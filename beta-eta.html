<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Big Red Connect ‚Äî ETA to You</title>

  <!-- ‚úÖ PWA + Icon setup -->
  <link rel="apple-touch-icon" href="icon.png">
  <link rel="icon" type="image/png" sizes="192x192" href="icon.png">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#000000">
  <meta name="apple-mobile-web-app-title" content="Big Red ETA">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <!-- Prevent caching -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <link rel="stylesheet" href="style.css" />

  <style>
    body { background:#000; color:#fff; font-family:'Roboto',sans-serif; margin:0; padding:0; text-align:center; }
    .wrap { max-width:720px; margin:auto; padding:10px 14px; }
    #map { height:320px; border-radius:10px; border:2px solid #c40000; margin:14px 0; }
    .panel { background:#111; border:1px solid #333; border-radius:10px; padding:12px 14px; margin-top:10px; }
    .cta-row { display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin:8px 0 16px; }
    .muted { color:#aaa; font-size:.9em; }
    .hidden { display:none!important; }
    .field-row { display:flex; gap:8px; align-items:center; }
    .field-row input { flex:1; padding:8px; border-radius:6px; border:none; font-size:1em; }
    .eta { font-weight:600; }
    .helper { color:#bbb; font-size:.9em; margin-top:4px }

    /* Live indicator */
    #last-updated { font-size:.9em; margin-top:6px; transition:color .4s ease, opacity .6s ease; }
    .fresh { color:#00e676; animation:pulse 2s infinite; }
    .delayed { color:#ffeb3b; }
    .stale { color:#ff5252; }
    @keyframes pulse { 0%,100%{opacity:1;} 50%{opacity:.4;} }
  </style>
</head>

<body>
  <div class="logo-header">
    <img src="official_logo.jpeg" alt="Big Red Connect Logo" />
  </div>

  <div class="wrap">
    <h1>How far is Big Red from you?</h1>
    <p class="tagline">Quickly check ETA from my live position to yours.</p>

    <div id="status-pill" class="status status--loading">Checking status‚Ä¶</div>

    <div class="panel">
      <div id="gps-hint" class="helper">Allow GPS for faster results, or enter your location manually.</div>
      <div class="cta-row">
        <button id="btnUseMyLoc" class="btn primary" type="button">üìç Check ETA to Me</button>
        <button id="btnEnterAddress" class="btn secondary" type="button">‚å®Ô∏è Enter Address</button>
      </div>
      <div id="manualRow" class="field-row hidden">
        <input id="manualAddr" type="text" placeholder="Enter your current location/address" />
        <button id="btnUseManual" class="btn primary" type="button">‚úÖ Use This</button>
      </div>
    </div>

    <div id="map"></div>

    <div id="resultPanel" class="panel hidden">
      <div id="etaLine" class="eta"></div>
      <div id="distLine"></div>
      <div id="whenLine" class="muted"></div>
      <div id="last-updated" class="muted">Last updated: ‚Äî</div>

      <div class="cta-row" style="margin-top:12px;">
        <a id="gmLink" class="btn secondary" href="#" target="_blank">üó∫Ô∏è Open in Google Maps</a>
        <a href="fare-calculator.html" class="btn primary">üí≤ Fare Calculator</a>
        <a id="textRed" class="btn secondary" href="sms:+14053784024">üì≤ Text RED</a>
      </div>
      <div class="muted">No surprises. Just solid local moves.</div>
    </div>

    <p class="muted">
      ‚Ä¢ Shows ETA only when Big Red is <strong>üü¢ Online</strong>.<br>
      ‚Ä¢ Refreshes automatically every 30 seconds.
    </p>

    <footer style="margin-top:20px;">
      <p>&copy; 2025 Big Red Connect ‚Äî <a href="index.html">Return Home</a></p>
    </footer>
  </div>

  <script src="status.js"></script>
  <script>
    const LOCATION_READER = "https://update-location.bigredtransportation.workers.dev";
    const STALE_MIN = 30;
    const HQ = { lat: 35.3207, lng: -97.4929 };
    let map, geocoder, directionsService, directionsRenderer;
    let driverPos = null, riderPos = null;
    let currentStatus = (localStorage.getItem("bigred_status") || "offline").toLowerCase();

    const el = id => document.getElementById(id);

    window.initEtaBeta = async function(){
      geocoder = new google.maps.Geocoder();
      directionsService = new google.maps.DirectionsService();
      directionsRenderer = new google.maps.DirectionsRenderer({ suppressMarkers:true });
      map = new google.maps.Map(el("map"), { center:{lat:35.4676,lng:-97.5164}, zoom:11 });
      directionsRenderer.setMap(map);

      el("btnUseMyLoc").onclick = handleUseMyLocation;
      el("btnEnterAddress").onclick = ()=>el("manualRow").classList.remove("hidden");
      el("btnUseManual").onclick = handleManualUse;

      await getDriverLocation();
    };

    async function getDriverLocation(){
      try {
        const res = await fetch(LOCATION_READER + "?nocache=" + Date.now());
        const j = await res.json();
        const lat = parseFloat(j.latitude), lng = parseFloat(j.longitude);
        const ts = j.timestamp ? new Date(j.timestamp) : null;
        const ageMin = ts ? (Date.now()-ts.getTime())/60000 : 999;
        driverPos = (!isNaN(lat)&&!isNaN(lng)&&ageMin<=STALE_MIN)?{lat,lng}:HQ;
        if(j.timestamp) updateLastUpdated(j.timestamp);
      } catch { driverPos = HQ; }
    }

    async function handleUseMyLocation(){
      await getDriverLocation();
      if(currentStatus!=="online") return showOfflinePanel();
      if(!navigator.geolocation) return alert("Location not supported.");
      navigator.geolocation.getCurrentPosition(async(pos)=>{
        riderPos=new google.maps.LatLng(pos.coords.latitude,pos.coords.longitude);
        await drawRoute();
      },()=>el("manualRow").classList.remove("hidden"));
    }

    async function handleManualUse(){
      await getDriverLocation();
      if(currentStatus!=="online") return showOfflinePanel();
      const addr=el("manualAddr").value.trim(); if(!addr) return alert("Enter your address.");
      geocoder.geocode({address:addr},async(res,status)=>{
        if(status==="OK"&&res[0]?.geometry?.location){riderPos=res[0].geometry.location;await drawRoute(addr);}
        else alert("Could not find that address.");
      });
    }

    async function drawRoute(addrStr=""){
      if(!driverPos||!riderPos)return;
      directionsRenderer.set("directions",null);
      if(window.driverMarker)window.driverMarker.setMap(null);
      if(window.riderMarker)window.riderMarker.setMap(null);
      window.driverMarker=new google.maps.Marker({position:driverPos,map,label:"üöó"});
      window.riderMarker=new google.maps.Marker({position:riderPos,map,label:"üìç"});

      const route=await new Promise((res,rej)=>directionsService.route({
        origin:driverPos,destination:riderPos,travelMode:"DRIVING"
      },(r,s)=>s==="OK"?res(r):rej(s)));
      directionsRenderer.setDirections(route);
      const leg=route.routes[0].legs[0];
      const miles=(leg.distance.value/1609.34).toFixed(1);
      const mins=Math.round(leg.duration.value/60);
      el("etaLine").textContent=`ETA ‚âà ${mins} min`;
      el("distLine").textContent=`Distance ‚âà ${miles} mi`;
      el("whenLine").textContent=`Calculated at ${new Date().toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit"})} CT`;
      el("gmLink").href=`https://www.google.com/maps/dir/?api=1&origin=${driverPos.lat},${driverPos.lng}&destination=${encodeURIComponent(addrStr||leg.end_address)}`;
      el("textRed").href=`sms:+14053784024?&body=${encodeURIComponent("Hey Big Red ‚Äî quick ETA check: ETA ~ "+mins+" min ("+miles+" mi). My spot: "+(addrStr||leg.end_address||"Pinned on map")+"." )}`;
      el("resultPanel").classList.remove("hidden");
      const b=new google.maps.LatLngBounds();b.extend(driverPos);b.extend(riderPos);map.fitBounds(b);
    }

    function showOfflinePanel(){
      directionsRenderer.set("directions",null);
      if(window.driverMarker)window.driverMarker.setMap(null);
      if(window.riderMarker)window.riderMarker.setMap(null);
      el("resultPanel").classList.remove("hidden");
      el("etaLine").textContent="I‚Äôm not currently online.";
      el("distLine").textContent="Tap ‚ÄúText RED‚Äù to plan your connection.";
      el("whenLine").textContent="";
      el("gmLink").href="#";
    }

    function updateLastUpdated(ts){
      const e=el("last-updated"); if(!e)return;
      const now=new Date(); const diff=Math.round((now-new Date(ts))/1000);
      let msg,cls;
      if(diff<60){msg=`${diff}s ago`;cls="fresh";}
      else if(diff<120){msg=`${Math.floor(diff/60)} min ago`;cls="delayed";}
      else{msg=`${Math.floor(diff/60)} min ago`;cls="stale";}
      e.textContent=`Last updated: ${msg}`; e.className=cls;
    }

    // üîÅ Auto-refresh
    setInterval(async()=>{
      await getDriverLocation();
      if(driverPos&&riderPos)drawRoute();
    },30000);

    // ‚úÖ Register Service Worker
    if('serviceWorker' in navigator){
      navigator.serviceWorker.register('service-worker.js')
        .then(()=>console.log("‚úÖ Service worker registered"))
        .catch(err=>console.warn("SW fail:",err));
    }
  </script>

  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCMM0dxLNM7XQI5G3OBSnINeO5hcS3Ks5I&libraries=places,geometry&callback=initEtaBeta">
  </script>
</body>
</html>
