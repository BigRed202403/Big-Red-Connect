<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Admin Big Red</title>

<link rel="apple-touch-icon" href="icon.png">
<link rel="icon" type="image/png" sizes="192x192" href="icon.png">
<link rel="shortcut icon" href="icon.png">
<meta name="theme-color" content="#000000">

<style>
:root { --red:#b30000; --bg:#000; --panel:#111; --muted:#aaa; }
body{background:var(--bg);color:#fff;font-family:Arial,Helvetica,sans-serif;margin:0;text-align:center;}
header{background:var(--panel);display:flex;justify-content:space-between;align-items:center;
padding:10px 16px;border-bottom:2px solid var(--red);}
.bar-left{color:#bbb;font-size:.92em;display:flex;gap:10px;align-items:center;}
.pill{padding:4px 10px;border-radius:999px;font-weight:700;font-size:.85em;}
.pill.online{background:#064;} .pill.away{background:#665500;} .pill.offline{background:#400;}
.refresh-btn{background:var(--red);color:#fff;border:none;padding:8px 14px;border-radius:6px;cursor:pointer;font-weight:700;}
.refresh-btn:hover{background:#cc0000;}
h1{margin:18px 0 6px;color:var(--red);font-size:1.6rem;}
.tagline{color:#ddd;margin:0 0 8px;font-size:.95rem;}
.status{margin:10px auto;padding:10px;border-radius:6px;display:inline-block;min-width:280px;}
.status.online{background:#064;} .status.away{background:#665500;} .status.offline{background:#400;}
.grid{display:grid;grid-template-columns:1fr;gap:18px;max-width:880px;margin:0 auto;padding:10px 16px 24px;}
section{background:var(--panel);border:1px solid #222;border-radius:8px;padding:14px;}
section h2{margin:6px 0 8px;font-size:1.1rem;}
select,button{padding:10px;border-radius:6px;border:none;margin:6px;font-weight:700;}
.btn-primary{background:var(--red);color:#fff;} 
.btn-secondary{background:#000;color:#fff;border:1px solid var(--red);}
.btn-tertiary{background:#222;color:#fff;border:1px solid #555;}
.row{display:flex;justify-content:center;align-items:center;flex-wrap:wrap;gap:6px;}
.meta{color:var(--muted);font-size:.85em;margin-top:6px;}
.img-box{max-width:95%;margin:10px auto;border:3px solid var(--red);border-radius:6px;padding:8px;}
.img-box img{width:100%;border-radius:6px;}
textarea{width:95%;max-width:780px;height:140px;background:#111;color:#fff;border:2px solid var(--red);
border-radius:6px;padding:8px;}
footer{margin:18px 0 24px;font-size:.9em;color:#777;}
#toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);
background:var(--red);color:#fff;padding:8px 16px;border-radius:6px;opacity:0;transition:opacity .35s;z-index:5;}
#debugLog{font-family:monospace;font-size:0.75rem;color:#0f0;background:#000;
padding:6px;max-height:200px;overflow:auto;text-align:left;border-top:1px solid #222;}
</style>
</head>
<body>

<header>
  <div class="bar-left">
    <span>ðŸ”’ Internal Use Only</span>
    <span id="livePill" class="pill offline">ðŸ“¡ Tracking: OFF</span>
  </div>
  <button class="refresh-btn" id="refreshPage">ðŸ”„ Refresh</button>
</header>

<h1>Big Red Connect â€” Admin Console</h1>
<p class="tagline">Veteran Owned â€¢ Affordable â€¢ Local â€¢ Trusted</p>

<div id="status-pill" class="status">Checking statusâ€¦</div>

<div class="grid">

  <section id="control">
    <h2>Update Driving Status</h2>
    <div class="row">
      <select id="statusSelect">
        <option value="online">ðŸŸ¢ On the Road</option>
        <option value="away">ðŸŸ¡ Limited Availability</option>
        <option value="offline">ðŸ”´ Offline</option>
      </select>
      <button class="btn-primary" id="updateStatusBtn">ðŸ’¾ Save</button>
    </div>
    <div class="meta">
      <div>Last status update: <span id="statusStamp">â€”</span></div>
      <div>Last GPS ping: <span id="gpsStamp">â€”</span> â€¢ Interval: <span id="gpsRate">â€”</span></div>
    </div>
  </section>

  <section id="share">
    <h2>Quick Share Builder</h2>

    <div class="img-box">
      <img id="statusImage" src="" alt="Preview">
    </div>

    <div class="row">
      <button id="prevCaption" class="btn-tertiary">â¬… Prev</button>
      <button id="nextCaption" class="btn-tertiary">Next âž¡</button>
    </div>

    <textarea id="captionBox" readonly></textarea>

    <div class="row">
      <button class="btn-secondary" id="copyBtn">ðŸ“‹ Copy</button>
      <button class="btn-primary" id="shareBtn">ðŸ“¤ Facebook</button>
      <button class="btn-primary" id="postToLive">ðŸ“¢ Post to Live Page</button>
    </div>

    <div class="meta">This preview + caption will appear on <strong>live.html</strong></div>
  </section>
</div>

<footer>Â© 2025 Big Red Connect â€” Admin Panel</footer>
<div id="toast"></div>
<div id="debugLog">[Debug log started]</div>

<script>
/* ---------------------------------------------------
   CONFIG
--------------------------------------------------- */
const STATUS_WORKER="https://bigred-status-updater.bigredtransportation.workers.dev";
const LOCATION_WORKER="https://update-location.bigredtransportation.workers.dev";
const POST_WORKER="https://post-to-live-beta.bigredtransportation.workers.dev";
const AUTH_SECRET="BigRedPrivateKey2025";

/* ELEMENTS */
const pill=document.getElementById("status-pill");
const statusStamp=document.getElementById("statusStamp");
const gpsStamp=document.getElementById("gpsStamp");
const gpsRate=document.getElementById("gpsRate");
const select=document.getElementById("statusSelect");
const captionBox=document.getElementById("captionBox");
const toast=document.getElementById("toast");

function showToast(msg){toast.textContent=msg;toast.style.opacity=1;setTimeout(()=>toast.style.opacity=0,2500);}
function fmtLocal(iso){return iso?new Date(iso).toLocaleString(): "â€”";}

/* ---------------------------------------------------
   REFRESH BUTTON
--------------------------------------------------- */
document.getElementById("refreshPage").onclick=()=>{location.reload();};

/* ---------------------------------------------------
   STATUS FETCH + RENDER
--------------------------------------------------- */
async function fetchStatus(){
  try{
    const res=await fetch(`${STATUS_WORKER}/status?nocache=${Date.now()}`);
    const j=await res.json();
    renderStatus(j.status,j.updated);
    select.value=j.status;
    updatePreview(j.status);
  }catch{
    renderStatus("offline");
  }
}
function renderStatus(state,iso){
  pill.className="status "+state;
  pill.textContent=`${state.toUpperCase()} â€” as of ${fmtLocal(iso)}`;
  statusStamp.textContent=fmtLocal(iso);
}

/* ---------------------------------------------------
   SAVE STATUS
--------------------------------------------------- */
document.getElementById("updateStatusBtn").onclick=async()=>{
  const status=select.value;
  const payload={status,updated:new Date().toISOString()};
  await fetch(STATUS_WORKER,{
    method:"PUT",
    headers:{"Content-Type":"application/json","X-Auth-Token":AUTH_SECRET},
    body:JSON.stringify(payload)
  });
  renderStatus(status,payload.updated);
  updatePreview(status);
  showToast("Status updated!");
};

/* ---------------------------------------------------
   CAPTION VARIANTS
--------------------------------------------------- */
let variants=[];
let idx=0;

function generateVariants(status){
  const weekday=new Date().toLocaleString("en-US",{weekday:"long"});
  const CTA="\n\nNo surprises. Just solid local moves.\nText â€˜REDâ€™ to 405-378-4024.\nVeteran Owned â€¢ Affordable â€¢ Local â€¢ Trusted.\nhttps://bigred202403.github.io/Big-Red-Connect/";

  if(status==="online"){
    variants=[
      `ðŸš— ${weekday} Moves â€” Big Red is LIVE!\n${CTA}`,
      `ðŸŒ™ ${weekday} Nights â€” Out and about? I'm rolling.\n${CTA}`,
      `ðŸš¦ Rolling steady â€” your flat-rate connection is LIVE.\n${CTA}`,
      `ðŸ“ In the metro now â€” message me to plan ahead.\n${CTA}`,
    ];
  }else if(status==="away"){
    variants=[
      `ðŸ•‘ ${weekday} Update â€” I'm close by, message to connect.\n${CTA}`,
      `ðŸŸ¡ Limited Availability â€” text RED and Iâ€™ll confirm.\n${CTA}`,
      `ðŸ“© Need a ride? I'm nearby.\n${CTA}`
    ];
  }else{
    variants=[
      `ðŸ”´ Offline â€” Thank you for riding local!\n${CTA}`,
      `ðŸ˜´ Signing off â€” back soon.\n${CTA}`
    ];
  }

  idx=0;
  captionBox.value=variants[idx];
}

document.getElementById("prevCaption").onclick=()=>{
  idx=(idx-1+variants.length)%variants.length;
  captionBox.value=variants[idx];
};
document.getElementById("nextCaption").onclick=()=>{
  idx=(idx+1)%variants.length;
  captionBox.value=variants[idx];
};

/* ---------------------------------------------------
   PREVIEW IMAGE
--------------------------------------------------- */
function updatePreview(status){
  generateVariants(status);
  const img=document.getElementById("statusImage");
  const imgs=[
    "3F34BE7E-5953-433C-B8D0-17AC9108107F.png",
    "B02AB3EA-1AF5-4BE4-8CBB-E5A1AA40711F.png",
    "3673A967-4A2D-4F9C-8602-0C820D31D168.png",
    "982ABF7A-D9F5-403D-BAE8-13777EC286FB.png"
  ];
  const chosen=imgs[Math.floor(Math.random()*imgs.length)];
  img.src=`https://raw.githubusercontent.com/bigred202403/Big-Red-Connect/main/${chosen}`;
}

/* ---------------------------------------------------
   COPY + SHARE
--------------------------------------------------- */
document.getElementById("copyBtn").onclick=()=>{navigator.clipboard.writeText(captionBox.value);showToast("Copied!");};
document.getElementById("shareBtn").onclick=()=>{window.open(`https://www.facebook.com/sharer/sharer.php?u=https://bigred202403.github.io/Big-Red-Connect/&quote=${encodeURIComponent(captionBox.value)}`);};

/* ---------------------------------------------------
   ðŸ“¢ POST TO LIVE PAGE
--------------------------------------------------- */
document.getElementById("postToLive").onclick=async()=>{
  const body={
    status:select.value,
    caption:captionBox.value,
    image:document.getElementById("statusImage").src
  };

  const res=await fetch(POST_WORKER,{
    method:"PUT",
    headers:{"Content-Type":"application/json","X-Admin-Secret":AUTH_SECRET},
    body:JSON.stringify(body)
  });

  if(res.ok) showToast("ðŸ“¢ Posted to live page!");
  else showToast("âš  Error posting");
};

/* INIT */
fetchStatus();
</script>
</body>
</html>