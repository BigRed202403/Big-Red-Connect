<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Big Red</title>

  <!-- Icons / PWA basics -->
  <link rel="apple-touch-icon" href="icon.PNG">
  <link rel="icon" type="image/png" sizes="192x192" href="icon.png">
  <link rel="shortcut icon" href="icon.PNG">
  <link rel="manifest" href="manifest-admin.json">
  <meta name="apple-mobile-web-app-title" content="Big Red Admin">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="theme-color" content="#000">
  <meta http-equiv="Cache-Control" content="no-store" />

  <style>
    :root {
      --red:#b30000;
      --bg:#000;
      --panel:#101010;
      --panel-soft:#151515;
      --muted:#aaa;
    }

    * { box-sizing:border-box; }

    body{
      background:var(--bg);
      color:#fff;
      font-family:-apple-system,BlinkMacSystemFont,system-ui,Arial,Helvetica,sans-serif;
      margin:0;
      text-align:center;
    }

    /* Header */
    header{
      background:var(--panel);
      border-bottom:2px solid var(--red);
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:10px 14px;
      position:sticky;
      top:0;
      z-index:20;
    }
    .bar-left{
      color:#ccc;
      font-size:.85rem;
      display:flex;
      gap:10px;
      align-items:center;
    }
    .pill{
      padding:4px 10px;
      border-radius:999px;
      font-weight:700;
      font-size:.78rem;
      background:#333;
    }
    .pill.online   { background:#065d32; }
    .pill.away     { background:#665500; }
    .pill.offline  { background:#5a1111; }

    .refresh-btn{
      background:#000;
      color:#fff;
      border:1px solid var(--red);
      padding:7px 13px;
      border-radius:6px;
      cursor:pointer;
      font-weight:600;
      font-size:.85rem;
    }
    .refresh-btn:hover{background:#1a1a1a;}

    h1{
      margin:16px 0 4px;
      color:var(--red);
      font-size:1.5rem;
    }
    .tagline{
      color:#ddd;
      margin:0 0 10px;
      font-size:.9rem;
    }

    /* Sticky status pill below header */
    #status-pill{
      margin:0 auto 12px;
      padding:8px 14px;
      border-radius:999px;
      display:inline-block;
      min-width:260px;
      font-size:.9rem;
      background:#333;
    }
    #status-pill.online  { background:#065d32; }
    #status-pill.away    { background:#665500; }
    #status-pill.offline { background:#5a1111; }

    /* Layout */
    .grid{
      display:grid;
      grid-template-columns:1fr;
      gap:16px;
      max-width:980px;
      margin:0 auto;
      padding:0 14px 24px;
    }
    @media (min-width:900px){
      .grid{
        grid-template-columns:1.2fr 1.1fr;
        align-items:flex-start;
      }
      .grid > section:last-child{
        grid-column:1 / -1;
      }
    }

    section{
      background:var(--panel-soft);
      border-radius:10px;
      padding:14px 12px 16px;
      text-align:left;
      border:1px solid #222;
      box-shadow:0 2px 4px rgba(0,0,0,.4);
    }
    section h2{
      margin:4px 0 8px;
      font-size:1.1rem;
      border-bottom:1px solid #222;
      padding-bottom:4px;
    }
    section p.helper{
      font-size:.8rem;
      color:var(--muted);
      margin:0 0 8px;
    }

    /* Inputs / buttons */
    select,button,input,textarea{
      font-family:inherit;
    }
    select,
    input[type="text"],
    input[type="url"]{
      padding:8px 10px;
      border-radius:6px;
      border:1px solid #333;
      margin:4px 0;
      font-weight:500;
      font-size:.9rem;
      background:#050505;
      color:#fff;
    }
    select:focus,
    input:focus,
    textarea:focus{
      outline:none;
      border-color:var(--red);
    }

    .btn-primary{
      background:var(--red);
      color:#fff;
      border:none;
    }
    .btn-secondary{
      background:#000;
      color:#fff;
      border:1px solid var(--red);
    }
    .btn-tertiary{
      background:#222;
      color:#fff;
      border:1px solid #555;
    }
    button{
      padding:8px 11px;
      border-radius:7px;
      font-size:.85rem;
      font-weight:600;
      cursor:pointer;
    }
    button:disabled{
      opacity:.6;
      cursor:default;
    }

    .row{
      display:flex;
      justify-content:flex-start;
      align-items:center;
      flex-wrap:wrap;
      gap:8px;
      margin:6px 0;
    }

    label{
      font-size:.8rem;
      color:#ccc;
      display:block;
      margin-top:4px;
    }

    textarea{
      width:100%;
      min-height:110px;
      background:#050505;
      color:#fff;
      border:1px solid #333;
      border-radius:6px;
      padding:8px;
      resize:vertical;
      font-size:.88rem;
    }

    .preview-box{
      margin-top:8px;
      padding:8px;
      border-radius:6px;
      border:1px dashed #444;
      background:#050505;
      font-size:.8rem;
      color:#ddd;
    }

    .img-box{
      max-width:100%;
      margin:6px auto 4px;
      border-radius:8px;
      padding:6px;
      background:#050505;
      border:2px solid var(--red);
    }
    .img-box img{
      width:100%;
      border-radius:6px;
      display:block;
    }

    /* Meta text */
    .meta{
      font-size:.75rem;
      color:#999;
      margin-top:4px;
      line-height:1.35;
    }

    /* Toast & debug */
    #toast{
      position:fixed;
      bottom:18px;
      left:50%;
      transform:translateX(-50%);
      background:var(--red);
      color:#fff;
      padding:7px 16px;
      border-radius:999px;
      opacity:0;
      transition:opacity .3s;
      font-size:.8rem;
      z-index:40;
      pointer-events:none;
      box-shadow:0 3px 7px rgba(0,0,0,.6);
    }
    #debugLog{
      font-family:SFMono-Regular,Menlo,monospace;
      font-size:0.7rem;
      color:#0f0;
      background:#000;
      padding:6px;
      max-height:190px;
      overflow:auto;
      border-top:1px solid #222;
      text-align:left;
    }
  </style>
</head>

<body>

<header>
  <div class="bar-left">
    <span>ğŸ”’ Big Red Admin</span>
    <span id="livePill" class="pill offline">ğŸ“¡ Tracking: OFF</span>
  </div>
  <button class="refresh-btn" id="refreshPage">ğŸ”„ Refresh</button>
</header>

<h1>Big Red Connect â€” Admin Console</h1>
<p class="tagline">Veteran Owned â€¢ Affordable â€¢ Local â€¢ Trusted</p>

<div id="status-pill" class="offline">Checking statusâ€¦</div>

<div class="grid">

  <!-- PUSH PANEL -->
  <section id="push-panel">
    <h2>Push Notifications</h2>
    <p class="helper">Send a broadcast â€œBig Red Alertâ€ to all subscribed devices.</p>

    <div class="row">
      <label style="margin-right:4px;">Template:</label>
      <select id="pushTemplate">
        <option value="LIVE">ğŸš— LIVE â€” Ready to Roll</option>
        <option value="AIRPORT">âœˆï¸ Airport Runs</option>
        <option value="WEEKEND">ğŸ» Weekend Night Run</option>
        <option value="HOLIDAY">ğŸ„ Holiday Specials</option>
        <option value="CAMPUS">ğŸ…¿ï¸ Campus Corner Late Night</option>
        <option value="OFFLINE">ğŸ”´ Going Offline</option>
        <option value="CUSTOM">âœï¸ Custom Only</option>
      </select>
      <button class="btn-tertiary" id="pushApplyTemplate">Apply</button>
    </div>

    <label>Title</label>
    <input id="pushTitle" type="text" placeholder="Big Red Connect" />

    <label>Message</label>
    <textarea id="pushMessage" placeholder="Enter message"></textarea>

    <label>Tap-through Link (optional)</label>
    <input id="pushUrl" type="url" placeholder="https://bigredconnectokc.com/" />

    <div class="preview-box">
      <strong>Preview:</strong><br>
      <span id="pushPrevTitle">Big Red Connect</span><br>
      <span id="pushPrevMessage">Message will appear here.</span><br>
      <span style="color:#888;font-size:.75rem;">
        Link: <span id="pushPrevUrl">https://bigredconnectokc.com/</span>
      </span>
    </div>

    <div class="row" style="margin-top:10px;">
      <button class="btn-primary" id="sendPush">ğŸ“£ Send Push Now</button>
      <button class="btn-secondary" id="clearPush">ğŸ§¹ Clear</button>
    </div>
  </section>

  <!-- STATUS PANEL -->
  <section id="status-panel">
    <h2>Driving Status</h2>
    <p class="helper">
      Updates the live status pill on the public site. Stored in Cloudflare KV.
    </p>

    <div class="row">
      <select id="statusSelect">
        <option value="online">ğŸŸ¢ On the Road</option>
        <option value="away">ğŸŸ¡ Limited Availability</option>
        <option value="offline">ğŸ”´ Offline</option>
      </select>
      <button class="btn-primary" id="updateStatusBtn">ğŸ’¾ Save</button>
    </div>

    <label>Custom Status Message</label>
    <input id="statusMessage" type="text"
           placeholder="Example: Rolling in Norman & Moore tonight" />

    <div class="meta">
      <div>Last status update: <span id="statusStamp">â€”</span></div>
      <div>KV lastUpdated: <span id="kvStamp">â€”</span></div>
    </div>
  </section>

  <!-- LIVE MAP / SOCIAL PANEL -->
  <section id="share-panel">
    <h2>Live Map â€” Preview & Caption</h2>
    <p class="helper">
      Rotate through preset images and captions for Big Red Live or socials.
    </p>

    <div class="img-box">
      <img id="statusImage" src="" alt="Preview image">
    </div>

    <div class="row">
      <button id="prevImage" class="btn-tertiary">â¬… Image</button>
      <button id="nextImage" class="btn-tertiary">Image â¡</button>
    </div>

    <div class="row">
      <button id="prevCaption" class="btn-tertiary">â¬… Caption</button>
      <button id="nextCaption" class="btn-tertiary">Caption â¡</button>
      <button id="resetCaption" class="btn-secondary">Reset</button>
    </div>

    <label>Caption</label>
    <textarea id="captionBox">Loadingâ€¦</textarea>

    <div class="row" style="margin-top:10px;">
      <button class="btn-secondary" id="copyBtn">ğŸ“‹ Copy Caption</button>
      <button class="btn-primary" id="postToLive">ğŸ“¢ Post to Live Map</button>
    </div>

  </section>

</div>

<div id="toast"></div>
<div id="debugLog">[Debug started]</div>

<script>
/* =========================
   CONFIG / CONSTANTS
   ========================= */

const STATUS_URL   = "https://bigred-status-updater.bigredtransportation.workers.dev/status";
const POST_WORKER  = "https://post-to-live-beta.bigredtransportation.workers.dev";
const PUSH_WORKER  = "https://bigredconnectokc.com/push/";

const AUTH_SECRET  = "BigRedPrivateKey2025";
const HOME_URL     = "https://bigredconnectokc.com/";
const TZ           = "America/Chicago";

/* Image + caption presets (you can swap filenames/text here) */
const IMAGE_LIST = [
  "live_1.png",
  "live_2.png",
  "live_3.png",
  "live_4.png"
];

const CAPTION_LIST = [
  "ğŸš— Big Red Connect is LIVE across the metro â€” text RED to 405-378-4024 to line up your flat-rate connection.",
  "ğŸŒ™ Rolling nights in Norman, Moore, and OKC â€” ride local, ride safe, ride with Big Red Connect.",
  "âœˆï¸ Airport runs & late-night link-ups â€” text RED before you head out and lock in your flat-rate connection.",
  "ğŸ“ Need a safe way home after last call? Big Red Connect has you covered â€” veteran owned, affordable, local, trusted."
];

/* Push templates */
const tpl = {
  LIVE: {
    title:"Big Red is LIVE",
    message:"Rolling now â€” text RED to 405-378-4024 if you need a connection.",
    url:HOME_URL
  },
  AIRPORT:{
    title:"Airport Runs Tonight",
    message:"Headed toward Will Rogers â€” text RED to 405-378-4024 to line up your ride.",
    url:HOME_URL
  },
  WEEKEND:{
    title:"Weekend Night Run",
    message:"Out and about? Big Red Connect is linking up safe rides across the metro.",
    url:HOME_URL
  },
  HOLIDAY:{
    title:"Holiday Ride Plans",
    message:"Plan your flat-rate holiday connections now â€” text RED to 405-378-4024.",
    url:HOME_URL
  },
  CAMPUS:{
    title:"Campus Corner Late Night",
    message:"OU students â€” need a safe late-night connection? Text RED to 405-378-4024.",
    url:HOME_URL
  },
  OFFLINE:{
    title:"Big Red is Offline",
    message:"Off the road for now â€” watch for the next Big Red Alert when Iâ€™m back on.",
    url:HOME_URL
  }
};

/* =========================
   TOAST + DEBUG HELPERS
   ========================= */
const toast = msg => {
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.style.opacity = 1;
  setTimeout(() => t.style.opacity = 0, 2200);
};

const log = msg => {
  const box = document.getElementById("debugLog");
  const time = new Date().toLocaleTimeString("en-US",{hour12:false});
  box.innerHTML = `[${time}] ${msg}<br>` + box.innerHTML;
};

/* =========================
   STATUS HANDLING (KV)
   ========================= */

let currentStatus = null;

function applyStatusToUI(data){
  currentStatus = data || {};
  const state = data.state || data.status || "offline";
  const online = (typeof data.online === "boolean")
    ? data.online
    : (state === "online");

  const msg = data.message || (
    state === "online" ? "On the road" :
    state === "away"   ? "Limited availability" :
                         "Offline"
  );

  // dropdown
  const select = document.getElementById("statusSelect");
  select.value = state;

  // custom message input
  document.getElementById("statusMessage").value = msg;

  // pills
  const pill = document.getElementById("status-pill");
  pill.className = state;
  pill.textContent =
    state === "online" ? `ğŸŸ¢ On the Road â€” ${msg}` :
    state === "away"   ? `ğŸŸ¡ Limited â€” ${msg}` :
                         `ğŸ”´ Offline â€” ${msg}`;

  const livePill = document.getElementById("livePill");
  livePill.className = "pill " + (online ? "online" : "offline");
  livePill.textContent = online ? "ğŸ“¡ Tracking: ON" : "ğŸ“¡ Tracking: OFF";

  // stamps
  const stamp = data.lastUpdated
    ? new Date(data.lastUpdated).toLocaleString("en-US",{timeZone:TZ})
    : "â€”";
  document.getElementById("statusStamp").textContent = stamp;
  document.getElementById("kvStamp").textContent = data.lastUpdated || "â€”";
}

async function loadStatus(){
  try{
    log("Loading status from KVâ€¦");
    const res = await fetch(STATUS_URL, { method:"GET" });
    const json = await res.json();
    log("Status GET OK: " + JSON.stringify(json));
    applyStatusToUI(json);
  }catch(err){
    log("Status GET error: " + err);
    toast("âš ï¸ Could not load status");
  }
}

async function saveStatus(){
  const state = document.getElementById("statusSelect").value;
  const msg = document.getElementById("statusMessage").value.trim() ||
    (state === "online" ? "On the road" :
     state === "away"   ? "Limited availability" :
                          "Offline");

  const body = {
    online: (state === "online"),
    state,
    message: msg,
    activeRideId: currentStatus && "activeRideId" in currentStatus
      ? currentStatus.activeRideId : null,
    location: currentStatus && "location" in currentStatus
      ? currentStatus.location : null
  };

  try{
    log("Saving status to KV: " + JSON.stringify(body));
    const res = await fetch(STATUS_URL,{
      method:"PUT",
      headers:{
        "Content-Type":"application/json",
        "X-Auth-Token":AUTH_SECRET
      },
      body:JSON.stringify(body)
    });
    const json = await res.json();
    log("Status PUT response: " + JSON.stringify(json));
    if(res.ok){
      applyStatusToUI(json.updated || body);
      toast("âœ… Status updated");
    }else{
      toast("âš ï¸ Status update failed");
    }
  }catch(err){
    log("Status PUT error: " + err);
    toast("âš ï¸ Status update error");
  }
}

/* =========================
   PUSH NOTIFICATIONS
   ========================= */

function updatePushPreview(){
  document.getElementById("pushPrevTitle").textContent =
    document.getElementById("pushTitle").value || "Big Red Connect";

  document.getElementById("pushPrevMessage").textContent =
    document.getElementById("pushMessage").value || "Message will appear here.";

  document.getElementById("pushPrevUrl").textContent =
    document.getElementById("pushUrl").value || HOME_URL;
}

function applyPushTemplate(){
  const key = document.getElementById("pushTemplate").value;
  if(key === "CUSTOM") return;
  const t = tpl[key];
  if(!t) return;
  document.getElementById("pushTitle").value = t.title;
  document.getElementById("pushMessage").value = t.message;
  document.getElementById("pushUrl").value = t.url;
  updatePushPreview();
}

async function sendPush(){
  const title = (document.getElementById("pushTitle").value || "Big Red Connect").trim();
  const message = document.getElementById("pushMessage").value.trim();
  const url = (document.getElementById("pushUrl").value || HOME_URL).trim();

  if(!message){
    toast("Message required");
    return;
  }

  log("Sending push via Workerâ€¦");
  try{
    const res = await fetch(PUSH_WORKER,{
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "X-Admin-Secret":AUTH_SECRET
      },
      body:JSON.stringify({ title, message, url })
    });

    const text = await res.text();
    log("Push Worker response (" + res.status + "): " + text);

    if(res.ok){
      toast("ğŸ“£ Push sent!");
    }else{
      toast("âš ï¸ Push failed (" + res.status + ")");
    }
  }catch(err){
    log("Push Worker error: " + err);
    toast("âš ï¸ Push error");
  }
}

/* =========================
   LIVE IMAGE / CAPTION PANEL
   ========================= */

let imgIndex = 0;
let capIndex = 0;

function applyImage(){
  const img = document.getElementById("statusImage");
  const src = IMAGE_LIST[imgIndex % IMAGE_LIST.length];
  img.src = src;
  img.alt = "Preview image " + (imgIndex+1);
  log("Image set to: " + src);
}

function applyCaption(){
  const caption = CAPTION_LIST[capIndex % CAPTION_LIST.length];
  document.getElementById("captionBox").value = caption;
  log("Caption set index " + capIndex);
}

function resetCaption(){
  capIndex = 0;
  applyCaption();
}

async function postToLive(){
  const caption = document.getElementById("captionBox").value.trim();
  const image = IMAGE_LIST[imgIndex % IMAGE_LIST.length];

  if(!caption){
    toast("Caption required");
    return;
  }

  try{
    log("Posting to live workerâ€¦");
    const res = await fetch(POST_WORKER,{
      method:"POST",
      headers:{
        "Content-Type":"application/json"
      },
      body:JSON.stringify({
        secret: AUTH_SECRET,
        image,
        caption
      })
    });
    const text = await res.text();
    log("Post-to-live response (" + res.status + "): " + text);
    toast(res.ok ? "âœ… Live map updated" : "âš ï¸ Live map failed");
  }catch(err){
    log("Post-to-live error: " + err);
    toast("âš ï¸ Live map error");
  }
}

/* =========================
   INIT / EVENT BINDINGS
   ========================= */

document.getElementById("refreshPage").onclick = () => location.reload(true);

document.getElementById("pushApplyTemplate").onclick = applyPushTemplate;
document.getElementById("pushTitle").oninput = updatePushPreview;
document.getElementById("pushMessage").oninput = updatePushPreview;
document.getElementById("pushUrl").oninput = updatePushPreview;
document.getElementById("sendPush").onclick = sendPush;

document.getElementById("clearPush").onclick = () => {
  document.getElementById("pushTitle").value = "";
  document.getElementById("pushMessage").value = "";
  document.getElementById("pushUrl").value = "";
  updatePushPreview();
};

document.getElementById("updateStatusBtn").onclick = saveStatus;

document.getElementById("prevImage").onclick = () => {
  imgIndex = (imgIndex - 1 + IMAGE_LIST.length) % IMAGE_LIST.length;
  applyImage();
};
document.getElementById("nextImage").onclick = () => {
  imgIndex = (imgIndex + 1) % IMAGE_LIST.length;
  applyImage();
};

document.getElementById("prevCaption").onclick = () => {
  capIndex = (capIndex - 1 + CAPTION_LIST.length) % CAPTION_LIST.length;
  applyCaption();
};
document.getElementById("nextCaption").onclick = () => {
  capIndex = (capIndex + 1) % CAPTION_LIST.length;
  applyCaption();
};
document.getElementById("resetCaption").onclick = resetCaption;

document.getElementById("copyBtn").onclick = async () => {
  const text = document.getElementById("captionBox").value;
  try{
    await navigator.clipboard.writeText(text);
    toast("ğŸ“‹ Caption copied");
  }catch{
    toast("âš ï¸ Unable to copy");
  }
};

function initAdmin(){
  log("Admin console loaded");
  // Set initial push template + preview
  applyPushTemplate();
  updatePushPreview();
  // Initial image + caption
  applyImage();
  applyCaption();
  // Load status from KV
  loadStatus();
}

window.addEventListener("load", initAdmin);
</script>

</body>
</html>