<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Admin Big Red</title>

<!-- Icons / PWA basics -->
<link rel="apple-touch-icon" href="icon.PNG">
<link rel="icon" type="image/png" sizes="192x192" href="icon.png">
<link rel="shortcut icon" href="icon.PNG">
<link rel="manifest" href="manifest-admin.json">
<meta name="apple-mobile-web-app-title" content="Big Red Admin">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="theme-color" content="#000">
<meta http-equiv="Cache-Control" content="no-store" />

<style>
:root { --red:#b30000; --bg:#000; --panel:#111; --muted:#aaa; }

body{
  background:var(--bg);
  color:#fff;
  font-family:Arial,Helvetica,sans-serif;
  margin:0;
  text-align:center;
}

/* Header */
header{
  background:var(--panel);
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:10px 16px;
  border-bottom:2px solid var(--red);
}
.bar-left{
  color:#bbb;
  font-size:.92em;
  display:flex;
  gap:10px;
  align-items:center;
}
.pill{
  padding:4px 10px;
  border-radius:999px;
  font-weight:700;
  font-size:.85em;
}
.pill.online{background:#064;}
.pill.away{background:#665500;}
.pill.offline{background:#400;}

.refresh-btn{
  background:var(--red);
  color:#fff;
  border:none;
  padding:8px 14px;
  border-radius:6px;
  cursor:pointer;
  font-weight:700;
}
.refresh-btn:hover{background:#cc0000;}

h1{
  margin:18px 0 6px;
  color:var(--red);
  font-size:1.6rem;
}
.tagline{
  color:#ddd;
  margin:0 0 8px;
  font-size:.95rem;
}

/* Status pill */
.status{
  margin:10px auto;
  padding:10px;
  border-radius:6px;
  display:inline-block;
  min-width:280px;
}
.status.online{background:#064;}
.status.away{background:#665500;}
.status.offline{background:#400;}

/* Layout */
.grid{
  display:grid;
  grid-template-columns:1fr;
  gap:18px;
  max-width:960px;
  margin:0 auto;
  padding:10px 16px 24px;
}
section{
  background:var(--panel);
  border:1px solid #222;
  border-radius:8px;
  padding:14px 12px 16px;
  text-align:left;
}
section h2{
  margin:6px 0 8px;
  font-size:1.1rem;
}

/* Inputs */
select,button,input,textarea{
  font-family:inherit;
}
select,button,input[type="text"],input[type="url"]{
  padding:8px 10px;
  border-radius:6px;
  border:none;
  margin:4px 0;
  font-weight:600;
  font-size:.95rem;
}
.btn-primary{background:var(--red);color:#fff;}
.btn-secondary{background:#000;color:#fff;border:1px solid var(--red);}
.btn-tertiary{background:#222;color:#fff;border:1px solid #555;}

.row{
  display:flex;
  justify-content:flex-start;
  align-items:center;
  flex-wrap:wrap;
  gap:8px;
  margin:6px 0;
}

/* Textareas */
textarea{
  width:100%;
  min-height:120px;
  background:#111;
  color:#fff;
  border:2px solid var(--red);
  border-radius:6px;
  padding:8px;
  resize:vertical;
}

/* Preview */
.preview-box{
  margin-top:8px;
  padding:8px;
  border-radius:6px;
  border:1px dashed #444;
  background:#050505;
  font-size:.85rem;
  color:#ddd;
}

/* Image box */
.img-box{
  max-width:95%;
  margin:10px auto 4px;
  border:3px solid var(--red);
  border-radius:6px;
  padding:8px;
}
.img-box img{
  width:100%;
  border-radius:6px;
}

/* Toast & debug */
#toast{
  position:fixed;
  bottom:20px;
  left:50%;
  transform:translateX(-50%);
  background:var(--red);
  color:#fff;
  padding:8px 16px;
  border-radius:6px;
  opacity:0;
  transition:opacity .35s;
}
#debugLog{
  font-family:monospace;
  font-size:0.75rem;
  color:#0f0;
  background:#000;
  padding:6px;
  max-height:200px;
  overflow:auto;
  border-top:1px solid #222;
}
</style>
</head>

<body>

<header>
  <div class="bar-left">
    <span>ğŸ”’ Internal Use Only</span>
    <span id="livePill" class="pill offline">ğŸ“¡ Tracking: OFF</span>
  </div>
  <button class="refresh-btn" id="refreshPage">ğŸ”„ Refresh</button>
</header>

<h1>Big Red Connect â€” Admin Console</h1>
<p class="tagline">Veteran Owned â€¢ Affordable â€¢ Local â€¢ Trusted</p>

<div id="status-pill" class="status">Checking statusâ€¦</div>

<div class="grid">

<!-- PUSH PANEL -->
<section>
<h2>Push Notifications</h2>

<div class="row">
  <label style="font-size:.85rem;color:#ccc;">Template:</label>
</div>

<div class="row">
  <select id="pushTemplate">
    <option value="LIVE">ğŸš— LIVE â€” Ready to Roll</option>
    <option value="AIRPORT">âœˆï¸ Airport Runs</option>
    <option value="WEEKEND">ğŸ» Weekend Night Run</option>
    <option value="HOLIDAY">ğŸ„ Holiday Specials</option>
    <option value="CAMPUS">ğŸ…¿ï¸ Campus Corner Late Night</option>
    <option value="OFFLINE">ğŸ”´ Going Offline</option>
    <option value="CUSTOM">âœï¸ Custom Only</option>
  </select>
  <button class="btn-tertiary" id="pushApplyTemplate">Apply</button>
</div>

<div class="field-group">
  <div class="field">
    <label>Title</label>
    <input id="pushTitle" type="text" placeholder="Big Red Connect" />
  </div>

  <div class="field">
    <label>Message</label>
    <textarea id="pushMessage" placeholder="Enter message"></textarea>
  </div>

  <div class="field">
    <label>Tap-through Link (optional)</label>
    <input id="pushUrl" type="url" placeholder="https://bigredconnectokc.com/" />
  </div>
</div>

<div class="preview-box">
  <strong>Preview:</strong><br>
  <span id="pushPrevTitle">Big Red Connect</span><br>
  <span id="pushPrevMessage">Message will appear here.</span><br>
  <span style="color:#888;font-size:.8rem;">Link: <span id="pushPrevUrl">https://bigredconnectokc.com/</span></span>
</div>

<div class="row" style="margin-top:10px;">
  <button class="btn-primary" id="sendPush">ğŸ“£ Send Push Now</button>
  <button class="btn-secondary" id="clearPush">ğŸ§¹ Clear</button>
</div>

</section>

<!-- STATUS PANEL -->
<section>
<h2>Driving Status</h2>

<div class="row">
  <select id="statusSelect">
    <option value="online">ğŸŸ¢ On the Road</option>
    <option value="away">ğŸŸ¡ Limited Availability</option>
    <option value="offline">ğŸ”´ Offline</option>
  </select>
  <button class="btn-primary" id="updateStatusBtn">ğŸ’¾ Save</button>
</div>

<div class="meta">
  <div>Last status update: <span id="statusStamp">â€”</span></div>
  <div>Last GPS ping: <span id="gpsStamp">â€”</span> â€¢ Interval: <span id="gpsRate">â€”</span></div>
</div>
</section>

<!-- SHARE PANEL -->
<section>
<h2>Live Map â€” Preview & Caption</h2>

<div class="img-box">
  <img id="statusImage" src="" alt="Preview">
</div>

<div class="row">
  <button id="prevImage" class="btn-tertiary">â¬… Image</button>
  <button id="nextImage" class="btn-tertiary">Image â¡</button>
</div>

<div class="row">
  <button id="prevCaption" class="btn-tertiary">â¬… Caption</button>
  <button id="nextCaption" class="btn-tertiary">Caption â¡</button>
  <button id="resetCaption" class="btn-secondary">Reset</button>
</div>

<label style="margin-top:8px;">Caption</label>
<textarea id="captionBox">Loadingâ€¦</textarea>

<div class="row" style="margin-top:10px;">
  <button class="btn-secondary" id="copyBtn">ğŸ“‹ Copy</button>
  <button class="btn-primary" id="postToLive">ğŸ“¢ Post to Live Map</button>
</div>

</section>

</div>

<div id="toast"></div>
<div id="debugLog">[Debug started]</div>

<script>
/* CONFIG */
const STATUS_WORKER = "https://bigred-status-updater.bigredtransportation.workers.dev";
const LOCATION_WORKER = "https://update-location.bigredtransportation.workers.dev";
const POST_WORKER    = "https://post-to-live-beta.bigredtransportation.workers.dev";

/* ğŸ”¥ NEW PUSH ENDPOINT â€” FIXED */
const PUSH_WORKER    = "https://bigredconnectokc.com/push/";

const AUTH_SECRET    = "BigRedPrivateKey2025";
const TZ             = "America/Chicago";

/* Short functions */
const toast = msg => {
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.style.opacity = 1;
  setTimeout(() => t.style.opacity = 0, 2200);
};
const log = msg => {
  const box = document.getElementById("debugLog");
  const time = new Date().toLocaleTimeString("en-US",{hour12:false});
  box.innerHTML = `[${time}] ${msg}<br>` + box.innerHTML;
};

/* --- PUSH TEMPLATES --- */
const HOME_URL = "https://bigredconnectokc.com/";
const tpl = {
  LIVE:     {title:"Big Red is LIVE", message:"Rolling now â€” text RED if you need a ride.", url:HOME_URL},
  AIRPORT:  {title:"Airport Runs",    message:"Headed toward Will Rogers â€” message RED.", url:HOME_URL},
  WEEKEND:  {title:"Weekend Run",     message:"Out and about? Iâ€™m rolling tonight.", url:HOME_URL},
  HOLIDAY:  {title:"Holiday Specials",message:"Flat-rate + holiday light runs available.", url:HOME_URL},
  CAMPUS:   {title:"Campus Corner",   message:"Late-night OU runs open.", url:HOME_URL},
  OFFLINE:  {title:"Big Red Offline", message:"See you soon!", url:HOME_URL}
};

function applyTpl(){
  const key = document.getElementById("pushTemplate").value;
  if(key==="CUSTOM") return;
  const t = tpl[key];
  document.getElementById("pushTitle").value = t.title;
  document.getElementById("pushMessage").value = t.message;
  document.getElementById("pushUrl").value = t.url;
  updPrev();
}

function updPrev(){
  document.getElementById("pushPrevTitle").textContent =
    document.getElementById("pushTitle").value || "Big Red Connect";
  document.getElementById("pushPrevMessage").textContent =
    document.getElementById("pushMessage").value || "Message will appear here.";
  document.getElementById("pushPrevUrl").textContent =
    document.getElementById("pushUrl").value || HOME_URL;
}

document.getElementById("pushApplyTemplate").onclick = applyTpl;
document.getElementById("pushTitle").oninput = updPrev;
document.getElementById("pushMessage").oninput = updPrev;
document.getElementById("pushUrl").oninput = updPrev;

/* --- SEND PUSH --- */
document.getElementById("sendPush").onclick = async () => {
  const title = document.getElementById("pushTitle").value.trim() || "Big Red Connect";
  const message = document.getElementById("pushMessage").value.trim();
  const url = document.getElementById("pushUrl").value.trim() || HOME_URL;

  if(!message){
    toast("Message required");
    return;
  }

  log("Sending pushâ€¦");

  const res = await fetch(PUSH_WORKER,{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      "X-Admin-Secret":AUTH_SECRET
    },
    body:JSON.stringify({title,message,url})
  });

  const txt = await res.text();
  log("Push response: " + txt);

  toast(res.ok ? "ğŸ“£ Push sent!" : "âš ï¸ Push failed");
};

/* --- CLEAR PUSH FIELDS --- */
document.getElementById("clearPush").onclick = () => {
  document.getElementById("pushTitle").value = "";
  document.getElementById("pushMessage").value = "";
  document.getElementById("pushUrl").value = "";
  updPrev();
};

/* INITIALIZE */
applyTpl();
updPrev();
</script>

</body>
</html>