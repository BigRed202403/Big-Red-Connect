<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Admin Big Red</title>

<!-- Icons / PWA basics -->
<link rel="apple-touch-icon" href="icon.PNG">
<link rel="icon" type="image/png" sizes="192x192" href="icon.png">
<link rel="shortcut icon" href="icon.PNG">
<link rel="manifest" href="manifest-admin.json">
<meta name="apple-mobile-web-app-title" content="Big Red Admin">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="theme-color" content="#000">
<meta http-equiv="Cache-Control" content="no-store" />

<style>
:root { --red:#b30000; --bg:#000; --panel:#111; --muted:#aaa; }

body{
  background:var(--bg);
  color:#fff;
  font-family:Arial,Helvetica,sans-serif;
  margin:0;
  text-align:center;
}

/* Header */
header{
  background:var(--panel);
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:10px 16px;
  border-bottom:2px solid var(--red);
}
.bar-left{
  color:#bbb;
  font-size:.92em;
  display:flex;
  gap:10px;
  align-items:center;
}
.pill{
  padding:4px 10px;
  border-radius:999px;
  font-weight:700;
  font-size:.85em;
}
.pill.online{background:#064;}
.pill.away{background:#665500;}
.pill.offline{background:#400;}

.refresh-btn{
  background:var(--red);
  color:#fff;
  border:none;
  padding:8px 14px;
  border-radius:6px;
  cursor:pointer;
  font-weight:700;
}
.refresh-btn:hover{background:#cc0000;}

h1{
  margin:18px 0 6px;
  color:var(--red);
  font-size:1.6rem;
}
.tagline{
  color:#ddd;
  margin:0 0 8px;
  font-size:.95rem;
}

/* Status pill */
.status{
  margin:10px auto;
  padding:10px;
  border-radius:6px;
  display:inline-block;
  min-width:280px;
}
.status.online{background:#064;}
.status.away{background:#665500;}
.status.offline{background:#400;}

/* Layout */
.grid{
  display:grid;
  grid-template-columns:1fr;
  gap:18px;
  max-width:960px;
  margin:0 auto;
  padding:10px 16px 24px;
}
section{
  background:var(--panel);
  border:1px solid #222;
  border-radius:8px;
  padding:14px 12px 16px;
  text-align:left;
}
section h2{
  margin:6px 0 8px;
  font-size:1.1rem;
}

/* Inputs */
select,button,input,textarea{
  font-family:inherit;
}
select,button,input[type="text"],input[type="url"]{
  padding:8px 10px;
  border-radius:6px;
  border:none;
  margin:4px 0;
  font-weight:600;
  font-size:.95rem;
}
.btn-primary{background:var(--red);color:#fff;}
.btn-secondary{background:#000;color:#fff;border:1px solid var(--red);}
.btn-tertiary{background:#222;color:#fff;border:1px solid #555;}
button{cursor:pointer;}
button:hover.btn-primary{background:#cc0000;}

.row{
  display:flex;
  justify-content:flex-start;
  align-items:center;
  flex-wrap:wrap;
  gap:8px;
  margin:6px 0;
}

.meta{
  color:var(--muted);
  font-size:.85em;
  margin-top:4px;
}

/* Textareas */
textarea{
  width:100%;
  min-height:120px;
  background:#111;
  color:#fff;
  border:2px solid var(--red);
  border-radius:6px;
  padding:8px;
  resize:vertical;
}

/* Preview */
.preview-box{
  margin-top:8px;
  padding:8px;
  border-radius:6px;
  border:1px dashed #444;
  background:#050505;
  font-size:.85rem;
  color:#ddd;
}

/* Image box */
.img-box{
  max-width:95%;
  margin:10px auto 4px;
  border:3px solid var(--red);
  border-radius:6px;
  padding:8px;
}
.img-box img{
  width:100%;
  border-radius:6px;
}

/* Toast & debug */
#toast{
  position:fixed;
  bottom:20px;
  left:50%;
  transform:translateX(-50%);
  background:var(--red);
  color:#fff;
  padding:8px 16px;
  border-radius:6px;
  opacity:0;
  transition:opacity .35s;
  z-index:10;
}
#debugLog{
  font-family:monospace;
  font-size:0.75rem;
  color:#0f0;
  background:#000;
  padding:6px;
  max-height:200px;
  overflow:auto;
  border-top:1px solid #222;
}

/* Simple responsive tweak */
@media (max-width:640px){
  section{ padding:12px 10px 14px; }
}
</style>
</head>

<body>

<header>
  <div class="bar-left">
    <span>ğŸ”’ Internal Use Only</span>
    <span id="livePill" class="pill offline">ğŸ“¡ Tracking: OFF</span>
  </div>
  <button class="refresh-btn" id="refreshPage">ğŸ”„ Refresh</button>
</header>

<h1>Big Red Connect â€” Admin Console</h1>
<p class="tagline">Veteran Owned â€¢ Affordable â€¢ Local â€¢ Trusted</p>

<div id="status-pill" class="status">Checking statusâ€¦</div>

<div class="grid">

  <!-- PUSH PANEL -->
  <section>
    <h2>Push Notifications</h2>
    <p class="meta">
      Send a quick push to everyone who chose Big Red Alerts on the homepage.
    </p>

    <div class="row">
      <label for="pushTemplate" style="font-size:.85rem;color:#ccc;">Template:</label>
    </div>

    <div class="row">
      <select id="pushTemplate">
        <option value="LIVE">ğŸš— LIVE â€” Ready to Roll</option>
        <option value="AIRPORT">âœˆï¸ Airport Runs</option>
        <option value="WEEKEND">ğŸ» Weekend Night Run</option>
        <option value="HOLIDAY">ğŸ„ Holiday Specials</option>
        <option value="CAMPUS">ğŸ…¿ï¸ Campus Corner Late Night</option>
        <option value="OFFLINE">ğŸ”´ Going Offline</option>
        <option value="CUSTOM">âœï¸ Custom Only</option>
      </select>
      <button class="btn-tertiary" id="pushApplyTemplate">Apply</button>
    </div>

    <div class="field-group">
      <div class="field">
        <label for="pushTitle" style="font-size:.85rem;color:#ccc;">Title</label>
        <input id="pushTitle" type="text" placeholder="Big Red Connect" />
      </div>

      <div class="field">
        <label for="pushMessage" style="font-size:.85rem;color:#ccc;">Message</label>
        <textarea id="pushMessage" placeholder="Enter message"></textarea>
      </div>

      <div class="field">
        <label for="pushUrl" style="font-size:.85rem;color:#ccc;">Tap-through Link (optional)</label>
        <input id="pushUrl" type="url" placeholder="https://bigredconnectokc.com/" />
      </div>
    </div>

    <div class="preview-box">
      <strong>Preview:</strong><br>
      <span id="pushPrevTitle">Big Red Connect</span><br>
      <span id="pushPrevMessage">Message will appear here.</span><br>
      <span style="color:#888;font-size:.8rem;">Link: <span id="pushPrevUrl">https://bigredconnectokc.com/</span></span>
    </div>

    <div class="row" style="margin-top:10px;">
      <button class="btn-primary" id="sendPush">ğŸ“£ Send Push Now</button>
      <button class="btn-secondary" id="clearPush">ğŸ§¹ Clear</button>
    </div>

    <p class="meta">
      Uses Cloudflare Worker â†’ OneSignal REST API. Sends instantly to all subscribed devices.
    </p>
  </section>

  <!-- STATUS PANEL (placeholder â€“ still wired for future use) -->
  <section>
    <h2>Driving Status</h2>

    <div class="row">
      <select id="statusSelect">
        <option value="online">ğŸŸ¢ On the Road</option>
        <option value="away">ğŸŸ¡ Limited Availability</option>
        <option value="offline">ğŸ”´ Offline</option>
      </select>
      <button class="btn-primary" id="updateStatusBtn">ğŸ’¾ Save</button>
    </div>

    <div class="meta">
      <div>Last status update: <span id="statusStamp">â€”</span></div>
      <div>Last GPS ping: <span id="gpsStamp">â€”</span> â€¢ Interval: <span id="gpsRate">â€”</span></div>
    </div>
  </section>

  <!-- SHARE PANEL (image + caption to Live Map) -->
  <section>
    <h2>Live Map â€” Preview & Caption</h2>
    <p class="meta">
      Choose an image + caption, then post to the public Live Map page.
    </p>

    <div class="img-box">
      <img id="statusImage" src="" alt="Preview">
    </div>

    <div class="row">
      <button id="prevImage" class="btn-tertiary">â¬… Image</button>
      <button id="nextImage" class="btn-tertiary">Image â¡</button>
    </div>

    <div class="row">
      <button id="prevCaption" class="btn-tertiary">â¬… Caption</button>
      <button id="nextCaption" class="btn-tertiary">Caption â¡</button>
      <button id="resetCaption" class="btn-secondary">Reset</button>
    </div>

    <label for="captionBox" style="margin-top:8px;display:block;font-size:.85rem;color:#ccc;">
      Caption (shows on Live Map + copy for socials)
    </label>
    <textarea id="captionBox">Loadingâ€¦</textarea>

    <div class="row" style="margin-top:10px;">
      <button class="btn-secondary" id="copyBtn">ğŸ“‹ Copy</button>
      <button class="btn-primary" id="postToLive">ğŸ“¢ Post to Live Map</button>
    </div>

    <p class="meta">
      Image + caption are stored via Worker and displayed on <strong>live.html</strong>.
    </p>
  </section>

</div>

<div id="toast"></div>
<div id="debugLog">[Debug started]</div>

<script>
/* ===================
   CONFIG
   =================== */
const STATUS_WORKER   = "https://bigred-status-updater.bigredtransportation.workers.dev";
const LOCATION_WORKER = "https://update-location.bigredtransportation.workers.dev";
const POST_WORKER     = "https://post-to-live-beta.bigredtransportation.workers.dev";

/* NEW: Push Worker routed through bigredconnectokc.com */
const PUSH_WORKER     = "https://bigredconnectokc.com/push/";

const AUTH_SECRET     = "BigRedPrivateKey2025";
const TZ              = "America/Chicago";

/* ===================
   TOAST / DEBUG HELPERS
   =================== */
function showToast(msg, ms = 2200){
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.style.opacity = 1;
  setTimeout(() => t.style.opacity = 0, ms);
}
function log(msg){
  const box = document.getElementById("debugLog");
  const time = new Date().toLocaleTimeString("en-US",{hour12:false});
  box.innerHTML = `[${time}] ${msg}<br>` + box.innerHTML;
}
function fmtLocal(iso){
  if(!iso) return "â€”";
  return new Date(iso).toLocaleString("en-US",{timeZone:TZ});
}

/* Header refresh button */
document.getElementById("refreshPage").onclick = () => {
  showToast("Refreshingâ€¦");
  setTimeout(() => location.reload(true), 300);
};

/* ===================
   PUSH PANEL LOGIC
   =================== */
const HOME_URL = "https://bigredconnectokc.com/";

const TEMPLATES = {
  LIVE: {
    title: "Big Red is LIVE",
    message: "Rolling now â€” text RED if you need a flat-rate connection.",
    url: HOME_URL
  },
  AIRPORT: {
    title: "Airport Runs Open",
    message: "Headed toward Will Rogers â€” message RED to line up your ride.",
    url: HOME_URL
  },
  WEEKEND: {
    title: "Weekend Night Run",
    message: "Out in the metro tonight? Iâ€™m rolling â€” ride local, ride safe.",
    url: HOME_URL
  },
  HOLIDAY: {
    title: "Holiday Specials",
    message: "Holiday light runs + flat-rate connections â€” plan ahead with Big Red.",
    url: HOME_URL
  },
  CAMPUS: {
    title: "Campus Corner Late Night",
    message: "OU late-night runs open â€” text RED for a safe ride home.",
    url: HOME_URL
  },
  OFFLINE: {
    title: "Big Red is Offline",
    message: "Thanks for riding local â€” Iâ€™ll be back soon.",
    url: HOME_URL
  }
};

function applyTemplate(){
  const key = document.getElementById("pushTemplate").value;
  if(key === "CUSTOM") return;

  const t = TEMPLATES[key];
  if(!t) return;

  document.getElementById("pushTitle").value   = t.title;
  document.getElementById("pushMessage").value = t.message;
  document.getElementById("pushUrl").value     = t.url;

  updatePreview();
}

function updatePreview(){
  const t = document.getElementById("pushTitle").value.trim()   || "Big Red Connect";
  const m = document.getElementById("pushMessage").value.trim() || "Message will appear here.";
  const u = document.getElementById("pushUrl").value.trim()     || HOME_URL;

  document.getElementById("pushPrevTitle").textContent   = t;
  document.getElementById("pushPrevMessage").textContent = m;
  document.getElementById("pushPrevUrl").textContent     = u;
}

/* Wire events */
document.getElementById("pushApplyTemplate").onclick = () => {
  applyTemplate();
  showToast("Template applied");
};
document.getElementById("pushTitle").oninput   = updatePreview;
document.getElementById("pushMessage").oninput = updatePreview;
document.getElementById("pushUrl").oninput     = updatePreview;

document.getElementById("clearPush").onclick = () => {
  document.getElementById("pushTitle").value   = "";
  document.getElementById("pushMessage").value = "";
  document.getElementById("pushUrl").value     = "";
  updatePreview();
};

document.getElementById("sendPush").onclick = async () => {
  const title   = (document.getElementById("pushTitle").value || "").trim() || "Big Red Connect";
  const message = (document.getElementById("pushMessage").value || "").trim();
  const url     = (document.getElementById("pushUrl").value || "").trim() || HOME_URL;

  if(!message){
    showToast("Message is required");
    return;
  }

  try{
    log("Sending push via Workerâ€¦");
    const res = await fetch(PUSH_WORKER,{
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "X-Admin-Secret": AUTH_SECRET
      },
      body: JSON.stringify({ title, message, url })
    });

    const text = await res.text();
    log("Push response: " + text);

    if(!res.ok){
      showToast("âš ï¸ Push failed");
      return;
    }

    showToast("ğŸ“£ Push sent!");
  }catch(err){
    log("Push error: " + err.message);
    showToast("âš ï¸ Push failed");
  }
};

/* Initialize push panel */
applyTemplate();
updatePreview();

/* ===================
   STATUS + LIVE MAP PREVIEW (lightweight)
   =================== */

const statusPill  = document.getElementById("status-pill");
const statusStamp = document.getElementById("statusStamp");
const gpsStamp    = document.getElementById("gpsStamp");
const gpsRate     = document.getElementById("gpsRate");
const statusSelect= document.getElementById("statusSelect");
const livePill    = document.getElementById("livePill");
const captionBox  = document.getElementById("captionBox");
const imageEl     = document.getElementById("statusImage");

function renderStatus(state, iso){
  statusPill.classList.remove("online","away","offline");
  const stamp = fmtLocal(iso);

  if(state === "online"){
    statusPill.classList.add("online");
    statusPill.textContent = `ğŸŸ¢ Online â€” as of ${stamp}`;
  } else if(state === "away"){
    statusPill.classList.add("away");
    statusPill.textContent = `ğŸŸ¡ Limited â€” as of ${stamp}`;
  } else {
    statusPill.classList.add("offline");
    statusPill.textContent = `ğŸ”´ Offline â€” as of ${stamp}`;
  }

  statusStamp.textContent = stamp;
}

/* Fetch current status on load */
async function fetchStatus(){
  try{
    const res = await fetch(`${STATUS_WORKER}/status?nocache=${Date.now()}`, { cache:"no-store" });
    const j   = await res.json();
    renderStatus(j.status, j.updated);
    statusSelect.value = j.status;
    updateCaptionVariants(j.status);
    pickImageSet(j.status);
  }catch(err){
    log("Status fetch error: " + err.message);
    renderStatus("offline");
  }
}

/* Save status */
document.getElementById("updateStatusBtn").onclick = async () => {
  const newStatus = statusSelect.value;
  const payload = { status:newStatus, updated:new Date().toISOString() };

  try{
    const res = await fetch(`${STATUS_WORKER}/status`, {
      method: "PUT",
      headers: {
        "Content-Type": "application/json",
        "X-Auth-Token": AUTH_SECRET
      },
      body: JSON.stringify(payload)
    });

    if(!res.ok){
      throw new Error(await res.text());
    }

    renderStatus(newStatus, payload.updated);
    updateCaptionVariants(newStatus);
    pickImageSet(newStatus);
    showToast("Status updated");
  }catch(err){
    log("Status update error: " + err.message);
    showToast("âš ï¸ Update failed");
  }
};

/* Caption variants */
let variants = [];
let originalVariants = [];
let captionIndex = 0;

function updateCaptionVariants(status){
  const weekday = new Date().toLocaleString("en-US",{weekday:"long"});
  const CTA =
    "\n\nNo surprises. Just solid local moves." +
    "\nText â€˜REDâ€™ to 405-378-4024 â€” your affordable flat-rate ride connection." +
    "\nVeteran Owned â€¢ Affordable â€¢ Local â€¢ Trusted." +
    "\nhttps://bigredconnectokc.com/";

  if(status === "online"){
    variants = [
      `ğŸš— ${weekday} Moves â€” Big Red Connect is LIVE! Letâ€™s roll.\n${CTA}`,
      `ğŸŒ™ ${weekday} Nights â€” Out and about? Big Redâ€™s on the move.\n${CTA}`,
      `ğŸ„ Holiday Run â€” Big Red is LIVE and rolling local tonight!\n${CTA}`
    ];
  } else if(status === "away"){
    variants = [
      `ğŸ•‘ ${weekday} Update â€” Iâ€™m stepping away but nearby. Text me if you need a connection.\n${CTA}`,
      `ğŸŸ¡ Limited Availability â€” I can take select rides, just message me first.\n${CTA}`
    ];
  } else {
    variants = [
      `ğŸ”´ Offline â€” Thank you for riding local! Back soon.\n${CTA}`,
      `ğŸ˜´ Signing off for now â€” see you later tonight or tomorrow.\n${CTA}`
    ];
  }

  originalVariants = variants.slice();
  captionIndex = 0;
  captionBox.value = variants[0] || "";
}

document.getElementById("prevCaption").onclick = () => {
  if(!variants.length) return;
  captionIndex = (captionIndex - 1 + variants.length) % variants.length;
  captionBox.value = variants[captionIndex];
};
document.getElementById("nextCaption").onclick = () => {
  if(!variants.length) return;
  captionIndex = (captionIndex + 1) % variants.length;
  captionBox.value = variants[captionIndex];
};
document.getElementById("resetCaption").onclick = () => {
  if(!originalVariants.length) return;
  captionBox.value = originalVariants[captionIndex] || originalVariants[0];
};

/* Image sets (using your GitHub images) */
const dayImgs = [
  "3F34BE7E-5953-433C-B8D0-17AC9108107F.png",
  "B02AB3EA-1AF5-4BE4-8CBB-E5A1AA40711F.png",
  "Big Red Live 2.png"
];
const nightImgs = [
  "3673A967-4A2D-4F9C-8602-0C820D31D168.png",
  "982ABF7A-D9F5-403D-BAE8-13777EC286FB.png",
  "0081086F-89FA-41B2-85EB-E4EE97E9E8EF.png"
];
const holidayImgs = [
  "BA7E86CF-5782-4323-B0B2-19918EF67887.png",
  "3673A967-4A2D-4F9C-8602-0C820D31D168.png",
  "982ABF7A-D9F5-403D-BAE8-13777EC286FB.png",
  "Big Red Live Holiday 1.png",
  "Big Red Live Christmas.png",
  "0081086F-89FA-41B2-85EB-E4EE97E9E8EF.png",
  "3F34BE7E-5953-433C-B8D0-17AC9108107F.png",
  "Big Red Live Thanksgiving.png"
];
const offlineImgs = [
  "3673A967-4A2D-4F9C-8602-0C820D31D168.png",
  "982ABF7A-D9F5-403D-BAE8-13777EC286FB.png",
  "0081086F-89FA-41B2-85EB-E4EE97E9E8EF.png"
];

let activeImages = [];
let imageIndex = 0;

function pickImageSet(status){
  const now   = new Date();
  const hour  = now.getHours();
  const month = now.getMonth();
  const isDay = hour >= 7 && hour < 18;
  const isHoliday = (month === 10 || month === 11); // Nov/Dec

  if(status === "offline"){
    activeImages = isHoliday ? holidayImgs.slice() : offlineImgs.slice();
  } else if(isHoliday){
    activeImages = holidayImgs.slice();
  } else if(isDay){
    activeImages = dayImgs.slice();
  } else {
    activeImages = nightImgs.slice();
  }

  if(!activeImages.length){
    activeImages = dayImgs.slice();
  }
  imageIndex = 0;
  applyImage();
}

function applyImage(){
  if(!activeImages.length) return;
  const filename = activeImages[imageIndex];
  const url = "https://raw.githubusercontent.com/bigred202403/Big-Red-Connect/main/" +
              encodeURIComponent(filename);
  imageEl.src = url;
}

document.getElementById("prevImage").onclick = () => {
  if(!activeImages.length) return;
  imageIndex = (imageIndex - 1 + activeImages.length) % activeImages.length;
  applyImage();
};
document.getElementById("nextImage").onclick = () => {
  if(!activeImages.length) return;
  imageIndex = (imageIndex + 1) % activeImages.length;
  applyImage();
};

/* Copy & Post to Live Map */
document.getElementById("copyBtn").onclick = () => {
  navigator.clipboard.writeText(captionBox.value || "");
  showToast("Copied caption");
};

document.getElementById("postToLive").onclick = async () => {
  const status  = statusSelect.value;
  const caption = captionBox.value || "";
  const image   = imageEl.src || "";

  try{
    const res = await fetch(POST_WORKER,{
      method:"PUT",
      headers:{
        "Content-Type":"application/json",
        "X-Admin-Secret":AUTH_SECRET
      },
      body:JSON.stringify({ status, caption, image })
    });

    const text = await res.text();
    log("Post-to-live response: " + text);

    if(!res.ok) throw new Error(text);

    showToast("ğŸ“¢ Posted to Live Map!");
  }catch(err){
    showToast("âš ï¸ Error posting");
    log("Post error: " + err.message);
  }
};

/* Init */
fetchStatus();
</script>

</body>
</html>