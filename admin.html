<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Admin Big Red</title>

<!-- ğŸ“± PWA -->
<link rel="apple-touch-icon" href="icon.PNG">
<link rel="icon" type="image/png" sizes="192x192" href="icon.png">
<link rel="shortcut icon" href="icon.PNG">
<link rel="manifest" href="manifest-admin.json">
<meta name="apple-mobile-web-app-title" content="Admin Big Red">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="theme-color" content="#000000">

<style>
  body { background:#000; color:#fff; font-family:Arial, sans-serif; text-align:center; margin:0; }
  header { background:#111; border-bottom:2px solid #b30000; padding:10px 0; }
  h1 { color:#b30000; margin:10px 0 5px; }
  p.tagline { color:#ccc; margin:0 0 20px; }

  .status { display:inline-block; padding:10px 16px; border-radius:20px; background:#222; margin:10px 0; }
  .status.online { background:#064; }
  .status.away { background:#665500; }
  .status.offline { background:#400; }

  .panel { background:#111; border:1px solid #333; border-radius:10px; padding:20px; max-width:400px; margin:20px auto; }
  select, button { font-size:1em; padding:10px; border-radius:6px; margin:6px; border:none; }
  .btn-primary { background:#b30000; color:#fff; }
  .btn-secondary { background:#000; border:1px solid #b30000; color:#fff; }
  footer { margin:20px 0; color:#aaa; font-size:.9em; }

  .img-box { margin-top:15px; }
  .img-box img { width:90%; border:2px solid #b30000; border-radius:8px; }

  textarea {
    width:90%;
    max-width:600px;
    height:100px;
    background:#111;
    border:1px solid #b30000;
    border-radius:8px;
    color:#fff;
    padding:10px;
    font-family:Arial, sans-serif;
  }
</style>
</head>

<body>
<header>
  <h1>Big Red Connect â€” Admin Panel</h1>
  <p class="tagline">Veteran Owned â€¢ Affordable â€¢ Local â€¢ Trusted</p>
</header>

<div id="status-pill" class="status">Checking statusâ€¦</div>

<div class="panel">
  <h2>Driving Status</h2>
  <select id="statusSelect">
    <option value="online">ğŸŸ¢ On the Road</option>
    <option value="away">ğŸŸ¡ Limited Availability</option>
    <option value="offline">ğŸ”´ Offline</option>
  </select>
  <br />
  <button id="updateStatusBtn" class="btn-primary">ğŸ’¾ Save Status</button>
  <button id="refreshBtn" class="btn-secondary">ğŸ”„ Refresh</button>
  <p style="color:#aaa;font-size:0.9em;">
    Updates your live status and location instantly across all devices.
  </p>
</div>

<div class="panel">
  <h2>Social Post Builder</h2>
  <div class="img-box"><img id="statusImage" src="" alt="Preview" /></div>
  <textarea id="captionBox" readonly>Loading caption...</textarea>
  <br />
  <button id="copyBtn" class="btn-secondary">ğŸ“‹ Copy Caption</button>
  <button id="shareBtn" class="btn-primary">ğŸ“¤ Share on Facebook</button>
  <p style="color:#aaa;font-size:0.85em;">Preview uses automatic holiday/day/night logic.</p>
</div>

<footer>
  <p>Â© 2025 Big Red Connect â€” Admin Console</p>
</footer>

<script>
const STATUS_WORKER = "https://bigred-status-updater.bigredtransportation.workers.dev";
const LOCATION_WORKER = "https://update-location.bigredtransportation.workers.dev/";
const AUTH_SECRET = "BigRedPrivateKey2025";

const select = document.getElementById("statusSelect");
const saveBtn = document.getElementById("updateStatusBtn");
const refreshBtn = document.getElementById("refreshBtn");
const pill = document.getElementById("status-pill");

let gpsInterval = null;
let wakeLock = null;

// ---- Status Fetch ----
async function fetchStatus() {
  try {
    const res = await fetch(STATUS_WORKER + "/status?nocache=" + Date.now(), { cache: "no-store" });
    const j = await res.json();
    select.value = j.status;
    updatePill(j.status, j.updated);
    buildPreview(j.status);
  } catch {
    updatePill("offline");
  }
}

// ---- Status Update ----
async function updateStatus() {
  const newStatus = select.value;
  const payload = { status: newStatus, updated: new Date().toISOString() };

  try {
    const res = await fetch(STATUS_WORKER + "/", {
      method: "PUT",
      mode: "cors",
      headers: {
        "Accept": "application/json",
        "Content-Type": "application/json",
        "X-Auth-Token": AUTH_SECRET
      },
      body: JSON.stringify(payload)
    });
    if (!res.ok) throw new Error(await res.text());
    updatePill(newStatus, payload.updated);
    alert("âœ… Status updated successfully!");

    buildPreview(newStatus);
    if (newStatus === "online") { startGPSUpdates(); requestWakeLock(); }
    else { stopGPSUpdates(); releaseWakeLock(); }

  } catch (err) {
    console.warn("âš ï¸ Update failed:", err);
    alert("Network error: unable to update status.");
  }
}

// ---- Caption Builder ----
function buildPreview(status){
  const img = document.getElementById("statusImage");
  const caption = document.getElementById("captionBox");

  const now = new Date();
  const month = now.getMonth();
  const hour = now.getHours();

  let imgName = "Big Red Live 2.png";
  const isHoliday = (month === 10 || month === 11);
  const isDay = (hour >= 7 && hour < 18);

  if (isHoliday) imgName = "Big Red Live Holiday 1.png";
  else if (!isDay) imgName = "Big Red Live Christmas.png";

  img.src = `https://raw.githubusercontent.com/bigred202403/Big-Red-Connect/main/${encodeURIComponent(imgName)}`;

  let base = "";
  if (status === "online") {
    base = isHoliday ? "ğŸ„ Big Red Connect is LIVE â€” plan ahead this holiday season!"
      : isDay ? "ğŸš— Big Red Connect is LIVE â€” your affordable flat-rate connection."
      : "ğŸŒ™ Big Red Connect is LIVE â€” from last call to your front door.";
  } else if (status === "away") {
    base = "ğŸ•‘ Big Red Connect is temporarily away â€” back soon!";
  } else {
    base = "ğŸ”´ Big Red Connect is currently offline. Thanks for riding local!";
  }
  caption.value = base + "\n\nVeteran Owned â€¢ Affordable â€¢ Local â€¢ Trusted.";
}

document.getElementById("copyBtn").onclick = () => {
  navigator.clipboard.writeText(document.getElementById("captionBox").value);
  alert("ğŸ“‹ Caption copied!");
};

document.getElementById("shareBtn").onclick = () => {
  const text = encodeURIComponent(document.getElementById("captionBox").value);
  window.open(
    `https://www.facebook.com/sharer/sharer.php?u=https://bigred202403.github.io/Big-Red-Connect/&quote=${text}`,
    "_blank"
  );
};

// ---- GPS Updates ----
async function sendGPS(lat, lng) {
  const coords = { latitude: lat, longitude: lng, timestamp: new Date().toISOString() };
  try {
    await fetch(LOCATION_WORKER, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(coords)
    });
    console.log("ğŸ“¡ GPS updated:", lat, lng);
  } catch (err) { console.warn("âš ï¸ GPS update failed:", err); }
}

function startGPSUpdates() {
  if (gpsInterval) clearInterval(gpsInterval);
  if (!navigator.geolocation) return alert("GPS not supported on this device.");
  const push = () => {
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        const { latitude, longitude } = pos.coords;
        sendGPS(latitude, longitude);
      },
      (err) => console.warn("GPS error:", err),
      { enableHighAccuracy: true, maximumAge: 15000, timeout: 10000 }
    );
  };
  push();
  gpsInterval = setInterval(push, 30000);
}

function stopGPSUpdates() {
  if (gpsInterval) { clearInterval(gpsInterval); gpsInterval = null; }
}

// ---- Wake Lock ----
async function requestWakeLock() {
  try {
    if ("wakeLock" in navigator) {
      wakeLock = await navigator.wakeLock.request("screen");
      console.log("ğŸ”’ WakeLock active");
    }
  } catch (err) {
    console.warn("WakeLock failed:", err);
  }
}
async function releaseWakeLock() {
  if (wakeLock) { await wakeLock.release(); wakeLock = null; }
}

// ---- Update Pill ----
function updatePill(state, iso = null) {
  const now = iso ? new Date(iso) : new Date();
  const stamp = now.toLocaleString("en-US", {
    month: "short", day: "numeric", hour: "numeric", minute: "2-digit",
    timeZone: "America/Chicago", timeZoneName: "short"
  });
  pill.classList.remove("online","away","offline");
  if (state === "online") pill.classList.add("online"), pill.textContent = `ğŸŸ¢ Online â€” as of ${stamp}`;
  else if (state === "away") pill.classList.add("away"), pill.textContent = `ğŸŸ¡ Limited â€” as of ${stamp}`;
  else pill.classList.add("offline"), pill.textContent = `ğŸ”´ Offline â€” as of ${stamp}`;
}

saveBtn.onclick = updateStatus;
refreshBtn.onclick = () => location.reload(true);
fetchStatus();

// ---- Register PWA SW ----
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("sw.js")
      .then(() => console.log("âœ… Service worker registered"))
      .catch(err => console.warn("âš ï¸ SW registration failed:", err));
  });
}
</script>
</body>
</html>