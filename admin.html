<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Big Red Admin</title>
<link rel="stylesheet" href="shimmer.css">

<style>
    body {
        background:#0b0b0b;
        margin:0;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto;
        color:white;
    }
    header {
        background:#121212;
        padding:14px;
        border-bottom:2px solid #900;
        display:flex;
        justify-content:space-between;
        align-items:center;
    }
    h1 {
        font-size:1.2rem;
        margin:0;
        font-weight:600;
    }
    .pill {
        padding:6px 14px;
        border-radius:20px;
        font-size:0.85rem;
        font-weight:600;
        display:inline-block;
    }
    .offline { background:#550000; color:#ffb3b3; }
    .online { background:#004d00; color:#b6ffb6; }
    .container {
        padding:15px;
    }
    .img-box {
        width:100%;
        height:250px;
        border:2px solid #900;
        border-radius:10px;
        display:flex;
        align-items:center;
        justify-content:center;
        overflow:hidden;
        margin-bottom:12px;
        background:black;
    }
    .img-box img {
        width:100%;
        height:100%;
        object-fit:cover;
    }
    button {
        width:48%;
        padding:12px;
        margin-top:6px;
        font-size:1rem;
        border:none;
        border-radius:8px;
        background:#222;
        color:white;
    }
    .red-btn { background:#990000; }
    .green-btn { background:#006600; }
    .row { display:flex; justify-content:space-between; gap:10px; }
    textarea {
        width:100%;
        height:100px;
        margin-top:10px;
        background:#111;
        border:1px solid #444;
        border-radius:8px;
        padding:10px;
        color:white;
        font-size:1rem;
    }
    select {
        width:100%;
        background:#111;
        color:white;
        padding:10px;
        border-radius:8px;
        margin-top:8px;
        border:1px solid #444;
        font-size:1rem;
    }
    #debug {
        margin-top:20px;
        padding:15px;
        background:black;
        border:1px solid #333;
        border-radius:10px;
        font-size:0.8rem;
        white-space:pre-wrap;
    }
</style>
</head>

<body>

<header>
    <h1>ğŸ”’ Big Red Admin</h1>
    <div>
        <span id="statusPill" class="pill offline">Checkingâ€¦</span>
        <button id="refreshBtn" style="margin-left:10px;font-size:0.8rem;">ğŸ”„ Refresh</button>
    </div>
</header>

<div class="container">

    <div class="img-box">
        <img id="previewImg" src="" alt="preview">
    </div>

    <div class="row">
        <button id="prevImg">â¬… Image</button>
        <button id="nextImg">Image â¡</button>
    </div>

    <select id="templateSelect">
        <option value="">ğŸ„ Christmas Templates</option>
        <option>ğŸ„ Big Red Connect is LIVE â€” serving OKC, Moore, Norman, Mustang & Yukon! Text RED to 405-378-4024.</option>
        <option>ğŸ„ Stay merry, stay safe â€” Big Red Connect is running tonight! Flat-rate connections all across the metro.</option>
        <option>ğŸ„ Need a lift between Christmas events? Big Red Connect has you covered. Text RED to 405-378-4024!</option>
        <option>ğŸ Holiday lights, concerts, nightlife â€” ride local, ride safe with Big Red Connect tonight!</option>
        <option>â­ Big Red Connect is up and rolling â€” affordable flat-rate rides across the metro!</option>
        <option>ğŸš—âœ¨ Your connection is covered â€” text RED to 405-378-4024 for your flat-rate ride!</option>
    </select>

    <textarea id="captionBox"></textarea>

    <div class="row">
        <button class="red-btn" id="copyBtn">ğŸ“‹ Copy</button>
        <button class="green-btn" id="liveBtn">ğŸ“£ Post to Live Map</button>
    </div>

    <button class="red-btn" style="width:100%;margin-top:10px;" id="pushBtn">ğŸ“¢ Send Push Notification</button>

    <pre id="debug"></pre>
</div>

<script>
/* -------------------------------------------
   CONFIG
-------------------------------------------*/
const STATUS_URL = "https://bigredconnectokc.com/status";
const PUSH_URL = "https://bigredconnectokc.com/push/send";
const AUTH_SECRET = "BigRedPrivateKey2025";

/* -------------------------------------------
   STATE
-------------------------------------------*/
let images = [];
let currentIndex = 0;

/* -------------------------------------------
   DEBUG HELPER
-------------------------------------------*/
function log(msg) {
    const el = document.getElementById("debug");
    el.textContent += `[${new Date().toLocaleTimeString()}] ${msg}\n`;
    el.scrollTop = el.scrollHeight;
}

/* -------------------------------------------
   LOAD ALL ROOT IMAGES
-------------------------------------------*/
async function loadImages() {
    const res = await fetch(".");
    const text = await res.text();

    const matches = [...text.matchAll(/href="([^"]+\.(png|jpg|jpeg))"/gi)];
    images = matches.map(m => m[1]);

    if (images.length === 0) {
        log("No images found in repo root.");
        return;
    }
    log(`Loaded ${images.length} images.`);

    let savedIndex = localStorage.getItem("brc_last_image");
    if (savedIndex) currentIndex = parseInt(savedIndex);

    updateImage();
}

/* -------------------------------------------
   UPDATE IMAGE PREVIEW
-------------------------------------------*/
function updateImage() {
    if (images.length === 0) return;
    if (currentIndex < 0) currentIndex = images.length - 1;
    if (currentIndex >= images.length) currentIndex = 0;

    const imgEl = document.getElementById("previewImg");
    imgEl.src = images[currentIndex];

    localStorage.setItem("brc_last_image", currentIndex);
    log(`Image set: ${images[currentIndex]}`);
}

/* -------------------------------------------
   STATUS LOADING
-------------------------------------------*/
async function loadStatus() {
    const res = await fetch(STATUS_URL);
    const data = await res.json();

    const pill = document.getElementById("statusPill");

    const when = new Date(data.lastUpdated).toLocaleTimeString([], { hour:"numeric", minute:"2-digit" });

    if (data.online) {
        pill.className = "pill online";
        pill.textContent = `ONLINE â€” as of ${when}`;
    } else {
        pill.className = "pill offline";
        pill.textContent = `OFFLINE â€” as of ${when}`;
    }

    log("Status loaded.");
}

/* -------------------------------------------
   POST TO LIVE MAP
-------------------------------------------*/
async function postLive() {
    const caption = document.getElementById("captionBox").value;

    await fetch("status.js"); // keep your existing script logic alive

    localStorage.setItem("brc_last_caption", caption);

    log("Live map updated (handled by status.js).");
    alert("Live map updated!");
}

/* -------------------------------------------
   SEND PUSH NOTIFICATION
-------------------------------------------*/
async function sendPush() {
    const caption = document.getElementById("captionBox").value;

    const payload = {
        title: "Big Red Connect",
        message: caption,
        url: "https://bigredconnectokc.com/"
    };

    const res = await fetch(PUSH_URL, {
        method:"POST",
        headers:{
            "Content-Type":"application/json",
            "X-Admin-Secret": AUTH_SECRET
        },
        body: JSON.stringify(payload)
    });

    const text = await res.text();
    log(`Push Worker response (${res.status}): ${text}`);

    if (res.status === 200 || res.status === 201) {
        alert("Push sent!");
    } else {
        alert("Push failed â€” see debugger.");
    }
}

/* -------------------------------------------
   INIT
-------------------------------------------*/
window.onload = () => {
    loadImages();
    loadStatus();

    const saved = localStorage.getItem("brc_last_caption");
    if (saved) document.getElementById("captionBox").value = saved;

    document.getElementById("prevImg").onclick = () => { currentIndex--; updateImage(); };
    document.getElementById("nextImg").onclick = () => { currentIndex++; updateImage(); };
    document.getElementById("copyBtn").onclick = () => navigator.clipboard.writeText(captionBox.value);
    document.getElementById("liveBtn").onclick = postLive;
    document.getElementById("pushBtn").onclick = sendPush;
    document.getElementById("refreshBtn").onclick = loadStatus;

    document.getElementById("templateSelect").onchange = e => {
        if (e.target.value) {
            captionBox.value = e.target.value;
            localStorage.setItem("brc_last_caption", e.target.value);
        }
    };
};
</script>

</body>
</html>