<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Admin Big Red</title>

<!-- Icons / PWA basics -->
<link rel="apple-touch-icon" href="icon.PNG">
<link rel="icon" type="image/png" sizes="192x192" href="icon.png">
<link rel="shortcut icon" href="icon.PNG">
<meta name="theme-color" content="#000000">

<style>
:root { --red:#b30000; --bg:#000; --panel:#111; --muted:#aaa; }
body{
  background:var(--bg);
  color:#fff;
  font-family:Arial,Helvetica,sans-serif;
  margin:0;
  text-align:center;
}
header{
  background:var(--panel);
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:10px 16px;
  border-bottom:2px solid var(--red);
}
.bar-left{
  color:#bbb;
  font-size:.92em;
  display:flex;
  gap:10px;
  align-items:center;
}
.pill{
  padding:4px 10px;
  border-radius:999px;
  font-weight:700;
  font-size:.85em;
}
.pill.online{background:#064;}
.pill.away{background:#665500;}
.pill.offline{background:#400;}

.refresh-btn{
  background:var(--red);
  color:#fff;
  border:none;
  padding:8px 14px;
  border-radius:6px;
  cursor:pointer;
  font-weight:700;
}
.refresh-btn:hover{background:#cc0000;}

h1{
  margin:18px 0 6px;
  color:var(--red);
  font-size:1.6rem;
}
.tagline{
  color:#ddd;
  margin:0 0 8px;
  font-size:.95rem;
}

.status{
  margin:10px auto;
  padding:10px;
  border-radius:6px;
  display:inline-block;
  min-width:280px;
}
.status.online{background:#064;}
.status.away{background:#665500;}
.status.offline{background:#400;}

.grid{
  display:grid;
  grid-template-columns:1fr;
  gap:18px;
  max-width:880px;
  margin:0 auto;
  padding:10px 16px 24px;
}
section{
  background:var(--panel);
  border:1px solid #222;
  border-radius:8px;
  padding:14px;
}
section h2{
  margin:6px 0 12px;
  font-size:1.25rem;
}

select,button,input,textarea{
  font-family:inherit;
  font-size:1rem;
}
button{
  padding:10px 18px;
  border-radius:6px;
  border:none;
  margin:6px;
  font-weight:700;
  cursor:pointer;
}
.btn-primary{background:var(--red);color:#fff;}
.btn-secondary{background:#000;color:#fff;border:1px solid var(--red);}
.btn-tertiary{background:#222;color:#fff;border:1px solid #555;}

.row{
  display:flex;
  justify-content:center;
  align-items:center;
  flex-wrap:wrap;
  gap:6px;
}
.meta{
  color:var(--muted);
  font-size:.85em;
  margin-top:6px;
}

.img-box{
  max-width:95%;
  margin:10px auto 4px;
  border:3px solid var(--red);
  border-radius:6px;
  padding:8px;
}
.img-box img{
  width:100%;
  border-radius:6px;
}

textarea{
  width:95%;
  max-width:780px;
  background:#111;
  color:#fff;
  border:2px solid var(--red);
  border-radius:6px;
  padding:8px;
}

#shareCaption{
  height:160px;
}
#pushBody{
  height:110px;
}

footer{
  margin:18px 0 24px;
  font-size:.9em;
  color:#777;
}

#toast{
  position:fixed;
  bottom:20px;
  left:50%;
  transform:translateX(-50%);
  background:var(--red);
  color:#fff;
  padding:8px 16px;
  border-radius:6px;
  opacity:0;
  transition:opacity .35s;
  z-index:5;
}
#debugLog{
  font-family:monospace;
  font-size:0.75rem;
  color:#0f0;
  background:#000;
  padding:6px;
  max-height:200px;
  overflow:auto;
  text-align:left;
  border-top:1px solid #222;
}

/* Push preview box */
.push-preview{
  border:1px solid #333;
  border-radius:6px;
  padding:8px;
  text-align:left;
  max-width:780px;
  margin:10px auto 0;
  background:#000;
}
.push-title-preview{
  font-weight:700;
  margin-bottom:4px;
}
.push-body-preview{
  font-size:.9rem;
}

/* Share builder */
.share-top-label{
  text-align:left;
  max-width:780px;
  margin:6px auto 0;
  font-size:.9rem;
}
.share-char{
  text-align:left;
  max-width:780px;
  margin:4px auto 0;
  font-size:.8rem;
  color:var(--muted);
}
.share-char span{
  font-weight:700;
  color:#fff;
}
.share-bottom-note{
  max-width:780px;
  margin:8px auto 0;
  font-size:.9rem;
}
.share-controls{
  max-width:780px;
  margin:0 auto;
  text-align:left;
}
.share-controls label{
  font-size:.95rem;
}
.share-preset-row{
  display:flex;
  flex-wrap:wrap;
  gap:6px;
  justify-content:flex-start;
  align-items:center;
  max-width:780px;
  margin:6px auto 0;
}
.share-preset-row select{
  padding:8px 10px;
  border-radius:6px;
  border:1px solid #555;
  background:#000;
  color:#fff;
}
</style>
</head>
<body>

<header>
  <div class="bar-left">
    <span>ğŸ”’ Internal Use Only</span>
    <span id="livePill" class="pill offline">ğŸ“¡ Tracking: OFF</span>
  </div>
  <button class="refresh-btn" id="refreshPage">ğŸ”„ Refresh Page</button>
</header>

<h1>Big Red Connect â€” Admin Console</h1>
<p class="tagline">Veteran Owned â€¢ Affordable â€¢ Local â€¢ Trusted</p>

<div id="status-pill" class="status">Checking statusâ€¦</div>

<div class="grid">

  <!-- PUSH NOTIFICATION SECTION -->
  <section id="push">
    <h2>Send Push Notification</h2>

    <div class="row">
      <select id="pushTemplate">
        <option value="LIVE">ğŸš— LIVE â€” Ready to Roll</option>
        <option value="AIRPORT">âœˆï¸ Airport Runs</option>
        <option value="WEEKEND">ğŸ» Weekend Night Run</option>
        <option value="HOLIDAY">ğŸ„ Holiday Specials</option>
        <option value="CAMPUS">ğŸ…¿ï¸ Campus Corner Late Night</option>
        <option value="OFFLINE">ğŸ”´ Going Offline</option>
      </select>
    </div>

    <div class="share-controls" style="margin-top:8px;">
      <div style="margin-bottom:6px;text-align:left;max-width:780px;margin-inline:auto;">
        <label for="pushTitle">Title</label>
      </div>
      <input id="pushTitle" type="text"
             style="width:95%;max-width:780px;background:#111;color:#fff;border:2px solid var(--red);border-radius:6px;padding:8px;"
             placeholder="Notification title (e.g., Big Red is LIVE)" />

      <div style="margin:10px auto 6px;text-align:left;max-width:780px;">
        <label for="pushBody">Message</label>
      </div>
      <textarea id="pushBody" placeholder="Notification body text..."></textarea>
    </div>

    <div class="push-preview">
      <div style="font-size:.8rem;color:var(--muted);margin-bottom:4px;">Preview</div>
      <div class="push-title-preview" id="pushPreviewTitle">Big Red is LIVE</div>
      <div class="push-body-preview" id="pushPreviewBody">
        Iâ€™m on the road now â€” message me if you need a connection.
      </div>
    </div>

    <div class="row" style="margin-top:10px;">
      <button class="btn-primary" id="sendPush">ğŸ“£ Send Push</button>
    </div>

    <div class="meta">
      Sends instantly to every subscriber who has enabled notifications.
    </div>
  </section>

  <!-- CONTROL -->
  <section id="control">
    <h2>Update Driving Status</h2>
    <div class="row">
      <select id="statusSelect">
        <option value="online">ğŸŸ¢ On the Road</option>
        <option value="away">ğŸŸ¡ Limited Availability</option>
        <option value="offline">ğŸ”´ Offline</option>
      </select>
      <button class="btn-primary" id="updateStatusBtn">ğŸ’¾ Save Status</button>
    </div>
    <div class="meta">
      <div>Last status update: <span id="statusStamp">â€”</span></div>
      <div>Last GPS ping: <span id="gpsStamp">â€”</span> â€¢ Interval: <span id="gpsRate">â€”</span></div>
    </div>
  </section>

  <!-- QUICK SHARE BUILDER -->
  <section id="share">
    <h2>Quick Share Builder</h2>

    <div class="img-box">
      <img id="statusImage" src="" alt="Preview">
    </div>

    <div class="row">
      <button id="prevImage" class="btn-tertiary">â¬… Image</button>
      <button id="nextImage" class="btn-tertiary">Image â¡</button>
      <button id="prevTemplate" class="btn-tertiary">â¬… Template</button>
      <button id="nextTemplate" class="btn-tertiary">Template â¡</button>
    </div>

    <div class="share-controls">
      <div style="margin-top:6px;">
        <label>
          <input type="checkbox" id="enableCustom" />
          <span>Enable Custom Caption</span>
        </label>
      </div>
    </div>

    <p class="share-top-label">
      Caption for Facebook / Live Map:
    </p>

    <textarea id="shareCaption" placeholder="Type your custom caption here..."></textarea>

    <div class="share-char">
      <span id="charCount">0</span> characters
    </div>

    <div class="share-preset-row">
      <select id="presetSelect">
        <option value="">Insert saved caption...</option>
      </select>
      <button class="btn-secondary" id="savePreset">ğŸ’¾ Save Current as Preset</button>
    </div>

    <div class="row" style="margin-top:10px;">
      <button class="btn-secondary" id="copyBtn">ğŸ“‹ Copy Caption</button>
      <button class="btn-primary" id="postToLive">ğŸ“¢ Post to Live Page</button>
    </div>

    <p class="share-bottom-note">
      This caption + image appears on the public <strong>Live Map</strong> page.
    </p>
  </section>

</div>

<footer>Â© 2025 Big Red Connect â€” Admin Panel</footer>
<div id="toast"></div>
<div id="debugLog">[Debug log started]</div>

<script>
/* === CONFIG === */
const STATUS_WORKER  = "https://bigred-status-updater.bigredtransportation.workers.dev";
const LOCATION_WORKER= "https://update-location.bigredtransportation.workers.dev";
const POST_WORKER    = "https://post-to-live-beta.bigredtransportation.workers.dev";
const PUSH_WORKER    = "https://bigred-send-push.bigredtransportation.workers.dev/";
const AUTH_SECRET    = "BigRedPrivateKey2025";
const TZ             = "America/Chicago";

/* === ELEMENT REFERENCES === */
const pill        = document.getElementById("status-pill");
const statusStamp = document.getElementById("statusStamp");
const gpsStamp    = document.getElementById("gpsStamp");
const gpsRate     = document.getElementById("gpsRate");
const select      = document.getElementById("statusSelect");
const livePill    = document.getElementById("livePill");
const toast       = document.getElementById("toast");
const debugEl     = document.getElementById("debugLog");

/* Share builder elements */
const imageEl       = document.getElementById("statusImage");
const shareCaption  = document.getElementById("shareCaption");
const enableCustom  = document.getElementById("enableCustom");
const charCountEl   = document.getElementById("charCount");
const presetSelect  = document.getElementById("presetSelect");
const savePresetBtn = document.getElementById("savePreset");

/* Push elements */
const pushTemplateSel = document.getElementById("pushTemplate");
const pushTitleInput  = document.getElementById("pushTitle");
const pushBodyInput   = document.getElementById("pushBody");
const pushPreviewTitle= document.getElementById("pushPreviewTitle");
const pushPreviewBody = document.getElementById("pushPreviewBody");

/* === TOAST & DEBUG === */
function showToast(msg, ms=2500){
  toast.textContent = msg;
  toast.style.opacity = 1;
  setTimeout(() => toast.style.opacity = 0, ms);
}
function logDebug(msg){
  const now = new Date().toLocaleTimeString("en-US",{hour12:false});
  debugEl.innerHTML = `[${now}] ${msg}<br>` + debugEl.innerHTML;
}
function fmtLocal(iso){
  if(!iso) return "â€”";
  return new Date(iso).toLocaleString("en-US",{timeZone:TZ});
}

/* === REFRESH BUTTON === */
document.getElementById("refreshPage").onclick = () => {
  showToast("Refreshingâ€¦");
  setTimeout(() => location.reload(true), 350);
};

/* === STATUS FETCH === */
async function fetchStatus(){
  try{
    const res = await fetch(`${STATUS_WORKER}/status?nocache=${Date.now()}`, { cache:"no-store" });
    const j   = await res.json();
    renderStatusPill(j.status, j.updated);
    select.value = j.status || "offline";
    initShareBuilder(j.status || "offline");
    if(j.status === "online") startGPSLoop(30000);
    else stopGPSLoop();
  }catch(err){
    logDebug("Status fetch error: " + err.message);
    renderStatusPill("offline");
    initShareBuilder("offline");
  }
}

function renderStatusPill(state, iso){
  pill.classList.remove("online","away","offline");
  const stamp = fmtLocal(iso);
  if(state === "online"){
    pill.classList.add("online");
    pill.textContent = `ğŸŸ¢ Online â€” as of ${stamp}`;
  } else if(state === "away"){
    pill.classList.add("away");
    pill.textContent = `ğŸŸ¡ Limited â€” as of ${stamp}`;
  } else {
    pill.classList.add("offline");
    pill.textContent = `ğŸ”´ Offline â€” as of ${stamp}`;
  }
  statusStamp.textContent = stamp;
}

/* === SAVE STATUS === */
document.getElementById("updateStatusBtn").onclick = async () => {
  const newStatus = select.value;
  const payload = { status:newStatus, updated:new Date().toISOString() };

  try{
    const res = await fetch(`${STATUS_WORKER}/`,{
      method:"PUT",
      headers:{
        "Content-Type":"application/json",
        "X-Auth-Token":AUTH_SECRET
      },
      body:JSON.stringify(payload)
    });

    if(!res.ok) throw new Error(await res.text());

    renderStatusPill(newStatus, payload.updated);
    if(!enableCustom.checked){
      initShareBuilder(newStatus);
    }
    showToast("Status updated!");

    if(newStatus === "online") startGPSLoop(30000);
    else stopGPSLoop();

  }catch(err){
    showToast("âš ï¸ Update failed");
    logDebug("Status update error: " + err.message);
  }
};

/* === GPS LOOP === */
let gpsTimerActive = false;
let wakeLock       = null;

function setLivePill(active, rateMs){
  livePill.classList.remove("online","away","offline");
  livePill.classList.add(active ? "online" : "offline");
  livePill.textContent = active ? "ğŸ“¡ Tracking: ON" : "ğŸ“¡ Tracking: OFF";
  gpsRate.textContent  = active ? `${Math.round(rateMs/1000)}s` : "â€”";
}

async function sendGPS(lat,lng){
  const payload = {
    latitude : lat,
    longitude: lng,
    timestamp: new Date().toISOString()
  };
  try{
    logDebug(`GPS â†’ ${lat.toFixed(5)}, ${lng.toFixed(5)}`);
    const res = await fetch(LOCATION_WORKER,{
      method:"PUT",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify(payload)
    });
    if(res.ok){
      gpsStamp.textContent = fmtLocal(payload.timestamp);
      logDebug("GPS OK");
    }else{
      logDebug("GPS FAIL " + res.status);
    }
  }catch(err){
    logDebug("GPS ERR " + err.message);
  }
}

function startGPSLoop(intervalMs){
  stopGPSLoop();
  gpsTimerActive = true;
  setLivePill(true, intervalMs);
  requestWakeLock();

  const loop = () => {
    if(!gpsTimerActive) return;
    if(navigator.geolocation){
      navigator.geolocation.getCurrentPosition(
        pos => sendGPS(pos.coords.latitude, pos.coords.longitude),
        err => logDebug("GPS ERROR " + err.message),
        { enableHighAccuracy:true, maximumAge:8000, timeout:8000 }
      );
    }
    setTimeout(loop, intervalMs);
  };
  loop();
}

function stopGPSLoop(){
  gpsTimerActive = false;
  setLivePill(false, 0);
  releaseWakeLock();
}

async function requestWakeLock(){
  try{
    if("wakeLock" in navigator){
      wakeLock = await navigator.wakeLock.request("screen");
    }
  }catch{}
}
async function releaseWakeLock(){
  if(wakeLock){
    try{ await wakeLock.release(); }catch{}
    wakeLock = null;
  }
}

window.addEventListener("pagehide", () => stopGPSLoop());

/* === PUSH TEMPLATES === */
const PUSH_TEMPLATES = {
  LIVE: {
    title: "Big Red is LIVE",
    body : "Iâ€™m on the road now â€” message me if you need a connection."
  },
  AIRPORT: {
    title: "Airport Runs Open",
    body : "Headed toward Will Rogers â€” text RED if you need a flat-rate airport ride."
  },
  WEEKEND: {
    title: "Weekend Night Run",
    body : "Rolling through the metro tonight. Message me if you need a safe ride home."
  },
  HOLIDAY: {
    title: "Holiday Lights & Rides",
    body : "Holiday specials + lights tours â€” plan ahead and message RED to lock in your spot."
  },
  CAMPUS: {
    title: "Campus Corner Late Night",
    body : "OU late-night runs are open. Message RED if you need a ride off Campus Corner."
  },
  OFFLINE: {
    title: "Big Red is Offline",
    body : "Thanks for riding local with Big Red Connect â€” Iâ€™ll be back on the road soon."
  }
};

function applyPushTemplate(key){
  const tpl = PUSH_TEMPLATES[key] || PUSH_TEMPLATES.LIVE;
  pushTemplateSel.value = key;
  pushTitleInput.value  = tpl.title;
  pushBodyInput.value   = tpl.body;
  updatePushPreview();
}

function updatePushPreview(){
  pushPreviewTitle.textContent = pushTitleInput.value.trim() || "Big Red Connect";
  pushPreviewBody.textContent  = pushBodyInput.value.trim()  || "Notification body will appear here.";
}

pushTemplateSel.addEventListener("change", () => {
  applyPushTemplate(pushTemplateSel.value);
});
pushTitleInput.addEventListener("input", updatePushPreview);
pushBodyInput.addEventListener("input", updatePushPreview);

document.getElementById("sendPush").onclick = async () => {
  const title = pushTitleInput.value.trim() || "Big Red Connect";
  const message = pushBodyInput.value.trim();
  if(!message){
    showToast("Add a message first.");
    return;
  }

  try{
    const res = await fetch(PUSH_WORKER, {
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "X-Admin-Secret":AUTH_SECRET
      },
      body: JSON.stringify({ title, message })
    });

    const txt = await res.text();
    if(!res.ok){
      showToast("âš ï¸ Push failed");
      logDebug("Push error: " + txt);
      return;
    }

    showToast("ğŸ“£ Push sent!");
    logDebug("Push sent OK: " + title);
  }catch(err){
    showToast("âš ï¸ Push failed");
    logDebug("Push error: " + err.message);
  }
};

/* === SHARE BUILDER: IMAGES === */
const dayImgs = [
  "3F34BE7E-5953-433C-B8D0-17AC9108107F.png",
  "B02AB3EA-1AF5-4BE4-8CBB-E5A1AA40711F.png",
  "Big Red Live 2.png"
];
const nightImgs = [
  "3673A967-4A2D-4F9C-8602-0C820D31D168.png",
  "982ABF7A-D9F5-403D-BAE8-13777EC286FB.png",
  "0081086F-89FA-41B2-85EB-E4EE97E9E8EF.png"
];
const holidayImgs = [
  "BA7E86CF-5782-4323-B0B2-19918EF67887.png",
  "3673A967-4A2D-4F9C-8602-0C820D31D168.png",
  "982ABF7A-D9F5-403D-BAE8-13777EC286FB.png",
  "Big Red Live Holiday 1.png",
  "Big Red Live Christmas.png",
  "0081086F-89FA-41B2-85EB-E4EE97E9E8EF.png",
  "3F34BE7E-5953-433C-B8D0-17AC9108107F.png",
  "Big Red Live Thanksgiving.png"
];
const offlineImgs = [
  "3673A967-4A2D-4F9C-8602-0C820D31D168.png",
  "982ABF7A-D9F5-403D-BAE8-13777EC286FB.png",
  "0081086F-89FA-41B2-85EB-E4EE97E9E8EF.png"
];

let activeImages = [];
let imageIndex   = 0;

function pickImageSet(status){
  const now   = new Date();
  const hour  = now.getHours();
  const month = now.getMonth();
  const isDay     = hour >= 7 && hour < 18;
  const isHoliday = (month === 10 || month === 11); // Nov / Dec

  if(status === "offline"){
    activeImages = isHoliday ? holidayImgs.slice() : offlineImgs.slice();
  } else if(isHoliday){
    activeImages = holidayImgs.slice();
  } else if(isDay){
    activeImages = dayImgs.slice();
  } else {
    activeImages = nightImgs.slice();
  }

  if(activeImages.length === 0){
    activeImages = dayImgs.slice();
  }
  imageIndex = 0;
  applyImage();
}

function applyImage(){
  if(activeImages.length === 0) return;
  const filename = activeImages[imageIndex];
  const url = "https://raw.githubusercontent.com/bigred202403/Big-Red-Connect/main/" +
              encodeURIComponent(filename);
  imageEl.src = url;
}

document.getElementById("prevImage").onclick = () => {
  if(activeImages.length === 0) return;
  imageIndex = (imageIndex - 1 + activeImages.length) % activeImages.length;
  applyImage();
};
document.getElementById("nextImage").onclick = () => {
  if(activeImages.length === 0) return;
  imageIndex = (imageIndex + 1) % activeImages.length;
  applyImage();
};

/* === SHARE BUILDER: CAPTION VARIANTS === */
let variants     = [];
let captionIndex = 0;

function buildCTA(){
  return (
    "\n\nNo surprises. Just solid local moves." +
    "\nText â€˜REDâ€™ to 405-378-4024 â€” your affordable flat-rate ride connection." +
    "\nVeteran Owned â€¢ Affordable â€¢ Local â€¢ Trusted." +
    "\nhttps://bigred202403.github.io/Big-Red-Connect/"
  );
}

function generateVariants(status){
  const weekday = new Date().toLocaleString("en-US",{weekday:"long"});
  const CTA = buildCTA();

  if(status === "online"){
    variants = [
      `ğŸš— ${weekday} Moves â€” Big Red Connect is LIVE! Letâ€™s roll.\n${CTA}`,
      `ğŸŒ™ ${weekday} Nights â€” Out and about? Big Redâ€™s on the move.\n${CTA}`,
      `ğŸ„ Holiday Run â€” Big Red is LIVE and rolling local tonight!\n${CTA}`,
      `ğŸš¦ Rolling steady â€” your trusted flat-rate connection is LIVE.\n${CTA}`,
      `ğŸ“ In the metro now â€” message me to plan your pickup.\n${CTA}`
    ];
  } else if(status === "away"){
    variants = [
      `ğŸ•‘ ${weekday} Update â€” Iâ€™m stepping away but still nearby. Text me if you need a connection.\n${CTA}`,
      `ğŸŸ¡ Limited Availability â€” I can take select rides, just message me first.\n${CTA}`,
      `ğŸ“© Need a ride? Iâ€™m close â€” text RED and Iâ€™ll confirm ASAP.\n${CTA}`
    ];
  } else {
    variants = [
      `ğŸ”´ Offline â€” Thank you for riding local! Back soon.\n${CTA}`,
      `ğŸ˜´ Signing off for now â€” see you later tonight or tomorrow.\n${CTA}`
    ];
  }
}

function applyVariant(index){
  if(!variants.length) return;
  captionIndex = ((index % variants.length) + variants.length) % variants.length;
  if(!enableCustom.checked){
    shareCaption.value = variants[captionIndex];
    updateCharCount();
  }
}

function initShareBuilder(status){
  pickImageSet(status);
  generateVariants(status);
  applyVariant(0);
}

document.getElementById("prevTemplate").onclick = () => {
  if(enableCustom.checked){
    showToast("Custom caption enabled â€” templates wonâ€™t overwrite.");
    return;
  }
  if(!variants.length) return;
  applyVariant(captionIndex - 1);
};
document.getElementById("nextTemplate").onclick = () => {
  if(enableCustom.checked){
    showToast("Custom caption enabled â€” templates wonâ€™t overwrite.");
    return;
  }
  if(!variants.length) return;
  applyVariant(captionIndex + 1);
};

/* === SHARE: CUSTOM + PRESETS === */
function updateCharCount(){
  charCountEl.textContent = shareCaption.value.length.toString();
}
shareCaption.addEventListener("input", updateCharCount);

enableCustom.addEventListener("change", () => {
  if(enableCustom.checked){
    showToast("Custom caption mode enabled.");
  }else{
    // Reset to template based on current status
    initShareBuilder(select.value || "offline");
    showToast("Templates re-enabled.");
  }
});

/* Presets in localStorage */
const PRESET_KEY = "brc_caption_presets";

function loadPresets(){
  let list = [];
  try{
    const raw = localStorage.getItem(PRESET_KEY);
    if(raw) list = JSON.parse(raw) || [];
  }catch{}
  presetSelect.innerHTML = "";
  const baseOpt = document.createElement("option");
  baseOpt.value = "";
  baseOpt.textContent = "Insert saved caption...";
  presetSelect.appendChild(baseOpt);

  list.forEach((txt, idx) => {
    const opt = document.createElement("option");
    const preview = txt.replace(/\s+/g," ").trim().slice(0,60);
    opt.value = idx.toString();
    opt.textContent = preview || "(blank)";
    presetSelect.appendChild(opt);
  });
}

function savePresets(list){
  try{
    localStorage.setItem(PRESET_KEY, JSON.stringify(list));
  }catch{}
}

savePresetBtn.addEventListener("click", () => {
  const txt = shareCaption.value.trim();
  if(!txt){
    showToast("Nothing to save.");
    return;
  }
  let list = [];
  try{
    const raw = localStorage.getItem(PRESET_KEY);
    if(raw) list = JSON.parse(raw) || [];
  }catch{}
  list.push(txt);
  savePresets(list);
  loadPresets();
  showToast("Caption preset saved.");
});

presetSelect.addEventListener("change", () => {
  const idx = parseInt(presetSelect.value, 10);
  if(isNaN(idx)) return;
  let list = [];
  try{
    const raw = localStorage.getItem(PRESET_KEY);
    if(raw) list = JSON.parse(raw) || [];
  }catch{}
  if(idx >= 0 && idx < list.length){
    shareCaption.value = list[idx];
    updateCharCount();
  }
});

/* === SHARE: COPY & POST === */
document.getElementById("copyBtn").onclick = () => {
  navigator.clipboard.writeText(shareCaption.value || "");
  showToast("Copied!");
};

document.getElementById("postToLive").onclick = async () => {
  const status  = select.value || "offline";
  const caption = shareCaption.value || "";
  const image   = imageEl.src || "";

  try{
    const res = await fetch(POST_WORKER,{
      method:"PUT",
      headers:{
        "Content-Type":"application/json",
        "X-Admin-Secret":AUTH_SECRET
      },
      body:JSON.stringify({ status, caption, image })
    });

    if(!res.ok) throw new Error(await res.text());

    showToast("ğŸ“¢ Posted to Live Map!");
    logDebug("Posted to Live Map successfully.");
  }catch(err){
    showToast("âš  Error posting to Live Map");
    logDebug("Error posting: " + err.message);
  }
};

/* === INIT === */
loadPresets();
applyPushTemplate("LIVE");
updateCharCount();
fetchStatus();
</script>

</body>
</html>