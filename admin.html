<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Big Red</title>

  <!-- ğŸ“± Admin PWA Setup -->
  <link rel="apple-touch-icon" href="icon.PNG">
  <link rel="icon" type="image/png" sizes="192x192" href="icon.png">
  <link rel="shortcut icon" href="icon.PNG">
  <link rel="manifest" href="manifest-admin.json">
  <meta name="apple-mobile-web-app-title" content="Admin Big Red">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="theme-color" content="#000000">

  <style>
    body {
      text-align: center;
      font-family: Arial, sans-serif;
      background: #000;
      color: #fff;
      margin: 0;
    }
    header {
      background: #111;
      color: #fff;
      padding: 10px 0;
      border-bottom: 2px solid #b30000;
    }
    h1 {
      color: #b30000;
      margin: 20px 0 5px;
    }
    p.tagline {
      color: #ccc;
      margin-bottom: 20px;
    }
    .status {
      display: inline-block;
      padding: 10px 16px;
      border-radius: 20px;
      background: #222;
      margin: 10px 0;
    }
    .status.online { background: #064; }
    .status.away { background: #665500; }
    .status.offline { background: #400; }
    .panel {
      background: #111;
      border: 1px solid #333;
      border-radius: 10px;
      padding: 20px;
      max-width: 400px;
      margin: 20px auto;
      text-align: center;
    }
    select, button {
      font-size: 1em;
      padding: 10px;
      border-radius: 6px;
      margin: 6px;
      border: none;
    }
    .btn-primary { background: #b30000; color: #fff; }
    .btn-secondary { background: #000; border: 1px solid #b30000; color: #fff; }
    footer {
      margin: 20px 0;
      font-size: 0.9em;
      color: #aaa;
    }
    #refreshBtn {
      margin-top: 10px;
      background: #444;
      border: none;
      color: #fff;
      padding: 6px 12px;
      border-radius: 5px;
      cursor: pointer;
    }
    #refreshBtn:hover { background: #666; }
  </style>
</head>

<body>
  <header>
    <h1>Big Red Connect â€” Admin Panel</h1>
    <p class="tagline">Veteran Owned â€¢ Affordable â€¢ Local â€¢ Trusted</p>
  </header>

  <div id="status-pill" class="status">Checking statusâ€¦</div>

  <div class="panel">
    <h2>Update Driving Status</h2>
    <select id="statusSelect">
      <option value="online">ğŸŸ¢ On the Road</option>
      <option value="away">ğŸŸ¡ Limited Availability</option>
      <option value="offline">ğŸ”´ Offline</option>
    </select>
    <br />
    <button id="updateStatusBtn" class="btn-primary">ğŸ’¾ Save Status</button>
    <br />
    <button id="refreshBtn">ğŸ”„ Refresh Page</button>
    <p style="color:#aaa;font-size:0.9em;">
      Updates your live status and GPS location across all devices.
    </p>
  </div>

  <footer>
    <p>Â© 2025 Big Red Connect â€” Admin Console</p>
  </footer>

  <script>
    const STATUS_WORKER = "https://bigred-status-updater.bigredtransportation.workers.dev";
    const LOCATION_WORKER = "https://update-location.bigredtransportation.workers.dev/";
    const AUTH_SECRET = "BigRedPrivateKey2025";

    const pill = document.getElementById("status-pill");
    const select = document.getElementById("statusSelect");
    const saveBtn = document.getElementById("updateStatusBtn");
    const refreshBtn = document.getElementById("refreshBtn");

    let gpsInterval = null;
    let wakeLock = null;

    // ---- Fetch current status ----
    async function fetchStatus() {
      try {
        const res = await fetch(STATUS_WORKER + "/status?nocache=" + Date.now(), { cache: "no-store" });
        const j = await res.json();
        select.value = j.status;
        updatePill(j.status, j.updated);
      } catch (err) {
        console.warn("âš ï¸ Could not load status:", err);
        updatePill("offline");
      }
    }

    // ---- Save new status ----
    async function updateStatus() {
      const newStatus = select.value;
      const payload = { status: newStatus, updated: new Date().toISOString() };

      try {
        const res = await fetch(STATUS_WORKER + "/", {
          method: "PUT",
          mode: "cors",
          headers: {
            "Accept": "application/json",
            "Content-Type": "application/json",
            "X-Auth-Token": AUTH_SECRET
          },
          body: JSON.stringify(payload)
        });

        if (!res.ok) throw new Error(await res.text());
        updatePill(newStatus, payload.updated);
        alert("âœ… Status updated successfully!");

        if (newStatus === "online") {
          startGPSUpdates();
          requestWakeLock();
        } else {
          stopGPSUpdates();
          releaseWakeLock();
        }

      } catch (err) {
        console.error("âŒ Update failed:", err);
        alert("âš ï¸ Network error: unable to update status. Try again shortly.");
      }
    }

    // ---- GPS Auto-Update ----
    async function sendGPS(lat, lng) {
      const coords = { latitude: lat, longitude: lng, timestamp: new Date().toISOString() };
      try {
        await fetch(LOCATION_WORKER, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(coords)
        });
        console.log("ğŸ“¡ GPS updated:", lat, lng);
      } catch (err) {
        console.warn("âš ï¸ GPS update failed:", err);
      }
    }

    function startGPSUpdates() {
      if (gpsInterval) clearInterval(gpsInterval);
      if (!navigator.geolocation) {
        alert("GPS not supported on this device.");
        return;
      }
      const pushLocation = () => {
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            const { latitude, longitude } = pos.coords;
            sendGPS(latitude, longitude);
          },
          (err) => console.warn("GPS error:", err),
          { enableHighAccuracy: true, maximumAge: 15000, timeout: 10000 }
        );
      };
      pushLocation();
      gpsInterval = setInterval(pushLocation, 30000);
      console.log("âœ… GPS tracking started");
    }

    function stopGPSUpdates() {
      if (gpsInterval) {
        clearInterval(gpsInterval);
        gpsInterval = null;
        console.log("ğŸ›‘ GPS tracking stopped");
      }
    }

    // ---- Prevent screen sleep ----
    async function requestWakeLock() {
      try {
        if ('wakeLock' in navigator) {
          wakeLock = await navigator.wakeLock.request('screen');
          wakeLock.addEventListener('release', () => console.log('ğŸ”“ WakeLock released'));
          console.log('ğŸ”’ WakeLock active');
        }
      } catch (err) {
        console.warn('WakeLock failed:', err);
      }
    }
    async function releaseWakeLock() {
      if (wakeLock) { await wakeLock.release(); wakeLock = null; }
    }

    // ---- Update pill ----
    function updatePill(state, iso = null) {
      const now = iso ? new Date(iso) : new Date();
      const stamp = now.toLocaleString("en-US", {
        month: "short", day: "numeric", hour: "numeric", minute: "2-digit",
        timeZone: "America/Chicago", timeZoneName: "short"
      });

      pill.classList.remove("online","away","offline");
      if (state === "online") {
        pill.classList.add("online");
        pill.textContent = `ğŸŸ¢ Online â€” as of ${stamp}`;
      } else if (state === "away") {
        pill.classList.add("away");
        pill.textContent = `ğŸŸ¡ Limited Availability â€” as of ${stamp}`;
      } else {
        pill.classList.add("offline");
        pill.textContent = `ğŸ”´ Offline â€” as of ${stamp}`;
      }
    }

    // ---- Init ----
    saveBtn.onclick = updateStatus;
    refreshBtn.onclick = () => location.reload(true);
    fetchStatus();

    // ---- Register PWA Service Worker ----
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker
          .register("sw.js")
          .then(() => console.log("âœ… Service worker registered"))
          .catch(err => console.warn("âš ï¸ Service worker failed:", err));
      });
    }
  </script>
</body>
</html>