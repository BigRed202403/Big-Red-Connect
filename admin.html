<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Admin Big Red (Beta)</title>

<!-- ğŸ“± Big Red Connect Admin PWA Setup -->
<link rel="apple-touch-icon" href="icon.png">
<link rel="icon" type="image/png" sizes="192x192" href="icon.png">
<link rel="shortcut icon" href="icon.png">
<meta name="apple-mobile-web-app-title" content="Admin Big Red Beta">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#000000">

<style>
:root { --red:#b30000; --bg:#000; --panel:#111; --muted:#aaa; }
body{background:var(--bg);color:#fff;font-family:Arial,Helvetica,sans-serif;margin:0;text-align:center;}
header{background:var(--panel);display:flex;justify-content:space-between;align-items:center;
padding:10px 16px;border-bottom:2px solid var(--red);}
.bar-left{color:#bbb;font-size:.92em;display:flex;gap:10px;align-items:center;}
.pill{padding:4px 10px;border-radius:999px;font-weight:700;font-size:.85em;}
.pill.online{background:#064;} .pill.away{background:#665500;} .pill.offline{background:#400;}
.refresh-btn{background:var(--red);color:#fff;border:none;padding:8px 14px;border-radius:6px;cursor:pointer;font-weight:700;}
.refresh-btn:hover{background:#cc0000;}
h1{margin:18px 0 6px;color:var(--red);font-size:1.6rem;}
.tagline{color:#ddd;margin:0 0 8px;font-size:.95rem;}
.status{margin:10px auto;padding:10px;border-radius:6px;display:inline-block;min-width:280px;}
.status.online{background:#064;} .status.away{background:#665500;} .status.offline{background:#400;}
.grid{display:grid;grid-template-columns:1fr;gap:18px;max-width:880px;margin:0 auto;padding:10px 16px 24px;}
section{background:var(--panel);border:1px solid #222;border-radius:8px;padding:14px;}
section h2{margin:6px 0 8px;font-size:1.1rem;}
select,button{padding:10px;border-radius:6px;border:none;margin:6px;font-weight:700;}
.btn-primary{background:var(--red);color:#fff;} .btn-secondary{background:#000;color:#fff;border:1px solid var(--red);}
.row{display:flex;justify-content:center;align-items:center;flex-wrap:wrap;gap:6px;}
.meta{color:var(--muted);font-size:.85em;margin-top:6px;}
.img-box{max-width:95%;margin:10px auto;border:3px solid var(--red);border-radius:6px;padding:8px;}
.img-box img{width:100%;border-radius:6px;}
textarea{width:95%;max-width:780px;height:120px;background:#111;color:#fff;border:2px solid var(--red);
border-radius:6px;padding:8px;}
footer{margin:18px 0 24px;font-size:.9em;color:#777;}
#toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);
background:var(--red);color:#fff;padding:8px 16px;border-radius:6px;opacity:0;transition:opacity .35s;z-index:5;}
#debugLog{font-family:monospace;font-size:0.75rem;color:#0f0;background:#000;
padding:6px;max-height:200px;overflow:auto;text-align:left;border-top:1px solid #222;}
</style>
</head>
<body>

<header>
  <div class="bar-left">
    <span>ğŸ”’ Internal Use Only</span>
    <span id="livePill" class="pill offline">ğŸ“¡ Tracking: OFF</span>
  </div>
  <button class="refresh-btn" id="refreshPage">ğŸ”„ Refresh Page</button>
</header>

<h1>Big Red Connect â€” Admin Console (Beta)</h1>
<p class="tagline">Veteran Owned â€¢ Affordable â€¢ Local â€¢ Trusted</p>

<div id="status-pill" class="status">Checking statusâ€¦</div>

<div class="grid">
  <!-- ===== CONTROL ===== -->
  <section id="control">
    <h2>Update Driving Status</h2>
    <div class="row">
      <select id="statusSelect">
        <option value="online">ğŸŸ¢ On the Road</option>
        <option value="away">ğŸŸ¡ Limited Availability</option>
        <option value="offline">ğŸ”´ Offline</option>
      </select>
      <button class="btn-primary" id="updateStatusBtn">ğŸ’¾ Save Status</button>
    </div>

    <div id="gpsPermission" style="display:none; margin-top:10px;">
      <button class="btn-secondary" id="requestGPSBtn">ğŸ“ Grant Location Permission</button>
      <p class="meta">Tap this once to allow live GPS tracking on this device.</p>
    </div>

    <div class="meta">
      <div>Last status update: <span id="statusStamp">â€”</span></div>
      <div>Last GPS ping: <span id="gpsStamp">â€”</span> â€¢ Interval: <span id="gpsRate">â€”</span></div>
    </div>
  </section>

  <!-- ===== QUICK SHARE ===== -->
  <section id="share">
    <h2>Quick Share Builder</h2>
    <div class="img-box"><img id="statusImage" src="" alt="Preview"></div>
    <textarea id="captionBox" readonly>Loading caption...</textarea>
    <div class="row">
      <button class="btn-secondary" id="copyBtn">ğŸ“‹ Copy Caption</button>
      <button class="btn-primary" id="shareBtn">ğŸ“¤ Share on Facebook</button>
    </div>
    <div class="meta">Preview uses holiday/day/night logic automatically.</div>
  </section>
</div>

<footer>Â© 2025 Big Red Connect â€” Admin Panel Beta</footer>
<div id="toast"></div>
<div id="debugLog">[Debug log started]</div>

<script>
const STATUS_WORKER="https://bigred-status-updater.bigredtransportation.workers.dev";
const LOCATION_WORKER="https://update-location.bigredtransportation.workers.dev";
const AUTH_SECRET="BigRedPrivateKey2025";
const TZ="America/Chicago";

const pill=document.getElementById("status-pill");
const statusStamp=document.getElementById("statusStamp");
const gpsStamp=document.getElementById("gpsStamp");
const gpsRate=document.getElementById("gpsRate");
const select=document.getElementById("statusSelect");
const livePill=document.getElementById("livePill");
const toast=document.getElementById("toast");
const gpsPermission=document.getElementById("gpsPermission");
const requestGPSBtn=document.getElementById("requestGPSBtn");

function showToast(msg,ms=2000){toast.textContent=msg;toast.style.opacity=1;setTimeout(()=>toast.style.opacity=0,ms);}
function logDebug(msg){
 const el=document.getElementById("debugLog");
 const now=new Date().toLocaleTimeString("en-US",{hour12:false});
 el.innerHTML=`[${now}] ${msg}<br>`+el.innerHTML;
}

document.getElementById("refreshPage").onclick=()=>{showToast("Refreshingâ€¦");setTimeout(()=>location.reload(true),350);};

async function fetchStatus(){
 try{
  const res=await fetch(STATUS_WORKER+"/status?nocache="+Date.now(),{cache:"no-store"});
  const j=await res.json();
  renderStatusPill(j.status,j.updated);
  select.value=j.status;
  buildPreview(j.status);
  if(j.status==="online")startGPSLoop(5000);
  else if(j.status==="away")startGPSLoop(30000);
  else stopGPSLoop();
 }catch(e){renderStatusPill("offline");}
}

function fmtLocal(iso){if(!iso)return"â€”";return new Date(iso).toLocaleString("en-US",{timeZone:TZ});}
function renderStatusPill(state,iso){
 pill.classList.remove("online","away","offline");
 let stamp=fmtLocal(iso);
 if(state==="online"){pill.classList.add("online");pill.textContent=`ğŸŸ¢ Online â€” as of ${stamp}`;}
 else if(state==="away"){pill.classList.add("away");pill.textContent=`ğŸŸ¡ Limited â€” as of ${stamp}`;}
 else{pill.classList.add("offline");pill.textContent=`ğŸ”´ Offline â€” as of ${stamp}`;}
 statusStamp.textContent=stamp;
}

requestGPSBtn.addEventListener("click",()=>{
 if(!navigator.geolocation){alert("GPS not supported on this device.");return;}
 navigator.geolocation.getCurrentPosition(
  pos=>{
    showToast("âœ… Location permission granted!");
    gpsPermission.style.display="none";
    const{latitude,longitude}=pos.coords;
    sendGPS(latitude,longitude);
  },
  err=>{
    console.warn("âŒ Permission denied:",err);
    alert("Location permission was denied. Enable it in Settings â†’ Privacy â†’ Location Services.");
  },
  {enableHighAccuracy:true,timeout:10000}
 );
});
function maybeShowGPSPrompt(status){
 if(status==="online"){gpsPermission.style.display="block";}
 else{gpsPermission.style.display="none";}
}

document.getElementById("updateStatusBtn").onclick=async()=>{
 const newStatus=select.value;
 const payload={status:newStatus,updated:new Date().toISOString()};
 try{
  const res=await fetch(STATUS_WORKER+"/",{method:"PUT",headers:{"Content-Type":"application/json","X-Auth-Token":AUTH_SECRET},body:JSON.stringify(payload)});
  if(!res.ok)throw new Error(await res.text());
  renderStatusPill(newStatus,payload.updated);
  showToast("âœ… Status updated");
  buildPreview(newStatus);
  maybeShowGPSPrompt(newStatus);
  if(newStatus==="online")startGPSLoop(5000);
  else if(newStatus==="away")startGPSLoop(30000);
  else stopGPSLoop();
 }catch(e){showToast("âš ï¸ Update failed");}
};

function buildPreview(status){
 const img=document.getElementById("statusImage");
 const caption=document.getElementById("captionBox");
 const now=new Date();const hour=now.getHours();const m=now.getMonth();
 const isHoliday=(m===10||m===11);const isDay=hour>=7&&hour<18;
 let imgName="Big Red Live 2.png";
 if(isHoliday)imgName="Big Red Live Holiday 1.png";else if(!isDay)imgName="Big Red Live Christmas.png";
 img.src=`https://raw.githubusercontent.com/bigred202403/Big-Red-Connect/main/${encodeURIComponent(imgName)}`;
 let base="";
 if(status==="online"){
  base=isHoliday?"ğŸ„ Big Red Connect is LIVE â€” plan ahead this holiday season!"
  :(isDay?"ğŸš— Big Red Connect is LIVE â€” your affordable flat-rate ride connection."
  :"ğŸŒ™ Big Red Connect is LIVE â€” from last call to your front door, ride local and ride safe.");
 }else if(status==="away"){base="ğŸ•‘ Big Red Connect is temporarily away â€” back soon!";}
 else{base="ğŸ”´ Big Red Connect is currently offline. Thanks for riding local!";}
 const CTA="\n\nNo surprises. Just solid local moves.\nText â€˜REDâ€™ to 405-378-4024 â€” your affordable flat-rate ride connection.\nVeteran Owned â€¢ Affordable â€¢ Local â€¢ Trusted.";
 caption.value=base+CTA;
}

document.getElementById("copyBtn").onclick=()=>{navigator.clipboard.writeText(document.getElementById("captionBox").value);showToast("ğŸ“‹ Caption copied");};
document.getElementById("shareBtn").onclick=()=>{const c=encodeURIComponent(document.getElementById("captionBox").value);
window.open(`https://www.facebook.com/sharer/sharer.php?u=https://bigred202403.github.io/Big-Red-Connect/&quote=${c}`,"_blank");};

/* === GPS LOOP (recursive) + WAKE LOCK === */
let gpsTimerActive=false;let wakeLock=null;let currentIntervalMs=0;
function setLivePill(active,rateMs){
 livePill.classList.remove("online","away","offline");
 if(active){livePill.classList.add("online");livePill.textContent="ğŸ“¡ Tracking: ON";}
 else{livePill.classList.add("offline");livePill.textContent="ğŸ“¡ Tracking: OFF";}
 gpsRate.textContent=active?`${Math.round(rateMs/1000)}s`:"â€”";
}

async function sendGPS(lat,lng){
 const payload={latitude:lat,longitude:lng,timestamp:new Date().toISOString()};
 try{
  logDebug(`Sending GPS â†’ ${lat.toFixed(5)}, ${lng.toFixed(5)}`);
  const res=await fetch(LOCATION_WORKER,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});
  if(res.ok){
    gpsStamp.textContent=fmtLocal(payload.timestamp);
    logDebug("âœ… GPS sent OK");
  }else{
    logDebug("âš ï¸ GPS push failed "+res.status);
  }
 }catch(e){
  logDebug("âŒ GPS send error: "+e.message);
 }
}

function startGPSLoop(intervalMs){
 stopGPSLoop();
 currentIntervalMs=intervalMs;
 gpsTimerActive=true;
 setLivePill(true,currentIntervalMs);
 requestWakeLock();
 logDebug("GPS loop started ("+intervalMs+"ms)");
 const loop=()=>{
   if(!gpsTimerActive)return;
   if(!navigator.geolocation){showToast("âš ï¸ Enable Location Services");return;}
   logDebug("â° GPS tick");
   navigator.geolocation.getCurrentPosition(
     (pos)=>{const{latitude,longitude}=pos.coords;sendGPS(latitude,longitude);},
     (err)=>logDebug("GPS error "+err.message),
     {enableHighAccuracy:true,maximumAge:8000,timeout:8000}
   );
   setTimeout(loop,currentIntervalMs);
 };
 loop();
}

function stopGPSLoop(){
 gpsTimerActive=false;
 currentIntervalMs=0;
 setLivePill(false,0);
 releaseWakeLock();
 logDebug("GPS loop stopped");
}

async function requestWakeLock(){try{if('wakeLock'in navigator){wakeLock=await navigator.wakeLock.request('screen');logDebug("Wake lock granted");}}catch(e){logDebug("Wake lock denied "+e.message);}}
async function releaseWakeLock(){if(wakeLock){try{await wakeLock.release();logDebug("Wake lock released");}catch{}wakeLock=null;}}

window.addEventListener("pagehide",()=>{stopGPSLoop();});
fetchStatus();

/* === PWA Service Worker === */
if("serviceWorker"in navigator){
 window.addEventListener("load",()=>{
  navigator.serviceWorker.register("sw.js")
  .then(()=>console.log("âœ… Service Worker registered for Admin PWA"))
  .catch(err=>console.warn("âš ï¸ SW registration failed:",err));
 });
}
</script>
</body>
</html>