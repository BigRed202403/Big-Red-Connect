<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Big Red Connect â€” Live Control (GPS Enabled)</title>

  <!-- No Cache -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="hero"></div>
  <img src="official_logo.jpeg" alt="Big Red Connect Logo" class="main-logo" />
  <p class="tagline">Veteran Owned â€¢ Affordable Flat Rates â€¢ Trusted Local Connections</p>

  <div id="status-pill" class="status status--loading">Checking statusâ€¦</div>

  <section class="info-section" style="text-align:center;max-width:400px;margin:auto;">
    <h2>Update Driving Status</h2>
    <select id="statusSelect" class="btn secondary" style="width:100%;max-width:320px;padding:10px;">
      <option value="online">ğŸŸ¢ On the Road</option>
      <option value="away">ğŸŸ¡ Limited Availability</option>
      <option value="offline">ğŸ”´ Offline</option>
    </select>
    <button id="updateStatusBtn" class="btn primary" style="margin-top:12px;">ğŸ’¾ Save Status</button>
    <p id="gps-status" style="font-size:0.9em;color:#aaa;margin-top:8px;">
      GPS idle â€” waiting for status updateâ€¦
    </p>
  </section>

  <div class="cta-group">
    <a href="index.html" class="btn secondary">ğŸ  Return Home</a>
    <a href="sms:+14053784024" class="btn primary">ğŸ“² Text â€œREDâ€</a>
  </div>

  <footer>
    <p>&copy; 2025 Big Red Connect â€” Live GPS Control</p>
  </footer>

  <script>
    const STATUS_WORKER = "https://bigred-status-updater.bigredtransportation.workers.dev";
    const LOCATION_WORKER = "https://update-location.bigredtransportation.workers.dev";
    const AUTH_SECRET = "BigRedPrivateKey2025";

    const select = document.getElementById("statusSelect");
    const saveBtn = document.getElementById("updateStatusBtn");
    const pill = document.getElementById("status-pill");
    const gpsStatus = document.getElementById("gps-status");

    let gpsInterval = null;

    // ---- Fetch current status ----
    async function fetchStatus() {
      try {
        const res = await fetch(STATUS_WORKER + "/status?nocache=" + Date.now(), { cache: "no-store" });
        const j = await res.json();
        select.value = j.status;
        updatePill(j.status, j.updated);
      } catch (err) {
        console.warn("âš ï¸ Could not load status:", err);
        updatePill("offline");
      }
    }

    // ---- Save new status ----
    async function updateStatus() {
      const newStatus = select.value;
      const payload = {
        status: newStatus,
        updated: new Date().toISOString()
      };

      try {
        const res = await fetch(STATUS_WORKER + "/", {
          method: "PUT",
          mode: "cors",
          headers: {
            "Accept": "application/json",
            "Content-Type": "application/json",
            "X-Auth-Token": AUTH_SECRET
          },
          body: JSON.stringify(payload)
        });

        if (!res.ok) throw new Error(await res.text());
        const data = await res.json();
        updatePill(data.newStatus?.status || newStatus, payload.updated);

        if (newStatus === "online") {
          startLiveGPS();
        } else {
          stopLiveGPS();
        }

        alert("âœ… Status updated successfully!");
      } catch (err) {
        console.error("âŒ Update failed:", err);
        alert("âš ï¸ Network error: unable to update status. Try again shortly.");
      }
    }

    // ---- GPS Loop ----
    function startLiveGPS() {
      gpsStatus.textContent = "ğŸ“¡ GPS tracking active â€” updating every 30 seconds.";
      gpsStatus.style.color = "#0f0";
      if (gpsInterval) clearInterval(gpsInterval);

      // Immediately send once
      sendLocationToWorker();

      // Repeat every 30 seconds
      gpsInterval = setInterval(sendLocationToWorker, 30000);
    }

    function stopLiveGPS() {
      gpsStatus.textContent = "â›” GPS tracking paused â€” driver is away/offline.";
      gpsStatus.style.color = "#ffa500";
      if (gpsInterval) clearInterval(gpsInterval);
    }

    async function sendLocationToWorker() {
      if (!navigator.geolocation) {
        gpsStatus.textContent = "âš ï¸ GPS not supported on this device.";
        gpsStatus.style.color = "#f00";
        return;
      }

      navigator.geolocation.getCurrentPosition(async (pos) => {
        const coords = {
          latitude: pos.coords.latitude,
          longitude: pos.coords.longitude,
          accuracy_m: pos.coords.accuracy,
          timestamp: new Date().toISOString()
        };

        try {
          await fetch(LOCATION_WORKER, {
            method: "PUT",
            mode: "cors",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(coords)
          });
          gpsStatus.textContent = `âœ… Sent ${coords.latitude.toFixed(4)}, ${coords.longitude.toFixed(4)} @ ${new Date().toLocaleTimeString()}`;
          gpsStatus.style.color = "#0f0";
        } catch (err) {
          gpsStatus.textContent = "âš ï¸ Failed to send location â€” retrying...";
          gpsStatus.style.color = "#f00";
        }
      }, (err) => {
        gpsStatus.textContent = "âš ï¸ GPS error: " + err.message;
        gpsStatus.style.color = "#f00";
      });
    }

    // ---- Update pill display ----
    function updatePill(state, iso = null) {
      const now = iso ? new Date(iso) : new Date();
      const stamp = now.toLocaleString("en-US", {
        month: "short",
        day: "numeric",
        hour: "numeric",
        minute: "2-digit",
        timeZone: "America/Chicago",
        timeZoneName: "short"
      });

      pill.classList.remove("online","away","offline","status--loading");
      if (state === "online") {
        pill.classList.add("online");
        pill.textContent = `ğŸŸ¢ Online â€” as of ${stamp}`;
      } else if (state === "away") {
        pill.classList.add("away");
        pill.textContent = `ğŸŸ¡ Limited Availability â€” as of ${stamp}`;
      } else {
        pill.classList.add("offline");
        pill.textContent = `ğŸ”´ Offline â€” as of ${stamp}`;
      }
    }

    saveBtn.onclick = updateStatus;
    fetchStatus();
  </script>
</body>
</html>