<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Fare Calculator (Beta) â€“ Big Red Connect</title>

  <!-- ğŸ“± PWA / Icons -->
  <link rel="apple-touch-icon" href="icon.PNG">
  <link rel="icon" type="image/png" sizes="192x192" href="icon.png">
  <link rel="shortcut icon" href="icon.PNG">
  <link rel="manifest" href="manifest.json">
  <meta name="apple-mobile-web-app-title" content="Big Red Connect">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="theme-color" content="#000000">

  <!-- No cache -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <link rel="stylesheet" href="style.css" />

  <!-- Google Maps -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCMM0dxLNM7XQI5G3OBSnINeO5hcS3Ks5I&libraries=places,geometry&callback=initGoogle" async defer></script>

  <style>
    #map { height: 250px; margin-top: 15px; border-radius: 10px; }
    .home-top { display:flex; justify-content:center; gap:10px; margin-top:8px; }
    .muted { color:#aaa; font-size:0.9em; }
    .prefill-msg { background:#112; color:#9f9; padding:8px; border-radius:6px; font-size:0.9em; margin-bottom:10px; text-align:center; }
  </style>
</head>

<body>
  <div class="logo-header">
    <a href="index.html" title="Return to Home">
      <img src="official_logo_Nov.png" alt="Big Red Connect Logo" style="cursor:pointer;" />
    </a>
  </div>

  <div class="home-top">
    <a href="index.html" class="btn secondary">ğŸ  Home</a>
    <a href="beta-live.html" class="btn secondary">ğŸ“ Live Map</a>
  </div>

  <h1>Fare Calculator (Beta)</h1>
  <p class="tagline">Plan your next ride connection â€” quick, simple, and local.</p>

  <!-- Status Pill -->
  <div id="status-pill" class="status status--loading">Checking statusâ€¦</div>

  <section class="info-section calculator">

    <div id="prefillNotice" class="prefill-msg" style="display:none;">âœ… Pickup auto-filled from your recent ETA check.</div>

    <!-- Ride mode toggle -->
    <div class="ride-mode-toggle" aria-label="Choose ride mode">
      <button id="modeNow" class="btn btn-toggle active" type="button">ğŸš— Ride Now</button>
      <button id="modeReserve" class="btn btn-toggle" type="button">ğŸ•’ Reserve Ride</button>
    </div>

    <!-- Reserve controls (hidden by default) -->
    <div id="reserveControls" style="display:none;">
      <label for="reserveDate">Date</label>
      <input id="reserveDate" type="date" />
      <label for="reserveTime">Time</label>
      <input id="reserveTime" type="time" />
      <label for="planBy">Plan By</label>
      <select id="planBy">
        <option value="pickup">Pickup Time</option>
        <option value="dropoff">Drop-Off Time</option>
      </select>
      <div class="muted">Rush hour applies automatically (Weekdays 5â€“9 AM / 3â€“7 PM)</div>
    </div>

    <!-- Pickup -->
    <label for="pickup">Pickup Location</label>
    <input id="pickup" type="text" placeholder="Enter pickup address or place" />
    <button id="useLocPickup" class="btn primary" type="button" style="margin-top:8px;">ğŸ“ Use My Location for Pickup</button>

    <div id="stopsWrap"></div>
    <button id="addStopBtn" class="btn primary" type="button">â• Add Stop</button>

    <!-- Drop-off -->
    <label for="dropoff">Drop-off Location</label>
    <input id="dropoff" type="text" placeholder="Enter drop-off address or place" />
    <button id="useLocDrop" class="btn secondary" type="button" style="margin-top:8px;">ğŸ“ Use My Location for Drop-off</button>

    <div id="map"></div>

    <!-- Notes -->
    <div id="airport-note"></div>
    <div id="event-note"></div>
    <div id="rushhour-note"></div>
    <div id="fairness-note"></div>

    <!-- Hidden tripType -->
    <select id="tripType" style="display:none;">
      <option value="10">Standard</option>
      <option value="15">Rush Hour</option>
      <option value="15_airport">Airport</option>
      <option value="20">Special Event</option>
    </select>

    <label for="payment">Payment Method</label>
    <select id="payment">
      <option value="cash">Cash / Venmo / Cash App</option>
      <option value="card">Card (+3.3% booking + 2.4% fuel)</option>
    </select>

    <button class="btn primary" id="calcBtn" style="display:block;margin:20px auto;">ğŸ’² Calculate Fare</button>

    <div id="text-red-wrapper" style="margin-top:10px;text-align:center;">
      <a href="sms:+14053784024?&body=Hey%20Big%20Red%20â€”%20Iâ€™d%20like%20to%20plan%20a%20ride%20connection." class="btn secondary">ğŸ“² Text RED</a>
    </div>

    <div id="result" style="display:none;"></div>
    <p class="muted">*Estimates only. Final fare may vary slightly based on route or wait time.</p>
  </section>

  <footer>
    <p>&copy; 2025 Big Red Connect â€” <a href="index.html">Return Home</a></p>
  </footer>

  <!-- status.js -->
  <script src="status.js"></script>

  <script>
  // ======== Auto-fill pickup from ETA page ========
  window.addEventListener("DOMContentLoaded", () => {
    try {
      const saved = localStorage.getItem("bigred_last_rider");
      if (saved) {
        const { address, lat, lng, timestamp } = JSON.parse(saved);
        const ageMin = (Date.now() - timestamp) / 60000;
        if (ageMin <= 15) {
          const pickup = document.getElementById("pickup");
          const msg = document.getElementById("prefillNotice");
          pickup.value = address ? address : `${lat.toFixed(5)}, ${lng.toFixed(5)}`;
          msg.style.display = "block";
        }
      }
    } catch(e) {
      console.warn("No recent ETA data found:", e);
    }
  });

  // ========== Core Fare Calculator ==========
  const HQ = { lat: 35.3207, lng: -97.4929 };
  const STALE_MINUTES = 30;
  const WORKER_URL = "https://update-location.bigredtransportation.workers.dev";

  let map, geocoder, directionsService, directionsRenderer;
  let pickupLatLng=null, dropoffLatLng=null;

  window.initGoogle = async function() {
    geocoder = new google.maps.Geocoder();
    directionsService = new google.maps.DirectionsService();
    directionsRenderer = new google.maps.DirectionsRenderer({ suppressMarkers:true });
    map = new google.maps.Map(document.getElementById("map"), { center:{lat:35.4676,lng:-97.5164}, zoom:11 });
    directionsRenderer.setMap(map);

    const acPickup = new google.maps.places.Autocomplete(document.getElementById("pickup"));
    const acDrop = new google.maps.places.Autocomplete(document.getElementById("dropoff"));

    acPickup.addListener("place_changed", () => {
      const p = acPickup.getPlace();
      if (p.geometry) {
        pickupLatLng = p.geometry.location;
        map.setCenter(pickupLatLng);
        new google.maps.Marker({ position: pickupLatLng, map, label: "P" });
      }
    });

    acDrop.addListener("place_changed", () => {
      const p = acDrop.getPlace();
      if (p.geometry) {
        dropoffLatLng = p.geometry.location;
        map.panTo(dropoffLatLng);
        new google.maps.Marker({ position: dropoffLatLng, map, label: "D" });
      }
    });

    document.getElementById("calcBtn").onclick = calculateFare;
  };

  async function calculateFare() {
    const pickup = document.getElementById("pickup").value.trim();
    const dropoff = document.getElementById("dropoff").value.trim();
    if (!pickup || !dropoff) return alert("Enter both pickup and drop-off.");

    const route = await new Promise((res, rej) =>
      directionsService.route({ origin: pickup, destination: dropoff, travelMode: "DRIVING" }, (r, s) => s==="OK"?res(r):rej(s))
    );

    directionsRenderer.setDirections(route);
    const legs = route.routes[0].legs;
    const miles = legs.reduce((m,l)=>m+(l.distance.value||0),0)/1609.34;
    const duration = legs.reduce((t,l)=>t+(l.duration.value||0),0)/60;

    const base = 10;
    const tier2 = Math.max(0,Math.min(10,miles-10))*1.25;
    const tier3 = Math.max(0,miles-20)*1.00;
    let fare = base + tier2 + tier3;

    const pay = document.getElementById("payment").value;
    if (pay==="card") fare += fare*0.033 + fare*0.024;

    const total = fare.toFixed(2);
    const result = document.getElementById("result");
    result.innerHTML = `
      <div class="total">$${total}</div>
      <p>ğŸ“ ${miles.toFixed(1)} mi  â±ï¸ ${Math.round(duration)} min</p>
      <p><strong>Payment:</strong> ${pay==="card"?"Card (fees included)":"Cash / Venmo / Cash App"}</p>
      <p style="text-align:center;margin-top:15px;"><button class="btn primary" onclick="textRed()">ğŸ“² Text RED</button></p>
    `;
    result.style.display = "block";
  }

  function textRed() {
    const pickup = document.getElementById("pickup").value.trim();
    const dropoff = document.getElementById("dropoff").value.trim();
    const smsBody = encodeURIComponent(`Hey Big Red â€” I'd like a ride from ${pickup} to ${dropoff}.`);
    window.location.href = `sms:+14053784024?&body=${smsBody}`;
  }
  </script>
</body>
</html>