<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Fare Calculator â€“ Big Red Connect</title>

  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <link rel="stylesheet" href="style.css" />
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCMM0dxLNM7XQI5G3OBSnINeO5hcS3Ks5I&libraries=places,geometry&callback=initGoogle" async defer></script>
</head>
<body>

  <div class="logo-header">
    <a href="index.html"><img src="official_logo.jpeg" alt="Big Red Connect Logo" /></a>
  </div>

  <div class="top-home-btn" style="text-align:center;margin-top:10px;margin-bottom:10px;">
    <a href="index.html" class="btn secondary">ğŸ  Home</a>
  </div>

  <h1>Fare Calculator</h1>
  <p class="tagline">Plan your next ride connection â€” quick, simple, and local.</p>

  <div id="status-pill" class="status">Checking statusâ€¦</div>

  <section class="info-section calculator">
    <div class="ride-mode-toggle">
      <button id="modeNow" class="btn btn-toggle active">ğŸš— Ride Now</button>
      <button id="modeReserve" class="btn btn-toggle">ğŸ•’ Reserve Ride</button>
    </div>

    <div id="reserveControls" style="display:none;">
      <label>Date</label><input id="reserveDate" type="date" />
      <label>Time</label><input id="reserveTime" type="time" />
      <label>Plan By</label>
      <select id="planBy"><option value="pickup">Pickup</option><option value="dropoff">Drop-Off</option></select>
      <div style="color:#ccc;font-size:0.9em;margin:6px 0 10px;">
        Rush hour auto-applies (5â€“9 AM / 3â€“7 PM weekdays).
      </div>
    </div>

    <label>Pickup Location</label>
    <input id="pickup" placeholder="Enter pickup address or place" />
    <button id="useLocPickup" class="btn primary" type="button" style="margin-top:8px;">ğŸ“ Use My Location</button>

    <div id="stopsWrap"></div>
    <button id="addStopBtn" class="btn primary" type="button">â• Add Stop</button>

    <label>Drop-off Location</label>
    <input id="dropoff" placeholder="Enter drop-off address or place" />
    <button id="useLocDrop" class="btn secondary" type="button" style="margin-top:8px;">ğŸ“ Use My Location</button>

    <div id="map" style="height:250px;margin-top:15px;border-radius:10px;"></div>

    <div id="airport-note"></div>
    <div id="event-note"></div>
    <div id="rushhour-note"></div>
    <div id="fairness-note"></div>

    <select id="tripType" style="display:none;">
      <option value="10">Standard</option>
      <option value="15">Rush Hour</option>
      <option value="15_airport">Airport</option>
      <option value="20">Special Event</option>
    </select>

    <label>Payment Method</label>
    <select id="payment">
      <option value="cash">Cash / Venmo / Cash App (no fees)</option>
      <option value="card">Card (+3.3% booking + 2.4% fuel)</option>
    </select>

    <button class="btn primary" id="calcBtn" style="margin-top:15px;">ğŸ’² Calculate Fare</button>

    <div id="text-red-wrapper" style="text-align:center;margin-top:10px;">
      <a href="sms:+14053784024?&body=Hey%20Big%20Red%20â€”%20Iâ€™d%20like%20to%20plan%20a%20ride." class="btn secondary">ğŸ“² Text RED</a>
    </div>

    <div id="result" style="display:none;"></div>
    <p class="disclaimer">*Estimates only. Final fare may vary slightly.</p>
  </section>

  <footer><p>&copy; 2025 Big Red Connect â€” <a href="index.html">Return Home</a></p></footer>

  <script src="status.js"></script>
  <script>
  const HQ={lat:35.3207,lng:-97.4929};
  const WORKER_URL="https://update-location.bigredtransportation.workers.dev";
  const STALE_MINUTES=30;
  let map,geocoder,directionsService,directionsRenderer;
  let pickupLatLng=null,dropoffLatLng=null,pickupPlace=null,dropPlace=null,driverPos=null,mode="now",EVENT_VENUES=null;

  function isValidCoords(o){return o&&typeof o.lat==="number"&&typeof o.lng==="number";}
  function distMi(a,b){return google.maps.geometry.spherical.computeDistanceBetween(new google.maps.LatLng(a.lat,a.lng),new google.maps.LatLng(b.lat,b.lng))/1609.34;}
  function weekdayRushHour(d){const day=d.getDay(),h=d.getHours();return day>=1&&day<=5&&((h>=5&&h<9)||(h>=15&&h<19));}

  window.initGoogle=async function(){
    geocoder=new google.maps.Geocoder();
    directionsService=new google.maps.DirectionsService();
    directionsRenderer=new google.maps.DirectionsRenderer({suppressMarkers:true});
    map=new google.maps.Map(document.getElementById("map"),{center:{lat:35.4676,lng:-97.5164},zoom:11});
    directionsRenderer.setMap(map);

    const acP=new google.maps.places.Autocomplete(document.getElementById("pickup"));
    const acD=new google.maps.places.Autocomplete(document.getElementById("dropoff"));
    acP.addListener("place_changed",async()=>{const p=acP.getPlace();if(!p.geometry)return;
      pickupPlace=p;pickupLatLng=p.geometry.location;markPickup();await applyRideTypePriority();await maybeShowFairnessNotePreview();});
    acD.addListener("place_changed",async()=>{const p=acD.getPlace();if(!p.geometry)return;
      dropPlace=p;dropoffLatLng=p.geometry.location;markDrop();await applyRideTypePriority();});

    document.getElementById("useLocPickup").onclick=()=>useMyLocation("pickup");
    document.getElementById("useLocDrop").onclick=()=>useMyLocation("dropoff");
    document.getElementById("calcBtn").onclick=calculateFare;

    smartRideTypeDefault();await getDriverLocation();
  };

  function markPickup(){if(window.pickupMarker)window.pickupMarker.setMap(null);
    window.pickupMarker=new google.maps.Marker({position:pickupLatLng,map,label:"P"});map.setCenter(pickupLatLng);}
  function markDrop(){if(window.dropoffMarker)window.dropoffMarker.setMap(null);
    window.dropoffMarker=new google.maps.Marker({position:dropoffLatLng,map,label:"D"});map.panTo(dropoffLatLng);}

  async function useMyLocation(id){
    if(!navigator.geolocation){alert("Location not supported.");return;}
    navigator.geolocation.getCurrentPosition(async(pos)=>{
      const latlng={lat:pos.coords.latitude,lng:pos.coords.longitude};
      const addr=await new Promise(r=>geocoder.geocode({location:latlng},(res,s)=>r(s==="OK"&&res[0]?res[0].formatted_address:`${latlng.lat},${latlng.lng}`)));
      document.getElementById(id).value=addr;
      if(id==="pickup"){pickupLatLng=new google.maps.LatLng(latlng.lat,latlng.lng);markPickup();await maybeShowFairnessNotePreview();}
      else{dropoffLatLng=new google.maps.LatLng(latlng.lat,latlng.lng);markDrop();}
      await applyRideTypePriority();
    },err=>alert("GPS Error: "+err.message),{enableHighAccuracy:true,timeout:10000});
  }

  async function getDriverLocation(){
    try{const r=await fetch(WORKER_URL,{cache:"no-store"});const j=await r.json();
      const lat=parseFloat(j.latitude),lng=parseFloat(j.longitude);driverPos=!isNaN(lat)&&!isNaN(lng)?{lat,lng}:HQ;}catch{driverPos=HQ;}
  }

  function smartRideTypeDefault(){const n=new Date();if(weekdayRushHour(n)){setTripType("15");document.getElementById("rushhour-note").innerHTML="ğŸš¦ Rush Hour pricing";}
    else{setTripType("10");document.getElementById("rushhour-note").innerHTML="";}}
  function setTripType(v){document.getElementById("tripType").value=v;}
  function detectAirportAndFlag(){
    let c="";[pickupPlace,dropPlace].forEach(p=>{if(p)c+=(p.name||"")+(p.formatted_address||"");});
    const isAirport=c.toLowerCase().includes("airport")&&!c.toLowerCase().includes("tinker");
    document.getElementById("airport-note").innerHTML=isAirport?"âœˆï¸ Airport ride â€” $15 base.":"";return isAirport;
  }

  async function detectEventAndFlag(){
    if(!EVENT_VENUES){try{const r=await fetch("event-venues.json",{cache:"no-store"});EVENT_VENUES=await r.json();}catch{EVENT_VENUES={venues:[],keywords:[]};}}
    let inside=null;function inRad(pt,c,r){return distMi(c,pt)<=r;}
    const testLocs=[pickupLatLng,dropoffLatLng].filter(Boolean);
    for(const loc of testLocs){for(const v of EVENT_VENUES.venues){if(!v.active)continue;if(inRad({lat:loc.lat(),lng:loc.lng()},{lat:v.lat,lng:v.lng},v.radius_mi)){inside=v;break;}}}
    if(!inside){const combo=((pickupPlace?.name||"")+(pickupPlace?.formatted_address||"")+(dropPlace?.name||"")+(dropPlace?.formatted_address||"")).toLowerCase();
      const hit=(EVENT_VENUES.keywords||[]).some(k=>k.active && combo.includes(k.value.toLowerCase()));if(hit)inside={name:"Special Event Area"};}
    if(inside){document.getElementById("event-note").innerHTML=`ğŸŸï¸ Special event near ${inside.name}`;return true;}
    document.getElementById("event-note").innerHTML="";return false;
  }

  async function applyRideTypePriority(){
    const airport=detectAirportAndFlag();if(airport){setTripType("15_airport");return;}
    const event=await detectEventAndFlag();if(event){setTripType("20");return;}
    smartRideTypeDefault();
  }

  async function maybeShowFairnessNotePreview(){
    if(!pickupLatLng)return document.getElementById("fairness-note").innerHTML="";
    await getDriverLocation();const ref=isValidCoords(driverPos)?driverPos:HQ;
    const d=distMi(ref,{lat:pickupLatLng.lat(),lng:pickupLatLng.lng()});let msg="";
    if(d>35)msg="A travel fairness fee may apply.";else if(d>15)msg="A small travel fairness fee may apply.";
    document.getElementById("fairness-note").innerHTML=msg;
  }

  async function calculateFare(){
    const pickup=document.getElementById("pickup").value.trim(),dropoff=document.getElementById("dropoff").value.trim();
    if(!pickup||!dropoff){alert("Please enter both pickup and drop-off.");return;}
    const route=await new Promise((res,rej)=>directionsService.route({origin:pickup,destination:dropoff,travelMode:"DRIVING"},(r,s)=>s==="OK"?res(r):rej(s)));
    directionsRenderer.setDirections(route);
    const legs=route.routes[0].legs,miles=legs.reduce((m,l)=>m+(l.distance?.value||0),0)/1609.34;
    const duration=legs.reduce((t,l)=>t+(l.duration?.value||0),0)/60;
    await applyRideTypePriority();await getDriverLocation();
    const ref=isValidCoords(driverPos)?driverPos:HQ;
    const eta=pickupLatLng?`${Math.ceil((distMi(ref,{lat:pickupLatLng.lat(),lng:pickupLatLng.lng()})/30)*60)} min`:"â€”";
    const tripVal=document.getElementById("tripType").value;const base=(tripVal==="15_airport")?15:parseFloat(tripVal);
    const tier2=Math.max(0,Math.min(10,miles-10))*1.25,tier3=Math.max(0,miles-20)*1.00,milesSub=tier2+tier3;
    const fair=(()=>{const d=distMi(ref,{lat:pickupLatLng.lat(),lng:pickupLatLng.lng()});return d>35?20:d>15?10:0;})();
    const pay=document.getElementById("payment").value;
    let fare=base+milesSub+fair;if(pay==="card")fare+=fare*0.033+fare*0.024;
    const total=fare.toFixed(2);
    const result=document.getElementById("result");
    result.innerHTML=`<div class="total">$${total}</div>
      <p><strong>Base:</strong> $${base}</p>
      <p><strong>Mileage:</strong> $${milesSub.toFixed(2)}</p>
      ${fair>0?`<p><strong>Travel Fairness Fee:</strong> $${fair}</p>`:""}
      <p>ğŸ“ ${miles.toFixed(1)} mi â±ï¸ ${Math.round(duration)} min ğŸš— ETA ${eta}</p>
      <p style="text-align:center;margin-top:15px;"><button class="btn primary" id="textRedBtn">ğŸ“² Text RED</button></p>`;
    result.style.display="block";
    document.getElementById("textRedBtn").onclick=()=>{const sms=`Hey Big Red â€” Ride from ${pickup} to ${dropoff}. Est. $${total}.`;window.location.href=`sms:+14053784024?&body=${encodeURIComponent(sms)}`;}
  }
  </script>
</body>
</html>