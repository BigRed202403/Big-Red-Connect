<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Fare Calculator â€“ Big Red Connect</title>

  <!-- ğŸ“± PWA / Icons -->
  <link rel="apple-touch-icon" href="icon.PNG">
  <link rel="icon" type="image/png" sizes="192x192" href="icon.png">
  <link rel="shortcut icon" href="icon.PNG">
  <link rel="manifest" href="manifest.json">
  <meta name="apple-mobile-web-app-title" content="Big Red Connect">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="theme-color" content="#000000">

  <!-- No cache -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <link rel="stylesheet" href="style.css" />

  <!-- Google Maps -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCMM0dxLNM7XQI5G3OBSnINeO5hcS3Ks5I&libraries=places,geometry&callback=initGoogle" async defer></script>
</head>

<body>

  <!-- Header -->
  <div class="logo-header">
    <a href="index.html" title="Return to Home">
      <img src="official_logo_Nov.png" alt="Big Red Connect Logo" style="cursor:pointer;" />
    </a>
  </div>

  <!-- Centered Home Button -->
  <div class="top-home-btn" style="text-align:center; margin-top:10px; margin-bottom:10px;">
    <a href="index.html" class="btn secondary">ğŸ  Home</a>
  </div>

  <h1>Fare Calculator</h1>
  <p class="tagline">Plan your next ride connection â€” quick, simple, and local.</p>

  <div id="status-pill" class="status">Checking statusâ€¦</div>

  <section class="info-section calculator">
    <div class="ride-mode-toggle" aria-label="Choose ride mode">
      <button id="modeNow" class="btn btn-toggle active" type="button">ğŸš— Ride Now</button>
      <button id="modeReserve" class="btn btn-toggle" type="button">ğŸ•’ Reserve Ride</button>
    </div>

    <div id="reserveControls" style="display:none;">
      <label for="reserveDate">Date</label>
      <input id="reserveDate" type="date" />
      <label for="reserveTime">Time</label>
      <input id="reserveTime" type="time" />
      <label for="planBy">Plan By</label>
      <select id="planBy">
        <option value="pickup">Pickup Time</option>
        <option value="dropoff">Drop-Off Time</option>
      </select>
      <div id="reserveHint" style="color:#ccc;font-size:0.9em;margin:6px 0 10px;">
        Choose a date/time. Rush hour auto-applies if the pickup is a weekday 5â€“9 AM or 3â€“7 PM.
      </div>
    </div>

    <label for="pickup">Pickup Location</label>
    <input id="pickup" type="text" placeholder="Enter pickup address or place" />
    <button id="useLocPickup" class="btn primary" type="button" style="margin-top:8px;">ğŸ“ Use My Location for Pickup</button>

    <div id="stopsWrap"></div>
    <button id="addStopBtn" class="btn primary" type="button">â• Add Stop</button>

    <label for="dropoff">Drop-off Location</label>
    <input id="dropoff" type="text" placeholder="Enter drop-off address or place" />
    <button id="useLocDrop" class="btn secondary" type="button" style="margin-top:8px;">ğŸ“ Use My Location for Drop-off</button>

    <div id="map" style="height:250px;margin-top:15px;border-radius:10px;"></div>

    <div id="airport-note"></div>
    <div id="event-note"></div>
    <div id="rushhour-note"></div>
    <div id="fairness-note"></div>

    <select id="tripType" style="display:none;">
      <option value="10">Standard ($10 base)</option>
      <option value="15">Rush Hour ($15 base)</option>
      <option value="15_airport">Airport ($15 base)</option>
      <option value="20">Special Event ($20 base)</option>
    </select>

    <label for="payment">Payment Method</label>
    <select id="payment">
      <option value="cash">Cash / Venmo / Cash App (no fees)</option>
      <option value="card">Card (+3.3% booking + 2.4% fuel)</option>
    </select>

    <button class="btn primary" id="calcBtn" style="display:block;margin:20px auto;">ğŸ’² Calculate Fare</button>

    <div id="text-red-wrapper" style="margin-top:10px;text-align:center;">
      <a href="sms:+14053784024?&body=Hey%20Big%20Red%20â€”%20Iâ€™d%20like%20to%20plan%20a%20ride%20connection." class="btn secondary">ğŸ“² Text RED</a>
    </div>

    <div id="result" style="display:none;"></div>
    <p class="disclaimer">*Estimates only. Final fare may vary slightly based on route or wait time.</p>
  </section>

  <footer>
    <p>Â© 2025 Big Red Connect â€” <a href="index.html">Return to Home</a></p>
  </footer>

  <script src="status.js"></script>
  <script>
  const HQ = { lat: 35.3207, lng: -97.4929 };

  /* âœ… Uses location-reader worker â€” falls back to HQ if GPS is stale */
  const WORKER_URL = "https://location-reader.bigredtransportation.workers.dev";
  const STALE_MINUTES = 30;

  function getParam(name){
    const url = new URL(window.location.href);
    const v = url.searchParams.get(name);
    return v ? decodeURIComponent(v) : "";
  }

  window.addEventListener("DOMContentLoaded",()=>{
    try{
      const drop = getParam("dropoff");
      if(drop) document.getElementById("dropoff").value = drop;
      const saved = localStorage.getItem("bigred_last_rider");
      if(saved){
        const {address,lat,lng,timestamp} = JSON.parse(saved);
        const ageMin = (Date.now()-timestamp)/60000;
        if(ageMin <= 15){
          const input = document.getElementById("pickup");
          input.value = address?address:`${lat.toFixed(5)}, ${lng.toFixed(5)}`;
          const msg = document.createElement("div");
          msg.textContent = "âœ… Pickup auto-filled from your recent ETA check.";
          msg.style.cssText = "background:#112;color:#9f9;padding:8px;border-radius:6px;font-size:.9em;margin-bottom:10px;text-align:center;";
          input.parentNode.insertBefore(msg,input);
          setTimeout(()=>msg.remove(),6000);
        }
      }
    }catch(e){}
  });

  let map, geocoder, directionsService, directionsRenderer;
  let pickupLatLng = null, dropoffLatLng = null, pickupPlace = null, dropPlace = null;
  let pickupCity = "", driverPos = null, mode = "now", EVENT_VENUES = null;

  function isValidCoords(o){return o && typeof o.lat==="number" && typeof o.lng==="number" && !isNaN(o.lat) && !isNaN(o.lng);}
  function distMi(a,b){return(google.maps.geometry.spherical.computeDistanceBetween(new google.maps.LatLng(a.lat,a.lng),new google.maps.LatLng(b.lat,b.lng))/1609.34);}
  function weekdayRushHour(d){const day = d.getDay(), h = d.getHours();return day>=1 && day<=5 && ((h>=5 && h<9) || (h>=15 && h<19));}

  window.initGoogle = async function(){
    geocoder = new google.maps.Geocoder();
    directionsService = new google.maps.DirectionsService();
    directionsRenderer = new google.maps.DirectionsRenderer({suppressMarkers:true});
    map = new google.maps.Map(document.getElementById("map"),{center:{lat:35.4676,lng:-97.5164},zoom:11});
    directionsRenderer.setMap(map);

    const acPickup = new google.maps.places.Autocomplete(document.getElementById("pickup"));
    const acDrop = new google.maps.places.Autocomplete(document.getElementById("dropoff"));

    acPickup.addListener("place_changed",async()=>{
      const p = acPickup.getPlace();
      if(!p.geometry)return;
      pickupPlace = p;pickupLatLng = p.geometry.location;
      if(window.pickupMarker)window.pickupMarker.setMap(null);
      window.pickupMarker = new google.maps.Marker({position:pickupLatLng,map,label:"P"});
      map.setCenter(pickupLatLng);
      pickupCity = extractCity(p) || (await reverseCity(pickupLatLng));
      await applyRideTypePriority();
      await maybeShowFairnessNotePreview();
    });

    acDrop.addListener("place_changed",async()=>{
      const p = acDrop.getPlace();
      if(!p.geometry)return;
      dropPlace = p;dropoffLatLng = p.geometry.location;
      if(window.dropoffMarker)window.dropoffMarker.setMap(null);
      window.dropoffMarker = new google.maps.Marker({position:dropoffLatLng,map,label:"D"});
      map.panTo(dropoffLatLng);
      await applyRideTypePriority();
    });

    document.getElementById("modeNow").onclick = ()=>setMode("now");
    document.getElementById("modeReserve").onclick = ()=>setMode("reserve");
    document.getElementById("calcBtn").onclick = calculateFare;
    document.getElementById("addStopBtn").onclick = addStopField;
    document.getElementById("useLocPickup").onclick = ()=>useMyLocation("pickup");
    document.getElementById("useLocDrop").onclick = ()=>useMyLocation("dropoff");

    smartRideTypeDefault();
    await getDriverLocation();
  };

  function extractCity(p){const c = p.address_components || [];const f = c.find(x=>x.types?.includes("locality"));return f?f.long_name:"";}
  function reverseCity(latlng){return new Promise(r=>geocoder.geocode({location:latlng},(res,s)=>{if(s==="OK"&&res?.[0]){const f = res[0].address_components.find(x=>x.types?.includes("locality"));r(f?f.long_name:"");}else r("");}));}

  async function getDriverLocation(){
    try{
      const r = await fetch(WORKER_URL,{cache:"no-store"});
      const j = await r.json();
      const lat = parseFloat(j.latitude), lng = parseFloat(j.longitude);
      const t = j.timestamp?new Date(j.timestamp):null;
      const age = t?(Date.now()-t.getTime())/60000:999;
      if(!isNaN(lat)&&!isNaN(lng)&&age<=STALE_MINUTES){driverPos={lat,lng};}
      else driverPos=HQ;
    }catch{driverPos=HQ;}
  }

  /* === Refined Fairness Fee === */
  function calcFairnessFee(mi,ref,pLL){
    if(!pLL||!ref)return 0;
    const d = distMi(ref,{lat:pLL.lat(),lng:pLL.lng()});
    if(d>40)return 20;
    if(d>20)return 10;
    return 0;
  }

  async function maybeShowFairnessNotePreview(){
    if(!pickupLatLng){document.getElementById("fairness-note").innerHTML="";return;}
    await getDriverLocation();
    const ref = isValidCoords(driverPos)?driverPos:HQ;
    const d = distMi(ref,{lat:pickupLatLng.lat(),lng:pickupLatLng.lng()});
    let msg="";
    if(d>40)msg="A travel fairness fee may apply ($20 zone).";
    else if(d>20)msg="A small travel fairness fee may apply ($10 zone).";
    document.getElementById("fairness-note").innerHTML=msg||"";
  }

  /* === Rest of the calculator: unchanged === */
  // (Ride type detection, event/airport logic, mileage, stop count, card fees, and SMS share remain identical)
  </script>
</body>
</html>