<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Fare Calculator ‚Äì Big Red Connect</title>

  <!-- üì± PWA / Icons -->
  <link rel="apple-touch-icon" href="icon.PNG">
  <link rel="icon" type="image/png" sizes="192x192" href="icon.png">
  <link rel="shortcut icon" href="icon.PNG">
  <link rel="manifest" href="manifest.json">
  <meta name="apple-mobile-web-app-title" content="Big Red Connect">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="theme-color" content="#000000">

  <!-- No cache -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <link rel="stylesheet" href="style.css" />

  <!-- Google Maps -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCMM0dxLNM7XQI5G3OBSnINeO5hcS3Ks5I&libraries=places,geometry&callback=initGoogle" async defer></script>
</head>

<body>

  <!-- Header -->
  <div class="logo-header">
    <a href="index.html" title="Return to Home">
      <img src="official_logo_Nov.png" alt="Big Red Connect Logo" style="cursor:pointer;" />
    </a>
  </div>

  <!-- Centered Home Button -->
  <div class="top-home-btn" style="text-align:center; margin-top:10px; margin-bottom:10px;">
    <a href="index.html" class="btn secondary">üè† Home</a>
  </div>

  <h1>Fare Calculator</h1>
  <p class="tagline">Plan your next ride connection ‚Äî quick, simple, and local.</p>

  <div id="status-pill" class="status">Checking status‚Ä¶</div>

  <section class="info-section calculator">
    <div class="ride-mode-toggle" aria-label="Choose ride mode">
      <button id="modeNow" class="btn btn-toggle active" type="button">üöó Ride Now</button>
      <button id="modeReserve" class="btn btn-toggle" type="button">üïí Reserve Ride</button>
    </div>

    <div id="reserveControls" style="display:none;">
      <label for="reserveDate">Date</label>
      <input id="reserveDate" type="date" />
      <label for="reserveTime">Time</label>
      <input id="reserveTime" type="time" />
      <label for="planBy">Plan By</label>
      <select id="planBy">
        <option value="pickup">Pickup Time</option>
        <option value="dropoff">Drop-Off Time</option>
      </select>
      <div id="reserveHint" style="color:#ccc;font-size:0.9em;margin:6px 0 10px;">
        Choose a date/time. Rush hour auto-applies if the pickup is a weekday 5‚Äì9 AM or 3‚Äì7 PM.
      </div>
    </div>

    <label for="pickup">Pickup Location</label>
    <input id="pickup" type="text" placeholder="Enter pickup address or place" />
    <button id="useLocPickup" class="btn primary" type="button" style="margin-top:8px;">üìç Use My Location for Pickup</button>

    <div id="stopsWrap"></div>
    <button id="addStopBtn" class="btn primary" type="button">‚ûï Add Stop</button>

    <label for="dropoff">Drop-off Location</label>
    <input id="dropoff" type="text" placeholder="Enter drop-off address or place" />
    <button id="useLocDrop" class="btn secondary" type="button" style="margin-top:8px;">üìç Use My Location for Drop-off</button>

    <div id="map" style="height:250px;margin-top:15px;border-radius:10px;"></div>

    <div id="airport-note"></div>
    <div id="event-note"></div>
    <div id="rushhour-note"></div>
    <div id="fairness-note"></div>

    <select id="tripType" style="display:none;">
      <option value="10">Standard ($10 base)</option>
      <option value="15">Rush Hour ($15 base)</option>
      <option value="15_airport">Airport ($15 base)</option>
      <option value="20">Special Event ($20 base)</option>
    </select>

    <label for="payment">Payment Method</label>
    <select id="payment">
      <option value="cash">Cash / Venmo / Cash App (no fees)</option>
      <option value="card">Card (+3.3% booking + 2.4% fuel)</option>
    </select>

    <button class="btn primary" id="calcBtn" style="display:block;margin:20px auto;">üí≤ Calculate Fare</button>

    <div id="text-red-wrapper" style="margin-top:10px;text-align:center;">
      <a href="sms:+14053784024?&body=Hey%20Big%20Red%20‚Äî%20I‚Äôd%20like%20to%20plan%20a%20ride%20connection." class="btn secondary">üì≤ Text RED</a>
    </div>

    <div id="result" style="display:none;"></div>
    <p class="disclaimer">*Estimates only. Final fare may vary slightly based on route or wait time.</p>
  </section>

  <footer>
    <p>&copy; 2025 Big Red Connect ‚Äî <a href="index.html">Return to Home</a></p>
  </footer>

  <script src="status.js"></script>
  <script>
  const HQ = { lat: 35.3207, lng: -97.4929 };
  const WORKER_URL = "https://update-location.bigredtransportation.workers.dev";
  const STALE_MINUTES = 30;

  // === URL parameter helper ===
  function getParam(name) {
    const url = new URL(window.location.href);
    const v = url.searchParams.get(name);
    return v ? decodeURIComponent(v) : "";
  }

  // --- Auto-fill from ETA and ?dropoff ---
  window.addEventListener("DOMContentLoaded", () => {
    try {
      const drop = getParam("dropoff");
      if (drop) document.getElementById("dropoff").value = drop;

      const saved = localStorage.getItem("bigred_last_rider");
      if (saved) {
        const { address, lat, lng, timestamp } = JSON.parse(saved);
        const ageMin = (Date.now() - timestamp) / 60000;
        if (ageMin <= 15) {
          const input = document.getElementById("pickup");
          input.value = address ? address : `${lat.toFixed(5)}, ${lng.toFixed(5)}`;
          const msg = document.createElement("div");
          msg.textContent = "‚úÖ Pickup auto-filled from your recent ETA check.";
          msg.style.cssText = "background:#112;color:#9f9;padding:8px;border-radius:6px;font-size:.9em;margin-bottom:10px;text-align:center;";
          input.parentNode.insertBefore(msg, input);
          setTimeout(() => msg.remove(), 6000);
        }
      }
    } catch (e) {}
  });

  // ===== Full Fare Calculator =====
  let map, geocoder, directionsService, directionsRenderer;
  let pickupLatLng = null,
    dropoffLatLng = null,
    pickupPlace = null,
    dropPlace = null;
  let pickupCity = "",
    driverPos = null,
    mode = "now",
    EVENT_VENUES = null;

  function isValidCoords(o) {
    return (
      o &&
      typeof o.lat === "number" &&
      typeof o.lng === "number" &&
      !isNaN(o.lat) &&
      !isNaN(o.lng)
    );
  }
  function distMi(a, b) {
    return (
      google.maps.geometry.spherical.computeDistanceBetween(
        new google.maps.LatLng(a.lat, a.lng),
        new google.maps.LatLng(b.lat, b.lng)
      ) / 1609.34
    );
  }
  function weekdayRushHour(d) {
    const day = d.getDay(),
      h = d.getHours();
    return day >= 1 && day <= 5 && ((h >= 5 && h < 9) || (h >= 15 && h < 19));
  }

  window.initGoogle = async function () {
    geocoder = new google.maps.Geocoder();
    directionsService = new google.maps.DirectionsService();
    directionsRenderer = new google.maps.DirectionsRenderer({
      suppressMarkers: true,
    });
    map = new google.maps.Map(document.getElementById("map"), {
      center: { lat: 35.4676, lng: -97.5164 },
      zoom: 11,
    });
    directionsRenderer.setMap(map);

    const acPickup = new google.maps.places.Autocomplete(
      document.getElementById("pickup")
    );
    const acDrop = new google.maps.places.Autocomplete(
      document.getElementById("dropoff")
    );

    acPickup.addListener("place_changed", async () => {
      const p = acPickup.getPlace();
      if (!p.geometry) return;
      pickupPlace = p;
      pickupLatLng = p.geometry.location;
      if (window.pickupMarker) window.pickupMarker.setMap(null);
      window.pickupMarker = new google.maps.Marker({
        position: pickupLatLng,
        map,
        label: "P",
      });
      map.setCenter(pickupLatLng);
      pickupCity = extractCity(p) || (await reverseCity(pickupLatLng));
      await applyRideTypePriority();
      await maybeShowFairnessNotePreview();
    });

    acDrop.addListener("place_changed", async () => {
      const p = acDrop.getPlace();
      if (!p.geometry) return;
      dropPlace = p;
      dropoffLatLng = p.geometry.location;
      if (window.dropoffMarker) window.dropoffMarker.setMap(null);
      window.dropoffMarker = new google.maps.Marker({
        position: dropoffLatLng,
        map,
        label: "D",
      });
      map.panTo(dropoffLatLng);
      await applyRideTypePriority();
    });

    document.getElementById("modeNow").onclick = () => setMode("now");
    document.getElementById("modeReserve").onclick = () => setMode("reserve");
    document.getElementById("calcBtn").onclick = calculateFare;
    document.getElementById("addStopBtn").onclick = addStopField;
    document.getElementById("useLocPickup").onclick = () => useMyLocation("pickup");
    document.getElementById("useLocDrop").onclick = () => useMyLocation("dropoff");

    smartRideTypeDefault();
    await getDriverLocation();
  };

  function extractCity(p) {
    const c = p.address_components || [];
    const f = c.find((x) => x.types?.includes("locality"));
    return f ? f.long_name : "";
  }
  function reverseCity(latlng) {
    return new Promise((r) =>
      geocoder.geocode({ location: latlng }, (res, s) => {
        if (s === "OK" && res?.[0]) {
          const f = res[0].address_components.find((x) =>
            x.types?.includes("locality")
          );
          r(f ? f.long_name : "");
        } else r("");
      })
    );
  }

  async function getDriverLocation() {
    try {
      const r = await fetch(WORKER_URL, { cache: "no-store" });
      const j = await r.json();
      const lat = parseFloat(j.latitude),
        lng = parseFloat(j.longitude);
      const t = j.timestamp ? new Date(j.timestamp) : null;
      const age = t ? (Date.now() - t.getTime()) / 60000 : 999;
      if (!isNaN(lat) && !isNaN(lng) && age <= STALE_MINUTES) {
        driverPos = { lat, lng };
      } else driverPos = HQ;
    } catch {
      driverPos = HQ;
    }
  }

  function setMode(m) {
    mode = m;
    const now = document.getElementById("modeNow"),
      res = document.getElementById("modeReserve"),
      ctr = document.getElementById("reserveControls");
    if (m === "now") {
      now.classList.add("active");
      res.classList.remove("active");
      ctr.style.display = "none";
      smartRideTypeDefault();
    } else {
      res.classList.add("active");
      now.classList.remove("active");
      ctr.style.display = "block";
    }
  }

  function addStopField() {
    if (window.stopInputs?.length >= 3) {
      alert("Limit 3 stops.");
      return;
    }
    if (!window.stopInputs) window.stopInputs = [];
    const id = `stop_${Date.now()}`;
    window.stopInputs.push(id);
    const wrap = document.getElementById("stopsWrap");
    const div = document.createElement("div");
    div.className = "stop-row";
    div.id = `row_${id}`;
    div.innerHTML = `<label for="${id}">Stop ${window.stopInputs.length}</label>
    <div style="display:flex;gap:6px;align-items:center;"><input id="${id}" type="text" placeholder="Enter stop address or place" style="flex:1;">
    <button type="button" class="remove-stop" onclick="removeStop('${id}')">‚úñ</button></div>`;
    wrap.appendChild(div);
    new google.maps.places.Autocomplete(document.getElementById(id));
  }

  function removeStop(id) {
    document.getElementById(`row_${id}`)?.remove();
    window.stopInputs = (window.stopInputs || []).filter((s) => s !== id);
    document.querySelectorAll("#stopsWrap label").forEach(
      (l, i) => (l.textContent = `Stop ${i + 1}`)
    );
  }

  async function useMyLocation(id) {
    if (!navigator.geolocation) {
      alert("Location not supported.");
      return;
    }
    navigator.geolocation.getCurrentPosition(async (p) => {
      const latlng = { lat: p.coords.latitude, lng: p.coords.longitude };
      const addr = await new Promise((r) =>
        geocoder.geocode({ location: latlng }, (res, s) =>
          r(
            s === "OK" && res[0]
              ? res[0].formatted_address
              : `${latlng.lat},${latlng.lng}`
          )
        )
      );
      document.getElementById(id).value = addr;
      if (id === "pickup") {
        pickupLatLng = new google.maps.LatLng(latlng.lat, latlng.lng);
        if (window.pickupMarker) window.pickupMarker.setMap(null);
        window.pickupMarker = new google.maps.Marker({
          position: pickupLatLng,
          map,
          label: "P",
        });
        pickupCity = await reverseCity(latlng);
        await applyRideTypePriority();
        await maybeShowFairnessNotePreview();
      } else {
        dropoffLatLng = new google.maps.LatLng(latlng.lat, latlng.lng);
        if (window.dropoffMarker) window.dropoffMarker.setMap(null);
        window.dropoffMarker = new google.maps.Marker({
          position: dropoffLatLng,
          map,
          label: "D",
        });
        await applyRideTypePriority();
      }
    });
  }

  function smartRideTypeDefault() {
    const now = new Date();
    if (weekdayRushHour(now)) {
      setTripType("15");
      document.getElementById("rushhour-note").innerHTML =
        "üö¶ Weekday Rush Hour pricing (5‚Äì9 AM / 3‚Äì7 PM)";
    } else {
      if (
        document.getElementById("tripType").value !== "15_airport" &&
        document.getElementById("tripType").value !== "20"
      ) {
        setTripType("10");
      }
      document.getElementById("rushhour-note").innerHTML = "";
    }
  }

  function setTripType(v) {
    document.getElementById("tripType").value = v;
  }

  async function applyRideTypePriority(dt = null) {
    const airport = detectAirportAndFlag();
    if (airport) {
      setTripType("15_airport");
      document.getElementById("rushhour-note").innerHTML = "";
      return;
    }
    const event = await detectEventAndFlag();
    if (event) {
      setTripType("20");
      document.getElementById("rushhour-note").innerHTML = "";
      return;
    }
    if (mode === "reserve" && dt) applyRushHourForReserve(dt);
    else smartRideTypeDefault();
  }

  function detectAirportAndFlag() {
    let combo = "";
    [pickupPlace, dropPlace]
      .filter(Boolean)
      .forEach((p) => (combo += (p?.name || "") + (p?.formatted_address || "")));
    const c = combo.toLowerCase(),
      isAirport = c.includes("airport") && !c.includes("tinker");
    document.getElementById("airport-note").innerHTML = isAirport
      ? "‚úàÔ∏è Airport ride detected ‚Äî $15 base applied automatically."
      : "";
    return isAirport;
  }

  async function detectEventAndFlag() {
    if (!EVENT_VENUES) {
      try {
        const r = await fetch("event-venues.json", { cache: "no-store" });
        EVENT_VENUES = await r.json();
      } catch {
        EVENT_VENUES = { venues: [], keywords: [] };
      }
    }
    let inside = null;
    function inRad(pt, c, r) {
      return distMi(c, pt) <= r;
    }
    if (pickupLatLng) {
      const p = { lat: pickupLatLng.lat(), lng: pickupLatLng.lng() };
      for (const v of EVENT_VENUES.venues) {
        if (inRad(p, { lat: v.lat, lng: v.lng }, v.radius_mi)) {
          inside = v;
          break;
        }
      }
    }
    if (!inside && dropoffLatLng) {
      const d = { lat: dropoffLatLng.lat(), lng: dropoffLatLng.lng() };
      for (const v of EVENT_VENUES.venues) {
        if (inRad(d, { lat: v.lat, lng: v.lng }, v.radius_mi)) {
          inside = v;
          break;
        }
      }
    }
    if (!inside) {
      let c =
        ((pickupPlace?.name || "") +
          (pickupPlace?.formatted_address || "") +
          (dropPlace?.name || "") +
          (dropPlace?.formatted_address || "")).toLowerCase();
      const hit = (EVENT_VENUES.keywords || []).some((k) =>
        c.includes(k.toLowerCase())
      );
      if (hit) inside = { name: "Special Event Area" };
    }
    if (inside) {
      document.getElementById(
        "event-note"
      ).innerHTML = `üéüÔ∏è Special event near ${inside.name} ‚Äî event base rate applies`;
      return true;
    } else {
      document.getElementById("event-note").innerHTML = "";
      return false;
    }
  }

  function calcFairnessFee(mi, ref, pLL) {
    if (!pLL || !ref) return 0;
    const d = distMi(ref, { lat: pLL.lat(), lng: pLL.lng() });
    if (d > 35) return 20;
    if (d > 15) return 10;
    return 0;
  }

  async function maybeShowFairnessNotePreview() {
    if (!pickupLatLng) {
      document.getElementById("fairness-note").innerHTML = "";
      return;
    }
    await getDriverLocation();
    const ref = isValidCoords(driverPos) ? driverPos : HQ;
    const d = distMi(ref, { lat: pickupLatLng.lat(), lng: pickupLatLng.lng() });
    let msg = "";
    if (d > 35) msg = "A travel fairness fee may apply.";
    else if (d > 15) msg = "A small fairness fee may apply.";
    document.getElementById("fairness-note").innerHTML = msg || "";
  }

  async function calculateFare() {
    const pickup = document.getElementById("pickup").value.trim(),
      dropoff = document.getElementById("dropoff").value.trim();
    if (!pickup || !dropoff) {
      alert("Please enter both pickup and drop-off.");
      return;
    }

    const stops = [];
    for (const id of window.stopInputs || []) {
      const v = document.getElementById(id)?.value.trim();
      if (v) stops.push({ location: v, stopover: true });
    }

    const route = await new Promise((res, rej) =>
      directionsService.route(
        {
          origin: pickup,
          destination: dropoff,
          waypoints: stops,
          travelMode: "DRIVING",
        },
        (r, s) => (s === "OK" ? res(r) : rej(s))
      )
    );

    directionsRenderer.setDirections(route);
    const legs = route.routes[0].legs;
    const rawMiles =
      legs.reduce((m, l) => m + (l.distance?.value || 0), 0) / 1609.34;
    const miles = Math.round(rawMiles); // <-- Rounded to nearest whole mile
    const duration =
      legs.reduce((t, l) => t + (l.duration?.value || 0), 0) / 60;

    await applyRideTypePriority();
    await getDriverLocation();
    const ref = isValidCoords(driverPos) ? driverPos : HQ;

    const tripVal = document.getElementById("tripType").value;
    const base = tripVal === "15_airport" ? 15 : parseFloat(tripVal);
    const tier2 = Math.max(0, Math.min(10, miles - 10)) * 1.25;
    const tier3 = Math.max(0, miles - 20) * 1.0;
    const milesSub = tier2 + tier3;

    const fair = calcFairnessFee(miles, ref, pickupLatLng);
    const stopsTot =
      (window.stopInputs || []).filter(
        (id) => (document.getElementById(id)?.value || "").trim().length > 0
      ).length * 5;

    let fare = base + milesSub + stopsTot + fair;
    const pay = document.getElementById("payment").value;
    if (pay === "card") fare += fare * 0.033 + fare * 0.024;

    const total = fare.toFixed(2);
    const resDiv = document.getElementById("result");
    resDiv.innerHTML = `<div class="total">$${total}</div>
      <p><strong>Base:</strong> $${base.toFixed(2)}</p>
      <p><strong>Mileage:</strong> $${milesSub.toFixed(2)}</p>
      <p><strong>Stops:</strong> ${(stopsTot / 5)} √ó $5 = $${stopsTot.toFixed(2)}</p>
      ${fair > 0 ? `<p><strong>Travel Fairness Fee:</strong> $${fair.toFixed(2)}</p>` : ""}
      <p><strong>Payment:</strong> ${pay === "card" ? "Card (incl. fees)" : "Cash / Venmo / Cash App"}</p>
      <p>üìè ${miles} mi  ‚è±Ô∏è ${Math.round(duration)} min</p>
      <p style="text-align:center;margin-top:15px;"><button class="btn primary" id="textRedBtn">üì≤ Text RED with Trip Details</button></p>
      <p style="text-align:center;color:#888;margin-top:10px;">No surprises. Just solid local moves.</p>`;
    resDiv.style.display = "block";

    document.getElementById("textRedBtn").onclick = () => {
      const name = prompt("Enter your name for Big Red:");
      const lines = [];
      lines.push(`Hey Big Red ‚Äî this is ${name || "a rider"}.`);
      lines.push(`Ride estimate: $${total}`);
      lines.push(`From: ${pickup}`);
      if (stops.length)
        lines.push(`Stops: ${stops.map((s) => s.location).join(" ‚Üí ")}`);
      lines.push(`To: ${dropoff}`);
      lines.push(`Distance: ${miles} mi`);
      lines.push(`Time: ${Math.round(duration)} min`);
      if (fair > 0) lines.push(`Includes travel fairness fee: $${fair.toFixed(2)}.`);
      if (document.getElementById("tripType").value === "15_airport")
        lines.push("(Airport base applied)");
      if (document.getElementById("tripType").value === "20")
        lines.push("(Special event area base applied)");
      lines.push(
        `Payment: ${pay === "card" ? "Card (incl. fees)" : "Cash / Venmo / Cash App"}`
      );

      const routeLink = `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(
        pickup
      )}&destination=${encodeURIComponent(dropoff)}`;
      lines.push(`Route: ${routeLink}`);
      lines.push("No surprises. Just solid local moves.");

      const smsBody = encodeURIComponent(lines.join(" "));
      window.location.href = `sms:+14053784024?&body=${smsBody}`;
    };
  }
  </script>
</body>
</html>