<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>My Ride ‚Äì Big Red Connect</title>

<!-- PWA + Branding -->
<link rel="apple-touch-icon" href="icon.PNG">
<link rel="icon" type="image/png" sizes="192x192" href="icon.png">
<meta name="theme-color" content="#000000">

<!-- OneSignal -->
<script src="https://cdn.onesignal.com/sdks/OneSignalSDK.js" async></script>

<style>
  body {
    margin: 0;
    background: #000;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    color: #fff;
  }

  header {
    padding: 12px 15px;
    background: #111;
    border-bottom: 2px solid #b30000;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  h1 {
    font-size: 1.4rem;
    margin: 0;
  }

  #statusBox {
    margin: 15px;
    background: #111;
    padding: 15px;
    border-radius: 10px;
    border: 1px solid #222;
  }

  .label {
    color: #ccc;
    font-size: .8rem;
  }

  .value {
    font-size: 1rem;
    margin-bottom: 5px;
  }

  #cancelBtn {
    display: block;
    margin: 20px auto;
    background: #700;
    color: #fff;
    font-weight: 600;
    border: 1px solid #a00;
    padding: 10px 20px;
    border-radius: 999px;
    font-size: .9rem;
  }

  .muted {
    color: #777;
    margin-top: 20px;
    font-size: .8rem;
    text-align: center;
  }

  #partyInputBox {
    margin: 15px;
    background: #111;
    padding: 15px;
    border-radius: 10px;
    border: 1px solid #222;
  }

  select {
    width: 100%;
    padding: 8px;
    border-radius: 7px;
    background: #000;
    border: 1px solid #444;
    color: #fff;
    font-size: .9rem;
  }

  #savePartyBtn {
    margin-top: 10px;
    width: 100%;
    background: #222;
    color: #fff;
    border: 1px solid #444;
    padding: 10px;
    border-radius: 9px;
    font-size: .9rem;
  }

</style>
</head>

<body>

<header>
  <h1>My Ride</h1>
  <button id="notifyBtn" style="
    background:#111;border:1px solid #444;
    color:#ddd;padding:6px 15px;border-radius:999px;
  ">üîî Alerts: Off</button>
</header>

<div id="partyInputBox">
  <div class="label">How many riders?</div>
  <select id="partySize">
    <option value="1">1 rider</option>
    <option value="2">2 riders</option>
    <option value="3">3 riders</option>
    <option value="4">4 riders</option>
    <option value="5">5 riders</option>
    <option value="6">6 riders</option>
  </select>
  <button id="savePartyBtn">Save Party Size</button>
</div>

<div id="statusBox">
  <div class="label">Booking ID</div>
  <div class="value" id="bookingId">‚Äî</div>

  <div class="label">Status</div>
  <div class="value" id="rideStatus">Loading‚Ä¶</div>

  <div class="label">Driver</div>
  <div class="value">Big Red üöó</div>

  <div class="label">Pickup</div>
  <div class="value" id="pickupAddr">‚Äî</div>

  <div class="label">Drop-off</div>
  <div class="value" id="dropoffAddr">‚Äî</div>

  <div class="label">Estimate</div>
  <div class="value" id="estimateVal">‚Äî</div>
</div>

<button id="cancelBtn">Cancel Ride</button>

<div class="muted">Page auto-updates every 10 seconds. Ride safe, ride local. ‚ù§Ô∏è</div>

<script>
const API_BASE = "https://bigred-bookings.bigredtransportation.workers.dev";
const ONESIGNAL_APP_ID = "64641a89-3619-4491-a25b-c0ab000bdfe0";

let bookingId = null;
let playerId = null;

// --- GET ID FROM URL ---
const url = new URL(window.location.href);
bookingId = url.searchParams.get("id");
document.getElementById("bookingId").textContent = bookingId || "Missing";

if (!bookingId) {
  document.getElementById("rideStatus").textContent = "Invalid ride link.";
}

// --- NOTIFICATION SETUP ---
window.OneSignal = window.OneSignal || [];
OneSignal.push(function() {
  OneSignal.init({
    appId: ONESIGNAL_APP_ID,
    notifyButton: { enable: false }
  });

  OneSignal.isPushNotificationsEnabled(function(enabled) {
    updateNotifyUI(enabled);
    if (enabled) {
      OneSignal.getUserId().then(id => {
        playerId = id;
        registerRiderDevice(id);
      });
    }
  });

  OneSignal.on('subscriptionChange', function(enabled) {
    updateNotifyUI(enabled);
    if (enabled) {
      OneSignal.getUserId().then(id => {
        playerId = id;
        registerRiderDevice(id);
      });
    }
  });
});

function updateNotifyUI(on) {
  const btn = document.getElementById("notifyBtn");
  if (on) {
    btn.textContent = "üîî Alerts: On";
    btn.style.borderColor = "#3a3";
    btn.style.color = "#9f9";
    btn.style.background = "#071707";
  } else {
    btn.textContent = "üîî Alerts: Off";
    btn.style.borderColor = "#444";
    btn.style.color = "#ddd";
    btn.style.background = "#111";
  }
}

document.getElementById("notifyBtn").onclick = () => {
  OneSignal.isPushNotificationsEnabled(function(enabled) {
    if (!enabled) OneSignal.registerForPushNotifications();
    else alert("Alerts already enabled.");
  });
};

function registerRiderDevice(playerId) {
  fetch(`${API_BASE}/api/rider/device`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      bookingId,
      playerId,
      role: "rider"
    })
  });
}

// --- PARTY SIZE SAVE ---
document.getElementById("savePartyBtn").onclick = async () => {
  const size = Number(document.getElementById("partySize").value);

  await fetch(`${API_BASE}/api/driver/bookings/${bookingId}`, {
    method: "PUT",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({
      rider: { partySize: size }
    })
  });

  alert("Party size saved!");
};

// --- LOAD BOOKING ---
async function loadBooking() {
  if (!bookingId) return;

  try {
    const res = await fetch(`${API_BASE}/api/driver/bookings/${bookingId}`);
    const b = await res.json();

    document.getElementById("rideStatus").textContent = b.status;
    document.getElementById("pickupAddr").textContent = b.pickup?.address || "‚Äî";
    document.getElementById("dropoffAddr").textContent = b.dropoff?.address || "‚Äî";
    document.getElementById("estimateVal").textContent =
      b.pricing?.estimate ? "$" + b.pricing.estimate.toFixed(2) : "‚Äî";

    if (b.rider?.partySize) {
      document.getElementById("partySize").value = b.rider.partySize;
    }

  } catch (err) {
    document.getElementById("rideStatus").textContent = "Error loading status.";
  }
}

setInterval(loadBooking, 10000);
loadBooking();

// --- RIDER CANCEL ---
document.getElementById("cancelBtn").onclick = async () => {
  if (!confirm("Cancel this ride?")) return;

  await fetch(`${API_BASE}/api/driver/bookings/${bookingId}`, {
    method: "PUT",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ status: "CANCELLED" })
  });

  alert("Your ride has been cancelled.");
  loadBooking();
};
</script>

</body>
</html>