<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>My Ride â€“ Big Red Connect</title>

  <!-- ðŸ“± PWA / Icons -->
  <link rel="apple-touch-icon" href="icon.PNG">
  <link rel="icon" type="image/png" sizes="192x192" href="icon.png">
  <link rel="shortcut icon" href="icon.PNG">
  <meta name="apple-mobile-web-app-title" content="Big Red Connect">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="theme-color" content="#000000">

  <!-- No cache -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <!-- OneSignal SDK -->
  <script src="https://cdn.onesignal.com/sdks/OneSignalSDK.js" async></script>

  <style>
    :root {
      --red: #b30000;
      --bg: #000;
      --panel: #111;
      --border: #222;
      --muted: #aaa;
      --accent: #ffcc00;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: radial-gradient(circle at top, #111 0, #000 55%);
      color: #fff;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    a {
      color: #fff;
      text-decoration: none;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 12px;
      background: rgba(0,0,0,0.94);
      border-bottom: 2px solid var(--red);
    }

    .hdr-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo {
      height: 40px;
      width: auto;
      border-radius: 4px;
    }

    .hdr-title {
      display: flex;
      flex-direction: column;
    }

    .hdr-title span:first-child {
      font-weight: 700;
      font-size: 0.95rem;
      letter-spacing: 0.03em;
      text-transform: uppercase;
    }

    .hdr-title span:last-child {
      font-size: 0.8rem;
      color: var(--muted);
    }

    .hdr-right {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
      font-size: 0.8rem;
    }

    .pill {
      padding: 3px 9px;
      border-radius: 999px;
      font-weight: 600;
      font-size: 0.78rem;
      background: #222;
      border: 1px solid #444;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .pill-push.ok { color: #8f8; border-color: #3a3; }
    .pill-push.off { color: #f8c; border-color: #a36; }

    main {
      flex: 1;
      padding: 14px 12px 18px;
      max-width: 700px;
      width: 100%;
      margin: 0 auto;
    }

    .card {
      background: rgba(10,10,10,0.96);
      border-radius: 12px;
      border: 1px solid var(--border);
      padding: 12px 12px 14px;
      margin-bottom: 14px;
    }

    .card h2 {
      margin: 0 0 6px;
      font-size: 1rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .status-label {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 3px 9px;
      border-radius: 999px;
      border: 1px solid #444;
      font-size: 0.8rem;
      margin-top: 4px;
    }

    .status-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: #666;
    }

    .status-dot.live { background: #3ad35e; }

    .row {
      margin-top: 8px;
      font-size: 0.85rem;
    }

    .row-label {
      font-size: 0.75rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .row-value {
      margin-top: 2px;
    }

    .est-row {
      margin-top: 10px;
      font-size: 0.9rem;
    }

    .est-row strong {
      font-size: 1.1rem;
      color: var(--accent);
    }

    .meta {
      margin-top: 6px;
      font-size: 0.78rem;
      color: var(--muted);
    }

    .btn {
      border-radius: 999px;
      border: none;
      padding: 7px 13px;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .btn-primary {
      background: var(--red);
      color: #fff;
    }

    .btn-ghost {
      background: transparent;
      border: 1px solid #444;
      color: #fff;
    }

    .actions {
      margin-top: 12px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .hint {
      font-size: 0.78rem;
      color: var(--muted);
      margin-top: 6px;
    }

    footer {
      text-align: center;
      padding: 8px 10px 12px;
      font-size: 0.75rem;
      color: #777;
    }

    #toast {
      position: fixed;
      bottom: 16px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.92);
      color: #fff;
      padding: 8px 14px;
      border-radius: 999px;
      font-size: 0.8rem;
      border: 1px solid var(--red);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s;
      z-index: 10;
      max-width: 90%;
      text-align: center;
    }

    #toast.show {
      opacity: 1;
      pointer-events: auto;
    }
  </style>
</head>
<body>

<header>
  <div class="hdr-left">
    <a href="index.html" title="Return to Home">
      <img src="official_logo_Nov.png" alt="Big Red Connect Logo" class="logo" />
    </a>
    <div class="hdr-title">
      <span>My Big Red Ride</span>
      <span>Estimate, status & updates</span>
    </div>
  </div>
  <div class="hdr-right">
    <div class="pill pill-push off" id="pushPill">Notifications: Off</div>
  </div>
</header>

<main>
  <div id="rideCard" class="card">
    <h2>Ride Details</h2>
    <div id="statusChip" class="status-label">
      <span class="status-dot" id="statusDot"></span>
      <span id="statusText">Loadingâ€¦</span>
    </div>

    <div class="row">
      <div class="row-label">From</div>
      <div class="row-value" id="fromText">â€”</div>
    </div>

    <div class="row">
      <div class="row-label">Stops</div>
      <div class="row-value" id="stopsText">None</div>
    </div>

    <div class="row">
      <div class="row-label">To</div>
      <div class="row-value" id="toText">â€”</div>
    </div>

    <div class="est-row" id="estRow">
      <div>Estimated Fare:</div>
      <div><strong id="estAmount">$â€”</strong></div>
    </div>

    <div class="meta" id="metaLine">Requested: â€”</div>

    <div class="actions">
      <button class="btn btn-primary" id="btnRefresh">ðŸ”„ Refresh Status</button>
      <button class="btn btn-ghost" id="btnTextRed">ðŸ“² Text Big Red</button>
    </div>

    <div class="hint">
      Want live updates? Allow notifications when prompted. You can always turn them off later.
    </div>
  </div>
</main>

<footer>
  Â© 2025 Big Red Connect â€” Veteran Owned. Affordable. Local. Trusted.
</footer>

<div id="toast"></div>

<script>
  const API_BASE = "https://bigred-bookings.bigredtransportation.workers.dev";
  const ONESIGNAL_APP_ID = "64641a89-3619-4491-a25b-c0ab000bdfe0"; // ðŸ” same as admin/driver

  const params = new URLSearchParams(window.location.search);
  const bookingId = params.get("id") || "";

  const pushPill = document.getElementById("pushPill");
  const statusText = document.getElementById("statusText");
  const statusDot = document.getElementById("statusDot");
  const fromText = document.getElementById("fromText");
  const toText = document.getElementById("toText");
  const stopsText = document.getElementById("stopsText");
  const estAmount = document.getElementById("estAmount");
  const metaLine = document.getElementById("metaLine");
  const btnRefresh = document.getElementById("btnRefresh");
  const btnTextRed = document.getElementById("btnTextRed");
  const toastEl = document.getElementById("toast");

  function showToast(msg, ms = 2200) {
    toastEl.textContent = msg;
    toastEl.classList.add("show");
    setTimeout(() => toastEl.classList.remove("show"), ms);
  }

  function statusLabel(s) {
    const u = (s || "REQUESTED").toUpperCase();
    switch (u) {
      case "REQUESTED": return "Requested";
      case "ACCEPTED":  return "Accepted";
      case "ENROUTE":   return "En Route";
      case "ARRIVED":   return "Arrived";
      case "ONBOARD":   return "Onboard";
      case "COMPLETED": return "Completed";
      case "CANCELLED": return "Cancelled";
      default:          return u;
    }
  }

  function fmtTime(iso) {
    if (!iso) return "Unknown";
    try {
      const d = new Date(iso);
      return d.toLocaleString("en-US", {
        month: "short",
        day: "numeric",
        hour: "numeric",
        minute: "2-digit"
      });
    } catch {
      return iso;
    }
  }

  async function fetchBooking() {
    if (!bookingId) {
      statusText.textContent = "Missing ride ID.";
      return;
    }

    try {
      const res = await fetch(`${API_BASE}/api/driver/bookings/${encodeURIComponent(bookingId)}?t=${Date.now()}`, {
        method: "GET",
        headers: { "Accept": "application/json" }
      });

      if (!res.ok) {
        statusText.textContent = "Ride not found.";
        showToast("Could not load ride details.");
        return;
      }

      const b = await res.json();
      renderBooking(b);
    } catch (err) {
      console.error("Fetch error:", err);
      showToast("Network error loading ride.");
    }
  }

  function renderBooking(b) {
    const s = statusLabel(b.status);
    statusText.textContent = s;

    const live = ["ACCEPTED","ENROUTE","ARRIVED","ONBOARD"].includes((b.status || "").toUpperCase());
    statusDot.classList.toggle("live", live);

    fromText.textContent = b.pickup?.address || "â€”";
    toText.textContent = b.dropoff?.address || "â€”";

    if (Array.isArray(b.stops) && b.stops.length) {
      const list = b.stops.map(s => s.address || "").filter(Boolean).join(" â†’ ");
      stopsText.textContent = list || "None";
    } else {
      stopsText.textContent = "None";
    }

    if (typeof b.pricing?.estimate === "number") {
      estAmount.textContent = `$${b.pricing.estimate.toFixed(2)}`;
    } else {
      estAmount.textContent = "$â€”";
    }

    const when = b.requestedAt ? `Requested: ${fmtTime(b.requestedAt)}` : "Requested: â€”";
    const miles = b.metrics?.miles != null ? `${b.metrics.miles} mi` : "";
    const mins = b.metrics?.minutes != null ? `${b.metrics.minutes} min` : "";
    const tail = [miles, mins].filter(Boolean).join(" â€¢ ");

    metaLine.textContent = tail ? `${when} â€¢ ${tail}` : when;
  }

  function buildSmsBody() {
    const from = fromText.textContent || "";
    const to = toText.textContent || "";
    const est = estAmount.textContent || "";
    const s = statusText.textContent || "";

    const lines = [];
    lines.push("Hey Big Red â€” this is a rider from the My Ride page.");
    if (bookingId) lines.push(`Booking ID: ${bookingId}`);
    lines.push(`Status: ${s}`);
    lines.push(`From: ${from}`);
    lines.push(`To: ${to}`);
    lines.push(`Estimate: ${est}`);
    lines.push("Can you confirm or adjust this ride for me?");
    return encodeURIComponent(lines.join(" "));
  }

  // ==========================
  // OneSignal init (rider)
  // ==========================
  window.OneSignal = window.OneSignal || [];
  OneSignal.push(function() {
    OneSignal.init({
      appId: ONESIGNAL_APP_ID,
      notifyButton: { enable: false },
      allowLocalhostAsSecureOrigin: true
    });

    // Update UI pill based on permission
    OneSignal.isPushNotificationsEnabled(function(enabled) {
      if (enabled) {
        pushPill.textContent = "Notifications: On";
        pushPill.classList.remove("off");
        pushPill.classList.add("ok");
      } else {
        pushPill.textContent = "Notifications: Off";
        pushPill.classList.remove("ok");
        pushPill.classList.add("off");
      }
    });

    // Prompt if not already subscribed
    OneSignal.isPushNotificationsEnabled(function(enabled) {
      if (!enabled) {
        OneSignal.showSlidedownPrompt();
      }
    });

    // Tag as rider + specific booking
    const tags = { role: "rider" };
    if (bookingId) tags.booking_id = bookingId;
    OneSignal.sendTags(tags);
  });

  // ==========================
  // Events
  // ==========================
  document.addEventListener("DOMContentLoaded", () => {
    if (!bookingId) {
      showToast("Missing ride ID in link.");
    } else {
      fetchBooking();
    }

    btnRefresh.addEventListener("click", () => {
      fetchBooking();
      showToast("Refreshing ride statusâ€¦");
    });

    btnTextRed.addEventListener("click", () => {
      const body = buildSmsBody();
      window.location.href = `sms:+14053784024?&body=${body}`;
    });

    // Allow tapping the pill to re-open prompt if off
    pushPill.addEventListener("click", () => {
      OneSignal.isPushNotificationsEnabled(function(enabled) {
        if (!enabled) {
          OneSignal.showSlidedownPrompt();
        } else {
          showToast("Notifications are already on.");
        }
      });
    });
  });
</script>

</body>
</html>