<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Big Red Connect â€” Driver Dispatch (BETA)</title>

  <!-- ðŸ“± PWA Icons (BETA) -->
  <link rel="apple-touch-icon" href="icon.PNG">
  <link rel="icon" type="image/png" sizes="192x192" href="icon.PNG">
  <!-- BETA driver manifest -->
  <link rel="manifest" href="manifest-driver-beta.json">
  <meta name="theme-color" content="#000000">

  <!-- ðŸš« Disable cache (BETA) -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <!-- ðŸ”” OneSignal v16 SDK -->
  <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
  <script>
    window.OneSignalDeferred = window.OneSignalDeferred || [];
    function withOneSignal(fn) {
      OneSignalDeferred.push(fn);
    }
  </script>

  <style>
    :root {
      --red: #b30000;
      --bg: #000;
      --panel: #111;
      --border: #222;
      --muted: #aaa;
      --accent: #ffcc00;
    }

    body {
      margin: 0;
      background: var(--bg);
      color: #fff;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }

    header {
      display:flex;
      justify-content:space-between;
      padding:10px;
      background:#000;
      border-bottom:2px solid var(--red);
      position:sticky;
      top:0;
      z-index:10;
    }

    .logo { height:40px; border-radius:4px; }

    .badge-beta {
      font-size:0.7rem;
      padding:2px 6px;
      border-radius:999px;
      background:#b30000;
      color:#fff;
      display:inline-block;
      margin-top:2px;
    }

    .btn {
      padding:6px 10px;
      border-radius:8px;
      border:none;
      cursor:pointer;
      font-weight:600;
    }

    .btn-primary { background:var(--red); color:#fff; }
    .btn-ghost { background:#111; color:#fff; border:1px solid #444; }
    .btn-notify { background:#111; color:#fff; border:1px solid #555; }

    .grid {
      padding:12px;
      display:grid;
      grid-template-columns:1fr;
      gap:12px;
    }

    @media(min-width:900px){
      .grid{
        grid-template-columns:repeat(3,1fr);
      }
    }

    .column {
      background:#111;
      border:1px solid #222;
      border-radius:10px;
      overflow:hidden;
    }

    .col-header {
      padding:10px;
      border-bottom:1px solid #222;
      font-weight:700;
      text-transform:uppercase;
      font-size:.85rem;
      letter-spacing:.03em;
      display:flex;
      justify-content:space-between;
    }

    .col-body {
      max-height:70vh;
      overflow-y:auto;
      padding:10px;
    }

    .empty-text {
      text-align:center;
      color:#777;
      padding:20px;
      font-size:.85rem;
    }

    .card {
      background:#000;
      border:1px solid #333;
      border-radius:8px;
      padding:10px;
      margin-bottom:10px;
      font-size:.82rem;
    }

    .card-label-row {
      display:flex;
      justify-content:space-between;
      margin-bottom:6px;
    }

    .badge {
      display:inline-block;
      padding:2px 6px;
      border-radius:999px;
      font-size:.7rem;
      border:1px solid #666;
      margin-right:4px;
    }

    .badge-status { border-color:#aaa; }
    .badge-type { border-color:var(--accent); color:var(--accent); }

    .loc-line {
      margin:4px 0;
      font-size:.78rem;
    }

    .card-footer {
      border-top:1px solid #222;
      margin-top:8px;
      padding-top:6px;
      display:flex;
      justify-content:space-between;
    }

    .status-dropdown {
      background:#111;
      color:#fff;
      border:1px solid #333;
      padding:4px;
      border-radius:6px;
    }

    #toast {
      position:fixed;
      bottom:20px;
      left:50%;
      transform:translateX(-50%);
      background:#111;
      border:1px solid var(--red);
      padding:10px 18px;
      border-radius:999px;
      opacity:0;
      pointer-events:none;
      transition:opacity .25s;
      z-index:50;
    }
    #toast.show { opacity:1; }
  </style>
</head>
<body>

<header>
  <div style="display:flex;align-items:center;gap:10px;">
    <a href="beta-index.html"><img src="icon.PNG" class="logo" alt="Big Red Logo" /></a>
    <div>
      <div style="font-weight:700;font-size:.9rem;">Big Red Driver</div>
      <div style="color:#888;font-size:.75rem;">Live Dispatch (BETA)</div>
      <span class="badge-beta">BETA</span>
    </div>
  </div>

  <div style="display:flex;gap:6px;">
    <button class="btn btn-ghost" id="btnRefresh">ðŸ”„ Refresh</button>
    <button class="btn btn-primary" id="btnScope">ðŸ“‹ active</button>
    <button class="btn btn-notify" id="btnNotify">ðŸ”” Alerts: Off</button>
  </div>
</header>

<div class="grid">
  <section class="column">
    <div class="col-header">ðŸ†• New Requests <span id="countNew">0</span></div>
    <div class="col-body" id="listNew"><div class="empty-text">None</div></div>
  </section>

  <section class="column">
    <div class="col-header">ðŸš¦ Active Trips <span id="countActive">0</span></div>
    <div class="col-body" id="listActive"><div class="empty-text">None</div></div>
  </section>

  <section class="column">
    <div class="col-header">âœ… Completed <span id="countDone">0</span></div>
    <div class="col-body" id="listDone"><div class="empty-text">None</div></div>
  </section>
</div>

<div id="toast"></div>

<script>
/* ======================================================
   OneSignal â€” DRIVER BETA
====================================================== */

const notifyBtn = document.querySelector("#btnNotify");

function updateNotifyButton(enabled) {
  notifyBtn.textContent = enabled ? "ðŸ”” Alerts: On" : "ðŸ”” Alerts: Off";
}

function showToast(msg) {
  const toast = document.querySelector("#toast");
  toast.textContent = msg;
  toast.classList.add("show");
  setTimeout(() => toast.classList.remove("show"), 1800);
}

// Init + tag this device as driver_beta
withOneSignal(async function(OneSignal) {
  try {
    await OneSignal.init({
      appId: "9b8bcc89-87d3-46e2-b2d0-042d1a267718",
      safari_web_id: "web.onesignal.auto.0c90051e-4735-447d-b203-75e3767d91b9",
      notifyButton: { enable: false },
      serviceWorkerPath: "/OneSignalSDKWorker.js"
      path: "/"
    });

    await OneSignal.login("driver_beta");
    await OneSignal.sendTag("env", "beta");
    await OneSignal.sendTag("role_driver_beta", "true");

    const status = await OneSignal.Notifications.getPermissionStatus();
    updateNotifyButton(status === "granted");

    console.log("[BETA Driver] OneSignal initialized and tagged.");
  } catch (e) {
    console.warn("[BETA Driver] OneSignal init/login error:", e);
  }
});

// Toggle alerts
notifyBtn.addEventListener("click", () => {
  withOneSignal(async function(OneSignal) {
    try {
      const current = await OneSignal.Notifications.getPermissionStatus();

      if (current === "granted") {
        showToast("Alerts already enabled.");
        updateNotifyButton(true);
        return;
      }

      const result = await OneSignal.Notifications.requestPermission();
      const granted = result === "granted";
      updateNotifyButton(granted);
      showToast(granted ? "Alerts enabled!" : "Permission blocked.");
    } catch (e) {
      console.warn("[BETA Driver] Permission toggle error:", e);
      showToast("Error updating alerts.");
    }
  });
});

/* ======================================================
   API + RENDERING â€” BETA Version
   (Still points at your existing bookings worker)
====================================================== */

const API = "https://bigred-bookings.bigredtransportation.workers.dev";
let scope = "active";

async function fetchBookings() {
  const url = `${API}/api/driver/bookings?scope=${scope}&t=${Date.now()}`;
  try {
    const res = await fetch(url);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    renderAll(data);
  } catch(e) {
    console.error("[BETA Driver] Sync failed:", e);
    showToast("Sync failed");
  }
}

function renderAll(list) {
  const newArr    = list.filter(b => b.status === "REQUESTED");
  const activeArr = list.filter(b => ["ACCEPTED","ENROUTE","ARRIVED"].includes(b.status));
  const doneArr   = list.filter(b => ["COMPLETED","CANCELLED"].includes(b.status));

  renderColumn("listNew", newArr);
  renderColumn("listActive", activeArr);
  renderColumn("listDone", doneArr);

  document.querySelector("#countNew").textContent    = newArr.length;
  document.querySelector("#countActive").textContent = activeArr.length;
  document.querySelector("#countDone").textContent   = doneArr.length;
}

function renderColumn(id, arr) {
  const box = document.getElementById(id);
  box.innerHTML = "";

  if (!arr.length) {
    box.innerHTML = `<div class="empty-text">None</div>`;
    return;
  }

  arr.forEach(b => {
    const div = document.createElement("div");
    div.className = "card";

    const est = b.pricing?.estimate ? `$${b.pricing.estimate.toFixed(2)}` : "--";

    div.innerHTML = `
      <div class="card-label-row">
        <span><strong>${b.type || "Ride"}</strong></span>
        <span class="badge badge-status">${b.status}</span>
      </div>

      <div class="loc-line">FROM: ${b.pickup.address}</div>
      ${
        b.stops && b.stops.length
          ? `<div class="loc-line">STOPS: ${b.stops.map(s=>s.address).join(" â†’ ")}</div>`
          : ""
      }
      <div class="loc-line">TO: ${b.dropoff.address}</div>

      <div style="margin-top:6px;">Est: ${est}</div>

      <div class="card-footer">
        <div>
          <select class="status-dropdown" data-id="${b.id}">
            <option ${b.status==="REQUESTED"?"selected":""}>REQUESTED</option>
            <option ${b.status==="ACCEPTED"?"selected":""}>ACCEPTED</option>
            <option ${b.status==="ENROUTE"?"selected":""}>ENROUTE</option>
            <option ${b.status==="ARRIVED"?"selected":""}>ARRIVED</option>
            <option ${b.status==="COMPLETED"?"selected":""}>COMPLETED</option>
            <option ${b.status==="CANCELLED"?"selected":""}>CANCELLED</option>
          </select>
        </div>
        <div style="font-size:.75rem;color:#bbb;">
          Rider: ${b.rider?.name || "â€”"}
        </div>
      </div>
    `;

    box.appendChild(div);
  });
}

// Handle status changes
document.body.addEventListener("change", async (e) => {
  if (e.target.classList.contains("status-dropdown")) {
    const id = e.target.dataset.id;
    const newState = e.target.value;

    try {
      const res = await fetch(`${API}/api/driver/bookings/${id}`, {
        method:"PUT",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify({ status:newState })
      });

      if(res.ok){
        showToast(`Status â†’ ${newState}`);
        fetchBookings();
      } else {
        showToast("Update failed");
      }
    } catch(err) {
      console.error("[BETA Driver] Update error:", err);
      showToast("Update failed");
    }
  }
});

// Scope toggler
document.querySelector("#btnScope").addEventListener("click", ()=>{
  if(scope==="active"){ scope="upcoming"; showToast("Showing upcoming"); }
  else if(scope==="upcoming"){ scope="all"; showToast("Showing all"); }
  else { scope="active"; showToast("Active only"); }

  document.querySelector("#btnScope").textContent = `ðŸ“‹ ${scope}`;
  fetchBookings();
});

// Manual refresh
document.querySelector("#btnRefresh").addEventListener("click", ()=>{
  fetchBookings();
  showToast("Refreshingâ€¦");
});

// Auto poll every 20s
setInterval(fetchBookings, 20000);
fetchBookings();
</script>

</body>
</html>