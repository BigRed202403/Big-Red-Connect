<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Fare Calculator ‚Äì Big Red Connect</title>

  <!-- üì± PWA / Icons -->
  <link rel="apple-touch-icon" href="icon.PNG">
  <link rel="icon" type="image/png" sizes="192x192" href="icon.png">
  <link rel="shortcut icon" href="icon.PNG">
  <link rel="manifest" href="manifest.json">
  <meta name="apple-mobile-web-app-title" content="Big Red Connect">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="theme-color" content="#000000">

  <!-- No cache -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <link rel="stylesheet" href="style.css" />

  <!-- OneSignal SDK (non-breaking if not used globally) -->
  <script src="https://cdn.onesignal.com/sdks/OneSignalSDK.js" async></script>

  <!-- Google Maps -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCMM0dxLNM7XQI5G3OBSnINeO5hcS3Ks5I&libraries=places,geometry&callback=initGoogle" async defer></script>
</head>

<body>

  <!-- Header -->
  <div class="logo-header">
    <a href="index.html" title="Return to Home">
      <img src="official_logo_Nov.png" alt="Big Red Connect Logo" style="cursor:pointer;" />
    </a>
  </div>

  <!-- Centered Home Button -->
  <div class="top-home-btn" style="text-align:center; margin-top:10px; margin-bottom:10px;">
    <a href="index.html" class="btn secondary">üè† Home</a>
  </div>

  <h1>Fare Calculator</h1>
  <p class="tagline">Plan your next ride connection ‚Äî quick, simple, and local.</p>

  <div id="status-pill" class="status">Checking status‚Ä¶</div>

  <section class="info-section calculator">
    <div class="ride-mode-toggle" aria-label="Choose ride mode">
      <button id="modeNow" class="btn btn-toggle active" type="button">üöó Ride Now</button>
      <button id="modeReserve" class="btn btn-toggle" type="button">üïí Reserve Ride</button>
    </div>

    <div id="reserveControls" style="display:none;">
      <label for="reserveDate">Date</label>
      <input id="reserveDate" type="date" />
      <label for="reserveTime">Time</label>
      <input id="reserveTime" type="time" />
      <label for="planBy">Plan By</label>
      <select id="planBy">
        <option value="pickup">Pickup Time</option>
        <option value="dropoff">Drop-Off Time</option>
      </select>
      <div id="reserveHint" style="color:#ccc;font-size:0.9em;margin:6px 0 10px;">
        Choose a date/time. Rush hour & holiday pricing are based on your scheduled pickup window.
      </div>
    </div>

    <label for="pickup">Pickup Location</label>
    <input id="pickup" type="text" placeholder="Enter pickup address or place" />
    <button id="useLocPickup" class="btn primary" type="button" style="margin-top:8px;">üìç Use My Location for Pickup</button>

    <div id="stopsWrap"></div>
    <button id="addStopBtn" class="btn primary" type="button">‚ûï Add Stop</button>

    <label for="dropoff">Drop-off Location</label>
    <input id="dropoff" type="text" placeholder="Enter drop-off address or place" />
    <button id="useLocDrop" class="btn secondary" type="button" style="margin-top:8px;">üìç Use My Location for Drop-off</button>

    <div id="map" style="height:250px;margin-top:15px;border-radius:10px;"></div>

    <div id="airport-note"></div>
    <div id="event-note"></div>
    <div id="rushhour-note"></div>
    <div id="holiday-note"></div>
    <div id="fairness-note"></div>

    <select id="tripType" style="display:none;">
      <option value="10">Standard ($10 base)</option>
      <option value="15">Rush Hour ($15 base)</option>
      <option value="15_airport">Airport ($15 base)</option>
      <option value="20">Special Event / Holiday ($20 base)</option>
    </select>

    <label for="payment">Payment Method</label>
    <select id="payment">
      <option value="cash">Cash / Venmo / Cash App (no fees)</option>
      <option value="card">Card (+3.3% booking + 2.4% fuel)</option>
    </select>

    <label for="partySize" style="margin-top:10px;">How many riders?</label>
    <select id="partySize">
      <option value="1" selected>1</option>
      <option value="2">2</option>
      <option value="3">3</option>
      <option value="4">4</option>
      <option value="5">5</option>
      <option value="6">6</option>
    </select>

    <button class="btn primary" id="calcBtn" style="display:block;margin:20px auto;">üí≤ Calculate Fare</button>

    <!-- Result area (buttons are injected here after calculation) -->
    <div id="result" style="display:none;"></div>

    <p class="disclaimer">*Estimates only. Final fare may vary slightly based on route or wait time.</p>
  </section>

  <footer>
    <p>&copy; 2025 Big Red Connect ‚Äî <a href="index.html">Return to Home</a></p>
  </footer>

  <script src="status.js"></script>
  <script>
  // ============ BASIC LOG / CONSTANTS ============
  const log = (...a)=>console.log(new Date().toLocaleTimeString(),"[FAIR]",...a);

  const HQ = { lat: 35.3207, lng: -97.4929 };
  const WORKER_URL = "https://location-reader.bigredtransportation.workers.dev"; // ‚úÖ reader endpoint
  const BOOKING_WORKER_URL = "https://bigred-bookings.bigredtransportation.workers.dev"; // üåê bookings API
  const STALE_MINUTES = 60;

  let map, geocoder, directionsService, directionsRenderer;
  let pickupLatLng = null, dropoffLatLng = null, pickupPlace = null, dropPlace = null;
  let driverPos = null, driverSource = "HQ";
  let mode = "now", EVENT_VENUES = null;

  let riderPushId = null;   // OneSignal player id (if available)
  let lastNamePrompt = "";  // cache rider name between actions

  function isValidCoords(o){return o&&typeof o.lat==="number"&&typeof o.lng==="number"&&!isNaN(o.lat)&&!isNaN(o.lng);}
  function distMi(a,b){return google.maps.geometry.spherical.computeDistanceBetween(new google.maps.LatLng(a.lat,a.lng),new google.maps.LatLng(b.lat,b.lng))/1609.34;}
  function weekdayRushHour(d){const day=d.getDay(),h=d.getHours();return day>=1&&day<=5&&((h>=5&&h<9)||(h>=15&&h<19));}

  // Simple US-holiday checker for your special-event/holiday base rate
  function isHolidayDate(d) {
    if (!d || isNaN(d.getTime())) return false;
    const y = d.getFullYear();
    const m = d.getMonth();   // 0‚Äì11
    const day = d.getDate();  // 1‚Äì31

    // Fixed-date: New Year's Day, Independence Day, Christmas, NYE
    if ((m === 0 && day === 1) ||          // Jan 1
        (m === 6 && day === 4) ||          // Jul 4
        (m === 11 && (day === 24 || day === 25 || day === 31))) {  // Dec 24/25/31
      return true;
    }

    // Helper to find Nth weekday of month (0=Sun..6=Sat)
    function nthWeekday(month, weekday, n) {
      const first = new Date(y, month, 1);
      let offset = (weekday - first.getDay() + 7) % 7;
      const date = 1 + offset + (n - 1) * 7;
      return new Date(y, month, date);
    }

    // Helper: last weekday of month
    function lastWeekday(month, weekday) {
      const last = new Date(y, month + 1, 0);
      let offset = (last.getDay() - weekday + 7) % 7;
      return new Date(y, month + 1, last.getDate() - offset);
    }

    // Memorial Day: last Monday in May
    const memorial = lastWeekday(4, 1); // May, Monday
    if (m === 4 && day === memorial.getDate()) return true;

    // Labor Day: first Monday in September
    const labor = nthWeekday(8, 1, 1); // Sep, Monday, 1st
    if (m === 8 && day === labor.getDate()) return true;

    // Thanksgiving: 4th Thursday in November
    const thanks = nthWeekday(10, 4, 4); // Nov, Thu, 4th
    if (m === 10 && day === thanks.getDate()) return true;

    return false;
  }

  // OneSignal: read existing player ID if SDK is already wired
  function setupOneSignalListener() {
    try {
      if (!window.OneSignal || !window.OneSignal.push) return;
      window.OneSignal.push(function() {
        if (!window.OneSignal.getUserId) return;
        window.OneSignal.getUserId(function(userId) {
          if (userId) {
            riderPushId = userId;
            log("OneSignal playerId:", userId);
          }
        });
      });
    } catch (e) {
      log("OneSignal hook error:", e.message);
    }
  }

  // --- Handoff & auto-fill from status page
  document.addEventListener("DOMContentLoaded", async () => {
    setupOneSignalListener();

    try {
      const url = new URL(window.location.href);
      const drop = url.searchParams.get("dropoff");
      if (drop) document.getElementById("dropoff").value = drop;

      const saved = localStorage.getItem("bigred_last_rider");
      if (saved) {
        const { address, lat, lng, timestamp } = JSON.parse(saved);
        const ageMin = (Date.now() - timestamp) / 60000;
        if (ageMin <= 15) {
          const input = document.getElementById("pickup");
          input.value = address ? address : `${lat.toFixed(5)}, ${lng.toFixed(5)}`;
          const msg = document.createElement("div");
          msg.textContent = "‚úÖ Pickup auto-filled from your recent ETA check.";
          msg.style.cssText = "background:#112;color:#9f9;padding:8px;border-radius:6px;font-size:.9em;margin-bottom:10px;text-align:center;";
          input.parentNode.insertBefore(msg, input);
          setTimeout(() => msg.remove(), 6000);
          log("handoff loaded ‚Üí", address || `${lat},${lng}`, "age(min):", Math.round(ageMin));
          // Force geocode of the pickup so fairness fee can run even if user doesn't edit the field
          await ensurePickupLatLngFromCurrentInput();
        }
      }
    } catch (e) { log("handoff load err", e?.message); }
  });

  // Google Maps init (callback from script URL)
  window.initGoogle = async function () {
    geocoder = new google.maps.Geocoder();
    directionsService = new google.maps.DirectionsService();
    directionsRenderer = new google.maps.DirectionsRenderer({ suppressMarkers: true });
    map = new google.maps.Map(document.getElementById("map"), { center: { lat:35.4676, lng:-97.5164 }, zoom: 11 });
    directionsRenderer.setMap(map);

    const acPickup = new google.maps.places.Autocomplete(document.getElementById("pickup"));
    const acDrop   = new google.maps.places.Autocomplete(document.getElementById("dropoff"));

    acPickup.addListener("place_changed", async () => {
      const p = acPickup.getPlace(); if (!p.geometry) return;
      pickupPlace = p; pickupLatLng = p.geometry.location;
      if (window.pickupMarker) window.pickupMarker.setMap(null);
      window.pickupMarker = new google.maps.Marker({ position: pickupLatLng, map, label:"P" });
      map.setCenter(pickupLatLng);
      log("pickup set via autocomplete ‚Üí", p.formatted_address || p.name);
      await maybeShowFairnessNotePreview();
    });

    acDrop.addListener("place_changed", async () => {
      const p = acDrop.getPlace(); if (!p.geometry) return;
      dropPlace = p; dropoffLatLng = p.geometry.location;
      if (window.dropoffMarker) window.dropoffMarker.setMap(null);
      window.dropoffMarker = new google.maps.Marker({ position:dropoffLatLng, map, label:"D" });
      map.panTo(dropoffLatLng);
      log("dropoff set via autocomplete ‚Üí", p.formatted_address || p.name);
    });

    document.getElementById("modeNow").onclick = () => setMode("now");
    document.getElementById("modeReserve").onclick = () => setMode("reserve");
    document.getElementById("calcBtn").onclick = () => { calculateFare().catch(e => log("calc err", e.message)); };
    document.getElementById("addStopBtn").onclick = addStopField;
    document.getElementById("useLocPickup").onclick = () => useMyLocation("pickup");
    document.getElementById("useLocDrop").onclick = () => useMyLocation("dropoff");

    smartRideTypeDefault();
    await getDriverLocation();
    await maybeShowFairnessNotePreview(); // show hint if we already have pickup from handoff
  };

  function setMode(m){
    mode=m;
    const nowBtn=document.getElementById("modeNow"),
          resBtn=document.getElementById("modeReserve"),
          ctr=document.getElementById("reserveControls");
    if(m==="now"){
      nowBtn.classList.add("active");
      resBtn.classList.remove("active");
      ctr.style.display="none";
      smartRideTypeDefault();
    } else {
      resBtn.classList.add("active");
      nowBtn.classList.remove("active");
      ctr.style.display="block";
    }
  }

  function smartRideTypeDefault(){
    const now=new Date();
    if(weekdayRushHour(now)){
      setTripType("15");
      document.getElementById("rushhour-note").innerHTML="üö¶ Weekday Rush Hour pricing (5‚Äì9 AM / 3‚Äì7 PM)";
    }else{
      if(document.getElementById("tripType").value!=="15_airport"&&document.getElementById("tripType").value!=="20"){
        setTripType("10");
      }
      document.getElementById("rushhour-note").innerHTML="";
    }
    document.getElementById("holiday-note").innerHTML = "";
  }
  function setTripType(v){ document.getElementById("tripType").value=v; }

  async function getDriverLocation(){
    try{
      const r = await fetch(WORKER_URL+"?n="+Date.now(),{cache:"no-store"});
      const j = await r.json();
      const lat = parseFloat(j.latitude), lng = parseFloat(j.longitude);
      const t = j.timestamp ? new Date(j.timestamp) : null;
      const age = t ? (Date.now()-t.getTime())/60000 : 999;
      if (!isNaN(lat) && !isNaN(lng) && age <= STALE_MINUTES){
        driverPos = {lat,lng}; driverSource="live";
      } else {
        driverPos = HQ; driverSource="HQ";
      }
    }catch{
      driverPos = HQ; driverSource="HQ";
    }
    log("driver source:", driverSource, "‚Üí", driverPos);
  }

  async function ensurePickupLatLngFromCurrentInput(){
    const val = document.getElementById("pickup").value.trim();
    if (!val) return;
    return new Promise((resolve) => {
      geocoder.geocode({ address: val }, (res, s) => {
        if (s === "OK" && res?.[0]) {
          pickupLatLng = res[0].geometry.location;
          if (window.pickupMarker) window.pickupMarker.setMap(null);
          window.pickupMarker = new google.maps.Marker({ position: pickupLatLng, map, label:"P" });
          log("pickup geocoded from input ‚Üí", val);
        } else {
          log("pickup geocode failed for input ‚Üí", val);
        }
        resolve();
      });
    });
  }

  function addStopField(){
    if ((window.stopInputs||[]).length>=3){alert("Limit 3 stops.");return;}
    if(!window.stopInputs) window.stopInputs=[];
    const id=`stop_${Date.now()}`; window.stopInputs.push(id);
    const wrap=document.getElementById("stopsWrap");
    const div=document.createElement("div");
    div.className="stop-row"; div.id=`row_${id}`;
    div.innerHTML=`<label for="${id}">Stop ${window.stopInputs.length}</label>
    <div style="display:flex;gap:6px;align-items:center;"><input id="${id}" type="text" placeholder="Enter stop address or place" style="flex:1;">
    <button type="button" class="remove-stop" onclick="removeStop('${id}')">‚úñ</button></div>`;
    wrap.appendChild(div);
    new google.maps.places.Autocomplete(document.getElementById(id));
  }
  function removeStop(id){
    document.getElementById(`row_${id}`)?.remove();
    window.stopInputs=(window.stopInputs||[]).filter(s=>s!==id);
    document.querySelectorAll("#stopsWrap label").forEach((l,i)=>l.textContent=`Stop ${i+1}`);
  }

  async function useMyLocation(id){
    if(!navigator.geolocation){alert("Location not supported.");return;}
    navigator.geolocation.getCurrentPosition(async (p)=>{
      const latlng={lat:p.coords.latitude,lng:p.coords.longitude};
      const addr=await new Promise(r=>geocoder.geocode({location:latlng},(res,s)=>r(s==="OK"&&res[0]?res[0].formatted_address:`${latlng.lat},${latlng.lng}`)));
      document.getElementById(id).value = addr;
      if(id==="pickup"){
        pickupLatLng=new google.maps.LatLng(latlng.lat,latlng.lng);
        if(window.pickupMarker) window.pickupMarker.setMap(null);
        window.pickupMarker=new google.maps.Marker({position:pickupLatLng,map,label:"P"});
        log("pickup set via GPS ‚Üí", addr);
        await maybeShowFairnessNotePreview();
      }else{
        dropoffLatLng=new google.maps.LatLng(latlng.lat,latlng.lng);
        if(window.dropoffMarker) window.dropoffMarker.setMap(null);
        window.dropoffMarker=new google.maps.Marker({position:dropoffLatLng,map,label:"D"});
        log("dropoff set via GPS ‚Üí", addr);
      }
    });
  }

  // üîß Refined fairness thresholds (driver reference ‚Üí pickup):
  //   <=20 mi: $0   |  >20‚Äì40 mi: $10   |   >40 mi: $20
  function calcFairnessFee(ref, pLL){
    if(!pLL || !ref) return 0;
    const d = distMi(ref, {lat:pLL.lat(), lng:pLL.lng()});
    let fee = 0;
    if (d > 40) fee = 20;
    else if (d > 20) fee = 10;
    log(`driver‚Üípickup ${d.toFixed(1)} mi ‚Üí fairness $${fee}`);
    return fee;
  }

  async function maybeShowFairnessNotePreview(){
    if(!pickupLatLng){ document.getElementById("fairness-note").innerHTML=""; return; }
    await getDriverLocation();
    const ref = isValidCoords(driverPos)? driverPos : HQ;
    const d = distMi(ref, {lat:pickupLatLng.lat(), lng:pickupLatLng.lng()});
    let msg="";
    if (d > 40) msg = "A travel fairness fee may apply ($20 zone).";
    else if (d > 20) msg = "A small travel fairness fee may apply ($10 zone).";
    document.getElementById("fairness-note").innerHTML = msg || "";
  }

  function getEffectiveDateTimeForPricing(currentMode) {
    if (currentMode === "reserve") {
      const dStr = document.getElementById("reserveDate").value;
      const tStr = document.getElementById("reserveTime").value;
      if (dStr && tStr) {
        const partsD = dStr.split("-");
        const partsT = tStr.split(":");
        if (partsD.length === 3 && partsT.length === 2) {
          const y = Number(partsD[0]);
          const m = Number(partsD[1]);
          const day = Number(partsD[2]);
          const hh = Number(partsT[0]);
          const mm = Number(partsT[1]);
          if (!isNaN(y) && !isNaN(m) && !isNaN(day) && !isNaN(hh) && !isNaN(mm)) {
            return new Date(y, m - 1, day, hh, mm, 0);
          }
        }
      }
    }
    // Fallback: now
    return new Date();
  }

  async function calculateFare(){
    const pickup=document.getElementById("pickup").value.trim(),
          dropoff=document.getElementById("dropoff").value.trim();
    if(!pickup||!dropoff){ alert("Please enter both pickup and drop-off."); return; }

    // Ensure pickupLatLng exists even when pickup came from handoff text
    if (!pickupLatLng) { await ensurePickupLatLngFromCurrentInput(); }

    await getDriverLocation();
    const ref = isValidCoords(driverPos)? driverPos : HQ;

    // Build waypoints from stops
    const stops=[];
    for(const id of window.stopInputs||[]){
      const v=document.getElementById(id)?.value.trim();
      if(v) stops.push({location:v,stopover:true});
    }

    const route=await new Promise((res,rej)=>directionsService.route(
      {origin:pickup,destination:dropoff,waypoints:stops,travelMode:"DRIVING"},
      (r,s)=>s==="OK"?res(r):rej(s)
    ));

    directionsRenderer.setDirections(route);
    const legs=route.routes[0].legs;
    const rawMiles=legs.reduce((m,l)=>m+(l.distance?.value||0),0)/1609.34;
    const miles=Math.round(rawMiles);
    const duration=legs.reduce((t,l)=>t+(l.duration?.value||0),0)/60;

    // Priority base logic (uses reservation time if reserve mode)
    const combo=((pickupPlace?.name||"")+(pickupPlace?.formatted_address||"")+(dropPlace?.name||"")+(dropPlace?.formatted_address||"")).toLowerCase();
    const isAirport=(combo.includes("airport") && !combo.includes("tinker"));

    const pricingClock = getEffectiveDateTimeForPricing(mode);
    const holiday = isHolidayDate(pricingClock);

    let base;
    if (holiday) {
      base = 20;  // Holiday / special-event base
    } else if (isAirport) {
      base = 15;  // Airport base
    } else if (weekdayRushHour(pricingClock)) {
      base = 15;  // Rush-hour base
      document.getElementById("rushhour-note").innerHTML = "üö¶ Rush hour window based on your scheduled time.";
    } else {
      base = 10;  // Standard
      document.getElementById("rushhour-note").innerHTML = "";
    }

    document.getElementById("holiday-note").innerHTML = holiday
      ? "üéâ Holiday / special-event base rate applied."
      : "";

    // Event area check (best-effort overlay: bumps to $20 if within special zone)
    try{
      if (!EVENT_VENUES) {
        const r=await fetch("event-venues.json",{cache:"no-store"});
        EVENT_VENUES=await r.json();
      }
      const inRad=(pt,c,r)=>distMi(c,pt)<=r;
      let inside=null;
      if(pickupLatLng){
        const p={lat:pickupLatLng.lat(),lng:pickupLatLng.lng()};
        for(const v of (EVENT_VENUES.venues||[])){ if(inRad(p,{lat:v.lat,lng:v.lng},v.radius_mi)){inside=v;break;} }
      }
      if(!inside && dropoffLatLng){
        const d={lat:dropoffLatLng.lat(),lng:dropoffLatLng.lng()};
        for(const v of (EVENT_VENUES.venues||[])){ if(inRad(d,{lat:v.lat,lng:v.lng},v.radius_mi)){inside=v;break;} }
      }
      if(inside){ base = 20; log("event zone ‚Üí", inside.name); }
    }catch(_){/* ignore */ }

    // Mileage tiers
    const tier2=Math.max(0,Math.min(10,miles-10))*1.25;
    const tier3=Math.max(0,miles-20)*1.0;
    const milesSub=tier2+tier3;

    // Fairness fee (driver‚Üípickup)
    const fair=calcFairnessFee(ref, pickupLatLng);

    let fare=base+milesSub+fair;
    const pay=document.getElementById("payment").value;
    if(pay==="card") fare += fare*0.033 + fare*0.024;

    const total=fare.toFixed(2);
    log(`fare breakdown ‚Üí base:$${base.toFixed(2)} miles:$${milesSub.toFixed(2)} fairness:$${fair.toFixed(2)} pay:${pay} total:$${total}`);

    const partySizeVal = parseInt(document.getElementById("partySize").value, 10) || 1;

    // üîπ Save last quote details for booking / reservation submission
    window.lastQuote = {
      mode,
      pickup,
      dropoff,
      stops: (window.stopInputs || []).map(id => {
        const v = document.getElementById(id)?.value.trim();
        return v ? v : null;
      }).filter(Boolean),
      miles,
      minutes: Math.round(duration),
      base,
      mileageComponent: milesSub,
      fairnessFee: fair,
      payMethod: pay,
      total: parseFloat(total),
      isAirport,
      isHoliday: holiday,
      reserveDate: document.getElementById("reserveDate")?.value || null,
      reserveTime: document.getElementById("reserveTime")?.value || null,
      planBy: document.getElementById("planBy")?.value || "pickup",
      pricingTimeIso: pricingClock.toISOString(),
      partySize: partySizeVal,
      riderName: lastNamePrompt || ""
    };

    const resDiv=document.getElementById("result");
    resDiv.innerHTML = `
      <div class="total">$${total}</div>
      <p><strong>Base:</strong> $${base.toFixed(2)}</p>
      <p><strong>Mileage:</strong> $${milesSub.toFixed(2)}</p>
      ${fair>0 ? `<p><strong>Travel Fairness Fee:</strong> $${fair.toFixed(2)}</p>` : ""}
      <p><strong>Payment:</strong> ${pay==="card" ? "Card (incl. fees)" : "Cash / Venmo / Cash App"}</p>
      <p>üìè ${miles} mi  ‚è±Ô∏è ${Math.round(duration)} min</p>
      <p>üë• Party size: ${partySizeVal}</p>

      <p style="text-align:center;margin-top:15px;">
        <button class="btn primary" id="sendUnifiedBtn">
          ${mode === "reserve"
            ? "üïí Send My Reservation Request"
            : "üöó Send My Ride Request"}
        </button>
      </p>

      <p style="text-align:center;margin-top:6px;font-size:0.9em;color:#aaa;">
        Having trouble or prefer text?
        <a href="#" id="smsFallbackLink" style="color:#fff;text-decoration:underline;">
          Tap here to text RED instead.
        </a>
      </p>

      <p style="text-align:center;color:#888;margin-top:10px;">
        No surprises. Just solid local moves.
      </p>
    `;
    resDiv.style.display="block";
  }

  // =====================================================
  //  BOOKING SUBMISSION ‚Üí Big Red Bookings Worker
  // =====================================================

  function buildScheduledFor(quote) {
    if (quote.mode !== "reserve") return null;
    if (!quote.reserveDate || !quote.reserveTime) return null;

    const partsDate = quote.reserveDate.split("-");
    const partsTime = quote.reserveTime.split(":");
    if (partsDate.length !== 3 || partsTime.length !== 2) return null;

    const year = Number(partsDate[0]);
    const month = Number(partsDate[1]);
    const day = Number(partsDate[2]);
    const h = Number(partsTime[0]);
    const m = Number(partsTime[1]);

    if (!year || !month || !day || isNaN(h) || isNaN(m)) return null;

    const dt = new Date(year, month - 1, day, h, m, 0);
    return dt.toISOString();
  }

  function buildBookingPayload() {
    if (!window.lastQuote) {
      alert("Please calculate a fare first.");
      return null;
    }
    const q = window.lastQuote;
    const scheduledFor = buildScheduledFor(q);

    // Use the same pricing time that was used for the estimate
    const whenForRate = q.pricingTimeIso ? new Date(q.pricingTimeIso) : new Date();

    const ratePlan = q.isAirport
      ? "AIRPORT"
      : (q.isHoliday
          ? "HOLIDAY"
          : (weekdayRushHour(whenForRate) ? "RUSH_HOUR" : "STANDARD"));

    const booking = {
      type: q.mode === "reserve" || scheduledFor ? "RESERVATION" : "INSTANT",
      pickup: {
        address: q.pickup,
        notes: ""
      },
      dropoff: {
        address: q.dropoff,
        notes: ""
      },
      stops: q.stops.map(addr => ({ address: addr })),

      rider: {
        name: q.riderName || "",
        phone: "",
        partySize: q.partySize || 1
      },

      pricing: {
        estimate: q.total,
        finalFare: null,
        travelFee: q.fairnessFee,
        ratePlan
      },

      metrics: {
        miles: q.miles,
        minutes: q.minutes
      },

      source: "FARE_CALCULATOR",
      scheduledFor,
      pushPlayerId: riderPushId || null
    };

    return booking;
  }

  async function submitBooking() {
    if (!window.lastQuote) {
      alert("Please calculate a fare first.");
      return;
    }

    // Prompt for name once; reuse for both booking + SMS
    if (!window.lastQuote.riderName) {
      const nm = prompt("Enter your name for Big Red (optional):", lastNamePrompt || "");
      if (nm !== null) {
        lastNamePrompt = nm.trim();
        window.lastQuote.riderName = lastNamePrompt;
      }
    }

    const booking = buildBookingPayload();
    if (!booking) return;

    try {
      const res = await fetch(BOOKING_WORKER_URL + "/api/bookings", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify(booking)
      });

      if (!res.ok) {
        const txt = await res.text();
        console.error("Booking error:", txt);
        alert("Hmm, something went wrong sending your request. Please text RED instead.");
        return;
      }

      const created = await res.json();
      console.log("Booking created:", created);

      alert(
        booking.type === "RESERVATION"
          ? "Reservation request sent to Big Red! You‚Äôll get a confirmation by text."
          : "Ride request sent to Big Red! If I‚Äôm available, I‚Äôll confirm by text."
      );

      // Send them to their My Ride page
      if (created.id) {
        window.location.href = `https://bigred202403.github.io/myride.html?id=${encodeURIComponent(created.id)}`;
      }
    } catch (err) {
      console.error("Booking network error:", err);
      alert("Network error sending your request. Please text RED instead.");
    }
  }

  function buildSmsBodyFromLastQuote() {
    if (!window.lastQuote) {
      return encodeURIComponent("Hey Big Red ‚Äî I had trouble submitting the form, can you help me plan a ride?");
    }
    const q = window.lastQuote;
    const lines = [];

    const nm = q.riderName && q.riderName.trim().length ? q.riderName.trim() : "a rider";
    lines.push(`Hey Big Red ‚Äî this is ${nm}.`);
    lines.push(`Can you help me confirm this ${q.mode === "reserve" ? "reservation" : "ride"}?`);
    lines.push(`Estimate: $${q.total.toFixed(2)}`);
    lines.push(`From: ${q.pickup}`);
    if (q.stops && q.stops.length) {
      lines.push(`Stops: ${q.stops.join(" ‚Üí ")}`);
    }
    lines.push(`To: ${q.dropoff}`);
    lines.push(`Distance: ${q.miles} mi`);
    lines.push(`Time: ${q.minutes} min`);
    lines.push(`Party size: ${q.partySize || 1}`);
    if (q.fairnessFee > 0) {
      lines.push(`Includes travel fairness fee: $${q.fairnessFee.toFixed(2)}.`);
    }
    if (q.isAirport) {
      lines.push("(Airport base applied)");
    }
    if (q.isHoliday) {
      lines.push("(Holiday / special-event base applied)");
    }
    if (q.mode === "reserve" && q.reserveDate && q.reserveTime) {
      lines.push(`Requested for: ${q.reserveDate} at ${q.reserveTime} (${q.planBy === "dropoff" ? "drop-off time" : "pickup time"}).`);
    }
    lines.push("No surprises. Just solid local moves.");

    return encodeURIComponent(lines.join(" "));
  }

  // Attach handlers for dynamic primary button + SMS fallback
  document.addEventListener("click", (e) => {
    const target = e.target;

    if (target && target.id === "sendUnifiedBtn") {
      e.preventDefault();
      submitBooking();
    }

    if (target && target.id === "smsFallbackLink") {
      e.preventDefault();

      // Name prompt before SMS, same as you requested
      if (!window.lastQuote) {
        window.lastQuote = { riderName: "" };
      }
      if (!window.lastQuote.riderName) {
        const nm = prompt("Enter your name for Big Red (optional):", lastNamePrompt || "");
        if (nm !== null) {
          lastNamePrompt = nm.trim();
          window.lastQuote.riderName = lastNamePrompt;
        }
      }

      const body = buildSmsBodyFromLastQuote();
      window.location.href = `sms:+14053784024?&body=${body}`;
    }
  });
  </script>
</body>
</html>