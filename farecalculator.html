<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Fare Calculator ‚Äì Big Red Connect</title>
  <style>
    body {background:#000;color:#fff;font-family:'Segoe UI',Roboto,Helvetica,Arial,sans-serif;
          margin:0;padding:20px;max-width:640px;margin:auto;text-align:center;}
    .logo{margin:28px 0 16px;}
    h1{color:#c40000;font-size:1.9em;margin:0 0 10px;}
    p.lead{color:#bbb;margin:0 0 18px;}
    label{display:block;text-align:left;margin:14px 0 6px;color:#ccc;}
    input,select{width:100%;padding:12px;border-radius:8px;border:1px solid #333;background:#111;color:#fff;}
    .btn{background:#c40000;color:#fff;border:none;padding:12px 22px;border-radius:10px;
         margin-top:16px;font-weight:700;font-size:1.05em;box-shadow:0 3px 6px rgba(255,0,0,.3);
         cursor:pointer;transition:.15s;}
    .btn:hover{background:#990000;transform:scale(1.03);}
    #map{height:250px;width:100%;border:2px solid #c40000;border-radius:10px;margin-top:15px;}
    #result{background:#111;border:1px solid #c40000;border-radius:12px;padding:18px;margin-top:22px;text-align:left;}
    #result .total{font-size:1.6em;color:#ff4444;font-weight:800;text-align:center;margin:0 0 8px;}
    #result p{margin:6px 0;}
    #fairness-note{color:#999;font-size:0.95em;font-style:italic;margin-top:8px;text-align:left;}
    .disclaimer{font-size:.9em;color:#999;margin:16px 0 28px;font-style:italic;}
    footer{margin:28px 0 36px;color:#666;font-size:.9em;}
    footer a{color:#aaa;text-decoration:none;}
    footer a:hover{text-decoration:underline;color:#fff;}
  </style>
</head>
<body>
  <div class="logo">
    <img src="148D1A08-D537-4A0C-B141-2336DBF68A15.png" alt="Big Red Connect" width="260">
  </div>

  <h1>Big Red Connect Fare Calculator</h1>
  <p class="lead">Type an address or business (e.g. <em>Campus Corner</em>, <em>Riverwind Casino</em>) ‚Äî or tap the pin to use your current location.</p>

  <label for="pickup">Pickup Location:</label>
  <input id="pickup" type="text" placeholder="Enter pickup address or place">

  <label for="dropoff">Drop-off Location:</label>
  <input id="dropoff" type="text" placeholder="Enter drop-off address or place">

  <div style="display:flex;gap:10px;margin-top:12px;">
    <button id="useLocPickup" class="btn" type="button">üìç Use My Location for Pickup</button>
    <button id="useLocDrop" class="btn" type="button">üìç Use My Location for Drop-off</button>
  </div>

  <div id="map"></div>
  <div id="fairness-note"></div>

  <label for="tripType">Ride Type:</label>
  <select id="tripType">
    <option value="10">Standard ($10 base)</option>
    <option value="15">Rush Hour ($15 base)</option>
    <option value="15_airport">Airport ($15 base)</option>
    <option value="20">Special Event ($20 base)</option>
  </select>

  <label for="payment">Payment Method:</label>
  <select id="payment">
    <option value="cash">Cash / Venmo / Cash App (no fees)</option>
    <option value="card">Card (+3.3% booking + 2.4% fuel)</option>
  </select>

  <button class="btn" id="calcBtn">üí≤ Calculate Fare</button>
  <div id="result" style="display:none;"></div>

  <div class="disclaimer">*Estimates only. Final fare may vary slightly based on route, wait time, or negotiated pricing.</div>

  <footer>
    &copy; 2025 Big Red Connect ‚Äî <a href="index.html">Return to Main Page</a>
  </footer>

  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCMM0dxLNM7XQI5G3OBSnINeO5hcS3Ks5I&libraries=places,geometry&callback=initGoogle" async defer></script>

  <script>
  /* CONFIG */
  const HQ = { lat:35.2902, lng:-97.5289 };
  const WORKER_URL = "https://falling-night-3e4d.bigredtransportation.workers.dev";

  const ZONE1=["oklahoma city","moore","norman","midwest city","del city"];
  const ZONE2=["edmond","yukon","mustang","newcastle","tuttle","choctaw","harrah","jones","luther","far east norman","east norman"];
  const ZONE3=["shawnee","tecumseh","guthrie","blanchard","wellston","seminole","chickasha","goldsby","lexington","noble"];

  let map,geocoder,directionsService,directionsRenderer;
  let pickupLatLng=null,dropoffLatLng=null,pickupPlace=null,dropPlace=null;
  let pickupCity="",driverPos=null,driverCity="";

  async function initGoogle(){
    geocoder=new google.maps.Geocoder();
    directionsService=new google.maps.DirectionsService();
    directionsRenderer=new google.maps.DirectionsRenderer({suppressMarkers:true});
    map=new google.maps.Map(document.getElementById('map'),{
      center:{lat:35.4676,lng:-97.5164},zoom:11,mapTypeControl:false,streetViewControl:false});
    directionsRenderer.setMap(map);

    const acPickup=new google.maps.places.Autocomplete(document.getElementById('pickup'));
    const acDrop=new google.maps.places.Autocomplete(document.getElementById('dropoff'));

    acPickup.addListener('place_changed',async()=>{
      const p=acPickup.getPlace();if(!p.geometry)return;
      pickupPlace=p;pickupLatLng=p.geometry.location;
      map.setCenter(pickupLatLng);map.setZoom(12);
      pickupCity=extractCityFromPlace(p)||await reverseCity(pickupLatLng);
      await computeFairnessNote();
    });

    acDrop.addListener('place_changed',async()=>{
      const p=acDrop.getPlace();if(!p.geometry)return;
      dropPlace=p;dropoffLatLng=p.geometry.location;
      map.panTo(dropoffLatLng);detectAirportAndSetType();
    });

    document.getElementById('useLocPickup').addEventListener('click',()=>useMyLocationToField('pickup'));
    document.getElementById('useLocDrop').addEventListener('click',()=>useMyLocationToField('dropoff'));
    document.getElementById('calcBtn').addEventListener('click',calculateFare);
    smartRideTypeDefault();
    await getDriverLocation();
    if(driverPos){driverCity=await reverseCity(driverPos);}
  }

  function extractCityFromPlace(place){
    const comps=place.address_components||[];
    const city=comps.find(c=>c.types.includes("locality")||c.types.includes("postal_town")||c.types.includes("administrative_area_level_3"));
    return city?city.long_name:"";
  }

  function reverseCity(latlng){
    return new Promise(res=>{
      geocoder.geocode({location:latlng},(results,status)=>{
        if(status==='OK'&&results&&results[0]){
          const comps=results[0].address_components||[];
          const city=comps.find(c=>c.types.includes("locality")||c.types.includes("postal_town")||c.types.includes("administrative_area_level_3"));
          res(city?city.long_name:"");
        }else res("");
      });
    });
  }

  async function getDriverLocation(){
    try{
      const r=await fetch(WORKER_URL,{cache:"no-store"});
      const data=await r.json();
      if(data&&data.latitude&&data.longitude){driverPos={lat:+data.latitude,lng:+data.longitude};}
      else driverPos=null;
    }catch{driverPos=null;}
  }

  function distanceMiles(a,b){
    const meters=google.maps.geometry.spherical.computeDistanceBetween(
      new google.maps.LatLng(a.lat,a.lng),new google.maps.LatLng(b.lat,b.lng));
    return meters/1609.34;
  }
  function distanceFee(mi){if(mi<=15)return 0;if(mi<=30)return 10;return 20;}
  function capitalize(s){return(!s||!s.length)?s:s.charAt(0).toUpperCase()+s.slice(1);}

  async function computeFairnessNote(){
    if(!pickupLatLng){document.getElementById('fairness-note').innerText="";return 0;}
    const pCity=(pickupCity||"").toLowerCase().trim();
    const dCity=(driverCity||"").toLowerCase().trim();
    const driverRef=driverPos||HQ;
    let fee=0,path="",source=driverPos?"Live Location":"HQ Fallback";
    const inZ1=ZONE1.includes(pCity),inZ2=ZONE2.includes(pCity),inZ3=ZONE3.includes(pCity);

    if(inZ1){
      if(driverPos&&!ZONE1.includes(dCity)){
        const mi=distanceMiles(driverRef,{lat:pickupLatLng.lat(),lng:pickupLatLng.lng()});
        fee=distanceFee(mi);path=`Pickup in Zone 1 (${capitalize(pCity)}), but you are outside Zone 1 ‚Äî ${mi.toFixed(1)} mi ‚Üí $${fee} fairness fee.`;
      }else{fee=0;path=`Pickup in Zone 1 (${capitalize(pCity)}) ‚Äî no fairness fee.`;}
    }else if(inZ2){
      if(driverPos&&ZONE2.includes(dCity)){fee=0;path=`Pickup in Zone 2 (${capitalize(pCity)}), and you‚Äôre already in Zone 2 ‚Äî no fairness fee.`;}
      else{fee=10;path=`Pickup in Zone 2 (${capitalize(pCity)}) ‚Äî $10 fairness fee.`;}
    }else if(inZ3){
      if(driverPos&&ZONE3.includes(dCity)){fee=0;path=`Pickup in Zone 3 (${capitalize(pCity)}), and you‚Äôre already in Zone 3 ‚Äî no fairness fee.`;}
      else{fee=20;path=`Pickup in Zone 3 (${capitalize(pCity)}) ‚Äî $20 fairness fee.`;}
    }else{
      const mi=distanceMiles(driverRef,{lat:pickupLatLng.lat(),lng:pickupLatLng.lng()});
      fee=distanceFee(mi);
      path=`Pickup city unrecognized ‚Äî ${mi.toFixed(1)} mi from your ${driverPos?'current location':'HQ'} ‚Üí $${fee} fairness fee.`;
    }
    document.getElementById('fairness-note').innerHTML=`${path}<br><span style="color:#777;font-size:0.85em;">Source: ${source}</span>`;
    return fee;
  }

  async function useMyLocationToField(fieldId){
    if(!navigator.geolocation){alert("Location not supported.");return;}
    navigator.geolocation.getCurrentPosition(async(pos)=>{
      const latlng={lat:pos.coords.latitude,lng:pos.coords.longitude};
      const addr=await new Promise(res=>{
        geocoder.geocode({location:latlng},(results,status)=>{
          res((status==='OK'&&results&&results[0])?results[0].formatted_address:`${latlng.lat.toFixed(6)},${latlng.lng.toFixed(6)}`);
        });
      });
      document.getElementById(fieldId).value=addr;
      if(fieldId==='pickup'){
        pickupLatLng=new google.maps.LatLng(latlng.lat,latlng.lng);
        pickupCity=await reverseCity(latlng);
        map.setCenter(pickupLatLng);map.setZoom(12);
        await computeFairnessNote();
      }else{
        dropoffLatLng=new google.maps.LatLng(latlng.lat,latlng.lng);
        map.panTo(dropoffLatLng);
      }
    },()=>alert("Could not get location."));
  }

  async function calculateFare(){
    const pickup=document.getElementById('pickup').value.trim();
    const dropoff=document.getElementById('dropoff').value.trim();
    if(!pickup||!dropoff){alert('Please enter both pickup and drop-off.');return;}
    const fairnessFee=await computeFairnessNote();
    try{
      const route=await new Promise((res,rej)=>{
        directionsService.route({origin:pickup,destination:dropoff,travelMode:google.maps.TravelMode.DRIVING,optimizeWaypoints:false},
          (r,s)=>{if(s==='OK'&&r&&r.routes[0]){directionsRenderer.setDirections(r);res(r);}else rej(s);});
      });
      const miles=route.routes[0].legs.reduce((m,leg)=>m+(leg.distance?.value||0),0)/1609.34;
      smartRideTypeDefault();detectAirportAndSetType();
      const tripVal=document.getElementById('tripType').value;
      const base=(tripVal==="15_airport")?15:parseFloat(tripVal);
      let fare=base;
      if(miles>10&&miles<=20)fare+=(miles-10)*1.25;
      else if(miles>20)fare+=(10*1.25)+((miles-20)*1.0);
      fare+=fairnessFee;
      const payment=document.getElementById('payment').value;
      if(payment==='card'){fare+=fare*0.033+fare*0.024;}
      const total=fare.toFixed(2);
      const payLabel=(payment==='card')?'Card (includes fees)':'Cash / Venmo / Cash App';
      const r=document.getElementById('result');
      r.innerHTML=`<div class="total">$${total}</div>
        <p><strong>Distance:</strong> ${miles.toFixed(1)} mi</p>
        <p><strong>Ride Type:</strong> $${base.toFixed(2)} base</p>
        <p><strong>Travel Fairness Fee:</strong> $${fairnessFee.toFixed(2)}</p>
        <p><strong>Payment:</strong> ${payLabel}</p>`;
      r.style.display='block';
    }catch(e){alert('Could not calculate route.');console.error(e);}
  }

  function smartRideTypeDefault(){
    let val="10";const d=new Date();const day=d.getDay();const h=d.getHours();
    if(day>=1&&day<=5&&((h>=5&&h<10)||(h>=16&&h<19)))val="15";
    document.getElementById("tripType").value=val;
  }

  function detectAirportAndSetType(){
    const fields=[pickupPlace,dropPlace];
    const txts=fields.filter(Boolean).map(p=>(p.formatted_address||"").toLowerCase()).join(" ");
    const include=["airport","airfield","air park","airpark","intl","international","regional","municipal","hangar","jet center","heliport"];
    const exclude=["tinker","afb","air force","base","ang"];
    const inc=include.some(k=>txts.includes(k));const exc=exclude.some(k=>txts.includes(k));
    if(inc&&!exc)document.getElementById("tripType").value="15_airport";
  }

  document.addEventListener("DOMContentLoaded",smartRideTypeDefault);
  window.initGoogle=initGoogle;
  </script>
</body>
</html>
