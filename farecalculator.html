<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Fare Calculator â€“ Big Red Connect</title>

<!-- Icons -->
<link rel="apple-touch-icon" href="icon.png">
<link rel="icon" type="image/png" sizes="192x192" href="icon.png">
<link rel="shortcut icon" href="icon.png">
<link rel="manifest" href="manifest.json">

<!-- Disable cache -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />

<link rel="stylesheet" href="style.css" />

<!-- Google Maps -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCMM0dxLNM7XQI5G3OBSnINeO5hcS3Ks5I&libraries=places,geometry&callback=initGoogle" async defer></script>

<!-- OneSignal -->
<script src="https://cdn.onesignal.com/sdks/OneSignalSDK.js" async></script>

<style>
  /* Quick fix for the top spacing */
  .notifyMsg { color:#ccc; font-size:0.8rem; text-align:center; }
</style>
</head>

<body>

<!-- Header -->
<div class="logo-header">
  <a href="index.html"><img src="official_logo_Nov.png" alt="Big Red Connect Logo"></a>
</div>

<div class="top-home-btn" style="text-align:center; margin-top:10px;">
  <a href="index.html" class="btn secondary">ğŸ  Home</a>
</div>

<h1>Fare Calculator</h1>
<p class="tagline">Plan your next ride connection â€” quick, simple, and local.</p>

<div id="status-pill" class="status">Checking statusâ€¦</div>

<section class="info-section calculator">
  <!-- Mode -->
  <div class="ride-mode-toggle">
    <button id="modeNow" class="btn btn-toggle active">ğŸš— Ride Now</button>
    <button id="modeReserve" class="btn btn-toggle">ğŸ•’ Reserve Ride</button>
  </div>

  <div id="reserveControls" style="display:none;">
    <label>Date</label>
    <input id="reserveDate" type="date">

    <label>Time</label>
    <input id="reserveTime" type="time">

    <label>Plan By</label>
    <select id="planBy">
      <option value="pickup">Pickup Time</option>
      <option value="dropoff">Drop-Off Time</option>
    </select>
  </div>

  <!-- Pickup -->
  <label>Pickup Location</label>
  <input id="pickup" type="text" placeholder="Enter pickup address or place">
  <button id="useLocPickup" class="btn primary" type="button" style="margin-top:8px;">
    ğŸ“ Use My Location for Pickup
  </button>

  <!-- Stops -->
  <div id="stopsWrap"></div>
  <button id="addStopBtn" class="btn primary">â• Add Stop</button>

  <!-- Dropoff -->
  <label>Drop-off Location</label>
  <input id="dropoff" type="text" placeholder="Enter drop-off address or place">
  <button id="useLocDrop" class="btn secondary" style="margin-top:8px;">
    ğŸ“ Use My Location for Drop-off
  </button>

  <!-- Map -->
  <div id="map" style="height:250px; margin-top:15px; border-radius:10px;"></div>

  <!-- Fare Notes -->
  <div id="rushhour-note"></div>
  <div id="fairness-note"></div>

  <!-- Payment -->
  <label for="payment">Payment Method</label>
  <select id="payment">
    <option value="cash">Cash / Venmo / Cash App</option>
    <option value="card">Card (+3.3% + 2.4%)</option>
  </select>

  <button class="btn primary" id="calcBtn" style="display:block;margin:20px auto;">
    ğŸ’² Calculate Fare
  </button>

  <div id="result" style="display:none;"></div>

  <p class="disclaimer">*Estimates only. Final fare may vary slightly.</p>
</section>

<footer>
  <p>&copy; 2025 Big Red Connect â€” <a href="index.html">Return to Home</a></p>
</footer>

<!-- Status Pill Script -->
<script src="status.js"></script>

<script>
/* ======================================================
   CONFIG
====================================================== */
const API_BOOK = "https://bigred-bookings.bigredtransportation.workers.dev";
const HQ = { lat: 35.3207, lng: -97.4929 };
const STALE_MIN = 60;
let mode = "now";

/* ======================================================
   GOOGLE MAPS INIT
====================================================== */
let map, geocoder, directionsService, directionsRenderer;
let pickupLatLng = null, dropoffLatLng = null, pickupPlace=null, dropPlace=null;

function initGoogle() {
  geocoder = new google.maps.Geocoder();
  directionsService = new google.maps.DirectionsService();
  directionsRenderer = new google.maps.DirectionsRenderer({ suppressMarkers:true });

  map = new google.maps.Map(document.getElementById("map"), {
    center:{ lat:35.4676, lng:-97.5164 }, zoom:11
  });

  directionsRenderer.setMap(map);

  const acPickup = new google.maps.places.Autocomplete(document.getElementById("pickup"));
  const acDrop = new google.maps.places.Autocomplete(document.getElementById("dropoff"));

  acPickup.addListener("place_changed", ()=>{
    const p=acPickup.getPlace(); if(!p.geometry) return;
    pickupLatLng=p.geometry.location;
  });

  acDrop.addListener("place_changed", ()=>{
    const p=acDrop.getPlace(); if(!p.geometry) return;
    dropoffLatLng=p.geometry.location;
  });

  document.getElementById("modeNow").onclick = ()=> setMode("now");
  document.getElementById("modeReserve").onclick = ()=> setMode("reserve");
  document.getElementById("calcBtn").onclick = calculateFare;
  document.getElementById("addStopBtn").onclick = addStopField;

  document.getElementById("useLocPickup").onclick = ()=> useMyLocation("pickup");
  document.getElementById("useLocDrop").onclick = ()=> useMyLocation("dropoff");

  // Start status pill updates
  if (window.updateStatusPill) {
    updateStatusPill();
    setInterval(updateStatusPill, 60000);
  }
}

/* ======================================================
   MODE SWITCH
====================================================== */
function setMode(m){
  mode = m;
  if(m==="now"){
    document.getElementById("modeNow").classList.add("active");
    document.getElementById("modeReserve").classList.remove("active");
    document.getElementById("reserveControls").style.display="none";
  } else {
    document.getElementById("modeReserve").classList.add("active");
    document.getElementById("modeNow").classList.remove("active");
    document.getElementById("reserveControls").style.display="block";
  }
}

/* ======================================================
   ADD STOP FIELD
====================================================== */
window.stopInputs = [];
function addStopField(){
  if(stopInputs.length>=3){ alert("Limit 3 stops"); return; }

  const id="stop_"+Date.now();
  stopInputs.push(id);

  const wrap=document.getElementById("stopsWrap");
  const div=document.createElement("div");
  div.className="stop-row";
  div.id="row_"+id;
  div.innerHTML = `
    <label>Stop ${stopInputs.length}</label>
    <div style="display:flex; gap:6px; align-items:center;">
      <input id="${id}" type="text" placeholder="Enter stop address" style="flex:1;">
      <button type="button" class="remove-stop" onclick="removeStop('${id}')">âœ–</button>
    </div>
  `;
  wrap.appendChild(div);

  new google.maps.places.Autocomplete(document.getElementById(id));
}
function removeStop(id){
  document.getElementById("row_"+id)?.remove();
  stopInputs = stopInputs.filter(x=>x!==id);
}

/* ======================================================
   GPS PICKUP/DROPOFF
====================================================== */
function useMyLocation(which){
  if(!navigator.geolocation){ alert("Location not supported"); return; }

  navigator.geolocation.getCurrentPosition((pos)=>{
    const lat=pos.coords.latitude, lng=pos.coords.longitude;
    const latlng={ lat, lng };

    geocoder.geocode({ location:latlng }, (res,stat)=>{
      const addr = (stat==="OK" && res[0]) ? res[0].formatted_address : `${lat},${lng}`;

      document.getElementById(which).value = addr;

      if(which==="pickup"){
        pickupLatLng = new google.maps.LatLng(lat, lng);
      } else {
        dropoffLatLng = new google.maps.LatLng(lat, lng);
      }
    });
  });
}

/* ======================================================
   CALCULATE FARE
====================================================== */
async function calculateFare(){
  const pickup=document.getElementById("pickup").value.trim();
  const dropoff=document.getElementById("dropoff").value.trim();
  if(!pickup || !dropoff){ alert("Please enter pickup and dropoff."); return; }

  const stops = stopInputs.map(id=>{
    const v=document.getElementById(id)?.value.trim();
    return v ? { location:v, stopover:true } : null;
  }).filter(Boolean);

  // Google route
  const route = await new Promise((resolve,reject)=>{
    directionsService.route(
      { origin:pickup, destination:dropoff, waypoints:stops, travelMode:"DRIVING" },
      (r,status)=> status==="OK" ? resolve(r) : reject(status)
    );
  });

  directionsRenderer.setDirections(route);

  let miles = 0;
  let minutes = 0;
  route.routes[0].legs.forEach(l=>{
    miles += l.distance.value/1609.34;
    minutes += l.duration.value/60;
  });
  miles = Math.round(miles);
  minutes = Math.round(minutes);

  // Base rate logic
  let base=10;
  const now=new Date();
  const isRush = (now.getHours()>=5 && now.getHours()<9) || (now.getHours()>=15 && now.getHours()<19);
  if(isRush) base=15;

  // Mileage tiers
  const tier2=Math.max(0,Math.min(10,miles-10))*1.25;
  const tier3=Math.max(0,miles-20)*1.0;
  const milesSub = tier2+tier3;

  let fare = base + milesSub;
  if(document.getElementById("payment").value==="card"){
    fare += fare*0.033 + fare*0.024;
  }

  const result = document.getElementById("result");
  result.style.display="block";
  result.innerHTML = `
    <div class="total">$${fare.toFixed(2)}</div>
    <p><strong>Base:</strong> $${base.toFixed(2)}</p>
    <p><strong>Mileage:</strong> $${milesSub.toFixed(2)}</p>
    <p>ğŸ“ ${miles} mi â€¢ ${minutes} min</p>

    <button class="btn primary" id="btnRequest">ğŸ“© Request This Ride</button>
  `;

  // Save data
  window.lastFare = {
    pickup, dropoff, miles, minutes, fare: fare.toFixed(2),
    stops: stopInputs.map(id=>document.getElementById(id)?.value.trim()).filter(Boolean),
    mode,
    reserveDate:document.getElementById("reserveDate").value,
    reserveTime:document.getElementById("reserveTime").value,
    planBy:document.getElementById("planBy").value
  };

  document.getElementById("btnRequest").onclick = sendRequest;
}

/* ======================================================
   SEND REQUEST â†’ Worker â†’ Redirect to MyRide
====================================================== */
async function sendRequest(){
  if(!window.lastFare){ alert("Calculate first"); return; }

  // Ask rider name + party size
  const name = prompt("Your first name?");
  const party = prompt("How many passengers?", "1");

  const q = window.lastFare;

  const scheduled = (q.mode==="reserve" && q.reserveDate && q.reserveTime)
    ? new Date(`${q.reserveDate}T${q.reserveTime}:00`).toISOString()
    : null;

  const payload = {
    type: scheduled ? "RESERVATION" : "INSTANT",
    pickup:{ address:q.pickup },
    dropoff:{ address:q.dropoff },
    stops:q.stops.map(a=>({ address:a })),
    rider:{ 
      name:name||"", 
      phone:"", 
      partySize: Number(party)||1 
    },
    pricing:{
      estimate: Number(q.fare),
      travelFee:0,
      ratePlan:"STANDARD"
    },
    metrics:{ miles:q.miles, minutes:q.minutes },
    scheduledFor: scheduled,
    source:"FARE_CALCULATOR"
  };

  const res = await fetch(API_BOOK+"/api/bookings", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify(payload)
  });

  if(!res.ok){ alert("Error sending request"); return; }

  const booking = await res.json();

  // Rider auto login for push
  OneSignal.push(()=> {
    OneSignal.login("ride-" + booking.id);
  });

  // Redirect to MyRide
  location.href = `myride.html?id=${booking.id}`;
}
</script>

</body>
</html>