<!-- ============================================================
     GOOGLE MAPS + OKC-BIASED AUTOCOMPLETE (FULL WORKING BLOCK)
     Big Red Connect – Fare Calculator
     Version: 2025-12-01
============================================================ -->

<!-- Load Google Maps JavaScript API + Places Library -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCMM0dxLNM7XQI5G3OBSnINeO5hcS3Ks5I&libraries=places"></script>

<script>
/* ============================================================
   Initialize Map
============================================================ */
let map;
let pickupMarker;
let dropoffMarker;

function initMap() {
  map = new google.maps.Map(document.getElementById("map"), {
    center: { lat: 35.4676, lng: -97.5164 }, // OKC center
    zoom: 11,
    disableDefaultUI: true,
    gestureHandling: "greedy",
    styles: [
      { elementType: "geometry", stylers: [{ color: "#1a1a1a" }] },
      { elementType: "labels.text.stroke", stylers: [{ color: "#1a1a1a" }] },
      { elementType: "labels.text.fill", stylers: [{ color: "#ffffff" }] },
      {
        featureType: "poi",
        elementType: "geometry",
        stylers: [{ color: "#111" }]
      }
    ]
  });
}

/* Marker Helpers */
function setPickupMarker(lat, lng) {
  if (pickupMarker) pickupMarker.setMap(null);
  pickupMarker = new google.maps.Marker({
    position: { lat, lng },
    map,
    icon: { url: "http://maps.google.com/mapfiles/ms/icons/green-dot.png" }
  });
  map.panTo({ lat, lng });
}

function setDropoffMarker(lat, lng) {
  if (dropoffMarker) dropoffMarker.setMap(null);
  dropoffMarker = new google.maps.Marker({
    position: { lat, lng },
    map,
    icon: { url: "http://maps.google.com/mapfiles/ms/icons/red-dot.png" }
  });
  map.panTo({ lat, lng });
}

/* ============================================================
   Enhanced OKC-Biased Autocomplete
============================================================ */

function setupAutocomplete(id) {
  const input = document.getElementById(id);
  if (!input) return null;

  const okcBounds = new google.maps.LatLngBounds(
    { lat: 34.9000, lng: -98.2000 }, // Southwest OKC-metro area
    { lat: 36.0000, lng: -96.0000 }  // Northeast OKC-metro area
  );

  const options = {
    fields: ["formatted_address", "geometry.location", "name", "place_id"],
    bounds: okcBounds,
    strictBounds: false, // Still allow any destination, just bias OKC strongly
    types: ["establishment", "geocode"],
    componentRestrictions: { country: "us" }
  };

  const ac = new google.maps.places.Autocomplete(input, options);

  // Geo-bias to rider’s actual current location (very strong relevance boost)
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition((pos) => {
      try {
        const loc = new google.maps.LatLng(pos.coords.latitude, pos.coords.longitude);
        ac.setBounds(new google.maps.LatLngBounds(loc, loc));
      } catch (e) {}
    });
  }

  ac.addListener("place_changed", () => {
    const p = ac.getPlace();
    if (!p || !p.geometry) return;

    const lat = p.geometry.location.lat();
    const lng = p.geometry.location.lng();

    input.dataset.lat = lat;
    input.dataset.lng = lng;

    if (id === "pickup") setPickupMarker(lat, lng);
    if (id === "dropoff") setDropoffMarker(lat, lng);
  });

  return ac;
}

/* ============================================================
   Autocomplete Initialization
============================================================ */
function initAutocompleteAll() {
  setupAutocomplete("pickup");
  setupAutocomplete("dropoff");

  if (document.getElementById("stop1")) setupAutocomplete("stop1");
  if (document.getElementById("stop2")) setupAutocomplete("stop2");
  if (document.getElementById("stop3")) setupAutocomplete("stop3");
}

/* ============================================================
   On Page Load
============================================================ */
window.addEventListener("load", () => {
  initMap();
  initAutocompleteAll();
});
</script>