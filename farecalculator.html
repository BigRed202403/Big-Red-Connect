<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Fare Calculator ‚Äì Big Red Connect</title>

  <!-- No cache -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <link rel="stylesheet" href="style.css" />

  <!-- Google Maps -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCMM0dxLNM7XQI5G3OBSnINeO5hcS3Ks5I&libraries=places,geometry&callback=initGoogle" async defer></script>
</head>
<body>

  <!-- Header -->
  <div class="logo-header">
    <a href="index.html" title="Return to Home">
      <img src="official_logo.jpeg" alt="Big Red Connect Logo" style="cursor:pointer;" />
    </a>
  </div>

  <h1>Fare Calculator</h1>
  <p class="tagline">Plan your next ride connection ‚Äî quick, simple, and local.</p>

  <!-- Visible status pill (controlled by status.js only) -->
  <div id="status-pill" class="status">Checking status‚Ä¶</div>

  <section class="info-section calculator">

    <!-- Ride mode toggle -->
    <div class="ride-mode-toggle" aria-label="Choose ride mode">
      <button id="modeNow" class="btn btn-toggle active" type="button">üöó Ride Now</button>
      <button id="modeReserve" class="btn btn-toggle" type="button">üïí Reserve Ride</button>
    </div>

    <!-- Reserve controls (hidden by default) -->
    <div id="reserveControls" style="display:none;">
      <label for="reserveDate">Date</label>
      <input id="reserveDate" type="date" />

      <label for="reserveTime">Time</label>
      <input id="reserveTime" type="time" />

      <label for="planBy">Plan By</label>
      <select id="planBy">
        <option value="pickup">Pickup Time</option>
        <option value="dropoff">Drop-Off Time</option>
      </select>

      <div id="reserveHint" style="color:#ccc;font-size:0.9em;margin:6px 0 10px;">
        Choose a date/time. Rush hour will auto-apply if the pickup falls on a weekday 5‚Äì9 AM or 3‚Äì7 PM.
      </div>
    </div>

    <label for="pickup">Pickup Location</label>
    <input id="pickup" type="text" placeholder="Enter pickup address or place" />

    <div id="stopsWrap"></div>
    <button id="addStopBtn" class="btn primary" type="button">‚ûï Add Stop</button>

    <label for="dropoff">Drop-off Location</label>
    <input id="dropoff" type="text" placeholder="Enter drop-off address or place" />

    <div class="location-buttons">
      <button id="useLocPickup" class="btn primary" type="button">üìç Use My Location for Pickup</button>
      <button id="useLocDrop" class="btn secondary" type="button">üìç Use My Location for Drop-off</button>
    </div>

    <div id="map" style="height:250px;margin-top:15px;border-radius:10px;"></div>
    <div id="fairness-note"></div>
    <div id="airport-note"></div>
    <div id="rushhour-note"></div>

    <label for="tripType">Ride Type</label>
    <select id="tripType">
      <option value="10">Standard ($10 base)</option>
      <option value="15">Rush Hour ($15 base)</option>
      <option value="15_airport">Airport ($15 base)</option>
      <option value="20">Special Event ($20 base)</option>
    </select>

    <label for="payment">Payment Method</label>
    <select id="payment">
      <option value="cash">Cash / Venmo / Cash App (no fees)</option>
      <option value="card">Card (+3.3% booking + 2.4% fuel)</option>
    </select>

    <button class="btn primary" id="calcBtn" style="display:block;margin:20px auto;">üí≤ Calculate Fare</button>

    <div id="text-red-wrapper" style="margin-top:10px;text-align:center;">
      <a href="sms:+14053784024?&body=Hey%20Big%20Red%20‚Äî%20I‚Äôd%20like%20to%20plan%20a%20ride%20connection." class="btn secondary">üì≤ Text RED</a>
    </div>

    <div id="result" style="display:none;"></div>
    <p class="disclaimer">*Estimates only. Final fare may vary slightly based on route or wait time.</p>
  </section>

  <footer>
    <p>&copy; 2025 Big Red Connect ‚Äî <a href="index.html">Return to Home</a></p>
  </footer>

  <script>
  // ===== Config =====
  const HQ = { lat: 35.3207, lng: -97.4929 }; // 19th & S Santa Fe, Moore, OK (approx)
  const WORKER_URL = "https://update-location.bigredtransportation.workers.dev";
  const STALE_MINUTES = 30; // background "online" threshold for ETA/fee only
  const ZONE1 = ["oklahoma city","moore","norman","midwest city","del city"];
  const ZONE2 = ["edmond","yukon","mustang","newcastle","tuttle","choctaw","harrah","jones","luther"];
  const ZONE3 = ["shawnee","tecumseh","guthrie","blanchard","wellston","seminole","chickasha","goldsby","lexington","noble","purcell"];

  // ===== Maps globals =====
  let map, geocoder, directionsService, directionsRenderer;
  let pickupLatLng=null, dropoffLatLng=null, pickupPlace=null, dropPlace=null;
  let pickupCity="", driverPos=null;
  let stopInputs=[], pickupMarker=null, dropoffMarker=null;

  // ===== Reserve / Mode =====
  let mode = "now"; // "now" | "reserve"

  // ===== Helpers =====
  function isValidCoords(obj){return obj && typeof obj.lat==="number" && typeof obj.lng==="number" && !isNaN(obj.lat) && !isNaN(obj.lng);}
  function cap(s){return s ? s.charAt(0).toUpperCase()+s.slice(1) : s;}
  function distMi(a,b){return google.maps.geometry.spherical.computeDistanceBetween(new google.maps.LatLng(a.lat,a.lng),new google.maps.LatLng(b.lat,b.lng))/1609.34;}
  function extractCity(p){const c=p.address_components||[];const f=c.find(x=>x.types?.includes("locality")||x.types?.includes("postal_town"));return f?f.long_name:"";}
  function reverseCity(latlng){return new Promise(r=>geocoder.geocode({location:latlng},(res,s)=>{if(s==="OK"&&res?.[0]){const c=res[0].address_components||[];const f=c.find(x=>x.types?.includes("locality")||x.types?.includes("postal_town"));r(f?f.long_name:"");} else r("");}));}
  function weekdayRushHour(dateObj){
    const d=dateObj.getDay(), h=dateObj.getHours();
    const weekday = d>=1 && d<=5;
    const rush = (h>=5 && h<9) || (h>=15 && h<19);
    return weekday && rush;
  }

  // ===== Google init =====
  window.initGoogle = async function(){
    geocoder=new google.maps.Geocoder();
    directionsService=new google.maps.DirectionsService();
    directionsRenderer=new google.maps.DirectionsRenderer({suppressMarkers:true});
    map=new google.maps.Map(document.getElementById('map'),{center:{lat:35.4676,lng:-97.5164},zoom:11});
    directionsRenderer.setMap(map);

    // Autocomplete
    const acPickup=new google.maps.places.Autocomplete(document.getElementById('pickup'));
    const acDrop=new google.maps.places.Autocomplete(document.getElementById('dropoff'));

    acPickup.addListener('place_changed',async()=>{
      const p=acPickup.getPlace(); if(!p.geometry) return;
      pickupPlace=p; pickupLatLng=p.geometry.location;
      if(pickupMarker) pickupMarker.setMap(null);
      pickupMarker=new google.maps.Marker({position:pickupLatLng,map,label:"P"});
      map.setCenter(pickupLatLng); map.setZoom(12);
      pickupCity=extractCity(p)||await reverseCity(pickupLatLng);
      detectAirportAndSetType();
      await maybeShowFairnessNotePreview(); // preview only if fee would apply
    });
    acDrop.addListener('place_changed',()=>{
      const p=acDrop.getPlace(); if(p.geometry){
        dropPlace=p; dropoffLatLng=p.geometry.location;
        if(dropoffMarker) dropoffMarker.setMap(null);
        dropoffMarker=new google.maps.Marker({position:dropoffLatLng,map,label:"D"});
        map.panTo(dropoffLatLng); detectAirportAndSetType();
      }
    });

    // Carry-over destination from index
    const params=new URLSearchParams(window.location.search);
    const dest=params.get("dropoff");
    if(dest){
      const decoded=decodeURIComponent(dest);
      document.getElementById("dropoff").value=decoded;
      dropPlace={formatted_address:decoded,name:decoded};
      detectAirportAndSetType();
      setTimeout(()=>useMyLocation("pickup"),800);
    }

    // Mode toggle
    document.getElementById("modeNow").onclick=()=>setMode("now");
    document.getElementById("modeReserve").onclick=()=>setMode("reserve");

    // Buttons
    document.getElementById("calcBtn").onclick=calculateFare;
    document.getElementById("addStopBtn").onclick=addStopField;
    document.getElementById("useLocPickup").onclick=()=>useMyLocation("pickup");
    document.getElementById("useLocDrop").onclick=()=>useMyLocation("dropoff");

    smartRideTypeDefault();
    await getDriverLocation();
  };

  function setMode(m){
    mode=m;
    const nowBtn=document.getElementById("modeNow");
    const resBtn=document.getElementById("modeReserve");
    const controls=document.getElementById("reserveControls");
    if(m==="now"){
      nowBtn.classList.add("active"); resBtn.classList.remove("active");
      controls.style.display="none";
      smartRideTypeDefault(); // revert to live-time default
    }else{
      resBtn.classList.add("active"); nowBtn.classList.remove("active");
      controls.style.display="block";
      // If user picks a time later, we'll auto-set rush hour based on *effective pickup time*
    }
  }

  // Add/remove stops
  function addStopField(){
    if(stopInputs.length>=3){alert("Limit 3 stops.");return;}
    const id=`stop_${Date.now()}`; stopInputs.push(id);
    const wrap=document.getElementById('stopsWrap');
    const div=document.createElement('div');
    div.className="stop-row"; div.id=`row_${id}`;
    div.innerHTML=`<label for="${id}">Stop ${stopInputs.length}</label>
      <div style="display:flex;gap:6px;align-items:center;">
        <input id="${id}" type="text" placeholder="Enter stop address or place" style="flex:1;">
        <button type="button" class="remove-stop" onclick="removeStop('${id}')">‚úñ</button>
      </div>`;
    wrap.appendChild(div);
    new google.maps.places.Autocomplete(document.getElementById(id));
  }
  function removeStop(id){
    document.getElementById(`row_${id}`)?.remove();
    stopInputs=stopInputs.filter(s=>s!==id);
    document.querySelectorAll("#stopsWrap label").forEach((l,i)=>l.textContent=`Stop ${i+1}`);
  }

  // Airport detection
  function detectAirportAndSetType(){
    let combined="";
    const places=[pickupPlace,dropPlace].filter(Boolean);
    for(const p of places){ combined += (p?.name||"") + (p?.formatted_address||""); }
    const c=combined.toLowerCase();
    if(c.includes("airport") && !c.includes("tinker")){
      document.getElementById("tripType").value="15_airport";
      document.getElementById("airport-note").innerHTML="‚úàÔ∏è Airport ride detected ‚Äî $15 base applied automatically.";
    }else{
      document.getElementById("airport-note").innerHTML="";
    }
  }

  // Driver position (for ETA/fees only; status pill remains separate via status.js)
  async function getDriverLocation(){
    try{
      const r=await fetch(WORKER_URL,{cache:"no-store"});
      const j=await r.json();
      const lat=parseFloat(j.latitude), lng=parseFloat(j.longitude);
      const t=j.timestamp?new Date(j.timestamp):null;
      const ageMinutes=t?(Date.now()-t.getTime())/60000:999;

      const valid=!isNaN(lat)&&!isNaN(lng);
      const inRegion = lat>34 && lat<37 && lng>-99 && lng<-94; // keep obvious OKC-region sanity
      if(valid && ageMinutes<=STALE_MINUTES && inRegion){
        driverPos={lat,lng};
      }else{
        driverPos=HQ; // fallback only if missing/stale or obviously out-of-region
      }
    }catch{
      driverPos=HQ;
    }
  }

  // Smart default (live time)
  function smartRideTypeDefault(){
    const now=new Date();
    if(weekdayRushHour(now)){
      document.getElementById("tripType").value="15";
      document.getElementById("rushhour-note").innerHTML="üö¶ Weekday Rush Hour pricing (5‚Äì9 AM / 3‚Äì7 PM)";
    }else{
      document.getElementById("tripType").value="10";
      document.getElementById("rushhour-note").innerHTML="";
    }
  }

  // Reserve rush-hour evaluator based on *effective pickup time*
  function applyRushHourForReserve(effectivePickupDate){
    if(weekdayRushHour(effectivePickupDate)){
      document.getElementById("tripType").value="15";
      document.getElementById("rushhour-note").innerHTML="üö¶ Reserve pickup lands in a weekday Rush Hour (5‚Äì9 AM / 3‚Äì7 PM)";
    }else{
      // keep airport auto if detected, otherwise Standard
      if(document.getElementById("tripType").value!=="15_airport"){
        document.getElementById("tripType").value="10";
      }
      document.getElementById("rushhour-note").innerHTML="";
    }
  }

  // Use device location
  async function useMyLocation(id){
    if(!navigator.geolocation){alert("Location not supported.");return;}
    navigator.geolocation.getCurrentPosition(async(p)=>{
      const latlng={lat:p.coords.latitude,lng:p.coords.longitude};
      const addr=await new Promise(r=>geocoder.geocode({location:latlng},(res,s)=>r((s==="OK"&&res[0])?res[0].formatted_address:`${latlng.lat},${latlng.lng}`)));
      document.getElementById(id).value=addr;
      if(id==="pickup"){
        pickupLatLng=new google.maps.LatLng(latlng.lat,latlng.lng);
        if(pickupMarker) pickupMarker.setMap(null);
        pickupMarker=new google.maps.Marker({position:pickupLatLng,map,label:"P"});
        pickupCity=await reverseCity(latlng);
        await maybeShowFairnessNotePreview();
      }else{
        dropoffLatLng=new google.maps.LatLng(latlng.lat,latlng.lng);
        if(dropoffMarker) dropoffMarker.setMap(null);
        dropoffMarker=new google.maps.Marker({position:dropoffLatLng,map,label:"D"});
      }
    },()=>alert("Could not get your location permission."));
  }

  // ==== Fairness Fee 4.0 (silent unless applies) ====
  // If totalTripMiles < 35:
  //   >35 mi from driver => $20
  //   >15 mi (<=35) => $10
  // else $0
  function calcFairnessFee(totalTripMiles, ref, pickupLL){
    if(!pickupLL || !ref) return 0;
    if(totalTripMiles >= 35) return 0;
    const distFromDriver = distMi(ref, {lat: pickupLL.lat(), lng: pickupLL.lng()});
    if(distFromDriver > 35) return 20;
    if(distFromDriver > 15) return 10;
    return 0;
  }

  async function maybeShowFairnessNotePreview(){
    // Only show if it would apply and we have enough info to estimate driver distance
    if(!pickupLatLng) { document.getElementById('fairness-note').innerHTML=""; return; }
    await getDriverLocation();
    const ref=(isValidCoords(driverPos)?driverPos:HQ);
    // We don't know total trip miles yet, so preview only on distance thresholds with conservative message
    const distFromDriver = distMi(ref,{lat:pickupLatLng.lat(),lng:pickupLatLng.lng()});
    let msg="";
    if(distFromDriver>35) msg="Potential travel fairness fee may apply based on driver distance to pickup.";
    else if(distFromDriver>15) msg="A small travel fairness fee may apply based on driver distance to pickup.";
    document.getElementById('fairness-note').innerHTML = msg ? msg : "";
  }

  // ===== Main calculation =====
  async function calculateFare(){
    const pickup=document.getElementById('pickup').value.trim();
    const dropoff=document.getElementById('dropoff').value.trim();
    if(!pickup||!dropoff){alert("Please enter both pickup and drop-off.");return;}

    // Build waypoints
    const stops=[];
    for(const id of stopInputs){
      const v=document.getElementById(id)?.value.trim();
      if(v) stops.push({location:v, stopover:true});
    }

    // Directions
    const route=await new Promise((res,rej)=>directionsService.route({
      origin:pickup, destination:dropoff, waypoints:stops, travelMode:"DRIVING"
    },(r,s)=> s==="OK" ? res(r) : rej(s)));
    directionsRenderer.setDirections(route);
    const legs = route.routes[0].legs;
    const miles = legs.reduce((m,l)=>m+(l.distance?.value||0),0)/1609.34;
    const durationMin = legs.reduce((t,l)=>t+(l.duration?.value||0),0)/60;

    // Effective pickup datetime (affects rush hour if reserve)
    let effectivePickupDT = new Date();
    let reserveSummary = "";
    if(mode==="reserve"){
      const dStr=document.getElementById("reserveDate").value;
      const tStr=document.getElementById("reserveTime").value;
      const planBy=document.getElementById("planBy").value; // 'pickup' | 'dropoff'
      if(!dStr||!tStr){ alert("Please select a date and time for your reservation."); return; }

      // Build Date from inputs (local)
      const [yr,mo,dy]=dStr.split("-").map(Number);
      const [hh,mm]=tStr.split(":").map(Number);
      const chosen=new Date(yr,mo-1,dy,hh,mm,0,0);

      if(planBy==="pickup"){
        effectivePickupDT = chosen;
        reserveSummary = `Pickup at ${fmtTime(effectivePickupDT)} on ${fmtDate(effectivePickupDT)}`;
      }else{
        // Plan by drop-off: estimate pickup by subtracting duration
        const pickEstimate = new Date(chosen.getTime() - durationMin*60000);
        effectivePickupDT = pickEstimate;
        reserveSummary = `Drop-off by ${fmtTime(chosen)} on ${fmtDate(chosen)} (Pickup ‚âà ${fmtTime(pickEstimate)})`;
      }

      // Apply rush hour strictly Mon‚ÄìFri based on effective pickup time
      applyRushHourForReserve(effectivePickupDT);
    }else{
      // Live mode uses current time rule already via smartRideTypeDefault()
      smartRideTypeDefault();
    }

    // Read driver position (for ETA/fee calc)
    await getDriverLocation();
    const ref=(isValidCoords(driverPos)?driverPos:HQ);

    // ETA to pickup (hide in reserve mode)
    let pickupETAText="‚Äî";
    if(pickupLatLng){
      const mins=Math.max(2, Math.min(60, Math.ceil((distMi(ref,{lat:pickupLatLng.lat(),lng:pickupLatLng.lng()})/30)*60)));
      pickupETAText = `${mins} min`;
    }

    // Trip base (airport rule still wins)
    detectAirportAndSetType();
    const tripVal=document.getElementById('tripType').value;
    const base=(tripVal==="15_airport")?15:parseFloat(tripVal);

    // Mileage tiers (same as before)
    const tier2=Math.max(0,Math.min(10,miles-10))*1.25;
    const tier3=Math.max(0,miles-20)*1.00;
    const mileageSubtotal=tier2+tier3;

    // Fairness Fee 4.0 (silent unless >0)
    const fairnessFee = calcFairnessFee(miles, ref, pickupLatLng);

    // Stops
    const stopsTotal=stops.length*5;

    // Payment modifier
    let fare=base+mileageSubtotal+stopsTotal+fairnessFee;
    const pay=document.getElementById('payment').value;
    if(pay==="card") fare+=fare*0.033 + fare*0.024;
    const total=fare.toFixed(2);

    // Maps route link
    const wayStr=stops.length?stops.map(s=>s.location).join("|"):"";
    const routeLink=`https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(pickup)}&destination=${encodeURIComponent(dropoff)}${wayStr?`&waypoints=${encodeURIComponent(wayStr)}`:""}`;

    // Build result UI
    const resultDiv=document.getElementById('result');
    let html=`<div class="total">$${total}</div>
      <p><strong>Base Rate:</strong> $${base.toFixed(2)}</p>
      <p><strong>Mileage:</strong> $${mileageSubtotal.toFixed(2)}</p>
      <p><strong>Stops:</strong> ${stops.length} √ó $5 = $${stopsTotal.toFixed(2)}</p>
      ${fairnessFee>0?`<p><strong>Travel Fairness Fee:</strong> $${fairnessFee.toFixed(2)}</p>`:""}
      <p><strong>Payment:</strong> ${pay==="card"?"Card (incl. fees)":"Cash / Venmo / Cash App"}</p>
      <p>üìè ${miles.toFixed(1)} mi  ‚è±Ô∏è ${Math.round(durationMin)} min ${mode==="now"?` üöó ETA ${pickupETAText}`:""}</p>
      ${mode==="reserve"?`<p><em>${reserveSummary}</em></p>`:""}
      <p style="text-align:center;margin-top:15px;">
        <button class="btn primary" id="textRedBtn">üì≤ Text RED with Trip Details</button>
      </p>
      <p style="text-align:center;color:#888;margin-top:10px;">No surprises. Just solid local moves.</p>`;
    resultDiv.innerHTML=html;
    resultDiv.style.display="block";

    // Build SMS (include reserve info and pickup estimate when planning by drop-off)
    document.getElementById("textRedBtn").onclick=()=>{
      const name=prompt("Hey there! Please enter your name for the message to Big Red:");
      const lines=[];
      lines.push(`Hey Big Red ‚Äî this is ${name||"a rider"}.`);
      if(mode==="reserve"){
        const planBy=document.getElementById("planBy").value;
        const dStr=document.getElementById("reserveDate").value;
        const tStr=document.getElementById("reserveTime").value;
        const [yr,mo,dy]=dStr.split("-").map(Number);
        const [hh,mm]=tStr.split(":").map(Number);
        const chosen=new Date(yr,mo-1,dy,hh,mm,0,0);

        if(planBy==="pickup"){
          lines.push(`Requesting pickup at ${fmtTime(effectivePickupDT)} on ${fmtDate(effectivePickupDT)}.`);
        }else{
          const pickEstimate=new Date(chosen.getTime() - durationMin*60000);
          lines.push(`Requesting drop-off by ${fmtTime(chosen)} on ${fmtDate(chosen)}.`);
          lines.push(`Pickup ‚âà ${fmtTime(pickEstimate)}.`);
        }
      }else{
        lines.push(`Ride now request.`);
        if(pickupETAText && pickupETAText!=="‚Äî") lines.push(`Pickup ETA ‚âà ${pickupETAText}.`);
      }
      lines.push(`From: ${pickup}`);
      if(stops.length) lines.push(`Stops: ${stops.map(s=>s.location).join(" ‚Üí ")}`);
      lines.push(`To: ${dropoff}`);
      lines.push(`Est. flat rate: $${total}`);
      if(fairnessFee>0) lines.push(`Includes travel fairness fee: $${fairnessFee.toFixed(2)}.`);
      lines.push(`Route: ${routeLink}`);

      const smsBody=encodeURIComponent(lines.join(" "));
      window.location.href=`sms:+14053784024?&body=${smsBody}`;
    };
  }

  // Format helpers
  function fmtTime(d){
    const h=d.getHours(), m=d.getMinutes();
    const ampm = h>=12 ? "PM" : "AM";
    const hh = ((h+11)%12+1);
    const mm = m.toString().padStart(2,"0");
    return `${hh}:${mm} ${ampm}`;
  }
  function fmtDate(d){
    const m=d.getMonth()+1, day=d.getDate();
    return `${m}/${day}`;
  }
  </script>

  <!-- Status pill logic (visible UI) -->
  <script src="status.js"></script>
</body>
</html>
