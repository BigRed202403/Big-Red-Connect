<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Fare Calculator ‚Äì Big Red Connect</title>

  <!-- üö´ Force fresh reloads after publishing -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <link rel="stylesheet" href="style.css" />

  <!-- ‚ñ∏ Shimmer/Splash (once per session) -->
  <style>
    #shimmer {
      position: fixed; inset: 0; background:#000; z-index:10000;
      display:flex; flex-direction:column; align-items:center; justify-content:center;
    }
    #shimmer .logo {
      width: 160px; max-width: 50vw; height:auto;
      animation:pulse 1.2s infinite ease-in-out;
    }
    #shimmer .msg {
      color:#bbb; margin-top:14px; font-size:0.95em; letter-spacing:.3px;
    }
    @keyframes pulse {
      0%{opacity:.5; transform:scale(.98)}
      50%{opacity:1; transform:scale(1)}
      100%{opacity:.5; transform:scale(.98)}
    }
  </style>
  <script>
    window.SPLASH_MESSAGE = "Loading Fare Calculator‚Ä¶";
    (function(){
      if (sessionStorage.getItem("brc_splash_shown")) return;
      const w=document.createElement("div");
      w.id="shimmer";
      w.innerHTML = '<img class="logo" src="official_logo.jpeg" alt="Big Red Connect Logo"><div class="msg">'+(window.SPLASH_MESSAGE||"Loading‚Ä¶")+'</div>';
      document.addEventListener("DOMContentLoaded", ()=>document.body.appendChild(w));
      window.addEventListener("load", ()=>{
        setTimeout(()=>{
          w.style.transition="opacity .35s"; w.style.opacity="0";
          setTimeout(()=>{ w.remove(); sessionStorage.setItem("brc_splash_shown","1"); },350);
        },350);
      });
    })();
  </script>

  <!-- ‚úàÔ∏è Google Maps JS -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCMM0dxLNM7XQI5G3OBSnINeO5hcS3Ks5I&libraries=places,geometry&callback=initGoogle" async defer></script>
</head>
  <script>
  // üö´ Force reload every visit (no cache retained)
  (async function() {
    const savedStatus = sessionStorage.getItem('bigred_status'); // preserve driver status
    if ('caches' in window) {
      const keys = await caches.keys();
      for (const key of keys) await caches.delete(key);
    }
    localStorage.clear();
    sessionStorage.clear();
    if (savedStatus) sessionStorage.setItem('bigred_status', savedStatus); // restore after clear

    // Append random query to force a new request each time
    const currentUrl = window.location.href.split('?')[0];
    if (!window.location.search.includes('freshReload')) {
      const rand = Math.floor(Math.random() * 999999);
      window.location.replace(`${currentUrl}?freshReload=${rand}`);
    }
  })();
</script>
  <script>
  // üîÑ Sync current status from sessionStorage (set by index.html)
  document.addEventListener('DOMContentLoaded', () => {
    const pill = document.getElementById('status-pill');
    const state = sessionStorage.getItem('bigred_status') || 'offline';
    const map = {
      online: ['üü¢ Big Red is Live', 'status online'],
      away: ['üü° Limited Availability', 'status away'],
      offline: ['üî¥ Offline', 'status offline']
    };
    const [text, cls] = map[state];
    pill.textContent = text;
    pill.className = cls;

    // keep status.js hooks functional
    const evt = new CustomEvent("statusUpdated", { detail: state });
    document.dispatchEvent(evt);
  });
</script>
<body>

  <!-- üöó Logo Header (no hero on subpages) -->
  <div class="logo-header">
    <img src="official_logo.jpeg" alt="Big Red Connect Logo" />
  </div>

  <h1>Fare Calculator</h1>
  <p class="tagline">Plan your next ride connection ‚Äî quick, simple, and local.</p>

  <!-- üü¢ Status Pill -->
  <div id="status-pill" class="status status--loading">Checking status‚Ä¶</div>

  <!-- üßÆ Fare Calculator -->
  <section class="info-section calculator">
    <label for="pickup">Pickup Location</label>
    <input id="pickup" type="text" placeholder="Enter pickup address or place">

    <div id="stopsWrap"></div>
    <button id="addStopBtn" class="btn primary" type="button">‚ûï Add Stop</button>

    <label for="dropoff">Drop-off Location</label>
    <input id="dropoff" type="text" placeholder="Enter drop-off address or place">

    <div class="location-buttons">
      <button id="useLocPickup" class="btn primary" type="button">üìç Use My Location for Pickup</button>
      <button id="useLocDrop" class="btn secondary" type="button">üìç Use My Location for Drop-off</button>
    </div>

    <div id="map"></div>
    <div id="fairness-note"></div>
    <div id="airport-note"></div>

    <label for="tripType">Ride Type</label>
    <select id="tripType">
      <option value="10">Standard ($10 base)</option>
      <option value="15">Rush Hour ($15 base)</option>
      <option value="15_airport">Airport ($15 base)</option>
      <option value="20">Special Event ($20 base)</option>
    </select>

    <label for="payment">Payment Method</label>
    <select id="payment">
      <option value="cash">Cash / Venmo / Cash App (no fees)</option>
      <option value="card">Card (+3.3% booking + 2.4% fuel)</option>
    </select>

    <button class="btn primary" id="calcBtn">üí≤ Calculate Fare</button>

    <!-- Default Text RED fallback -->
    <div id="text-red-wrapper" style="margin-top:10px;">
      <a href="sms:+14053784024?&body=Hey%20Big%20Red%20‚Äî%20I‚Äôd%20like%20to%20plan%20a%20ride%20connection." class="btn secondary">üì≤ Text RED</a>
    </div>

    <div id="result" style="display:none;"></div>

    <p class="disclaimer">*Estimates only. Final fare may vary slightly based on route or wait time.</p>
  </section>

  <!-- ü¶∂ Footer -->
  <footer>
    <p>&copy; 2025 Big Red Connect ‚Äî <a href="index.html">Return to Home</a></p>
    <p style="font-size:0.8em;color:#777;margin-top:10px;line-height:1.4;">
      Vehicle imagery features actual Big Red Connect fleet vehicles.<br>
      Some backgrounds created with AI-assisted design tools for illustrative purposes only.<br>
      Brand names (Chevrolet¬Æ and GMC¬Æ) are property of their respective owners and used descriptively.
    </p>
  </footer>

  <!-- üîß Status Pill Logic -->
  <script src="status.js"></script>

  <!-- üöó Fare Calculator Logic -->
  <script>
  const HQ={lat:35.2902,lng:-97.5289};
  const WORKER_URL="https://falling-night-3e4d.bigredtransportation.workers.dev";
  const ZONE1=["oklahoma city","moore","norman","midwest city","del city"];
  const ZONE2=["edmond","yukon","mustang","newcastle","tuttle","choctaw","harrah","jones","luther","far east norman","east norman"];
  const ZONE3=["shawnee","tecumseh","guthrie","blanchard","wellston","seminole","chickasha","goldsby","lexington","noble"];

  let map,geocoder,directionsService,directionsRenderer;
  let pickupLatLng=null,dropoffLatLng=null,pickupPlace=null,dropPlace=null;
  let pickupCity="",driverPos=null,driverCity="";
  let stopInputs=[];

  window.initGoogle = async function(){
    geocoder=new google.maps.Geocoder();
    directionsService=new google.maps.DirectionsService();
    directionsRenderer=new google.maps.DirectionsRenderer({suppressMarkers:true});
    map=new google.maps.Map(document.getElementById('map'),{
      center:{lat:35.4676,lng:-97.5164},zoom:11,mapTypeControl:false,streetViewControl:false});
    directionsRenderer.setMap(map);

    const acPickup=new google.maps.places.Autocomplete(document.getElementById('pickup'));
    const acDrop=new google.maps.places.Autocomplete(document.getElementById('dropoff'));

    acPickup.addListener('place_changed',async()=>{
      const p=acPickup.getPlace();if(!p.geometry)return;
      pickupPlace=p;pickupLatLng=p.geometry.location;
      map.setCenter(pickupLatLng);map.setZoom(12);
      pickupCity=extractCity(p)||await reverseCity(pickupLatLng);
      await computeFairnessNote();detectAirportAndSetType();
    });
    acDrop.addListener('place_changed',()=>{
      const p=acDrop.getPlace();if(p.geometry){
        dropPlace=p;dropoffLatLng=p.geometry.location;
        map.panTo(dropoffLatLng);detectAirportAndSetType();
      }
    });

    document.getElementById('useLocPickup').onclick=()=>useMyLocation('pickup');
    document.getElementById('useLocDrop').onclick=()=>useMyLocation('dropoff');
    document.getElementById('addStopBtn').onclick=addStopField;
    document.getElementById('calcBtn').onclick=calculateFare;

    // Prefill from query param
    const params=new URLSearchParams(window.location.search);
    const dest=params.get('dropoff');
    if(dest){
      const decoded=decodeURIComponent(dest);
      document.getElementById('dropoff').value=decoded;
      dropPlace={formatted_address:decoded,name:decoded};
      detectAirportAndSetType();
      // Auto pickup as current device location
      setTimeout(()=>useMyLocation('pickup'),600);
    }

    smartRideTypeDefault();
    await getDriverLocation();
    if(driverPos)driverCity=await reverseCity(driverPos);
  };

  function addStopField(){
    if(stopInputs.length>=3){alert("Limit 3 stops.");return;}
    const id=`stop_${Date.now()}`;stopInputs.push(id);
    const wrap=document.getElementById('stopsWrap');
    const div=document.createElement('div');
    div.className="stop-row";div.id=`row_${id}`;
    div.innerHTML=`<label for="${id}">Stop ${stopInputs.length}</label>
      <div style="display:flex;gap:6px;align-items:center;">
        <input id="${id}" type="text" placeholder="Enter stop address or place" style="flex:1;">
        <button type="button" class="remove-stop" onclick="removeStop('${id}')">‚úñ</button>
      </div>`;
    wrap.appendChild(div);
    new google.maps.places.Autocomplete(document.getElementById(id));
  }

  function removeStop(id){
    document.getElementById(`row_${id}`)?.remove();
    stopInputs=stopInputs.filter(s=>s!==id);
    document.querySelectorAll("#stopsWrap label").forEach((l,i)=>l.textContent=`Stop ${i+1}`);
  }

  function extractCity(p){const c=p.address_components||[];const f=c.find(x=>x.types.includes("locality")||x.types.includes("postal_town")||x.types.includes("administrative_area_level_3"));return f?f.long_name:"";}
  function reverseCity(latlng){return new Promise(r=>geocoder.geocode({location:latlng},(res,s)=>{if(s==="OK"&&res[0]){const c=res[0].address_components||[];const f=c.find(x=>x.types.includes("locality")||x.types.includes("postal_town")||x.types.includes("administrative_area_level_3"));r(f?f.long_name:"");}else r("");}));}

  async function getDriverLocation(){try{const r=await fetch(WORKER_URL,{cache:"no-store"});const j=await r.json();if(j.latitude)driverPos={lat:+j.latitude,lng:+j.longitude};}catch{}}
  function distMi(a,b){return google.maps.geometry.spherical.computeDistanceBetween(new google.maps.LatLng(a.lat,a.lng),new google.maps.LatLng(b.lat,b.lng))/1609.34;}
  function distanceFee(mi){return mi<=15?0:mi<=30?10:20;}
  function cap(s){return s?s.charAt(0).toUpperCase()+s.slice(1):s;}

  async function computeFairnessNote(){
    if(!pickupLatLng){document.getElementById('fairness-note').innerText="";return 0;}
    const pCity=(pickupCity||"").toLowerCase().trim();
    const dCity=(driverCity||"").toLowerCase().trim();
    const ref=driverPos||HQ;let fee=0,msg="",src=driverPos?"Live Location":"HQ";
    const inZ1=ZONE1.includes(pCity),inZ2=ZONE2.includes(pCity),inZ3=ZONE3.includes(pCity);
    if(inZ1){
      if(driverPos&&!ZONE1.includes(dCity)){
        const mi=distMi(ref,{lat:pickupLatLng.lat(),lng:pickupLatLng.lng()});
        fee=distanceFee(mi);
        msg=`Pickup in Zone 1 (${cap(pCity)}) ‚Äî ${mi.toFixed(1)} mi away ‚Üí $${fee}`;
      } else { msg=`Pickup in Zone 1 (${cap(pCity)}) ‚Äî standard local rate.`; }
    } else if(inZ2){fee=(driverPos&&ZONE2.includes(dCity))?0:10;msg=`Pickup in Zone 2 (${cap(pCity)}) ‚Üí $${fee}`;}
    else if(inZ3){fee=(driverPos&&ZONE3.includes(dCity))?0:20;msg=`Pickup in Zone 3 (${cap(pCity)}) ‚Üí $${fee}`;}
    else{
      const mi=distMi(ref,{lat:pickupLatLng.lat(),lng:pickupLatLng.lng()});
      fee=distanceFee(mi);msg=`Unrecognized city ‚Äî ${mi.toFixed(1)} mi from ${src} ‚Üí $${fee}`;
    }
    document.getElementById('fairness-note').innerHTML=`${msg}<br><span style="color:#777;font-size:0.85em;">Source: ${src}</span>`;
    return fee;
  }

  async function useMyLocation(id){
    if(!navigator.geolocation){alert("Location not supported.");return;}
    navigator.geolocation.getCurrentPosition(async(p)=>{
      const latlng={lat:p.coords.latitude,lng:p.coords.longitude};
      const addr=await new Promise(r=>geocoder.geocode({location:latlng},(res,s)=>r((s==="OK"&&res[0])?res[0].formatted_address:`${latlng.lat},${latlng.lng}`)));
      document.getElementById(id).value=addr;
      if(id==="pickup"){
        pickupLatLng=new google.maps.LatLng(latlng.lat,latlng.lng);
        pickupCity=await reverseCity(latlng);
        map.setCenter(pickupLatLng);map.setZoom(12);
        await computeFairnessNote();
      } else {
        dropoffLatLng=new google.maps.LatLng(latlng.lat,latlng.lng);
        map.panTo(dropoffLatLng);
      }
    },()=>alert("Could not get your location permission."));
  }

  async function calculateFare(){
    const pickup=document.getElementById('pickup').value.trim();
    const dropoff=document.getElementById('dropoff').value.trim();
    if(!pickup||!dropoff){alert("Please enter both pickup and drop-off.");return;}
    const fairnessFee=await computeFairnessNote();
    const stops=[];
    for(const id of stopInputs){const v=document.getElementById(id)?.value.trim();if(v)stops.push({location:v,stopover:true});}
    try{
      const route=await new Promise((res,rej)=>directionsService.route({origin:pickup,destination:dropoff,waypoints:stops,travelMode:"DRIVING"},(r,s)=>{if(s==="OK")res(r);else rej(s);}));
      const miles=route.routes[0].legs.reduce((m,l)=>m+(l.distance?.value||0),0)/1609.34;
      smartRideTypeDefault();detectAirportAndSetType();

      const tripVal=document.getElementById('tripType').value;
      const base=(tripVal==="15_airport")?15:parseFloat(tripVal);
      let fare=base;
      if(miles>10&&miles<=20)fare+=(miles-10)*1.25;
      else if(miles>20)fare+=(10*1.25)+((miles-20)*1.0);
      fare+=(stops.length*5)+fairnessFee;

      const pay=document.getElementById('payment').value;
      if(pay==="card")fare+=fare*0.033+fare*0.024;

      const total=fare.toFixed(2);
      const payLabel=(pay==="card")?"Card (includes fees)":"Cash / Venmo / Cash App";
      const smsBody=encodeURIComponent(`Hey Big Red ‚Äî I‚Äôm heading from ${pickup} to ${dropoff}. Estimated $${total} flat rate. Are you available?`);

      const r=document.getElementById('result');
      r.innerHTML=`<div class="total">$${total}</div>
        <p><strong>Distance:</strong> ${miles.toFixed(1)} mi</p>
        <p><strong>Ride Type:</strong> $${base.toFixed(2)} base</p>
        <p><strong>Stops:</strong> ${stops.length} √ó $5 = $${(stops.length*5).toFixed(2)}</p>
        <p><strong>Travel Fairness Fee:</strong> $${fairnessFee.toFixed(2)}</p>
        <p><strong>Payment:</strong> ${payLabel}</p>
        <p style="text-align:center;margin-top:15px;">
          <a href="sms:+14053784024?&body=${smsBody}" class="btn primary">üì≤ Text RED with Trip Details</a>
        </p>`;
      r.style.display="block";
    }catch(e){alert("Could not calculate route.");console.error(e);}
  }

  function smartRideTypeDefault(){
    let v="10";
    const d=new Date(),day=d.getDay(),h=d.getHours();
    if(day>=1&&day<=5&&((h>=5&&h<10)||(h>=16&&h<19)))v="15";
    document.getElementById("tripType").value=v;
  }

  function detectAirportAndSetType(){
    let combined="";
    const places=[pickupPlace,dropPlace].filter(Boolean);
    for(const p of places){
      const name=(p?.name||"").toLowerCase();
      const addr=(p?.formatted_address||"").toLowerCase();
      combined+=name+" "+addr+" ";
    }
    for(const id of stopInputs){
      const stopVal=(document.getElementById(id)?.value||"").toLowerCase();
      combined+=stopVal+" ";
    }
    const include=["airport","airfield","air park","airpark","intl","international","regional","municipal","hangar","jet center","heliport"];
    const exclude=["tinker","afb","air force","base","ang"];
    if(include.some(k=>combined.includes(k)) && !exclude.some(k=>combined.includes(k))){
      document.getElementById("tripType").value="15_airport";
      document.getElementById("airport-note").innerHTML="‚úàÔ∏è Airport ride detected ‚Äî $15 base applied automatically.";
    } else {
      document.getElementById("airport-note").innerHTML="";
    }
  }
  </script>
</body>
</html>
