<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Fare Calculator ‚Äì Big Red Connect</title>
<style>
  body{background:#000;color:#fff;font-family:'Segoe UI',Roboto,Helvetica,Arial,sans-serif;
       margin:0;padding:20px;max-width:640px;margin:auto;text-align:center;}
  .logo{margin:28px 0 16px;}
  h1{color:#c40000;font-size:1.9em;margin:0 0 10px;}
  p.lead{color:#bbb;margin:0 0 18px;}
  label{display:block;text-align:left;margin:14px 0 6px;color:#ccc;}
  input,select{width:100%;padding:12px;border-radius:8px;border:1px solid #333;background:#111;color:#fff;}
  .btn{background:#c40000;color:#fff;border:none;padding:12px 22px;border-radius:10px;
       margin-top:16px;font-weight:700;font-size:1.05em;box-shadow:0 3px 6px rgba(255,0,0,.3);
       cursor:pointer;transition:.15s;}
  .btn:hover{background:#990000;transform:scale(1.03);}
  #map{height:250px;width:100%;border:2px solid #c40000;border-radius:10px;margin-top:15px;}
  #result{background:#111;border:1px solid #c40000;border-radius:12px;padding:18px;margin-top:22px;text-align:left;}
  #result .total{font-size:1.6em;color:#ff4444;font-weight:800;text-align:center;margin:0 0 8px;}
  #result p{margin:6px 0;}
  #fairness-note{color:#999;font-size:0.95em;font-style:italic;margin-top:8px;text-align:left;}
  .disclaimer{font-size:.9em;color:#999;margin:16px 0 28px;font-style:italic;}
  footer{margin:28px 0 36px;color:#666;font-size:.9em;}
  footer a{color:#aaa;text-decoration:none;}
  footer a:hover{text-decoration:underline;color:#fff;}
  .stop-row button.remove-stop{background:none;border:1px solid #555;color:#aaa;font-size:1em;width:34px;height:34px;
       border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .2s;}
  .stop-row button.remove-stop:hover{color:#fff;border-color:#888;background:#222;transform:scale(1.05);}
</style>
</head>
<body>
<div class="logo">
  <img src="148D1A08-D537-4A0C-B141-2336DBF68A15.png" alt="Big Red Connect" width="260">
</div>

<h1>Big Red Connect Fare Calculator</h1>
<p class="lead">Type an address or business (e.g. <em>Campus Corner</em>, <em>Riverwind Casino</em>) ‚Äî or tap the pin to use your current location.</p>

<label for="pickup">Pickup Location:</label>
<input id="pickup" type="text" placeholder="Enter pickup address or place">

<div id="stopsWrap"></div>
<button id="addStopBtn" class="btn" type="button" style="margin-top:10px;">‚ûï Add Stop</button>

<label for="dropoff">Drop-off Location:</label>
<input id="dropoff" type="text" placeholder="Enter drop-off address or place">

<div style="display:flex;gap:10px;margin-top:12px;">
  <button id="useLocPickup" class="btn" type="button">üìç Use My Location for Pickup</button>
  <button id="useLocDrop" class="btn" type="button">üìç Use My Location for Drop-off</button>
</div>

<div id="map"></div>
<div id="fairness-note"></div>

<label for="tripType">Ride Type:</label>
<select id="tripType">
  <option value="10">Standard ($10 base)</option>
  <option value="15">Rush Hour ($15 base)</option>
  <option value="15_airport">Airport ($15 base)</option>
  <option value="20">Special Event ($20 base)</option>
</select>

<label for="payment">Payment Method:</label>
<select id="payment">
  <option value="cash">Cash / Venmo / Cash App (no fees)</option>
  <option value="card">Card (+3.3% booking + 2.4% fuel)</option>
</select>

<button class="btn" id="calcBtn">üí≤ Calculate Fare</button>
<div id="result" style="display:none;"></div>

<div class="disclaimer">*Estimates only. Final fare may vary slightly based on route, wait time, or negotiated pricing.</div>

<footer>&copy; 2025 Big Red Connect ‚Äî <a href="index.html">Return to Main Page</a></footer>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCMM0dxLNM7XQI5G3OBSnINeO5hcS3Ks5I&libraries=places,geometry&callback=initGoogle" async defer></script>

<script>
const HQ={lat:35.2902,lng:-97.5289};
const WORKER_URL="https://falling-night-3e4d.bigredtransportation.workers.dev";

const ZONE1=["oklahoma city","moore","norman","midwest city","del city"];
const ZONE2=["edmond","yukon","mustang","newcastle","tuttle","choctaw","harrah","jones","luther","far east norman","east norman"];
const ZONE3=["shawnee","tecumseh","guthrie","blanchard","wellston","seminole","chickasha","goldsby","lexington","noble"];

let map,geocoder,directionsService,directionsRenderer;
let pickupLatLng=null,dropoffLatLng=null,pickupPlace=null,dropPlace=null;
let pickupCity="",driverPos=null,driverCity="";
let stopInputs=[];

async function initGoogle(){
  geocoder=new google.maps.Geocoder();
  directionsService=new google.maps.DirectionsService();
  directionsRenderer=new google.maps.DirectionsRenderer({suppressMarkers:true});
  map=new google.maps.Map(document.getElementById('map'),{center:{lat:35.4676,lng:-97.5164},zoom:11,mapTypeControl:false,streetViewControl:false});
  directionsRenderer.setMap(map);

  const acPickup=new google.maps.places.Autocomplete(document.getElementById('pickup'));
  const acDrop=new google.maps.places.Autocomplete(document.getElementById('dropoff'));

  acPickup.addListener('place_changed',async()=>{
    const p=acPickup.getPlace();if(!p.geometry)return;
    pickupPlace=p;pickupLatLng=p.geometry.location;
    map.setCenter(pickupLatLng);map.setZoom(12);
    pickupCity=extractCity(p)||await reverseCity(pickupLatLng);
    await computeFairnessNote();
  });
  acDrop.addListener('place_changed',()=>{const p=acDrop.getPlace();if(p.geometry){dropPlace=p;dropoffLatLng=p.geometry.location;map.panTo(dropoffLatLng);detectAirportAndSetType();}});

  document.getElementById('useLocPickup').onclick=()=>useMyLocation('pickup');
  document.getElementById('useLocDrop').onclick=()=>useMyLocation('dropoff');
  document.getElementById('addStopBtn').onclick=addStopField;
  document.getElementById('calcBtn').onclick=calculateFare;

  smartRideTypeDefault();
  await getDriverLocation();
  if(driverPos)driverCity=await reverseCity(driverPos);
}

function addStopField(){
  if(stopInputs.length>=3){alert("Limit 3 stops.");return;}
  const id=`stop_${Date.now()}`;stopInputs.push(id);
  const wrap=document.getElementById('stopsWrap');
  const div=document.createElement('div');
  div.className="stop-row";div.id=`row_${id}`;div.style.marginTop="10px";
  div.innerHTML=`<label for="${id}">Stop ${stopInputs.length}:</label>
    <div style="display:flex;gap:6px;align-items:center;">
      <input id="${id}" type="text" placeholder="Enter stop address or place" style="flex:1;">
      <button type="button" class="remove-stop" onclick="removeStop('${id}')">‚úñ</button>
    </div>`;
  wrap.appendChild(div);
  new google.maps.places.Autocomplete(document.getElementById(id));
}
function removeStop(id){
  document.getElementById(`row_${id}`)?.remove();
  stopInputs=stopInputs.filter(s=>s!==id);
  document.querySelectorAll("#stopsWrap label").forEach((l,i)=>l.textContent=`Stop ${i+1}:`);
}

function extractCity(p){const c=p.address_components||[];const f=c.find(x=>x.types.includes("locality")||x.types.includes("postal_town")||x.types.includes("administrative_area_level_3"));return f?f.long_name:"";}
function reverseCity(latlng){return new Promise(r=>geocoder.geocode({location:latlng},(res,s)=>{if(s==="OK"&&res[0]){const c=res[0].address_components||[];const f=c.find(x=>x.types.includes("locality")||x.types.includes("postal_town")||x.types.includes("administrative_area_level_3"));r(f?f.long_name:"");}else r("");}));}

async function getDriverLocation(){try{const r=await fetch(WORKER_URL,{cache:"no-store"});const j=await r.json();if(j.latitude)driverPos={lat:+j.latitude,lng:+j.longitude};}catch{}}
function distMi(a,b){return google.maps.geometry.spherical.computeDistanceBetween(new google.maps.LatLng(a.lat,a.lng),new google.maps.LatLng(b.lat,b.lng))/1609.34;}
function distanceFee(mi){return mi<=15?0:mi<=30?10:20;}
function cap(s){return s?s.charAt(0).toUpperCase()+s.slice(1):s;}

async function computeFairnessNote(){
  if(!pickupLatLng){document.getElementById('fairness-note').innerText="";return 0;}
  const pCity=(pickupCity||"").toLowerCase().trim();const dCity=(driverCity||"").toLowerCase().trim();
  const ref=driverPos||HQ;let fee=0,msg="",src=driverPos?"Live Location":"HQ";
  const inZ1=ZONE1.includes(pCity),inZ2=ZONE2.includes(pCity),inZ3=ZONE3.includes(pCity);
  if(inZ1){if(driverPos&&!ZONE1.includes(dCity)){const mi=distMi(ref,{lat:pickupLatLng.lat(),lng:pickupLatLng.lng()});fee=distanceFee(mi);msg=`Pickup in Zone 1 (${cap(pCity)}), but you are outside ‚Äî ${mi.toFixed(1)} mi ‚Üí $${fee}`;}else msg=`Pickup in Zone 1 (${cap(pCity)}) ‚Äî no fairness fee.`;}
  else if(inZ2){fee=(driverPos&&ZONE2.includes(dCity))?0:10;msg=`Pickup in Zone 2 (${cap(pCity)}) ‚Üí $${fee}`;}
  else if(inZ3){fee=(driverPos&&ZONE3.includes(dCity))?0:20;msg=`Pickup in Zone 3 (${cap(pCity)}) ‚Üí $${fee}`;}
  else{const mi=distMi(ref,{lat:pickupLatLng.lat(),lng:pickupLatLng.lng()});fee=distanceFee(mi);msg=`Unrecognized city ‚Äî ${mi.toFixed(1)} mi from ${src} ‚Üí $${fee}`;}
  document.getElementById('fairness-note').innerHTML=`${msg}<br><span style="color:#777;font-size:0.85em;">Source: ${src}</span>`;
  return fee;
}

async function useMyLocation(id){
  if(!navigator.geolocation){alert("Location not supported.");return;}
  navigator.geolocation.getCurrentPosition(async(p)=>{
    const latlng={lat:p.coords.latitude,lng:p.coords.longitude};
    const addr=await new Promise(r=>geocoder.geocode({location:latlng},(res,s)=>r((s==="OK"&&res[0])?res[0].formatted_address:`${latlng.lat},${latlng.lng}`)));
    document.getElementById(id).value=addr;
    if(id==="pickup"){pickupLatLng=new google.maps.LatLng(latlng.lat,latlng.lng);pickupCity=await reverseCity(latlng);map.setCenter(pickupLatLng);map.setZoom(12);await computeFairnessNote();}
    else{dropoffLatLng=new google.maps.LatLng(latlng.lat,latlng.lng);map.panTo(dropoffLatLng);}
  });
}

async function calculateFare(){
  const pickup=document.getElementById('pickup').value.trim();
  const dropoff=document.getElementById('dropoff').value.trim();
  if(!pickup||!dropoff){alert("Please enter both pickup and drop-off.");return;}
  const fairnessFee=await computeFairnessNote();
  const stops=[];for(const id of stopInputs){const v=document.getElementById(id)?.value.trim();if(v)stops.push({location:v,stopover:true});}
  try{
    const route=await new Promise((res,rej)=>directionsService.route({origin:pickup,destination:dropoff,waypoints:stops,travelMode:"DRIVING"},(r,s)=>{if(s==="OK")res(r);else rej(s);})); 
    const miles=route.routes[0].legs.reduce((m,l)=>m+(l.distance?.value||0),0)/1609.34;
    smartRideTypeDefault();detectAirportAndSetType();
    const tripVal=document.getElementById('tripType').value;const base=tripVal==="15_airport"?15:parseFloat(tripVal);
    let fare=base;if(miles>10&&miles<=20)fare+=(miles-10)*1.25;else if(miles>20)fare+=(10*1.25)+((miles-20)*1.0);
    fare+=(stops.length*5)+fairnessFee;
    const pay=document.getElementById('payment').value;if(pay==="card")fare+=fare*0.033+fare*0.024;
    const total=fare.toFixed(2);const payLabel=(pay==="card")?"Card (includes fees)":"Cash / Venmo / Cash App";
    const r=document.getElementById('result');
    r.innerHTML=`<div class="total">$${total}</div>
      <p><strong>Distance:</strong> ${miles.toFixed(1)} mi</p>
      <p><strong>Ride Type:</strong> $${base.toFixed(2)} base</p>
      <p><strong>Stops:</strong> ${stops.length} √ó $5 = $${(stops.length*5).toFixed(2)}</p>
      <p><strong>Travel Fairness Fee:</strong> $${fairnessFee.toFixed(2)}</p>
      <p><strong>Payment:</strong> ${payLabel}</p>`;
    r.style.display="block";
  }catch(e){alert("Could not calculate route.");console.error(e);}
}

function smartRideTypeDefault(){let v="10";const d=new Date(),day=d.getDay(),h=d.getHours();if(day>=1&&day<=5&&((h>=5&&h<10)||(h>=16&&h<19)))v="15";document.getElementById("tripType").value=v;}
function detectAirportAndSetType(){const f=[pickupPlace,dropPlace];const t=f.filter(Boolean).map(p=>(p.formatted_address||"").toLowerCase()).join(" ");const inc=["airport","airfield","air park","airpark","intl","international","regional","municipal","hangar","jet center","heliport"],exc=["tinker","afb","air force","base","ang"];if(inc.some(k=>t.includes(k))&&!exc.some(k=>t.includes(k)))document.getElementById("tripType").value="15_airport";}
document.addEventListener("DOMContentLoaded",smartRideTypeDefault);
window.initGoogle=initGoogle;
</script>
</body>
</html>
