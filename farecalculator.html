<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Fare Calculator â€“ Big Red Connect</title>

  <!-- ğŸš« No caching -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <link rel="stylesheet" href="style.css" />
  <style>
    #rushhour-note, #airport-note {
      margin-top: 10px;
      background: #111;
      border: 1px solid #ffcc00;
      border-radius: 8px;
      padding: 10px 14px;
      color: #ddd;
      text-align: center;
      font-size: 0.95em;
      animation: fadeIn 0.6s ease-in-out;
    }
    @keyframes fadeIn {
      from {opacity: 0;}
      to {opacity: 1;}
    }
  </style>
</head>
<body>

  <div class="logo-header">
    <img src="official_logo.jpeg" alt="Big Red Connect Logo" />
  </div>

  <h1>Fare Calculator</h1>
  <p class="tagline">Plan your next ride connection â€” quick, simple, and local.</p>

  <div id="status-pill" class="status status--loading">Checking statusâ€¦</div>

  <section class="info-section calculator">
    <label for="pickup">Pickup Location</label>
    <input id="pickup" type="text" placeholder="Enter pickup address or place">

    <div id="stopsWrap"></div>
    <button id="addStopBtn" class="btn primary" type="button">â• Add Stop</button>

    <label for="dropoff">Drop-off Location</label>
    <input id="dropoff" type="text" placeholder="Enter drop-off address or place">

    <div class="location-buttons">
      <button id="useLocPickup" class="btn primary" type="button">ğŸ“ Use My Location for Pickup</button>
      <button id="useLocDrop" class="btn secondary" type="button">ğŸ“ Use My Location for Drop-off</button>
    </div>

    <div id="map"></div>
    <div id="fairness-note"></div>
    <div id="rushhour-note"></div>
    <div id="airport-note"></div>

    <label for="tripType">Ride Type</label>
    <select id="tripType">
      <option value="10">Standard ($10 base)</option>
      <option value="15">Rush Hour ($15 base)</option>
      <option value="15_airport">Airport ($15 base)</option>
      <option value="20">Special Event ($20 base)</option>
    </select>

    <label for="payment">Payment Method</label>
    <select id="payment">
      <option value="cash">Cash / Venmo / Cash App (no fees)</option>
      <option value="card">Card (+3.3% booking + 2.4% fuel)</option>
    </select>

    <button class="btn primary" id="calcBtn">ğŸ’² Calculate Fare</button>

    <div id="text-red-wrapper" style="margin-top:10px;">
      <a href="sms:+14053784024?&body=Hey%20Big%20Red%20â€”%20Iâ€™d%20like%20to%20plan%20a%20ride%20connection." class="btn secondary">ğŸ“² Text RED</a>
    </div>

    <div id="result" style="display:none;"></div>
    <p class="disclaimer">*Estimates only. Final fare may vary slightly based on route or wait time.</p>
  </section>

  <footer>
    <p>&copy; 2025 Big Red Connect â€” <a href="index.html">Return to Home</a></p>
    <p style="font-size:0.8em;color:#777;margin-top:10px;line-height:1.4;">
      Vehicle imagery features actual Big Red Connect fleet vehicles.<br>
      Some backgrounds created with AI-assisted design tools for illustrative purposes only.<br>
      Brand names (ChevroletÂ® and GMCÂ®) are property of their respective owners and used descriptively.
    </p>
  </footer>

  <script src="status.js"></script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCMM0dxLNM7XQI5G3OBSnINeO5hcS3Ks5I&libraries=places,geometry&callback=initGoogle" async defer></script>

  <script>
  const HQ={lat:35.2902,lng:-97.5289};
  const WORKER_URL="https://falling-night-3e4d.bigredtransportation.workers.dev";
  let map,geocoder,directionsService,directionsRenderer;
  let pickupLatLng,dropoffLatLng,pickupPlace,dropPlace,driverPos=null;

  window.initGoogle=async function(){
    geocoder=new google.maps.Geocoder();
    directionsService=new google.maps.DirectionsService();
    directionsRenderer=new google.maps.DirectionsRenderer({suppressMarkers:true});
    map=new google.maps.Map(document.getElementById("map"),{center:{lat:35.4676,lng:-97.5164},zoom:11});
    directionsRenderer.setMap(map);

    const acPickup=new google.maps.places.Autocomplete(document.getElementById("pickup"));
    const acDrop=new google.maps.places.Autocomplete(document.getElementById("dropoff"));

    const params=new URLSearchParams(window.location.search);
    const dest=params.get("dropoff");
    if(dest){document.getElementById("dropoff").value=decodeURIComponent(dest);}

    acPickup.addListener("place_changed",async()=>{const p=acPickup.getPlace();if(!p.geometry)return;
      pickupPlace=p;pickupLatLng=p.geometry.location;map.setCenter(pickupLatLng);
      await computeFairnessNote();detectAirportAndSetType();
    });
    acDrop.addListener("place_changed",()=>{const p=acDrop.getPlace();if(p.geometry){dropPlace=p;dropoffLatLng=p.geometry.location;map.panTo(dropoffLatLng);detectAirportAndSetType();}});

    document.getElementById("useLocPickup").onclick=()=>useMyLocation("pickup");
    document.getElementById("useLocDrop").onclick=()=>useMyLocation("dropoff");
    document.getElementById("calcBtn").onclick=calculateFare;

    await getDriverLocation();
    smartRideTypeDefault(); // now includes rush-hour message
  };

  function smartRideTypeDefault(){
    const d=new Date(),day=d.getDay(),h=d.getHours();
    const tripType=document.getElementById("tripType");
    const rushMsg=document.getElementById("rushhour-note");
    if(day>=1&&day<=5&&((h>=5&&h<9)||(h>=15&&h<19))){
      tripType.value="15";
      rushMsg.innerHTML="âš¡ Rush Hour detected â€” $15 base applied automatically.";
    } else {
      rushMsg.innerHTML="";
      tripType.value="10";
    }
  }

  async function getDriverLocation(){
    const state=sessionStorage.getItem("bigred_status")||"offline";
    if(state==="online"){
      try{const r=await fetch(WORKER_URL,{cache:"no-store"});const j=await r.json();
        if(j.latitude)driverPos={lat:+j.latitude,lng:+j.longitude};
      }catch{}
    }
    if(!driverPos)driverPos=HQ;
  }

  async function computeFairnessNote(){
    if(!pickupLatLng)return 0;
    const ref=driverPos||HQ;
    const dist=google.maps.geometry.spherical.computeDistanceBetween(new google.maps.LatLng(ref.lat,ref.lng),pickupLatLng)/1609.34;
    const fee=dist<=15?0:dist<=30?10:20;
    document.getElementById("fairness-note").innerHTML=`ğŸ“ Travel Fairness Fee: $${fee.toFixed(2)} <span style="color:#777">(Distance ${dist.toFixed(1)} mi)</span>`;
    return fee;
  }

  async function useMyLocation(id){
    if(!navigator.geolocation)return alert("Location not supported.");
    navigator.geolocation.getCurrentPosition(async(p)=>{
      const latlng={lat:p.coords.latitude,lng:p.coords.longitude};
      const addr=await new Promise(r=>geocoder.geocode({location:latlng},(res,s)=>r((s==="OK"&&res[0])?res[0].formatted_address:"")));
      document.getElementById(id).value=addr;
      if(id==="pickup"){pickupLatLng=new google.maps.LatLng(latlng.lat,latlng.lng);await computeFairnessNote();}
      else{dropoffLatLng=new google.maps.LatLng(latlng.lat,latlng.lng);map.panTo(dropoffLatLng);}
    });
  }

  async function calculateFare(){
    const pickup=document.getElementById("pickup").value.trim();
    const dropoff=document.getElementById("dropoff").value.trim();
    if(!pickup||!dropoff)return alert("Please enter both pickup and drop-off.");
    const fairnessFee=await computeFairnessNote();

    const route=await new Promise((res,rej)=>directionsService.route({origin:pickup,destination:dropoff,travelMode:"DRIVING"},(r,s)=>s==="OK"?res(r):rej(s)));
    const miles=route.routes[0].legs.reduce((m,l)=>m+(l.distance?.value||0),0)/1609.34;

    smartRideTypeDefault();
    detectAirportAndSetType();

    const val=document.getElementById("tripType").value;
    const base=(val==="15_airport")?15:parseFloat(val);
    let fare=base;
    if(miles>10&&miles<=20)fare+=(miles-10)*1.25;
    else if(miles>20)fare+=(10*1.25)+((miles-20)*1.0);
    fare+=fairnessFee;

    const pay=document.getElementById("payment").value;
    if(pay==="card")fare+=fare*0.033+fare*0.024;

    const total=fare.toFixed(2);
    const smsBody=encodeURIComponent(`Hey Big Red â€” I'm heading from ${pickup} to ${dropoff}. Estimated $${total} flat rate.`);
    document.getElementById("result").innerHTML=`
      <div class="total">$${total}</div>
      <p><strong>Distance:</strong> ${miles.toFixed(1)} mi</p>
      <p><strong>Base Rate:</strong> $${base.toFixed(2)}</p>
      <p><strong>Travel Fairness Fee:</strong> $${fairnessFee.toFixed(2)}</p>
      <p><strong>Payment:</strong> ${pay==="card"?"Card (includes fees)":"Cash / Venmo / Cash App"}</p>
      <p style="text-align:center;margin-top:15px;">
        <a href="sms:+14053784024?&body=${smsBody}" class="btn primary">ğŸ“² Text RED with Trip Details</a>
      </p>`;
    document.getElementById("result").style.display="block";
  }

  function detectAirportAndSetType(){
    const text=[
      document.getElementById("pickup").value.toLowerCase(),
      document.getElementById("dropoff").value.toLowerCase()
    ].join(" ");
    const include=["airport","intl","international","regional","municipal","jet","hangar","airfield","airpark"];
    const exclude=["tinker","afb","air force","base","ang"];
    const msg=document.getElementById("airport-note");
    if(include.some(k=>text.includes(k))&&!exclude.some(k=>text.includes(k))){
      document.getElementById("tripType").value="15_airport";
      msg.innerHTML="âœˆï¸ Airport ride detected â€” $15 base applied automatically.";
    } else msg.innerHTML="";
  }
  </script>
</body>
</html>
