<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Ride Request â€“ Big Red Connect</title>

<!-- Icons -->
<link rel="apple-touch-icon" href="icon.png">
<link rel="icon" href="icon.png">
<link rel="manifest" href="manifest.json">

<!-- Disable Cache -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />

<link rel="stylesheet" href="style.css" />

<!-- OneSignal SDK -->
<script src="https://cdn.onesignal.com/sdks/OneSignalSDK.js" async></script>

<!-- Google Maps -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCMM0dxLNM7XQI5G3OBSnINeO5hcS3Ks5I&libraries=places,geometry&callback=initGoogle" async defer></script>

<style>
/* minimal fixes to ensure UI stability */
input, select {
  width:100%;
  padding:10px;
  margin:5px 0 10px;
}
.btn.primary {
  width:100%;
  margin-top:10px;
}
</style>
</head>

<body>

<div class="logo-header">
  <a href="index.html"><img src="official_logo_Nov.png"></a>
</div>

<h1>Fare Calculator</h1>
<p class="tagline">Plan your connection â€” flat rate, local, and predictable.</p>

<div id="status-pill" class="status">Checking statusâ€¦</div>

<section class="info-section calculator">

  <!-- Mode -->
  <div class="ride-mode-toggle">
    <button id="modeNow" class="btn btn-toggle active">ğŸš— Ride Now</button>
    <button id="modeReserve" class="btn btn-toggle">ğŸ•’ Reserve Ride</button>
  </div>

  <!-- Reserve fields -->
  <div id="reserveControls" style="display:none;">
    <label>Date</label>
    <input id="reserveDate" type="date">
    <label>Time</label>
    <input id="reserveTime" type="time">
    <label>Plan By</label>
    <select id="planBy">
      <option value="pickup">Pickup Time</option>
      <option value="dropoff">Drop-off Time</option>
    </select>
  </div>

  <label>Pickup</label>
  <input id="pickup" placeholder="Enter pickup">
  <button id="useLocPickup" class="btn primary">ğŸ“ Use My Location for Pickup</button>

  <div id="stopsWrap"></div>
  <button id="addStopBtn" class="btn primary">â• Add Stop</button>

  <label>Drop-off</label>
  <input id="dropoff" placeholder="Enter drop-off">
  <button id="useLocDrop" class="btn secondary">ğŸ“ Use My Location for Drop-off</button>

  <div id="map" style="height:240px;margin-top:10px;border-radius:8px;"></div>

  <div id="airport-note"></div>
  <div id="event-note"></div>
  <div id="rushhour-note"></div>
  <div id="fairness-note"></div>

  <label>Payment Method</label>
  <select id="payment">
    <option value="cash">Cash / Venmo / Cash App</option>
    <option value="card">Card (+3.3% + 2.4%)</option>
  </select>

  <button id="calcBtn" class="btn primary">ğŸ’² Calculate Fare</button>

  <div id="result" style="display:none;"></div>
</section>

<footer>
  Â© 2025 Big Red Connect
</footer>

<script>
/* ======================================================
   GLOBAL CONFIG
====================================================== */
const API_BASE = "https://bigred-bookings.bigredtransportation.workers.dev";

let mode = "now";
let map, geocoder, directionsService, directionsRenderer;
let pickupLatLng = null, dropLatLng = null;

/* ======================================================
   ONE SIGNAL â€” RIDER LOGIN (ONLY AFTER BOOKING CREATED)
====================================================== */
window.OneSignal = window.OneSignal || [];
OneSignal.push(function(){
  OneSignal.init({
    appId:"64641a89-3619-4491-a25b-c0ab000bdfe0",
    allowLocalhostAsSecureOrigin:true,
    notifyButton:{ enable:false }
  });
});

/* ======================================================
   MODE SWITCH
====================================================== */
document.addEventListener("DOMContentLoaded",()=>{
  document.getElementById("modeNow").onclick = ()=>setMode("now");
  document.getElementById("modeReserve").onclick = ()=>setMode("reserve");
  document.getElementById("calcBtn").onclick = calculateFare;
  document.getElementById("addStopBtn").onclick = addStop;
  document.getElementById("useLocPickup").onclick = ()=>useLoc("pickup");
  document.getElementById("useLocDrop").onclick = ()=>useLoc("dropoff");
});

function setMode(m){
  mode = m;
  const now = document.getElementById("modeNow");
  const res = document.getElementById("modeReserve");
  const ctrl = document.getElementById("reserveControls");

  if(m==="now"){
    now.classList.add("active");
    res.classList.remove("active");
    ctrl.style.display="none";
  }
  else {
    res.classList.add("active");
    now.classList.remove("active");
    ctrl.style.display="block";
  }
}

/* ======================================================
   GOOGLE MAPS INIT
====================================================== */
window.initGoogle = function(){
  geocoder = new google.maps.Geocoder();
  directionsService = new google.maps.DirectionsService();
  directionsRenderer = new google.maps.DirectionsRenderer({ suppressMarkers:true });

  map = new google.maps.Map(document.getElementById("map"), {
    center:{lat:35.4676,lng:-97.5164},
    zoom:11
  });
  directionsRenderer.setMap(map);

  const ac1 = new google.maps.places.Autocomplete(document.getElementById("pickup"));
  const ac2 = new google.maps.places.Autocomplete(document.getElementById("dropoff"));

  ac1.addListener("place_changed",()=>{
    const p = ac1.getPlace();
    if(p.geometry){
      pickupLatLng = p.geometry.location;
      map.setCenter(p.geometry.location);
    }
  });

  ac2.addListener("place_changed",()=>{
    const p = ac2.getPlace();
    if(p.geometry){
      dropLatLng = p.geometry.location;
      map.setCenter(p.geometry.location);
    }
  });
};

/* ======================================================
   ADD STOP
====================================================== */
function addStop(){
  if(!window.stopInputs) window.stopInputs=[];
  if(window.stopInputs.length>=3){
    alert("Max 3 stops allowed.");
    return;
  }
  const id = "stop"+Date.now();
  window.stopInputs.push(id);

  const div = document.createElement("div");
  div.innerHTML = `
    <input id="${id}" placeholder="Stop address">
  `;
  document.getElementById("stopsWrap").appendChild(div);

  new google.maps.places.Autocomplete(document.getElementById(id));
}

/* ======================================================
   USE MY LOCATION
====================================================== */
function useLoc(field){
  if(!navigator.geolocation){ alert("Location not available."); return; }

  navigator.geolocation.getCurrentPosition(async pos=>{
    const latlng = { lat:pos.coords.latitude, lng:pos.coords.longitude };
    const input = document.getElementById(field);

    geocoder.geocode({location:latlng},(res,stat)=>{
      if(stat==="OK" && res[0]){
        input.value = res[0].formatted_address;
      } else {
        input.value = `${latlng.lat}, ${latlng.lng}`;
      }

      if(field==="pickup") pickupLatLng = new google.maps.LatLng(latlng.lat,latlng.lng);
      if(field==="dropoff") dropLatLng = new google.maps.LatLng(latlng.lat,latlng.lng);
    });
  });
}

/* ======================================================
   CALCULATE FARE (CORE)
====================================================== */
async function calculateFare(){
  const pickup = document.getElementById("pickup").value.trim();
  const dropoff = document.getElementById("dropoff").value.trim();
  if(!pickup || !dropoff){
    alert("Enter pickup & dropoff.");
    return;
  }

  // Resolve coords if missing
  if(!pickupLatLng) await geocodePickup();
  if(!dropLatLng) await geocodeDrop();

  // Build stops
  const stops=[];
  for(const id of (window.stopInputs||[])){
    const v=document.getElementById(id)?.value.trim();
    if(v) stops.push({location:v,stopover:true});
  }

  // Route
  const route = await new Promise((res,rej)=>{
    directionsService.route({
      origin:pickup,
      destination:dropoff,
      waypoints:stops,
      travelMode:"DRIVING"
    },(r,s)=>s==="OK"?res(r):rej(s));
  });

  directionsRenderer.setDirections(route);
  const legs = route.routes[0].legs;

  const miles = Math.round(legs.reduce((t,l)=>t+(l.distance.value||0),0)/1609.34);
  const mins = Math.round(legs.reduce((t,l)=>t+(l.duration.value||0),0)/60);

  // Determine base (holiday + airport + reserve-time logic)
  const isAirport = (pickup+dropoff).toLowerCase().includes("airport");

  let base = 10;
  if(isAirport) base = 15;

  const pay = document.getElementById("payment").value;

  // reservation scheduled time logic
  let when = new Date();
  if(mode==="reserve"){
    const d = document.getElementById("reserveDate").value;
    const t = document.getElementById("reserveTime").value;
    if(d && t) when = new Date(`${d}T${t}`);
  }

  // Rush hour
  const h = when.getHours();
  const dow = when.getDay();
  const rush = (dow>=1&&dow<=5) && ((h>=5&&h<9)||(h>=15&&h<19));
  if(rush && !isAirport) base = 15;

  // Holiday surcharge
  const holiday = isHoliday(when);
  if(holiday) base = 20;

  // Mileage tiers
  const tier2 = Math.min(10,Math.max(0,miles-10))*1.25;
  const tier3 = Math.max(0,miles-20)*1.0;
  const mileageComponent = tier2+tier3;

  let total = base + mileageComponent;

  if(pay==="card"){
    total += total*0.033 + total*0.024;
  }

  total = parseFloat(total.toFixed(2));

  window.lastQuote = {
    mode, pickup, dropoff,
    stops:stops.map(s=>s.location),
    miles, minutes:mins,
    base, mileageComponent,
    payMethod:pay,
    total,
    isAirport,
    reserveDate: document.getElementById("reserveDate").value||null,
    reserveTime: document.getElementById("reserveTime").value||null,
    planBy: document.getElementById("planBy").value||"pickup"
  };

  showResult(total);
}

function isHoliday(d){
  const mmdd = (d.getMonth()+1)+"-"+d.getDate();
  const holidays = ["1-1","7-4","12-24","12-25","12-31","11-27"]; // example
  return holidays.includes(mmdd);
}

async function geocodePickup(){
  return new Promise(res=>{
    const val=document.getElementById("pickup").value.trim();
    geocoder.geocode({address:val},(r,s)=>{
      if(s==="OK"&&r[0]) pickupLatLng = r[0].geometry.location;
      res();
    });
  });
}

async function geocodeDrop(){
  return new Promise(res=>{
    const val=document.getElementById("dropoff").value.trim();
    geocoder.geocode({address:val},(r,s)=>{
      if(s==="OK"&&r[0]) dropLatLng = r[0].geometry.location;
      res();
    });
  });
}

/* ======================================================
   DISPLAY RESULT + LOAD SEND BUTTON
====================================================== */
function showResult(total){
  const div = document.getElementById("result");
  const btnLabel = mode==="reserve"
    ? "ğŸ•’ Send Reservation Request"
    : "ğŸš— Send Ride Request";

  div.innerHTML = `
    <div class="total">$${total}</div>

    <button id="sendBtn" class="btn primary">${btnLabel}</button>
  `;
  div.style.display="block";

  document.getElementById("sendBtn").onclick = buildAndSubmitBooking;
}

/* ======================================================
   BUILD BOOKING + SUBMIT TO WORKER
====================================================== */
async function buildAndSubmitBooking(){
  const q = window.lastQuote;
  if(!q){ alert("Calculate first."); return; }

  // GET PARTY SIZE
  let party = prompt("How many passengers?", "1");
  if(!party || isNaN(party)) party = 1;

  let scheduledFor = null;
  if(q.mode==="reserve" && q.reserveDate && q.reserveTime){
    scheduledFor = new Date(`${q.reserveDate}T${q.reserveTime}:00`).toISOString();
  }

  const payload = {
    type: scheduledFor ? "RESERVATION" : "INSTANT",
    pickup:{ address:q.pickup, notes:"" },
    dropoff:{ address:q.dropoff, notes:"" },
    stops: q.stops.map(s=>({address:s})),

    rider:{ name:"", phone:"", partySize:Number(party) },

    pricing:{
      estimate:q.total,
      finalFare:null,
      travelFee:0,
      ratePlan: q.isAirport ? "AIRPORT" :
              isHoliday(scheduledFor?new Date(scheduledFor):new Date()) ? "HOLIDAY" :
              q.mode==="reserve" && isRush(scheduledFor?new Date(scheduledFor):new Date()) ? "RUSH_HOUR" :
              "STANDARD"
    },

    metrics:{ miles:q.miles, minutes:q.minutes },
    source:"FARE_CALCULATOR",
    scheduledFor
  };

  const res = await fetch(`${API_BASE}/api/bookings`,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify(payload)
  });

  if(!res.ok){
    alert("Error sending request.");
    return;
  }

  const created = await res.json();
  const id = created.id;

  // Login rider to OneSignal
  OneSignal.login("ride-"+id);

  // Redirect to MyRide
  window.location.href = `myride.html?id=${id}`;
}

function isRush(d){
  const h=d.getHours(), dow=d.getDay();
  return (dow>=1&&dow<=5) && ((h>=5&&h<9)||(h>=15&&h<19));
}

</script>
</body>
</html>