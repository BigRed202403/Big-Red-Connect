<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Fare Calculator ‚Äì Big Red Connect</title>
  <link rel="stylesheet" href="/Big-Red-Connect/style.css" />
</head>
<body>

  <!-- üöó Logo Header -->
  <div class="logo-header">
    <img src="/Big-Red-Connect/images/official_logo.jpeg" alt="Big Red Connect Logo" />
  </div>

  <!-- üè∑Ô∏è Header -->
  <h1>Fare Calculator</h1>
  <p class="tagline">Plan your next ride connection ‚Äî quick, simple, and local.</p>

  <!-- üü¢ Status Pill -->
  <div id="status-pill" class="status status--loading">Checking status‚Ä¶</div>

  <!-- üßÆ Fare Calculator -->
  <section class="info-section calculator">
    <label for="pickup">Pickup Location</label>
    <input id="pickup" type="text" placeholder="Enter pickup address or place">

    <div id="stopsWrap"></div>
    <button id="addStopBtn" class="btn primary" type="button">‚ûï Add Stop</button>

    <label for="dropoff">Drop-off Location</label>
    <input id="dropoff" type="text" placeholder="Enter drop-off address or place">

    <div class="location-buttons">
      <button id="useLocPickup" class="btn primary" type="button">üìç Use My Location for Pickup</button>
      <button id="useLocDrop" class="btn secondary" type="button">üìç Use My Location for Drop-off</button>
    </div>

    <div id="map" style="height:260px;border:2px solid #c40000;border-radius:10px;margin-top:12px;"></div>
    <div id="fairness-note" style="color:#ccc;font-size:0.9em;margin-top:8px;"></div>
    <div id="airport-note" style="color:#ffcc00;font-size:0.9em;margin-top:4px;"></div>

    <label for="tripType">Ride Type</label>
    <select id="tripType">
      <option value="10">Standard ($10 base)</option>
      <option value="15">Rush Hour ($15 base)</option>
      <option value="15_airport">Airport ($15 base)</option>
      <option value="20">Special Event ($20 base)</option>
    </select>

    <label for="payment">Payment Method</label>
    <select id="payment">
      <option value="cash">Cash / Venmo / Cash App (no fees)</option>
      <option value="card">Card (+3.3% booking + 2.4% fuel)</option>
    </select>

    <button class="btn primary" id="calcBtn">üí≤ Calculate Fare</button>

    <div id="result" style="display:none;"></div>

    <p class="disclaimer">*Estimates only. Final fare may vary slightly based on route or wait time.</p>
  </section>

  <!-- ü¶∂ Footer -->
  <footer>
    <p>&copy; 2025 Big Red Connect ‚Äî <a href="/Big-Red-Connect/index.html">Return to Home</a></p>
    <p style="font-size:0.8em;color:#777;margin-top:10px;line-height:1.4;">
      Vehicle imagery features actual Big Red Connect fleet vehicles.<br>
      Some backgrounds created with AI-assisted design tools for illustrative purposes only.<br>
      Brand names (Chevrolet¬Æ and GMC¬Æ) are property of their respective owners and used descriptively.
    </p>
  </footer>

  <script src="/Big-Red-Connect/status.js"></script>

  <script>
  const HQ = { lat: 35.2902, lng: -97.5289 };
  let map, geocoder, directionsService, pickupLatLng = null, dropoffLatLng = null;
  let stopInputs = [], markers = [];

  // ‚úÖ Initialize Google Maps
  window.initGoogle = async function() {
    geocoder = new google.maps.Geocoder();
    directionsService = new google.maps.DirectionsService();
    map = new google.maps.Map(document.getElementById('map'), {
      center: { lat: 35.4676, lng: -97.5164 },
      zoom: 11,
      mapTypeControl: false,
      streetViewControl: false
    });

    const acPickup = new google.maps.places.Autocomplete(document.getElementById('pickup'));
    const acDrop = new google.maps.places.Autocomplete(document.getElementById('dropoff'));

    // Prefill from homepage
    const params = new URLSearchParams(window.location.search);
    const dest = params.get('dropoff');
    if (dest) document.getElementById('dropoff').value = decodeURIComponent(dest);

    // Optionally auto-detect pickup on page load
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(p => {
        const loc = { lat: p.coords.latitude, lng: p.coords.longitude };
        document.getElementById("pickup").value = "My current location";
        pickupLatLng = new google.maps.LatLng(loc.lat, loc.lng);
        map.setCenter(loc);
        map.setZoom(12);
        computeFairnessNote(pickupLatLng);
      });
    }

    // Autocomplete listeners
    acPickup.addListener('place_changed', () => {
      const p = acPickup.getPlace();
      if (!p.geometry) return;
      pickupLatLng = p.geometry.location;
      map.setCenter(pickupLatLng);
      addMarker(pickupLatLng, "#ff4444");
      computeFairnessNote(pickupLatLng);
    });

    acDrop.addListener('place_changed', () => {
      const p = acDrop.getPlace();
      if (!p.geometry) return;
      dropoffLatLng = p.geometry.location;
      map.setCenter(dropoffLatLng);
      addMarker(dropoffLatLng, "#ffffff");
      detectAirportAndSetType(p);
    });

    // Button hooks
    document.getElementById('useLocPickup').onclick = () => useMyLocation('pickup');
    document.getElementById('useLocDrop').onclick = () => useMyLocation('dropoff');
    document.getElementById('addStopBtn').onclick = addStopField;
    document.getElementById('calcBtn').onclick = calculateFare;
  };

  // ‚úÖ Add stop field
  function addStopField() {
    if (stopInputs.length >= 3) return alert("Limit 3 stops.");
    const id = `stop_${Date.now()}`;
    stopInputs.push(id);
    const wrap = document.getElementById('stopsWrap');
    const div = document.createElement('div');
    div.innerHTML = `<label for="${id}">Stop ${stopInputs.length}:</label>
      <input id="${id}" type="text" placeholder="Enter stop address or place" style="width:100%;margin-bottom:10px;">`;
    wrap.appendChild(div);
    new google.maps.places.Autocomplete(document.getElementById(id));
  }

  // ‚úÖ Add map markers
  function addMarker(latlng, color) {
    const marker = new google.maps.Marker({
      position: latlng,
      map: map,
      icon: {
        path: google.maps.SymbolPath.CIRCLE,
        scale: 8,
        fillColor: color,
        fillOpacity: 1,
        strokeWeight: 2,
        strokeColor: "#000"
      }
    });
    markers.push(marker);
  }

  // ‚úÖ Use My Location
  function useMyLocation(id) {
    if (!navigator.geolocation) return alert("Geolocation not supported.");
    navigator.geolocation.getCurrentPosition(pos => {
      const loc = { lat: pos.coords.latitude, lng: pos.coords.longitude };
      geocoder.geocode({ location: loc }, (res, stat) => {
        if (stat === "OK" && res[0]) {
          document.getElementById(id).value = res[0].formatted_address;
          map.setCenter(loc);
          map.setZoom(12);
          addMarker(loc, id === "pickup" ? "#ff4444" : "#ffffff");
          if (id === "pickup") computeFairnessNote(new google.maps.LatLng(loc.lat, loc.lng));
        }
      });
    });
  }

  // ‚úÖ Travel Fairness Fee
  function computeFairnessNote(latlng) {
    if (!latlng) return;
    const distMi = google.maps.geometry.spherical.computeDistanceBetween(
      new google.maps.LatLng(HQ.lat, HQ.lng),
      latlng
    ) / 1609.34;
    let fee = 0, msg = "";
    if (distMi <= 15) msg = `Pickup within local area ‚Äî no travel fee.`;
    else if (distMi <= 30) { fee = 10; msg = `Pickup ~${distMi.toFixed(1)} mi from HQ ‚Üí $${fee} travel fee.`; }
    else { fee = 20; msg = `Pickup ~${distMi.toFixed(1)} mi from HQ ‚Üí $${fee} travel fee.`; }
    document.getElementById("fairness-note").innerHTML = msg;
    document.getElementById("fairness-note").dataset.fee = fee;
  }

  // ‚úÖ Airport detection
  function detectAirportAndSetType(place) {
    const combined = (place.formatted_address + " " + (place.name || "")).toLowerCase();
    const include = ["airport","intl","international","jet","hangar"];
    const exclude = ["tinker","afb","base","air force"];
    if (include.some(k => combined.includes(k)) && !exclude.some(k => combined.includes(k))) {
      document.getElementById("tripType").value = "15_airport";
      document.getElementById("airport-note").innerHTML = "‚úàÔ∏è Airport ride detected ‚Äî $15 base applied automatically.";
    } else {
      document.getElementById("airport-note").innerHTML = "";
    }
  }

  // ‚úÖ Calculate full fare
  function calculateFare() {
    const pickup = document.getElementById("pickup").value.trim();
    const dropoff = document.getElementById("dropoff").value.trim();
    if (!pickup || !dropoff) return alert("Please enter both pickup and drop-off.");

    const fairnessFee = parseFloat(document.getElementById("fairness-note").dataset.fee || 0);
    const stops = stopInputs.map(id => document.getElementById(id).value.trim()).filter(v => v);
    const req = { origin: pickup, destination: dropoff, waypoints: stops.map(s => ({location: s, stopover:true})), travelMode: "DRIVING" };

    directionsService.route(req, (result, status) => {
      if (status !== "OK") return alert("Could not calculate route.");

      const miles = result.routes[0].legs.reduce((sum, leg) => sum + leg.distance.value, 0) / 1609.34;
      const tripVal = document.getElementById("tripType").value;
      const base = tripVal === "15_airport" ? 15 : parseFloat(tripVal);
      let fare = base;
      if (miles > 10 && miles <= 20) fare += (miles - 10) * 1.25;
      else if (miles > 20) fare += (10 * 1.25) + ((miles - 20) * 1.00);
      fare += (stops.length * 5) + fairnessFee;

      const payment = document.getElementById("payment").value;
      if (payment === "card") fare += fare * 0.033 + fare * 0.024;
      const total = fare.toFixed(2);

      const smsBody = encodeURIComponent(`Hey Big Red ‚Äî I'm going from ${pickup} to ${dropoff}. Est. $${total} flat rate (${miles.toFixed(1)} mi).`);
      document.getElementById("result").innerHTML = `
        <div class="total">$${total}</div>
        <p><strong>Base Fare:</strong> $${base.toFixed(2)}</p>
        <p><strong>Distance:</strong> ${miles.toFixed(1)} mi</p>
        <p><strong>Stops:</strong> ${stops.length} √ó $5 = $${(stops.length * 5).toFixed(2)}</p>
        <p><strong>Travel Fairness Fee:</strong> $${fairnessFee}</p>
        <p><strong>Payment:</strong> ${payment === "card" ? "Card (includes fees)" : "Cash / Venmo / Cash App"}</p>
        <p style="text-align:center;margin-top:10px;">
          <a href="sms:+14053784024?&body=${smsBody}" class="btn primary">üì≤ Text RED with Trip Details</a>
        </p>`;
      document.getElementById("result").style.display = "block";
    });
  }
  </script>

  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCMM0dxLNM7XQI5G3OBSnINeO5hcS3Ks5I&libraries=places,geometry&callback=initGoogle" async defer></script>
</body>
</html>
