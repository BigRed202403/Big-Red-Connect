<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Fare Calculator ‚Äì Big Red Connect</title>

  <!-- No cache -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <link rel="stylesheet" href="style.css" />

  <!-- Google Maps -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCMM0dxLNM7XQI5G3OBSnINeO5hcS3Ks5I&libraries=places,geometry&callback=initGoogle" async defer></script>
</head>
<body>

  <div class="logo-header">
    <a href="index.html" title="Return to Home">
      <img src="official_logo.jpeg" alt="Big Red Connect Logo" style="cursor:pointer;" />
    </a>
  </div>

  <h1>Fare Calculator</h1>
  <p class="tagline">Plan your next ride connection ‚Äî quick, simple, and local.</p>

  <div id="status-pill" class="status">Checking status‚Ä¶</div>

  <section class="info-section calculator">

    <!-- Ride mode toggle -->
    <div class="ride-mode-toggle" aria-label="Choose ride mode">
      <button id="modeNow" class="btn btn-toggle active" type="button">üöó Ride Now</button>
      <button id="modeReserve" class="btn btn-toggle" type="button">üïí Reserve Ride</button>
    </div>

    <!-- Reserve controls -->
    <div id="reserveControls" style="display:none;">
      <label for="reserveDate">Date</label>
      <input id="reserveDate" type="date" />
      <label for="reserveTime">Time</label>
      <input id="reserveTime" type="time" />
      <label for="planBy">Plan By</label>
      <select id="planBy">
        <option value="pickup">Pickup Time</option>
        <option value="dropoff">Drop-Off Time</option>
      </select>
      <div id="reserveHint" style="color:#ccc;font-size:0.9em;margin:6px 0 10px;">
        Choose a date/time. Rush hour will auto-apply if the pickup falls on a weekday 5‚Äì9 AM or 3‚Äì7 PM.
      </div>
    </div>

    <label for="pickup">Pickup Location</label>
    <input id="pickup" type="text" placeholder="Enter pickup address or place" />

    <div id="stopsWrap"></div>
    <button id="addStopBtn" class="btn primary" type="button">‚ûï Add Stop</button>

    <label for="dropoff">Drop-off Location</label>
    <input id="dropoff" type="text" placeholder="Enter drop-off address or place" />

    <div class="location-buttons">
      <button id="useLocPickup" class="btn primary" type="button">üìç Use My Location for Pickup</button>
      <button id="useLocDrop" class="btn secondary" type="button">üìç Use My Location for Drop-off</button>
    </div>

    <div id="map" style="height:250px;margin-top:15px;border-radius:10px;"></div>
    <div id="fairness-note"></div>
    <div id="airport-note"></div>
    <div id="event-note" style="color:#ffcc00;"></div>
    <div id="rushhour-note"></div>

    <!-- Hidden auto-populated ride type -->
    <select id="tripType" style="display:none;">
      <option value="10">Standard</option>
      <option value="15">Rush Hour</option>
      <option value="15_airport">Airport</option>
      <option value="20">Special Event</option>
    </select>

    <label for="payment">Payment Method</label>
    <select id="payment">
      <option value="cash">Cash / Venmo / Cash App (no fees)</option>
      <option value="card">Card (+3.3% booking + 2.4% fuel)</option>
    </select>

    <button class="btn primary" id="calcBtn" style="display:block;margin:20px auto;">üí≤ Calculate Fare</button>

    <div id="text-red-wrapper" style="margin-top:10px;text-align:center;">
      <a href="sms:+14053784024?&body=Hey Big Red ‚Äî I‚Äôd like to plan a ride connection." class="btn secondary">üì≤ Text RED</a>
    </div>

    <div id="result" style="display:none;"></div>
    <p class="disclaimer">*Estimates only. Final fare may vary slightly based on route or wait time.</p>
  </section>

  <footer>
    <p>&copy; 2025 Big Red Connect ‚Äî <a href="index.html">Return to Home</a></p>
  </footer>

  <script>
  const HQ={lat:35.3207,lng:-97.4929};
  const WORKER_URL="https://update-location.bigredtransportation.workers.dev";
  const STALE_MINUTES=30;
  let EVENT_KEYWORDS=[
    "paycom center","riverwind casino","lucky star casino",
    "gaylord family oklahoma memorial stadium","boone pickens stadium",
    "chickasaw bricktown ballpark","ou stadium","osu stadium"
  ];

  async function loadEventVenues(){
    try{
      const r=await fetch("special-venues.json?nocache="+Date.now());
      if(!r.ok)throw new Error("HTTP "+r.status);
      const j=await r.json();
      if(Array.isArray(j.keywords)&&j.keywords.length>0){
        EVENT_KEYWORDS=j.keywords.map(v=>v.toLowerCase());
        console.log("‚úÖ Event venues loaded:",EVENT_KEYWORDS.length);
      }
    }catch(e){console.warn("‚ö†Ô∏è Using fallback event list:",e);}
  }
  loadEventVenues();

  let map,geocoder,directionsService,directionsRenderer;
  let pickupLatLng=null,dropoffLatLng=null,pickupPlace=null,dropPlace=null;
  let driverPos=null,mode="now",stopInputs=[];

  function isValidCoords(o){return o&&typeof o.lat==="number"&&typeof o.lng==="number"&&!isNaN(o.lat)&&!isNaN(o.lng);}
  function distMi(a,b){return google.maps.geometry.spherical.computeDistanceBetween(new google.maps.LatLng(a.lat,a.lng),new google.maps.LatLng(b.lat,b.lng))/1609.34;}
  function weekdayRushHour(d){const h=d.getHours(),wd=d.getDay();return wd>=1&&wd<=5&&((h>=5&&h<9)||(h>=15&&h<19));}

  window.initGoogle=async function(){
    geocoder=new google.maps.Geocoder();
    directionsService=new google.maps.DirectionsService();
    directionsRenderer=new google.maps.DirectionsRenderer({suppressMarkers:true});
    map=new google.maps.Map(document.getElementById('map'),{center:{lat:35.4676,lng:-97.5164},zoom:11});
    directionsRenderer.setMap(map);

    const acP=new google.maps.places.Autocomplete(document.getElementById('pickup'));
    const acD=new google.maps.places.Autocomplete(document.getElementById('dropoff'));

    acP.addListener('place_changed',async()=>{
      const p=acP.getPlace();if(!p.geometry)return;
      pickupPlace=p;pickupLatLng=p.geometry.location;
      new google.maps.Marker({position:pickupLatLng,map,label:"P"});
      detectRideType();
    });
    acD.addListener('place_changed',()=>{
      const p=acD.getPlace();if(p.geometry){
        dropPlace=p;dropoffLatLng=p.geometry.location;
        new google.maps.Marker({position:dropoffLatLng,map,label:"D"});
        detectRideType();
      }
    });

    document.getElementById("modeNow").onclick=()=>setMode("now");
    document.getElementById("modeReserve").onclick=()=>setMode("reserve");
    document.getElementById("calcBtn").onclick=calculateFare;
    document.getElementById("addStopBtn").onclick=addStopField;
    document.getElementById("useLocPickup").onclick=()=>useMyLocation("pickup");
    document.getElementById("useLocDrop").onclick=()=>useMyLocation("dropoff");
    await getDriverLocation();
  };

  function setMode(m){
    mode=m;
    document.getElementById("modeNow").classList.toggle("active",m==="now");
    document.getElementById("modeReserve").classList.toggle("active",m==="reserve");
    document.getElementById("reserveControls").style.display=m==="reserve"?"block":"none";
  }

  async function getDriverLocation(){
    try{
      const r=await fetch(WORKER_URL,{cache:"no-store"});
      const j=await r.json();
      const lat=parseFloat(j.latitude),lng=parseFloat(j.longitude);
      const t=j.timestamp?new Date(j.timestamp):null;
      const age=t?(Date.now()-t.getTime())/60000:999;
      if(!isNaN(lat)&&!isNaN(lng)&&age<=STALE_MINUTES&&lat>34&&lat<37&&lng>-99&&lng<-94)
        driverPos={lat,lng};else driverPos=HQ;
    }catch{driverPos=HQ;}
  }

  function calcFairnessFee(total,ref,pLL){
    if(!pLL||!ref)return 0;if(total>=35)return 0;
    const d=distMi(ref,{lat:pLL.lat(),lng:pLL.lng()});
    return d>35?20:(d>15?10:0);
  }

  async function detectRideType(){
    document.getElementById("airport-note").innerHTML="";
    document.getElementById("event-note").innerHTML="";
    if(!pickupPlace&&!dropPlace)return;
    const combined=((pickupPlace?.name||"")+pickupPlace?.formatted_address||"")+((dropPlace?.name||"")+dropPlace?.formatted_address||"");
    const c=combined.toLowerCase();

    if(c.includes("airport")&&!c.includes("tinker")){
      document.getElementById("tripType").value="15_airport";
      document.getElementById("airport-note").innerHTML="‚úàÔ∏è Airport ride detected ‚Äî $15 base applied automatically.";
    }else if(EVENT_KEYWORDS.some(k=>c.includes(k))){
      document.getElementById("tripType").value="20";
      document.getElementById("event-note").innerHTML="üéüÔ∏è Special event ride detected ‚Äî $20 base applied.";
    }else{
      const now=new Date();
      if(weekdayRushHour(now)){
        document.getElementById("tripType").value="15";
        document.getElementById("rushhour-note").innerHTML="üö¶ Weekday Rush Hour pricing (5‚Äì9 AM / 3‚Äì7 PM)";
      }else {
        document.getElementById("tripType").value="10";
        document.getElementById("rushhour-note").innerHTML="";
      }
    }
  }

  async function useMyLocation(id){
    if(!navigator.geolocation){alert("Location not supported.");return;}
    navigator.geolocation.getCurrentPosition(async(p)=>{
      const latlng={lat:p.coords.latitude,lng:p.coords.longitude};
      const addr=await new Promise(r=>geocoder.geocode({location:latlng},(res,s)=>r((s==="OK"&&res[0])?res[0].formatted_address:`${latlng.lat},${latlng.lng}`)));
      document.getElementById(id).value=addr;
      if(id==="pickup")pickupLatLng=new google.maps.LatLng(latlng.lat,latlng.lng);
      else dropoffLatLng=new google.maps.LatLng(latlng.lat,latlng.lng);
      detectRideType();
    });
  }

  async function calculateFare(){
    const pickup=document.getElementById('pickup').value.trim();
    const dropoff=document.getElementById('dropoff').value.trim();
    if(!pickup||!dropoff){alert("Please enter both pickup and drop-off.");return;}

    const route=await new Promise((res,rej)=>directionsService.route({
      origin:pickup,destination:dropoff,travelMode:"DRIVING"
    },(r,s)=>s==="OK"?res(r):rej(s)));
    directionsRenderer.setDirections(route);
    const legs=route.routes[0].legs;
    const miles=legs.reduce((m,l)=>m+(l.distance?.value||0),0)/1609.34;
    const mins=legs.reduce((t,l)=>t+(l.duration?.value||0),0)/60;

    await getDriverLocation();
    const ref=isValidCoords(driverPos)?driverPos:HQ;
    const fair=calcFairnessFee(miles,ref,pickupLatLng);
    const tripVal=document.getElementById('tripType').value;
    const base=(tripVal==="15_airport")?15:parseFloat(tripVal);
    const tier2=Math.max(0,Math.min(10,miles-10))*1.25;
    const tier3=Math.max(0,miles-20)*1.00;
    const fare=base+tier2+tier3+fair;
    const total=fare.toFixed(2);

    const res=document.getElementById('result');
    res.innerHTML=`<div class="total">$${total}</div>
      <p><strong>Base Rate:</strong> $${base}</p>
      <p><strong>Mileage:</strong> $${(tier2+tier3).toFixed(2)}</p>
      ${fair>0?`<p><strong>Travel Fairness Fee:</strong> $${fair}</p>`:""}
      <p>üìè ${miles.toFixed(1)} mi  ‚è±Ô∏è ${Math.round(mins)} min</p>
      <p style="text-align:center;margin-top:15px;">
        <button class="btn primary" id="textRedBtn">üì≤ Text RED with Trip Details</button>
      </p>`;
    res.style.display="block";

    document.getElementById("textRedBtn").onclick=()=>{
      const name=prompt("Hey there! Please enter your name for the message to Big Red:");
      const smsBody=encodeURIComponent(
        `Hey Big Red ‚Äî this is ${name||"a rider"} from ${pickup} to ${dropoff}. Est. $${total} flat rate.`
      );
      window.location.href=`sms:+14053784024?&body=${smsBody}`;
    };
  }
  </script>

  <script src="status.js"></script>
</body>
</html>