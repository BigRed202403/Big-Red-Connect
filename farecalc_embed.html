<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Fare Calculator (Embedded) ‚Äì Big Red Connect</title>
  <link rel="stylesheet" href="style.css">

  <!-- ‚úàÔ∏è Google Maps -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCMM0dxLNM7XQI5G3OBSnINeO5hcS3Ks5I&libraries=places,geometry" async defer></script>
</head>
<body>

  <section class="info-section calculator">
    <label for="pickup">Pickup Location</label>
    <input id="pickup" type="text" placeholder="Enter pickup address or place">

    <div id="stopsWrap"></div>
    <button id="addStopBtn" class="btn primary" type="button">‚ûï Add Stop</button>

    <label for="dropoff">Drop-off Location</label>
    <input id="dropoff" type="text" placeholder="Enter drop-off address or place">

    <div class="location-buttons">
      <button id="useLocPickup" class="btn primary" type="button">üìç Use My Location for Pickup</button>
      <button id="useLocDrop" class="btn secondary" type="button">üìç Use My Location for Drop-off</button>
    </div>

    <div id="map"></div>
    <div id="source-note" style="margin-top:6px;font-size:0.85em;color:#aaa;"></div>
    <div id="rushhour-note"></div>
    <div id="airport-note"></div>

    <label for="tripType">Ride Type</label>
    <select id="tripType">
      <option value="10">Standard ($10 base)</option>
      <option value="15">Rush Hour ($15 base)</option>
      <option value="15_airport">Airport ($15 base)</option>
      <option value="20">Special Event ($20 base)</option>
    </select>

    <label for="payment">Payment Method</label>
    <select id="payment">
      <option value="cash">Cash / Venmo / Cash App (no fees)</option>
      <option value="card">Card (+3.3% booking + 2.4% fuel)</option>
    </select>

    <button class="btn primary" id="calcBtn">üí≤ Calculate Fare</button>

    <div id="result" style="display:none;"></div>
    <p class="disclaimer">*Estimates only. Final fare may vary slightly based on route or wait time.</p>
  </section>

  <script>
  const HQ = { lat: 35.31953, lng: -97.51199 };
  let refPoint = HQ;
  let refLabel = "HQ (Offline Mode)";
  let stopInputs = [];

  // üìç Distance helper
  function distMi(a,b){
    return google.maps.geometry
      ? google.maps.geometry.spherical.computeDistanceBetween(
          new google.maps.LatLng(a.lat,a.lng),
          new google.maps.LatLng(b.lat,b.lng)
        ) / 1609.34
      : 0;
  }

  // üß≠ Reference selector
  async function getDriverReference() {
    const status = localStorage.getItem("bigred_status") || "offline";
    let ref = null, refLabel = "HQ (Offline Mode)";
    try {
      const lat = parseFloat(localStorage.getItem("brc_ref_lat"));
      const lng = parseFloat(localStorage.getItem("brc_ref_lng"));
      if (status === "online" && !isNaN(lat) && !isNaN(lng)) {
        ref = { lat, lng };
        refLabel = "Live Location";
      }
    } catch (e) { console.warn("‚ö†Ô∏è read error", e); }

    if (!ref) ref = HQ;
    else if (distMi(HQ, ref) > 100) {
      console.warn("‚ö†Ô∏è Out-of-range live coords ‚Äî using HQ fallback");
      ref = HQ; refLabel = "HQ (Offline Mode)";
    }

    localStorage.setItem("brc_ref_lat", ref.lat);
    localStorage.setItem("brc_ref_lng", ref.lng);
    document.getElementById("source-note").textContent = `üìç Source: ${refLabel}`;
    return { ref, refLabel };
  }

  // ‚ûï Stop field
  function addStopField(){
    if(stopInputs.length>=3){alert("Limit 3 stops.");return;}
    const id=`stop_${Date.now()}`;stopInputs.push(id);
    const wrap=document.getElementById('stopsWrap');
    const div=document.createElement('div');
    div.className="stop-row";div.id=`row_${id}`;
    div.innerHTML=`<label for="${id}">Stop ${stopInputs.length}</label>
      <div style="display:flex;gap:6px;align-items:center;">
        <input id="${id}" type="text" placeholder="Enter stop address or place" style="flex:1;">
        <button type="button" class="remove-stop" onclick="removeStop('${id}')">‚úñ</button>
      </div>`;
    wrap.appendChild(div);
    new google.maps.places.Autocomplete(document.getElementById(id));
  }

  function removeStop(id){
    document.getElementById(`row_${id}`)?.remove();
    stopInputs=stopInputs.filter(s=>s!==id);
    document.querySelectorAll("#stopsWrap label").forEach((l,i)=>l.textContent=`Stop ${i+1}`);
  }

  // üöÄ Initialize Google Maps + calculator
  window.initGoogle = async function(){
    const { ref, refLabel } = await getDriverReference();

    const geocoder = new google.maps.Geocoder();
    const directionsService = new google.maps.DirectionsService();
    const directionsRenderer = new google.maps.DirectionsRenderer({ suppressMarkers:true });
    const map = new google.maps.Map(document.getElementById('map'), {
      center: ref, zoom:11, mapTypeControl:false, streetViewControl:false
    });
    directionsRenderer.setMap(map);

    const acPickup = new google.maps.places.Autocomplete(document.getElementById('pickup'));
    const acDrop = new google.maps.places.Autocomplete(document.getElementById('dropoff'));
    acPickup.addListener('place_changed',()=>{const p=acPickup.getPlace();if(p.geometry) map.setCenter(p.geometry.location);});
    acDrop.addListener('place_changed',()=>{const p=acDrop.getPlace();if(p.geometry) map.panTo(p.geometry.location);});

    document.getElementById('addStopBtn').onclick=addStopField;

    document.getElementById('calcBtn').onclick=async function(){
      const pickup=document.getElementById('pickup').value.trim();
      const dropoff=document.getElementById('dropoff').value.trim();
      if(!pickup||!dropoff){alert("Please enter both pickup and drop-off.");return;}

      const stops=[];
      for(const id of stopInputs){
        const v=document.getElementById(id)?.value.trim();
        if(v)stops.push({location:v,stopover:true});
      }

      const route=await new Promise((res,rej)=>
        directionsService.route({origin:pickup,destination:dropoff,waypoints:stops,travelMode:"DRIVING"},
          (r,s)=>s==="OK"?res(r):rej(s))
      );

      const miles=route.routes[0].legs.reduce((m,l)=>m+(l.distance?.value||0),0)/1609.34;
      const duration=route.routes[0].legs.reduce((t,l)=>t+(l.duration?.value||0),0)/60;

      const pickupCoords={
        lat:route.routes[0].legs[0].start_location.lat(),
        lng:route.routes[0].legs[0].start_location.lng()
      };
      const distToPickup=distMi(ref,pickupCoords);
      const etaMins=distToPickup<=1?2:Math.round((distToPickup/30)*60);

      // Rush Hour logic
      const h=new Date().getHours();
      const rush=(h>=5&&h<9)||(h>=15&&h<19);
      document.getElementById("rushhour-note").innerHTML=
        rush?"üö¶ Rush Hour pricing in effect (5‚Äì9 AM & 3‚Äì7 PM)": "";

      // Airport detection
      const dropLower=dropoff.toLowerCase();
      const airport=/airport|intl|regional|jet center|hangar/.test(dropLower)
                   && !/tinker|afb|air force|base|ang/.test(dropLower);
      document.getElementById("airport-note").innerHTML=
        airport?"‚úàÔ∏è Airport ride detected ‚Äî $15 base applied automatically.":"";

      let base=airport?15:rush?15:10;

      // Mileage tiers
      const tier2=Math.max(0,Math.min(10,miles-10))*1.25;
      const tier3=Math.max(0,miles-20)*1.00;
      const mileageSubtotal=tier2+tier3;

      // Fairness fee
      let fairnessFee=0;
      if(distToPickup>50)fairnessFee=20;
      else if(distToPickup>25)fairnessFee=10;

      // Stops
      const stopsCost=stops.length*5;

      // Payment
      const pay=document.getElementById("payment").value;
      let fare=base+mileageSubtotal+fairnessFee+stopsCost;
      if(pay==="card")fare+=fare*0.033+fare*0.024;
      const total=fare.toFixed(2);

      document.getElementById("result").innerHTML=`
        <div class="total">üí∞ Estimated Fare $${total}</div>
        <div class="miles">üìè Distance ${miles.toFixed(1)} mi</div>
        <div class="duration">‚è±Ô∏è Trip Time ‚âà ${Math.round(duration)} min</div>
        <div class="pickup">üöó Pickup ETA ‚âà ${etaMins} min</div>
        <hr style="margin:8px 0;border-color:#333;">
        <p><strong>Base Rate:</strong> $${base.toFixed(2)}</p>
        <p><strong>Mileage Subtotal:</strong> $${mileageSubtotal.toFixed(2)} 
          <span style="color:#777;">($1.25/mi after 10 mi & $1.00 after 20 mi)</span></p>
        <p><strong>Stops:</strong> ${stops.length} √ó $5 = $${stopsCost.toFixed(2)}</p>
        <p><strong>Travel Fairness Fee:</strong> $${fairnessFee.toFixed(2)}</p>
        <p><strong>Payment:</strong> ${pay==="card"?"Card (includes fees)":"Cash / Venmo / Cash App"}</p>
        <p style="margin-top:10px;color:#777;">Source: ${refLabel}</p>
        <p style="text-align:center;color:#888;margin-top:10px;">No surprises. Just solid local moves.</p>`;
      document.getElementById("result").style.display="block";
    };
  };
  </script>
</body>
</html>