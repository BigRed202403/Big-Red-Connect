<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Live Tracker (Beta) â€“ Big Red Connect</title>

  <!-- No Cache -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <link rel="stylesheet" href="style.css" />

  <!-- Google Maps -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCMM0dxLNM7XQI5G3OBSnINeO5hcS3Ks5I&libraries=geometry&callback=initMap" async defer></script>

  <style>
    #map {
      width: 100%;
      height: 420px;
      border: 2px solid #c40000;
      border-radius: 12px;
      margin-top: 15px;
    }
    .cta-bar {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 14px;
    }
    .cta-bar .btn {
      flex: 1;
      max-width: 180px;
      font-size: 0.95em;
    }
    #status-message {
      text-align: center;
      margin-top: 15px;
      color: #ccc;
      font-size: 0.95em;
      line-height: 1.4;
    }
  </style>
</head>
<body>

  <div class="logo-header">
    <a href="index.html"><img src="official_logo.jpeg" alt="Big Red Connect Logo" /></a>
    <div class="home-top">
      <a href="index.html" class="btn secondary">ğŸ  Home</a>
    </div>
  </div>

  <h1>Live Tracker (Beta)</h1>
  <p class="tagline">Follow Big Red Connectâ€™s live position or preview your connection route.</p>

  <div id="status-pill" class="status status--loading">Checking statusâ€¦</div>

  <!-- CTA Buttons -->
  <div class="cta-bar">
    <a href="fare-calculator.html" class="btn secondary">ğŸ’² Estimate Fare</a>
    <a href="sms:+14053784024?&body=Hey%20Big%20Red%20â€”%20Iâ€™d%20like%20to%20plan%20a%20ride%20connection." class="btn primary">ğŸ“² Text â€œREDâ€</a>
  </div>

  <section class="info-section">
    <div id="map"></div>
    <div id="status-message"></div>
  </section>

  <footer>
    <p>&copy; 2025 Big Red Connect â€” <a href="index.html">Return Home</a></p>
  </footer>

  <script src="status.js"></script>
  <script>
    const LOCATION_URL = "https://location-reader.bigredtransportation.workers.dev";
    const STATUS_URL = "https://bigred-status-updater.bigredtransportation.workers.dev/status";

    let map, marker, routeLine;

    // Initialize Map
    async function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 35.3207, lng: -97.4929 },
        zoom: 11,
        mapTypeControl: true,
        streetViewControl: true
      });

      // Add Big Red marker
      const icon = {
        url: "https://raw.githubusercontent.com/BigRed202403/Big-Red-Connect/main/official_logo.png",
        scaledSize: new google.maps.Size(70, 70),
        anchor: new google.maps.Point(35, 35)
      };
      marker = new google.maps.Marker({
        map,
        icon,
        title: "Big Red Connect"
      });

      // Fetch status first
      await fetchStatus();
      // Begin live updates
      refreshLocation();
      setInterval(refreshLocation, 30000);
    }

    // Get status + adjust UI messaging
    async function fetchStatus() {
      try {
        const res = await fetch(STATUS_URL + "?nocache=" + Date.now(), { cache: "no-store" });
        const j = await res.json();
        updatePill(j.status, j.updated);
      } catch {
        updatePill("offline");
      }
    }

    function updatePill(state, iso = null) {
      const pill = document.getElementById("status-pill");
      const msg = document.getElementById("status-message");
      const now = iso ? new Date(iso) : new Date();
      const stamp = now.toLocaleString("en-US", {
        month: "short", day: "numeric",
        hour: "numeric", minute: "2-digit",
        timeZone: "America/Chicago", timeZoneName: "short"
      });

      pill.classList.remove("online","away","offline","status--loading");
      if (state === "online") {
        pill.classList.add("online");
        pill.textContent = `ğŸŸ¢ Online â€” as of ${stamp}`;
        msg.innerHTML = `Big Red is live â€” track position or text for a pickup!`;
      } else if (state === "away") {
        pill.classList.add("away");
        pill.textContent = `ğŸŸ¡ Limited Availability â€” as of ${stamp}`;
        msg.innerHTML = `Big Redâ€™s between runs â€” text to line up your next connection.`;
      } else {
        pill.classList.add("offline");
        pill.textContent = `ğŸ”´ Offline â€” as of ${stamp}`;
        msg.innerHTML = `Big Redâ€™s currently off the road â€” plan ahead for later or estimate your fare above.`;
      }
    }

    // Refresh live marker
    async function refreshLocation() {
      try {
        const res = await fetch(LOCATION_URL + "?nocache=" + Date.now(), { cache: "no-store" });
        const j = await res.json();
        if (!j.latitude || !j.longitude) return;

        const latLng = { lat: parseFloat(j.latitude), lng: parseFloat(j.longitude) };
        marker.setPosition(latLng);
        map.panTo(latLng);

        // Optional route draw if pickup/dropoff exist
        const params = new URLSearchParams(window.location.search);
        const pickup = params.get("pickup");
        const dropoff = params.get("dropoff");
        if (pickup && dropoff && document.querySelector("#status-pill").classList.contains("online")) {
          drawRoute(latLng, pickup, dropoff);
        } else if (routeLine) {
          routeLine.setMap(null);
        }
      } catch (e) {
        console.warn("Location fetch failed:", e);
      }
    }

    // Draw route only if params exist
    async function drawRoute(currentLatLng, pickupAddr, dropoffAddr) {
      const directionsService = new google.maps.DirectionsService();
      const directionsRenderer = new google.maps.DirectionsRenderer({ suppressMarkers: true, preserveViewport: true });
      directionsRenderer.setMap(map);

      directionsService.route({
        origin: currentLatLng,
        destination: dropoffAddr,
        waypoints: [{ location: pickupAddr, stopover: true }],
        travelMode: "DRIVING"
      }, (result, status) => {
        if (status === "OK") {
          directionsRenderer.setDirections(result);
        } else {
          console.warn("Route error:", status);
        }
      });
    }
  </script>
</body>
</html>