<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Request a Ride ‚Äì Big Red Connect</title>

  <!-- Icons -->
  <link rel="apple-touch-icon" href="/icon.PNG">
  <link rel="icon" type="image/png" sizes="192x192" href="/icon.PNG">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#000"/>

  <!-- Google Places -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCMM0dxLNM7XQI5G3OBSnINeO5hcS3Ks5I&libraries=places"></script>

  <style>
    body {
      margin:0;
      background:#000;
      color:#fff;
      font-family:-apple-system, BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
      padding-bottom:70px; /* for nav footer */
    }

    header {
      padding:15px 12px;
      display:flex;
      align-items:center;
      gap:12px;
      border-bottom:2px solid #b30000;
      background:#000;
      position:sticky;
      top:0;
      z-index:12;
    }
    header img { height:46px; }

    h1 {
      text-align:center;
      margin:20px 0 10px;
      font-size:1.4rem;
      font-weight:700;
    }

    .form {
      width:calc(100% - 24px);
      margin:10px auto;
    }
    .input-group {
      margin-bottom:16px;
    }
    label {
      display:block;
      margin-bottom:6px;
      font-size:.85rem;
      color:#ccc;
    }
    input, select {
      width:100%;
      padding:12px;
      background:#111;
      border:1px solid #333;
      border-radius:8px;
      color:#fff;
      font-size:.95rem;
    }

    .btn {
      display:block;
      width:100%;
      margin-top:14px;
      padding:14px;
      background:#b30000;
      color:#fff;
      text-align:center;
      font-weight:700;
      border-radius:10px;
      text-decoration:none;
      font-size:1.05rem;
    }

    #holidayBanner {
      display:none;
      background:#331111;
      border:1px solid #b30000;
      padding:12px;
      border-radius:8px;
      margin-bottom:15px;
      color:#ffcccc;
      font-size:.85rem;
    }

    #toast {
      position:fixed;
      bottom:22px;
      left:50%;
      transform:translateX(-50%);
      background:#111;
      border:1px solid #b30000;
      padding:10px 18px;
      border-radius:999px;
      opacity:0;
      pointer-events:none;
      transition:.25s;
      z-index:200;
    }
    #toast.show { opacity:1; }

    /* Add Stop Button */
    #addStopBtn {
      margin: -8px 0 16px;
      background:#222;
      border:1px dashed #555;
      color:#aaa;
    }

    /* Bottom Navigation (A1) */
    .nav-footer {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: #000;
      border-top: 2px solid #b30000;
      display: flex;
      padding: 8px;
      z-index: 50;
    }

    .nav-btn {
      flex: 1;
      margin: 0 4px;
      background: #b30000;
      color: #fff;
      text-align: center;
      padding: 10px 0;
      border-radius: 10px;
      font-weight: 700;
      font-size: .9rem;
      text-decoration: none;
    }
  </style>
</head>

<body>

<header>
  <img src="/icon.PNG"/>
  <div>
    <div style="font-weight:700;">Big Red Connect</div>
    <div style="font-size:.8rem;color:#888;">Ride Request</div>
  </div>
</header>

<h1>Request a Ride</h1>

<div class="form">

  <!-- HOLIDAY BANNER -->
  <div id="holidayBanner">üéÑ Holiday Rate Applied ‚Äî Thanks for riding local!</div>

  <!-- NAME -->
  <div class="input-group">
    <label>Your Name</label>
    <input id="riderName" placeholder="Your name"/>
  </div>

  <!-- PHONE -->
  <div class="input-group">
    <label>Mobile Number</label>
    <input id="riderPhone" placeholder="555-555-5555" inputmode="tel"/>
  </div>

  <!-- PICKUP -->
  <div class="input-group">
    <label>Pickup Address</label>
    <input id="pickup" placeholder="Where should we pick you up?"/>
  </div>

  <!-- GATE CODE -->
  <div class="input-group">
    <label>Gate Code / Access Notes (optional)</label>
    <input id="gateCode" placeholder="Gate code, building, apartment‚Ä¶"/>
  </div>

  <!-- ADD STOP BUTTON -->
  <button id="addStopBtn" class="btn" style="background:#222;border:none;">+ Add Stop</button>

  <!-- STOPS CONTAINER -->
  <div id="stopsContainer"></div>

  <!-- DROPOFF -->
  <div class="input-group">
    <label>Dropoff Address</label>
    <input id="dropoff" placeholder="Where are you going?"/>
  </div>

  <!-- PASSENGERS -->
  <div class="input-group">
    <label>Passengers</label>
    <select id="partySize">
      <option>1</option><option>2</option><option>3</option>
      <option>4</option><option>5+</option>
    </select>
  </div>

  <!-- LUGGAGE (airport auto-toggle) -->
  <div class="input-group" id="luggageGroup" style="display:none;">
    <label>Luggage Pieces</label>
    <select id="luggage">
      <option>0</option><option>1</option><option>2</option><option>3+</option>
    </select>
  </div>

  <!-- TIME -->
  <div class="input-group">
    <label>When?</label>
    <select id="timeType">
      <option value="now">Right now</option>
      <option value="schedule">Schedule a time</option>
    </select>
  </div>

  <div class="input-group" id="scheduledGroup" style="display:none;">
    <label>Pick a Time</label>
    <input type="datetime-local" id="scheduledFor"/>
  </div>

  <!-- ESTIMATE -->
  <div class="input-group">
    <label>Estimated Fare</label>
    <input id="estimate" disabled placeholder="$0.00"/>
  </div>

  <a class="btn" id="btnSubmit">Submit Ride Request</a>

</div>

<div id="toast"></div>

<!-- Bottom Navigation -->
<footer class="nav-footer">
  <a href="/rider/rider.html" class="nav-btn">üè† Home</a>
  <a href="/rider/ride-request.html" class="nav-btn">üöó Request</a>
  <a href="/rider/profile.html" class="nav-btn">üë§ Profile</a>
</footer>

<script>
/* =======================================================
   TOAST
======================================================= */
function showToast(msg){
  const t=document.getElementById("toast");
  t.textContent=msg;
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"),1800);
}

/* =======================================================
   PROFILE PREFILL
======================================================= */
function prefillFromProfile(){
  ["riderName","riderPhone","riderHome","riderGate"].forEach(k=>{
    const val=localStorage.getItem(k);
    if(val && k==="riderName") document.getElementById("riderName").value=val;
    if(val && k==="riderPhone") document.getElementById("riderPhone").value=val;
    if(val && k==="riderHome") document.getElementById("pickup").value=val;
    if(val && k==="riderGate") document.getElementById("gateCode").value=val;
  });
}

/* =======================================================
   GOOGLE PLACES AUTOCOMPLETE
======================================================= */
function activateAutocomplete(input){
  return new google.maps.places.Autocomplete(input, {
    componentRestrictions: { country: "us" },
    fields: ["formatted_address","geometry"],
    strictBounds: false
  });
}

function initAutocomplete(){
  activateAutocomplete(document.getElementById("pickup"));
  activateAutocomplete(document.getElementById("dropoff"));
}

/* Add stop with autocomplete */
document.getElementById("addStopBtn").addEventListener("click", ()=>{
  const c=document.getElementById("stopsContainer");
  const div=document.createElement("div");
  div.className="input-group";
  div.innerHTML=`
    <label>Stop</label>
    <input class="stopInput" placeholder="Add a stop address"/>
  `;
  c.appendChild(div);
  activateAutocomplete(div.querySelector(".stopInput"));
});

/* =======================================================
   AIRPORT DETECTION
======================================================= */
function detectAirport(addr){
  if(!addr) return false;
  addr=addr.toLowerCase();
  return addr.includes("will rogers") || addr.includes("airport") ||
         addr.includes("okc") && addr.includes("terminal");
}
function checkLuggage(){
  const show = detectAirport(pickup.value) || detectAirport(dropoff.value);
  luggageGroup.style.display = show ? "block" : "none";
}
pickup.addEventListener("input",checkLuggage);
dropoff.addEventListener("input",checkLuggage);

/* =======================================================
   SCHEDULING UI
======================================================= */
timeType.addEventListener("change",()=>{
  scheduledGroup.style.display = timeType.value==="schedule" ? "block":"none";
});

/* =======================================================
   SUBMIT RIDE REQUEST
======================================================= */
btnSubmit.addEventListener("click",submitRide);

async function submitRide(){
  const name=riderName.value.trim();
  const phone=riderPhone.value.trim();
  const p=pickup.value.trim();
  const d=dropoff.value.trim();
  if(!name||!phone||!p||!d){ showToast("Missing fields"); return; }

  // Save profile
  localStorage.setItem("riderName",name);
  localStorage.setItem("riderPhone",phone);
  localStorage.setItem("riderHome",p);
  localStorage.setItem("riderGate",gateCode.value.trim());

  // Stops
  const stops=[...document.querySelectorAll(".stopInput")].map(i=>({address:i.value.trim()}))
               .filter(s=>s.address);

  const riderId = localStorage.getItem("riderId") || crypto.randomUUID();
  localStorage.setItem("riderId",riderId);

  const body={
    type: scheduledFor.value ? "SCHEDULED":"INSTANT",
    pickup:{address:p,gate:gateCode.value},
    dropoff:{address:d},
    stops,
    rider:{name,phone,partySize:Number(partySize.value),riderId},
    pricing:{estimate:Number(estimate.value.replace("$","")||0)},
    scheduledFor: timeType.value==="schedule" ? scheduledFor.value : null,
    source:"RIDER_APP"
  };

  const API="https://bigred-bookings.bigredtransportation.workers.dev";

  const res=await fetch(`${API}/api/bookings`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(body)
  });

  if(!res.ok){ showToast("Error"); return; }

  const booking=await res.json();

  // SMS prefill
  const sms=`sms:+14053784024?body=`+encodeURIComponent(
    `Ride Request:
From: ${p}
To: ${d}
Name: ${name}
Phone: ${phone}
Stops: ${stops.map(s=>s.address).join(", ")||"None"}
Passengers: ${partySize.value}
Booking ID: ${booking.id}`
  );
  window.location.href=sms;
}

prefillFromProfile();
window.onload=initAutocomplete;
</script>

</body>
</html>