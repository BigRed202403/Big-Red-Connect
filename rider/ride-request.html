<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ride Request & Estimate ‚Äì Big Red Connect</title>

  <!-- Icons / PWA -->
  <link rel="apple-touch-icon" href="/official_logo.jpeg">
  <link rel="icon" type="image/png" sizes="192x192" href="/official_logo.jpeg">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#000000"/>

  <!-- No cache -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
  <meta http-equiv="Pragma" content="no-cache"/>
  <meta http-equiv="Expires" content="0"/>

  <style>
    :root { --red:#b30000; --panel:#111; --border:#222; --muted:#aaa; }
    body { margin:0; background:#000; color:#fff; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif; padding-bottom:60px; }
    header { padding:12px 12px; display:flex; align-items:center; gap:10px; border-bottom:2px solid var(--red); background:#000; position:sticky; top:0; z-index:20; }
    .logo-tap { display:flex; align-items:center; gap:8px; cursor:pointer; }
    header img { height:44px; border-radius:4px; }
    .top-actions { margin-left:auto; display:flex; gap:6px; }
    .btn-small { padding:8px 10px; font-size:0.8rem; }
    h1 { text-align:center; font-size:1.4rem; margin:18px 0 4px; }
    .subhead { text-align:center; font-size:0.85rem; color:var(--muted); margin-bottom:8px; }
    .page { width:calc(100% - 24px); max-width:560px; margin:0 auto; }
    .card { background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:14px; margin-top:10px; }
    .section-title { font-size:0.9rem; font-weight:700; margin-bottom:8px; border-bottom:1px solid #222; padding-bottom:4px; }
    .input-group { margin-bottom:12px; }
    label { display:block; font-size:0.8rem; color:#ccc; margin-bottom:4px; }
    input, select, textarea { width:100%; padding:10px; background:#111; border:1px solid #333; border-radius:8px; color:#fff; font-size:0.95rem; }
    textarea { min-height:60px; resize:vertical; }
    .hint { font-size:0.75rem; color:var(--muted); margin-top:2px; }
    .btn { display:inline-block; text-align:center; padding:12px; border-radius:10px; font-weight:700; font-size:0.95rem; border:none; cursor:pointer; text-decoration:none; }
    .btn-primary { background:var(--red); color:#fff; }
    .btn-ghost { background:#000; color:#fff; border:1px solid #444; }
    .btn-secondary { background:#111; color:#fff; border:1px solid #333; }
    .btn-wide { width:100%; margin-top:12px; }
    .ride-mode-toggle { display:flex; gap:6px; margin-bottom:10px; }
    .btn-toggle { flex:1; padding:10px; font-size:0.9rem; border-radius:999px; border:1px solid #333; background:#000; color:#fff; }
    .btn-toggle.active { background:var(--red); border-color:var(--red); }
    #reserveControls { margin-top:8px; }
    #map { width:100%; height:220px; border-radius:10px; margin-top:10px; background:#050505; border:1px solid #222; }
    .notes-block p { margin:4px 0; font-size:0.8rem; }
    #airport-note, #event-note, #rushhour-note, #fairness-note { font-size:0.8rem; }
    #airport-note { color:#9fd4ff; }
    #event-note { color:#ffd27f; }
    #rushhour-note { color:#ffb3b3; }
    #fairness-note { color:#d3b9ff; }
    #result { margin-top:10px; padding:10px; border-radius:10px; background:#080808; border:1px solid #333; font-size:0.9rem; }
    .total { font-size:1.3rem; font-weight:700; margin-bottom:6px; }
    .profile-chip { font-size:0.8rem; color:var(--muted); }
    .profile-chip strong { color:#fff; }
    .btn-row { margin-top:16px; display:flex; flex-direction:column; gap:8px; }
    .smallnote { font-size:0.78rem; color:var(--muted); margin-top:6px; text-align:center; }
    .disclaimer { font-size:0.75rem; color:var(--muted); margin-top:10px; text-align:center; }
    #toast { position:fixed; bottom:22px; left:50%; transform:translateX(-50%); background:#111; border:1px solid var(--red); padding:10px 18px; border-radius:999px; opacity:0; pointer-events:none; transition:opacity .25s; z-index:99; font-size:0.85rem; }
    #toast.show { opacity:1; }
  </style>
</head>
<body>

<header>
  <div class="logo-tap" id="logoHome">
    <img src="/official_logo.jpeg" alt="Big Red Connect logo">
    <div>
      <div style="font-weight:700;font-size:0.92rem;">Big Red Connect</div>
      <div style="font-size:0.78rem;color:#888;">Ride Request &amp; Estimate</div>
    </div>
  </div>
  <div class="top-actions">
    <button class="btn btn-ghost btn-small" id="btnHub">Rider Hub</button>
  </div>
</header>

<h1>Ride Request &amp; Estimate</h1>
<div class="subhead">Get a local estimate first, then tap to send your request via text.</div>

<div class="page">

  <div class="card">
    <div class="section-title">You‚Äôre booking as</div>
    <div class="profile-chip" id="profileSummary">Loading profile‚Ä¶</div>
    <div class="btn-row" style="margin-top:10px;">
      <button class="btn btn-secondary btn-small" id="btnEditProfile">Edit Profile</button>
    </div>
  </div>

  <div class="card">
    <div class="section-title">When?</div>

    <!-- ‚úÖ CHANGE: Remove Ride Now / Reserve toggle. Always pre-arranged. -->
    <div id="reserveControls">
      <div class="input-group">
        <label for="reserveDate">Date</label>
        <input id="reserveDate" type="date">
      </div>

      <div class="input-group">
        <label for="reserveTimeSelect">Time (15-min increments)</label>
        <!-- ‚úÖ CHANGE: 15-min dropdown -->
        <select id="reserveTimeSelect"></select>
        <div class="hint">Pick a time (required). This keeps every request pre-arranged and predictable.</div>
      </div>

      <div class="input-group">
        <label for="planBy">Plan By</label>
        <select id="planBy">
          <option value="pickup">Pickup Time</option>
          <option value="dropoff">Drop-off Time</option>
        </select>
      </div>

      <div class="hint">
        Rush hour auto-applies if weekday 5‚Äì9 AM or 3‚Äì7 PM. Holidays and big events may use special base rates.
      </div>
    </div>
  </div>

  <div class="card">
    <div class="section-title">Trip Details</div>

    <div class="input-group">
      <label for="pickup">Pickup Location</label>
      <input id="pickup" type="text" placeholder="Enter pickup address or place">
      <button class="btn btn-secondary btn-wide" id="useLocPickup" type="button">üìç Use My Location</button>
    </div>

    <div class="input-group">
      <label for="gateCode">Gate Code / Access Notes (optional)</label>
      <input id="gateCode" type="text" placeholder="Gate code, building #, apartment‚Ä¶">
    </div>

    <div id="stopsWrap"></div>
    <button id="addStopBtn" class="btn btn-secondary btn-wide" type="button">‚ûï Add Stop</button>

    <div class="input-group" style="margin-top:10px;">
      <label for="dropoff">Drop-off Location</label>
      <input id="dropoff" type="text" placeholder="Enter drop-off address or place">
      <button class="btn btn-secondary btn-wide" id="useLocDrop" type="button">üìç Use My Location</button>
    </div>

    <div class="input-group">
      <label for="passengers">Passengers</label>
      <select id="passengers">
        <option value="1">1</option><option value="2">2</option><option value="3">3</option>
        <option value="4">4</option><option value="5">5</option>
        <option value="6">6</option>
      </select>
      <div class="hint">Seatbelts for everyone. Max 6 depending on which vehicle is in service.</div>
    </div>

    <!-- Luggage (Airport only) -->
    <div class="input-group" id="luggageWrap" style="display:none;">
      <label for="luggageCount">Luggage (airport rides)</label>
      <select id="luggageCount">
        <option value="0">0</option>
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
        <option value="6">6+</option>
      </select>
      <div class="hint">How many bags total? Helps make sure the right vehicle shows up.</div>
    </div>

    <div id="map"></div>

    <div class="notes-block" style="margin-top:10px;">
      <p id="airport-note"></p>
      <p id="event-note"></p>
      <p id="rushhour-note"></p>
      <p id="fairness-note"></p>
    </div>
  </div>

  <div class="card">
    <div class="section-title">Estimate</div>

    <div class="input-group">
      <label for="payment">Payment Method</label>
      <select id="payment">
        <option value="cash">Cash / Venmo / Cash App (no extra fees)</option>
        <option value="card">Card (+3.3% booking + 2.4% fuel)</option>
      </select>
    </div>

    <div class="input-group">
      <label for="estimateDisplay">Estimated Fare</label>
      <input id="estimateDisplay" type="text" disabled placeholder="$0.00">
    </div>

    <button class="btn btn-primary btn-wide" id="calcBtn" type="button">üí≤ Get Ride Estimate</button>

    <div id="result" style="display:none;"></div>

    <p class="smallnote">
      Already requested? You can <a href="/rider/myride.html" style="color:#ff6666;">track your ride</a> with your ride ID.
    </p>

    <p class="disclaimer">
      *Estimate only. Final fare may vary slightly based on route, wait time, or last-minute changes.
    </p>
  </div>

</div>

<div id="toast"></div>

<script>
  // =====================================================
  // CONFIG
  // =====================================================
  const API_BOOK   = "https://bigred-bookings.bigredtransportation.workers.dev";
  const PUSH_API   = "https://bigred-push.bigredtransportation.workers.dev/push/ride-request";

  const HQ = { lat: 35.3207, lng: -97.4929 };

  // ‚úÖ Option B: Pull live driver origin from update-location worker (CURRENT)
  const LOCATION_API = "https://update-location.bigredtransportation.workers.dev/";

  let fairnessOrigin = { ...HQ };

  // =====================================================
  // ‚úÖ Last Ride Cache (canonical)
  // =====================================================
  const LS_LAST_RIDE_ID = "brc_last_ride_id_v1";
  function setLastRideId(id){
    if(!id) return;
    try { localStorage.setItem(LS_LAST_RIDE_ID, String(id)); } catch(e) {}
  }

  // =====================================================
  // TOAST
  // =====================================================
  function showToast(msg) {
    const t = document.getElementById("toast");
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(() => t.classList.remove("show"), 1800);
  }

  // =====================================================
  // NOTIFY PREF (v1 local-only ‚Üí stamped into bookings)
  // =====================================================
  const NOTIFY_PREF_KEY = "notifyPref"; // both | sms | push
  function getNotifyPref(){
    const v = String(localStorage.getItem(NOTIFY_PREF_KEY) || "both").toLowerCase();
    return (v === "sms" || v === "push" || v === "both") ? v : "both";
  }

  // =====================================================
  // PLACE DISPLAY HELPERS (name + address)
  // =====================================================
  function formatPlaceLine(name, address){
    const n = String(name || "").trim();
    const a = String(address || "").trim();
    if (n && a) return `${n} ‚Äî ${a}`;
    return a || n || "";
  }

  function pickFirstString(...vals){
    for (const v of vals){
      if (typeof v === "string" && v.trim()) return v.trim();
    }
    return "";
  }

  // =====================================================
  // IMPORTANT: define these BEFORE early repeat-prefill runs
  // =====================================================
  let stopInputs = [];
  let repeatLocked = false; // ‚úÖ prevents profile/home/handoff from overriding repeat

  const PLACE_KEYS = {
    pickup: "brc_place_pickup_v1",
    dropoff: "brc_place_dropoff_v1",
    stopPrefix: "brc_place_stop_v1:"
  };

  function savePlace(key, placeObj) { try { sessionStorage.setItem(key, JSON.stringify(placeObj)); } catch(e) {} }
  function loadPlace(key) { try { const raw = sessionStorage.getItem(key); return raw ? JSON.parse(raw) : null; } catch(e) { return null; } }
  function clearPlace(key) { try { sessionStorage.removeItem(key); } catch(e) {} }

  // =====================================================
  // RIDER ID
  // =====================================================
  function ensureRiderId() {
    let rid = localStorage.getItem("riderId");
    if (!rid) {
      try {
        if (window.crypto && crypto.getRandomValues) {
          const buf = new Uint8Array(8);
          crypto.getRandomValues(buf);
          rid = "r_" + Array.from(buf).map(b => b.toString(16).padStart(2,"0")).join("");
        } else {
          rid = "r_" + Date.now().toString(36);
        }
      } catch(e) {
        rid = "r_" + Date.now().toString(36);
      }
      localStorage.setItem("riderId", rid);
    }
    return rid;
  }
  ensureRiderId();

  // =====================================================
  // NAV
  // =====================================================
  document.getElementById("logoHome").addEventListener("click", () => window.location.href = "/index.html");
  document.getElementById("btnHub").addEventListener("click", () => window.location.href = "/rider/rider.html");
  document.getElementById("btnEditProfile").addEventListener("click", () => window.location.href = "/rider/profile.html");

  // =====================================================
  // ‚úÖ CHANGE: Always pre-arranged (mode fixed to "reserve")
  // =====================================================
  let mode = "reserve";

  // =====================================================
  // ‚úÖ CHANGE: 15-min time dropdown helpers (SMART DEFAULTS)
  // =====================================================
  function pad2(n){ return String(n).padStart(2,"0"); }

  function build15MinOptions(selectEl){
    if(!selectEl) return;
    selectEl.innerHTML = "";
    for(let h=0; h<24; h++){
      for(let m=0; m<60; m+=15){
        const v = `${pad2(h)}:${pad2(m)}`;
        const opt = document.createElement("option");
        opt.value = v;
        opt.textContent = v;
        selectEl.appendChild(opt);
      }
    }
  }

  function getSmartDefaultSchedule(now = new Date()){
    const d = new Date(now);
    d.setSeconds(0); d.setMilliseconds(0);

    const isLate = (d.getHours() === 23 && d.getMinutes() >= 30);

    if (isLate) {
      const tomorrow = new Date(d);
      tomorrow.setDate(tomorrow.getDate() + 1);
      const yyyy = tomorrow.getFullYear();
      const mm = pad2(tomorrow.getMonth() + 1);
      const dd = pad2(tomorrow.getDate());
      return { date: `${yyyy}-${mm}-${dd}`, time: "00:15" };
    }

    const next = new Date(d);
    const mins = next.getMinutes();
    const rounded = Math.ceil((mins + 1) / 15) * 15;
    next.setMinutes(rounded);
    if (next.getMinutes() === 60) {
      next.setMinutes(0);
      next.setHours(next.getHours() + 1);
    }

    const yyyy = next.getFullYear();
    const mm = pad2(next.getMonth() + 1);
    const dd = pad2(next.getDate());

    return {
      date: `${yyyy}-${mm}-${dd}`,
      time: `${pad2(next.getHours())}:${pad2(next.getMinutes())}`
    };
  }

  function initDefaultScheduleIfEmpty(){
    const dateEl = document.getElementById("reserveDate");
    const timeEl = document.getElementById("reserveTimeSelect");
    if(!dateEl || !timeEl) return;

    const dateVal = (dateEl.value || "").trim();
    const timeVal = (timeEl.value || "").trim();

    if (!dateVal || !timeVal || timeVal === "00:00") {
      const smart = getSmartDefaultSchedule(new Date());
      if (!dateVal) dateEl.value = smart.date;
      if (!timeVal || timeVal === "00:00") timeEl.value = smart.time;
    }
  }

  function getReserveTimeValue(){
    const t = (document.getElementById("reserveTimeSelect")?.value || "").trim();
    return t;
  }

  // =====================================================
  // ‚úÖ Option B: fetch live driver origin from update-location
  // =====================================================
  async function fetchDriverOriginFromLiveGPS() {
    try {
      const res = await fetch(LOCATION_API + "?t=" + Date.now(), { cache: "no-store" });
      if (!res.ok) return;

      const data = await res.json();
      const lat = Number(data?.lat ?? data?.latitude);
      const lng = Number(data?.lng ?? data?.longitude);

      if (Number.isFinite(lat) && Number.isFinite(lng)) {
        fairnessOrigin = { lat, lng };
      }
    } catch (e) {
      console.warn("Live GPS origin fetch failed; using HQ", e);
    }
  }

  // =====================================================
  // HANDOFF (DROP-OFF + PICKUP) + QUERYSTRING PREFILL
  // =====================================================
  function readHandoffDropoff() {
    try {
      const u = new URL(window.location.href);
      const qsDrop = (u.searchParams.get("dropoff") || "").trim();
      const qsDest = (u.searchParams.get("destination") || "").trim();

      if (qsDrop) return { value: qsDrop, source: "qs:dropoff" };
      if (qsDest) return { value: qsDest, source: "qs:destination" };

      const ss = (sessionStorage.getItem("brc_dropoff_handoff") || "").trim();
      if (ss) return { value: ss, source: "sessionStorage" };

      const ls = (localStorage.getItem("brc_dropoff_handoff") || "").trim();
      if (ls) return { value: ls, source: "localStorage" };

      return null;
    } catch (e) { return null; }
  }

  function readHandoffPickup() {
    try {
      const u = new URL(window.location.href);
      const qsPick = (u.searchParams.get("pickup") || "").trim();
      if (qsPick) return { value: qsPick, source: "qs:pickup" };

      const ss = (sessionStorage.getItem("brc_pickup_handoff") || "").trim();
      if (ss) return { value: ss, source: "sessionStorage" };

      const ls = (localStorage.getItem("brc_pickup_handoff") || "").trim();
      if (ls) return { value: ls, source: "localStorage" };

      return null;
    } catch (e) { return null; }
  }

  function clearHandoffCommonParams() {
    try {
      sessionStorage.removeItem("brc_dropoff_handoff");
      localStorage.removeItem("brc_dropoff_handoff");
      sessionStorage.removeItem("brc_pickup_handoff");
      localStorage.removeItem("brc_pickup_handoff");

      const u = new URL(window.location.href);
      [
        "pickup","dropoff","destination",
        "stop",
        "mode","reserveDate","reserveTime","planBy",
        "payment","estimate","miles","minutes",
        "from"
      ].forEach(k => u.searchParams.delete(k));

      window.history.replaceState({}, "", u.pathname + (u.search || "") + (u.hash || ""));
    } catch (e) {}
  }

  // =====================================================
  // PREFILL FROM QUERYSTRING (Estimate ‚Üí Request)
  // =====================================================
  let pendingStopsToHydrate = [];

  function addStopField_NoAutocomplete(initialValue = "") {
    if (stopInputs.length >= 3) return;
    const id = "stop_" + Date.now() + "_" + Math.floor(Math.random()*1000);
    stopInputs.push(id);

    const wrap = document.getElementById("stopsWrap");
    const div = document.createElement("div");
    div.className = "input-group";
    div.id = "row_" + id;
    div.innerHTML = `
      <label>Stop ${stopInputs.length}</label>
      <div style="display:flex;gap:6px;align-items:center;">
        <input id="${id}" type="text" placeholder="Enter stop address or place" style="flex:1;">
        <button type="button" class="btn btn-secondary btn-small" onclick="removeStop('${id}')">‚úñ</button>
      </div>
    `;
    wrap.appendChild(div);

    const stopEl = document.getElementById(id);
    if (stopEl) stopEl.value = initialValue;

    pendingStopsToHydrate.push(id);
    stopEl?.addEventListener("input", () => { repeatLocked = false; clearPlace(PLACE_KEYS.stopPrefix + id); });
  }

  function prefillFromEstimateQuery_EARLY() {
    try {
      if (repeatLocked) return;

      const u = new URL(window.location.href);

      const qsPickup  = (u.searchParams.get("pickup") || "").trim();
      const qsDropoff = (u.searchParams.get("dropoff") || u.searchParams.get("destination") || "").trim();
      const qsStops   = u.searchParams.getAll("stop").map(s => String(s||"").trim()).filter(Boolean);

      const qsReserveDate = (u.searchParams.get("reserveDate") || "").trim();
      const qsReserveTime = (u.searchParams.get("reserveTime") || "").trim();
      const qsPlanBy      = (u.searchParams.get("planBy") || "").trim().toLowerCase();

      const qsPayment = (u.searchParams.get("payment") || "").trim().toLowerCase();

      const qsEstimate = (u.searchParams.get("estimate") || "").trim();
      const qsMiles    = (u.searchParams.get("miles") || "").trim();
      const qsMinutes  = (u.searchParams.get("minutes") || "").trim();

      const pEl = document.getElementById("pickup");
      const dEl = document.getElementById("dropoff");

      if (qsPickup && pEl && !String(pEl.value||"").trim()) {
        pEl.value = qsPickup;
        sessionStorage.removeItem(PLACE_KEYS.pickup);
      }

      if (qsDropoff && dEl && !String(dEl.value||"").trim()) {
        dEl.value = qsDropoff;
        sessionStorage.removeItem(PLACE_KEYS.dropoff);
      }

      if (Array.isArray(qsStops) && qsStops.length) {
        try {
          stopInputs.slice().forEach(id => removeStop(id));
          stopInputs = [];
          pendingStopsToHydrate = [];
        } catch(e) {}

        qsStops.slice(0, 3).forEach(s => addStopField_NoAutocomplete(s));
      }

      if (qsReserveDate) document.getElementById("reserveDate").value = qsReserveDate;
      if (qsReserveTime) document.getElementById("reserveTimeSelect").value = qsReserveTime;
      if (qsPlanBy === "pickup" || qsPlanBy === "dropoff") document.getElementById("planBy").value = qsPlanBy;

      if (qsPayment === "cash" || qsPayment === "card") {
        document.getElementById("payment").value = qsPayment;
      }

      if (qsEstimate) {
        const ed = document.getElementById("estimateDisplay");
        if (ed && !String(ed.value||"").trim()) ed.value = "$" + String(qsEstimate).replace(/^\$/, "");
      }

      const touched =
        !!qsPickup || !!qsDropoff || qsStops.length ||
        !!qsReserveDate || !!qsReserveTime || !!qsPlanBy ||
        !!qsPayment || !!qsEstimate || !!qsMiles || !!qsMinutes;

      if (touched) {
        clearHandoffCommonParams();
        showToast("Trip carried over ‚úÖ");
      }
    } catch (e) {
      console.warn("prefillFromEstimateQuery_EARLY failed:", e);
    }
  }

  function applyHandoffPickupIfAny() {
    if (repeatLocked) return;
    const handoff = readHandoffPickup();
    if (!handoff || !handoff.value) return;

    const pickEl = document.getElementById("pickup");
    if (!pickEl) return;

    if (!String(pickEl.value || "").trim()) {
      pickEl.value = handoff.value;
      sessionStorage.removeItem(PLACE_KEYS.pickup);
      showToast("Pickup carried over ‚úÖ");
    }
  }

  function applyHandoffDropoffIfAny() {
    if (repeatLocked) return;
    const handoff = readHandoffDropoff();
    if (!handoff || !handoff.value) return;

    const dropEl = document.getElementById("dropoff");
    if (!dropEl) return;

    if (!String(dropEl.value || "").trim()) {
      dropEl.value = handoff.value;
      sessionStorage.removeItem(PLACE_KEYS.dropoff);
      showToast("Drop-off carried over ‚úÖ");
    }
  }

  // =====================================================
  // MAPS + AUTOCOMPLETE
  // =====================================================
  let map, geocoder, directionsService, directionsRenderer;
  let pickupLatLng = null, dropoffLatLng = null;
  let pickupMarker = null, dropoffMarker = null;

  let googleReady = false;
  let pendingAutoRoute = false;

  function requestAutoRouteRender() {
    pendingAutoRoute = true;
    if (googleReady) setTimeout(renderRouteFromCurrentInputs, 150);
  }

  function renderRouteFromCurrentInputs() {
    try {
      if (!googleReady || !directionsService || !directionsRenderer || !map) return;

      const pickup = (document.getElementById("pickup")?.value || "").trim();
      const dropoff = (document.getElementById("dropoff")?.value || "").trim();
      if (!pickup || !dropoff) return;

      const waypoints = (stopInputs || [])
        .map(id => (document.getElementById(id)?.value || "").trim())
        .filter(Boolean)
        .map(v => ({ location: v, stopover: true }));

      directionsService.route(
        { origin: pickup, destination: dropoff, waypoints, travelMode: "DRIVING" },
        (r, status) => {
          if (status !== "OK" || !r?.routes?.[0]) return;

          directionsRenderer.setDirections(r);
          if (r.routes[0].bounds) map.fitBounds(r.routes[0].bounds);

          try {
            const legs = r.routes[0].legs || [];
            if (!legs.length) return;

            const first = legs[0];
            const last = legs[legs.length - 1];

            setMarker("pickup", first.start_location.lat(), first.start_location.lng());
            setMarker("dropoff", last.end_location.lat(), last.end_location.lng());
          } catch(e) {}
        }
      );
    } catch (e) {
      console.warn("renderRouteFromCurrentInputs failed:", e);
    }
  }

  function placeFromGoogle(p) {
    if (!p || !p.geometry || !p.geometry.location) return null;
    const loc = p.geometry.location;
    const lat = typeof loc.lat === "function" ? loc.lat() : loc.lat;
    const lng = typeof loc.lng === "function" ? loc.lng() : loc.lng;

    return {
      address: p.formatted_address || p.name || "",
      placeId: p.place_id || "",
      lat, lng,
      name: p.name || "",
      types: Array.isArray(p.types) ? p.types : []
    };
  }

  function setMarker(which, lat, lng) {
    const latlng = { lat, lng };
    if (which === "pickup") {
      pickupLatLng = new google.maps.LatLng(lat, lng);
      if (pickupMarker) pickupMarker.setMap(null);
      pickupMarker = new google.maps.Marker({ position: latlng, map, icon: { url: "http://maps.google.com/mapfiles/ms/icons/green-dot.png" } });
    } else if (which === "dropoff") {
      dropoffLatLng = new google.maps.LatLng(lat, lng);
      if (dropoffMarker) dropoffMarker.setMap(null);
      dropoffMarker = new google.maps.Marker({ position: latlng, map, icon: { url: "http://maps.google.com/mapfiles/ms/icons/red-dot.png" } });
    }
  }

  function hydrateFromStoredPlace(which) {
    const key = which === "pickup" ? PLACE_KEYS.pickup : PLACE_KEYS.dropoff;
    const stored = loadPlace(key);
    if (!stored || !stored.address) return;

    const el = document.getElementById(which);
    if (el && !String(el.value||"").trim()) el.value = formatPlaceLine(stored.name, stored.address);

    if (stored.lat && stored.lng && googleReady) {
      setMarker(which, stored.lat, stored.lng);
    }
    syncLuggageVisibility();
  }

  function attachManualTypingWatcher(which) {
    const el = document.getElementById(which);
    if (!el) return;

    const key = which === "pickup" ? PLACE_KEYS.pickup : PLACE_KEYS.dropoff;
    el.addEventListener("input", () => {
      repeatLocked = false;
      if (sessionStorage.getItem(key)) clearPlace(key);
      if (which === "pickup") pickupLatLng = null;
      if (which === "dropoff") dropoffLatLng = null;
      applyAutoRateLabels();
      updateFairnessPreview();
      syncLuggageVisibility();
    });
  }

  function setupAutocomplete(id, role) {
    const input = document.getElementById(id);
    if (!input) return null;

    const okcBounds = new google.maps.LatLngBounds(
      { lat: 34.9000, lng: -98.2000 },
      { lat: 36.0000, lng: -96.0000 }
    );

    const options = {
      bounds: okcBounds,
      strictBounds: false,
      componentRestrictions: { country: "us" },
      fields: ["formatted_address", "geometry.location", "name", "place_id", "types"]
    };

    const ac = new google.maps.places.Autocomplete(input, options);

    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        pos => {
          try {
            const loc = new google.maps.LatLng(pos.coords.latitude, pos.coords.longitude);
            const biasBounds = new google.maps.LatLngBounds(loc, loc);
            ac.setBounds(biasBounds);
          } catch (e) {}
        },
        () => {},
        { enableHighAccuracy:true, maximumAge:15000, timeout:8000 }
      );
    }

    ac.addListener("place_changed", () => {
      const p = ac.getPlace();
      const packed = placeFromGoogle(p);
      if (!packed) return;

      input.value = formatPlaceLine(packed.name, packed.address);

      if (role === "pickup") {
        savePlace(PLACE_KEYS.pickup, packed);
        if (packed.lat && packed.lng) setMarker("pickup", packed.lat, packed.lng);
        applyAutoRateLabels();
        updateFairnessPreview();
        syncLuggageVisibility();
        requestAutoRouteRender();
      } else if (role === "dropoff") {
        savePlace(PLACE_KEYS.dropoff, packed);
        if (packed.lat && packed.lng) setMarker("dropoff", packed.lat, packed.lng);
        applyAutoRateLabels();
        updateFairnessPreview();
        syncLuggageVisibility();
        requestAutoRouteRender();
      } else if (role === "stop") {
        savePlace(PLACE_KEYS.stopPrefix + id, packed);
        requestAutoRouteRender();
      }
    });

    return ac;
  }

  function addStopField() {
    if (stopInputs.length >= 3) { alert("Limit 3 stops."); return; }
    const id = "stop_" + Date.now() + "_" + Math.floor(Math.random()*1000);
    stopInputs.push(id);

    const wrap = document.getElementById("stopsWrap");
    const div = document.createElement("div");
    div.className = "input-group";
    div.id = "row_" + id;
    div.innerHTML = `
      <label>Stop ${stopInputs.length}</label>
      <div style="display:flex;gap:6px;align-items:center;">
        <input id="${id}" type="text" placeholder="Enter stop address or place" style="flex:1;">
        <button type="button" class="btn btn-secondary btn-small" onclick="removeStop('${id}')">‚úñ</button>
      </div>
    `;
    wrap.appendChild(div);

    setupAutocomplete(id, "stop");

    const stopEl = document.getElementById(id);
    stopEl.addEventListener("input", () => { repeatLocked = false; clearPlace(PLACE_KEYS.stopPrefix + id); });
  }

  function removeStop(id) {
    const row = document.getElementById("row_" + id);
    if (row) row.remove();
    stopInputs = stopInputs.filter(x => x !== id);
    clearPlace(PLACE_KEYS.stopPrefix + id);
    requestAutoRouteRender();
  }
  window.removeStop = removeStop;

  // =====================================================
  // EARLY REPEAT PREFILL (authoritative overwrite)
  // =====================================================
  async function prefillFromRepeatRideIfAny_EARLY() {
    try {
      const u = new URL(location.href);

      const repeatId =
        (u.searchParams.get("repeat") ||
         u.searchParams.get("repeatId") ||
         u.searchParams.get("repeat_id") ||
         u.searchParams.get("rideId") ||
         u.searchParams.get("ride_id") ||
         u.searchParams.get("bookingId") ||
         u.searchParams.get("booking_id") ||
         u.searchParams.get("id") ||
         "").trim();

      if (!repeatId) return false;

      setLastRideId(repeatId);

      repeatLocked = true;

      const res = await fetch(`${API_BOOK}/api/bookings/${encodeURIComponent(repeatId)}?t=${Date.now()}`, { cache: "no-store" });
      if (!res.ok) { console.warn("Repeat fetch failed:", res.status); repeatLocked = false; return false; }

      const raw = await res.json();
      const r = raw?.booking || raw?.data || raw;
      if (!r) { repeatLocked = false; return false; }

      const pickupObj  = (r.pickup && typeof r.pickup === "object") ? r.pickup : {};
      const dropoffObj = (r.dropoff && typeof r.dropoff === "object") ? r.dropoff : {};

      const pickupAddr = pickFirstString(
        pickupObj.address,
        r.pickupAddress,
        r.pickup_address,
        r.pickupAddr,
        (typeof r.pickup === "string" ? r.pickup : "")
      );

      const dropoffAddr = pickFirstString(
        dropoffObj.address,
        r.dropoffAddress,
        r.dropoff_address,
        r.dropoffAddr,
        (typeof r.dropoff === "string" ? r.dropoff : "")
      );

      const pickupName  = pickFirstString(pickupObj.name,  r.pickupName,  r.pickup_name);
      const dropoffName = pickFirstString(dropoffObj.name, r.dropoffName, r.dropoff_name);

      const pEl = document.getElementById("pickup");
      const dEl = document.getElementById("dropoff");

      if (pEl && pickupAddr)  pEl.value = formatPlaceLine(pickupName, pickupAddr);
      if (dEl && dropoffAddr) dEl.value = formatPlaceLine(dropoffName, dropoffAddr);

      const gEl = document.getElementById("gateCode");
      const gateVal = String(
        pickupObj?.gate ||
        pickupObj?.access ||
        pickupObj?.notes ||
        r.pickupGate ||
        r.gateCode ||
        ""
      ).trim();
      if (gEl) gEl.value = gateVal;

      const pax = Number(r?.rider?.partySize ?? r?.passengers ?? 1);
      const paxEl = document.getElementById("passengers");
      if (paxEl && Number.isFinite(pax) && pax > 0) paxEl.value = String(Math.min(6, pax));

      const lug = Number(r?.metadata?.luggageCount ?? 0);
      const lugEl = document.getElementById("luggageCount");
      if (lugEl && Number.isFinite(lug) && lug >= 0) lugEl.value = String(Math.min(6, lug));

      try {
        if (pickupAddr) {
          sessionStorage.setItem(PLACE_KEYS.pickup, JSON.stringify({
            address: pickupAddr,
            placeId: pickupObj.placeId || pickupObj.placeID || "",
            lat: (typeof pickupObj.lat === "number") ? pickupObj.lat : null,
            lng: (typeof pickupObj.lng === "number") ? pickupObj.lng : null,
            name: pickupName || "",
            types: Array.isArray(pickupObj.types) ? pickupObj.types : []
          }));
        }
        if (dropoffAddr) {
          sessionStorage.setItem(PLACE_KEYS.dropoff, JSON.stringify({
            address: dropoffAddr,
            placeId: dropoffObj.placeId || dropoffObj.placeID || "",
            lat: (typeof dropoffObj.lat === "number") ? dropoffObj.lat : null,
            lng: (typeof dropoffObj.lng === "number") ? dropoffObj.lng : null,
            name: dropoffName || "",
            types: Array.isArray(dropoffObj.types) ? dropoffObj.types : []
          }));
        }
      } catch(e) {}

      try {
        stopInputs.slice().forEach(id => removeStop(id));
        stopInputs = [];
        pendingStopsToHydrate = [];
      } catch(e) {}

      const stops = Array.isArray(r.stops) ? r.stops : [];
      for (const s of stops) {
        const addr = pickFirstString(s?.address, s?.addr, s?.location);
        if (!addr) continue;

        const name = pickFirstString(s?.name, s?.stopName);
        addStopField_NoAutocomplete(formatPlaceLine(name, addr));

        const lastId = pendingStopsToHydrate[pendingStopsToHydrate.length - 1];
        try {
          sessionStorage.setItem(PLACE_KEYS.stopPrefix + lastId, JSON.stringify({
            address: addr,
            placeId: s?.placeId || s?.placeID || "",
            lat: (typeof s?.lat === "number") ? s.lat : null,
            lng: (typeof s?.lng === "number") ? s.lng : null,
            name: name || "",
            types: Array.isArray(s?.types) ? s.types : []
          }));
        } catch(e) {}
      }

      ["repeat","repeatId","repeat_id","rideId","ride_id","bookingId","booking_id","id"].forEach(k => u.searchParams.delete(k));
      history.replaceState({}, "", u.pathname + (u.search || "") + (u.hash || ""));

      showToast("Ride loaded ‚úÖ");
      syncLuggageVisibility();
      requestAutoRouteRender();
      return true;
    } catch (e) {
      console.warn("early repeat prefill failed:", e);
      repeatLocked = false;
      return false;
    }
  }

  // ‚úÖ BULLETPROOF ORDER
  document.addEventListener("DOMContentLoaded", async () => {
    build15MinOptions(document.getElementById("reserveTimeSelect"));
    initDefaultScheduleIfEmpty();

    document.getElementById("reserveDate")?.addEventListener("change", applyAutoRateLabels);
    document.getElementById("reserveTimeSelect")?.addEventListener("change", applyAutoRateLabels);

    const didRepeat = await prefillFromRepeatRideIfAny_EARLY();

    if (!didRepeat && !repeatLocked) {
      prefillFromEstimateQuery_EARLY();
      applyHandoffPickupIfAny();
      applyHandoffDropoffIfAny();
      initDefaultScheduleIfEmpty();
    }
  });

  // =====================================================
  // PROFILE SUMMARY
  // =====================================================
  function loadProfileSummary() {
    const name  = localStorage.getItem("riderName")  || "";
    const phone = localStorage.getItem("riderPhone") || "";
    const home  = localStorage.getItem("riderHome")  || "";
    const gate  = localStorage.getItem("riderGate")  || "";

    const rid = ensureRiderId();
    const summary = document.getElementById("profileSummary");

    if (!name && !phone) {
      summary.innerHTML = `Not logged in. <strong><a href="/rider-login.html" style="color:#ff6666;">Tap here to log in</a></strong>.`;
    } else {
      const phonePretty = phone ? formatPhone(phone) : "";
      summary.innerHTML =
        `<span><strong>${name || "Rider"}</strong>${phonePretty ? " ¬∑ " + phonePretty : ""}</span>` +
        (home ? `<br><span>Home pickup: ${home}</span>` : "") +
        `<br><span style="font-size:0.7rem;color:#666;">Profile ID: ${rid}</span>`;
    }

    if (!repeatLocked) {
      const pickEl = document.getElementById("pickup");
      if (home && pickEl && !String(pickEl.value||"").trim()) pickEl.value = home;

      const gateEl = document.getElementById("gateCode");
      if (gate && gateEl && !String(gateEl.value||"").trim()) gateEl.value = gate;
    }

    syncLuggageVisibility();
  }

  function formatPhone(p) {
    const digits = String(p || "").replace(/\D/g, "");
    if (digits.length === 10) return `(${digits.slice(0,3)}) ${digits.slice(3,6)}-${digits.slice(6)}`;
    return p;
  }

  // =====================================================
  // GEOLOCATION BUTTONS
  // =====================================================
  function useMyLocation(which) {
    if (!navigator.geolocation) { alert("Location services not supported."); return; }

    navigator.geolocation.getCurrentPosition(
      pos => {
        repeatLocked = false;
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        const latlng = { lat, lng };

        geocoder.geocode({ location: latlng }, (res, stat) => {
          const addr = (stat === "OK" && res[0]) ? res[0].formatted_address : `${lat.toFixed(5)}, ${lng.toFixed(5)}`;
          const input = document.getElementById(which);
          input.value = addr;

          const packed = { address: addr, placeId: "", lat, lng, name: "", types: [] };

          if (which === "pickup") {
            pickupLatLng = new google.maps.LatLng(lat, lng);
            savePlace(PLACE_KEYS.pickup, packed);
            if (pickupMarker) pickupMarker.setMap(null);
            pickupMarker = new google.maps.Marker({ position: latlng, map, icon: { url: "http://maps.google.com/mapfiles/ms/icons/green-dot.png" } });
          } else {
            dropoffLatLng = new google.maps.LatLng(lat, lng);
            savePlace(PLACE_KEYS.dropoff, packed);
            if (dropoffMarker) dropoffMarker.setMap(null);
            dropoffMarker = new google.maps.Marker({ position: latlng, map, icon: { url: "http://maps.google.com/mapfiles/ms/icons/red-dot.png" } });
          }

          map.panTo(latlng);
          applyAutoRateLabels();
          updateFairnessPreview();
          syncLuggageVisibility();
          requestAutoRouteRender();
        });
      },
      err => alert("Unable to get location: " + err.message),
      { enableHighAccuracy:true, maximumAge:8000, timeout:8000 }
    );
  }

  document.getElementById("useLocPickup").addEventListener("click", () => useMyLocation("pickup"));
  document.getElementById("useLocDrop").addEventListener("click", () => useMyLocation("dropoff"));
  document.getElementById("addStopBtn").addEventListener("click", addStopField);

  // =====================================================
  // HOLIDAY / RUSH / EVENT / AIRPORT
  // =====================================================
  function getHolidayInfo(d) {
    if (!(d instanceof Date) || isNaN(d)) return null;
    const m = d.getMonth();
    const day = d.getDate();
    const weekday = d.getDay();

    if (m === 10 && weekday === 4) {
      const nth = Math.floor((day - 1) / 7) + 1;
      if (nth === 4) return { code: "thanksgiving", message: "ü¶É Holiday base ($20) applies for Thanksgiving rides." };
    }

    if (m === 11 && day === 24) return { code:"christmas_eve", message:"üéÑ Christmas Eve ‚Äì Holiday base ($20) applies." };
    if (m === 11 && day === 25) return { code:"christmas_day", message:"üéÑ Christmas Day ‚Äì Holiday base ($20) applies." };
    if (m === 11 && day === 31) return { code:"nye", message:"üéâ New Year's Eve ‚Äì Holiday base ($20) applies." };
    if (m === 0  && day === 1)  return { code:"nyd", message:"üéâ New Year's Day ‚Äì Holiday base ($20) applies." };

    return null;
  }

  function isWeekdayRushHour(d) {
    const day = d.getDay();
    const h = d.getHours();
    if (day === 0 || day === 6) return false;
    return (h >= 5 && h < 9) || (h >= 15 && h < 19);
  }

  const SPECIAL_EVENT_KEYWORDS = [
    "paycom center",
    "riverwind casino",
    "lucky star",
    "gaylord family oklahoma memorial stadium",
    "boone pickens stadium",
    "chickasaw bricktown ballpark",
    "memorial stadium",
    "ou stadium",
    "osu stadium"
  ];

  function getEffectiveDate() {
    const dStr = document.getElementById("reserveDate").value;
    const tStr = getReserveTimeValue();
    if (dStr && tStr) return new Date(dStr + "T" + tStr + ":00");
    return new Date();
  }

  function isAirportText(s) {
    const t = String(s || "").toLowerCase();
    return t.includes("airport") || t.includes("will rogers");
  }
  function isAirportPlace(stored) {
    if (!stored) return false;
    const name = String(stored.name || "").toLowerCase();
    const addr = String(stored.address || "").toLowerCase();
    const types = Array.isArray(stored.types) ? stored.types.map(x => String(x).toLowerCase()) : [];
    return types.includes("airport") || name.includes("airport") || name.includes("will rogers") || addr.includes("airport") || addr.includes("will rogers");
  }

  function isAirportTripNow(){
    const pickupText = document.getElementById("pickup").value || "";
    const dropText   = document.getElementById("dropoff").value || "";
    const pStored = loadPlace(PLACE_KEYS.pickup);
    const dStored = loadPlace(PLACE_KEYS.dropoff);

    return isAirportText(pickupText) || isAirportText(dropText) || isAirportPlace(pStored) || isAirportPlace(dStored);
  }

  function readLuggageCount(){
    const el = document.getElementById("luggageCount");
    const v = Number(el?.value ?? 0);
    return Number.isFinite(v) ? v : 0;
  }

  function syncLuggageVisibility(){
    const wrap = document.getElementById("luggageWrap");
    const luggageEl = document.getElementById("luggageCount");
    if(!wrap || !luggageEl) return;

    if(isAirportTripNow()){
      wrap.style.display = "block";
    } else {
      wrap.style.display = "none";
      luggageEl.value = "0";
    }
  }

  ["pickup","dropoff"].forEach(id=>{
    const el = document.getElementById(id);
    if(el){
      el.addEventListener("input", syncLuggageVisibility);
      el.addEventListener("change", syncLuggageVisibility);
    }
  });

  function applyAutoRateLabels() {
    const pickupText = (document.getElementById("pickup").value || "").toLowerCase();
    const dropText   = (document.getElementById("dropoff").value || "").toLowerCase();
    const effective  = getEffectiveDate();

    const rush    = isWeekdayRushHour(effective);
    const airport = isAirportTripNow();
    const event   = SPECIAL_EVENT_KEYWORDS.some(k => pickupText.includes(k) || dropText.includes(k));
    const holidayInfo = getHolidayInfo(effective);

    const rushNote    = document.getElementById("rushhour-note");
    const airportNote = document.getElementById("airport-note");
    const eventNote   = document.getElementById("event-note");

    rushNote.textContent = "";
    airportNote.textContent = "";
    eventNote.textContent = "";

    syncLuggageVisibility();

    if (holidayInfo) {
      eventNote.textContent = holidayInfo.message;
      return { baseType: "holiday", base: 20 };
    }
    if (event) {
      eventNote.textContent = "üìç Special event area ‚Äì Event base ($20) may apply.";
      return { baseType: "event", base: 20 };
    }
    if (airport) {
      airportNote.textContent = "‚úàÔ∏è Airport run ‚Äì Airport base ($15) applies.";
      return { baseType: "airport", base: 15 };
    }
    if (rush) {
      rushNote.textContent = "üö¶ Weekday Rush Hour (5‚Äì9 AM / 3‚Äì7 PM).";
      return { baseType: "rush", base: 15 };
    }
    return { baseType: "standard", base: 10 };
  }

  // =====================================================
  // FAIRNESS FEE (Option B: origin = live GPS when available)
  // =====================================================
  function distMi(a, b) {
    const p1 = new google.maps.LatLng(a.lat, a.lng);
    const p2 = new google.maps.LatLng(b.lat, b.lng);
    return google.maps.geometry.spherical.computeDistanceBetween(p1, p2) / 1609.34;
  }

      function computeFairnessFee(miles /*, basePlusMiles */) {
      if (!pickupLatLng) return 0;
    
      const pickup = { lat: pickupLatLng.lat(), lng: pickupLatLng.lng() };
      const origin = fairnessOrigin || HQ;
      const d = distMi(origin, pickup);
    
      let zoneFee = 0;
      if (d > 40) zoneFee = 20;
      else if (d > 20) zoneFee = 10;
    
      // ‚úÖ Waive only for true long trips (prevents rush base from killing it)
      if (zoneFee > 0 && miles > 20) zoneFee = 0;
    
      return zoneFee;
    }

  function updateFairnessPreview() {
    const note = document.getElementById("fairness-note");
    note.textContent = "";
    if (!pickupLatLng) return;

    const pickup = { lat: pickupLatLng.lat(), lng: pickupLatLng.lng() };
    const origin = fairnessOrigin || HQ;
    const d = distMi(origin, pickup);

    if (d > 40) note.textContent = "üìç Pickup is well outside the central metro / current driver area. A travel fairness fee may apply depending on total trip distance.";
    else if (d > 20) note.textContent = "üìç Pickup is outside the central zone / current driver area. A small travel fairness fee may apply depending on trip distance.";
  }

  // =====================================================
  // ROUTE URL
  // =====================================================
  function buildRouteUrl(pickup, dropoff, stops) {
    const base = "https://www.google.com/maps/dir/?api=1";
    let url = base + "&origin=" + encodeURIComponent(pickup) + "&destination=" + encodeURIComponent(dropoff);
    if (stops && stops.length > 0) url += "&waypoints=" + encodeURIComponent(stops.join("|"));
    return url;
  }

  // =====================================================
  // FARE CALCULATION
  // =====================================================
  let lastFare = null;
  let requestInFlight = false;

  function getStopsAsTextList() {
    return stopInputs
      .map(id => (document.getElementById(id)?.value || "").trim())
      .filter(Boolean);
  }

  function getStopsAsObjects() {
    return stopInputs
      .map(id => {
        const addr = (document.getElementById(id)?.value || "").trim();
        if (!addr) return null;
        const stored = loadPlace(PLACE_KEYS.stopPrefix + id);
        return {
          address: addr,
          placeId: stored?.placeId || null,
          lat: (typeof stored?.lat === "number") ? stored.lat : null,
          lng: (typeof stored?.lng === "number") ? stored.lng : null,
          name: stored?.name || null,
          types: Array.isArray(stored?.types) ? stored.types : []
        };
      })
      .filter(Boolean);
  }

  async function calculateFare() {
    const rd = (document.getElementById("reserveDate")?.value || "").trim();
    const rt = (getReserveTimeValue() || "").trim();
    if (!rd || !rt) { showToast("Select date & time"); return; }

    const pickup = document.getElementById("pickup").value.trim();
    const dropoff = document.getElementById("dropoff").value.trim();
    if (!pickup || !dropoff) { showToast("Enter pickup & drop-off"); return; }

    const waypoints = stopInputs
      .map(id => {
        const v = document.getElementById(id)?.value.trim();
        return v ? { location: v, stopover: true } : null;
      })
      .filter(Boolean);

    let route;
    try {
      route = await new Promise((resolve, reject) => {
        directionsService.route(
          { origin: pickup, destination: dropoff, waypoints, travelMode: "DRIVING" },
          (r, status) => status === "OK" ? resolve(r) : reject(status)
        );
      });
    } catch (errStatus) {
      alert("Unable to get route from Google Maps. Please double-check addresses.");
      return;
    }

    directionsRenderer.setDirections(route);
    if (route?.routes?.[0]?.bounds) map.fitBounds(route.routes[0].bounds);

    let miles = 0;
    let minutes = 0;
    route.routes[0].legs.forEach(l => {
      miles   += (l.distance?.value || 0) / 1609.34;
      minutes += (l.duration?.value || 0) / 60;
    });
    miles   = Math.round(miles);
    minutes = Math.round(minutes);

    const rate = applyAutoRateLabels();
    const base = rate.base;

    const tier2 = Math.max(0, Math.min(10, miles - 10)) * 1.25;
    const tier3 = Math.max(0, miles - 20) * 1.0;
    const mileageSub = tier2 + tier3;

    const basePlusMiles = base + mileageSub;

    // ‚úÖ Option B: refresh live driver origin BEFORE fairness calc
    await fetchDriverOriginFromLiveGPS();

    const fairnessFee = computeFairnessFee(miles);

    const pay = document.getElementById("payment").value;
    let fare = basePlusMiles + fairnessFee;
    if (pay === "card") fare += fare * 0.033 + fare * 0.024;

    const total = fare.toFixed(2);
    document.getElementById("estimateDisplay").value = "$" + total;

    const resDiv = document.getElementById("result");
    resDiv.style.display = "block";
    resDiv.innerHTML = `
      <div class="total">$${total}</div>
      <p><strong>Base:</strong> $${base.toFixed(2)}</p>
      <p><strong>Mileage:</strong> $${mileageSub.toFixed(2)} (${miles} mi)</p>
      ${fairnessFee > 0 ? `<p><strong>Travel Fairness Fee:</strong> $${fairnessFee.toFixed(2)}</p>` : ""}
      <p><strong>Payment:</strong> ${pay === "card" ? "Card (incl. fees)" : "Cash / Venmo / Cash App"}</p>
      <p>‚è±Ô∏è Approx. ${Math.round(minutes)} min</p>
      <div style="text-align:center;margin-top:10px;">
        <button class="btn btn-primary" id="btnRequest" type="button">üì© Request This Ride</button>
      </div>
    `;

    lastFare = {
      pickup, dropoff, miles, minutes, base, mileageSub, fairnessFee,
      total: Number(total),
      pay,
      mode,
      stopsText: getStopsAsTextList(),
      stopsObj: getStopsAsObjects(),
      reserveDate: rd,
      reserveTime: rt,
      planBy: document.getElementById("planBy").value,
      passengers: Number(document.getElementById("passengers").value || "1"),
      luggageCount: readLuggageCount(),
      gateCode: document.getElementById("gateCode").value.trim()
    };

    document.getElementById("btnRequest").onclick = sendRequest;

    updateFairnessPreview();
  }

  document.getElementById("calcBtn").addEventListener("click", calculateFare);

  // =====================================================
  // SEND REQUEST ‚Üí BOOKINGS + PUSH + SMS
  // =====================================================
  async function sendRequest() {
    if (!lastFare) { showToast("Get an estimate first."); return; }
    if (requestInFlight) { showToast("Request already sending‚Ä¶"); return; }
    if (!lastFare.reserveDate || !lastFare.reserveTime) { showToast("Select date & time"); return; }

    requestInFlight = true;

    const name  = localStorage.getItem("riderName")  || "Rider";
    const phone = localStorage.getItem("riderPhone") || "";
    const riderId = ensureRiderId();
    const q = lastFare;

    const localISO = q.reserveDate + "T" + q.reserveTime + ":00";
    const scheduledISO = new Date(localISO).toISOString();

    const routeUrl = buildRouteUrl(q.pickup, q.dropoff, q.stopsText || []);
    const pickupStored = loadPlace(PLACE_KEYS.pickup);
    const dropStored   = loadPlace(PLACE_KEYS.dropoff);

    const bookingType = "RESERVATION";

    const payload = {
      type: bookingType,
      pickup: {
        address: q.pickup,
        name: pickupStored?.name || null,
        gate: q.gateCode || "",
        placeId: pickupStored?.placeId || null,
        lat: (typeof pickupStored?.lat === "number") ? pickupStored.lat : null,
        lng: (typeof pickupStored?.lng === "number") ? pickupStored.lng : null
      },
      dropoff: {
        address: q.dropoff,
        name: dropStored?.name || null,
        placeId: dropStored?.placeId || null,
        lat: (typeof dropStored?.lat === "number") ? dropStored.lat : null,
        lng: (typeof dropStored?.lng === "number") ? dropStored.lng : null
      },
      stops: (q.stopsObj || []).map(s => ({
        address: s.address,
        name: s.name || null,
        placeId: s.placeId || null,
        lat: (typeof s.lat === "number") ? s.lat : null,
        lng: (typeof s.lng === "number") ? s.lng : null
      })),
      rider: {
        name, phone,
        partySize: q.passengers || 1,
        riderId,
        notifyPref: getNotifyPref()
      },
      pricing: {
        estimate: Number(q.total),
        travelFee: q.fairnessFee || 0,
        ratePlan: "RESERVATION"
      },
      metrics: { miles: q.miles, minutes: q.minutes },
      scheduledFor: scheduledISO,
      source: "RIDE_REQUEST",
      metadata: {
        luggageCount: (q.luggageCount ?? 0),
        routeUrl,
        notifyPref: getNotifyPref(),
        planBy: q.planBy || "pickup"
      }
    };

    let res;
    try {
      res = await fetch(API_BOOK + "/api/bookings", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify(payload)
      });
    } catch (e) {
      requestInFlight = false;
      alert("Network error sending request. Please try again or text RED.");
      return;
    }

    if (!res.ok) {
      requestInFlight = false;
      alert("Error sending request. Please text RED with your details.");
      return;
    }

    const booking = await res.json();
    const rideId = booking.id;

    setLastRideId(rideId);
    localStorage.setItem("lastRideId", rideId);

    try {
      await fetch(PUSH_API, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-Ride-Push-Key": "ride_request_ok"
        },
        body: JSON.stringify({
          rideId,
          riderName: name,
          pickup: q.pickup,
          dropoff: q.dropoff,
          passengers: q.passengers || 1,
          luggageCount: (q.luggageCount ?? 0),
          estimate: q.total,
          scheduledFor: scheduledISO
        })
      });
    } catch (e) {
      console.warn("Ride request push failed (non-blocking)", e);
    }

    const btn = document.getElementById("btnRequest");
    if (btn) {
      btn.disabled = true;
      btn.textContent = "Request Sent";
    }

    const stopsText = (q.stopsText && q.stopsText.length) ? q.stopsText.join(" ‚Üí ") : "None";
    const whenText = `${q.reserveDate} at ${q.reserveTime}`;
    const shortRoute = `https://bigredconnectokc.com/rider/route.html?id=${encodeURIComponent(rideId)}`;

    const smsBody =
      `Hey Big Red ‚Äî this is ${name}.\n` +
      `I'd like to request this ride:\n\n` +
      `Pickup: ${q.pickup}\n` +
      `Dropoff: ${q.dropoff}\n` +
      `Stops: ${stopsText}\n` +
      `Miles: ${q.miles}\n` +
      `Estimated Fare: $${q.total}\n` +
      `When: ${whenText}\n` +
      `Plan By: ${q.planBy || "pickup"}\n` +
      `Passengers: ${q.passengers}\n` +
      `Luggage: ${q.luggageCount ?? 0}\n` +
      `Gate / Access: ${q.gateCode || "None"}\n` +
      `Ride ID: ${rideId}\n` +
      `Route: ${shortRoute}`;

    const smsUrl = "sms:+14053784024?&body=" + encodeURIComponent(smsBody);
    const trackUrl = "/rider/myride.html?id=" + encodeURIComponent(rideId);

    alert("Almost done! You‚Äôll now be switched to Messages.\n\nPlease tap SEND in the text to finish submitting your ride request to Big Red.");
    window.location.href = smsUrl;

    setTimeout(() => {
      try { window.location.href = trackUrl; } catch (e) {}
    }, 1500);
  }

  // =====================================================
  // GOOGLE INIT
  // =====================================================
  window.initGoogle = function () {
    geocoder = new google.maps.Geocoder();
    directionsService = new google.maps.DirectionsService();
    directionsRenderer = new google.maps.DirectionsRenderer({ suppressMarkers:true });

    map = new google.maps.Map(document.getElementById("map"), {
      center: { lat: 35.4676, lng: -97.5164 },
      zoom: 11,
      disableDefaultUI: true,
      gestureHandling: "greedy",
      styles: [
        { elementType:"geometry", stylers:[{ color:"#1a1a1a" }] },
        { elementType:"labels.text.stroke", stylers:[{ color:"#1a1a1a" }] },
        { elementType:"labels.text.fill", stylers:[{ color:"#ffffff" }] },
        { featureType:"poi", elementType:"geometry", stylers:[{ color:"#111" }] }
      ]
    });

    directionsRenderer.setMap(map);
    googleReady = true;

    setupAutocomplete("pickup", "pickup");
    setupAutocomplete("dropoff", "dropoff");
    attachManualTypingWatcher("pickup");
    attachManualTypingWatcher("dropoff");

    if (Array.isArray(pendingStopsToHydrate) && pendingStopsToHydrate.length) {
      pendingStopsToHydrate.forEach(id => {
        try { setupAutocomplete(id, "stop"); } catch(e) {}
      });
      pendingStopsToHydrate = [];
    }

    hydrateFromStoredPlace("pickup");
    hydrateFromStoredPlace("dropoff");

    ensureRiderId();
    loadProfileSummary();

    // ‚úÖ Option B: load live GPS origin once on init (non-blocking)
    fetchDriverOriginFromLiveGPS().finally(() => {
      syncLuggageVisibility();
      applyAutoRateLabels();
      updateFairnessPreview();
    });

    setTimeout(renderRouteFromCurrentInputs, 200);
    if (pendingAutoRoute) setTimeout(renderRouteFromCurrentInputs, 250);
  };

  window.addEventListener("error", (e) => {
    if (String(e.filename || "").includes("maps.googleapis.com")) {
      console.warn("Google Maps failed to load.");
      showToast("Map failed to load, but you can still text RED.");
    }
  });
</script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCMM0dxLNM7XQI5G3OBSnINeO5hcS3Ks5I&libraries=places,geometry&callback=initGoogle" async defer></script>

<script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
<script>
  window.OneSignalDeferred = window.OneSignalDeferred || [];
  OneSignalDeferred.push(async function(OneSignal){
    try {
      const raw = localStorage.getItem("bigred_rider_profile_v1");
      if (!raw) return;
      const profile = JSON.parse(raw);
      if (!profile.riderId) return;
      await OneSignal.login(profile.riderId);
      console.log("üîî Rider push identity confirmed:", profile.riderId);
    } catch (e) {
      console.warn("Rider push identity skipped:", e);
    }
  });
</script>

<script src="/rider/session-guard.js"></script>

</body>
</html>