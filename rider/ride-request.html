<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Request a Ride ‚Äì Big Red Connect</title>

  <!-- Icons / PWA -->
  <link rel="apple-touch-icon" href="/icon.PNG">
  <link rel="icon" type="image/png" sizes="192x192" href="/icon.png">
  <link rel="shortcut icon" href="/icon.PNG">
  <link rel="manifest" href="manifest-rider.json">
  <meta name="theme-color" content="#000000">

  <!-- Google Maps -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCMM0dxLNM7XQI5G3OBSnINeO5hcS3Ks5I&libraries=places,geometry&callback=initGoogle" async defer></script>

  <link rel="stylesheet" href="/style.css"/>
</head>

<body>

<!-- Header -->
<div class="logo-header">
  <a href="/rider/rider.html">
    <img src="/icon.PNG" alt="Big Red Connect Logo"/>
  </a>
</div>

<!-- Home Button -->
<div class="top-home-btn" style="text-align:center; margin:10px 0 15px;">
  <a href="/rider/rider.html" class="btn secondary">‚¨Ö Back to Rider Hub</a>
</div>

<h1>Ride Request</h1>
<p class="tagline">Plan your connection ‚Äî affordable, local, predictable.</p>

<section class="info-section calculator">

  <!-- Ride Mode -->
  <div class="ride-mode-toggle">
    <button id="modeNow" class="btn btn-toggle active" type="button">üöó Ride Now</button>
    <button id="modeReserve" class="btn btn-toggle" type="button">üïí Reserve Ride</button>
  </div>

  <!-- Reserve Controls -->
  <div id="reserveControls" style="display:none;">
    <label for="reserveDate">Date</label>
    <input id="reserveDate" type="date">
    <label for="reserveTime">Time</label>
    <input id="reserveTime" type="time">
    <label for="planBy">Plan By</label>
    <select id="planBy">
      <option value="pickup">Pickup Time</option>
      <option value="dropoff">Drop-Off Time</option>
    </select>
  </div>

  <!-- Pickup -->
  <label for="pickup">Pickup Location</label>
  <input id="pickup" type="text" placeholder="Enter pickup address">

  <button id="useLocPickup" class="btn primary" type="button">üìç Use My Location</button>

  <!-- Stops -->
  <div id="stopsWrap"></div>
  <button id="addStopBtn" class="btn primary" type="button">‚ûï Add Stop</button>

  <!-- Dropoff -->
  <label for="dropoff">Drop-off Location</label>
  <input id="dropoff" type="text" placeholder="Enter drop-off address">

  <button id="useLocDrop" class="btn secondary" type="button">üìç Use My Location</button>

  <!-- Luggage (hidden until airport detected) -->
  <div id="luggageBlock" style="display:none;">
    <label for="luggageCount">Luggage (Airport trips only)</label>
    <select id="luggageCount">
      <option value="0">0 bags</option>
      <option value="1">1 bag</option>
      <option value="2">2 bags</option>
      <option value="3">3 bags</option>
      <option value="4">4 bags</option>
      <option value="5">5+ bags</option>
    </select>
  </div>

  <!-- Passengers -->
  <label for="passengers">Passengers</label>
  <select id="passengers">
    <option value="1">1 passenger</option>
    <option value="2">2 passengers</option>
    <option value="3">3 passengers</option>
    <option value="4">4 passengers</option>
    <option value="5">5 passengers</option>
    <option value="6">6 passengers</option>
  </select>

  <!-- Map -->
  <div id="map"></div>

  <!-- Dynamic Notes -->
  <div id="airport-note"></div>
  <div id="event-note"></div>
  <div id="rushhour-note"></div>
  <div id="fairness-note"></div>
  <div id="holiday-note" style="color:#ffcc00;font-weight:600;"></div>

  <!-- Hidden Rate Type -->
  <select id="tripType" style="display:none;">
    <option value="10">Standard</option>
    <option value="15">Rush</option>
    <option value="15_airport">Airport</option>
    <option value="20">Holiday / Event</option>
  </select>

  <!-- Payment -->
  <label for="payment">Payment Method</label>
  <select id="payment">
    <option value="cash">Cash / Venmo / Cash App</option>
    <option value="card">Card (+3.3% + 2.4% fees)</option>
  </select>

  <!-- Calculate -->
  <button id="calcBtn" class="btn primary" style="margin-top:20px;">
    üí≤ Calculate Fare
  </button>

  <div id="result" style="display:none;"></div>

  <p class="smallnote">
    *Estimate only ‚Äî final price may vary slightly based on route or wait time.
  </p>
</section>

<footer>
  <p>&copy; 2025 Big Red Connect</p>
</footer>

<script>
/* --------------------------
   CONFIG
--------------------------- */
const HQ = { lat: 35.3207, lng: -97.4929 };
const WORKER_BOOK = "https://bigred-bookings.bigredtransportation.workers.dev/api/bookings";
const WORKER_LOC = "https://location-reader.bigredtransportation.workers.dev";

/* --------------------------
   STATE
--------------------------- */
let map, geocoder, directionsService, directionsRenderer;
let pickupLatLng = null, dropoffLatLng = null;
let stopInputs = [];
let mode = "now";

/* --------------------------
   RIDER PROFILE LOAD
--------------------------- */
const profileRaw = localStorage.getItem("bigred_rider_profile_v2");
let riderProfile = profileRaw ? JSON.parse(profileRaw) : null;
const riderId = localStorage.getItem("bigred_rider_id") || "";

/* Autofill passengers + pickup home */
window.addEventListener("DOMContentLoaded", () => {
  if (riderProfile) {
    document.getElementById("passengers").value = riderProfile.passengers || 1;

    if (riderProfile.home) {
      const p = document.getElementById("pickup");
      if (!p.value.trim()) p.value = riderProfile.home.trim();
    }
  }
});

/* --------------------------
   GOOGLE INIT
--------------------------- */
function initGoogle() {
  geocoder = new google.maps.Geocoder();
  directionsService = new google.maps.DirectionsService();
  directionsRenderer = new google.maps.DirectionsRenderer({ suppressMarkers:true });

  map = new google.maps.Map(document.getElementById("map"),{
    center:{lat:35.4676,lng:-97.5164}, zoom:12,
    gestureHandling:"greedy",
    disableDefaultUI:true
  });
  directionsRenderer.setMap(map);

  setupAutocomplete("pickup", true);
  setupAutocomplete("dropoff", false);

  document.getElementById("modeNow").onclick=()=>setMode("now");
  document.getElementById("modeReserve").onclick=()=>setMode("reserve");
  document.getElementById("calcBtn").onclick=calculateFare;
  document.getElementById("addStopBtn").onclick=addStopField;
  document.getElementById("useLocPickup").onclick=()=>useMyLocation("pickup");
  document.getElementById("useLocDrop").onclick=()=>useMyLocation("dropoff");

  applyAutoRateLabels();
}

/* --------------------------
   AUTOCOMPLETE
--------------------------- */
function setupAutocomplete(id,isPickup){
  const ac=new google.maps.places.Autocomplete(document.getElementById(id));
  ac.addListener("place_changed",()=>{
    const p=ac.getPlace();
    if(!p.geometry)return;
    const loc=p.geometry.location;

    if(isPickup){
      pickupLatLng=loc;
    }else{
      dropoffLatLng=loc;
    }

    map.panTo(loc);
    applyAutoRateLabels();
    updateLuggageVisibility();
  });
}

/* --------------------------
   MODE SWITCH
--------------------------- */
function setMode(m){
  mode=m;
  document.getElementById("modeNow").classList.toggle("active",m==="now");
  document.getElementById("modeReserve").classList.toggle("active",m==="reserve");
  document.getElementById("reserveControls").style.display=(m==="reserve"?"block":"none");
  applyAutoRateLabels();
}

/* --------------------------
   HOLIDAY DETECTION
--------------------------- */
function holidayCheck(date){
  const m=date.getMonth()+1, d=date.getDate(), dow=date.getDay();

  // Thanksgiving (4th Thursday of November)
  if(m===11){
    if(d>=22 && d<=28 && dow===4) return "Happy Thanksgiving!";
  }
  // Christmas Eve / Day
  if(m===12 && d===24) return "Merry Christmas Eve!";
  if(m===12 && d===25) return "Merry Christmas!";
  // New Year‚Äôs Eve / Day
  if(m===12 && d===31) return "Happy New Year‚Äôs Eve!";
  if(m===1 && d===1) return "Happy New Year!";
  return "";
}

/* --------------------------
   RATE LOGIC
--------------------------- */
function applyAutoRateLabels(){
  const pickup=document.getElementById("pickup").value.toLowerCase();
  const drop=document.getElementById("dropoff").value.toLowerCase();

  const now = (mode==="reserve" && document.getElementById("reserveDate").value) ?
      new Date(document.getElementById("reserveDate").value + "T" + (document.getElementById("reserveTime").value||"00:00")) :
      new Date();

  const holidayMsg=holidayCheck(now);
  const isHoliday=holidayMsg!=="";

  const airport = pickup.includes("airport")||drop.includes("airport")||pickup.includes("will rogers")||drop.includes("will rogers");

  const rush = (()=>{
    const h=now.getHours(), dow=now.getDay();
    return dow>=1&&dow<=5 && ((h>=5&&h<9)||(h>=15&&h<19));
  })();

  const event = false; // (Optional future venue detection)

  const trip=document.getElementById("tripType");
  const holidayNote=document.getElementById("holiday-note");
  const airportNote=document.getElementById("airport-note");
  const rushNote=document.getElementById("rushhour-note");
  const eventNote=document.getElementById("event-note");

  holidayNote.textContent="";
  airportNote.textContent="";
  rushNote.textContent="";
  eventNote.textContent="";

  if(isHoliday){
    trip.value="20";
    holidayNote.textContent=holidayMsg+" Holiday rate applies ($20 base).";
  }else if(event){
    trip.value="20";
    eventNote.textContent="üìç Special event detected ‚Äî $20 base.";
  }else if(airport){
    trip.value="15_airport";
    airportNote.textContent="‚úàÔ∏è Airport run ‚Äî $15 base.";
  }else if(rush){
    trip.value="15";
    rushNote.textContent="üö¶ Rush Hour (5‚Äì9 AM / 3‚Äì7 PM).";
  }else{
    trip.value="10";
  }
}

/* --------------------------
   LUGGAGE VISIBILITY
--------------------------- */
function updateLuggageVisibility(){
  const pickup=document.getElementById("pickup").value.toLowerCase();
  const drop=document.getElementById("dropoff").value.toLowerCase();
  const isAirport = pickup.includes("airport") || drop.includes("airport") ||
                    pickup.includes("will rogers") || drop.includes("will rogers");

  document.getElementById("luggageBlock").style.display = isAirport ? "block" : "none";

  // Auto-fill saved luggage for airport rides:
  if(isAirport && riderProfile && riderProfile.luggage!==undefined){
    document.getElementById("luggageCount").value = riderProfile.luggage;
  }
}

/* --------------------------
   STOP FIELDS
--------------------------- */
function addStopField(){
  if(stopInputs.length>=3){alert("Limit 3 stops.");return;}
  const id="stop_"+Date.now();
  stopInputs.push(id);

  const wrap=document.getElementById("stopsWrap");
  const div=document.createElement("div");
  div.innerHTML=`
    <label>Stop ${stopInputs.length}</label>
    <input id="${id}" type="text" placeholder="Enter stop address">
  `;
  wrap.appendChild(div);
}

/* --------------------------
   MY LOCATION
--------------------------- */
function useMyLocation(which){
  if(!navigator.geolocation){return alert("Location unavailable.");}
  navigator.geolocation.getCurrentPosition(pos=>{
    const lat=pos.coords.latitude, lng=pos.coords.longitude;
    geocoder.geocode({location:{lat,lng}},(res,s)=>{
      const addr=(s==="OK"&&res[0])?res[0].formatted_address:`${lat}, ${lng}`;
      document.getElementById(which).value=addr;
      if(which==="pickup")pickupLatLng=new google.maps.LatLng(lat,lng);
      else dropoffLatLng=new google.maps.LatLng(lat,lng);
      map.panTo({lat,lng});
      applyAutoRateLabels();
      updateLuggageVisibility();
    });
  });
}

/* --------------------------
   FAIRNESS FEE
--------------------------- */
function distMi(a,b){
  return google.maps.geometry.spherical.computeDistanceBetween(
    new google.maps.LatLng(a.lat,a.lng),
    new google.maps.LatLng(b.lat,b.lng)
  )/1609.34;
}
async function getDriverRef(){
  try{
    const r=await fetch(WORKER_LOC+"?n="+Date.now(),{cache:"no-store"});
    const j=await r.json();
    const lat=parseFloat(j.latitude), lng=parseFloat(j.longitude);
    const t=j.timestamp?new Date(j.timestamp):null;
    const age=t?(Date.now()-t.getTime())/60000:999;
    return (age<=60 && !isNaN(lat) && !isNaN(lng)) ? {lat,lng} : HQ;
  }catch{return HQ;}
}
function fairnessFee(miles,ref,pLL){
  if(!pLL)return 0;
  const d=distMi(ref,{lat:pLL.lat(),lng:pLL.lng()});
  if(d>40)return 20;
  if(d>20)return 10;
  return 0;
}

/* --------------------------
   CALCULATE FARE
--------------------------- */
async function calculateFare(){
  const pickup=document.getElementById("pickup").value.trim();
  const dropoff=document.getElementById("dropoff").value.trim();

  if(!pickup||!dropoff)return alert("Enter pickup and dropoff.");

  const stops=stopInputs.map(id=>{
    const v=document.getElementById(id)?.value.trim();
    return v?{location:v,stopover:true}:null;
  }).filter(Boolean);

  const route=await new Promise((resolve,reject)=>
    directionsService.route({origin:pickup,destination:dropoff,waypoints:stops,travelMode:"DRIVING"},
      (r,s)=>s==="OK"?resolve(r):reject(s))
  );
  directionsRenderer.setDirections(route);

  let miles=0, minutes=0;
  route.routes[0].legs.forEach(l=>{
    miles+=(l.distance.value||0)/1609.34;
    minutes+=(l.duration.value||0)/60;
  });
  miles=Math.round(miles);
  minutes=Math.round(minutes);

  applyAutoRateLabels();
  updateLuggageVisibility();

  const type=document.getElementById("tripType").value;
  let base=10;
  if(type==="15")base=15;
  else if(type==="15_airport")base=15;
  else if(type==="20")base=20;

  const tier2=Math.max(0,Math.min(10,miles-10))*1.25;
  const tier3=Math.max(0,miles-20)*1;
  const milesSub=tier2+tier3;

  const ref=await getDriverRef();
  const fair=fairnessFee(miles,ref,pickupLatLng);

  let fare=base+milesSub+fair;

  const pay=document.getElementById("payment").value;
  if(pay==="card")fare+=fare*(0.033+0.024);

  const total=fare.toFixed(2);

  const result=document.getElementById("result");
  result.style.display="block";
  result.innerHTML=`
    <div class="total">$${total}</div>
    <p><strong>Base:</strong> $${base}</p>
    <p><strong>Mileage:</strong> $${milesSub.toFixed(2)}</p>
    ${fair>0?`<p><strong>Travel Fairness Fee:</strong> $${fair}</p>`:""}
    <p><strong>Payment:</strong> ${pay==="card"?"Card":"Cash / App"}</p>
    <p>üìè ${miles} mi  ‚è±Ô∏è ${Math.round(minutes)} min</p>

    <p style="text-align:center;margin-top:18px;">
      <button id="requestBtn" class="btn primary">üì© Request This Ride</button>
    </p>
  `;

  document.getElementById("requestBtn").onclick=()=>sendRequest({
    pickup, dropoff, stops,
    miles, minutes, total, base, milesSub, fair, pay
  });

  window._lastRoute={pickup,dropoff,stops};
}

/* --------------------------
   GOOGLE MAP ROUTE URL
--------------------------- */
function buildRouteURL(pick,drop,stops){
  let url=`https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(pick)}&destination=${encodeURIComponent(drop)}`;
  if(stops && stops.length){
    const wp=stops.map(s=>s.location).join("|");
    url+=`&waypoints=${encodeURIComponent(wp)}`;
  }
  return url;
}

/* --------------------------
   SEND REQUEST
--------------------------- */
async function sendRequest(q){
  if(!riderProfile){alert("Save rider profile first.");return;}

  const isAirport = q.pickup.toLowerCase().includes("airport") ||
                    q.dropoff.toLowerCase().includes("airport") ||
                    q.pickup.toLowerCase().includes("will rogers") ||
                    q.dropoff.toLowerCase().includes("will rogers");

  const luggage = isAirport ? parseInt(document.getElementById("luggageCount").value||"0") : 0;
  const passengers = parseInt(document.getElementById("passengers").value||"1");

  const dt = (mode==="reserve" && document.getElementById("reserveDate").value && document.getElementById("reserveTime").value)
      ? new Date(document.getElementById("reserveDate").value+"T"+document.getElementById("reserveTime").value+":00").toISOString()
      : null;

  const routeUrl = buildRouteURL(q.pickup,q.dropoff,q.stops);

  const payload={
    type: dt?"RESERVATION":"INSTANT",
    pickup:{address:q.pickup},
    dropoff:{address:q.dropoff},
    stops:(q.stops||[]).map(s=>({address:s.location})),
    rider:{
      name:riderProfile.name||"Rider",
      phone:riderProfile.phone||riderId,
      passengers,
      luggage
    },
    metrics:{miles:q.miles, minutes:q.minutes},
    pricing:{
      estimate:Number(q.total),
      travelFee:q.fair||0,
      ratePlan:dt?"RESERVATION":"STANDARD"
    },
    scheduledFor:dt,
    routeUrl,
    metadata:{notifyDriver:true}
  };

  const res=await fetch(WORKER_BOOK,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(payload)
  });

  if(!res.ok){
    alert("Error sending request. Please text RED directly.");
    return;
  }

  const booking=await res.json();
  const id=booking.id;

  const smsLines=[
    `Hey Big Red ‚Äî this is ${riderProfile.name||"a rider"}.`,
    `Pickup: ${q.pickup}`,
    q.stops.length?`Stops: ${q.stops.map(s=>s.location).join(", ")}`:"",
    `Dropoff: ${q.dropoff}`,
    `Estimate: $${q.total}`,
    `Passengers: ${passengers}`,
    isAirport?`Luggage: ${luggage}`:"",
    `Miles: ${q.miles}`,
    `Route: ${routeUrl}`
  ].filter(Boolean).join(" ");

  const sms=encodeURIComponent(smsLines);
  window.location.href=`sms:+14053784024?&body=${sms}`;

  window.location.href=`/rider/myride.html?id=${encodeURIComponent(id)}`;
}
</script>

</body>
</html>