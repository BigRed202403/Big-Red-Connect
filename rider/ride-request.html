<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Request a Ride ‚Äì Big Red Connect</title>

  <!-- Icons -->
  <link rel="apple-touch-icon" href="/icon.PNG">
  <link rel="icon" type="image/png" sizes="192x192" href="/icon.PNG">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#000"/>

  <!-- Core Styles -->
  <style>
    body {
      margin:0;
      background:#000;
      color:#fff;
      font-family:-apple-system, BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
      padding-bottom:40px;
    }
    header {
      padding:12px;
      display:flex;
      align-items:center;
      gap:12px;
      border-bottom:2px solid #b30000;
      background:#000;
      position:sticky;
      top:0;
      z-index:12;
    }
    header a.logo-link {
      display:flex;
      align-items:center;
      gap:10px;
      text-decoration:none;
      color:#fff;
    }
    header img {
      height:42px;
      border-radius:6px;
    }
    header-title-main {
      font-weight:700;
    }
    header-title-sub {
      font-size:.8rem;
      color:#888;
      display:block;
    }

    .back-bar {
      width:calc(100% - 24px);
      margin:10px auto 0;
    }
    .back-btn {
      width:100%;
      padding:10px 12px;
      border-radius:8px;
      border:1px solid #333;
      background:#111;
      color:#fff;
      font-size:.9rem;
      font-weight:600;
      text-align:center;
      text-decoration:none;
      display:inline-block;
    }

    h1 {
      text-align:center;
      margin:14px 0 8px;
      font-size:1.35rem;
      font-weight:700;
    }

    .form {
      width:calc(100% - 24px);
      margin:4px auto 20px;
    }
    .input-group {
      margin-bottom:14px;
    }
    label {
      display:block;
      font-size:.85rem;
      margin-bottom:4px;
      color:#ccc;
    }
    input, select, textarea {
      width:100%;
      padding:11px;
      background:#111;
      border:1px solid #333;
      border-radius:8px;
      color:#fff;
      font-size:.95rem;
      box-sizing:border-box;
    }
    input::placeholder, textarea::placeholder {
      color:#666;
    }

    .btn-primary {
      display:block;
      width:100%;
      margin-top:16px;
      padding:14px;
      background:#b30000;
      color:#fff;
      text-align:center;
      font-weight:700;
      border-radius:10px;
      text-decoration:none;
      font-size:1.05rem;
    }

    #holidayBanner {
      display:none;
      background:#331111;
      border:1px solid #b30000;
      padding:12px;
      border-radius:8px;
      margin-bottom:15px;
      color:#ffcccc;
      font-size:.85rem;
    }

    #toast {
      position:fixed;
      bottom:22px;
      left:50%;
      transform:translateX(-50%);
      background:#111;
      border:1px solid #b30000;
      padding:10px 18px;
      border-radius:999px;
      opacity:0;
      pointer-events:none;
      transition:.25s;
      z-index:99;
    }
    #toast.show { opacity:1; }

    /* Stops block */
    .stops-header-row {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .add-stop-btn {
      border:none;
      background:#111;
      border-radius:999px;
      padding:6px 10px;
      font-size:.8rem;
      color:#ffcc66;
      display:flex;
      align-items:center;
      gap:4px;
      cursor:pointer;
      border:1px solid #444;
    }
    .stop-row {
      display:flex;
      align-items:center;
      gap:8px;
      margin-top:6px;
    }
    .stop-row input {
      flex:1;
    }
    .remove-stop-btn {
      border:none;
      background:#221111;
      color:#ffaaaa;
      border-radius:999px;
      padding:6px 9px;
      font-size:.8rem;
      cursor:pointer;
    }

    .hint {
      font-size:.78rem;
      color:#888;
      margin-top:3px;
    }

    .inline-row {
      display:flex;
      gap:10px;
    }
    .inline-row > div {
      flex:1;
    }

    @media (min-width: 768px) {
      .form { max-width:520px; }
    }
  </style>
</head>

<body>
<header>
  <a href="/rider/rider.html" class="logo-link">
    <img src="/icon.PNG" alt="Big Red Connect Logo"/>
    <div>
      <span class="header-title-main">Big Red Connect</span>
      <header-title-sub>Request a Ride</header-title-sub>
    </div>
  </a>
</header>

<div class="back-bar">
  <a href="/rider/rider.html" class="back-btn">‚¨ÖÔ∏è Back to Rider Hub</a>
</div>

<h1>Request a Ride</h1>

<div class="form">

  <!-- Holiday Banner -->
  <div id="holidayBanner">
    üéÑ Holiday Rate Applied ‚Äî thanks for riding local during peak holiday dates.
  </div>

  <!-- NAME -->
  <div class="input-group">
    <label>Your Name</label>
    <input id="riderName" placeholder="Your name"/>
  </div>

  <!-- PHONE -->
  <div class="input-group">
    <label>Mobile Number</label>
    <input id="riderPhone" placeholder="555-555-5555" inputmode="tel"/>
  </div>

  <!-- PICKUP -->
  <div class="input-group">
    <label>Pickup Address</label>
    <input id="pickup" placeholder="Where should we pick you up?"/>
    <div class="hint">Tip: start typing a place, business, or address.</div>
  </div>

  <!-- GATE CODE -->
  <div class="input-group">
    <label>Gate Code / Access Notes (optional)</label>
    <input id="gateCode" placeholder="Gate code, building, apartment‚Ä¶"/>
  </div>

  <!-- STOPS -->
  <div class="input-group">
    <div class="stops-header-row">
      <label>Stops (optional)</label>
      <button type="button" id="btnAddStop" class="add-stop-btn">
        ‚ûï Add stop
      </button>
    </div>
    <div id="stopsContainer"></div>
    <div class="hint">You can add one or more quick stops along the way.</div>
  </div>

  <!-- DROPOFF -->
  <div class="input-group">
    <label>Dropoff Address</label>
    <input id="dropoff" placeholder="Where are you going?"/>
  </div>

  <!-- PASSENGERS + LUGGAGE -->
  <div class="inline-row">
    <div class="input-group">
      <label>Passengers</label>
      <select id="partySize"></select>
      <div class="hint" id="partyHint"></div>
    </div>

    <div class="input-group" id="luggageGroup" style="display:none;">
      <label>Luggage</label>
      <select id="luggage">
        <option value="0">0</option>
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3+</option>
      </select>
      <div class="hint">Shown automatically for airport rides.</div>
    </div>
  </div>

  <!-- TIME -->
  <div class="input-group">
    <label>When?</label>
    <select id="timeType">
      <option value="now">Right now</option>
      <option value="schedule">Schedule a time</option>
    </select>
  </div>

  <div class="input-group" id="scheduledGroup" style="display:none;">
    <label>Pick a Time</label>
    <input type="datetime-local" id="scheduledFor"/>
  </div>

  <!-- ESTIMATE (placeholder for now) -->
  <div class="input-group">
    <label>Estimated Fare</label>
    <input id="estimate" disabled placeholder="$0.00"/>
    <div class="hint">Final price is confirmed by Big Red based on distance and timing.</div>
  </div>

  <a class="btn-primary" id="btnSubmit">Submit Ride Request</a>

</div>

<div id="toast"></div>

<script>
/* =======================================================
   TOAST
======================================================= */
function showToast(msg){
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.classList.add("show");
  setTimeout(()=> t.classList.remove("show"), 1800);
}

/* =======================================================
   PREFILL FROM LOCAL PROFILE
======================================================= */
function prefillFromProfile(){
  const name = localStorage.getItem("riderName");
  const phone = localStorage.getItem("riderPhone");
  const home = localStorage.getItem("riderHome");
  const gate = localStorage.getItem("riderGate");

  if (name)  document.getElementById("riderName").value = name;
  if (phone) document.getElementById("riderPhone").value = phone;
  if (home)  document.getElementById("pickup").value = home;
  if (gate)  document.getElementById("gateCode").value = gate;
}

/* =======================================================
   HOLIDAY BANNER (simple rule set)
======================================================= */
function updateHolidayBanner() {
  const now = new Date();
  const m = now.getMonth() + 1; // Jan = 1
  const d = now.getDate();
  let isHoliday = false;

  // Simple rule: Thanksgiving week, Christmas week, New Year
  if (m === 11 && d >= 25 && d <= 30) isHoliday = true;  // Thanksgiving window
  if (m === 12 && d >= 20 && d <= 31) isHoliday = true;  // Christmas / NYE
  if (m === 1 && d <= 2) isHoliday = true;               // New Year's Day

  const banner = document.getElementById("holidayBanner");
  banner.style.display = isHoliday ? "block" : "none";
}

/* =======================================================
   AIRPORT DETECTION ‚Üí LUGGAGE FIELD
======================================================= */
function detectAirport(addr){
  if(!addr) return false;
  addr = addr.toLowerCase();
  return (
    addr.includes("will rogers") ||
    addr.includes("okc airport") ||
    addr.includes("terminal") ||
    addr.includes("airport")
  );
}

function checkLuggage(){
  const p = document.getElementById("pickup").value;
  const d = document.getElementById("dropoff").value;
  const show = detectAirport(p) || detectAirport(d);
  document.getElementById("luggageGroup").style.display = show ? "block" : "none";
}

document.getElementById("pickup").addEventListener("input", checkLuggage);
document.getElementById("dropoff").addEventListener("input", checkLuggage);

/* =======================================================
   SCHEDULED TIME TOGGLE
======================================================= */
document.getElementById("timeType").addEventListener("change", e=>{
  document.getElementById("scheduledGroup").style.display =
    e.target.value==="schedule" ? "block":"none";
});

/* =======================================================
   PASSENGER LIMIT BASED ON ACTIVE VEHICLE
======================================================= */
async function loadPassengerCap(){
  const select = document.getElementById("partySize");
  const hint = document.getElementById("partyHint");

  let maxPassengers = 6;
  let label = "up to 6 passengers";

  try {
    const res = await fetch("https://bigred-status-updater.bigredtransportation.workers.dev/status");
    if (res.ok) {
      const data = await res.json();
      // If driver is offline or status missing ‚Üí allow up to 6 (either vehicle)
      if (!data.online || data.status === "offline") {
        maxPassengers = 6;
        label = "up to 6 passengers (driver currently offline)";
      } else if (data.vehicle && data.vehicle.code) {
        if (data.vehicle.code === "BIG_RED") {
          maxPassengers = 4;
          label = "up to 4 passengers (Big Red)";
        } else if (data.vehicle.code === "BLACK_ACADIA") {
          maxPassengers = 6;
          label = "up to 6 passengers (Black GMC Acadia)";
        } else {
          maxPassengers = 4;
          label = "up to 4 passengers (active vehicle)";
        }
      } else {
        // Online but vehicle not set ‚Üí play it safe
        maxPassengers = 4;
        label = "up to 4 passengers (driver online)";
      }
    }
  } catch(e){
    // On error, fallback to 6
    maxPassengers = 6;
    label = "up to 6 passengers";
  }

  select.innerHTML = "";
  for (let i = 1; i <= maxPassengers; i++) {
    const opt = document.createElement("option");
    opt.value = String(i);
    opt.textContent = String(i);
    select.appendChild(opt);
  }

  hint.textContent = `Current max capacity: ${label}.`;
}

/* =======================================================
   STOPS: ADD / REMOVE DYNAMIC FIELDS
======================================================= */
const stopsContainer = document.getElementById("stopsContainer");
const btnAddStop = document.getElementById("btnAddStop");
let stopCounter = 0;
let allAutocompleteInstances = [];
let userLocationBounds = null;

btnAddStop.addEventListener("click", () => addStopField());

function addStopField(value = "") {
  stopCounter++;
  const id = "stop-" + stopCounter;

  const row = document.createElement("div");
  row.className = "stop-row";
  row.innerHTML = `
    <input id="${id}" placeholder="Extra stop address"/>
    <button type="button" class="remove-stop-btn" data-target="${id}">‚úñ</button>
  `;
  stopsContainer.appendChild(row);

  if (window.google && window.google.maps && window.google.maps.places) {
    setupAutocompleteForField(id);
  }
}

stopsContainer.addEventListener("click", (e) => {
  if (!e.target.classList.contains("remove-stop-btn")) return;
  const targetId = e.target.getAttribute("data-target");
  const input = document.getElementById(targetId);
  if (input && input.parentElement) {
    input.parentElement.remove();
  }
});

/* =======================================================
   GOOGLE PLACES AUTOCOMPLETE
======================================================= */
function setupAutocompleteForField(inputId) {
  const input = document.getElementById(inputId);
  if (!input) return;

  const ac = new google.maps.places.Autocomplete(input, {
    fields: ["formatted_address", "name", "geometry"],
    componentRestrictions: { country: "us" }
  });

  if (userLocationBounds) {
    ac.setBounds(userLocationBounds);
  }

  allAutocompleteInstances.push(ac);
}

function initUserLocationBias() {
  if (!navigator.geolocation) return;

  navigator.geolocation.getCurrentPosition(
    (pos) => {
      const center = new google.maps.LatLng(pos.coords.latitude, pos.coords.longitude);
      const circle = new google.maps.Circle({
        center,
        radius: 30000 // ~30km bias
      });
      userLocationBounds = circle.getBounds();

      allAutocompleteInstances.forEach(ac => {
        ac.setBounds(userLocationBounds);
      });
    },
    () => {
      // ignore errors, autocomplete will still work
    },
    { enableHighAccuracy:false, timeout:5000, maximumAge:60000 }
  );
}

function initAutocomplete() {
  // Base fields
  setupAutocompleteForField("pickup");
  setupAutocompleteForField("dropoff");

  // Any existing stop fields
  const stopInputs = stopsContainer.querySelectorAll("input[id^='stop-']");
  stopInputs.forEach(input => setupAutocompleteForField(input.id));

  initUserLocationBias();
}

/* =======================================================
   SUBMIT RIDE REQUEST
======================================================= */
document.getElementById("btnSubmit").addEventListener("click", submitRide);

async function submitRide(){
  const name = document.getElementById("riderName").value.trim();
  const phone = document.getElementById("riderPhone").value.trim();
  const pickup = document.getElementById("pickup").value.trim();
  const dropoff = document.getElementById("dropoff").value.trim();

  if(!name || !phone || !pickup || !dropoff){
    showToast("Missing required fields");
    return;
  }

  // Save profile pieces for future forms
  localStorage.setItem("riderName", name);
  localStorage.setItem("riderPhone", phone);
  localStorage.setItem("riderHome", pickup);
  localStorage.setItem("riderGate", document.getElementById("gateCode").value.trim());

  // Stops
  const stopInputs = stopsContainer.querySelectorAll("input[id^='stop-']");
  const stopList = [];
  const stopStrings = [];
  stopInputs.forEach(input => {
    const val = input.value.trim();
    if (val) {
      stopList.push({ address: val });
      stopStrings.push(val);
    }
  });

  const partySize = Number(document.getElementById("partySize").value || "1");
  const luggage = document.getElementById("luggageGroup").style.display==="block"
      ? Number(document.getElementById("luggage").value)
      : 0;

  const whenType = document.getElementById("timeType").value;
  const scheduledFor = whenType==="schedule"
      ? document.getElementById("scheduledFor").value
      : null;

  const estimateVal = document.getElementById("estimate").value.replace("$","") || 0;

  // Rider identity
  const storedRiderId = localStorage.getItem("riderId");
  const riderId = storedRiderId || crypto.randomUUID();
  localStorage.setItem("riderId", riderId);

  const body = {
    type: scheduledFor ? "SCHEDULED":"INSTANT",
    pickup: { address: pickup, gate: document.getElementById("gateCode").value },
    dropoff: { address: dropoff },
    stops: stopList,
    rider: { name, phone, partySize, riderId },
    pricing: { estimate: Number(estimateVal), travelFee:0 },
    scheduledFor,
    source: "RIDER_APP"
  };

  const API = "https://bigred-bookings.bigredtransportation.workers.dev";

  try {
    const res = await fetch(`${API}/api/bookings`, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify(body)
    });

    if(!res.ok){
      showToast("Error submitting ride");
      return;
    }

    const booking = await res.json();

    // Build Google Maps route link
    let routeUrl = `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(pickup)}&destination=${encodeURIComponent(dropoff)}`;
    if (stopStrings.length) {
      routeUrl += `&waypoints=${encodeURIComponent(stopStrings.join("|"))}`;
    }

    // Open SMS pre-fill
    const smsBody =
      `Ride Request:\n` +
      `From: ${pickup}\n` +
      `To: ${dropoff}\n` +
      `Name: ${name}\n` +
      `Phone: ${phone}\n` +
      `Stops: ${stopStrings.join(" | ") || "None"}\n` +
      `Passengers: ${partySize}\n` +
      `Luggage: ${luggage}\n` +
      `Booking ID: ${booking.id}\n` +
      `Route: ${routeUrl}`;

    const sms =
      `sms:+14053784024?body=` +
      encodeURIComponent(smsBody);

    window.location.href = sms;
  } catch(e){
    console.error(e);
    showToast("Error submitting ride");
  }
}

/* =======================================================
   ON LOAD
======================================================= */
prefillFromProfile();
updateHolidayBanner();
loadPassengerCap();
</script>

<!-- Google Maps Places (Autocomplete) -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCMM0dxLNM7XQI5G3OBSnINeO5hcS3Ks5I&libraries=places&callback=initAutocomplete" async defer></script>

</body>
</html>