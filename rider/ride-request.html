<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Request a Ride — Big Red Connect</title>

  <!-- Branding -->
  <link rel="apple-touch-icon" href="../icon.PNG">
  <link rel="icon" type="image/png" sizes="192x192" href="../icon.PNG">
  <meta name="theme-color" content="#000">

  <style>
    body {
      margin:0;
      background:#000;
      color:#fff;
      font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }

    header {
      padding:12px 16px;
      border-bottom:2px solid #b30000;
      background:#000;
      position:sticky;
      top:0;
      z-index:20;
    }

    header h1 {
      margin:0;
      font-size:1.2rem;
      font-weight:700;
    }

    .container {
      padding:16px;
      max-width:600px;
      margin:auto;
    }

    .section-title {
      font-size:1rem;
      font-weight:700;
      margin-top:22px;
      margin-bottom:8px;
    }

    input, select, textarea {
      width:100%;
      padding:12px;
      border-radius:10px;
      border:1px solid #333;
      background:#111;
      color:#fff;
      margin-bottom:14px;
      font-size:1rem;
    }

    textarea {
      resize:none;
      min-height:70px;
    }

    .btn-primary {
      width:100%;
      padding:14px;
      background:#b30000;
      border:none;
      border-radius:10px;
      color:#fff;
      font-weight:700;
      font-size:1rem;
      cursor:pointer;
      margin-top:10px;
    }

    .btn-primary:active {
      transform:scale(.98);
    }

    .back-link {
      color:#bbb;
      text-decoration:none;
      font-size:.9rem;
      display:inline-block;
      margin-bottom:20px;
    }

    footer {
      text-align:center;
      margin-top:35px;
      margin-bottom:25px;
      color:#666;
      font-size:.8rem;
    }
  </style>
</head>

<body>

<header>
  <h1>Request a Ride</h1>
</header>

<div class="container">

  <a href="rider.html" class="back-link">← Back to Rider Hub</a>

  <!-- Rider Info -->
  <div class="section-title">Your Info</div>
  <input id="riderName" type="text" placeholder="Your Name" />
  <input id="riderPhone" type="tel" placeholder="Phone Number" disabled />
  <select id="partySize">
    <option value="1">1 Passenger</option>
    <option value="2">2 Passengers</option>
    <option value="3">3 Passengers</option>
    <option value="4">4 Passengers</option>
    <option value="5">5 Passengers</option>
    <option value="6">6 Passengers</option>
  </select>

  <!-- Pickup -->
  <div class="section-title">Pickup Location</div>
  <input id="pickupAddress" type="text" placeholder="Pickup Address" />
  <input id="gateCode" type="text" placeholder="Gate Code (optional)" />
  <textarea id="pickupNotes" placeholder="Pickup Notes (optional)"></textarea>

  <!-- Dropoff -->
  <div class="section-title">Dropoff Location</div>
  <input id="dropoffAddress" type="text" placeholder="Dropoff Address" />
  <textarea id="travelNotes" placeholder="Travel / Airline Notes (optional)"></textarea>

  <button class="btn-primary" id="requestBtn">Submit Ride Request</button>

</div>

<footer>&copy; 2025 Big Red Connect</footer>

<script>
/* ===========================================================
   PREFILL RIDER PROFILE → NAME, HOME ADDRESS, NOTES
=========================================================== */

const PROFILE_API = "https://bigred-profile.bigredtransportation.workers.dev/api/profile";

async function loadProfile() {
  const phone = localStorage.getItem("riderPhone");
  if (!phone) {
    window.location.href = "../rider-login.html";
    return;
  }

  document.getElementById("riderPhone").value = phone; // locked

  try {
    const res = await fetch(`${PROFILE_API}?riderPhone=${encodeURIComponent(phone)}`);
    if (!res.ok) return;

    const p = await res.json();

    // Prefill main info
    document.getElementById("riderName").value = p.name || "";
    document.getElementById("partySize").value = p.partySize || "1";

    // Address
    if (p.homeAddress) {
      document.getElementById("pickupAddress").value = p.homeAddress;
    }

    // Notes fields
    document.getElementById("gateCode").value = p.gateCode || "";
    document.getElementById("pickupNotes").value = p.pickupNotes || "";
    document.getElementById("travelNotes").value = p.travelNotes || "";

  } catch (err) {
    console.warn("Profile prefill error", err);
  }
}

document.addEventListener("DOMContentLoaded", loadProfile);


/* ===========================================================
   SUBMIT RIDE REQUEST
=========================================================== */

async function submitRide() {
  const phone = localStorage.getItem("riderPhone");
  if (!phone) return alert("Please log in again.");

  const payload = {
    type: "INSTANT",
    source: "RIDER_APP",

    rider: {
      name: document.getElementById("riderName").value.trim(),
      phone,
      partySize: Number(document.getElementById("partySize").value || 1)
    },

    pickup: {
      address: document.getElementById("pickupAddress").value.trim(),
      gateCode: document.getElementById("gateCode").value.trim(),
      notes: document.getElementById("pickupNotes").value.trim()
    },

    dropoff: {
      address: document.getElementById("dropoffAddress").value.trim(),
      notes: document.getElementById("travelNotes").value.trim()
    },

    stops: [],
    pricing: {
      estimate: window.estimate || 0,
      travelFee: window.travelFee || 0,
      ratePlan: window.ratePlan || "STANDARD"
    }
  };

  try {
    const res = await fetch("https://bigred-bookings.bigredtransportation.workers.dev/api/bookings", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });

    if (!res.ok) throw new Error("Failed");

    const booking = await res.json();

    // Save for MyRide page
    localStorage.setItem("lastRideId", booking.id);

    window.location.href = `myride.html?id=${booking.id}`;

  } catch (err) {
    alert("Could not send ride request. Try again.");
  }
}

document.getElementById("requestBtn").addEventListener("click", submitRide);
</script>

</body>
</html>