<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Request a Ride â€“ Big Red Connect</title>

  <!-- Icons / PWA -->
  <link rel="apple-touch-icon" href="/icon.PNG">
  <link rel="icon" type="image/png" sizes="192x192" href="/icon.PNG">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#000"/>

  <style>
    body {
      margin:0;
      background:#000;
      color:#fff;
      font-family:-apple-system, BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
      padding-bottom:60px;
    }

    header {
      padding:12px 12px;
      display:flex;
      align-items:center;
      gap:12px;
      border-bottom:2px solid #b30000;
      background:#000;
      position:sticky;
      top:0;
      z-index:12;
    }
    header img { height:46px; border-radius:4px; }
    header a { text-decoration:none; color:inherit; display:flex; align-items:center; gap:12px; }

    h1 {
      text-align:center;
      margin:18px 0 8px;
      font-size:1.4rem;
      font-weight:700;
    }
    .subtitle {
      text-align:center;
      font-size:.85rem;
      color:#aaa;
      margin-bottom:10px;
    }

    .form {
      width:calc(100% - 24px);
      margin:10px auto 0;
      max-width:520px;
    }

    .input-group {
      margin-bottom:14px;
    }
    label {
      display:block;
      font-size:.85rem;
      margin-bottom:4px;
      color:#ccc;
    }
    input, select, textarea {
      width:100%;
      padding:11px 12px;
      background:#111;
      border:1px solid #333;
      border-radius:8px;
      color:#fff;
      font-size:.95rem;
      box-sizing:border-box;
    }
    input::placeholder, textarea::placeholder {
      color:#666;
    }

    .addr-input {
      /* visual hint itâ€™s smart-search */
      background:#111 url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23666'%3E%3Cpath d='M11.29 10.29 8.4 7.4A4.48 4.48 0 0 0 9 5.5 4.5 4.5 0 1 0 4.5 10a4.48 4.48 0 0 0 1.9-.4l2.89 2.89a1 1 0 0 0 1.4-1.4zM2 5.5A2.5 2.5 0 1 1 4.5 8 2.5 2.5 0 0 1 2 5.5z'/%3E%3C/svg%3E") no-repeat right 10px center;
      background-size:14px;
      padding-right:30px;
    }

    .inline {
      display:flex;
      gap:8px;
    }
    .inline .input-group {
      flex:1;
      margin-bottom:0;
    }

    .btn {
      display:block;
      width:100%;
      margin-top:14px;
      padding:14px;
      background:#b30000;
      color:#fff;
      text-align:center;
      font-weight:700;
      border-radius:10px;
      text-decoration:none;
      font-size:1.05rem;
      border:none;
      cursor:pointer;
    }

    .btn-ghost {
      background:#111;
      border:1px solid #333;
      color:#fff;
      font-size:.9rem;
      padding:11px;
      margin-top:10px;
    }

    .btn-small {
      font-size:.85rem;
      padding:9px 10px;
      margin-top:6px;
    }

    #holidayBanner {
      display:none;
      background:#331111;
      border:1px solid #b30000;
      padding:12px;
      border-radius:8px;
      margin-bottom:15px;
      color:#ffcccc;
      font-size:.85rem;
    }

    .section-label {
      margin-top:4px;
      margin-bottom:4px;
      font-size:.9rem;
      font-weight:600;
      color:#eee;
    }

    #toast {
      position:fixed;
      bottom:22px;
      left:50%;
      transform:translateX(-50%);
      background:#111;
      border:1px solid #b30000;
      padding:10px 18px;
      border-radius:999px;
      opacity:0;
      pointer-events:none;
      transition:.25s;
      z-index:99;
      font-size:.9rem;
    }
    #toast.show { opacity:1; }

    .hint {
      font-size:.75rem;
      color:#888;
      margin-top:4px;
    }
  </style>
</head>

<body>
<header>
  <!-- Tap logo to go home -->
  <a href="/index.html">
    <img src="/icon.PNG" alt="Big Red Connect logo"/>
    <div>
      <div style="font-weight:700;font-size:.95rem;">Big Red Connect</div>
      <div style="font-size:.8rem;color:#888;">Request a Ride</div>
    </div>
  </a>
</header>

<h1>Request a Ride</h1>
<div class="subtitle">Simple, fast, flat-rate local ride request.</div>

<div class="form">

  <!-- Holiday Banner -->
  <div id="holidayBanner">
    ðŸŽ„ Holiday rate may be in effect â€” thanks for riding local during peak dates.
  </div>

  <!-- WHO -->
  <div class="input-group">
    <label>Your Name</label>
    <input id="riderName" placeholder="Your name"/>
  </div>

  <div class="input-group">
    <label>Mobile Number</label>
    <input id="riderPhone" placeholder="555-555-5555" inputmode="tel"/>
  </div>

  <!-- PICKUP -->
  <div class="input-group">
    <label>Pickup Address</label>
    <input id="pickup" class="addr-input" placeholder="Where should we pick you up?"/>
    <div class="hint">Tip: you can type a place, bar, or address.</div>
  </div>

  <!-- GATE / ACCESS NOTES -->
  <div class="input-group">
    <label>Gate Code / Access Notes (optional)</label>
    <input id="gateCode" placeholder="Gate code, building, apartmentâ€¦"/>
  </div>

  <!-- STOPS SECTION -->
  <div class="section-label">Optional Stops</div>

  <div id="stop1Wrap" class="input-group" style="display:none;">
    <label>Stop 1</label>
    <input id="stop1" class="addr-input" placeholder="First stop address or place"/>
  </div>

  <div id="stop2Wrap" class="input-group" style="display:none;">
    <label>Stop 2</label>
    <input id="stop2" class="addr-input" placeholder="Second stop address or place"/>
  </div>

  <div id="stop3Wrap" class="input-group" style="display:none;">
    <label>Stop 3</label>
    <input id="stop3" class="addr-input" placeholder="Third stop address or place"/>
  </div>

  <button type="button" id="btnAddStop" class="btn-ghost btn-small">
    âž• Add a stop
  </button>

  <!-- DROPOFF -->
  <div class="input-group" style="margin-top:16px;">
    <label>Dropoff Address</label>
    <input id="dropoff" class="addr-input" placeholder="Where are you going?"/>
  </div>

  <!-- PASSENGERS + LUGGAGE -->
  <div class="inline" style="margin-top:8px;">
    <div class="input-group">
      <label>Passengers</label>
      <select id="partySize">
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
        <option value="6">6 (max)</option>
      </select>
    </div>

    <div class="input-group" id="luggageGroup" style="display:none;">
      <label>Luggage</label>
      <select id="luggage">
        <option value="0">0</option>
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3+</option>
      </select>
    </div>
  </div>
  <div class="hint" id="luggageHint" style="display:none;">
    Luggage shown because airport was detected in pickup or dropoff.
  </div>

  <!-- TIME -->
  <div class="input-group" style="margin-top:12px;">
    <label>When?</label>
    <select id="timeType">
      <option value="now">Right now</option>
      <option value="schedule">Schedule a time</option>
    </select>
  </div>

  <div class="input-group" id="scheduledGroup" style="display:none;">
    <label>Pick a Time</label>
    <input type="datetime-local" id="scheduledFor"/>
  </div>

  <!-- ESTIMATE (from calculator if provided) -->
  <div class="input-group">
    <label>Estimated Fare</label>
    <input id="estimate" disabled placeholder="From fare calculator or leave blank"/>
  </div>

  <!-- SUBMIT BUTTON -->
  <button class="btn" id="btnSubmit" type="button">
    âœ… Submit Ride Request
  </button>

  <!-- Back to Rider Hub -->
  <button class="btn-ghost" type="button" id="btnBackHub">
    â¬… Back to Rider Hub
  </button>
</div>

<div id="toast"></div>

<script>
/* =======================================================
   CONSTANTS
======================================================= */
const API_BOOKINGS = "https://bigred-bookings.bigredtransportation.workers.dev";

/* =======================================================
   TOAST
======================================================= */
function showToast(msg){
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.classList.add("show");
  setTimeout(()=> t.classList.remove("show"), 1900);
}

/* =======================================================
   PREFILL FROM PROFILE + QUERY
======================================================= */
function prefillFromProfile(){
  const name = localStorage.getItem("riderName");
  const phone = localStorage.getItem("riderPhone");
  const home = localStorage.getItem("riderHome");
  const gate = localStorage.getItem("riderGate");

  if(name)  document.getElementById("riderName").value = name;
  if(phone) document.getElementById("riderPhone").value = phone;
  if(home)  document.getElementById("pickup").value = home;
  if(gate)  document.getElementById("gateCode").value = gate;
}

function prefillFromQuery(){
  const params = new URLSearchParams(location.search);
  const drop = params.get("dropoff");
  const est  = params.get("est");

  if(drop){
    document.getElementById("dropoff").value = decodeURIComponent(drop);
  }
  if(est){
    const num = Number(est);
    if(!Number.isNaN(num) && num > 0){
      document.getElementById("estimate").value = "$" + num.toFixed(2);
    }
  }
}

/* =======================================================
   STOPS LOGIC (up to 3)
======================================================= */
const stopWraps = [
  document.getElementById("stop1Wrap"),
  document.getElementById("stop2Wrap"),
  document.getElementById("stop3Wrap")
];

document.getElementById("btnAddStop").addEventListener("click", () => {
  const next = stopWraps.find(w => w.style.display === "none");
  if(next){
    next.style.display = "block";
    // If now all visible, hide the button
    if(!stopWraps.find(w => w.style.display === "none")){
      document.getElementById("btnAddStop").style.display = "none";
    }
  } else {
    document.getElementById("btnAddStop").style.display = "none";
  }
});

/* =======================================================
   AIRPORT DETECTION â†’ LUGGAGE
======================================================= */
function detectAirport(addr){
  if(!addr) return false;
  addr = addr.toLowerCase();
  return (
    addr.includes("will rogers") ||
    addr.includes("okc airport") ||
    addr.includes("oklahoma city airport") ||
    addr.includes("airport") ||
    addr.includes("terminal")
  );
}

function checkLuggage(){
  const p = document.getElementById("pickup").value;
  const d = document.getElementById("dropoff").value;
  const show = detectAirport(p) || detectAirport(d);
  const group = document.getElementById("luggageGroup");
  const hint  = document.getElementById("luggageHint");
  group.style.display = show ? "block":"none";
  hint.style.display  = show ? "block":"none";
}

document.getElementById("pickup").addEventListener("input", checkLuggage);
document.getElementById("dropoff").addEventListener("input", checkLuggage);

/* =======================================================
   TIME TYPE â†’ SHOW/HIDE SCHEDULER
======================================================= */
document.getElementById("timeType").addEventListener("change", e=>{
  document.getElementById("scheduledGroup").style.display =
    e.target.value==="schedule" ? "block":"none";
});

/* =======================================================
   BACK TO HUB
======================================================= */
document.getElementById("btnBackHub").addEventListener("click", () => {
  window.location.href = "/rider/rider.html";
});

/* =======================================================
   SUBMIT RIDE REQUEST
======================================================= */
document.getElementById("btnSubmit").addEventListener("click", submitRide);

async function submitRide(){
  const name    = document.getElementById("riderName").value.trim();
  const phone   = document.getElementById("riderPhone").value.trim();
  const pickup  = document.getElementById("pickup").value.trim();
  const dropoff = document.getElementById("dropoff").value.trim();

  if(!name || !phone || !pickup || !dropoff){
    showToast("Please fill in name, phone, pickup, and dropoff.");
    return;
  }

  // Save basic profile parts locally
  localStorage.setItem("riderName", name);
  localStorage.setItem("riderPhone", phone);
  localStorage.setItem("riderHome", pickup);
  localStorage.setItem("riderGate", document.getElementById("gateCode").value.trim());

  // Stops
  const stops = [];
  const s1 = document.getElementById("stop1").value.trim();
  const s2 = document.getElementById("stop2").value.trim();
  const s3 = document.getElementById("stop3").value.trim();
  if(s1) stops.push({ address: s1 });
  if(s2) stops.push({ address: s2 });
  if(s3) stops.push({ address: s3 });

  const partySize = Number(document.getElementById("partySize").value);
  const luggage = document.getElementById("luggageGroup").style.display==="block"
    ? Number(document.getElementById("luggage").value)
    : 0;

  const whenType = document.getElementById("timeType").value;
  const scheduledFor = whenType==="schedule"
    ? document.getElementById("scheduledFor").value || null
    : null;

  const estStr = document.getElementById("estimate").value.replace("$","").trim();
  const estimateVal = estStr ? Number(estStr) : 0;

  // Rider ID (persistent per device)
  let riderId = localStorage.getItem("riderId");
  if(!riderId){
    if (window.crypto && crypto.randomUUID) {
      riderId = crypto.randomUUID();
    } else {
      riderId = "rider-" + Date.now() + "-" + Math.floor(Math.random()*999999);
    }
    localStorage.setItem("riderId", riderId);
  }

  const body = {
    type: scheduledFor ? "SCHEDULED" : "INSTANT",
    pickup: {
      address: pickup,
      gate: document.getElementById("gateCode").value.trim()
    },
    dropoff: { address: dropoff },
    stops,
    rider: { name, phone, partySize, riderId },
    pricing: {
      estimate: !Number.isNaN(estimateVal) ? estimateVal : 0,
      travelFee: 0,
      ratePlan: "STANDARD"
    },
    metrics: { miles: null, minutes: null },
    scheduledFor,
    source: "RIDER_APP"
  };

  try {
    const res = await fetch(`${API_BOOKINGS}/api/bookings`, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify(body)
    });

    if(!res.ok){
      showToast("Error submitting ride. Please try again.");
      return;
    }

    const booking = await res.json();

    // Build Stops text nicely for SMS
    const stopsText = stops.length
      ? stops.map((s, idx)=>`${idx+1}) ${s.address}`).join("; ")
      : "None";

    const smsBody =
`Ride Request:
From: ${pickup}
To: ${dropoff}
Stops: ${stopsText}
Name: ${name}
Phone: ${phone}
Passengers: ${partySize}
Luggage: ${luggage}
Booking ID: ${booking.id}`;

    const smsUrl =
      "sms:+14053784024?body=" + encodeURIComponent(smsBody);

    // Kick user to SMS app
    window.location.href = smsUrl;

  } catch(err){
    console.error(err);
    showToast("Network error. Please try again.");
  }
}

/* =======================================================
   INIT ON LOAD
======================================================= */
prefillFromProfile();
prefillFromQuery();
</script>

<!-- =====================================================
     GOOGLE PLACES AUTOCOMPLETE (with bias)
====================================================== -->
<script>
  let bigRedAutocompletes = [];

  function initAutocomplete(){
    if (!window.google || !google.maps || !google.maps.places) {
      console.warn("Google Places not available.");
      return;
    }

    const addrInputs = document.querySelectorAll(".addr-input");

    // Oklahoma City metro-ish bounding box
    const sw = new google.maps.LatLng(34.9, -98.1);
    const ne = new google.maps.LatLng(35.9, -96.8);
    const okcBounds = new google.maps.LatLngBounds(sw, ne);

    addrInputs.forEach(input => {
      const ac = new google.maps.places.Autocomplete(input, {
        fields: ["formatted_address", "name", "geometry"],
        bounds: okcBounds,
        strictBounds: false,
        componentRestrictions: { country: "us" }
      });
      bigRedAutocompletes.push(ac);
    });

    // Try to bias further to the rider's live location
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        pos => {
          const center = new google.maps.LatLng(
            pos.coords.latitude,
            pos.coords.longitude
          );
          const circle = new google.maps.Circle({
            center,
            radius: pos.coords.accuracy || 20000
          });
          const liveBounds = circle.getBounds();
          bigRedAutocompletes.forEach(ac => ac.setBounds(liveBounds));
        },
        err => {
          console.log("Geo denied or failed, using OKC bounds only.", err);
        }
      );
    }
  }
</script>
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCMM0dxLNM7XQI5G3OBSnINeO5hcS3Ks5I&libraries=places&callback=initAutocomplete"></script>

</body>
</html>