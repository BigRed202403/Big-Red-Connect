<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Request a Ride ‚Äì Big Red Connect</title>

  <!-- Icons -->
  <link rel="apple-touch-icon" href="/icon.PNG">
  <link rel="icon" type="image/png" sizes="192x192" href="/icon.PNG">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#000"/>

  <style>
    :root {
      --red: #b30000;
      --bg: #000;
      --panel: #111;
      --border: #222;
      --muted: #aaa;
    }

    body {
      margin:0;
      background:#000;
      color:#fff;
      font-family:-apple-system, BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
      padding-bottom:40px;
    }

    /* Compact App Header */
    header.app-header {
      padding:10px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom:2px solid var(--red);
      background:#000;
      position:sticky;
      top:0;
      z-index:20;
    }

    .header-left {
      display:flex;
      align-items:center;
      gap:8px;
      min-width:0;
    }

    .back-btn {
      background:#111;
      border:1px solid #333;
      color:#fff;
      border-radius:999px;
      width:34px;
      height:34px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:1.1rem;
      cursor:pointer;
      flex-shrink:0;
    }

    .header-logo {
      display:flex;
      align-items:center;
      gap:6px;
      cursor:pointer;
      min-width:0;
    }

    .header-logo img {
      height:34px;
      border-radius:4px;
      flex-shrink:0;
    }

    .header-title-block {
      display:flex;
      flex-direction:column;
      min-width:0;
    }

    .header-title {
      font-size:.95rem;
      font-weight:700;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .header-subtitle {
      font-size:.75rem;
      color:#888;
    }

    .menu-btn {
      background:#111;
      border:1px solid #333;
      color:#fff;
      border-radius:999px;
      padding:6px 10px;
      font-size:.9rem;
      cursor:pointer;
      flex-shrink:0;
    }

    /* Slide-down Menu */
    .menu-sheet {
      position:fixed;
      top:56px; /* just under header */
      left:0;
      right:0;
      background:#050505f0;
      border-bottom:1px solid #222;
      backdrop-filter:blur(8px);
      z-index:19;
      transform:translateY(-100%);
      opacity:0;
      transition:transform .2s ease-out, opacity .2s ease-out;
    }
    .menu-sheet.open {
      transform:translateY(0);
      opacity:1;
    }
    .menu-list {
      list-style:none;
      margin:0;
      padding:8px 0 10px;
    }
    .menu-item-btn {
      width:100%;
      text-align:left;
      padding:10px 16px;
      background:transparent;
      border:none;
      color:#fff;
      font-size:.95rem;
      display:flex;
      align-items:center;
      gap:8px;
      cursor:pointer;
    }
    .menu-item-btn span.icon {
      width:20px;
      text-align:center;
    }

    h1 {
      text-align:center;
      margin:18px 0 10px;
      font-size:1.4rem;
      font-weight:700;
    }

    .form {
      width:calc(100% - 24px);
      margin:0 auto 24px;
    }

    .input-group {
      margin-bottom:14px;
    }
    label {
      display:block;
      font-size:.85rem;
      margin-bottom:4px;
      color:#ccc;
    }
    input, select, textarea {
      width:100%;
      padding:12px;
      background:#111;
      border:1px solid #333;
      border-radius:8px;
      color:#fff;
      font-size:.95rem;
      box-sizing:border-box;
    }

    .btn {
      display:block;
      width:100%;
      margin-top:14px;
      padding:14px;
      background:var(--red);
      color:#fff;
      text-align:center;
      font-weight:700;
      border-radius:10px;
      text-decoration:none;
      font-size:1.05rem;
    }

    .btn-secondary {
      background:#111;
      border:1px solid #333;
      margin-top:8px;
      font-size:.9rem;
      padding:10px;
    }

    #holidayBanner {
      display:none;
      background:#331111;
      border:1px solid #b30000;
      padding:12px;
      border-radius:8px;
      margin-bottom:15px;
      color:#ffcccc;
      font-size:.85rem;
    }

    /* Stops list */
    #stopsContainer {
      margin-bottom:10px;
    }
    .stop-row {
      display:flex;
      align-items:center;
      gap:8px;
      margin-bottom:8px;
    }
    .stop-row input {
      flex:1;
    }
    .remove-stop-btn {
      background:#330000;
      border:1px solid #552222;
      color:#ffcccc;
      border-radius:999px;
      width:32px;
      height:32px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:1rem;
      cursor:pointer;
      flex-shrink:0;
    }
    .stop-hint {
      font-size:.75rem;
      color:#777;
      margin-top:4px;
    }

    #toast {
      position:fixed;
      bottom:22px;
      left:50%;
      transform:translateX(-50%);
      background:#111;
      border:1px solid #b30000;
      padding:10px 18px;
      border-radius:999px;
      opacity:0;
      pointer-events:none;
      transition:.25s;
      z-index:99;
      font-size:.9rem;
    }
    #toast.show { opacity:1; }
  </style>
</head>

<body>

<!-- HEADER -->
<header class="app-header">
  <div class="header-left">
    <button class="back-btn" id="backBtn" aria-label="Back">‚Üê</button>
    <div class="header-logo" id="logoHome">
      <img src="/icon.PNG" alt="Big Red Connect Logo">
      <div class="header-title-block">
        <div class="header-title">Big Red Connect</div>
        <div class="header-subtitle">Request a Ride</div>
      </div>
    </div>
  </div>
  <button class="menu-btn" id="menuBtn">‚ò∞</button>
</header>

<!-- MENU SHEET -->
<div class="menu-sheet" id="menuSheet">
  <ul class="menu-list">
    <li>
      <button class="menu-item-btn" data-link="/">
        <span class="icon">üè†</span> <span>Home</span>
      </button>
    </li>
    <li>
      <button class="menu-item-btn" data-link="/rider/rider.html">
        <span class="icon">üöó</span> <span>Rider Hub</span>
      </button>
    </li>
    <li>
      <button class="menu-item-btn" data-link="/rider/ride-request.html">
        <span class="icon">üìù</span> <span>Request a Ride</span>
      </button>
    </li>
    <li>
      <button class="menu-item-btn" data-link="/rider/myride.html">
        <span class="icon">üìç</span> <span>My Rides</span>
      </button>
    </li>
    <li>
      <button class="menu-item-btn" data-link="/rider/profile.html">
        <span class="icon">üë§</span> <span>My Profile</span>
      </button>
    </li>
  </ul>
</div>

<h1>Request a Ride</h1>

<div class="form">

  <!-- Holiday Banner (logic can be wired later) -->
  <div id="holidayBanner">
    üéÑ Holiday Rate Applied ‚Äî Thank you for riding local during peak holiday dates.
  </div>

  <!-- NAME -->
  <div class="input-group">
    <label>Your Name</label>
    <input id="riderName" placeholder="Your name"/>
  </div>

  <!-- PHONE -->
  <div class="input-group">
    <label>Mobile Number</label>
    <input id="riderPhone" placeholder="555-555-5555" inputmode="tel"/>
  </div>

  <!-- PICKUP -->
  <div class="input-group">
    <label>Pickup Address</label>
    <input id="pickup" placeholder="Where should we pick you up?"/>
  </div>

  <!-- GATE CODE -->
  <div class="input-group">
    <label>Gate Code / Access Notes (optional)</label>
    <input id="gateCode" placeholder="Gate code, building, apartment‚Ä¶"/>
  </div>

  <!-- STOPS -->
  <div class="input-group">
    <label>Stops (optional)</label>
    <div id="stopsContainer"></div>
    <button type="button" class="btn-secondary" id="btnAddStop">‚ûï Add a Stop</button>
    <div class="stop-hint">You can add a couple of quick stops on the way.</div>
  </div>

  <!-- DROPOFF -->
  <div class="input-group">
    <label>Dropoff Address</label>
    <input id="dropoff" placeholder="Where are you going?"/>
  </div>

  <!-- PASSENGERS -->
  <div class="input-group">
    <label>Passengers</label>
    <select id="partySize">
      <option value="1">1</option>
      <option value="2">2</option>
      <option value="3">3</option>
      <option value="4">4</option>
      <option value="5">5+</option>
    </select>
  </div>

  <!-- LUGGAGE (auto-shown for airport rides) -->
  <div class="input-group" id="luggageGroup" style="display:none;">
    <label>Luggage Pieces</label>
    <select id="luggage">
      <option value="0">0</option>
      <option value="1">1</option>
      <option value="2">2</option>
      <option value="3">3+</option>
    </select>
  </div>

  <!-- TIME -->
  <div class="input-group">
    <label>When?</label>
    <select id="timeType">
      <option value="now">Right now</option>
      <option value="schedule">Schedule a time</option>
    </select>
  </div>

  <div class="input-group" id="scheduledGroup" style="display:none;">
    <label>Pick a Time</label>
    <input type="datetime-local" id="scheduledFor"/>
  </div>

  <!-- ESTIMATE (placeholder, could be wired to fare calc later) -->
  <div class="input-group">
    <label>Estimated Fare</label>
    <input id="estimate" disabled placeholder="$0.00"/>
  </div>

  <a class="btn" id="btnSubmit">Submit Ride Request</a>

</div>

<div id="toast"></div>

<script>
/* =======================================================
   BASIC TOAST
======================================================= */
function showToast(msg){
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.classList.add("show");
  setTimeout(()=> t.classList.remove("show"), 2000);
}

/* =======================================================
   HEADER NAVIGATION
======================================================= */
const backBtn   = document.getElementById("backBtn");
const logoHome  = document.getElementById("logoHome");
const menuBtn   = document.getElementById("menuBtn");
const menuSheet = document.getElementById("menuSheet");

backBtn.addEventListener("click", () => {
  if (window.history.length > 1) {
    window.history.back();
  } else {
    window.location.href = "/rider/rider.html";
  }
});

logoHome.addEventListener("click", () => {
  window.location.href = "/rider/rider.html";
});

menuBtn.addEventListener("click", () => {
  menuSheet.classList.toggle("open");
});

menuSheet.addEventListener("click", (e) => {
  const btn = e.target.closest(".menu-item-btn");
  if (!btn) return;
  const link = btn.getAttribute("data-link");
  if (link) window.location.href = link;
});

document.addEventListener("click", (e) => {
  if (!menuSheet.classList.contains("open")) return;
  const withinHeader = e.target.closest(".app-header");
  const withinMenu = e.target.closest(".menu-sheet");
  if (!withinHeader && !withinMenu) {
    menuSheet.classList.remove("open");
  }
});

/* =======================================================
   PREFILL FROM PROFILE (localStorage)
======================================================= */
function prefillFromProfile(){
  const name = localStorage.getItem("riderName");
  const phone = localStorage.getItem("riderPhone");
  const home = localStorage.getItem("riderHome");
  const gate = localStorage.getItem("riderGate");

  if(name)  document.getElementById("riderName").value = name;
  if(phone) document.getElementById("riderPhone").value = phone;
  if(home)  document.getElementById("pickup").value = home;
  if(gate)  document.getElementById("gateCode").value = gate;
}

/* =======================================================
   AIRPORT / LUGGAGE DETECTION
======================================================= */
function detectAirport(addr){
  if(!addr) return false;
  addr = addr.toLowerCase();
  return (
    addr.includes("will rogers") ||
    addr.includes("okc airport") ||
    addr.includes("terminal") ||
    addr.includes("airport")
  );
}

function checkLuggage(){
  const p = document.getElementById("pickup").value;
  const d = document.getElementById("dropoff").value;
  const show = detectAirport(p) || detectAirport(d);
  document.getElementById("luggageGroup").style.display = show ? "block":"none";
}

document.getElementById("pickup").addEventListener("input", checkLuggage);
document.getElementById("dropoff").addEventListener("input", checkLuggage);

/* =======================================================
   SCHEDULED TIME TOGGLE
======================================================= */
document.getElementById("timeType").addEventListener("change", e=>{
  document.getElementById("scheduledGroup").style.display =
    e.target.value==="schedule" ? "block":"none";
});

/* =======================================================
   STOPS: ADD / REMOVE (max 3)
======================================================= */
const stopsContainer = document.getElementById("stopsContainer");
const btnAddStop = document.getElementById("btnAddStop");
const MAX_STOPS = 3;

btnAddStop.addEventListener("click", () => {
  const current = stopsContainer.querySelectorAll(".stop-row").length;
  if (current >= MAX_STOPS) {
    showToast("Max stops reached");
    return;
  }
  addStopRow("");
});

function addStopRow(initialValue){
  const row = document.createElement("div");
  row.className = "stop-row";
  row.innerHTML = '' +
    '<input class="stop-input" placeholder="Add a quick stop" />' +
    '<button type="button" class="remove-stop-btn" aria-label="Remove stop">‚úï</button>';
  stopsContainer.appendChild(row);

  const input = row.querySelector(".stop-input");
  if (initialValue) input.value = initialValue;

  // Autocomplete hookup if Google is ready
  if (window.google && google.maps && google.maps.places) {
    setupAutocomplete(input);
  }

  const removeBtn = row.querySelector(".remove-stop-btn");
  removeBtn.addEventListener("click", () => {
    row.remove();
  });
}

/* =======================================================
   GOOGLE PLACES AUTOCOMPLETE
   - Biased to rider's current location when available
======================================================= */
let autocompleteInstances = [];
let userBounds = null;

function setupAutocomplete(inputEl){
  if (!window.google || !google.maps || !google.maps.places) return;

  const opts = {
    fields: ["formatted_address", "name", "geometry"],
    componentRestrictions: { country: "us" }
  };
  const ac = new google.maps.places.Autocomplete(inputEl, opts);
  if (userBounds) ac.setBounds(userBounds);

  autocompleteInstances.push(ac);
}

function initPlaces() {
  const pickupEl  = document.getElementById("pickup");
  const dropoffEl = document.getElementById("dropoff");

  if (pickupEl)  setupAutocomplete(pickupEl);
  if (dropoffEl) setupAutocomplete(dropoffEl);

  // Try to bias to user location (50km radius)
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        const center = new google.maps.LatLng(pos.coords.latitude, pos.coords.longitude);
        const circle = new google.maps.Circle({
          center,
          radius: 50000
        });
        userBounds = circle.getBounds();
        autocompleteInstances.forEach(ac => ac.setBounds(userBounds));
      },
      () => {
        // Ignore errors silently, autocomplete still works
      },
      { enableHighAccuracy:false, timeout:8000, maximumAge:600000 }
    );
  }
}

/* =======================================================
   SUBMIT RIDE REQUEST
======================================================= */
document.getElementById("btnSubmit").addEventListener("click", submitRide);

async function submitRide(){
  const name = document.getElementById("riderName").value.trim();
  const phone = document.getElementById("riderPhone").value.trim();
  const pickup = document.getElementById("pickup").value.trim();
  const dropoff = document.getElementById("dropoff").value.trim();

  if(!name || !phone || !pickup || !dropoff){
    showToast("Missing required fields");
    return;
  }

  // Save profile pieces locally
  localStorage.setItem("riderName", name);
  localStorage.setItem("riderPhone", phone);
  localStorage.setItem("riderHome", pickup);
  localStorage.setItem("riderGate", document.getElementById("gateCode").value.trim());

  // Collect stops from inputs
  const stopInputs = Array.from(document.querySelectorAll(".stop-input"));
  const stopList = stopInputs
    .map(i => i.value.trim())
    .filter(v => v.length)
    .map(addr => ({ address: addr }));

  const partySize = Number(document.getElementById("partySize").value);
  const luggage = document.getElementById("luggageGroup").style.display==="block"
      ? Number(document.getElementById("luggage").value)
      : 0;

  const whenType = document.getElementById("timeType").value;
  const scheduledFor = whenType==="schedule"
      ? document.getElementById("scheduledFor").value
      : null;

  const estimateValRaw = document.getElementById("estimate").value.replace("$","").trim();
  const estimateVal = estimateValRaw ? Number(estimateValRaw) : 0;

  // Rider ID (for future profile worker integration)
  let riderId = localStorage.getItem("riderId");
  if (!riderId) {
    riderId = crypto.randomUUID();
    localStorage.setItem("riderId", riderId);
  }

  const body = {
    type: scheduledFor ? "SCHEDULED":"INSTANT",
    pickup: { address: pickup, gate: document.getElementById("gateCode").value.trim() },
    dropoff: { address: dropoff },
    stops: stopList,
    rider: { name, phone, partySize, riderId },
    pricing: { estimate: estimateVal, travelFee:0 },
    scheduledFor,
    source: "RIDER_APP"
  };

  const API = "https://bigred-bookings.bigredtransportation.workers.dev";

  let res;
  try {
    res = await fetch(`${API}/api/bookings`, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify(body)
    });
  } catch(err) {
    console.error(err);
    showToast("Error submitting");
    return;
  }

  if(!res.ok){
    showToast("Error submitting");
    return;
  }

  const booking = await res.json();

  // Open SMS pre-fill so everything stays like your original flow
  const sms =
    "sms:+14053784024?body=" +
    encodeURIComponent(
      `Ride Request:
From: ${pickup}
To: ${dropoff}
Name: ${name}
Phone: ${phone}
Stops: ${stopInputs.length ? stopInputs.map(i=>i.value.trim()).filter(v=>v).join(" | ") : "None"}
Passengers: ${partySize}
Luggage: ${luggage}
Booking ID: ${booking.id}`
    );

  window.location.href = sms;
}

/* =======================================================
   INITIALIZE
======================================================= */
prefillFromProfile();
</script>

<!-- Google Places JS (same key you use on main index) -->
<script
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCMM0dxLNM7XQI5G3OBSnINeO5hcS3Ks5I&libraries=places&callback=initPlaces"
  async defer></script>

</body>
</html>