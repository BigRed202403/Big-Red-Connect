<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Request a Ride – Big Red Connect</title>

<!-- Icons -->
<link rel="apple-touch-icon" href="/icon.PNG">
<link rel="icon" type="image/png" sizes="192x192" href="/icon.PNG">
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#000"/>

<!-- Google Maps Autocomplete -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCMM0dxLNM7XQI5GOBSnINeO5hcS3Ks5I&libraries=places"></script>

<style>
  body {
    margin:0;
    background:#000;
    color:#fff;
    font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    padding-bottom:60px;
  }

  /* Header */
  header {
    background:#000;
    padding:12px;
    border-bottom:2px solid #b30000;
    display:flex;
    justify-content:space-between;
    align-items:center;
    position:sticky;
    top:0;
    z-index:50;
  }
  .header-left { display:flex; align-items:center; gap:10px; }
  .logo { height:42px; cursor:pointer; }

  #menuBtn {
    font-size:1.6rem;
    background:none;
    color:white;
    border:none;
    cursor:pointer;
  }

  #menuPanel {
    display:none;
    flex-direction:column;
    background:#111;
    border-bottom:2px solid #b30000;
  }
  #menuPanel a {
    padding:16px;
    color:#fff;
    text-decoration:none;
    border-bottom:1px solid #222;
    font-size:1rem;
  }
  #menuPanel a:hover { background:#222; }

  h1 {
    text-align:center;
    margin:20px 0 10px;
    font-size:1.4rem;
    font-weight:700;
  }

  .form { width:calc(100% - 24px); margin:10px auto; }
  .input-group { margin-bottom:14px; }
  label {
    display:block;
    font-size:.85rem;
    margin-bottom:4px;
    color:#ccc;
  }
  input, select {
    width:100%;
    padding:12px;
    background:#111;
    border:1px solid #333;
    border-radius:8px;
    color:#fff;
    font-size:.95rem;
  }

  .btn {
    display:block;
    width:100%;
    margin-top:14px;
    padding:14px;
    background:#b30000;
    color:#fff;
    text-align:center;
    font-weight:700;
    border-radius:10px;
    text-decoration:none;
    font-size:1.05rem;
  }
  .btn-small {
    width:100%;
    background:#111;
    border:1px solid #444;
    padding:10px;
    text-align:center;
    border-radius:8px;
    font-size:.85rem;
    margin-bottom:10px;
  }

  #toast {
    position:fixed;
    bottom:22px;
    left:50%;
    transform:translateX(-50%);
    background:#111;
    border:1px solid #b30000;
    padding:10px 18px;
    border-radius:999px;
    opacity:0;
    pointer-events:none;
    transition:.25s;
    z-index:999;
  }
  #toast.show { opacity:1; }
</style>
</head>

<body>

<header>
  <div class="header-left">
    <img src="/icon.PNG" class="logo" onclick="window.location.href='/index.html';">
    <div style="font-weight:700;font-size:1rem;">Request a Ride</div>
  </div>
  <button id="menuBtn">☰</button>
</header>

<!-- MENU PANEL -->
<nav id="menuPanel">
  <a href="/rider/rider.html">Rider Hub</a>
  <a href="/rider/ride-request.html">Request a Ride</a>
  <a href="/rider/myride.html">My Ride</a>
  <a href="/rider/profile.html">Profile</a>
  <a href="#" id="logoutBtn">Log Out</a>
</nav>

<h1>Request a Ride</h1>

<div class="form">

  <div class="input-group">
    <label>Your Name</label>
    <input id="riderName" placeholder="Your name">
  </div>

  <div class="input-group">
    <label>Mobile Number</label>
    <input id="riderPhone" placeholder="555-555-5555" inputmode="tel">
  </div>

  <div class="input-group">
    <label>Pickup Address</label>
    <input id="pickup" placeholder="Where should we pick you up?">
  </div>

  <div class="input-group">
    <label>Gate / Access Code (optional)</label>
    <input id="gateCode" placeholder="Gate code, building, apt…">
  </div>

  <!-- Dynamic Stops -->
  <button class="btn-small" id="btnAddStop">➕ Add Stop</button>
  <div id="stopsContainer"></div>

  <div class="input-group">
    <label>Dropoff Address</label>
    <input id="dropoff" placeholder="Where are you going?">
  </div>

  <div class="input-group">
    <label>Passengers</label>
    <select id="partySize">
      <option value="1">1</option>
      <option value="2">2</option>
      <option value="3">3</option>
      <option value="4">4</option>
      <option value="5">5+</option>
    </select>
  </div>

  <div class="input-group" id="luggageGroup" style="display:none;">
    <label>Luggage (airport ride)</label>
    <select id="luggage">
      <option value="0">0</option>
      <option value="1">1</option>
      <option value="2">2</option>
      <option value="3">3+</option>
    </select>
  </div>

  <div class="input-group">
    <label>When?</label>
    <select id="timeType">
      <option value="now">Right now</option>
      <option value="schedule">Schedule a time</option>
    </select>
  </div>

  <div class="input-group" id="scheduledGroup" style="display:none;">
    <label>Pick a Time</label>
    <input type="datetime-local" id="scheduledFor">
  </div>

  <div class="input-group">
    <label>Estimated Fare</label>
    <input id="estimate" disabled placeholder="$0.00">
  </div>

  <a class="btn" id="btnSubmit">Submit Ride Request</a>

</div>

<div id="toast"></div>

<script>
/* MENU LOGIC */
document.getElementById("menuBtn").addEventListener("click",()=>{
  const m=document.getElementById("menuPanel");
  m.style.display=(m.style.display==="flex"?"none":"flex");
});
document.getElementById("logoutBtn").addEventListener("click",()=>{
  localStorage.clear();
  window.location.href="/index.html";
});

/* TOAST */
function showToast(msg){
  const t=document.getElementById("toast");
  t.textContent=msg;
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"),1800);
}

/* PREFILL FROM PROFILE */
function prefill(){
  ["riderName","riderPhone","riderHome","riderGate"].forEach(k=>{
    const v=localStorage.getItem(k);
    if(v){
      if(k==="riderHome") document.getElementById("pickup").value=v;
      else if(k==="riderGate") document.getElementById("gateCode").value=v;
      else document.getElementById(k).value=v;
    }
  });
}

/* GOOGLE AUTOCOMPLETE SETUP */
let autoPickup, autoDropoff;
let autoStops = [];

function initAutocomplete(){
  // OKC Metro Bounds
  const okcBounds = new google.maps.LatLngBounds(
    { lat: 34.8, lng: -98.0 },   // SW
    { lat: 36.0, lng: -96.0 }    // NE
  );

  const options = {
    bounds: okcBounds,
    strictBounds:false,
    fields:["formatted_address","geometry","name"]
  };

  // MAIN FIELDS
  autoPickup = new google.maps.places.Autocomplete(
    document.getElementById("pickup"), options
  );
  autoDropoff = new google.maps.places.Autocomplete(
    document.getElementById("dropoff"), options
  );

  // BIAS TO USER LOCATION
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(pos=>{
      const userCircle = new google.maps.Circle({
        center:{lat:pos.coords.latitude,lng:pos.coords.longitude},
        radius:25000
      });
      autoPickup.setBounds(userCircle.getBounds());
      autoDropoff.setBounds(userCircle.getBounds());
      autoStops.forEach(a=>a.setBounds(userCircle.getBounds()));
    });
  }
}

/* ADD STOP */
let stopCount = 0;
document.getElementById("btnAddStop").addEventListener("click",()=>{
  stopCount++;
  const id="stop"+stopCount;
  const div=document.createElement("div");
  div.className="input-group";
  div.innerHTML=`
    <label>Stop ${stopCount}</label>
    <input id="${id}" placeholder="Add stop address">
  `;
  document.getElementById("stopsContainer").appendChild(div);

  const a = new google.maps.places.Autocomplete(
    document.getElementById(id),
    { fields:["formatted_address","geometry","name"] }
  );
  autoStops.push(a);
});

/* AIRPORT LUGGAGE DETECTION */
function detectAirport(t){
  if(!t) return false;
  t=t.toLowerCase();
  return t.includes("will rogers") || t.includes("airport");
}
function checkAirport(){
  const p=document.getElementById("pickup").value;
  const d=document.getElementById("dropoff").value;
  document.getElementById("luggageGroup").style.display=
    (detectAirport(p)||detectAirport(d))?"block":"none";
}
document.getElementById("pickup").addEventListener("input",checkAirport);
document.getElementById("dropoff").addEventListener("input",checkAirport);

/* SHOW SCHEDULE BOX */
document.getElementById("timeType").addEventListener("change",e=>{
  document.getElementById("scheduledGroup").style.display=
    (e.target.value==="schedule"?"block":"none");
});

/* SUBMIT RIDE */
document.getElementById("btnSubmit").addEventListener("click",submitRide);

async function submitRide(){
  const name=document.getElementById("riderName").value.trim();
  const phone=document.getElementById("riderPhone").value.trim();
  const pickup=document.getElementById("pickup").value.trim();
  const dropoff=document.getElementById("dropoff").value.trim();

  if(!name||!phone||!pickup||!dropoff){
    showToast("Missing required fields");
    return;
  }

  /* Save Local Profile */
  localStorage.setItem("riderName",name);
  localStorage.setItem("riderPhone",phone);
  localStorage.setItem("riderHome",pickup);
  localStorage.setItem("riderGate",document.getElementById("gateCode").value.trim());

  /* Stops */
  const stops=[];
  for(let i=1;i<=stopCount;i++){
    const val=document.getElementById("stop"+i)?.value.trim();
    if(val) stops.push({ address:val });
  }

  /* Luggage */
  const luggage =
    document.getElementById("luggageGroup").style.display==="block" ?
    Number(document.getElementById("luggage").value) :
    0;

  /* Time */
  const when=document.getElementById("timeType").value;
  const scheduledFor =
    (when==="schedule") ? document.getElementById("scheduledFor").value : null;

  /* Estimate placeholder */
  const est = Number(
    document.getElementById("estimate").value.replace("$","") || 0
  );

  /* Rider ID */
  const riderId = localStorage.getItem("riderId") || crypto.randomUUID();
  localStorage.setItem("riderId", riderId);

  /* Build Body */
  const body={
    type: scheduledFor ? "SCHEDULED" : "INSTANT",
    pickup:{ address:pickup, gate:document.getElementById("gateCode").value },
    dropoff:{ address:dropoff },
    stops,
    rider:{ name, phone, partySize:Number(document.getElementById("partySize").value), riderId },
    pricing:{ estimate:est },
    scheduledFor,
    luggage,
    source:"RIDER_APP"
  };

  const API="https://bigred-bookings.bigredtransportation.workers.dev";

  const res=await fetch(`${API}/api/bookings`,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify(body)
  });

  if(!res.ok){
    showToast("Error submitting request");
    return;
  }

  const b=await res.json();

  // Auto-open SMS
  const sms =
    `sms:+14053784024?body=` +
    encodeURIComponent(`Ride Request:
From: ${pickup}
To: ${dropoff}
Name: ${name}
Phone: ${phone}
Stops: ${stops.map(s=>s.address).join(", ") || "None"}
Passengers: ${body.rider.partySize}
Luggage: ${luggage}
Booking ID: ${b.id}`);

  window.location.href=sms;
}

prefill();
window.onload=initAutocomplete;
</script>
</body>
</html>