<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Profile — Big Red Connect</title>

  <!-- Icons -->
  <link rel="apple-touch-icon" href="/icon.PNG">
  <link rel="icon" type="image/png" href="/icon.PNG">

  <!-- No cache -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <style>
    :root {
      --red: #b30000;
      --bg: #000;
      --panel: #111;
      --border: #222;
      --muted: #aaa;
      --accent: #ffcc00;
    }

    body {
      margin:0;
      padding:0;
      background:#000;
      color:#fff;
      font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }

    header {
      background:#000;
      border-bottom:2px solid var(--red);
      padding:12px 16px;
      display:flex;
      align-items:center;
      gap:12px;
    }

    header img.logo {
      height:40px;
      border-radius:6px;
    }

    .container {
      padding:16px;
    }

    .section {
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:12px;
      padding:18px;
      margin-bottom:18px;
    }

    .section-title {
      font-size:1rem;
      font-weight:700;
      margin-bottom:12px;
      text-transform:uppercase;
      letter-spacing:0.5px;
      color:#ddd;
    }

    label {
      display:block;
      font-size:.8rem;
      margin-bottom:4px;
      color:#ccc;
    }

    input, textarea {
      width:100%;
      background:#000;
      border:1px solid #333;
      border-radius:8px;
      padding:10px;
      font-size:.9rem;
      color:#fff;
      margin-bottom:14px;
    }

    textarea {
      resize:none;
      min-height:70px;
    }

    .btn {
      width:100%;
      padding:12px;
      border:none;
      border-radius:10px;
      font-size:1rem;
      font-weight:700;
      cursor:pointer;
      margin-top:10px;
    }

    .btn-primary { background:var(--red); color:#fff; }
    .btn-secondary { background:#111; border:1px solid #333; color:#fff; }

    #toast {
      position:fixed;
      bottom:20px;
      left:50%;
      transform:translateX(-50%);
      background:#111;
      border:1px solid var(--red);
      padding:12px 18px;
      border-radius:999px;
      color:#fff;
      opacity:0;
      pointer-events:none;
      transition:.25s;
      z-index:1000;
    }

    #toast.show { opacity:1; }

    .footer-space { height:40px; }
  </style>
</head>

<body>

<header>
  <a href="/rider/rider.html"><img src="/official_logo_Nov.png" class="logo"></a>
  <div>
    <div style="font-size:.9rem;font-weight:700;">My Profile</div>
    <div style="font-size:.75rem;color:#888;">Customize your ride details</div>
  </div>
</header>

<div class="container">

  <!-- IDENTIFICATION -->
  <div class="section">
    <div class="section-title">Your Info</div>

    <label for="name">Your Name</label>
    <input id="name" placeholder="Enter your name">

    <label for="phone">Phone Number</label>
    <input id="phone" disabled style="opacity:0.7;">
    <div style="font-size:.75rem;color:#999;margin-top:-10px;margin-bottom:10px;">
      (Phone is used as login and cannot be changed)
    </div>

    <label for="partySize">Default Group Size</label>
    <input id="partySize" type="number" min="1" placeholder="1">
  </div>

  <!-- HOME PICKUP -->
  <div class="section">
    <div class="section-title">Home / Usual Pickup</div>

    <label for="home">Home Address</label>
    <input id="home" placeholder="123 Main St, Moore OK">

    <label for="gateCode">Gate Code / Access Instructions</label>
    <textarea id="gateCode" placeholder="Optional"></textarea>
  </div>

  <button class="btn btn-primary" id="saveBtn">Save Profile</button>
  <button class="btn btn-secondary" onclick="window.location='/rider/rider.html'">Back</button>

  <div class="footer-space"></div>
</div>

<div id="toast"></div>

<script>
  const API = "https://bigred-rider-profiles.bigredtransportation.workers.dev";
  let riderId = localStorage.getItem("rider_id");
  let riderPhone = localStorage.getItem("rider_phone");

  function showToast(msg) {
    const t = document.getElementById("toast");
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(() => t.classList.remove("show"), 1800);
  }

  async function loadProfile() {
    if (!riderId) return;

    try {
      const res = await fetch(`${API}/api/profile/${riderId}`);
      if (!res.ok) return;

      const data = await res.json();

      document.getElementById("name").value = data.name || "";
      document.getElementById("phone").value = data.phone || riderPhone || "";
      document.getElementById("partySize").value = data.partySize || "";
      document.getElementById("home").value = data.homeAddress || "";
      document.getElementById("gateCode").value = data.gateCode || "";

    } catch (err) {
      console.error("Load profile error:", err);
    }
  }

  async function saveProfile() {
    if (!riderId) {
      showToast("Missing rider ID.");
      return;
    }

    const body = {
      id: riderId,
      name: document.getElementById("name").value.trim(),
      phone: riderPhone,
      partySize: Number(document.getElementById("partySize").value || 1),
      homeAddress: document.getElementById("home").value.trim(),
      gateCode: document.getElementById("gateCode").value.trim()
    };

    try {
      const res = await fetch(`${API}/api/profile/${riderId}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });

      if (res.ok) {
        showToast("Profile saved ✔");
      } else {
        showToast("Save failed");
      }
    } catch (err) {
      console.error("Save error:", err);
      showToast("Save failed");
    }
  }

  document.getElementById("saveBtn").addEventListener("click", saveProfile);

  loadProfile();
</script>

</body>
</html>