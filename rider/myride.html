<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>My Ride â€“ Big Red Connect</title>

<link rel="apple-touch-icon" href="/icon.PNG">
<link rel="icon" type="image/png" sizes="192x192" href="/icon.PNG">
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#000"/>

<style>
body {
  margin:0;
  background:#000;
  color:#fff;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
}
header {
  background:#000;
  padding:12px;
  border-bottom:2px solid #b30000;
  display:flex;
  justify-content:space-between;
  align-items:center;
  position:sticky;
  top:0;
}
.logo { height:42px; }
#menuBtn { font-size:1.6rem;background:none;border:none;color:white;cursor:pointer; }
#menuPanel {
  display:none;
  flex-direction:column;
  background:#111;
  border-bottom:2px solid #b30000;
}
#menuPanel a {
  padding:16px;
  color:#fff;
  text-decoration:none;
  border-bottom:1px solid #222;
}
.container { padding:20px;text-align:center; }
.card {
  background:#111;
  border:1px solid #333;
  border-radius:12px;
  padding:14px;
  margin:12px;
}
#map {
  height:340px;
  margin:12px;
  border-radius:12px;
  border:1px solid #333;
  display:none;
}
.status { color:#ccc;font-size:.9rem; }
#etaBox { display:none; }
.btn {
  display:block;
  width:calc(100% - 24px);
  margin:12px auto;
  padding:14px;
  background:#b30000;
  color:#fff;
  text-decoration:none;
  border-radius:10px;
  font-weight:700;
}
.btn.secondary {
  background:#111;
  border:1px solid #333;
}
</style>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCMM0dxLNM7XQI5G3OBSnINeO5hcS3Ks5I&libraries=geometry"></script>
</head>

<body>

<header>
  <div style="display:flex;align-items:center;gap:10px;">
    <a href="/index.html"><img src="/icon.PNG" class="logo"></a>
    <strong>My Ride</strong>
  </div>
  <button id="menuBtn">â˜°</button>
</header>

<nav id="menuPanel">
  <a href="/rider/rider.html">Rider Hub</a>
  <a href="/rider/ride-request.html">Request Ride</a>
  <a href="/rider/profile.html">Profile</a>
  <a href="#" id="logoutBtn">Log Out</a>
</nav>

<div class="container">
  <h1>Your Ride</h1>
  <div id="activeRide"></div>
</div>

<div id="map"></div>

<div id="etaBox" class="card"></div>

<a href="/rider/ride-request.html" class="btn">Request Another Ride</a>
<a href="/rider/rider.html" class="btn secondary">Back to Rider Hub</a>

<script>
const BOOKINGS_API = "https://bigred-bookings.bigredtransportation.workers.dev";
const STATUS_API   = "https://bigred-status-updater.bigredtransportation.workers.dev/status";

let map, directionsService, directionsRenderer;
let driverMarker, pickupMarker, dropoffMarker;
let etaTimer = null;
let activeRide = null;

document.getElementById("menuBtn").onclick = () => {
  const p = document.getElementById("menuPanel");
  p.style.display = p.style.display==="flex"?"none":"flex";
};
document.getElementById("logoutBtn").onclick = () => {
  localStorage.clear();
  location.href="/index.html";
};

async function loadRide(){
  const riderId = localStorage.getItem("riderId");
  if(!riderId) return;

  const res = await fetch(`${BOOKINGS_API}/api/driver/bookings?scope=active`);
  const list = await res.json();

  activeRide = list.find(r => r.rider?.riderId === riderId);
  if(!activeRide){
    document.getElementById("activeRide").innerHTML =
      `<div class="card">No active ride.</div>`;
    return;
  }

  document.getElementById("activeRide").innerHTML = `
    <div class="card">
      <div class="status">Status: ${activeRide.status}</div>
      <div>Pickup: ${activeRide.pickup.address}</div>
      <div>Dropoff: ${activeRide.dropoff.address}</div>
    </div>
  `;

  initMap();
}

function initMap(){
  document.getElementById("map").style.display="block";

  directionsService = new google.maps.DirectionsService();
  directionsRenderer = new google.maps.DirectionsRenderer({ suppressMarkers:true });

  map = new google.maps.Map(document.getElementById("map"), {
    zoom:12,
    center:{ lat:35.4676,lng:-97.5164 }
  });
  directionsRenderer.setMap(map);

  geocodeAndStart();
}

async function geocodeAndStart(){
  const geocoder = new google.maps.Geocoder();

  const pickup = await geocode(geocoder, activeRide.pickup.address);
  const dropoff = await geocode(geocoder, activeRide.dropoff.address);

  pickupMarker = new google.maps.Marker({
    map, position:pickup, label:"P"
  });
  dropoffMarker = new google.maps.Marker({
    map, position:dropoff, label:"D"
  });

  startTracking(pickup, dropoff);
}

function geocode(geocoder, addr){
  return new Promise((resolve,reject)=>{
    geocoder.geocode({ address:addr }, (res,status)=>{
      if(status==="OK") resolve(res[0].geometry.location);
      else reject(status);
    });
  });
}

async function startTracking(pickup, dropoff){
  if(etaTimer) clearInterval(etaTimer);
  await updateDriver(pickup, dropoff);
  etaTimer = setInterval(()=>updateDriver(pickup,dropoff),15000);
}

async function updateDriver(pickup, dropoff){
  const res = await fetch(STATUS_API+"?t="+Date.now());
  const j = await res.json();

  const lat = j.location?.lat;
  const lng = j.location?.lng;
  if(typeof lat!=="number"||typeof lng!=="number") return;

  const driverPos = new google.maps.LatLng(lat,lng);

  if(!driverMarker){
    driverMarker = new google.maps.Marker({
      map, position:driverPos, label:"ðŸš—"
    });
  } else {
    driverMarker.setPosition(driverPos);
  }

  const route = await directionsService.route({
    origin:driverPos,
    destination:dropoff,
    waypoints:[{ location:pickup }],
    travelMode:"DRIVING"
  });

  directionsRenderer.setDirections(route);

  const leg = route.routes[0].legs[0];
  const mins = Math.round(leg.duration.value/60);
  const miles = (leg.distance.value/1609.34).toFixed(1);

  document.getElementById("etaBox").style.display="block";
  document.getElementById("etaBox").innerHTML = `
    <div class="status">ETA â‰ˆ ${mins} min</div>
    <div class="status">Distance â‰ˆ ${miles} mi</div>
    <div class="status">Updated ${new Date().toLocaleTimeString()}</div>
  `;

  const bounds = new google.maps.LatLngBounds();
  bounds.extend(driverPos);
  bounds.extend(pickup);
  bounds.extend(dropoff);
  map.fitBounds(bounds);
}

loadRide();
</script>

<!-- ðŸ”” OneSignal identity rebind -->
<script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
<script>
window.OneSignalDeferred = window.OneSignalDeferred || [];
OneSignalDeferred.push(async OneSignal=>{
  try{
    const raw = localStorage.getItem("bigred_rider_profile_v1");
    if(!raw) return;
    const p = JSON.parse(raw);
    if(p.riderId) await OneSignal.login(p.riderId);
  }catch{}
});
</script>

</body>
</html>