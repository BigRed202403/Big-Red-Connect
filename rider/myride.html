<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My Rides ‚Äì Big Red Connect</title>

  <!-- PWA / Icons -->
  <link rel="apple-touch-icon" href="/icon.PNG">
  <link rel="icon" type="image/png" sizes="192x192" href="/icon.png">
  <link rel="shortcut icon" href="/icon.PNG">
  <link rel="manifest" href="manifest-rider.json">
  <meta name="apple-mobile-web-app-title" content="Big Red Rider">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="theme-color" content="#000000">

  <!-- Global Styles -->
  <link rel="stylesheet" href="/style.css" />

  <!-- Google Maps (for live driver map) -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCMM0dxLNM7XQI5G3OBSnINeO5hcS3Ks5I&libraries=geometry"></script>

  <!-- No cache -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <style>
    body {
      margin: 0;
      background: #000;
      color: #fff;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }
    header {
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 14px;
      border-bottom:2px solid #b30000;
      background:#050505;
      position:sticky;
      top:0;
      z-index:10;
    }
    header .left {
      display:flex;
      align-items:center;
      gap:10px;
    }
    header img {
      height:40px;
      border-radius:4px;
    }
    header .title-text {
      font-size:0.9rem;
      line-height:1.2;
    }
    header .title-text div:first-child {
      font-weight:700;
    }
    header .home-link a {
      color:#fff;
      text-decoration:none;
      font-size:0.85rem;
      border:1px solid #b30000;
      border-radius:8px;
      padding:6px 10px;
    }

    main {
      padding:14px;
      max-width:720px;
      margin:0 auto 40px auto;
    }
    h1 {
      font-size:1.5rem;
      color:#ff1a1a;
      text-align:center;
      margin:10px 0 4px;
    }
    .tagline {
      text-align:center;
      color:#aaa;
      font-size:0.9rem;
      margin-bottom:14px;
    }

    .section-label {
      font-size:0.95rem;
      font-weight:700;
      margin:18px 0 8px;
      color:#ff4c4c;
      border-bottom:1px solid #222;
      padding-bottom:4px;
    }

    .rides-empty {
      font-size:0.9rem;
      color:#888;
      padding:10px 4px 4px;
    }

    .ride-card {
      background:#111;
      border-radius:10px;
      border:1px solid #222;
      padding:12px 10px 12px;
      margin-bottom:10px;
      font-size:0.9rem;
    }
    .ride-row {
      display:flex;
      justify-content:space-between;
      gap:8px;
      margin-top:4px;
    }
    .ride-label {
      font-size:0.75rem;
      color:#aaa;
      text-transform:uppercase;
      letter-spacing:0.03em;
    }
    .ride-value {
      font-size:0.9rem;
      color:#fff;
      margin-top:2px;
    }
    .ride-status-row {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      margin-top:8px;
    }
    .status-pill {
      display:inline-block;
      padding:4px 10px;
      border-radius:999px;
      font-size:0.78rem;
      border:1px solid #444;
      background:#1a1a1a;
      text-transform:uppercase;
    }
    .status-REQUESTED { border-color:#888; color:#ddd; }
    .status-ACCEPTED  { border-color:#4CAF50; color:#8bc34a; }
    .status-ENROUTE   { border-color:#03a9f4; color:#4fc3f7; }
    .status-ARRIVED   { border-color:#ffeb3b; color:#fff176; }
    .status-COMPLETED { border-color:#9e9e9e; color:#e0e0e0; }
    .status-CANCELLED { border-color:#f44336; color:#ef9a9a; }

    .ride-actions {
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:10px;
    }
    .ride-actions .btn {
      flex:1 1 120px;
      padding:8px 10px;
      font-size:0.85rem;
    }
    .btn-cancel {
      background:#660000;
      border:1px solid #b71c1c;
    }
    .btn-view {
      background:linear-gradient(180deg,#333,#111);
      border:1px solid #444;
    }
    .btn-rerequest {
      background:linear-gradient(180deg,#a30000,#7a0000);
      border:1px solid #ff1a1a;
    }

    #mapWrap {
      margin-top:12px;
      margin-bottom:10px;
      display:none;
    }
    #activeMap {
      width:100%;
      height:220px;
      border-radius:10px;
      border:2px solid #b30000;
    }
    #mapNote {
      font-size:0.8rem;
      color:#bbb;
      margin-top:4px;
      text-align:center;
    }

    .info-banner {
      background:#111;
      border-radius:8px;
      border:1px solid #222;
      padding:8px 10px;
      font-size:0.85rem;
      color:#ccc;
      margin-bottom:10px;
    }
    .info-banner strong {
      color:#ff4c4c;
    }

    #toast {
      position:fixed;
      bottom:20px;
      left:50%;
      transform:translateX(-50%);
      background:#111;
      border:1px solid #b30000;
      padding:8px 16px;
      border-radius:999px;
      font-size:0.9rem;
      opacity:0;
      transition:opacity .25s;
      z-index:50;
    }
    #toast.show {
      opacity:1;
    }

    footer {
      text-align:center;
      font-size:0.8rem;
      color:#777;
      margin:16px 0 20px;
    }
    footer a { color:#ff4c4c; text-decoration:none; }
    footer a:hover { text-decoration:underline; }

    @media (max-width:600px) {
      .ride-row {
        flex-direction:column;
      }
      .ride-actions .btn {
        flex:1 1 100%;
      }
      #activeMap {
        height:200px;
      }
    }
  </style>
</head>
<body>

<header>
  <div class="left">
    <img src="/icon.PNG" alt="Big Red Connect Logo">
    <div class="title-text">
      <div>My Rides</div>
      <div style="color:#888;">Track and review your connections</div>
    </div>
  </div>
  <div class="home-link">
    <a href="/rider/rider.html">üè† Rider Hub</a>
  </div>
</header>

<main>
  <h1>Your Ride History</h1>
  <p class="tagline">
    View your active ride, recent trips, and request repeat connections with Big Red.
  </p>

  <div id="profileBanner" class="info-banner" style="display:none;"></div>

  <div id="mapWrap">
    <div id="activeMap"></div>
    <div id="mapNote">Live driver location shown for active rides when Big Red is en route.</div>
  </div>

  <div id="activeSection">
    <div class="section-label">Active Ride</div>
    <div id="activeList"></div>
  </div>

  <div id="recentSection">
    <div class="section-label">Recent Rides</div>
    <div id="recentList"></div>
  </div>
</main>

<footer>
  <p>Need help? Text <strong>"RED"</strong> to (405) 378-4024.</p>
  <p><a href="/index.html">Main Site</a></p>
  <p>&copy; 2025 Big Red Connect ‚Äî Local. Affordable Flat Rates. Trusted.</p>
</footer>

<div id="toast"></div>

<script>
  const API_BOOK = "https://bigred-bookings.bigredtransportation.workers.dev";
  const LOCATION_API = "https://location-reader.bigredtransportation.workers.dev";
  const ACTIVE_STATUSES = ["REQUESTED","ACCEPTED","ENROUTE","ARRIVED"];
  const RECENT_STATUSES = ["COMPLETED","CANCELLED"];

  let mapInstance = null;
  let driverMarker = null;
  let lastActiveRideId = null;

  function normalizePhoneLocal(p) {
    if (!p) return "";
    const digits = p.toString().replace(/\D/g, "");
    if (digits.length === 10) return "+1" + digits;
    if (digits.length === 11 && digits.startsWith("1")) return "+" + digits;
    return "+" + digits;
  }

  function showToast(msg) {
    const t = document.getElementById("toast");
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(() => t.classList.remove("show"), 1800);
  }

  function loadProfile() {
    let profile = null;
    try {
      const raw = localStorage.getItem("bigred_rider_profile_v1");
      if (raw) profile = JSON.parse(raw);
    } catch {
      profile = null;
    }

    let name = profile?.name || "";
    let phoneRaw = profile?.phone || "";
    let normalized = localStorage.getItem("bigred_rider_id_normalized") || "";

    if (!normalized && phoneRaw) {
      normalized = normalizePhoneLocal(phoneRaw);
      localStorage.setItem("bigred_rider_id_normalized", normalized);
    }

    return { name, phoneRaw, normalizedPhone: normalized };
  }

  function renderProfileBanner(profile) {
    const banner = document.getElementById("profileBanner");
    if (!profile.normalizedPhone) {
      banner.style.display = "block";
      banner.innerHTML = `
        <strong>No rider profile found.</strong><br>
        Save your name and mobile number first so your rides can be linked correctly.
        <br><br>
        <a href="/rider/rider.html" style="color:#ff6666;text-decoration:none;">Go to Rider Hub ‚Üí</a>
      `;
      return;
    }

    const labelName = profile.name || "Rider";
    banner.style.display = "block";
    banner.innerHTML = `
      Profile loaded for <strong>${labelName}</strong> (${profile.phoneRaw || profile.normalizedPhone}).
      <br>
      <a href="/rider/rider.html" style="color:#ff6666;text-decoration:none;">Edit profile ‚Üí</a>
    `;
  }

  async function fetchAllBookings() {
    const res = await fetch(API_BOOK + "/api/driver/bookings?scope=all", { cache: "no-store" });
    if (!res.ok) throw new Error("Booking fetch failed");
    return await res.json();
  }

  function formatWhen(booking) {
    if (booking.scheduledFor) {
      const dt = new Date(booking.scheduledFor);
      if (!isNaN(dt)) {
        return "Scheduled ¬∑ " + dt.toLocaleString(undefined, {
          month: "short",
          day: "numeric",
          hour: "numeric",
          minute: "2-digit"
        });
      }
      return "Scheduled";
    }
    const created = booking.createdAt ? new Date(booking.createdAt) : null;
    if (created && !isNaN(created)) {
      return "Requested ¬∑ " + created.toLocaleString(undefined, {
        month: "short",
        day: "numeric",
        hour: "numeric",
        minute: "2-digit"
      });
    }
    return "Requested";
  }

  function buildRideCard(booking, isActiveSection) {
    const pickup = booking.pickup?.address || "Unknown pickup";
    const dropoff = booking.dropoff?.address || "Unknown drop-off";
    const stops = Array.isArray(booking.stops) ? booking.stops : [];
    const estimate = booking.pricing?.estimate;
    const status = booking.status || "REQUESTED";
    const rider = booking.rider || {};
    const partySize = rider.partySize || 1;
    const luggage = booking.metrics?.luggage || null;

    const statusClass = "status-" + status.toUpperCase();
    const whenText = formatWhen(booking);

    const canCancel = isActiveSection && (status === "REQUESTED" || status === "ACCEPTED");
    const canShowMap = isActiveSection && (status === "ENROUTE" || status === "ARRIVED");
    const canReRequest = !isActiveSection && RECENT_STATUSES.includes(status);

    const estimateHtml = (typeof estimate === "number")
      ? `$${estimate.toFixed(2)}`
      : "--";

    let extrasLine = `Party: ${partySize}`;
    if (luggage !== null && luggage !== undefined) {
      extrasLine += ` ¬∑ Luggage: ${luggage}`;
    }

    return `
      <div class="ride-card" data-ride-id="${booking.id}">
        <div class="ride-row">
          <div style="flex:1;">
            <div class="ride-label">From</div>
            <div class="ride-value">${pickup}</div>
          </div>
        </div>

        ${stops.length ? `
        <div class="ride-row">
          <div style="flex:1;">
            <div class="ride-label">Stops</div>
            <div class="ride-value">${stops.map(s => s.address || "").join(" ‚Üí ")}</div>
          </div>
        </div>
        ` : ""}

        <div class="ride-row">
          <div style="flex:1;">
            <div class="ride-label">To</div>
            <div class="ride-value">${dropoff}</div>
          </div>
        </div>

        <div class="ride-row">
          <div style="flex:1;">
            <div class="ride-label">Estimate</div>
            <div class="ride-value">${estimateHtml}</div>
          </div>
          <div style="flex:1; text-align:right;">
            <div class="ride-label">When</div>
            <div class="ride-value">${whenText}</div>
          </div>
        </div>

        <div class="ride-row">
          <div style="flex:1;">
            <div class="ride-label">Details</div>
            <div class="ride-value">${extrasLine}</div>
          </div>
        </div>

        <div class="ride-status-row">
          <span class="status-pill ${statusClass}">${status}</span>
          <a href="/rider/myride.html?id=${encodeURIComponent(booking.id)}" class="btn btn-view" style="padding:6px 10px;font-size:0.8rem;">
            View Details
          </a>
        </div>

        <div class="ride-actions">
          ${canCancel ? `
            <button class="btn btn-cancel btn-cancel-ride" data-id="${booking.id}">‚ùå Cancel Ride</button>
          ` : ""}

          ${canShowMap ? `
            <button class="btn btn-view btn-focus-map" data-id="${booking.id}">üó∫Ô∏è Show Live Map</button>
          ` : ""}

          ${canReRequest ? `
            <button class="btn btn-rerequest btn-rerequest" data-pickup="${encodeURIComponent(pickup)}" data-dropoff="${encodeURIComponent(dropoff)}">
              üîÅ Request This Ride Again
            </button>
          ` : ""}
        </div>
      </div>
    `;
  }

  async function renderListsForProfile(profile, focusId, isAutoRefresh) {
    const profileBannerShown = !!profile.normalizedPhone;
    renderProfileBanner(profile);

    let all;
    try {
      all = await fetchAllBookings();
    } catch {
      const activeList = document.getElementById("activeList");
      const recentList = document.getElementById("recentList");
      activeList.innerHTML = "<div class='rides-empty'>Unable to load rides.</div>";
      recentList.innerHTML = "";
      return;
    }

    const phoneFilter = profile.normalizedPhone || "";
    let myRides = all;

    if (phoneFilter) {
      myRides = all.filter(b => normalizePhoneLocal(b.rider?.phone || "") === phoneFilter);
    }

    let focusRide = null;
    if (focusId) {
      focusRide = myRides.find(b => b.id === focusId) || all.find(b => b.id === focusId) || null;
    }

    const active = myRides.filter(b => ACTIVE_STATUSES.includes(b.status));
    const recent = myRides
      .filter(b => RECENT_STATUSES.includes(b.status))
      .sort((a, b) => {
        const aKey = (a.updatedAt || a.createdAt || "");
        const bKey = (b.updatedAt || b.createdAt || "");
        return bKey.localeCompare(aKey);
      })
      .slice(0, 10);

    const activeList = document.getElementById("activeList");
    const recentList = document.getElementById("recentList");

    if (!active.length && !focusRide) {
      activeList.innerHTML = "<div class='rides-empty'>No active rides right now.</div>";
    } else {
      let cardsHtml = "";
      const activeSource = focusRide && ACTIVE_STATUSES.includes(focusRide.status)
        ? [focusRide]
        : active;

      if (!activeSource.length) {
        activeList.innerHTML = "<div class='rides-empty'>No active rides right now.</div>";
      } else {
        activeSource.forEach(b => {
          cardsHtml += buildRideCard(b, true);
        });
        activeList.innerHTML = cardsHtml;
      }
    }

    if (!recent.length) {
      recentList.innerHTML = "<div class='rides-empty'>No recent rides to show yet.</div>";
    } else {
      let recentHtml = "";
      recent.forEach(b => {
        recentHtml += buildRideCard(b, false);
      });
      recentList.innerHTML = recentHtml;
    }

    wireButtons();

    const primaryActive = focusRide && ACTIVE_STATUSES.includes(focusRide.status)
      ? focusRide
      : active[0] || null;

    await renderLiveMap(primaryActive);
  }

  function wireButtons() {
    const cancelButtons = document.querySelectorAll(".btn-cancel-ride");
    cancelButtons.forEach(btn => {
      btn.onclick = async () => {
        const id = btn.dataset.id;
        if (!id) return;
        if (!confirm("Cancel this ride?")) return;

        try {
          const res = await fetch(API_BOOK + "/api/driver/bookings/" + encodeURIComponent(id), {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ status: "CANCELLED" })
          });
          if (res.ok) {
            showToast("Ride cancelled.");
            const profile = loadProfile();
            const focusId = new URL(window.location.href).searchParams.get("id") || null;
            await renderListsForProfile(profile, focusId, false);
          } else {
            showToast("Cancel failed.");
          }
        } catch {
          showToast("Cancel failed.");
        }
      };
    });

    const reButtons = document.querySelectorAll(".btn-rerequest");
    reButtons.forEach(btn => {
      btn.onclick = () => {
        const pickup = decodeURIComponent(btn.dataset.pickup || "");
        const dropoff = decodeURIComponent(btn.dataset.dropoff || "");
        const bodyLines = [
          "Hey Big Red ‚Äî I‚Äôd like to request this same ride again.",
          pickup ? "From: " + pickup : "",
          dropoff ? "To: " + dropoff : ""
        ].filter(Boolean);
        const body = encodeURIComponent(bodyLines.join(" "));
        window.location.href = "sms:+14053784024?&body=" + body;
      };
    });

    const mapButtons = document.querySelectorAll(".btn-focus-map");
    mapButtons.forEach(btn => {
      btn.onclick = async () => {
        const id = btn.dataset.id;
        if (!id) return;
        const profile = loadProfile();
        await renderListsForProfile(profile, id, false);
      };
    });
  }

  async function renderLiveMap(activeRide) {
    const wrap = document.getElementById("mapWrap");
    const mapEl = document.getElementById("activeMap");

    if (!activeRide || !(activeRide.status === "ENROUTE" || activeRide.status === "ARRIVED")) {
      wrap.style.display = "none";
      return;
    }

    wrap.style.display = "block";
    lastActiveRideId = activeRide.id;

    let driverLoc = null;
    try {
      const res = await fetch(LOCATION_API + "?n=" + Date.now(), { cache: "no-store" });
      if (res.ok) {
        const j = await res.json();
        const lat = parseFloat(j.latitude);
        const lng = parseFloat(j.longitude);
        if (!isNaN(lat) && !isNaN(lng)) {
          driverLoc = { lat, lng };
        }
      }
    } catch {
      driverLoc = null;
    }

    if (!driverLoc) {
      mapEl.innerHTML = "";
      return;
    }

    if (!mapInstance) {
      mapInstance = new google.maps.Map(mapEl, {
        center: driverLoc,
        zoom: 13,
        disableDefaultUI: true,
        gestureHandling: "greedy"
      });
    } else {
      mapInstance.setCenter(driverLoc);
    }

    if (!driverMarker) {
      driverMarker = new google.maps.Marker({
        map: mapInstance,
        position: driverLoc,
        label: "üöó"
      });
    } else {
      driverMarker.setPosition(driverLoc);
    }
  }

  document.addEventListener("DOMContentLoaded", async () => {
    const profile = loadProfile();
    const focusId = new URL(window.location.href).searchParams.get("id") || null;

    await renderListsForProfile(profile, focusId, false);

    setInterval(async () => {
      const freshProfile = loadProfile();
      await renderListsForProfile(freshProfile, focusId, true);
    }, 30000);
  });
</script>

</body>
</html>