<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>My Ride â€“ Big Red Connect</title>

  <!-- PWA + Icons -->
  <link rel="apple-touch-icon" href="/icon.PNG">
  <link rel="icon" type="image/png" sizes="192x192" href="/icon.PNG">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#000"/>

  <style>
    body {
      margin:0;
      background:#000;
      color:#fff;
      font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      padding-bottom:50px;
    }

    /* HEADER + MENU */
    header {
      background:#000;
      padding:12px;
      border-bottom:2px solid #b30000;
      display:flex;
      justify-content:space-between;
      align-items:center;
      position:sticky;
      top:0;
      z-index:50;
    }
    .header-left {
      display:flex;
      align-items:center;
      gap:10px;
    }
    .logo {
      height:42px;
    }
    #menuBtn {
      font-size:1.6rem;
      background:none;
      border:none;
      color:white;
      cursor:pointer;
    }
    #menuPanel {
      display:none;
      flex-direction:column;
      background:#111;
      border-bottom:2px solid #b30000;
      animation:drop .15s ease-out;
    }
    #menuPanel a {
      padding:16px;
      color:#fff;
      text-decoration:none;
      border-bottom:1px solid #222;
      font-size:1rem;
    }
    #menuPanel a:hover { background:#222; }

    @keyframes drop {
      from { opacity:0; transform:translateY(-10px); }
      to   { opacity:1; transform:translateY(0); }
    }

    h1 {
      text-align:center;
      font-size:1.4rem;
      margin:18px 0;
      font-weight:700;
    }

    .section-title {
      font-size:1rem;
      font-weight:700;
      margin:10px 0 6px;
      padding:0 12px;
    }

    .card {
      background:#111;
      border:1px solid #333;
      border-radius:10px;
      padding:14px;
      margin:0 12px 14px;
    }

    .status {
      font-size:.88rem;
      margin-bottom:4px;
      color:#ccc;
    }

    .loc-line {
      margin:6px 0;
      font-size:.9rem;
    }

    .vehicle-thumb {
      width:80px;
      border-radius:10px;
      margin-top:10px;
      border:1px solid #333;
      display:block;
    }

    .btn-primary, .btn-ghost {
      display:block;
      width:calc(100% - 24px);
      margin:12px auto;
      padding:15px;
      text-align:center;
      border-radius:10px;
      text-decoration:none;
      font-weight:700;
      font-size:1.05rem;
    }
    .btn-primary {
      background:#b30000;
      color:#fff;
    }
    .btn-ghost {
      background:#111;
      color:#fff;
      border:1px solid #333;
    }

    #map {
      width:calc(100% - 24px);
      height:300px;
      margin:12px auto;
      border-radius:12px;
      border:1px solid #333;
      display:none;
    }

    /* ETA panel */
    #etaPanel {
      display:none;
    }
    #etaLine {
      font-weight:600;
      margin-bottom:4px;
    }
    #distLine, #updatedLine {
      font-size:.85rem;
      color:#aaa;
      margin:2px 0;
    }

    #toast {
      position:fixed;
      bottom:22px;
      left:50%;
      transform:translateX(-50%);
      background:#111;
      border:1px solid #b30000;
      padding:10px 18px;
      border-radius:999px;
      opacity:0;
      transition:.25s;
      z-index:999;
    }
    #toast.show { opacity:1; }
  </style>

  <!-- Google Maps JS API (standard blue route style) -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCMM0dxLNM7XQI5G3OBSnINeO5hcS3Ks5I&libraries=geometry"></script>
</head>

<body>

<!-- HEADER -->
<header>
  <div class="header-left">
    <a href="/index.html"><img src="/icon.PNG" class="logo"></a>
    <div style="font-weight:700;font-size:1rem;">My Ride</div>
  </div>
  <button id="menuBtn">â˜°</button>
</header>

<!-- MENU -->
<nav id="menuPanel">
  <a href="/rider/rider.html">Rider Hub</a>
  <a href="/rider/ride-request.html">Request a Ride</a>
  <a href="/rider/myride.html">My Ride</a>
  <a href="/rider/profile.html">Profile</a>
  <a href="#" id="logoutBtn">Log Out</a>
</nav>

<h1>Your Ride</h1>

<!-- ACTIVE RIDE -->
<div id="activeContainer"></div>

<!-- LIVE MAP -->
<div id="map"></div>

<!-- ETA PANEL -->
<div id="etaPanel" class="card">
  <div id="etaLine"></div>
  <div id="distLine"></div>
  <div id="updatedLine"></div>
</div>

<!-- PAST RIDES -->
<h2 class="section-title">Past Rides</h2>
<div id="pastContainer"></div>

<a href="/rider/ride-request.html" class="btn-primary">Request Another Ride</a>
<a href="/rider/rider.html" class="btn-ghost">Back to Rider Hub</a>

<div id="toast"></div>

<script>
const API_BOOKINGS    = "https://bigred-bookings.bigredtransportation.workers.dev";
const LOCATION_READER = "https://update-location.bigredtransportation.workers.dev";

let map, directionsService, directionsRenderer;
let pickupLatLng = null;
let driverPos = null;
let driverMarker = null;
let pickupMarker = null;
let activeRide = null;
let pollTimer = null;

/* MENU */
document.getElementById("menuBtn").addEventListener("click", () => {
  const p = document.getElementById("menuPanel");
  p.style.display = (p.style.display === "flex" ? "none" : "flex");
});
document.getElementById("logoutBtn").addEventListener("click", () => {
  localStorage.clear();
  window.location.href = "/index.html";
});

function showToast(msg){
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.classList.add("show");
  setTimeout(() => t.classList.remove("show"), 1900);
}

/* LOAD RIDES FOR THIS RIDER */
async function loadRides(){
  const riderId = localStorage.getItem("riderId");
  if (!riderId) {
    document.getElementById("activeContainer").innerHTML =
      `<div class="card">No rider profile found. Please update your profile and request a ride.</div>`;
    document.getElementById("map").style.display = "none";
    document.getElementById("etaPanel").style.display = "none";
    return;
  }

  try {
    const res = await fetch(`${API_BOOKINGS}/api/driver/bookings?scope=all`);
    if (!res.ok) throw new Error("HTTP " + res.status);
    const all = await res.json();

    const myRides = all.filter(r => r.rider && r.rider.riderId === riderId);

    const active = myRides.find(r =>
      ["REQUESTED", "ACCEPTED", "ENROUTE", "ARRIVED"].includes(r.status)
    );
    const done = myRides.filter(r =>
      ["COMPLETED", "CANCELLED"].includes(r.status)
    );

    renderActive(active);
    renderPast(done.reverse());
  } catch (e) {
    console.error(e);
    showToast("Could not load rides");
  }
}

/* RENDER ACTIVE RIDE CARD + INIT MAP/ETA */
function renderActive(ride){
  const box = document.getElementById("activeContainer");

  if (!ride) {
    box.innerHTML = `<div class="card">You have no active rides.</div>`;
    document.getElementById("map").style.display = "none";
    document.getElementById("etaPanel").style.display = "none";
    activeRide = null;
    if (pollTimer) clearInterval(pollTimer);
    return;
  }

  activeRide = ride;

  box.innerHTML = `
    <div class="card">
      <div class="status">Status: ${ride.status}</div>
      <div class="loc-line">Pickup: ${ride.pickup.address}</div>
      <div class="loc-line">Dropoff: ${ride.dropoff.address}</div>
      ${ride.vehicle && ride.vehicle.image ? `
        <img class="vehicle-thumb" src="${ride.vehicle.image}" alt="Vehicle"/>
      ` : ""}
    </div>
  `;

  initMapAndEta(ride);
}

/* RENDER PAST RIDES */
function renderPast(list){
  const box = document.getElementById("pastContainer");
  box.innerHTML = "";

  if (!list.length) {
    box.innerHTML = `<div class="card">No past rides yet.</div>`;
    return;
  }

  list.forEach(r => {
    const created = r.createdAt ? new Date(r.createdAt) : null;
    const whenStr = created
      ? created.toLocaleString("en-US", { month:"short", day:"numeric", hour:"numeric", minute:"2-digit" })
      : "";

    box.innerHTML += `
      <div class="card">
        <div class="status">${r.status}${whenStr ? " Â· " + whenStr : ""}</div>
        <div class="loc-line">From: ${r.pickup.address}</div>
        <div class="loc-line">To: ${r.dropoff.address}</div>
      </div>
    `;
  });
}

/* INIT MAP + DIRECTIONS FOR THIS RIDE (driver â†’ pickup) */
function initMapAndEta(ride){
  const mapEl = document.getElementById("map");
  mapEl.style.display = "block";

  // Create map & services if first time
  if (!map) {
    map = new google.maps.Map(mapEl, {
      zoom: 11,
      center: { lat:35.4676, lng:-97.5164 } // OKC baseline
    });
    directionsService = new google.maps.DirectionsService();
    directionsRenderer = new google.maps.DirectionsRenderer({
      suppressMarkers: true   // Use our own markers; route stays standard Google blue
    });
    directionsRenderer.setMap(map);
  }

  const geocoder = new google.maps.Geocoder();
  geocoder.geocode({ address: ride.pickup.address }, (results, status) => {
    if (status === "OK" && results[0]?.geometry?.location) {
      pickupLatLng = results[0].geometry.location;

      if (pickupMarker) pickupMarker.setMap(null);
      pickupMarker = new google.maps.Marker({
        map,
        position: pickupLatLng,
        label: "ðŸ“"
      });

      // Once we know pickup, fetch driver location & draw route
      refreshDriverAndRoute();
      if (pollTimer) clearInterval(pollTimer);
      pollTimer = setInterval(refreshDriverAndRoute, 30000);
    } else {
      console.warn("Geocode failed:", status);
    }
  });
}

/* GET DRIVER LOCATION FROM UPDATE-LOCATION WORKER */
async function fetchDriverLocation(){
  try {
    const res = await fetch(LOCATION_READER + "?nocache=" + Date.now(), { cache:"no-store" });
    if (!res.ok) return null;
    const data = await res.json();

    const lat = parseFloat(data.latitude);
    const lng = parseFloat(data.longitude);
    if (Number.isNaN(lat) || Number.isNaN(lng)) return null;

    return { lat, lng };
  } catch (e) {
    console.warn("Driver location fetch failed:", e);
    return null;
  }
}

/* REFRESH DRIVER POSITION AND REDRAW ROUTE/ETA */
async function refreshDriverAndRoute(){
  if (!pickupLatLng || !activeRide) return;

  const pos = await fetchDriverLocation();
  if (!pos) return;

  driverPos = pos;

  // Update or create driver marker
  if (!driverMarker) {
    driverMarker = new google.maps.Marker({
      map,
      position: driverPos,
      label: "ðŸš—"
    });
  } else {
    driverMarker.setPosition(driverPos);
  }

  drawRouteAndEta();
}

/* DRAW GOOGLE ROUTE + UPDATE ETA/DISTANCE */
function drawRouteAndEta(){
  if (!driverPos || !pickupLatLng || !directionsService || !directionsRenderer) return;

  const req = {
    origin: driverPos,
    destination: pickupLatLng,
    travelMode: "DRIVING"
  };

  directionsService.route(req, (result, status) => {
    if (status !== "OK" || !result?.routes?.length) {
      console.warn("Directions failed:", status);
      return;
    }

    directionsRenderer.setDirections(result);

    const leg = result.routes[0].legs[0];
    const distMiles = leg.distance?.value ? (leg.distance.value / 1609.34) : null;
    const durMins = leg.duration?.value ? Math.round(leg.duration.value / 60) : null;

    const etaLine = document.getElementById("etaLine");
    const distLine = document.getElementById("distLine");
    const updatedLine = document.getElementById("updatedLine");
    const etaPanel = document.getElementById("etaPanel");

    if (durMins != null) {
      etaLine.textContent = `ETA â‰ˆ ${durMins} min`;
    } else {
      etaLine.textContent = "ETA unavailable";
    }

    if (distMiles != null) {
      distLine.textContent = `Distance â‰ˆ ${distMiles.toFixed(1)} miles`;
    } else {
      distLine.textContent = "";
    }

    updatedLine.textContent =
      "Updated at " +
      new Date().toLocaleTimeString("en-US", { hour:"numeric", minute:"2-digit" }) +
      " CT";

    etaPanel.style.display = "block";

    // Fit map to show both driver and pickup
    const bounds = new google.maps.LatLngBounds();
    bounds.extend(new google.maps.LatLng(driverPos.lat, driverPos.lng));
    bounds.extend(pickupLatLng);
    map.fitBounds(bounds);
  });
}

/* KICK OFF */
loadRides();
</script>

</body>
</html>