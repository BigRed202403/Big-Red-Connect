<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>My Ride ‚Äì Big Red Connect</title>

<!-- PWA Icons -->
<link rel="apple-touch-icon" href="icon.png">
<link rel="icon" type="image/png" sizes="192x192" href="icon.png">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#000000">

<!-- Disable cache -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />

<!-- OneSignal -->
<script src="https://cdn.onesignal.com/sdks/OneSignalSDK.js" async></script>

<style>
  body {
    margin:0;
    background:#000;
    color:#fff;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    padding-bottom:40px;
  }

  header {
    padding:10px;
    border-bottom:2px solid #b30000;
    display:flex;
    align-items:center;
    gap:10px;
    background:#000;
    position:sticky;
    top:0;
  }

  header img {
    height:45px;
  }

  h1 {
    font-size:1.4rem;
    margin:12px;
    text-align:center;
  }

  .ride-box {
    background:#111;
    border:1px solid #222;
    border-radius:10px;
    margin:12px;
    padding:14px;
    font-size:.9rem;
  }

  .label {
    font-size:.75rem;
    color:#aaa;
    margin-top:10px;
  }

  .value {
    font-size:.9rem;
    margin-top:2px;
  }

  .status-pill {
    display:inline-block;
    padding:6px 10px;
    border-radius:999px;
    background:#222;
    font-size:.8rem;
    border:1px solid #444;
    margin-top:6px;
  }

  #btnCancel, #btnRefresh, #btnNotify {
    margin:10px 12px;
    padding:10px 14px;
    border-radius:8px;
    border:none;
    font-weight:600;
    width:calc(100% - 24px);
    cursor:pointer;
  }

  #btnCancel { background:#660000; color:#fff; }
  #btnRefresh { background:#111; color:#fff; border:1px solid #333; }
  #btnNotify { background:#111; color:#fff; border:1px solid #444; }

  #toast {
    position:fixed;
    bottom:20px;
    left:50%;
    transform:translateX(-50%);
    background:#111;
    border:1px solid #b30000;
    padding:10px 16px;
    border-radius:999px;
    opacity:0;
    transition:.25s;
    z-index:50;
  }
  #toast.show { opacity:1; }

</style>
</head>

<body>

<header>
  <img src="official_logo_Nov.png">
  <div style="font-size:.9rem;">
    <div style="font-weight:700;">My Ride</div>
    <div style="color:#888;">Live Status</div>
  </div>
</header>

<h1>Your Ride Details</h1>

<div id="rideBox" class="ride-box">Loading‚Ä¶</div>

<button id="btnRefresh">üîÑ Refresh</button>
<button id="btnNotify">üîî Alerts: Off</button>
<button id="btnCancel">‚ùå Cancel Ride</button>

<div id="toast"></div>

<script>
/* ======================================================
    CONFIG
====================================================== */
const API = "https://bigred-bookings.bigredtransportation.workers.dev";
const rideId = new URL(location.href).searchParams.get("id");
const rideBox = document.getElementById("rideBox");

/* ======================================================
    ONE SIGNAL ‚Äî RIDER LOGIN
====================================================== */
window.OneSignal = window.OneSignal || [];
OneSignal.push(function() {
  OneSignal.init({
    appId:"64641a89-3619-4491-a25b-c0ab000bdfe0",
    allowLocalhostAsSecureOrigin:true,
    notifyButton:{ enable:false }
  });

  if (rideId) {
    OneSignal.login("ride-" + rideId);
  }

  OneSignal.getNotificationPermission().then(p => {
    updateNotifyBtn(p === "granted");
  });
});

function updateNotifyBtn(enabled){
  document.getElementById("btnNotify").textContent =
    enabled ? "üîî Alerts: On" : "üîî Alerts: Off";
}

document.getElementById("btnNotify").addEventListener("click", async()=>{
  const perm = await OneSignal.getNotificationPermission();
  if (perm === "granted") {
    showToast("Alerts already enabled.");
    updateNotifyBtn(true);
    return;
  }

  const result = await OneSignal.Notifications.requestPermission();
  if (result === "granted") {
    updateNotifyBtn(true);
    showToast("Alerts enabled!");
  } else {
    updateNotifyBtn(false);
    showToast("Permission blocked.");
  }
});

/* ======================================================
    TOAST
====================================================== */
function showToast(msg){
  const t=document.getElementById("toast");
  t.textContent=msg;
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"),1800);
}

/* ======================================================
    FETCH BOOKING
====================================================== */
async function loadRide(){
  if(!rideId){
    rideBox.innerHTML = "<div style='text-align:center;'>Invalid link.</div>";
    return;
  }

  try{
    const res = await fetch(`${API}/api/driver/bookings/${rideId}`);
    if(!res.ok){
      rideBox.innerHTML = "<div style='text-align:center;'>Ride not found.</div>";
      return;
    }

    const b = await res.json();
    renderRide(b);

  } catch(e){
    rideBox.innerHTML = "<div style='text-align:center;'>Error loading ride.</div>";
  }
}

function renderRide(b){
  rideBox.innerHTML = `
    <div class="label">FROM</div>
    <div class="value">${b.pickup.address}</div>

    ${b.stops.length ? `
      <div class="label">STOPS</div>
      <div class="value">${b.stops.map(s=>s.address).join(" ‚Üí ")}</div>
    ` : ""}

    <div class="label">TO</div>
    <div class="value">${b.dropoff.address}</div>

    <div class="label">Estimate</div>
    <div class="value">$${b.pricing.estimate?.toFixed(2) || "--"}</div>

    <div class="label">Driver Status</div>
    <div class="status-pill">${b.status}</div>
  `;
}

/* ======================================================
    CANCEL RIDE
====================================================== */
document.getElementById("btnCancel").addEventListener("click", async()=>{
  if(!confirm("Cancel this ride?")) return;

  const res = await fetch(`${API}/api/driver/bookings/${rideId}`, {
    method:"PUT",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ status:"CANCELLED" })
  });

  if(res.ok){
    showToast("Ride Cancelled");
    loadRide();
  } else {
    showToast("Cancel failed.");
  }
});

/* ======================================================
    REFRESH BUTTON
====================================================== */
document.getElementById("btnRefresh").addEventListener("click", loadRide);

/* ======================================================
    AUTO LOAD
====================================================== */
loadRide();
setInterval(loadRide, 15000); // Background auto refresh
</script>

</body>
</html>
