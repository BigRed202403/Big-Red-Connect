<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>My Rides ‚Äì Big Red Connect</title>

  <!-- PWA Icons -->
  <link rel="apple-touch-icon" href="/icon.PNG">
  <link rel="icon" type="image/png" sizes="192x192" href="/icon.PNG">
  <link rel="manifest" href="/manifest-rider.json">
  <meta name="theme-color" content="#000000">

  <!-- Disable cache -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <style>
    :root {
      --red:#b30000;
      --bg:#000;
      --panel:#111;
      --border:#222;
      --muted:#aaa;
    }
    * { box-sizing:border-box; }

    body {
      margin:0;
      background:var(--bg);
      color:#fff;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }

    header {
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 12px;
      border-bottom:2px solid var(--red);
      background:#000;
      position:sticky;
      top:0;
      z-index:10;
    }
    header img {
      height:36px;
      border-radius:4px;
    }
    .header-title {
      display:flex;
      flex-direction:column;
      margin-left:8px;
      font-size:.85rem;
    }
    .header-title strong {
      font-size:.95rem;
    }
    .header-right a {
      color:#fff;
      text-decoration:none;
      font-size:.8rem;
      border:1px solid var(--red);
      padding:6px 10px;
      border-radius:8px;
    }

    main {
      flex:1;
      padding:12px;
      max-width:480px;
      width:100%;
      margin:0 auto 20px;
    }

    h1 {
      font-size:1.4rem;
      margin:10px 0 6px;
      color:var(--red);
    }

    .tagline {
      font-size:.9rem;
      color:#ddd;
      margin-bottom:10px;
    }

    .card {
      background:var(--panel);
      border-radius:10px;
      border:1px solid var(--border);
      padding:12px 10px 14px;
      margin-bottom:12px;
      font-size:.9rem;
    }

    .card-header-row {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:6px;
      font-size:.8rem;
      color:#ccc;
    }

    .status-pill {
      display:inline-block;
      padding:5px 10px;
      border-radius:999px;
      border:1px solid #444;
      font-size:.75rem;
      background:#000;
      text-transform:uppercase;
    }

    .line-label {
      font-size:.75rem;
      color:#999;
      margin-top:6px;
    }
    .line-value {
      font-size:.9rem;
      margin-top:2px;
    }

    .eta-line {
      margin-top:6px;
      font-size:.8rem;
      color:#ccc;
    }

    .vehicle-row {
      display:flex;
      align-items:center;
      gap:8px;
      margin-top:8px;
      font-size:.8rem;
      color:#ccc;
    }
    .vehicle-thumb {
      width:52px;
      height:auto;
      border-radius:6px;
      border:1px solid #333;
    }

    .button-row {
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-top:10px;
    }
    .btn {
      display:block;
      width:100%;
      padding:10px 14px;
      border-radius:8px;
      border:none;
      font-weight:600;
      font-size:.9rem;
      background:var(--red);
      color:#fff;
      text-align:center;
      text-decoration:none;
      cursor:pointer;
    }
    .btn.secondary {
      background:#000;
      border:1px solid #444;
    }
    .btn.outline {
      background:#111;
      border:1px solid #333;
    }

    .map-wrapper {
      margin-top:10px;
      border-radius:10px;
      overflow:hidden;
      border:1px solid var(--border);
    }
    .map-wrapper iframe {
      width:100%;
      height:220px;
      border:none;
    }

    .subheading {
      margin:16px 0 6px;
      font-size:1rem;
      color:#eee;
    }

    .ride-list-card {
      margin-bottom:8px;
      padding:10px;
      border-radius:8px;
      border:1px solid #222;
      background:#050505;
      font-size:.85rem;
    }
    .ride-list-line {
      font-size:.8rem;
      color:#ccc;
    }
    .ride-list-line strong {
      color:#fff;
    }
    .ride-list-meta {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-top:4px;
      font-size:.75rem;
      color:#888;
    }
    .link-small {
      font-size:.75rem;
      color:#ff9999;
      text-decoration:none;
    }

    .empty {
      font-size:.85rem;
      color:#aaa;
      margin-top:6px;
    }

    footer {
      text-align:center;
      font-size:.8rem;
      color:#777;
      padding:8px 0 12px;
    }

    #toast {
      position:fixed;
      bottom:18px;
      left:50%;
      transform:translateX(-50%);
      background:#111;
      border:1px solid var(--red);
      padding:8px 14px;
      border-radius:999px;
      font-size:.8rem;
      opacity:0;
      pointer-events:none;
      transition:opacity .25s;
      z-index:50;
    }
    #toast.show { opacity:1; }
  </style>
</head>
<body>

<header>
  <div style="display:flex;align-items:center;">
    <img src="/icon.PNG" alt="Big Red Connect">
    <div class="header-title">
      <strong>My Rides</strong>
      <span>Track your Big Red connections</span>
    </div>
  </div>
  <div class="header-right">
    <a href="/rider/rider.html">‚Üê Rider Hub</a>
  </div>
</header>

<main>
  <h1>Active Ride</h1>
  <p class="tagline">Watch status, see your driver‚Äôs vehicle, and check the route.</p>

  <!-- Active / Focus Ride -->
  <section id="activeRideCard" class="card" style="display:none;"></section>

  <!-- Recent rides -->
  <h2 class="subheading">Recent Rides</h2>
  <section id="recentRides"></section>

</main>

<footer>
  ¬© 2025 Big Red Connect ‚Äî Veteran Owned. Affordable. Local. Trusted.
</footer>

<div id="toast"></div>

<script>
const API = "https://bigred-bookings.bigredtransportation.workers.dev";

const activeRideCard = document.getElementById("activeRideCard");
const recentRides    = document.getElementById("recentRides");
const toastEl        = document.getElementById("toast");

const url     = new URL(location.href);
const rideId  = url.searchParams.get("id") || null;

// Rider phone from profile (for history view)
let riderPhone = "";
try {
  const rawProfile = localStorage.getItem("bigred_rider_profile_v1");
  if (rawProfile) {
    const p = JSON.parse(rawProfile);
    if (p.phone) riderPhone = p.phone.trim();
  }
  if (!riderPhone) {
    const shortId = localStorage.getItem("bigred_rider_id");
    if (shortId) riderPhone = shortId.trim();
  }
} catch(e) {
  console.warn("Profile parse error", e);
}

function showToast(msg) {
  toastEl.textContent = msg;
  toastEl.classList.add("show");
  setTimeout(() => toastEl.classList.remove("show"), 1800);
}

/* =====================================================
   LOAD LOGIC
===================================================== */
async function loadMyRides() {
  recentRides.innerHTML = "";
  activeRideCard.style.display = "none";

  // Case 1: direct link with ?id= (focus a single ride)
  if (rideId) {
    try {
      const res = await fetch(`${API}/api/bookings?id=${encodeURIComponent(rideId)}`);
      if (!res.ok) {
        activeRideCard.innerHTML = "<p class='empty'>Ride not found.</p>";
        activeRideCard.style.display = "block";
        return;
      }
      const b = await res.json();
      renderActiveRide(b);
      // We won't attempt history lookup here if we don't know phone
    } catch (e) {
      console.error(e);
      activeRideCard.innerHTML = "<p class='empty'>Error loading ride.</p>";
      activeRideCard.style.display = "block";
    }
    return;
  }

  // Case 2: no id, use rider phone to show active + history
  if (!riderPhone) {
    activeRideCard.innerHTML =
      "<p class='empty'>No rider profile found. Please save your profile from the Rider Hub first.</p>";
    activeRideCard.style.display = "block";
    recentRides.innerHTML = "<p class='empty'>No history to show.</p>";
    return;
  }

  try {
    const res = await fetch(`${API}/api/bookings?riderPhone=${encodeURIComponent(riderPhone)}`);
    if (!res.ok) {
      activeRideCard.innerHTML = "<p class='empty'>No rides found for this number yet.</p>";
      activeRideCard.style.display = "block";
      recentRides.innerHTML = "<p class='empty'>No history to show.</p>";
      return;
    }

    const list = await res.json();
    if (!Array.isArray(list) || !list.length) {
      activeRideCard.innerHTML = "<p class='empty'>No rides found for this number yet.</p>";
      activeRideCard.style.display = "block";
      recentRides.innerHTML = "<p class='empty'>No history to show.</p>";
      return;
    }

    const activeStates = ["REQUESTED","ACCEPTED","ENROUTE","ARRIVED"];

    const activeRide = list.find(b => activeStates.includes(b.status));
    const rest       = list.filter(b => !activeStates.includes(b.status));

    if (activeRide) {
      renderActiveRide(activeRide);
    } else {
      activeRideCard.innerHTML = "<p class='empty'>No active ride right now.</p>";
      activeRideCard.style.display = "block";
    }

    renderRecentRides(rest);

  } catch (e) {
    console.error(e);
    activeRideCard.innerHTML = "<p class='empty'>Error loading rides.</p>";
    activeRideCard.style.display = "block";
    recentRides.innerHTML = "<p class='empty'>Unable to load history.</p>";
  }
}

/* =====================================================
   RENDER ACTIVE / FOCUS RIDE
===================================================== */
function renderActiveRide(b) {
  const isActive = ["REQUESTED","ACCEPTED","ENROUTE","ARRIVED"].includes(b.status);
  const status = b.status || "UNKNOWN";

  const etaMinutes = b.metrics?.minutes
    ? `${Math.round(b.metrics.minutes)} min`
    : null;

  const vehicleLabel =
    b.vehicle?.label ||
    (b.vehicle?.code === "BIG_RED" ? "Big Red (Red Silverado)" : "Black GMC Acadia (SUV)");

  const vehicleImg =
    b.vehicle?.image ||
    (b.vehicle?.code === "BIG_RED"
      ? "/Big Red Thumbnail.PNG"
      : "/Black Acadia Thumbnail.PNG");

  const showMap = ["ENROUTE","ARRIVED"].includes(status);
  const rideIdLocal = b.id;

  let html = `
    <div class="card-header-row">
      <span>${b.type || "Instant"} Ride</span>
      <span class="status-pill">${status}</span>
    </div>

    <div class="line-label">Pickup</div>
    <div class="line-value">${b.pickup?.address || "‚Äî"}</div>

    ${
      b.stops?.length
        ? `<div class="line-label">Stops</div><div class="line-value">${b.stops.map(s=>s.address).join(" ‚Üí ")}</div>`
        : ""
    }

    <div class="line-label">Dropoff</div>
    <div class="line-value">${b.dropoff?.address || "‚Äî"}</div>

    ${
      etaMinutes
        ? `<div class="eta-line">Estimated ride time (from fare calculator): ${etaMinutes}</div>`
        : ""
    }

    <div class="vehicle-row">
      <img src="${vehicleImg}" class="vehicle-thumb" alt="Assigned vehicle">
      <div>
        <div>Vehicle:</div>
        <div>${vehicleLabel}</div>
      </div>
    </div>

    <div class="button-row">
      <a href="sms:14053784024" class="btn">üì≤ Text Big Red</a>
      ${
        isActive
          ? `<a href="tel:14053784024" class="btn secondary">üìû Call Big Red</a>`
          : `<button class="btn secondary" onclick="reRequestRide('${rideIdLocal}')">üîÅ Request This Trip Again</button>`
      }
      <a href="https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(b.dropoff?.address || '')}&origin=${encodeURIComponent(b.pickup?.address || '')}&travelmode=driving"
         class="btn outline"
         target="_blank">
        üó∫Ô∏è Open Route in Maps
      </a>
    </div>
  `;

  if (showMap && rideIdLocal) {
    html += `
      <div class="map-wrapper">
        <iframe src="https://location-reader.bigredtransportation.workers.dev/?id=${rideIdLocal}" loading="lazy"></iframe>
      </div>
    `;
  }

  activeRideCard.innerHTML = html;
  activeRideCard.style.display = "block";
}

/* =====================================================
   RENDER RECENT RIDES
===================================================== */
function renderRecentRides(list) {
  if (!list || !list.length) {
    recentRides.innerHTML = "<p class='empty'>No completed or cancelled rides yet.</p>";
    return;
  }

  const limited = list.slice(0, 10); // last 10 rides

  recentRides.innerHTML = "";
  limited.forEach(b => {
    const created = b.createdAt
      ? new Date(b.createdAt).toLocaleString()
      : "Unknown time";

    const fare = b.pricing?.estimate
      ? `$${b.pricing.estimate.toFixed(2)}`
      : "--";

    const status = b.status || "UNKNOWN";

    const shortPickup  = (b.pickup?.address || "‚Äî").split(",")[0];
    const shortDropoff = (b.dropoff?.address || "‚Äî").split(",")[0];

    const etaMinutes = b.metrics?.minutes
      ? `${Math.round(b.metrics.minutes)} min`
      : null;

    const card = document.createElement("div");
    card.className = "ride-list-card";
    card.innerHTML = `
      <div class="ride-list-line">
        <strong>${shortPickup}</strong> ‚Üí <strong>${shortDropoff}</strong>
      </div>
      <div class="ride-list-meta">
        <span>${status} ‚Ä¢ ${created}</span>
        <span>Est: ${fare}</span>
      </div>
      ${
        etaMinutes
          ? `<div class="ride-list-line">Est. ride time: ${etaMinutes}</div>`
          : ""
      }
      <div style="margin-top:4px;">
        <a href="/rider/myride.html?id=${encodeURIComponent(b.id)}" class="link-small">
          View details / re-request ‚Üí
        </a>
      </div>
    `;
    recentRides.appendChild(card);
  });
}

/* =====================================================
   RE-REQUEST HANDLER (placeholder)
   - For now we just prompt them to text you,
   - later we can auto-populate a new ride-request.
===================================================== */
function reRequestRide(id) {
  showToast("To repeat this trip, text Big Red with your request.");
  // Future enhancement: hit a 'clone booking' endpoint or pre-fill ride request form.
}

/* =====================================================
   INIT
===================================================== */
loadMyRides();
</script>

</body>
</html>