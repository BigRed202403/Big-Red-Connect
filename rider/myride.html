<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My Ride ‚Äì Big Red Connect</title>

  <!-- PWA / Icons -->
  <link rel="apple-touch-icon" href="/icon.PNG">
  <link rel="icon" type="image/png" sizes="192x192" href="/icon.PNG">
  <link rel="shortcut icon" href="/icon.PNG">
  <link rel="manifest" href="/manifest-rider.json">
  <meta name="theme-color" content="#000000">

  <!-- Disable cache -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <!-- Global styles -->
  <link rel="stylesheet" href="/style.css" />

  <style>
    /* Page wrapper */
    body {
      margin: 0;
      background: #000;
      color: #fff;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      text-align: left;
    }

    /* Simple top bar to match rider app */
    header {
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 14px;
      border-bottom:2px solid #b30000;
      background:#000;
      position:sticky;
      top:0;
      z-index:10;
    }
    header .logo-wrap {
      display:flex;
      align-items:center;
      gap:8px;
    }
    header img {
      height:36px;
      border-radius:4px;
    }
    header .title-block {
      font-size:0.9rem;
    }
    header .title-block div:first-child {
      font-weight:700;
    }
    header .title-block div:last-child {
      color:#888;
      font-size:0.78rem;
    }
    header .back-link {
      text-decoration:none;
      color:#fff;
      font-size:0.8rem;
      padding:6px 10px;
      border-radius:8px;
      border:1px solid #b30000;
      background:#111;
    }

    main {
      max-width:700px;
      margin:0 auto;
      padding:14px 14px 24px;
    }

    h1 {
      font-size:1.4rem;
      margin:4px 0 4px;
      text-align:left;
      color:#ff1a1a;
    }
    .tagline {
      font-size:0.9rem;
      color:#ccc;
      margin:0 0 12px;
      text-align:left;
    }

    .section-title {
      margin-top:16px;
      margin-bottom:6px;
      font-size:1rem;
      font-weight:700;
      color:#ff4444;
    }

    .card {
      background:#111;
      border-radius:10px;
      border:1px solid #222;
      padding:12px 12px 14px;
      margin-bottom:10px;
      font-size:0.9rem;
    }

    .card-header-line {
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:6px;
      margin-bottom:4px;
      font-size:0.82rem;
      color:#aaa;
    }

    .card-loc {
      margin-top:4px;
      font-size:0.9rem;
    }
    .card-loc span.label {
      font-size:0.8rem;
      color:#888;
      text-transform:uppercase;
      letter-spacing:0.03em;
    }

    .card-meta {
      margin-top:6px;
      font-size:0.82rem;
      color:#ccc;
    }

    /* Status + vehicle inline (Layout C) */
    .status-row {
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      margin-top:8px;
    }

    .status-pill {
      display:inline-block;
      padding:4px 10px;
      border-radius:999px;
      font-size:0.78rem;
      border:1px solid #555;
      background:#000;
      text-transform:uppercase;
      letter-spacing:0.04em;
    }
    .status-pill.active {
      border-color:#4CAF50;
      color:#b6ffb6;
    }
    .status-pill.done {
      border-color:#777;
      color:#ddd;
    }
    .status-pill.warn {
      border-color:#ff9800;
      color:#ffe3b3;
    }

    .vehicle-inline {
      display:flex;
      align-items:center;
      gap:6px;
      font-size:0.8rem;
      color:#eee;
    }
    .vehicle-inline-thumb {
      width:32px;
      height:auto;
      border-radius:4px;
      border:1px solid #333;
    }
    .vehicle-inline span {
      white-space:nowrap;
    }

    @media (max-width:480px) {
      .status-row {
        flex-direction:column;
        align-items:flex-start;
      }
    }

    .card-actions {
      margin-top:10px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    .btn-full {
      display:block;
      width:100%;
      text-align:center;
      padding:10px 14px;
      border-radius:10px;
      border:none;
      font-weight:700;
      font-size:0.95rem;
      cursor:pointer;
    }
    .btn-primary {
      background:linear-gradient(180deg,#c40000,#9a0000);
      color:#fff;
      border:1px solid #c40000;
    }
    .btn-secondary {
      background:#000;
      color:#fff;
      border:1px solid #444;
    }

    .hint {
      font-size:0.8rem;
      color:#888;
      margin-top:4px;
    }

    .empty-block {
      font-size:0.85rem;
      color:#aaa;
      padding:10px 4px;
    }

    #toast {
      position:fixed;
      bottom:20px;
      left:50%;
      transform:translateX(-50%);
      background:#111;
      border:1px solid #b30000;
      padding:8px 14px;
      border-radius:999px;
      opacity:0;
      pointer-events:none;
      transition:opacity .25s;
      z-index:50;
      font-size:0.85rem;
    }
    #toast.show { opacity:1; }
  </style>
</head>
<body>

<header>
  <div class="logo-wrap">
    <img src="/icon.PNG" alt="Big Red Connect Logo" />
    <div class="title-block">
      <div>My Ride</div>
      <div>Live status & history</div>
    </div>
  </div>
  <a href="/rider/rider.html" class="back-link">‚¨Ö Rider Hub</a>
</header>

<main>
  <h1>Your Rides</h1>
  <p class="tagline">
    View your current ride, see recent trips, and re-request a route when needed.
  </p>

  <div id="profileInfo" class="hint"></div>

  <h2 class="section-title">Active Ride</h2>
  <div id="activeRide"></div>

  <h2 class="section-title">Recent Rides</h2>
  <div id="recentRides"></div>

  <div class="hint" id="deepLinkHint" style="margin-top:14px;"></div>

  <div class="card" style="margin-top:18px;">
    <div class="card-header-line">
      <span>Need a new connection?</span>
    </div>
    <div class="card-actions">
      <button class="btn-full btn-primary" id="btnNewRide">üìù Request a New Ride</button>
    </div>
  </div>
</main>

<div id="toast"></div>

<script>
  const API = "https://bigred-bookings.bigredtransportation.workers.dev";

  const activeRideEl   = document.getElementById("activeRide");
  const recentRidesEl  = document.getElementById("recentRides");
  const profileInfoEl  = document.getElementById("profileInfo");
  const deepLinkHintEl = document.getElementById("deepLinkHint");
  const toastEl        = document.getElementById("toast");

  const url = new URL(window.location.href);
  const paramId = url.searchParams.get("id");

  function showToast(msg) {
    toastEl.textContent = msg;
    toastEl.classList.add("show");
    setTimeout(() => toastEl.classList.remove("show"), 1900);
  }

  function getStoredProfile() {
    try {
      const raw = localStorage.getItem("bigred_rider_profile_v1");
      if (!raw) return null;
      const p = JSON.parse(raw);
      if (!p || typeof p !== "object") return null;
      return {
        name: p.name || "",
        phone: p.phone || "",
        home: p.home || ""
      };
    } catch (e) {
      return null;
    }
  }

  function formatStatusPillClass(status) {
    const s = (status || "").toUpperCase();
    if (["REQUESTED","ACCEPTED","ENROUTE","ARRIVED"].includes(s)) return "status-pill active";
    if (["COMPLETED","CANCELLED"].includes(s)) return "status-pill done";
    return "status-pill warn";
  }

  function formatStatusLabel(status) {
    return (status || "").toUpperCase() || "UNKNOWN";
  }

  function renderVehicleInline(vehicle) {
    if (!vehicle || (!vehicle.label && !vehicle.code)) {
      return `
        <div class="vehicle-inline">
          <span>Vehicle: Not yet assigned</span>
        </div>
      `;
    }
    const label = vehicle.label || vehicle.code || "Assigned Vehicle";
    const img   = vehicle.image || "/Black Acadia Thumbnail.PNG";
    return `
      <div class="vehicle-inline">
        <img src="${img}" class="vehicle-inline-thumb" alt="${label}">
        <span>${label}</span>
      </div>
    `;
  }

  function renderRideCard(booking, opts = {}) {
    const {
      showActions = false,
      allowRerequest = false
    } = opts;

    const statusClass = formatStatusPillClass(booking.status);
    const statusLabel = formatStatusLabel(booking.status);
    const vehicleHtml = renderVehicleInline(booking.vehicle);

    const estimate = booking.pricing?.estimate != null
      ? `$${booking.pricing.estimate.toFixed(2)}`
      : "--";

    const created = booking.createdAt ? new Date(booking.createdAt) : null;
    const timeStr = created
      ? `${created.toLocaleDateString()} ¬∑ ${created.toLocaleTimeString([], { hour:'2-digit', minute:'2-digit' })}`
      : "";

    const stopsLine = (booking.stops && booking.stops.length)
      ? `<div class="card-loc"><span class="label">STOPS</span><br>${booking.stops.map(s=>s.address).join(" ‚Üí ")}</div>`
      : "";

    return `
      <div class="card" data-id="${booking.id}">
        <div class="card-header-line">
          <span>${booking.type || "Ride"}</span>
          <span>${timeStr}</span>
        </div>

        <div class="card-loc">
          <span class="label">FROM</span><br>
          ${booking.pickup?.address || "‚Äî"}
        </div>

        ${stopsLine}

        <div class="card-loc">
          <span class="label">TO</span><br>
          ${booking.dropoff?.address || "‚Äî"}
        </div>

        <div class="card-meta">
          Estimate: ${estimate}<br>
          Party: ${booking.rider?.partySize || 1}
        </div>

        <div class="status-row">
          <span class="${statusClass}">${statusLabel}</span>
          ${vehicleHtml}
        </div>

        ${
          showActions
            ? `<div class="card-actions">
                 <button class="btn-full btn-secondary js-refresh-one" data-id="${booking.id}">
                   üîÑ Refresh Status
                 </button>
                 ${
                   allowRerequest
                     ? `<button class="btn-full btn-primary js-rerequest" data-id="${booking.id}">
                          üîÅ Re-request This Route
                        </button>`
                     : ""
                 }
               </div>`
            : ""
        }
      </div>
    `;
  }

  async function fetchSingleRide(id) {
    try {
      const res = await fetch(`${API}/api/bookings?id=${encodeURIComponent(id)}&t=${Date.now()}`, {
        cache: "no-store"
      });
      if (!res.ok) return null;
      return await res.json();
    } catch {
      return null;
    }
  }

  async function fetchRidesForPhone(phone) {
    // Requires worker patch that supports riderPhone filter
    try {
      const res = await fetch(`${API}/api/bookings?riderPhone=${encodeURIComponent(phone)}&t=${Date.now()}`, {
        cache: "no-store"
      });
      if (!res.ok) return [];
      const list = await res.json();
      return Array.isArray(list) ? list : [];
    } catch {
      return [];
    }
  }

  function splitActiveRecent(list) {
    const activeStates = ["REQUESTED","ACCEPTED","ENROUTE","ARRIVED"];
    const completedStates = ["COMPLETED","CANCELLED"];

    const active = list
      .filter(b => activeStates.includes((b.status || "").toUpperCase()))
      .sort((a,b) => (b.createdAt || "").localeCompare(a.createdAt || ""));

    const recent = list
      .filter(b => completedStates.includes((b.status || "").toUpperCase()))
      .sort((a,b) => (b.createdAt || "").localeCompare(a.createdAt || ""));

    return { active, recent };
  }

  async function renderPage() {
    const profile = getStoredProfile();
    const riderPhone = profile?.phone?.trim();

    if (profile && riderPhone) {
      profileInfoEl.textContent = `Profile: ${profile.name || "Rider"} (${riderPhone}).`;
    } else {
      profileInfoEl.textContent = "Tip: Save your rider profile so Big Red can match your rides to your phone number.";
    }

    // If we have a deep-linked rideId, render that as the primary focus.
    if (paramId) {
      const booking = await fetchSingleRide(paramId);
      if (!booking) {
        activeRideEl.innerHTML = `<div class="empty-block">That ride link could not be found. It may have expired or been deleted.</div>`;
        return;
      }

      const isActive = ["REQUESTED","ACCEPTED","ENROUTE","ARRIVED"].includes(
        (booking.status || "").toUpperCase()
      );

      activeRideEl.innerHTML = renderRideCard(booking, {
        showActions: true,
        allowRerequest: !isActive
      });

      deepLinkHintEl.textContent =
        "This view is linked to a specific ride. You can still see other rides when your profile phone number is saved.";

      // If we have a profile phone, grab the rest for history
      if (riderPhone) {
        const list = await fetchRidesForPhone(riderPhone);
        const { recent } = splitActiveRecent(list.filter(b => b.id !== booking.id));
        if (!recent.length) {
          recentRidesEl.innerHTML = `<div class="empty-block">No recent rides found yet under your phone number.</div>`;
        } else {
          recentRidesEl.innerHTML = recent
            .slice(0, 5)
            .map(b => renderRideCard(b, { showActions: true, allowRerequest: true }))
            .join("");
        }
      } else {
        recentRidesEl.innerHTML = `<div class="empty-block">Save your rider profile to see your full ride history.</div>`;
      }

      return;
    }

    // No id param: normal phone-based dashboard
    if (!riderPhone) {
      activeRideEl.innerHTML =
        `<div class="empty-block">No phone number found. Save your rider profile first so rides can be linked to you.</div>`;
      recentRidesEl.innerHTML =
        `<div class="empty-block">Once your profile is saved and you complete rides, they‚Äôll appear here.</div>`;
      return;
    }

    const list = await fetchRidesForPhone(riderPhone);
    if (!list.length) {
      activeRideEl.innerHTML =
        `<div class="empty-block">No active rides found under ${riderPhone}.</div>`;
      recentRidesEl.innerHTML =
        `<div class="empty-block">No recent rides yet. Your history will appear here after your trips.</div>`;
      return;
    }

    const { active, recent } = splitActiveRecent(list);

    if (!active.length) {
      activeRideEl.innerHTML =
        `<div class="empty-block">No active rides at the moment. When you have a ride in progress, it will show up here.</div>`;
    } else {
      // Show the most recent active ride
      const top = active[0];
      activeRideEl.innerHTML = renderRideCard(top, {
        showActions: true,
        allowRerequest: false
      });
    }

    if (!recent.length) {
      recentRidesEl.innerHTML =
        `<div class="empty-block">No completed or cancelled rides found yet.</div>`;
    } else {
      recentRidesEl.innerHTML = recent
        .slice(0, 5)
        .map(b => renderRideCard(b, { showActions: true, allowRerequest: true }))
        .join("");
    }
  }

  // Click handlers for refresh/re-request buttons
  document.addEventListener("click", async (e) => {
    const refreshBtn = e.target.closest(".js-refresh-one");
    const rerequestBtn = e.target.closest(".js-rerequest");
    const newRideBtn = e.target.id === "btnNewRide";

    if (refreshBtn) {
      const id = refreshBtn.dataset.id;
      if (!id) return;
      const booking = await fetchSingleRide(id);
      if (!booking) {
        showToast("Unable to refresh this ride.");
        return;
      }
      const cardHtml = renderRideCard(booking, {
        showActions: true,
        allowRerequest: !["REQUESTED","ACCEPTED","ENROUTE","ARRIVED"].includes(
          (booking.status || "").toUpperCase()
        )
      });
      const parent = refreshBtn.closest(".card");
      if (parent) parent.outerHTML = cardHtml;
      showToast("Ride status refreshed");
    }

    if (rerequestBtn) {
      const id = rerequestBtn.dataset.id;
      if (!id) return;
      // Just send them to the ride request page with prefilled query
      const cardEl = rerequestBtn.closest(".card");
      if (!cardEl) return;

      // We‚Äôll just trust backend for now; simple redirect:
      window.location.href = "/rider/ride-request.html";
    }

    if (newRideBtn) {
      window.location.href = "/rider/ride-request.html";
    }
  });

  // Initial render + periodic refresh of active if in normal mode
  renderPage();

  // If in deep-link mode, re-poll that single ride every 20s
  if (paramId) {
    setInterval(async () => {
      const booking = await fetchSingleRide(paramId);
      if (!booking) return;
      const isActive = ["REQUESTED","ACCEPTED","ENROUTE","ARRIVED"].includes(
        (booking.status || "").toUpperCase()
      );
      activeRideEl.innerHTML = renderRideCard(booking, {
        showActions: true,
        allowRerequest: !isActive
      });
    }, 20000);
  } else {
    // Phone-based dashboard: refresh everything every 30s
    setInterval(renderPage, 30000);
  }

</script>

</body>
</html>