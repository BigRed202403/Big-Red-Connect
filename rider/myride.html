<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>My Ride – Big Red Connect</title>

  <!-- PWA / Icons -->
  <link rel="apple-touch-icon" href="/icon.PNG">
  <link rel="icon" type="image/png" sizes="192x192" href="/icon.PNG">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#000"/>

  <!-- Google Maps -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCMM0dxLNM7XQI5G3OBSnINeO5hcS3Ks5I&libraries=geometry"></script>

  <style>
    body {
      margin:0;
      background:#000;
      color:#fff;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
      padding-bottom:60px;
    }

    header {
      background:#000;
      padding:12px;
      border-bottom:2px solid #b30000;
      display:flex;
      justify-content:space-between;
      align-items:center;
      position:sticky;
      top:0;
      z-index:50;
    }

    .header-left {
      display:flex;
      align-items:center;
      gap:10px;
    }

    .logo { height:42px; }

    #menuBtn {
      font-size:1.6rem;
      background:none;
      border:none;
      color:#fff;
      cursor:pointer;
    }

    #menuPanel {
      display:none;
      flex-direction:column;
      background:#111;
      border-bottom:2px solid #b30000;
    }

    #menuPanel a {
      padding:16px;
      color:#fff;
      text-decoration:none;
      border-bottom:1px solid #222;
    }

    h1 {
      text-align:center;
      margin:18px 0;
      font-size:1.4rem;
    }

    .card {
      background:#111;
      border:1px solid #333;
      border-radius:10px;
      padding:14px;
      margin:0 12px 14px;
    }

    .status {
      font-size:.9rem;
      color:#ccc;
      margin-bottom:6px;
    }

    .loc {
      font-size:.95rem;
      margin:4px 0;
    }

    .btn {
      display:block;
      width:calc(100% - 24px);
      margin:10px auto;
      padding:15px;
      border-radius:10px;
      font-weight:700;
      text-align:center;
      text-decoration:none;
    }

    .btn-primary { background:#b30000; color:#fff; }
    .btn-secondary { background:#111; border:1px solid #333; color:#fff; }
    .btn-danger { background:#400; border:1px solid #b30000; color:#fff; }

    .locked-msg {
      background:#111;
      border:1px solid #555;
      border-radius:10px;
      padding:14px;
      margin:0 12px 14px;
      font-size:.9rem;
      color:#aaa;
      text-align:center;
    }

    #map {
      width:calc(100% - 24px);
      height:300px;
      margin:12px auto;
      border-radius:12px;
      border:1px solid #333;
      display:none;
    }

    /* MODAL */
    #confirmModal {
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.75);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:999;
    }

    .modal-box {
      background:#111;
      border:1px solid #b30000;
      border-radius:12px;
      padding:20px;
      max-width:320px;
      text-align:center;
    }

    .modal-box p { margin-bottom:16px; }

    .modal-actions {
      display:flex;
      gap:10px;
      justify-content:center;
    }
  </style>
</head>

<body>

<header>
  <div class="header-left">
    <a href="/index.html"><img src="/icon.PNG" class="logo"></a>
    <div style="font-weight:700;">My Ride</div>
  </div>
  <button id="menuBtn">☰</button>
</header>

<nav id="menuPanel">
  <a href="/rider/rider.html">Rider Hub</a>
  <a href="/rider/ride-request.html">Request a Ride</a>
  <a href="/rider/myride.html">My Ride</a>
  <a href="/rider/profile.html">Profile</a>
  <a href="#" id="logoutBtn">Log Out</a>
</nav>

<h1>Your Ride</h1>

<div id="activeRide"></div>
<div id="map"></div>

<a href="/rider/ride-request.html" class="btn btn-primary">Request Another Ride</a>
<a href="/rider/rider.html" class="btn btn-secondary">Back to Rider Hub</a>

<!-- CANCEL CONFIRMATION MODAL -->
<div id="confirmModal">
  <div class="modal-box">
    <p>Are you sure you want to cancel this ride?</p>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeModal()">No</button>
      <button class="btn btn-danger" onclick="confirmCancel()">Yes, Cancel</button>
    </div>
  </div>
</div>

<script>
const BOOKINGS_API = "https://bigred-bookings.bigredtransportation.workers.dev";
const STATUS_API   = "https://bigred-status-updater.bigredtransportation.workers.dev/status";

let activeRide = null;

/* MENU */
menuBtn.onclick = () => {
  menuPanel.style.display = menuPanel.style.display === "flex" ? "none" : "flex";
};

logoutBtn.onclick = () => {
  localStorage.clear();
  location.href="/index.html";
};

/* LOCK RULE */
function canModifyRide(status){
  return !["PICKED_UP","COMPLETED","CANCELLED"].includes(status);
}

/* LOAD RIDE */
async function loadRide(){
  const riderId = localStorage.getItem("riderId");
  if(!riderId) return;

  const res = await fetch(`${BOOKINGS_API}/api/driver/bookings?scope=all`);
  const all = await res.json();

  activeRide = all.find(r =>
    r.rider?.riderId === riderId &&
    ["REQUESTED","ACCEPTED","ENROUTE","ARRIVED","PICKED_UP"].includes(r.status)
  );

  renderRide();
}

function renderRide(){
  const box = document.getElementById("activeRide");
  if(!activeRide){
    box.innerHTML = `<div class="card">You have no active rides.</div>`;
    return;
  }

  const editable = canModifyRide(activeRide.status);

  box.innerHTML = `
    <div class="card">
      <div class="status">Status: ${activeRide.status}</div>
      <div class="loc">Pickup: ${activeRide.pickup.address}</div>
      <div class="loc">Dropoff: ${activeRide.dropoff.address}</div>
    </div>

    ${
      editable ? `
        <a class="btn btn-secondary" href="/rider/ride-request.html?edit=${activeRide.id}">
          ✏️ Edit Ride
        </a>
        <button class="btn btn-danger" onclick="openCancelModal()">
          ❌ Cancel Ride
        </button>
      ` : `
        <div class="locked-msg">
          This ride is already in progress and can no longer be edited or canceled.
        </div>
      `
    }
  `;
}

/* CANCEL FLOW */
function openCancelModal(){
  confirmModal.style.display="flex";
}

function closeModal(){
  confirmModal.style.display="none";
}

async function confirmCancel(){
  closeModal();
  await fetch(`${BOOKINGS_API}/api/rider/cancel`,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ bookingId: activeRide.id })
  });
  location.reload();
}

loadRide();
</script>

</body>
</html>