<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>My Ride â€“ Big Red Connect</title>

  <!-- PWA + Icons -->
  <link rel="apple-touch-icon" href="/icon.PNG">
  <link rel="icon" type="image/png" sizes="192x192" href="/icon.PNG">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#000"/>

  <style>
    body{
      margin:0;
      background:#000;
      color:#fff;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
      padding-bottom:50px;
    }

    /* HEADER + MENU */
    header{
      background:#000;
      padding:12px;
      border-bottom:2px solid #b30000;
      display:flex;
      justify-content:space-between;
      align-items:center;
      position:sticky;
      top:0;
      z-index:50;
    }
    .header-left{ display:flex; align-items:center; gap:10px; }
    .logo{ height:42px; }
    #menuBtn{
      font-size:1.6rem;
      background:none;
      border:none;
      color:white;
      cursor:pointer;
    }
    #menuPanel{
      display:none;
      flex-direction:column;
      background:#111;
      border-bottom:2px solid #b30000;
      animation:drop .15s ease-out;
    }
    #menuPanel a{
      padding:16px;
      color:#fff;
      text-decoration:none;
      border-bottom:1px solid #222;
      font-size:1rem;
    }
    #menuPanel a:hover{ background:#222; }
    @keyframes drop{
      from{ opacity:0; transform:translateY(-10px); }
      to{ opacity:1; transform:translateY(0); }
    }

    h1{
      text-align:center;
      font-size:1.4rem;
      margin:18px 0 8px;
      font-weight:700;
    }

    .section-title{
      font-size:1rem;
      font-weight:700;
      margin:10px 0 6px;
      padding:0 12px;
    }

    .card{
      background:#111;
      border:1px solid #333;
      border-radius:10px;
      padding:14px;
      margin:0 12px 14px;
    }

    .status{
      font-size:.88rem;
      margin-bottom:4px;
      color:#ccc;
    }

    .loc-line{
      margin:6px 0;
      font-size:.9rem;
      color:#e8e8e8;
    }

    .muted{ color:#aaa; font-size:.88rem; }

    .btn-primary, .btn-ghost{
      display:block;
      width:calc(100% - 24px);
      margin:12px auto;
      padding:15px;
      text-align:center;
      border-radius:10px;
      text-decoration:none;
      font-weight:700;
      font-size:1.05rem;
    }
    .btn-primary{ background:#b30000; color:#fff; }
    .btn-ghost{
      background:#111;
      color:#fff;
      border:1px solid #333;
    }

    /* Map */
    #map{
      width:calc(100% - 24px);
      height:320px;
      margin:12px auto;
      border-radius:12px;
      border:1px solid #333;
      display:none;
    }

    #etaBox{
      display:none;
      margin:-4px 12px 14px;
    }

    /* Diagnostics */
    .diag-toggle{
      display:flex;
      justify-content:center;
      gap:10px;
      padding:0 12px 10px;
    }
    .diag-toggle button{
      background:#111;
      border:1px solid #333;
      color:#fff;
      border-radius:999px;
      padding:10px 14px;
      font-weight:700;
      cursor:pointer;
    }
    .diag-row{
      display:flex;
      gap:10px;
      align-items:flex-start;
      padding:8px 0;
      border-bottom:1px solid #222;
    }
    .diag-badge{
      min-width:78px;
      text-align:center;
      font-weight:800;
      font-size:.78rem;
      padding:6px 8px;
      border-radius:999px;
      border:1px solid #333;
      background:#0b0b0b;
    }
    .ok{ border-color:#2d8a3a; color:#bff5c7; }
    .warn{ border-color:#c08a2a; color:#ffe2b3; }
    .bad{ border-color:#b30000; color:#ffb3b3; }
    .diag-text{ font-size:.9rem; color:#ddd; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    #toast{
      position:fixed;
      bottom:22px;
      left:50%;
      transform:translateX(-50%);
      background:#111;
      border:1px solid #b30000;
      padding:10px 18px;
      border-radius:999px;
      opacity:0;
      transition:.25s;
      z-index:999;
      max-width:90vw;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    #toast.show{ opacity:1; }
  </style>

  <!-- OneSignal SDK (identity bind only; no prompt here) -->
  <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>

  <!-- Google Maps (loaded later via script tag at bottom with callback) -->
</head>

<body>

<header>
  <div class="header-left">
    <a href="/index.html"><img src="/icon.PNG" class="logo" alt="Big Red Connect"></a>
    <div style="font-weight:700;font-size:1rem;">My Ride</div>
  </div>
  <button id="menuBtn">â˜°</button>
</header>

<nav id="menuPanel">
  <a href="/rider/rider.html">Rider Hub</a>
  <a href="/rider/ride-request.html">Request a Ride</a>
  <a href="/rider/myride.html">My Ride</a>
  <a href="/rider/profile.html">Profile</a>
  <a href="#" id="logoutBtn">Log Out</a>
</nav>

<h1>Your Ride</h1>

<div class="diag-toggle">
  <button id="btnToggleDiag">ðŸ§° Show Diagnostics</button>
  <button id="btnRefresh">ðŸ”„ Refresh</button>
</div>

<div id="diagCard" class="card" style="display:none;">
  <div class="status" style="font-weight:800;">Diagnostics (no DevTools required)</div>
  <div class="muted" style="margin-top:6px;">
    This panel tells you exactly what is failing (network, CORS, unauthorized, bad JSON, no rides, etc.).
  </div>
  <div id="diagList" style="margin-top:10px;"></div>
</div>

<!-- ACTIVE -->
<div id="activeContainer"></div>

<!-- MAP -->
<div id="map"></div>

<!-- ETA CARD -->
<div id="etaBox" class="card"></div>

<!-- PAST RIDES -->
<h2 class="section-title">Past Rides</h2>
<div id="pastContainer"></div>

<a href="/rider/ride-request.html" class="btn-primary">Request Another Ride</a>
<a href="/rider/rider.html" class="btn-ghost">Back to Rider Hub</a>

<div id="toast"></div>

<script>
/* =========================
   CONFIG
========================= */
const API_BOOKINGS = "https://bigred-bookings.bigredtransportation.workers.dev";
const API_STATUS   = "https://bigred-status-updater.bigredtransportation.workers.dev/status";

/* =========================
   UI BASICS
========================= */
document.getElementById("menuBtn").addEventListener("click", ()=>{
  const p = document.getElementById("menuPanel");
  p.style.display = (p.style.display==="flex" ? "none" : "flex");
});

document.getElementById("logoutBtn").addEventListener("click", ()=>{
  // Only remove rider-related keys (donâ€™t nuke everything)
  localStorage.removeItem("bigred_rider_profile_v1");
  localStorage.removeItem("riderId");
  localStorage.removeItem("riderName");
  localStorage.removeItem("riderPhone");
  localStorage.removeItem("riderHome");
  localStorage.removeItem("riderGate");
  showToast("Logged out");
  setTimeout(()=> window.location.href="/index.html", 350);
});

document.getElementById("btnRefresh").addEventListener("click", ()=>{
  location.reload();
});

function showToast(msg){
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.classList.add("show");
  setTimeout(()=> t.classList.remove("show"), 1900);
}

/* =========================
   DIAGNOSTICS (VISIBLE)
========================= */
const diagCard = document.getElementById("diagCard");
const diagList = document.getElementById("diagList");
let diagVisible = false;

document.getElementById("btnToggleDiag").addEventListener("click", ()=>{
  diagVisible = !diagVisible;
  diagCard.style.display = diagVisible ? "block" : "none";
  document.getElementById("btnToggleDiag").textContent = diagVisible ? "ðŸ§° Hide Diagnostics" : "ðŸ§° Show Diagnostics";
});

function addDiag(level, label, text){
  const cls = level === "OK" ? "ok" : level === "WARN" ? "warn" : "bad";
  const row = document.createElement("div");
  row.className = "diag-row";
  row.innerHTML = `
    <div class="diag-badge ${cls}">${label}</div>
    <div class="diag-text">${text}</div>
  `;
  diagList.appendChild(row);
}

function clearDiag(){
  diagList.innerHTML = "";
}

/* =========================
   RIDER IDENTITY HELPERS
========================= */
function getProfile(){
  // Canonical
  try{
    const raw = localStorage.getItem("bigred_rider_profile_v1");
    if(raw){
      const p = JSON.parse(raw);
      return {
        riderId: p.riderId || null,
        name: p.name || null,
        phone: (p.phone || "").replace(/\D/g,"") || null
      };
    }
  } catch {}
  // Legacy
  return {
    riderId: localStorage.getItem("riderId") || null,
    name: localStorage.getItem("riderName") || null,
    phone: (localStorage.getItem("riderPhone") || "").replace(/\D/g,"") || null
  };
}

function ensureLegacyKeysFromCanonical(){
  // Make older pages happy without breaking new canonical
  try{
    const p = getProfile();
    if(p.riderId) localStorage.setItem("riderId", p.riderId);
    if(p.name) localStorage.setItem("riderName", p.name);
    if(p.phone) localStorage.setItem("riderPhone", p.phone);
  } catch {}
}

/* =========================
   BOOKINGS FETCH (SELF-DIAGNOSING)
========================= */
async function safeFetchJson(url){
  // Returns { ok, status, json, text, errorType }
  try{
    const res = await fetch(url, { cache:"no-store" });
    const status = res.status;
    const text = await res.text();

    // Try JSON parse
    let j = null;
    try{ j = JSON.parse(text); } catch {}

    if(!res.ok){
      return {
        ok:false,
        status,
        json:j,
        text,
        errorType: (status === 401 || status === 403) ? "UNAUTHORIZED" : "HTTP_ERROR"
      };
    }

    if(j === null){
      return { ok:false, status, json:null, text, errorType:"BAD_JSON" };
    }

    return { ok:true, status, json:j, text };
  } catch(e){
    return { ok:false, status:0, json:null, text:"", errorType:"NETWORK" };
  }
}

async function loadBookingsWithDiagnostics(){
  clearDiag();
  ensureLegacyKeysFromCanonical();

  const prof = getProfile();

  addDiag("OK", "PROFILE", `Local rider profile found: <span class="mono">${prof.riderId || "MISSING"}</span> â€¢ phone: <span class="mono">${prof.phone || "MISSING"}</span>`);

  if(!prof.riderId && !prof.phone){
    addDiag("BAD", "LOGIN", `No riderId/phone found in storage. You are effectively logged out. Go to <span class="mono">/rider-login.html</span> and log in.`);
    return { all: [], my: [], active: null, past: [] };
  }

  // Primary endpoint (your current pattern)
  const urlAll = `${API_BOOKINGS}/api/driver/bookings?scope=all`;
  addDiag("WARN", "FETCH", `Attempting bookings fetch: <span class="mono">${urlAll}</span>`);

  const res1 = await safeFetchJson(urlAll);

  if(!res1.ok){
    if(res1.errorType === "NETWORK"){
      addDiag("BAD", "NETWORK", `Browser could not reach the bookings worker at all. This is typically: offline, DNS, or a blocked request.`);
    } else if(res1.errorType === "UNAUTHORIZED"){
      addDiag("BAD", "AUTH", `Bookings worker responded ${res1.status}. This suggests it now requires a secret header or changed access rules.`);
    } else if(res1.errorType === "BAD_JSON"){
      addDiag("BAD", "JSON", `Bookings worker returned non-JSON (status ${res1.status}). First chars: <span class="mono">${(res1.text||"").slice(0,180).replace(/</g,"&lt;")}</span>`);
    } else {
      addDiag("BAD", "HTTP", `Bookings worker returned HTTP ${res1.status}. Body: <span class="mono">${(res1.text||"").slice(0,180).replace(/</g,"&lt;")}</span>`);
    }

    // Try a secondary fetch to help isolate
    const urlActive = `${API_BOOKINGS}/api/driver/bookings?scope=active`;
    addDiag("WARN", "RETRY", `Trying alternate scope: <span class="mono">${urlActive}</span>`);
    const res2 = await safeFetchJson(urlActive);

    if(res2.ok){
      addDiag("OK", "ALT OK", `Alternate fetch works (HTTP ${res2.status}). That means the worker is reachable; the issue is likely scope/size or response formatting on scope=all.`);
      return processBookings(res2.json, prof);
    } else {
      addDiag("BAD", "ALT FAIL", `Alternate fetch also failed. This confirms a worker reachability / CORS / auth issue, not a filtering issue on this page.`);
      return { all: [], my: [], active: null, past: [] };
    }
  }

  addDiag("OK", "OK", `Bookings fetch succeeded (HTTP ${res1.status}). Records returned: <span class="mono">${Array.isArray(res1.json) ? res1.json.length : "NOT_ARRAY"}</span>`);

  if(!Array.isArray(res1.json)){
    addDiag("BAD", "FORMAT", `Expected an array of bookings but got something else. First chars: <span class="mono">${(res1.text||"").slice(0,180).replace(/</g,"&lt;")}</span>`);
    return { all: [], my: [], active: null, past: [] };
  }

  return processBookings(res1.json, prof);
}

function processBookings(all, prof){
  // Filter by canonical riderId OR by phone as fallback
  const my = all.filter(b=>{
    const rid = b?.rider?.riderId || null;
    const ph  = (b?.rider?.phone || "").replace(/\D/g,"");
    if(prof.riderId && rid && rid === prof.riderId) return true;
    if(prof.phone && ph && ph === prof.phone) return true;
    return false;
  });

  addDiag(my.length ? "OK" : "WARN", "MATCH", `Bookings matching THIS rider: <span class="mono">${my.length}</span> (match logic: riderId first, phone fallback)`);

  const activeStatuses = ["REQUESTED","ACCEPTED","ENROUTE","ARRIVED","PICKED_UP"];
  const doneStatuses   = ["COMPLETED","CANCELLED","DECLINED"];

  const active = my.find(b => activeStatuses.includes(String(b.status||"").toUpperCase())) || null;
  const past   = my.filter(b => doneStatuses.includes(String(b.status||"").toUpperCase()));

  addDiag(active ? "OK" : "WARN", "ACTIVE", active ? `Active ride found: <span class="mono">${active.id}</span> status <span class="mono">${active.status}</span>` : `No active ride found.`);
  addDiag(past.length ? "OK" : "WARN", "PAST", `Past rides found: <span class="mono">${past.length}</span>`);

  return { all, my, active, past };
}

/* =========================
   RENDER
========================= */
let activeRide = null;

function renderActive(ride){
  const box = document.getElementById("activeContainer");
  const mapDiv = document.getElementById("map");
  const etaBox = document.getElementById("etaBox");

  if(!ride){
    box.innerHTML = `<div class="card">You have no active rides.</div>`;
    mapDiv.style.display="none";
    etaBox.style.display="none";
    activeRide = null;
    stopLiveLoops();
    return;
  }

  activeRide = ride;

  box.innerHTML = `
    <div class="card">
      <div class="status">Status: <strong>${ride.status}</strong></div>
      <div class="loc-line"><strong>Pickup:</strong> ${ride.pickup?.address || "â€”"}</div>
      <div class="loc-line"><strong>Dropoff:</strong> ${ride.dropoff?.address || "â€”"}</div>
      <div class="muted" style="margin-top:8px;">Ride ID: <span class="mono">${ride.id}</span></div>
    </div>
  `;
}

function renderPast(list){
  const box = document.getElementById("pastContainer");
  box.innerHTML = "";

  if(!list || !list.length){
    box.innerHTML = `<div class="card">No past rides yet.</div>`;
    return;
  }

  list
    .slice()
    .sort((a,b)=>(String(b.createdAt||"").localeCompare(String(a.createdAt||""))))
    .forEach(r=>{
      box.innerHTML += `
        <div class="card">
          <div class="status">${r.status}</div>
          <div class="loc-line"><strong>From:</strong> ${r.pickup?.address || "â€”"}</div>
          <div class="loc-line"><strong>To:</strong> ${r.dropoff?.address || "â€”"}</div>
          <div class="muted" style="margin-top:8px;">Ride ID: <span class="mono">${r.id}</span></div>
        </div>
      `;
    });
}

/* =========================
   MAP + LIVE DRIVER + ROUTE + ETA
   - Shows pickup + dropoff markers
   - Shows driver marker
   - Draws route:
       before PICKED_UP -> driver -> pickup
       after PICKED_UP  -> driver -> dropoff
========================= */
let map, geocoder, directionsService, directionsRenderer;
let driverMarker, pickupMarker, dropoffMarker;
let pickupLatLng = null;
let dropoffLatLng = null;
let driverLatLng = null;
let statusLoop = null;
let routeLoop = null;

function stopLiveLoops(){
  if(statusLoop){ clearInterval(statusLoop); statusLoop = null; }
  if(routeLoop){ clearInterval(routeLoop); routeLoop = null; }
}

function initMapIfNeeded(){
  const mapDiv = document.getElementById("map");
  mapDiv.style.display = "block";

  if(map) return;

  map = new google.maps.Map(mapDiv, {
    zoom: 12,
    center: { lat:35.4676, lng:-97.5164 },
    mapTypeControl:false,
    streetViewControl:false,
    fullscreenControl:false
  });

  geocoder = new google.maps.Geocoder();
  directionsService = new google.maps.DirectionsService();
  directionsRenderer = new google.maps.DirectionsRenderer({
    suppressMarkers:true,
    polylineOptions: { strokeWeight: 5 }
  });
  directionsRenderer.setMap(map);
}

function setMarker(existing, pos, iconUrl){
  if(existing) existing.setMap(null);
  return new google.maps.Marker({
    map,
    position: pos,
    icon: iconUrl ? { url: iconUrl } : undefined
  });
}

function fitAll(){
  const bounds = new google.maps.LatLngBounds();
  let hasAny = false;

  if(driverLatLng){ bounds.extend(driverLatLng); hasAny = true; }
  if(pickupLatLng){ bounds.extend(pickupLatLng); hasAny = true; }
  if(dropoffLatLng){ bounds.extend(dropoffLatLng); hasAny = true; }

  if(hasAny){
    map.fitBounds(bounds);
  }
}

function showEtaBox(textHtml){
  const etaBox = document.getElementById("etaBox");
  etaBox.style.display = "block";
  etaBox.innerHTML = textHtml;
}

async function geocodeAddress(addr){
  return await new Promise((resolve, reject)=>{
    geocoder.geocode({ address: addr }, (res, status)=>{
      if(status === "OK" && res && res[0]){
        resolve(res[0].geometry.location);
      } else {
        reject(status);
      }
    });
  });
}

async function fetchDriverLocation(){
  // Expected format from your status worker: { location: { lat, lng } ... }
  try{
    const r = await fetch(API_STATUS, { cache:"no-store" });
    const j = await r.json();
    const loc = j.location || j.loc || null;

    if(loc && typeof loc.lat === "number" && typeof loc.lng === "number"){
      return new google.maps.LatLng(loc.lat, loc.lng);
    }

    // Some workers return {latitude, longitude}
    if(typeof j.latitude === "number" && typeof j.longitude === "number"){
      return new google.maps.LatLng(j.latitude, j.longitude);
    }

    return null;
  } catch {
    return null;
  }
}

async function drawRouteAndEta(){
  if(!activeRide || !pickupLatLng || !dropoffLatLng) return;

  // Pull latest driver position
  const drv = await fetchDriverLocation();
  if(drv) driverLatLng = drv;

  // If no driver location yet, tell the rider clearly
  if(!driverLatLng){
    showEtaBox(`
      <div class="status"><strong>Live Driver:</strong> unavailable right now</div>
      <div class="muted">If this persists while you're ENROUTE, it usually means the driver device isnâ€™t publishing live location.</div>
    `);
    return;
  }

  // Markers
  driverMarker = setMarker(driverMarker, driverLatLng, "https://maps.google.com/mapfiles/ms/icons/red-dot.png");
  pickupMarker = setMarker(pickupMarker, pickupLatLng, "https://maps.google.com/mapfiles/ms/icons/green-dot.png");
  dropoffMarker = setMarker(dropoffMarker, dropoffLatLng, "https://maps.google.com/mapfiles/ms/icons/blue-dot.png");

  // Decide route target
  const st = String(activeRide.status||"").toUpperCase();
  const goingTo = (st === "PICKED_UP") ? "DROPOFF" : "PICKUP";
  const dest = (goingTo === "DROPOFF") ? dropoffLatLng : pickupLatLng;

  // Route
  try{
    const route = await new Promise((resolve, reject)=>{
      directionsService.route(
        { origin: driverLatLng, destination: dest, travelMode: "DRIVING" },
        (r, s)=> (s === "OK" ? resolve(r) : reject(s))
      );
    });

    directionsRenderer.setDirections(route);

    const leg = route.routes[0].legs[0];
    const miles = leg.distance.value / 1609.34;
    const mins  = Math.round(leg.duration.value / 60);

    showEtaBox(`
      <div class="status"><strong>Live ETA:</strong> ${mins} min â€¢ ${miles.toFixed(1)} mi</div>
      <div class="muted">Routing: driver â†’ ${goingTo === "DROPOFF" ? "dropoff" : "pickup"} â€¢ Updated ${new Date().toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit"})}</div>
    `);

    fitAll();
  } catch(errStatus){
    showEtaBox(`
      <div class="status"><strong>Route:</strong> unavailable</div>
      <div class="muted">Directions request failed (${String(errStatus)}). We still show markers.</div>
    `);
    fitAll();
  }
}

async function startActiveRideMap(ride){
  stopLiveLoops();
  initMapIfNeeded();

  // Clear previous
  directionsRenderer && directionsRenderer.set("directions", null);

  pickupLatLng = null;
  dropoffLatLng = null;
  driverLatLng = null;

  // Geocode pickup/dropoff
  try{
    pickupLatLng = await geocodeAddress(ride.pickup?.address || "");
  } catch (s){
    showEtaBox(`<div class="status"><strong>Pickup:</strong> could not be mapped (${String(s)})</div>`);
  }

  try{
    dropoffLatLng = await geocodeAddress(ride.dropoff?.address || "");
  } catch (s){
    const etaBox = document.getElementById("etaBox");
    etaBox.style.display = "block";
    etaBox.innerHTML += `<div class="status"><strong>Dropoff:</strong> could not be mapped (${String(s)})</div>`;
  }

  // Immediate draw
  await drawRouteAndEta();

  // Keep updating driver + route while active
  // - Driver marker moves when status worker updates
  // - Route recalculates periodically
  statusLoop = setInterval(async ()=>{
    const drv = await fetchDriverLocation();
    if(drv){
      driverLatLng = drv;
      if(driverMarker) driverMarker.setPosition(driverLatLng);
    }
  }, 15000);

  routeLoop = setInterval(drawRouteAndEta, 30000);
}

/* =========================
   MAIN LOAD
========================= */
async function main(){
  // Always show diag by default for now (since weâ€™re stabilizing)
  diagVisible = true;
  diagCard.style.display = "block";
  document.getElementById("btnToggleDiag").textContent = "ðŸ§° Hide Diagnostics";

  const { active, past } = await loadBookingsWithDiagnostics();

  // Render
  renderActive(active);
  renderPast((past||[]).reverse());

  // Map only if active ride exists
  if(active){
    // Load map + start live route/eta
    // NOTE: Google Maps script loads async; callback fires initMapsCallback()
    window.__activeRideForMap = active;
    loadGoogleMapsIfNeeded();
  } else {
    stopLiveLoops();
  }
}

/* =========================
   GOOGLE MAPS LOADER (SAFE)
========================= */
let mapsLoading = false;
function loadGoogleMapsIfNeeded(){
  if(window.google && window.google.maps){
    // Already loaded
    startActiveRideMap(window.__activeRideForMap).catch(()=>{});
    return;
  }
  if(mapsLoading) return;
  mapsLoading = true;

  // Visible diag
  addDiag("WARN", "MAP", "Loading Google Mapsâ€¦");

  window.initMyRideMap = async function(){
    addDiag("OK", "MAP", "Google Maps loaded.");
    try{
      await startActiveRideMap(window.__activeRideForMap);
    } catch(e){
      addDiag("BAD", "MAP", "Map initialized but could not start live tracking.");
    }
  };

  const s = document.createElement("script");
  s.async = true;
  s.defer = true;
  s.src = "https://maps.googleapis.com/maps/api/js?key=AIzaSyCMM0dxLNM7XQI5G3OBSnINeO5hcS3Ks5I&libraries=geometry&callback=initMyRideMap";
  document.head.appendChild(s);
}

/* =========================
   ONESIGNAL: INIT + IDENTITY BIND (NO PROMPT)
========================= */
window.OneSignalDeferred = window.OneSignalDeferred || [];
OneSignalDeferred.push(async function(OneSignal){
  try{
    await OneSignal.init({
      appId: "9b8bcc89-87d3-46e2-b2d0-042d1a267718",
      safari_web_id: "web.onesignal.auto.0c90051e-4735-447d-b203-75e3767d91b9",
      notifyButton: { enable:false },
      serviceWorkerPath: "/onesignalsdkworker.js",
      path: "/"
    });

    const raw = localStorage.getItem("bigred_rider_profile_v1");
    if(!raw) return;

    const profile = JSON.parse(raw);
    if(!profile.riderId) return;

    await OneSignal.login(profile.riderId);

    // Best-effort tags (does NOT prompt)
    try{
      await OneSignal.User.addTags({ role_rider: "true", env: "live" });
    } catch {}

  } catch(e){
    // No console dependency; show in diagnostics only if open
    if(diagVisible){
      addDiag("WARN","PUSH","OneSignal init/bind skipped on this load.");
    }
  }
});

/* GO */
main();
</script>

</body>
</html>