<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>My Rides ‚Äì Big Red Connect</title>

  <!-- üì± PWA / Icons -->
  <link rel="apple-touch-icon" href="/icon.PNG">
  <link rel="icon" type="image/png" sizes="192x192" href="/icon.png">
  <link rel="shortcut icon" href="/icon.PNG">
  <link rel="manifest" href="manifest-rider.json">
  <meta name="apple-mobile-web-app-title" content="Big Red Rider">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="theme-color" content="#000000">

  <!-- No cache -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <!-- Global Styles -->
  <link rel="stylesheet" href="/style.css?v=1" />

  <!-- Google Maps (for live map + ETA) -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCMM0dxLNM7XQI5G3OBSnINeO5hcS3Ks5I&libraries=places,geometry"></script>

  <style>
    /* Scoped extras for My Rides */
    .page-title {
      margin-top: 8px;
    }
    .info-section h2 {
      margin-bottom: 10px;
    }
    .ride-card {
      background:#111;
      border:1px solid #222;
      border-radius:10px;
      padding:12px 10px;
      margin-bottom:10px;
      font-size:0.9rem;
    }
    .ride-top-row {
      display:flex;
      justify-content:space-between;
      gap:8px;
      align-items:center;
      margin-bottom:4px;
    }
    .ride-status-pill {
      display:inline-block;
      padding:4px 10px;
      border-radius:999px;
      font-size:0.75rem;
      border:1px solid #444;
      background:#111;
      text-transform:uppercase;
      letter-spacing:0.03em;
    }
    .status-REQUESTED { border-color:#ffaa33; color:#ffaa33; }
    .status-ACCEPTED { border-color:#66ccff; color:#66ccff; }
    .status-ENROUTE  { border-color:#00cc66; color:#00cc66; }
    .status-ARRIVED  { border-color:#00ff99; color:#00ff99; }
    .status-COMPLETED{ border-color:#999; color:#999; }
    .status-CANCELLED{ border-color:#ff5555; color:#ff5555; }

    .ride-label {
      font-size:0.75rem;
      color:#aaa;
      margin-top:6px;
    }
    .ride-value {
      font-size:0.9rem;
      margin-top:2px;
    }
    .ride-meta {
      font-size:0.8rem;
      color:#888;
      margin-top:6px;
    }
    .ride-actions {
      margin-top:10px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    .ride-actions .btn {
      flex:1;
      min-width:140px;
      padding:8px 10px;
      font-size:0.9rem;
    }
    #liveMap {
      width:100%;
      height:260px;
      border-radius:10px;
      border:2px solid #b30000;
      margin-top:12px;
    }
    #etaLine {
      font-size:0.9rem;
      color:#ffcc66;
      margin-top:6px;
    }
    #toast {
      position:fixed;
      bottom:20px;
      left:50%;
      transform:translateX(-50%);
      background:#111;
      border:1px solid #b30000;
      padding:8px 14px;
      border-radius:999px;
      opacity:0;
      transition:opacity .25s;
      z-index:50;
      font-size:0.9rem;
    }
    #toast.show {
      opacity:1;
    }
  </style>
</head>
<body>

  <!-- Header -->
  <div class="logo-header">
    <a href="/index.html" title="Return to Home">
      <img src="/icon.PNG" alt="Big Red Connect Logo" style="cursor:pointer;" />
    </a>
  </div>

  <!-- Back to Rider Hub -->
  <div class="top-home-btn" style="text-align:center; margin-top:10px; margin-bottom:10px;">
    <a href="/rider/rider.html" class="btn secondary">‚¨Ö Rider Hub</a>
  </div>

  <h1 class="page-title">My Rides</h1>
  <p class="tagline">View your active ride and recent connections with Big Red.</p>

  <section class="info-section" id="activeRideSection">
    <h2>Active Ride</h2>
    <div id="activeRideBox" class="ride-card">
      Loading your rides‚Ä¶
    </div>
    <div id="etaLine" style="display:none;"></div>
    <div id="liveMap" style="display:none;"></div>
    <div class="ride-actions" id="activeActions" style="margin-top:12px; display:none;">
      <button id="btnRefresh" class="btn secondary" type="button">üîÑ Refresh Status</button>
      <button id="btnCancel" class="btn primary" type="button">‚ùå Cancel Ride</button>
    </div>
  </section>

  <section class="info-section" id="recentRideSection">
    <h2>Recent Rides</h2>
    <div id="recentRidesBox">
      <p style="font-size:0.9rem;color:#888;">No past rides yet.</p>
    </div>
  </section>

  <footer>
    <p>&copy; 2025 Big Red Connect ‚Äî <a href="/index.html">Return to Home</a></p>
  </footer>

  <div id="toast"></div>

  <script>
  // ======================================================
  //  CONFIG + CONSTANTS
  // ======================================================
  const API_BOOK = "https://bigred-bookings.bigredtransportation.workers.dev";
  const LOCATION_API = "https://location-reader.bigredtransportation.workers.dev";
  const ACTIVE_STATUSES = ["REQUESTED", "ACCEPTED", "ENROUTE", "ARRIVED"];
  const CANCELLABLE_STATUSES = ["REQUESTED", "ACCEPTED"];
  const MAX_RECENT = 10;

  let riderProfile = null;
  let riderPhoneE164 = null;
  let riderName = "Rider";

  let bookings = [];
  let currentRide = null;
  let refreshTimer = null;

  // Live map globals
  let liveMap = null;
  let liveDirections = null;
  let geocodeSvc = null;
  let geocodeCache = {};
  let driverMarker = null;
  let pickupMarker = null;
  let dropoffMarker = null;

  // ======================================================
  //  GUARD: REQUIRE RIDER PROFILE & NORMALIZE PHONE
  // ======================================================
  (function guardProfile(){
    const raw = localStorage.getItem("bigred_rider_profile_v1");
    if (!raw) {
      window.location.href = "/rider-login.html?next=myride";
      return;
    }
    try {
      riderProfile = JSON.parse(raw);
    } catch {
      window.location.href = "/rider-login.html?next=myride";
      return;
    }

    if (riderProfile.name && riderProfile.name.trim()) {
      riderName = riderProfile.name.trim();
    }

    const phoneRaw = (riderProfile.phone || "").trim();
    const normalized = normalizePhoneToE164(phoneRaw);
    if (!normalized) {
      // Missing/invalid phone = cannot match rides; send them back to fix profile
      window.location.href = "/rider-login.html?next=myride&fix=phone";
      return;
    }
    riderPhoneE164 = normalized;

    // Cache normalized for other pages
    localStorage.setItem("bigred_rider_id_e164", riderPhoneE164);
  })();

  function normalizePhoneToE164(phone) {
    if (!phone) return null;
    phone = phone.trim();

    // If starts with + and numeric, accept
    if (phone[0] === "+") {
      const digits = phone.slice(1).replace(/\D/g,"");
      if (!digits) return null;
      return "+" + digits;
    }

    const digits = phone.replace(/\D/g,"");
    if (!digits) return null;

    // US assumptions
    if (digits.length === 10) {
      return "+1" + digits;
    }
    if (digits.length === 11 && digits[0] === "1") {
      return "+" + digits;
    }
    return "+" + digits;
  }

  // ======================================================
  //  TOAST
  // ======================================================
  function showToast(msg, ms = 2000) {
    const t = document.getElementById("toast");
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(() => t.classList.remove("show"), ms);
  }

  // ======================================================
  //  LOAD RIDES FOR THIS RIDER
  // ======================================================
  async function loadRides() {
    const activeBox = document.getElementById("activeRideBox");
    const recentBox = document.getElementById("recentRidesBox");
    activeBox.textContent = "Loading your rides‚Ä¶";

    const url = API_BOOK + "/api/bookings?riderPhone=" + encodeURIComponent(riderPhoneE164);
    let data;
    try {
      const res = await fetch(url, { cache:"no-store" });
      if (!res.ok) {
        activeBox.innerHTML = "<p style='font-size:0.9rem;color:#ccc;'>Unable to load rides right now.</p>";
        return;
      }
      data = await res.json();
      if (!Array.isArray(data)) data = [];
    } catch {
      activeBox.innerHTML = "<p style='font-size:0.9rem;color:#ccc;'>Network error loading rides.</p>";
      return;
    }

    bookings = data;

    // Newest first
    bookings.sort((a,b) => {
      const ta = getRideTimestamp(a);
      const tb = getRideTimestamp(b);
      return tb - ta;
    });

    // Active + recent buckets
    const activeList = bookings.filter(b => ACTIVE_STATUSES.includes((b.status || "").toUpperCase()));
    const recentList = bookings
      .filter(b => !ACTIVE_STATUSES.includes((b.status || "").toUpperCase()))
      .slice(0, MAX_RECENT);

    const urlId = new URL(window.location.href).searchParams.get("id");
    let selected = null;

    if (urlId) {
      selected = bookings.find(b => String(b.id) === String(urlId));
    }
    if (!selected && activeList.length > 0) {
      selected = activeList[0];
    }

    currentRide = selected || null;

    renderActiveRide(currentRide);
    renderRecentRides(recentList, currentRide ? currentRide.id : null);
    updateActiveControls();

    if (currentRide) {
      await updateLiveMapForRide(currentRide);
    } else {
      hideLiveMap();
    }
  }

  function getRideTimestamp(b) {
    const cand = b.updatedAt || b.updated_at || b.scheduledFor || b.scheduled_for || b.createdAt || b.created_at;
    const t = cand ? new Date(cand).getTime() : 0;
    return isNaN(t) ? 0 : t;
  }

  // ======================================================
  //  RENDER ACTIVE RIDE
  // ======================================================
  function renderActiveRide(b) {
    const box = document.getElementById("activeRideBox");
    const statusLine = document.getElementById("etaLine");

    if (!b) {
      box.innerHTML = `
        <p style="font-size:0.9rem;color:#ccc;">
          You don't have an active ride right now.
        </p>
        <p style="font-size:0.85rem;color:#888;margin-top:6px;">
          When you request a ride, your live status will show here.
        </p>
      `;
      statusLine.style.display = "none";
      return;
    }

    const status = (b.status || "").toUpperCase();
    const from = b.pickup && b.pickup.address ? b.pickup.address : "‚Äî";
    const to   = b.dropoff && b.dropoff.address ? b.dropoff.address : "‚Äî";
    const stops = Array.isArray(b.stops) ? b.stops.map(s => s.address).filter(Boolean) : [];
    const when = formatRideTime(b);
    const type = b.type || b.rideType || "";

    const statusClass = "status-" + status;
    const metaBits = [];
    if (when) metaBits.push(when);
    if (type) metaBits.push(type.toString());

    box.innerHTML = `
      <div class="ride-top-row">
        <div style="font-weight:600;">Ride ID: ${b.id}</div>
        <div class="ride-status-pill ${statusClass}">${status}</div>
      </div>

      <div class="ride-label">FROM</div>
      <div class="ride-value">${from}</div>

      ${stops.length ? `
        <div class="ride-label">STOPS</div>
        <div class="ride-value">${stops.join(" ‚Üí ")}</div>
      ` : ""}

      <div class="ride-label">TO</div>
      <div class="ride-value">${to}</div>

      <div class="ride-meta">
        ${metaBits.join(" ¬∑ ")}
      </div>
    `;

    // ETA line controlled in live map updates
    statusLine.style.display = "none";
  }

  function formatRideTime(b) {
    const cand = b.scheduledFor || b.scheduled_for || b.createdAt || b.created_at;
    if (!cand) return "";
    const d = new Date(cand);
    if (isNaN(d)) return "";
    return d.toLocaleString(undefined, {
      month:"short",
      day:"numeric",
      hour:"numeric",
      minute:"2-digit"
    });
  }

  // ======================================================
  //  RENDER RECENT RIDES (TEXT ONLY)
  // ======================================================
  function renderRecentRides(list, activeId) {
    const box = document.getElementById("recentRidesBox");
    if (!list.length) {
      box.innerHTML = `<p style="font-size:0.9rem;color:#888;">No past rides yet.</p>`;
      return;
    }

    let html = "";
    list.forEach(b => {
      const status = (b.status || "").toUpperCase();
      const from = b.pickup && b.pickup.address ? b.pickup.address : "‚Äî";
      const to   = b.dropoff && b.dropoff.address ? b.dropoff.address : "‚Äî";
      const stops = Array.isArray(b.stops) ? b.stops.map(s => s.address).filter(Boolean) : [];
      const when = formatRideTime(b);
      const statusClass = "status-" + status;

      html += `
        <div class="ride-card">
          <div class="ride-top-row">
            <div style="font-weight:600;">Ride ID: ${b.id}</div>
            <div class="ride-status-pill ${statusClass}">${status}</div>
          </div>

          <div class="ride-label">FROM</div>
          <div class="ride-value">${from}</div>

          ${stops.length ? `
            <div class="ride-label">STOPS</div>
            <div class="ride-value">${stops.join(" ‚Üí ")}</div>
          ` : ""}

          <div class="ride-label">TO</div>
          <div class="ride-value">${to}</div>

          <div class="ride-meta">${when || ""}</div>

          <div class="ride-actions">
            <button type="button" class="btn secondary"
              onclick="viewRideDetails('${b.id}')">üìç View Details</button>
            ${canReRequest(status) ? `
              <button type="button" class="btn primary"
                onclick="reRequestRide('${encodeURIComponent(from)}','${encodeURIComponent(to)}','${encodeURIComponent(stops.join('|'))}')">
                üîÅ Request This Again
              </button>
            ` : ""}
          </div>
        </div>
      `;
    });

    box.innerHTML = html;
  }

  function canReRequest(status) {
    status = (status || "").toUpperCase();
    return status === "COMPLETED" || status === "CANCELLED";
  }

  function viewRideDetails(id) {
    const url = new URL(window.location.href);
    url.searchParams.set("id", id);
    window.location.href = url.toString();
  }

  function reRequestRide(fromEnc, toEnc, stopsEnc) {
    const from = decodeURIComponent(fromEnc);
    const to = decodeURIComponent(toEnc);
    const stopsStr = decodeURIComponent(stopsEnc || "");
    const params = new URLSearchParams();
    if (from) params.set("pickup", from);
    if (to) params.set("dropoff", to);
    if (stopsStr) params.set("stops", stopsStr);
    params.set("reFrom", "history");

    window.location.href = "/rider/ride-request.html?" + params.toString();
  }

  // ======================================================
  //  ACTIVE CONTROLS (REFRESH + CANCEL)
  // ======================================================
  function updateActiveControls() {
    const actions = document.getElementById("activeActions");
    const btnCancel = document.getElementById("btnCancel");

    if (!currentRide) {
      actions.style.display = "none";
      return;
    }

    actions.style.display = "flex";

    const status = (currentRide.status || "").toUpperCase();
    if (CANCELLABLE_STATUSES.includes(status)) {
      btnCancel.disabled = false;
      btnCancel.textContent = "‚ùå Cancel Ride";
    } else {
      btnCancel.disabled = true;
      btnCancel.textContent = "‚ùå Cancel (Not Available)";
    }
  }

  document.getElementById("btnRefresh").addEventListener("click", async () => {
    await loadRides();
    showToast("Status refreshed");
  });

  document.getElementById("btnCancel").addEventListener("click", async () => {
    if (!currentRide) return;
    const status = (currentRide.status || "").toUpperCase();
    if (!CANCELLABLE_STATUSES.includes(status)) {
      showToast("This ride can no longer be cancelled.");
      return;
    }
    if (!confirm("Cancel this ride?")) return;

    try {
      const res = await fetch(API_BOOK + "/api/bookings/" + encodeURIComponent(currentRide.id), {
        method: "PUT",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify({ status:"CANCELLED" })
      });
      if (!res.ok) {
        showToast("Cancel failed.");
        return;
      }
      showToast("Ride cancelled.");
      await loadRides();
    } catch {
      showToast("Cancel failed.");
    }
  });

  // ======================================================
  //  LIVE MAP + ETA (ENROUTE ONLY)
  // ======================================================
  async function updateLiveMapForRide(b) {
    if (!b) {
      hideLiveMap();
      return;
    }

    const status = (b.status || "").toUpperCase();
    const fromAddr = b.pickup && b.pickup.address ? b.pickup.address : "";
    const toAddr   = b.dropoff && b.dropoff.address ? b.dropoff.address : "";

    if (!fromAddr || !toAddr) {
      hideLiveMap();
      return;
    }

    // Ensure services
    if (!geocodeSvc && window.google && google.maps) {
      geocodeSvc = new google.maps.Geocoder();
    }
    if (!liveMap && window.google && google.maps) {
      liveMap = new google.maps.Map(document.getElementById("liveMap"), {
        center: { lat:35.4676, lng:-97.5164 },
        zoom: 11,
        disableDefaultUI:true,
        gestureHandling:"greedy"
      });
      liveDirections = new google.maps.DirectionsService();
    }

    if (!geocodeSvc || !liveMap) {
      hideLiveMap();
      return;
    }

    const pickupLatLng = await geocodeAddressCached(fromAddr);
    const dropLatLng = await geocodeAddressCached(toAddr);

    if (!pickupLatLng || !dropLatLng) {
      hideLiveMap();
      return;
    }

    // Fetch driver location
    let driverLatLng = null;
    try {
      const res = await fetch(LOCATION_API + "?n=" + Date.now(), { cache:"no-store" });
      if (res.ok) {
        const j = await res.json();
        const lat = parseFloat(j.latitude);
        const lng = parseFloat(j.longitude);
        if (!isNaN(lat) && !isNaN(lng)) {
          driverLatLng = { lat, lng };
        }
      }
    } catch {
      // ignore
    }

    const mapDiv = document.getElementById("liveMap");
    const etaLine = document.getElementById("etaLine");
    mapDiv.style.display = "block";

    // Clear old markers
    if (driverMarker) driverMarker.setMap(null);
    if (pickupMarker) pickupMarker.setMap(null);
    if (dropoffMarker) dropoffMarker.setMap(null);

    // Place pickup & dropoff markers
    pickupMarker = new google.maps.Marker({
      position: pickupLatLng,
      map: liveMap,
      label: "P"
    });
    dropoffMarker = new google.maps.Marker({
      position: dropLatLng,
      map: liveMap,
      label: "D"
    });

    const bounds = new google.maps.LatLngBounds();
    bounds.extend(pickupLatLng);
    bounds.extend(dropLatLng);

    let showEta = false;

    // If we have driver + status, incorporate
    if (driverLatLng) {
      driverMarker = new google.maps.Marker({
        position: driverLatLng,
        map: liveMap,
        label: "R"
      });
      bounds.extend(driverLatLng);

      if (status === "ENROUTE") {
        showEta = true;
        await updateEta(driverLatLng, pickupLatLng);
      } else {
        etaLine.style.display = "none";
      }
    } else {
      etaLine.style.display = "none";
    }

    liveMap.fitBounds(bounds);

    // Only ENROUTE gets ETA line; ARRIVED just shows map
    if (status === "ARRIVED") {
      etaLine.style.display = "block";
      etaLine.textContent = "‚úÖ Big Red has arrived at your pickup location.";
    } else if (!showEta) {
      etaLine.style.display = "none";
    }
  }

  async function updateEta(driverLatLng, pickupLatLng) {
    const etaLine = document.getElementById("etaLine");
    etaLine.style.display = "none";

    if (!liveDirections) return;

    try {
      const route = await new Promise((resolve, reject) => {
        liveDirections.route(
          {
            origin: driverLatLng,
            destination: pickupLatLng,
            travelMode: "DRIVING"
          },
          (r, status) => status === "OK" ? resolve(r) : reject(status)
        );
      });

      const leg = route.routes[0].legs[0];
      const minutes = Math.round((leg.duration.value || 0) / 60);
      const safeMin = minutes < 1 ? 1 : minutes;

      etaLine.style.display = "block";
      etaLine.textContent = `üöó Big Red is on the way ‚Äî about ${safeMin} minute${safeMin === 1 ? "" : "s"} out.`;
    } catch {
      etaLine.style.display = "none";
    }
  }

  function hideLiveMap() {
    const mapDiv = document.getElementById("liveMap");
    const etaLine = document.getElementById("etaLine");
    mapDiv.style.display = "none";
    etaLine.style.display = "none";
  }

  function geocodeAddressCached(addr) {
    return new Promise(resolve => {
      if (!addr) return resolve(null);
      if (geocodeCache[addr]) return resolve(geocodeCache[addr]);

      geocodeSvc.geocode({ address: addr }, (res, status) => {
        if (status === "OK" && res[0] && res[0].geometry && res[0].geometry.location) {
          const loc = res[0].geometry.location;
          const obj = { lat: loc.lat(), lng: loc.lng() };
          geocodeCache[addr] = obj;
          resolve(obj);
        } else {
          resolve(null);
        }
      });
    });
  }

  // ======================================================
  //  AUTO REFRESH (30 seconds)
  // ======================================================
  async function initMyRides() {
    await loadRides();
    if (refreshTimer) clearInterval(refreshTimer);
    refreshTimer = setInterval(loadRides, 30000);
  }

  document.addEventListener("DOMContentLoaded", initMyRides);
  </script>
</body>
</html>