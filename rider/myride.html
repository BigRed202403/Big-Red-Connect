<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>My Ride â€“ Big Red Connect</title>

<link rel="apple-touch-icon" href="/icon.PNG">
<link rel="icon" type="image/png" sizes="192x192" href="/icon.PNG">
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#000"/>

<style>
body{margin:0;background:#000;color:#fff;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;padding-bottom:60px}
header{background:#000;padding:12px;border-bottom:2px solid #b30000;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:50}
.logo{height:42px}
#menuBtn{font-size:1.6rem;background:none;border:none;color:white}
#menuPanel{display:none;flex-direction:column;background:#111;border-bottom:2px solid #b30000}
#menuPanel a{padding:16px;color:#fff;text-decoration:none;border-bottom:1px solid #222}
h1{text-align:center;margin:16px 0;font-size:1.4rem}
.card{background:#111;border:1px solid #333;border-radius:12px;padding:14px;margin:12px}
.status{color:#ccc;font-size:.9rem;margin-bottom:6px}
.btn{display:block;margin:10px auto;padding:14px;border-radius:10px;font-weight:700;text-align:center;text-decoration:none}
.btn-primary{background:#b30000;color:#fff}
.btn-secondary{background:#111;border:1px solid #333;color:#fff}
.btn-disabled{opacity:.45;pointer-events:none}
#map{height:320px;margin:12px;border-radius:12px;border:1px solid #333;display:none}
.locked{color:#ffcc66;font-size:.85rem;text-align:center;margin-top:6px}
</style>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCMM0dxLNM7XQI5G3OBSnINeO5hcS3Ks5I&libraries=geometry"></script>
</head>

<body>

<header>
  <a href="/index.html"><img src="/icon.PNG" class="logo"></a>
  <button id="menuBtn">â˜°</button>
</header>

<nav id="menuPanel">
  <a href="/rider/rider.html">Rider Hub</a>
  <a href="/rider/ride-request.html">Request Ride</a>
  <a href="/rider/myride.html">My Ride</a>
  <a href="#" id="logoutBtn">Log Out</a>
</nav>

<h1>My Ride</h1>

<div id="activeRide"></div>
<div id="map"></div>

<h1 style="font-size:1.1rem;margin-top:24px;">Ride History</h1>
<div id="history"></div>

<a href="/rider/ride-request.html" class="btn btn-primary">Request New Ride</a>

<script>
const API="https://bigred-bookings.bigredtransportation.workers.dev";
const STATUS_API="https://bigred-status-updater.bigredtransportation.workers.dev/status";

document.getElementById("menuBtn").onclick=()=>{
  const m=document.getElementById("menuPanel");
  m.style.display=m.style.display==="flex"?"none":"flex";
};
document.getElementById("logoutBtn").onclick=()=>{
  localStorage.clear();
  location.href="/index.html";
};

const riderId=localStorage.getItem("riderId");
let map,driverMarker,pickupMarker,dropoffMarker,routeSvc,routeLine;

function canModify(status){
  return ["REQUESTED","ACCEPTED","ENROUTE","ARRIVED"].includes(status);
}

async function loadRides(){
  const res=await fetch(`${API}/api/driver/bookings?scope=all`);
  const all=await res.json();
  const mine=all.filter(r=>r.rider?.riderId===riderId);
  const active=mine.find(r=>!["COMPLETED","CANCELLED"].includes(r.status));
  renderActive(active);
  renderHistory(mine.filter(r=>["COMPLETED","CANCELLED"].includes(r.status)));
}

function renderActive(r){
  const box=document.getElementById("activeRide");
  if(!r){
    box.innerHTML=`<div class="card">No active ride.</div>`;
    return;
  }

  const locked=!canModify(r.status);

  box.innerHTML=`
    <div class="card">
      <div class="status">Status: ${r.status}</div>
      <div>Pickup: ${r.pickup.address}</div>
      <div>Dropoff: ${r.dropoff.address}</div>

      <a class="btn btn-secondary ${locked?"btn-disabled":""}" href="/rider/ride-request.html?id=${r.id}">
        Edit Ride
      </a>

      <a class="btn btn-secondary ${locked?"btn-disabled":""}" onclick="cancelRide('${r.id}')">
        Cancel Ride
      </a>

      ${locked?`<div class="locked">ðŸ”’ Ride locked once pickup begins</div>`:""}
    </div>
  `;

  drawMap(r);
}

async function cancelRide(id){
  if(!confirm("Cancel this ride?")) return;
  await fetch(`${API}/api/driver/bookings/${id}`,{
    method:"PUT",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({status:"CANCELLED"})
  });
  loadRides();
}

function renderHistory(list){
  const h=document.getElementById("history");
  if(!list.length){
    h.innerHTML=`<div class="card">No past rides.</div>`;
    return;
  }
  h.innerHTML=list.reverse().map(r=>`
    <div class="card">
      <div class="status">${r.status}</div>
      <div>${r.pickup.address} â†’ ${r.dropoff.address}</div>
      <a class="btn btn-secondary" href="/rider/ride-request.html?repeat=${r.id}">
        Re-Request Ride
      </a>
    </div>
  `).join("");
}

async function drawMap(r){
  document.getElementById("map").style.display="block";
  if(!map){
    map=new google.maps.Map(document.getElementById("map"),{zoom:12});
    routeSvc=new google.maps.DirectionsService();
    routeLine=new google.maps.DirectionsRenderer({suppressMarkers:true});
    routeLine.setMap(map);
  }

  const geo=new google.maps.Geocoder();
  const p1=await geo.geocode({address:r.pickup.address});
  const p2=await geo.geocode({address:r.dropoff.address});
  const pickup=p1.results[0].geometry.location;
  const dropoff=p2.results[0].geometry.location;

  pickupMarker=new google.maps.Marker({map,position:pickup,label:"ðŸ“"});
  dropoffMarker=new google.maps.Marker({map,position:dropoff,label:"ðŸ"});

  routeSvc.route({
    origin:pickup,
    destination:dropoff,
    travelMode:"DRIVING"
  },(res,s)=>{
    if(s==="OK") routeLine.setDirections(res);
  });

  pollDriver();
}

async function pollDriver(){
  try{
    const r = await fetch(STATUS_API);
    if(!r.ok) throw new Error("status fetch failed");

    const j = await r.json();

    // ðŸ”’ Guard: location may not exist yet
    if(!j.location || typeof j.location.lat !== "number"){
      console.log("Driver location not available yet");
      setTimeout(pollDriver, 15000);
      return;
    }

    const pos = {
      lat: j.location.lat,
      lng: j.location.lng
    };

    if(!driverMarker){
      driverMarker = new google.maps.Marker({
        map,
        position: pos,
        icon: "https://maps.google.com/mapfiles/kml/shapes/cabs.png"
      });
    } else {
      driverMarker.setPosition(pos);
    }

  } catch(e){
    console.warn("Driver poll error:", e.message);
  }

  setTimeout(pollDriver, 15000);
}

loadRides();
</script>
</body>
</html>