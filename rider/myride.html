<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>My Ride — Big Red Connect</title>

  <link rel="apple-touch-icon" href="../icon.PNG">
  <link rel="icon" type="image/png" sizes="192x192" href="../icon.PNG">
  <meta name="theme-color" content="#000">

  <style>
    body {
      margin:0;
      background:#000;
      color:#fff;
      font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }

    header {
      padding:12px 16px;
      border-bottom:2px solid #b30000;
      position:sticky;
      top:0;
      background:#000;
      z-index:20;
    }

    header h1 {
      margin:0;
      font-size:1.2rem;
      font-weight:700;
    }

    .container {
      padding:16px;
      max-width:600px;
      margin:auto;
    }

    .section-title {
      font-size:1rem;
      font-weight:700;
      margin-top:22px;
      margin-bottom:8px;
    }

    .card {
      background:#111;
      border:1px solid #222;
      border-radius:10px;
      padding:16px;
      margin-bottom:16px;
    }

    .label {
      font-size:.8rem;
      color:#888;
      margin-top:6px;
    }

    .value {
      margin-top:2px;
      font-size:.95rem;
      font-weight:500;
    }

    .vehicle-block {
      display:flex;
      align-items:center;
      gap:12px;
      margin-top:12px;
    }

    .vehicle-thumb {
      width:65px;
      border-radius:8px;
      border:1px solid #333;
    }

    .btn-primary {
      width:100%;
      padding:14px;
      background:#b30000;
      border:none;
      border-radius:10px;
      color:#fff;
      font-weight:700;
      font-size:1rem;
      margin-top:20px;
      cursor:pointer;
    }

    .btn-primary:active { transform:scale(.98); }

    .back-link {
      display:block;
      color:#bbb;
      text-decoration:none;
      font-size:.9rem;
      margin-bottom:20px;
    }

    footer {
      text-align:center;
      margin-top:35px;
      margin-bottom:25px;
      color:#666;
      font-size:.8rem;
    }
  </style>
</head>

<body>
<header>
  <h1>My Ride</h1>
</header>

<div class="container">

  <a class="back-link" href="rider.html">← Back to Rider Hub</a>

  <div id="activeRide"></div>

  <div class="section-title">Past Rides</div>
  <div id="pastRides"></div>

</div>

<footer>&copy; 2025 Big Red Connect</footer>

<script>
const API = "https://bigred-bookings.bigredtransportation.workers.dev";

// Identify ride from URL or saved
function getRideId() {
  const url = new URL(window.location.href);
  const id = url.searchParams.get("id");
  if (id) {
    localStorage.setItem("lastRideId", id);
    return id;
  }
  return localStorage.getItem("lastRideId");
}

// Fetch single ride
async function fetchRide(id) {
  const res = await fetch(`${API}/api/bookings?id=${id}&t=${Date.now()}`);
  if (!res.ok) return null;
  return res.json();
}

// Fetch past rides (completed/cancelled)
async function fetchPast(phone) {
  const res = await fetch(`${API}/api/bookings?riderPhone=${encodeURIComponent(phone)}`);
  if (!res.ok) return [];
  const all = await res.json();
  return all.filter(r => ["COMPLETED","CANCELLED"].includes(r.status));
}

function renderActive(ride) {
  if (!ride) {
    document.getElementById("activeRide").innerHTML =
      `<div class="card">No active ride.</div>`;
    return;
  }

  const vehicle = ride.vehicle ? `
      <div class="vehicle-block">
        <img src="${ride.vehicle.image}" class="vehicle-thumb">
        <div>
          <div class="label">Vehicle</div>
          <div class="value">${ride.vehicle.label}</div>
        </div>
      </div>
    ` : `
      <div class="label" style="margin-top:12px;">Vehicle</div>
      <div class="value">Not assigned yet</div>
    `;

  const mapsLink = `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(ride.pickup.address)}&destination=${encodeURIComponent(ride.dropoff.address)}`;

  document.getElementById("activeRide").innerHTML = `
    <div class="card">
      <div class="label">Status</div>
      <div class="value">${ride.status}</div>

      <div class="label">Pickup</div>
      <div class="value">${ride.pickup.address}</div>

      <div class="label">Dropoff</div>
      <div class="value">${ride.dropoff.address}</div>

      <div class="label">Map</div>
      <div class="value">
        <a href="${mapsLink}" target="_blank" style="color:#ffcc66;text-decoration:none;">
          Open Route in Google Maps →
        </a>
      </div>

      <div class="label">ETA</div>
      <div class="value" id="etaText">${ride.status === "ENROUTE" ? "Updating…" : "—"}</div>

      ${vehicle}

    </div>
  `;
}

function renderPast(list) {
  const box = document.getElementById("pastRides");
  box.innerHTML = "";

  if (!list.length) {
    box.innerHTML = `<div class="card">No past rides.</div>`;
    return;
  }

  list.sort((a, b) => (b.updatedAt || "").localeCompare(a.updatedAt || ""));

  list.forEach(r => {
    const v = r.vehicle?.label ? r.vehicle.label : "—";
    const s = r.status === "COMPLETED" ? "Completed" : "Cancelled";

    box.innerHTML += `
      <div class="card">
        <div class="label">Status</div>
        <div class="value">${s}</div>

        <div class="label">From</div>
        <div class="value">${r.pickup.address}</div>

        <div class="label">To</div>
        <div class="value">${r.dropoff.address}</div>

        <div class="label">Vehicle</div>
        <div class="value">${v}</div>
      </div>
    `;
  });
}

async function update() {
  const id = getRideId();
  if (!id) {
    document.getElementById("activeRide").innerHTML =
      `<div class="card">No ride found.</div>`;
    return;
  }

  const ride = await fetchRide(id);
  renderActive(ride);

  const phone = ride?.rider?.phone || localStorage.getItem("riderPhone");
  if (phone) {
    const past = await fetchPast(phone);
    renderPast(past);
  }
}

update();
setInterval(update, 12000);
</script>

</body>
</html>