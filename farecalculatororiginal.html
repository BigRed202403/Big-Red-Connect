<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Fare Calculator ‚Äì Big Red Connect</title>

  <!-- üé® Styles -->
  <link rel="stylesheet" href="style.css">

  <!-- ‚úàÔ∏è Google Maps -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCMM0dxLNM7XQI5G3OBSnINeO5hcS3Ks5I&libraries=places,geometry" async defer></script>
</head>
<body>

  <!-- üîª Header -->
  <div class="hero small"></div>
  <h1>Fare Calculator</h1>
  <div id="status-pill" class="status status--loading">Checking status‚Ä¶</div>

  <p class="lead">
    Type an address or business (e.g. <em>Campus Corner</em>, <em>Riverwind Casino</em>)  
    ‚Äî or tap the pin to use your current location.
  </p>

  <!-- üßÆ Embedded calculator -->
  <iframe src="farecalc_embed.html" width="100%" height="720"
    style="border:2px solid #c40000; border-radius:10px;"></iframe>

  <!-- ü¶∂ Footer -->
  <footer>
    <p>&copy; 2025 Big Red Connect ‚Äî 
      <a href="index.html">Home</a> |
      <a href="live.html">Live Map</a>
    </p>
  </footer>

  <!-- üîÑ Status Script -->
  <script src="status.js"></script>

  <!-- üß≠ Smart Default Location Logic -->
  <script>
  (function(){
    // ‚úÖ Big Red HQ coordinates (accurate)
    const HQ = { lat: 35.31953, lng: -97.51199 };
    const WORKER_URL = "https://falling-night-3e4d.bigredtransportation.workers.dev";

    // üåç Fetch live driver location from Cloudflare Worker
    async function getDriverLocation() {
      try {
        const r = await fetch(WORKER_URL, { cache: "no-store" });
        const j = await r.json();
        if (j.latitude && j.longitude) {
          return { lat: +j.latitude, lng: +j.longitude };
        }
      } catch (err) {
        console.warn("‚ö†Ô∏è Live location fetch failed:", err);
      }
      return null;
    }

    // üß† Choose reference point based on status
    async function getActiveReference() {
      const status = localStorage.getItem("bigred_status") || "offline";
      if (status === "online") {
        const live = await getDriverLocation();
        if (live) return live;
      }
      return HQ; // fallback if offline/away or fetch fails
    }

    // üíæ Store reference point for embedded calculator
    (async () => {
      const ref = await getActiveReference();
      localStorage.setItem("brc_ref_lat", ref.lat.toFixed(5));
      localStorage.setItem("brc_ref_lng", ref.lng.toFixed(5));
      console.log(`üìç Reference set ‚Üí ${ref.lat}, ${ref.lng}`);
    })();
  })();
  </script>

</body>
</html>