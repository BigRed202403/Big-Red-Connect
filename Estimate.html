<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ride Estimate ‚Äì Big Red Connect</title>

  <!-- üì± PWA / Icons -->
  <link rel="apple-touch-icon" href="official_logo.jpeg">
  <link rel="icon" type="image/png" sizes="192x192" href="official_logo.jpeg">
  <link rel="shortcut icon" href="official_logo.jpeg">
  <link rel="manifest" href="manifest.json">
  <meta name="apple-mobile-web-app-title" content="Big Red Connect">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="theme-color" content="#000000">

  <!-- No cache -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <link rel="stylesheet" href="style.css" />
</head>

<body>

  <!-- Header -->
  <div class="logo-header">
    <a href="index.html" title="Return to Home">
      <img src="official_logo.jpeg" alt="Big Red Connect Logo" style="cursor:pointer;" />
    </a>
  </div>

  <!-- Centered Home Button -->
  <div class="top-home-btn" style="text-align:center; margin-top:10px; margin-bottom:10px;">
    <a href="index.html" class="btn secondary">üè† Home</a>
  </div>

  <h1>Ride Estimate</h1>
  <p class="tagline">Get a quick flat-rate estimate ‚Äî request on the next screen if you want to lock it in.</p>

  <div id="status-pill" class="status">Checking status‚Ä¶</div>

  <section class="info-section calculator">

    <!-- ‚úÖ WHEN (Optional) ‚Äî softened, no "on demand" feel -->
    <div id="whenControls" style="margin-bottom:14px;">
      <label for="reserveDate">Date (optional)</label>
      <input id="reserveDate" type="date" />

      <label for="reserveTime" style="margin-top:10px;">Time (optional)</label>
      <!-- ‚úÖ iOS Safari ignores step for <input type="time"> in many cases.
           Using a 15-min dropdown for consistent behavior. -->
      <select id="reserveTime">
        <option value="">Select a time</option>
      </select>

      <label for="planBy" style="margin-top:10px;">Plan By</label>
      <select id="planBy">
        <option value="pickup">Pickup Time</option>
        <option value="dropoff">Drop-Off Time</option>
      </select>

      <div id="reserveHint" style="color:#ccc;font-size:0.9em;margin:6px 0 10px;">
        Add a date/time if you have one. Rush hour auto-applies if pickup is a weekday 5‚Äì9 AM or 3‚Äì7 PM.
      </div>
    </div>

    <!-- Pickup -->
    <label for="pickup">Pickup Location</label>
    <input id="pickup" type="text" placeholder="Enter pickup address or place" />
    <button id="useLocPickup" class="btn primary" type="button" style="margin-top:8px;">
      üìç Use My Location for Pickup
    </button>

    <!-- Stops -->
    <div id="stopsWrap"></div>
    <button id="addStopBtn" class="btn primary" type="button">‚ûï Add Stop</button>

    <!-- Dropoff -->
    <label for="dropoff">Drop-off Location</label>
    <input id="dropoff" type="text" placeholder="Enter drop-off address or place" />
    <button id="useLocDrop" class="btn secondary" type="button" style="margin-top:8px;">
      üìç Use My Location for Drop-off
    </button>

    <!-- Map -->
    <div id="map" style="height:250px;margin-top:15px;border-radius:10px;"></div>

    <!-- Notes -->
    <div id="airport-note"></div>
    <div id="event-note"></div>
    <div id="rushhour-note"></div>
    <div id="fairness-note"></div>

    <!-- Under-the-hood trip type selector (for internal logic) -->
    <select id="tripType" style="display:none;">
      <option value="10">Standard ($10 base)</option>
      <option value="15">Rush Hour ($15 base)</option>
      <option value="15_airport">Airport ($15 base)</option>
      <option value="20">Holiday / Special Event ($20 base)</option>
    </select>

    <!-- Payment -->
    <label for="payment">Payment Method</label>
    <select id="payment">
      <option value="cash">Cash / Venmo / Cash App (no fees)</option>
      <option value="card">Card (+3.3% booking + 2.4% fuel)</option>
    </select>

    <!-- Calculate CTA -->
    <button class="btn primary" id="calcBtn" type="button" style="display:block;margin:20px auto;">
      üí≤ Get Ride Estimate
    </button>

    <!-- Text RED fallback -->
    <div id="text-red-wrapper" style="margin-top:10px;text-align:center;">
      <a href="sms:+14053784024?&body=Hey%20Big%20Red%20%E2%80%94%20I%E2%80%99d%20like%20to%20plan%20a%20ride%20connection." class="btn secondary">
        üì≤ Text RED
      </a>
    </div>

    <!-- Result -->
    <div id="result" style="display:none;"></div>

    <!-- Track My Ride helper -->
    <p class="smallnote" style="margin-top:12px;">
      Already booked? You can <a href="/rider/myride.html" style="color:#ff4444;">track your ride</a> with your ride ID.
    </p>

    <p class="disclaimer">
      *Estimates only. Final fare may vary slightly based on route or wait time.
    </p>
  </section>

  <footer>
    <p>&copy; 2025 Big Red Connect ‚Äî <a href="index.html">Return to Home</a></p>
  </footer>

  <!-- Status pill logic -->
  <script src="status.js"></script>

  <script>
  // ======================================================
  //  CONFIG
  // ======================================================
  const HQ = { lat: 35.3207, lng: -97.4929 }; // Moore HQ

  // ‚úÖ CHANGE (Option A): Pull driver origin from status API for fairness
  const STATUS_API = "https://bigred-status-updater.bigredtransportation.workers.dev/status";
  let fairnessOrigin = { ...HQ };

  // ‚úÖ Request page (correct, with .html)
  const REQUEST_PAGE = "/rider/ride-request.html";

  // ‚úÖ "Soft login" page (collect name + phone, then route to request)
  const RIDER_DETAILS_PAGE = "/rider-login.html";

  // ------------------------------------------------------
  // Handoff helpers (session + local backup)
  // ------------------------------------------------------
  function stashDropoffHandoff(dest) {
    try { sessionStorage.setItem("brc_dropoff_handoff", dest); } catch (e) {}
    try { localStorage.setItem("brc_dropoff_handoff", dest); } catch (e) {}
  }
  function stashPickupHandoff(src) {
    try { sessionStorage.setItem("brc_pickup_handoff", src); } catch (e) {}
    try { localStorage.setItem("brc_pickup_handoff", src); } catch (e) {}
  }

  function readIncomingDestination() {
    try {
      const u = new URL(window.location.href);
      return (u.searchParams.get("destination") || u.searchParams.get("dropoff") || "").trim();
    } catch (e) { return ""; }
  }
  function readStashedDestination() {
    try {
      return (sessionStorage.getItem("brc_dropoff_handoff") || localStorage.getItem("brc_dropoff_handoff") || "").trim();
    } catch (e) { return ""; }
  }

  // ‚úÖ Rider helpers
  function getRiderName() {
    return (localStorage.getItem("riderName") || "").trim();
  }
  function ensureRiderNameSoft() {
    // For SMS only: ask name if missing, but don't force phone/profile.
    let name = getRiderName();
    if (name) return name;

    const typed = (prompt("Quick question ‚Äî what‚Äôs your name?") || "").trim();
    if (!typed) return "";

    localStorage.setItem("riderName", typed);
    // keep profile blob in sync if it exists (best effort, no schema changes)
    try {
      const raw = localStorage.getItem("bigred_rider_profile_v1");
      if (raw) {
        const p = JSON.parse(raw);
        if (p && typeof p === "object") {
          p.name = typed;
          localStorage.setItem("bigred_rider_profile_v1", JSON.stringify(p));
        }
      }
    } catch(e){}

    return typed;
  }

  // ======================================================
  // ‚úÖ CHANGE (Option A): Fetch current driver origin for fairness
  // ======================================================
  async function fetchDriverOrigin() {
    try {
      const res = await fetch(STATUS_API, { cache: "no-store" });
      if (!res.ok) return;
      const data = await res.json();
      if (data && data.location && typeof data.location.lat === "number" && typeof data.location.lng === "number") {
        fairnessOrigin = { lat: data.location.lat, lng: data.location.lng };
      }
    } catch (e) {
      // non-blocking
    }
  }

  // ======================================================
  // ‚úÖ 15-MIN TIME OPTIONS + SMART DEFAULTS
  // ======================================================
  function pad2(n){ return String(n).padStart(2,"0"); }
  function to12hLabel(h, m){
    const ampm = h >= 12 ? "PM" : "AM";
    const hh = ((h + 11) % 12) + 1;
    return `${hh}:${pad2(m)} ${ampm}`;
  }

  function buildTimeOptions15(){
    const sel = document.getElementById("reserveTime");
    if (!sel) return;

    // keep the first placeholder option, clear anything else
    while (sel.options.length > 1) sel.remove(1);

    for (let h = 0; h < 24; h++){
      for (let m = 0; m < 60; m += 15){
        const val = `${pad2(h)}:${pad2(m)}`;
        const opt = document.createElement("option");
        opt.value = val;
        opt.textContent = to12hLabel(h, m);
        sel.appendChild(opt);
      }
    }
  }

  function nextQuarterTimeHHMM(now = new Date()){
    const d = new Date(now);
    d.setSeconds(0); d.setMilliseconds(0);
    const mins = d.getMinutes();
    const next = Math.ceil((mins + 1) / 15) * 15; // always at least +1 min, then round up to quarter hour
    d.setMinutes(next);
    if (d.getMinutes() === 60) { d.setMinutes(0); d.setHours(d.getHours() + 1); }
    return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
  }

  function yyyymmdd(dateObj){
    const yyyy = dateObj.getFullYear();
    const mm = pad2(dateObj.getMonth()+1);
    const dd = pad2(dateObj.getDate());
    return `${yyyy}-${mm}-${dd}`;
  }

  // ‚úÖ Smart default rule:
  // - If after 11:30 PM ‚Üí date tomorrow, time 00:15
  // - Else ‚Üí date today, time next quarter hour
  function initSmartDefaultSchedule(){
    const dateEl = document.getElementById("reserveDate");
    const timeEl = document.getElementById("reserveTime");
    if (!dateEl || !timeEl) return;

    // Only set defaults if user hasn't set them
    const hasDate = !!String(dateEl.value || "").trim();
    const hasTime = !!String(timeEl.value || "").trim();

    if (hasDate && hasTime) return;

    const now = new Date();
    const isAfter1130 = (now.getHours() > 23) || (now.getHours() === 23 && now.getMinutes() >= 30);

    if (!hasDate) {
      const d = new Date(now);
      if (isAfter1130) d.setDate(d.getDate() + 1);
      dateEl.value = yyyymmdd(d);
    }

    if (!hasTime) {
      timeEl.value = isAfter1130 ? "00:15" : nextQuarterTimeHHMM(now);
    }
  }

  // Holiday info ‚Äî only actual holiday days
  function getHolidayInfo(d) {
    if (!(d instanceof Date) || isNaN(d)) return null;

    const m = d.getMonth();   // 0 = Jan
    const day = d.getDate();
    const weekday = d.getDay(); // 0=Sun, 4=Thu

    // Thanksgiving: 4th Thursday of November
    if (m === 10 && weekday === 4) { // November, Thursday
      const nth = Math.floor((day - 1) / 7) + 1;
      if (nth === 4) {
        return { code:"thanksgiving", label:"Thanksgiving", message:"ü¶É Happy Thanksgiving! Holiday base ($20) applies for Thanksgiving rides." };
      }
    }

    if (m === 11 && day === 24) return { code:"christmas_eve", label:"Christmas Eve", message:"üéÑ Merry Christmas Eve! Holiday base ($20) applies for Christmas Eve rides." };
    if (m === 11 && day === 25) return { code:"christmas_day", label:"Christmas Day", message:"üéÑ Merry Christmas! Holiday base ($20) applies for Christmas Day rides." };
    if (m === 11 && day === 31) return { code:"new_years_eve", label:"New Year's Eve", message:"üéâ Happy New Year's Eve! Holiday base ($20) applies for New Year's Eve rides." };
    if (m === 0  && day === 1)  return { code:"new_years_day", label:"New Year's Day", message:"üéâ Happy New Year! Holiday base ($20) applies for New Year's Day rides." };

    return null;
  }

  function isWeekdayRushHour(d) {
    const day = d.getDay(); // 0=Sun
    const h = d.getHours();
    if (day === 0 || day === 6) return false; // weekend
    return (h >= 5 && h < 9) || (h >= 15 && h < 19);
  }

  const SPECIAL_EVENT_KEYWORDS = [
    "paycom center","riverwind casino","lucky star",
    "gaylord family oklahoma memorial stadium","boone pickens stadium",
    "chickasaw bricktown ballpark","memorial stadium","ou stadium","osu stadium"
  ];

  function isAirportTrip(text) {
    if (!text) return false;
    const t = text.toLowerCase();
    return t.includes("airport") || t.includes("will rogers");
  }

  // ======================================================
  //  STATE
  // ======================================================
  let mode = "now";
  let map, geocoder, directionsService, directionsRenderer;
  let pickupLatLng = null, dropoffLatLng = null;
  let pickupMarker = null, dropoffMarker = null;
  let stopInputs = [];

  // ======================================================
  //  GOOGLE + PAGE INIT
  // ======================================================
  window.initGoogle = function () {
    geocoder = new google.maps.Geocoder();
    directionsService = new google.maps.DirectionsService();
    directionsRenderer = new google.maps.DirectionsRenderer({ suppressMarkers: true });

    map = new google.maps.Map(document.getElementById("map"), {
      center: { lat: 35.4676, lng: -97.5164 },
      zoom: 11,
      disableDefaultUI: true,
      gestureHandling: "greedy",
      styles: [
        { elementType: "geometry", stylers: [{ color: "#1a1a1a" }] },
        { elementType: "labels.text.stroke", stylers: [{ color: "#1a1a1a" }] },
        { elementType: "labels.text.fill", stylers: [{ color: "#ffffff" }] },
        { featureType: "poi", elementType: "geometry", stylers: [{ color: "#111" }] }
      ]
    });

    directionsRenderer.setMap(map);

    setupAutocomplete("pickup", true);
    setupAutocomplete("dropoff", false);

    document.getElementById("calcBtn").onclick = calculateFare;
    document.getElementById("addStopBtn").onclick = addStopField;
    document.getElementById("useLocPickup").onclick = () => useMyLocation("pickup");
    document.getElementById("useLocDrop").onclick = () => useMyLocation("dropoff");

    // ‚úÖ build 15-min time options (iOS-safe)
    buildTimeOptions15();

    // ‚úÖ SMART DEFAULTS (after options exist)
    initSmartDefaultSchedule();

    // ‚úÖ Re-evaluate pricing notes when date/time changes
    const dEl = document.getElementById("reserveDate");
    const tEl = document.getElementById("reserveTime");
    const pBy = document.getElementById("planBy");
    if (dEl) dEl.addEventListener("change", applyAutoRateLabels);
    if (tEl) tEl.addEventListener("change", applyAutoRateLabels);
    if (pBy) pBy.addEventListener("change", applyAutoRateLabels);

    // ‚úÖ Prefill dropoff if coming from index (destination handoff)
    const incoming = readIncomingDestination() || readStashedDestination();
    if (incoming) {
      const dEl2 = document.getElementById("dropoff");
      if (dEl2 && !String(dEl2.value||"").trim()) dEl2.value = incoming;
    }

    // ‚úÖ CHANGE (Option A): load driver origin early (non-blocking)
    fetchDriverOrigin();

    applyAutoRateLabels();
  };

  // ======================================================
  //  AUTOCOMPLETE
  // ======================================================
  function setupAutocomplete(id, isPickup) {
    const input = document.getElementById(id);
    if (!input) return null;

    const okcBounds = new google.maps.LatLngBounds(
      { lat: 34.9000, lng: -98.2000 },
      { lat: 36.0000, lng: -96.0000 }
    );

    const options = {
      bounds: okcBounds,
      strictBounds: false,
      componentRestrictions: { country: "us" },
      fields: ["formatted_address", "geometry.location", "name", "place_id"]
    };

    const ac = new google.maps.places.Autocomplete(input, options);

    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        pos => {
          try {
            const loc = new google.maps.LatLng(pos.coords.latitude, pos.coords.longitude);
            const biasBounds = new google.maps.LatLngBounds(loc, loc);
            ac.setBounds(biasBounds);
          } catch (e) {}
        },
        ()=>{},
        { enableHighAccuracy: true, maximumAge: 15000, timeout: 8000 }
      );
    }

    ac.addListener("place_changed", () => {
      const p = ac.getPlace();
      if (!p || !p.geometry) return;

      const loc = p.geometry.location;
      const lat = loc.lat();
      const lng = loc.lng();

      if (isPickup) {
        pickupLatLng = loc;
        if (pickupMarker) pickupMarker.setMap(null);
        pickupMarker = new google.maps.Marker({
          position: { lat, lng },
          map,
          icon: { url: "http://maps.google.com/mapfiles/ms/icons/green-dot.png" }
        });
      } else {
        dropoffLatLng = loc;
        if (dropoffMarker) dropoffMarker.setMap(null);
        dropoffMarker = new google.maps.Marker({
          position: { lat, lng },
          map,
          icon: { url: "http://maps.google.com/mapfiles/ms/icons/red-dot.png" }
        });
      }

      map.panTo({ lat, lng });
      applyAutoRateLabels();
      updateFairnessPreview();
    });

    return ac;
  }

  // ======================================================
  //  STOPS
  // ======================================================
  function addStopField() {
    if (stopInputs.length >= 3) { alert("Limit 3 stops."); return; }
    const id = "stop_" + Date.now();
    stopInputs.push(id);

    const wrap = document.getElementById("stopsWrap");
    const div = document.createElement("div");
    div.className = "stop-row";
    div.id = "row_" + id;
    div.innerHTML = `
      <label>Stop ${stopInputs.length}</label>
      <div style="display:flex; gap:6px; align-items:center;">
        <input id="${id}" type="text" placeholder="Enter stop address or place" style="flex:1;">
        <button type="button" class="remove-stop" onclick="removeStop('${id}')">‚úñ</button>
      </div>
    `;
    wrap.appendChild(div);

    setupAutocomplete(id, false);
  }

  function removeStop(id) {
    const row = document.getElementById("row_" + id);
    if (row) row.remove();
    stopInputs = stopInputs.filter(x => x !== id);
  }
  window.removeStop = removeStop;

  // ======================================================
  //  GPS PICKUP/DROPOFF
  // ======================================================
  function useMyLocation(which) {
    if (!navigator.geolocation) { alert("Location services not supported."); return; }

    navigator.geolocation.getCurrentPosition(
      pos => {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        const latlng = { lat, lng };

        geocoder.geocode({ location: latlng }, (res, stat) => {
          const addr = (stat === "OK" && res[0]) ? res[0].formatted_address : `${lat.toFixed(5)}, ${lng.toFixed(5)}`;
          const input = document.getElementById(which);
          input.value = addr;

          if (which === "pickup") {
            pickupLatLng = new google.maps.LatLng(lat, lng);
            if (pickupMarker) pickupMarker.setMap(null);
            pickupMarker = new google.maps.Marker({ position: latlng, map, icon: { url: "http://maps.google.com/mapfiles/ms/icons/green-dot.png" } });
          } else {
            dropoffLatLng = new google.maps.LatLng(lat, lng);
            if (dropoffMarker) dropoffMarker.setMap(null);
            dropoffMarker = new google.maps.Marker({ position: latlng, map, icon: { url: "http://maps.google.com/mapfiles/ms/icons/red-dot.png" } });
          }

          map.panTo(latlng);
          applyAutoRateLabels();
          updateFairnessPreview();
        });
      },
      err => alert("Unable to get location: " + err.message),
      { enableHighAccuracy: true, maximumAge: 8000, timeout: 8000 }
    );
  }

  // ======================================================
  //  RATE LOGIC
  // ======================================================
  function getEffectiveDate() {
    // ‚úÖ If date+time are provided, use them. If only date is provided, use noon.
    const dStr = document.getElementById("reserveDate").value;
    const tStr = document.getElementById("reserveTime").value;

    if (dStr && tStr) {
      mode = "reserve";
      return new Date(dStr + "T" + tStr + ":00");
    }
    if (dStr && !tStr) {
      mode = "reserve";
      return new Date(dStr + "T12:00:00");
    }

    mode = "now";
    return new Date();
  }

  function applyAutoRateLabels() {
    const pickupText = (document.getElementById("pickup").value || "").toLowerCase();
    const dropText   = (document.getElementById("dropoff").value || "").toLowerCase();
    const effective  = getEffectiveDate();

    const holidayInfo = getHolidayInfo(effective);
    const rush    = isWeekdayRushHour(effective);
    const airport = isAirportTrip(pickupText) || isAirportTrip(dropText);
    const event   = SPECIAL_EVENT_KEYWORDS.some(k => pickupText.includes(k) || dropText.includes(k));

    if (holidayInfo) document.getElementById("tripType").value = "20";
    else if (event) document.getElementById("tripType").value = "20";
    else if (airport) document.getElementById("tripType").value = "15_airport";
    else if (rush) document.getElementById("tripType").value = "15";
    else document.getElementById("tripType").value = "10";

    const rushNote    = document.getElementById("rushhour-note");
    const airportNote = document.getElementById("airport-note");
    const eventNote   = document.getElementById("event-note");

    rushNote.innerHTML = "";
    airportNote.innerHTML = "";
    eventNote.innerHTML = "";

    if (holidayInfo) eventNote.innerHTML = holidayInfo.message;
    else if (event) eventNote.innerHTML = "üìç Special event location detected ‚Äî Event base ($20) applies.";
    else if (airport) airportNote.innerHTML = "‚úàÔ∏è Airport run detected ‚Äî Airport base ($15) applies.";
    else if (rush) rushNote.innerHTML = "üö¶ Weekday Rush Hour pricing (5‚Äì9 AM / 3‚Äì7 PM).";
  }

  // ======================================================
  //  FAIRNESS FEE
  // ======================================================
  function distMi(a, b) {
    const p1 = new google.maps.LatLng(a.lat, a.lng);
    const p2 = new google.maps.LatLng(b.lat, b.lng);
    return google.maps.geometry.spherical.computeDistanceBetween(p1, p2) / 1609.34;
  }

  function computeFairnessFee(miles, basePlusMiles) {
    if (!pickupLatLng) return 0;
    const pickup = { lat: pickupLatLng.lat(), lng: pickupLatLng.lng() };

    // ‚úÖ CHANGE (Option A): use fairnessOrigin (driver status origin) not HQ-only
    const origin = fairnessOrigin || HQ;
    const d = distMi(origin, pickup);

    let zoneFee = 0;
    if (d > 40) zoneFee = 20;
    else if (d > 20) zoneFee = 10;

    if (zoneFee > 0 && (miles > 20 || basePlusMiles >= 25)) zoneFee = 0;
    return zoneFee;
  }

  function updateFairnessPreview() {
    const note = document.getElementById("fairness-note");
    note.innerHTML = "";
    if (!pickupLatLng) return;

    const pickup = { lat: pickupLatLng.lat(), lng: pickupLatLng.lng() };

    // ‚úÖ CHANGE (Option A): preview based on driver origin
    const origin = fairnessOrigin || HQ;
    const d = distMi(origin, pickup);

    if (d > 40) note.innerHTML = "üìç Pickup is well outside the core metro / current driver area. A travel fairness fee <em>may</em> apply depending on total trip distance.";
    else if (d > 20) note.innerHTML = "üìç Pickup is outside the central zone / current driver area. A small travel fairness fee <em>may</em> apply depending on trip distance.";
  }

  // ======================================================
  //  ROUTE URL BUILDER (GOOGLE MAPS)
  // ======================================================
  function buildRouteUrl(pickup, dropoff, stops) {
    const base = "https://www.google.com/maps/dir/?api=1";
    let url = base + "&origin=" + encodeURIComponent(pickup) + "&destination=" + encodeURIComponent(dropoff);
    if (stops && stops.length > 0) url += "&waypoints=" + encodeURIComponent(stops.join("|"));
    return url;
  }

  // ======================================================
  //  CONTINUE ‚Üí REQUEST PAGE (PWA-safe + full handoff)
  // ======================================================
  function continueToRequestFromLastFare() {
    const q = window.lastFare;
    if (!q) return;

    // Build ONE payload of ride details we can reuse for either path
    const rideParams = new URLSearchParams();

    if (q.pickup)  rideParams.set("pickup", q.pickup);
    if (q.dropoff) rideParams.set("dropoff", q.dropoff);

    (q.stops || []).slice(0, 3).forEach(s => rideParams.append("stop", s));

    if (q.mode)       rideParams.set("mode", q.mode);
    if (q.reserveDate) rideParams.set("reserveDate", q.reserveDate);
    if (q.reserveTime) rideParams.set("reserveTime", q.reserveTime);
    if (q.planBy)     rideParams.set("planBy", q.planBy);

    // Payment + estimate detail
    if (q.pay)        rideParams.set("payment", q.pay);
    if (q.total != null)   rideParams.set("estimate", String(q.total));
    if (q.miles != null)   rideParams.set("miles", String(q.miles));
    if (q.minutes != null) rideParams.set("minutes", String(q.minutes));

    // Helpful origin marker
    rideParams.set("from", "estimate");

    const riderName = getRiderName();

    // If not "soft logged in" yet ‚Üí go to rider-login with ALL ride details included
    if (!riderName) {
      // Keep your existing storage handoff too (belt + suspenders)
      if (q.pickup)  stashPickupHandoff(q.pickup);
      if (q.dropoff) stashDropoffHandoff(q.dropoff);

      const next = new URLSearchParams();
      next.set("next", "ride-request");

      // ‚úÖ include the full ride details on the login hop
      for (const [k, v] of rideParams.entries()) next.append(k, v);

      window.location.href = RIDER_DETAILS_PAGE + "?" + next.toString();
      return;
    }

    // Already has riderName ‚Üí go straight to request with full ride details
    if (q.pickup)  stashPickupHandoff(q.pickup);
    if (q.dropoff) stashDropoffHandoff(q.dropoff);

    window.location.href = REQUEST_PAGE + "?" + rideParams.toString();
  }

  // ======================================================
  //  CALCULATE FARE
  // ======================================================
  async function calculateFare() {
    const pickup = document.getElementById("pickup").value.trim();
    const dropoff = document.getElementById("dropoff").value.trim();
    if (!pickup || !dropoff) { alert("Please enter both pickup and drop-off."); return; }

    const waypoints = stopInputs
      .map(id => {
        const v = document.getElementById(id)?.value.trim();
        return v ? { location: v, stopover: true } : null;
      })
      .filter(Boolean);

    let route;
    try {
      route = await new Promise((resolve, reject) => {
        directionsService.route(
          { origin: pickup, destination: dropoff, waypoints, travelMode: "DRIVING" },
          (r, status) => status === "OK" ? resolve(r) : reject(status)
        );
      });
    } catch (errStatus) {
      alert("Unable to get route from Google Maps. Try adjusting addresses.");
      return;
    }

    directionsRenderer.setDirections(route);

    let miles = 0;
    let minutes = 0;
    route.routes[0].legs.forEach(l => {
      miles   += (l.distance?.value || 0) / 1609.34;
      minutes += (l.duration?.value || 0) / 60;
    });
    miles   = Math.round(miles);
    minutes = Math.round(minutes);

    applyAutoRateLabels();
    const tripTypeValue = document.getElementById("tripType").value;

    let base = 10;
    if (tripTypeValue === "15" || tripTypeValue === "15_airport") base = 15;
    else if (tripTypeValue === "20") base = 20;

    const tier2 = Math.max(0, Math.min(10, miles - 10)) * 1.25;
    const tier3 = Math.max(0, miles - 20) * 1.0;
    const mileageSub = tier2 + tier3;

    const basePlusMiles = base + mileageSub;

    // ‚úÖ CHANGE (Option A): refresh driver origin right before fairness calc
    await fetchDriverOrigin();

    const fairnessFee = computeFairnessFee(miles, basePlusMiles);

    const pay = document.getElementById("payment").value;
    let fare = basePlusMiles + fairnessFee;
    if (pay === "card") fare += fare * 0.033 + fare * 0.024;

    const total = fare.toFixed(2);

    const resDiv = document.getElementById("result");
    resDiv.style.display = "block";
    resDiv.innerHTML = `
      <div class="total">$${total}</div>
      <p><strong>Base:</strong> $${base.toFixed(2)}</p>
      <p><strong>Mileage:</strong> $${mileageSub.toFixed(2)}</p>
      ${fairnessFee > 0 ? `<p><strong>Travel Fairness Fee:</strong> $${fairnessFee.toFixed(2)}</p>` : ""}
      <p><strong>Payment:</strong> ${pay === "card" ? "Card (incl. fees)" : "Cash / Venmo / Cash App"}</p>
      <p>üìè ${miles} mi  ‚è±Ô∏è ${Math.round(minutes)} min</p>

      <p style="text-align:center;margin-top:15px; display:flex; flex-direction:column; gap:10px;">
        <button class="btn primary" id="btnContinue" type="button">‚û°Ô∏è Continue to Request Ride</button>
        <button class="btn secondary" id="btnTextRed" type="button">üì≤ Text RED (No Login)</button>
      </p>

      <p style="text-align:center;color:#ccc;font-size:.9em;margin-top:6px;">
        Tip: ‚ÄúContinue‚Äù lets you save your profile + choose SMS/Push updates.
      </p>
    `;

    const dStr = document.getElementById("reserveDate").value;
    const tStr = document.getElementById("reserveTime").value;
    const derivedMode = (dStr || tStr) ? "reserve" : "now";

    window.lastFare = {
      pickup,
      dropoff,
      miles,
      minutes,
      total: Number(total),
      base,
      mileageSub,
      fairnessFee,
      pay,
      mode: derivedMode,
      stops: stopInputs.map(id => document.getElementById(id)?.value.trim()).filter(Boolean),
      reserveDate: dStr,
      reserveTime: tStr,
      planBy: document.getElementById("planBy").value
    };

    document.getElementById("btnContinue").onclick = continueToRequestFromLastFare;
    document.getElementById("btnTextRed").onclick = sendTextRedFromLastFare;
  }

  function sendTextRedFromLastFare() {
    if (!window.lastFare) { alert("Please calculate your fare first."); return; }
    const q = window.lastFare;

    const riderName = ensureRiderNameSoft();
    if (!riderName) { alert("No worries ‚Äî just add your name so Big Red knows who‚Äôs texting."); return; }

    const stopsText = (q.stops && q.stops.length) ? q.stops.join(" ‚Üí ") : "None";

    let whenText = "Time not specified";
    if (q.reserveDate && q.reserveTime) whenText = `${q.reserveDate} at ${q.reserveTime}`;
    else if (q.reserveDate && !q.reserveTime) whenText = `${q.reserveDate} (time TBD)`;
    else if (!q.reserveDate && q.reserveTime) whenText = `Today at ${q.reserveTime}`;

    const routeUrl = buildRouteUrl(q.pickup, q.dropoff, q.stops || []);

    const smsBody =
      `Hey Big Red, it‚Äôs ${riderName} ‚Äî I‚Äôd like to plan a ride:\n\n` +
      `Pickup: ${q.pickup}\n` +
      `Dropoff: ${q.dropoff}\n` +
      `Stops: ${stopsText}\n` +
      `When: ${whenText}\n` +
      `Estimate: $${q.total}\n` +
      `Miles: ${q.miles}\n` +
      `Route: ${routeUrl}`;

    window.location.href = "sms:+14053784024?&body=" + encodeURIComponent(smsBody);
  }
  </script>

  <!-- ‚úÖ Google Maps (Places + Geometry) -->
  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCMM0dxLNM7XQI5G3OBSnINeO5hcS3Ks5I&libraries=places,geometry&callback=initGoogle"
    defer>
  </script>

</body>
</html>