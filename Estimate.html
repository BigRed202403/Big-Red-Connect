<!-- =========================
FILE 1: /rider/estimate.html (Estimate ‚Äì Big Red Connect)
========================= -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Estimate ‚Äì Big Red Connect</title>

  <!-- Icons / PWA -->
  <link rel="apple-touch-icon" href="/official_logo.jpeg">
  <link rel="icon" type="image/png" sizes="192x192" href="/official_logo.jpeg">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#000000"/>

  <!-- No cache -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
  <meta http-equiv="Pragma" content="no-cache"/>
  <meta http-equiv="Expires" content="0"/>

  <style>
    :root { --red:#b30000; --panel:#111; --border:#222; --muted:#aaa; }
    body { margin:0; background:#000; color:#fff; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif; padding-bottom:60px; }
    header { padding:12px 12px; display:flex; align-items:center; gap:10px; border-bottom:2px solid var(--red); background:#000; position:sticky; top:0; z-index:20; }
    .logo-tap { display:flex; align-items:center; gap:8px; cursor:pointer; }
    header img { height:44px; border-radius:4px; }
    .top-actions { margin-left:auto; display:flex; gap:6px; }
    .btn-small { padding:8px 10px; font-size:0.8rem; }
    h1 { text-align:center; font-size:1.4rem; margin:18px 0 4px; }
    .subhead { text-align:center; font-size:0.85rem; color:var(--muted); margin-bottom:8px; }
    .page { width:calc(100% - 24px); max-width:560px; margin:0 auto; }
    .card { background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:14px; margin-top:10px; }
    .section-title { font-size:0.9rem; font-weight:700; margin-bottom:8px; border-bottom:1px solid #222; padding-bottom:4px; }
    .input-group { margin-bottom:12px; }
    label { display:block; font-size:0.8rem; color:#ccc; margin-bottom:4px; }
    input, select { width:100%; padding:10px; background:#111; border:1px solid #333; border-radius:8px; color:#fff; font-size:0.95rem; }
    .hint { font-size:0.75rem; color:var(--muted); margin-top:2px; }
    .btn { display:inline-block; text-align:center; padding:12px; border-radius:10px; font-weight:700; font-size:0.95rem; border:none; cursor:pointer; text-decoration:none; }
    .btn-primary { background:var(--red); color:#fff; }
    .btn-ghost { background:#000; color:#fff; border:1px solid #444; }
    .btn-secondary { background:#111; color:#fff; border:1px solid #333; }
    .btn-wide { width:100%; margin-top:12px; }
    #map { width:100%; height:220px; border-radius:10px; margin-top:10px; background:#050505; border:1px solid #222; }
    #airport-note, #event-note, #rushhour-note, #fairness-note { font-size:0.8rem; margin:4px 0; }
    #airport-note { color:#9fd4ff; }
    #event-note { color:#ffd27f; }
    #rushhour-note { color:#ffb3b3; }
    #fairness-note { color:#d3b9ff; }
    #result { margin-top:10px; padding:10px; border-radius:10px; background:#080808; border:1px solid #333; font-size:0.9rem; display:none; }
    .total { font-size:1.3rem; font-weight:700; margin-bottom:6px; }
    #toast { position:fixed; bottom:22px; left:50%; transform:translateX(-50%); background:#111; border:1px solid var(--red); padding:10px 18px; border-radius:999px; opacity:0; pointer-events:none; transition:opacity .25s; z-index:99; font-size:0.85rem; }
    #toast.show { opacity:1; }
  </style>
</head>
<body>

<header>
  <div class="logo-tap" id="logoHome">
    <img src="/official_logo.jpeg" alt="Big Red Connect logo">
    <div>
      <div style="font-weight:700;font-size:0.92rem;">Big Red Connect</div>
      <div style="font-size:0.78rem;color:#888;">Estimate</div>
    </div>
  </div>
  <div class="top-actions">
    <button class="btn btn-ghost btn-small" id="btnHub">Rider Hub</button>
  </div>
</header>

<h1>Get an Estimate</h1>
<div class="subhead">Pick your date/time first ‚Äî pricing is based on your scheduled pickup window.</div>

<div class="page">

  <div class="card">
    <div class="section-title">When?</div>

    <div class="input-group">
      <label for="reserveDate">Date</label>
      <input id="reserveDate" type="date">
    </div>

    <div class="input-group">
      <label for="reserveTimeSelect">Time (15-min increments)</label>
      <select id="reserveTimeSelect"></select>
      <div class="hint">Required. Rush hour applies only if the selected time falls in weekday rush windows.</div>
    </div>

    <div class="input-group">
      <label for="planBy">Plan By</label>
      <select id="planBy">
        <option value="pickup">Pickup Time</option>
        <option value="dropoff">Drop-off Time</option>
      </select>
    </div>

    <div class="hint">
      Rush hour auto-applies if weekday 5‚Äì9 AM or 3‚Äì7 PM. Holidays and big events may use special base rates.
    </div>
  </div>

  <div class="card">
    <div class="section-title">Trip</div>

    <div class="input-group">
      <label for="pickup">Pickup Location</label>
      <input id="pickup" type="text" placeholder="Enter pickup address or place">
      <button class="btn btn-secondary btn-wide" id="useLocPickup" type="button">üìç Use My Location</button>
    </div>

    <div class="input-group">
      <label for="dropoff">Drop-off Location</label>
      <input id="dropoff" type="text" placeholder="Enter drop-off address or place">
      <button class="btn btn-secondary btn-wide" id="useLocDrop" type="button">üìç Use My Location</button>
    </div>

    <div id="map"></div>

    <div style="margin-top:10px;">
      <p id="airport-note"></p>
      <p id="event-note"></p>
      <p id="rushhour-note"></p>
      <p id="fairness-note"></p>
    </div>
  </div>

  <div class="card">
    <div class="section-title">Estimate</div>

    <div class="input-group">
      <label for="payment">Payment Method</label>
      <select id="payment">
        <option value="cash">Cash / Venmo / Cash App (no extra fees)</option>
        <option value="card">Card (+3.3% booking + 2.4% fuel)</option>
      </select>
    </div>

    <button class="btn btn-primary btn-wide" id="calcBtn" type="button">üí≤ Get Estimate</button>
    <div id="result"></div>

    <div class="hint" style="text-align:center;margin-top:10px;">
      If this looks good, you can submit the request from the Ride Request page.
    </div>
  </div>

</div>

<div id="toast"></div>

<script>
  // =====================================================
  // CONFIG
  // =====================================================
  const HQ = { lat: 35.3207, lng: -97.4929 };
  const LOCATION_API = "https://update-location.bigredtransportation.workers.dev/";
  let fairnessOrigin = { ...HQ };

  // =====================================================
  // TOAST
  // =====================================================
  function showToast(msg) {
    const t = document.getElementById("toast");
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(() => t.classList.remove("show"), 1800);
  }

  // =====================================================
  // NAV
  // =====================================================
  document.getElementById("logoHome").addEventListener("click", () => window.location.href = "/index.html");
  document.getElementById("btnHub").addEventListener("click", () => window.location.href = "/rider/rider.html");

  // =====================================================
  // 15-min time dropdown + smart defaults (prevents "rush by accident")
  // =====================================================
  function pad2(n){ return String(n).padStart(2,"0"); }

  function build15MinOptions(selectEl){
    if(!selectEl) return;
    selectEl.innerHTML = "";
    for(let h=0; h<24; h++){
      for(let m=0; m<60; m+=15){
        const v = `${pad2(h)}:${pad2(m)}`;
        const opt = document.createElement("option");
        opt.value = v;
        opt.textContent = v;
        selectEl.appendChild(opt);
      }
    }
  }

  function getSmartDefaultSchedule(now = new Date()){
    const d = new Date(now);
    d.setSeconds(0); d.setMilliseconds(0);

    const isLate = (d.getHours() === 23 && d.getMinutes() >= 30);
    if (isLate) {
      const tomorrow = new Date(d);
      tomorrow.setDate(tomorrow.getDate() + 1);
      return {
        date: `${tomorrow.getFullYear()}-${pad2(tomorrow.getMonth()+1)}-${pad2(tomorrow.getDate())}`,
        time: "00:15"
      };
    }

    const next = new Date(d);
    const mins = next.getMinutes();
    const rounded = Math.ceil((mins + 1) / 15) * 15;
    next.setMinutes(rounded);
    if (next.getMinutes() === 60) { next.setMinutes(0); next.setHours(next.getHours()+1); }

    return {
      date: `${next.getFullYear()}-${pad2(next.getMonth()+1)}-${pad2(next.getDate())}`,
      time: `${pad2(next.getHours())}:${pad2(next.getMinutes())}`
    };
  }

  function initDefaultScheduleIfEmpty(){
    const dateEl = document.getElementById("reserveDate");
    const timeEl = document.getElementById("reserveTimeSelect");
    if(!dateEl || !timeEl) return;

    const dateVal = (dateEl.value || "").trim();
    const timeVal = (timeEl.value || "").trim();

    // ‚úÖ Key: never allow blank/00:00 to fall back to "now"
    if (!dateVal || !timeVal || timeVal === "00:00") {
      const smart = getSmartDefaultSchedule(new Date());
      if (!dateVal) dateEl.value = smart.date;
      if (!timeVal || timeVal === "00:00") timeEl.value = smart.time;
    }
  }

  function getReserveTimeValue(){
    return (document.getElementById("reserveTimeSelect")?.value || "").trim();
  }

  // =====================================================
  // Option B: fetch live driver origin from update-location
  // =====================================================
  async function fetchDriverOriginFromLiveGPS() {
    try {
      const res = await fetch(LOCATION_API + "?t=" + Date.now(), { cache: "no-store" });
      if (!res.ok) return;

      const data = await res.json();
      const lat = Number(data?.lat ?? data?.latitude);
      const lng = Number(data?.lng ?? data?.longitude);

      if (Number.isFinite(lat) && Number.isFinite(lng)) {
        fairnessOrigin = { lat, lng };
      }
    } catch (e) {
      console.warn("Live GPS origin fetch failed; using HQ", e);
    }
  }

  // =====================================================
  // HOLIDAY / RUSH / EVENT / AIRPORT (same rules as ride-request)
  // =====================================================
  function getHolidayInfo(d) {
    if (!(d instanceof Date) || isNaN(d)) return null;
    const m = d.getMonth();
    const day = d.getDate();
    const weekday = d.getDay();

    if (m === 10 && weekday === 4) {
      const nth = Math.floor((day - 1) / 7) + 1;
      if (nth === 4) return { code: "thanksgiving", message: "ü¶É Holiday base ($20) applies for Thanksgiving rides." };
    }
    if (m === 11 && day === 24) return { code:"christmas_eve", message:"üéÑ Christmas Eve ‚Äì Holiday base ($20) applies." };
    if (m === 11 && day === 25) return { code:"christmas_day", message:"üéÑ Christmas Day ‚Äì Holiday base ($20) applies." };
    if (m === 11 && day === 31) return { code:"nye", message:"üéâ New Year's Eve ‚Äì Holiday base ($20) applies." };
    if (m === 0  && day === 1)  return { code:"nyd", message:"üéâ New Year's Day ‚Äì Holiday base ($20) applies." };
    return null;
  }

  function isWeekdayRushHour(d) {
    const day = d.getDay();
    const h = d.getHours();
    if (day === 0 || day === 6) return false;
    return (h >= 5 && h < 9) || (h >= 15 && h < 19);
  }

  const SPECIAL_EVENT_KEYWORDS = [
    "paycom center",
    "riverwind casino",
    "lucky star",
    "gaylord family oklahoma memorial stadium",
    "boone pickens stadium",
    "chickasaw bricktown ballpark",
    "memorial stadium",
    "ou stadium",
    "osu stadium"
  ];

  function getEffectiveDate() {
    // ‚úÖ Must be based on selected date/time only
    const dStr = document.getElementById("reserveDate").value;
    const tStr = getReserveTimeValue();
    if (dStr && tStr) return new Date(dStr + "T" + tStr + ":00");
    return null; // ‚úÖ do NOT fall back to "now"
  }

  function isAirportText(s) {
    const t = String(s || "").toLowerCase();
    return t.includes("airport") || t.includes("will rogers");
  }

  function applyAutoRateLabels() {
    const pickupText = (document.getElementById("pickup").value || "").toLowerCase();
    const dropText   = (document.getElementById("dropoff").value || "").toLowerCase();

    const effective = getEffectiveDate();

    const rushNote    = document.getElementById("rushhour-note");
    const airportNote = document.getElementById("airport-note");
    const eventNote   = document.getElementById("event-note");

    rushNote.textContent = "";
    airportNote.textContent = "";
    eventNote.textContent = "";

    if (!effective) return { baseType:"standard", base:10 }; // should not happen if required

    const rush    = isWeekdayRushHour(effective);
    const airport = isAirportText(pickupText) || isAirportText(dropText);
    const event   = SPECIAL_EVENT_KEYWORDS.some(k => pickupText.includes(k) || dropText.includes(k));
    const holidayInfo = getHolidayInfo(effective);

    if (holidayInfo) { eventNote.textContent = holidayInfo.message; return { baseType: "holiday", base: 20 }; }
    if (event) { eventNote.textContent = "üìç Special event area ‚Äì Event base ($20) may apply."; return { baseType: "event", base: 20 }; }
    if (airport) { airportNote.textContent = "‚úàÔ∏è Airport run ‚Äì Airport base ($15) applies."; return { baseType: "airport", base: 15 }; }
    if (rush) { rushNote.textContent = "üö¶ Weekday Rush Hour (5‚Äì9 AM / 3‚Äì7 PM)."; return { baseType: "rush", base: 15 }; }

    return { baseType: "standard", base: 10 };
  }

  // =====================================================
  // MAPS + AUTOCOMPLETE
  // =====================================================
  let map, geocoder, directionsService, directionsRenderer;
  let pickupLatLng = null, dropoffLatLng = null;
  let pickupMarker = null, dropoffMarker = null;

  function setMarker(which, lat, lng) {
    const latlng = { lat, lng };
    if (which === "pickup") {
      pickupLatLng = new google.maps.LatLng(lat, lng);
      if (pickupMarker) pickupMarker.setMap(null);
      pickupMarker = new google.maps.Marker({ position: latlng, map, icon: { url: "http://maps.google.com/mapfiles/ms/icons/green-dot.png" } });
    } else if (which === "dropoff") {
      dropoffLatLng = new google.maps.LatLng(lat, lng);
      if (dropoffMarker) dropoffMarker.setMap(null);
      dropoffMarker = new google.maps.Marker({ position: latlng, map, icon: { url: "http://maps.google.com/mapfiles/ms/icons/red-dot.png" } });
    }
  }

  function setupAutocomplete(id, role) {
    const input = document.getElementById(id);
    if (!input) return null;

    const okcBounds = new google.maps.LatLngBounds(
      { lat: 34.9000, lng: -98.2000 },
      { lat: 36.0000, lng: -96.0000 }
    );

    const ac = new google.maps.places.Autocomplete(input, {
      bounds: okcBounds,
      strictBounds: false,
      componentRestrictions: { country: "us" },
      fields: ["formatted_address", "geometry.location", "name", "place_id", "types"]
    });

    ac.addListener("place_changed", () => {
      const p = ac.getPlace();
      if (!p || !p.geometry || !p.geometry.location) return;
      const loc = p.geometry.location;
      input.value = (p.name && p.formatted_address) ? `${p.name} ‚Äî ${p.formatted_address}` : (p.formatted_address || p.name || input.value);

      const lat = loc.lat();
      const lng = loc.lng();
      setMarker(role, lat, lng);

      applyAutoRateLabels();
      updateFairnessPreview();
      renderRouteFromInputs();
    });

    return ac;
  }

  function renderRouteFromInputs() {
    try {
      const pickup = (document.getElementById("pickup")?.value || "").trim();
      const dropoff = (document.getElementById("dropoff")?.value || "").trim();
      if (!pickup || !dropoff || !directionsService || !directionsRenderer) return;

      directionsService.route(
        { origin: pickup, destination: dropoff, travelMode: "DRIVING" },
        (r, status) => {
          if (status !== "OK" || !r?.routes?.[0]) return;
          directionsRenderer.setDirections(r);
          if (r.routes[0].bounds) map.fitBounds(r.routes[0].bounds);

          try {
            const legs = r.routes[0].legs || [];
            if (!legs.length) return;
            setMarker("pickup", legs[0].start_location.lat(), legs[0].start_location.lng());
            setMarker("dropoff", legs[legs.length - 1].end_location.lat(), legs[legs.length - 1].end_location.lng());
            updateFairnessPreview();
          } catch(e) {}
        }
      );
    } catch(e) {}
  }

  async function ensureResolvedLatLng(which){
    const el = document.getElementById(which);
    const text = (el?.value || "").trim();
    if (!text || !geocoder) return false;

    if (which === "pickup" && pickupLatLng) return true;
    if (which === "dropoff" && dropoffLatLng) return true;

    const okcBounds = new google.maps.LatLngBounds(
      { lat: 34.9000, lng: -98.2000 },
      { lat: 36.0000, lng: -96.0000 }
    );

    const result = await new Promise((resolve) => {
      geocoder.geocode({ address: text, bounds: okcBounds }, (res, stat) => {
        if (stat !== "OK" || !res?.length) return resolve(null);
        resolve(res[0]);
      });
    });

    if (!result?.geometry?.location) return false;

    const loc = result.geometry.location;
    const lat = loc.lat();
    const lng = loc.lng();
    setMarker(which, lat, lng);
    return true;
  }

  function useMyLocation(which) {
    if (!navigator.geolocation) { alert("Location services not supported."); return; }

    navigator.geolocation.getCurrentPosition(
      pos => {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        const latlng = { lat, lng };

        geocoder.geocode({ location: latlng }, (res, stat) => {
          const addr = (stat === "OK" && res[0]) ? res[0].formatted_address : `${lat.toFixed(5)}, ${lng.toFixed(5)}`;
          document.getElementById(which).value = addr;
          setMarker(which, lat, lng);

          map.panTo(latlng);
          applyAutoRateLabels();
          updateFairnessPreview();
          renderRouteFromInputs();
        });
      },
      err => alert("Unable to get location: " + err.message),
      { enableHighAccuracy:true, maximumAge:8000, timeout:8000 }
    );
  }

  document.getElementById("useLocPickup").addEventListener("click", () => useMyLocation("pickup"));
  document.getElementById("useLocDrop").addEventListener("click", () => useMyLocation("dropoff"));

  // =====================================================
  // FAIRNESS FEE (same rules)
  // =====================================================
  function distMi(a, b) {
    const p1 = new google.maps.LatLng(a.lat, a.lng);
    const p2 = new google.maps.LatLng(b.lat, b.lng);
    return google.maps.geometry.spherical.computeDistanceBetween(p1, p2) / 1609.34;
  }

  function computeFairnessFee(miles) {
    if (!pickupLatLng) return 0;

    const pickup = { lat: pickupLatLng.lat(), lng: pickupLatLng.lng() };
    const origin = fairnessOrigin || HQ;
    const d = distMi(origin, pickup);

    let zoneFee = 0;
    if (d > 40) zoneFee = 20;
    else if (d > 20) zoneFee = 10;

    // fairness rule: no travel fee on long trips that already cover it
    if (zoneFee > 0 && miles > 20) zoneFee = 0;
    return zoneFee;
  }

  function updateFairnessPreview() {
    const note = document.getElementById("fairness-note");
    note.textContent = "";
    if (!pickupLatLng) return;

    const pickup = { lat: pickupLatLng.lat(), lng: pickupLatLng.lng() };
    const origin = fairnessOrigin || HQ;
    const d = distMi(origin, pickup);

    if (d > 40) note.textContent = "üìç Pickup is well outside the central metro / current driver area. A travel fairness fee may apply depending on total trip distance.";
    else if (d > 20) note.textContent = "üìç Pickup is outside the central zone / current driver area. A small travel fairness fee may apply depending on trip distance.";
  }

  // =====================================================
  // ESTIMATE CALC
  // =====================================================
  async function calculateEstimate() {
    // ‚úÖ Enforce schedule (prevents falling back to "now" = accidental rush)
    initDefaultScheduleIfEmpty();
    const rd = (document.getElementById("reserveDate")?.value || "").trim();
    const rt = (getReserveTimeValue() || "").trim();
    if (!rd || !rt) { showToast("Select date & time"); return; }

    const pickup = (document.getElementById("pickup").value || "").trim();
    const dropoff = (document.getElementById("dropoff").value || "").trim();
    if (!pickup || !dropoff) { showToast("Enter pickup & drop-off"); return; }

    // Ensure pickup/dropoff latlng exist so fairness can compute
    const okPick = await ensureResolvedLatLng("pickup");
    const okDrop = await ensureResolvedLatLng("dropoff");
    if (!okPick || !okDrop) {
      alert("Please select valid pickup and drop-off locations (or use My Location).");
      return;
    }

    // Get route
    let route;
    try {
      route = await new Promise((resolve, reject) => {
        directionsService.route(
          { origin: pickup, destination: dropoff, travelMode: "DRIVING" },
          (r, status) => status === "OK" ? resolve(r) : reject(status)
        );
      });
    } catch (e) {
      alert("Unable to get route from Google Maps. Please double-check locations.");
      return;
    }

    directionsRenderer.setDirections(route);
    if (route?.routes?.[0]?.bounds) map.fitBounds(route.routes[0].bounds);

    let miles = 0;
    let minutes = 0;
    route.routes[0].legs.forEach(l => {
      miles   += (l.distance?.value || 0) / 1609.34;
      minutes += (l.duration?.value || 0) / 60;
    });
    miles = Math.round(miles);
    minutes = Math.round(minutes);

    // Base
    const rate = applyAutoRateLabels();
    const base = rate.base;

    // Mileage tiers
    const tier2 = Math.max(0, Math.min(10, miles - 10)) * 1.25;
    const tier3 = Math.max(0, miles - 20) * 1.0;
    const mileageSub = tier2 + tier3;

    const basePlusMiles = base + mileageSub;

    // ‚úÖ Fetch origin BEFORE computing fairness fee
    await fetchDriverOriginFromLiveGPS();
    const fairnessFee = computeFairnessFee(miles);

    const pay = document.getElementById("payment").value;
    let fare = basePlusMiles + fairnessFee;
    if (pay === "card") fare += fare * 0.033 + fare * 0.024;

    const total = fare.toFixed(2);

    const resDiv = document.getElementById("result");
    resDiv.style.display = "block";
    resDiv.innerHTML = `
      <div class="total">$${total}</div>
      <p><strong>Base:</strong> $${base.toFixed(2)}</p>
      <p><strong>Mileage:</strong> $${mileageSub.toFixed(2)} (${miles} mi)</p>
      <p><strong>Travel Fairness Fee:</strong> $${Number(fairnessFee).toFixed(2)}</p>
      <p><strong>Payment:</strong> ${pay === "card" ? "Card (incl. fees)" : "Cash / Venmo / Cash App"}</p>
      <p>‚è±Ô∏è Approx. ${Math.round(minutes)} min</p>
      <div style="text-align:center;margin-top:10px;">
        <a class="btn btn-secondary" href="/rider/ride-request.html?pickup=${encodeURIComponent(pickup)}&dropoff=${encodeURIComponent(dropoff)}&reserveDate=${encodeURIComponent(rd)}&reserveTime=${encodeURIComponent(rt)}&planBy=${encodeURIComponent(document.getElementById("planBy").value)}&payment=${encodeURIComponent(pay)}&estimate=${encodeURIComponent(total)}&miles=${encodeURIComponent(String(miles))}&minutes=${encodeURIComponent(String(minutes))}">Continue to Request ‚Üí</a>
      </div>
    `;

    updateFairnessPreview();
  }

  document.getElementById("calcBtn").addEventListener("click", calculateEstimate);

  // =====================================================
  // INIT
  // =====================================================
  document.addEventListener("DOMContentLoaded", () => {
    build15MinOptions(document.getElementById("reserveTimeSelect"));
    initDefaultScheduleIfEmpty();

    document.getElementById("reserveDate")?.addEventListener("change", applyAutoRateLabels);
    document.getElementById("reserveTimeSelect")?.addEventListener("change", applyAutoRateLabels);

    // grab origin early (non-blocking)
    fetchDriverOriginFromLiveGPS().finally(() => {
      applyAutoRateLabels();
      updateFairnessPreview();
    });
  });

  window.initGoogle = function () {
    geocoder = new google.maps.Geocoder();
    directionsService = new google.maps.DirectionsService();
    directionsRenderer = new google.maps.DirectionsRenderer({ suppressMarkers:true });

    map = new google.maps.Map(document.getElementById("map"), {
      center: { lat: 35.4676, lng: -97.5164 },
      zoom: 11,
      disableDefaultUI: true,
      gestureHandling: "greedy",
      styles: [
        { elementType:"geometry", stylers:[{ color:"#1a1a1a" }] },
        { elementType:"labels.text.stroke", stylers:[{ color:"#1a1a1a" }] },
        { elementType:"labels.text.fill", stylers:[{ color:"#ffffff" }] },
        { featureType:"poi", elementType:"geometry", stylers:[{ color:"#111" }] }
      ]
    });

    directionsRenderer.setMap(map);

    setupAutocomplete("pickup", "pickup");
    setupAutocomplete("dropoff", "dropoff");

    document.getElementById("pickup")?.addEventListener("input", () => { pickupLatLng = null; applyAutoRateLabels(); updateFairnessPreview(); });
    document.getElementById("dropoff")?.addEventListener("input", () => { dropoffLatLng = null; applyAutoRateLabels(); });

    // render route when both have content
    document.getElementById("pickup")?.addEventListener("change", renderRouteFromInputs);
    document.getElementById("dropoff")?.addEventListener("change", renderRouteFromInputs);

    applyAutoRateLabels();
    updateFairnessPreview();
  };
</script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCMM0dxLNM7XQI5G3OBSnINeO5hcS3Ks5I&libraries=places,geometry&callback=initGoogle" async defer></script>

<script src="/rider/session-guard.js"></script>
</body>
</html>