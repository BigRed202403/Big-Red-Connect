<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Big Red Connect â€” Driver Dispatch</title>

  <!-- PWA Icons -->
  <link rel="apple-touch-icon" href="icon.PNG">
  <link rel="icon" type="image/png" sizes="192x192" href="icon.PNG">
  <link rel="manifest" href="manifest-driver.json">
  <meta name="theme-color" content="#000000">

  <!-- Disable cache -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <!-- OneSignal v16 SDK -->
  <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
  <script>
    // Small helper so we can safely queue work until OneSignal is ready
    window.OneSignalDeferred = window.OneSignalDeferred || [];
    function withOneSignal(fn) {
      OneSignalDeferred.push(fn);
    }
  </script>

  <style>
    :root {
      --red: #b30000;
      --bg: #000;
      --panel: #111;
      --border: #222;
      --muted: #aaa;
      --accent: #ffcc00;
    }

    * { box-sizing:border-box; }

    body {
      margin: 0;
      background: var(--bg);
      color: #fff;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }

    /* Header */
    header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:10px 12px;
      background:#000;
      border-bottom:2px solid var(--red);
      position:sticky;
      top:0;
      z-index:20;
    }

    .header-left {
      display:flex;
      align-items:center;
      gap:10px;
    }

    .logo { height:40px; border-radius:4px; }

    .header-title-main {
      font-weight:700;
      font-size:.95rem;
    }

    .header-title-sub {
      color:#888;
      font-size:.75rem;
    }

    .header-actions {
      display:flex;
      gap:6px;
    }

    .btn {
      padding:7px 10px;
      border-radius:8px;
      border:none;
      cursor:pointer;
      font-weight:600;
      font-size:.8rem;
      white-space:nowrap;
    }

    .btn-primary { background:var(--red); color:#fff; }
    .btn-ghost  { background:#111; color:#fff; border:1px solid #444; }
    .btn-notify { background:#111; color:#fff; border:1px solid #555; }

    /* Vehicle legend strip */
    .vehicle-legend {
      padding:8px 12px 4px;
      background:#050505;
      border-bottom:1px solid #111;
      display:flex;
      gap:10px;
      overflow-x:auto;
      -webkit-overflow-scrolling:touch;
    }

    .vehicle-legend-item {
      display:flex;
      align-items:center;
      gap:6px;
      background:#111;
      border-radius:999px;
      border:1px solid #333;
      padding:4px 8px;
      font-size:.75rem;
      flex-shrink:0;
    }

    .vehicle-legend-item img {
      width:28px;
      height:28px;
      border-radius:4px;
      object-fit:cover;
    }

    .vehicle-legend-label-main {
      font-weight:600;
    }
    .vehicle-legend-label-sub {
      color:#bbb;
      font-size:.7rem;
    }

    /* Main grid */
    .grid {
      padding:10px 10px 16px;
      display:grid;
      grid-template-columns:1fr;
      gap:12px;
    }

    @media(min-width:900px){
      .grid{
        grid-template-columns:repeat(3,1fr);
      }
    }

    .column {
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:10px;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height:0;
    }

    .col-header {
      padding:8px 10px;
      border-bottom:1px solid #222;
      font-weight:700;
      font-size:.85rem;
      display:flex;
      justify-content:space-between;
      align-items:center;
      text-transform:uppercase;
      letter-spacing:.03em;
    }

    .col-header span.count-pill {
      background:#000;
      border-radius:999px;
      padding:2px 8px;
      border:1px solid #444;
      font-size:.75rem;
      color:#ddd;
    }

    .col-body {
      flex:1;
      max-height:72vh;
      overflow-y:auto;
      padding:8px;
    }

    .empty-text {
      text-align:center;
      color:#777;
      padding:20px 6px;
      font-size:.85rem;
    }

    /* Cards */
    .card {
      background:#000;
      border:1px solid #222;
      border-radius:10px;
      padding:10px 9px 9px;
      margin-bottom:10px;
      font-size:.8rem;
      display:flex;
      flex-direction:column;
      gap:6px;
    }

    .card-top-row {
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:6px;
    }

    .card-rider {
      font-weight:600;
      font-size:.88rem;
    }

    .badge-row {
      display:flex;
      gap:4px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .badge {
      display:inline-block;
      padding:2px 6px;
      border-radius:999px;
      font-size:.7rem;
      border:1px solid #666;
    }

    .badge-status {
      border-color:#aaa;
      text-transform:uppercase;
    }

    .badge-type {
      border-color:var(--accent);
      color:var(--accent);
      text-transform:uppercase;
    }

    .time-line {
      font-size:.75rem;
      color:#bbb;
    }

    .loc-block {
      margin-top:2px;
    }

    .loc-label {
      color:#999;
      font-size:.73rem;
      text-transform:uppercase;
      letter-spacing:.04em;
    }

    .loc-text {
      font-size:.8rem;
      margin-top:1px;
    }

    .stops-line {
      font-size:.78rem;
      margin-top:2px;
    }

    .metrics-row {
      display:flex;
      justify-content:space-between;
      font-size:.78rem;
      margin-top:4px;
    }

    .metrics-row span {
      color:#ddd;
    }
    .metrics-row strong {
      color:#fff;
    }

    /* Vehicle row */
    .vehicle-row {
      display:flex;
      margin-top:4px;
      gap:6px;
      align-items:center;
      justify-content:space-between;
    }

    .vehicle-pill {
      display:flex;
      align-items:center;
      gap:6px;
      background:#090909;
      border-radius:999px;
      border:1px solid #333;
      padding:3px 8px;
      min-width:0;
      max-width:52%;
      font-size:.75rem;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .vehicle-pill img {
      width:26px;
      height:26px;
      border-radius:4px;
      object-fit:cover;
      flex-shrink:0;
    }

    .vehicle-pill span.main {
      font-weight:600;
    }
    .vehicle-pill span.sub {
      color:#bbb;
      font-size:.7rem;
    }

    .vehicle-pill.empty {
      justify-content:center;
      color:#999;
      font-style:italic;
    }

    .vehicle-choices {
      display:flex;
      gap:4px;
      flex-wrap:nowrap;
    }

    .vehicle-chip {
      display:flex;
      align-items:center;
      gap:4px;
      padding:3px 6px;
      border-radius:999px;
      border:1px solid #444;
      background:#050505;
      color:#eee;
      font-size:.72rem;
      cursor:pointer;
      flex-shrink:0;
    }

    .vehicle-chip img {
      width:22px;
      height:22px;
      border-radius:4px;
      object-fit:cover;
      flex-shrink:0;
    }

    .vehicle-chip span {
      display:inline-block;
      max-width:60px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .vehicle-chip.active {
      border-color:var(--red);
      background:#1a0505;
      color:#ffdada;
    }

    /* Footer row in card */
    .card-footer {
      border-top:1px solid #181818;
      margin-top:6px;
      padding-top:5px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:6px;
      flex-wrap:wrap;
    }

    .status-dropdown {
      background:#111;
      color:#fff;
      border:1px solid #333;
      padding:4px 6px;
      border-radius:6px;
      font-size:.75rem;
    }

    .card-footer-right {
      font-size:.75rem;
      color:#bbb;
      text-align:right;
      flex:1;
    }

    .card-footer-right div + div {
      margin-top:2px;
    }

    /* Toast */
    #toast {
      position:fixed;
      bottom:20px;
      left:50%;
      transform:translateX(-50%);
      background:#111;
      border:1px solid var(--red);
      padding:9px 16px;
      border-radius:999px;
      opacity:0;
      pointer-events:none;
      transition:opacity .25s;
      z-index:50;
      font-size:.8rem;
    }
    #toast.show { opacity:1; }

    @media (max-width:600px){
      header {
        flex-wrap:wrap;
        row-gap:6px;
      }
      .header-actions {
        width:100%;
        justify-content:flex-end;
      }
      .col-body {
        max-height:none;
      }
    }
  </style>
</head>
<body>

<header>
  <div class="header-left">
    <a href="index.html">
      <img src="icon.PNG" class="logo" alt="Big Red Connect Logo" />
    </a>
    <div>
      <div class="header-title-main">Big Red Driver</div>
      <div class="header-title-sub">Live Dispatch &amp; Ride Board</div>
    </div>
  </div>

  <div class="header-actions">
    <button class="btn btn-ghost" id="btnRefresh">ðŸ”„ Refresh</button>
    <button class="btn btn-primary" id="btnScope">ðŸ“‹ Active</button>
    <button class="btn btn-notify" id="btnNotify">ðŸ”” Alerts: Off</button>
  </div>
</header>

<!-- Vehicle legend strip -->
<div class="vehicle-legend">
  <div class="vehicle-legend-item">
    <img src="/Big%20Red%20Thumbnail.PNG" alt="Big Red">
    <div>
      <div class="vehicle-legend-label-main">Big Red</div>
      <div class="vehicle-legend-label-sub">Red Chevy 2500 HD</div>
    </div>
  </div>

  <div class="vehicle-legend-item">
    <img src="/Black%20Acadia%20Thumbnail.PNG" alt="Black GMC Acadia">
    <div>
      <div class="vehicle-legend-label-main">Black GMC Acadia</div>
      <div class="vehicle-legend-label-sub">3-row SUV</div>
    </div>
  </div>
</div>

<div class="grid">

  <section class="column">
    <div class="col-header">
      <span>ðŸ†• New Requests</span>
      <span class="count-pill" id="countNew">0</span>
    </div>
    <div class="col-body" id="listNew"><div class="empty-text">No new requests.</div></div>
  </section>

  <section class="column">
    <div class="col-header">
      <span>ðŸš¦ Active Trips</span>
      <span class="count-pill" id="countActive">0</span>
    </div>
    <div class="col-body" id="listActive"><div class="empty-text">No active trips.</div></div>
  </section>

  <section class="column">
    <div class="col-header">
      <span>âœ… Completed / Cancelled</span>
      <span class="count-pill" id="countDone">0</span>
    </div>
    <div class="col-body" id="listDone"><div class="empty-text">No recent trips.</div></div>
  </section>

</div>

<div id="toast"></div>

<script>
/* ======================================================
   CONFIG
====================================================== */
const API = "https://bigred-bookings.bigredtransportation.workers.dev";
let scope = "active";

const VEHICLE_MAP = {
  BIG_RED: {
    code: "BIG_RED",
    label: "Big Red",
    sub: "Red Chevy 2500 HD",
    img: "/Big%20Red%20Thumbnail.PNG"
  },
  ACADIA: {
    code: "ACADIA",
    label: "Black GMC Acadia",
    sub: "3-row SUV",
    img: "/Black%20Acadia%20Thumbnail.PNG"
  }
};

const VEHICLE_STORAGE_KEY = "bigred_vehicle_assignments_v1";
let vehicleAssignments = loadVehicleAssignments();

/* ======================================================
   ONE SIGNAL â€” DRIVER LOGIN (v16)
====================================================== */

const notifyBtn = document.querySelector("#btnNotify");

function updateNotifyButton(enabled) {
  notifyBtn.textContent = enabled ? "ðŸ”” Alerts: On" : "ðŸ”” Alerts: Off";
}

function showToast(msg) {
  const toast = document.querySelector("#toast");
  toast.textContent = msg;
  toast.classList.add("show");
  setTimeout(() => toast.classList.remove("show"), 1800);
}

// Init + login as "driver"
withOneSignal(async function(OneSignal) {
  try {
    await OneSignal.init({
      appId: "64641a89-3619-4491-a25b-c0ab000bdfe0",
      allowLocalhostAsSecureOrigin: true,
      notifyButton: { enable: false }
    });

    // Login as the single driver identity
    await OneSignal.login("driver");

    const status = await OneSignal.Notifications.getPermissionStatus();
    updateNotifyButton(status === "granted");
  } catch (e) {
    console.warn("OneSignal init/login error:", e);
  }
});

// Toggle alerts
notifyBtn.addEventListener("click", () => {
  withOneSignal(async function(OneSignal) {
    try {
      const current = await OneSignal.Notifications.getPermissionStatus();

      if (current === "granted") {
        showToast("Alerts already enabled.");
        updateNotifyButton(true);
        return;
      }

      const result = await OneSignal.Notifications.requestPermission();
      const granted = result === "granted";
      updateNotifyButton(granted);
      showToast(granted ? "Alerts enabled!" : "Permission blocked.");
    } catch (e) {
      console.warn("Permission toggle error:", e);
      showToast("Error updating alerts.");
    }
  });
});

/* ======================================================
   VEHICLE ASSIGNMENTS (LOCAL ONLY FOR NOW)
====================================================== */
function loadVehicleAssignments() {
  try {
    const raw = localStorage.getItem(VEHICLE_STORAGE_KEY);
    if (!raw) return {};
    const obj = JSON.parse(raw);
    return obj && typeof obj === "object" ? obj : {};
  } catch {
    return {};
  }
}

function saveVehicleAssignments() {
  try {
    localStorage.setItem(VEHICLE_STORAGE_KEY, JSON.stringify(vehicleAssignments));
  } catch (e) {
    console.warn("Vehicle assignment save failed", e);
  }
}

function getVehicleForRide(id) {
  return vehicleAssignments[id] || null;
}

function setVehicleForRide(id, code) {
  if (!id) return;
  if (!code) {
    delete vehicleAssignments[id];
  } else {
    vehicleAssignments[id] = code;
  }
  saveVehicleAssignments();
}

/* ======================================================
   API + RENDERING
====================================================== */

async function fetchBookings() {
  const url = `${API}/api/driver/bookings?scope=${scope}&t=${Date.now()}`;
  try {
    const res = await fetch(url);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    renderAll(data);
  } catch(e) {
    console.error("Sync failed:", e);
    showToast("Sync failed");
  }
}

function renderAll(list) {
  const newArr    = list.filter(b => b.status === "REQUESTED");
  const activeArr = list.filter(b => ["ACCEPTED","ENROUTE","ARRIVED"].includes(b.status));
  const doneArr   = list.filter(b => ["COMPLETED","CANCELLED"].includes(b.status));

  renderColumn("listNew", newArr);
  renderColumn("listActive", activeArr);
  renderColumn("listDone", doneArr);

  document.querySelector("#countNew").textContent    = newArr.length;
  document.querySelector("#countActive").textContent = activeArr.length;
  document.querySelector("#countDone").textContent   = doneArr.length;
}

function formatWhen(b) {
  if (b.type === "RESERVATION" && b.scheduledFor) {
    const d = new Date(b.scheduledFor);
    if (!isNaN(d)) {
      return d.toLocaleString(undefined, {
        month:"short", day:"numeric",
        hour:"numeric", minute:"2-digit"
      });
    }
  }
  const created = b.createdAt ? new Date(b.createdAt) : null;
  if (created && !isNaN(created)) {
    return "Now Â· " + created.toLocaleTimeString(undefined, {
      hour:"numeric", minute:"2-digit"
    });
  }
  return "Now";
}

function renderColumn(id, arr) {
  const box = document.getElementById(id);
  box.innerHTML = "";

  if (!arr.length) {
    box.innerHTML = `<div class="empty-text">None</div>`;
    return;
  }

  arr.forEach(b => {
    const div = document.createElement("div");
    div.className = "card";
    div.dataset.id = b.id;
    div.dataset.status = b.status;

    const est = b.pricing?.estimate ? `$${b.pricing.estimate.toFixed(2)}` : "--";
    const whenText = formatWhen(b);
    const miles = b.metrics?.miles != null ? `${b.metrics.miles} mi` : "--";
    const mins  = b.metrics?.minutes != null ? `${Math.round(b.metrics.minutes)} min` : "--";
    const party = b.rider?.partySize || 1;
    const riderName = b.rider?.name || "Rider";

    const assignedCode = getVehicleForRide(b.id);
    const assignedVehicle = assignedCode ? VEHICLE_MAP[assignedCode] : null;

    const vehiclePill = assignedVehicle
      ? `
        <div class="vehicle-pill">
          <img src="${assignedVehicle.img}" alt="${assignedVehicle.label}">
          <div>
            <span class="main">${assignedVehicle.label}</span><br>
            <span class="sub">${assignedVehicle.sub}</span>
          </div>
        </div>`
      : `<div class="vehicle-pill empty"><span>No vehicle assigned</span></div>`;

    const stopsHtml = (b.stops && b.stops.length)
      ? `<div class="stops-line">Stops: ${b.stops.map(s => s.address).join(" â†’ ")}</div>`
      : "";

    div.innerHTML = `
      <div class="card-top-row">
        <div>
          <div class="card-rider">${riderName}</div>
          <div class="time-line">${whenText} Â· Party ${party}</div>
        </div>
        <div class="badge-row">
          <span class="badge badge-type">${b.type || "INSTANT"}</span>
          <span class="badge badge-status">${b.status}</span>
        </div>
      </div>

      <div class="loc-block">
        <div class="loc-label">FROM</div>
        <div class="loc-text">${b.pickup.address}</div>
      </div>

      ${stopsHtml}

      <div class="loc-block">
        <div class="loc-label">TO</div>
        <div class="loc-text">${b.dropoff.address}</div>
      </div>

      <div class="metrics-row">
        <span>Est: <strong>${est}</strong></span>
        <span>Route: <strong>${miles}</strong> Â· <strong>${mins}</strong></span>
      </div>

      <div class="vehicle-row">
        ${vehiclePill}
        <div class="vehicle-choices">
          <button class="vehicle-chip ${assignedCode==="BIG_RED"?"active":""}" data-vehicle="BIG_RED" data-id="${b.id}">
            <img src="${VEHICLE_MAP.BIG_RED.img}" alt="Big Red">
            <span>Big Red</span>
          </button>
          <button class="vehicle-chip ${assignedCode==="ACADIA"?"active":""}" data-vehicle="ACADIA" data-id="${b.id}">
            <img src="${VEHICLE_MAP.ACADIA.img}" alt="Black GMC Acadia">
            <span>Acadia</span>
          </button>
        </div>
      </div>

      <div class="card-footer">
        <div>
          <select class="status-dropdown" data-id="${b.id}">
            <option ${b.status==="REQUESTED"?"selected":""}>REQUESTED</option>
            <option ${b.status==="ACCEPTED"?"selected":""}>ACCEPTED</option>
            <option ${b.status==="ENROUTE"?"selected":""}>ENROUTE</option>
            <option ${b.status==="ARRIVED"?"selected":""}>ARRIVED</option>
            <option ${b.status==="COMPLETED"?"selected":""}>COMPLETED</option>
            <option ${b.status==="CANCELLED"?"selected":""}>CANCELLED</option>
          </select>
        </div>

        <div class="card-footer-right">
          <div>Source: ${b.source || "â€”"}</div>
          <div>ID: ${b.id.slice(0,8)}â€¦</div>
        </div>
      </div>
    `;

    box.appendChild(div);
  });
}

/* ======================================================
   STATUS CHANGE HANDLER
====================================================== */

document.body.addEventListener("change", async (e) => {
  if (e.target.classList.contains("status-dropdown")) {
    const id = e.target.dataset.id;
    const newState = e.target.value;

    try {
      const res = await fetch(`${API}/api/driver/bookings/${id}`, {
        method:"PUT",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify({ status:newState })
      });

      if(res.ok){
        showToast(`Status â†’ ${newState}`);
        fetchBookings();
      } else {
        showToast("Update failed");
      }
    } catch(err) {
      console.error(err);
      showToast("Update failed");
    }
  }
});

/* ======================================================
   VEHICLE CHIP HANDLER (LOCAL ASSIGNMENT)
====================================================== */

document.body.addEventListener("click", (e) => {
  const chip = e.target.closest(".vehicle-chip");
  if (!chip) return;

  const id = chip.dataset.id;
  const code = chip.dataset.vehicle;

  if (!VEHICLE_MAP[code]) return;

  setVehicleForRide(id, code);
  showToast(`${VEHICLE_MAP[code].label} assigned to ride.`);
  fetchBookings();
});

/* ======================================================
   SCOPE TOGGLE + MANUAL REFRESH
====================================================== */

document.querySelector("#btnScope").addEventListener("click", ()=>{
  if(scope==="active"){ scope="upcoming"; showToast("Showing upcoming"); }
  else if(scope==="upcoming"){ scope="all"; showToast("Showing all"); }
  else { scope="active"; showToast("Active only"); }
  document.querySelector("#btnScope").textContent = `ðŸ“‹ ${scope}`;
  fetchBookings();
});

document.querySelector("#btnRefresh").addEventListener("click", ()=>{
  fetchBookings();
  showToast("Refreshingâ€¦");
});

/* ======================================================
   AUTO POLL
====================================================== */

setInterval(fetchBookings, 20000);
fetchBookings();

</script>

</body>
</html>