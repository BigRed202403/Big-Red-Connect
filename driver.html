<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Big Red Connect ‚Äî Driver Dispatch</title>

  <!-- üì± PWA / Icons -->
  <link rel="apple-touch-icon" href="icon.PNG">
  <link rel="icon" type="image/png" sizes="192x192" href="icon.png">
  <link rel="shortcut icon" href="icon.PNG">
  <link rel="manifest" href="manifest-driver.json">
  <meta name="apple-mobile-web-app-title" content="Big Red Driver">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="theme-color" content="#000000">

  <!-- No cache -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <style>
    :root {
      --red: #b30000;
      --bg: #000;
      --panel: #111;
      --border: #222;
      --muted: #aaa;
      --accent: #ffcc00;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: radial-gradient(circle at top, #111 0, #000 55%);
      color: #fff;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    a {
      color: #fff;
      text-decoration: none;
    }

    /* Header */
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 12px;
      background: rgba(0,0,0,0.92);
      border-bottom: 2px solid var(--red);
      position: sticky;
      top: 0;
      z-index: 5;
    }

    .hdr-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo {
      height: 40px;
      width: auto;
      border-radius: 4px;
    }

    .hdr-title {
      display: flex;
      flex-direction: column;
    }

    .hdr-title span:first-child {
      font-weight: 700;
      font-size: 0.95rem;
      letter-spacing: 0.03em;
      text-transform: uppercase;
    }

    .hdr-title span:last-child {
      font-size: 0.8rem;
      color: var(--muted);
    }

    .hdr-right {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
      font-size: 0.8rem;
    }

    .pill {
      padding: 3px 9px;
      border-radius: 999px;
      font-weight: 600;
      font-size: 0.78rem;
      background: #222;
      border: 1px solid #444;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .pill-sync {
      background: #111;
      border-color: #333;
      color: var(--muted);
    }

    .pill-sync.ok {
      color: #8f8;
      border-color: #3a3;
    }

    .pill-sync.err {
      color: #f88;
      border-color: #a33;
    }

    .pill-scope {
      cursor: pointer;
    }

    .pill-scope strong {
      color: var(--accent);
    }

    .hdr-actions {
      display: flex;
      gap: 6px;
    }

    .btn {
      border-radius: 999px;
      border: none;
      padding: 6px 11px;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .btn-primary {
      background: var(--red);
      color: #fff;
    }
    .btn-primary:active {
      opacity: 0.85;
    }

    .btn-ghost {
      background: transparent;
      color: #fff;
      border: 1px solid #444;
    }
    .btn-ghost:active {
      background: #111;
    }

    .btn-notify {
      background: #111;
      border: 1px solid #444;
      color: #ddd;
    }
    .btn-notify.on {
      border-color: #3a3;
      color: #9f9;
      background: #071707;
    }

    /* Main grid */
    main {
      flex: 1;
      padding: 10px 10px 16px;
      max-width: 1200px;
      width: 100%;
      margin: 0 auto;
    }

    .blurb {
      font-size: 0.82rem;
      color: var(--muted);
      margin: 6px 2px 10px;
      display: flex;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }

    .blurb strong {
      color: #fff;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }

    @media (min-width: 900px) {
      .grid {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }
    }

    .column {
      background: rgba(10,10,10,0.96);
      border-radius: 10px;
      border: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      min-height: 180px;
      max-height: calc(100vh - 170px);
      overflow: hidden;
    }

    .col-header {
      padding: 8px 10px;
      border-bottom: 1px solid #222;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .col-title {
      font-size: 0.9rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .col-count {
      font-size: 0.8rem;
      color: var(--muted);
    }

    .col-body {
      flex: 1;
      overflow-y: auto;
      padding: 6px 8px 8px;
    }

    .empty-text {
      font-size: 0.8rem;
      color: #666;
      text-align: center;
      padding: 20px 8px;
    }

    /* Booking cards */
    .card {
      background: #111;
      border-radius: 9px;
      border: 1px solid #262626;
      padding: 8px 9px;
      margin-bottom: 8px;
      font-size: 0.8rem;
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .card-header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
    }

    .card-badge-row {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 2px;
    }

    .badge {
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 0.7rem;
      border: 1px solid #444;
      color: #ccc;
    }

    .badge-type {
      border-color: var(--accent);
      color: var(--accent);
    }

    .badge-status {
      border-color: #999;
    }

    .badge-est {
      border-color: #666;
    }

    .badge-time {
      border-color: #555;
      color: #aaa;
    }

    .badge-alert {
      border-color: #e67e22;
      color: #f6c49a;
    }

    .card-main {
      margin-top: 4px;
      line-height: 1.25;
    }

    .loc-line {
      display: flex;
      align-items: flex-start;
      gap: 4px;
    }

    .loc-label {
      width: 44px;
      color: var(--muted);
      font-size: 0.75rem;
      text-transform: uppercase;
    }

    .loc-text {
      flex: 1;
      font-size: 0.8rem;
    }

    .card-footer {
      margin-top: 6px;
      border-top: 1px solid #222;
      padding-top: 5px;
      display: flex;
      justify-content: space-between;
      gap: 4px;
      align-items: center;
      flex-wrap: wrap;
    }

    .card-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }

    .chip-btn {
      border-radius: 999px;
      border: 1px solid #444;
      background: #151515;
      color: #eee;
      font-size: 0.7rem;
      padding: 3px 7px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 3px;
    }

    .chip-btn.primary {
      border-color: var(--red);
      background: #220000;
      color: #ffdddd;
    }

    .chip-btn.good {
      border-color: #2ecc71;
      background: #102d18;
      color: #c7f9d4;
    }

    .chip-btn.warn {
      border-color: #e67e22;
      background: #2b1a05;
      color: #ffd6a3;
    }

    .chip-btn:active {
      opacity: 0.85;
    }

    .card-meta {
      font-size: 0.7rem;
      color: var(--muted);
      text-align: right;
    }

    /* Manual status dropdown */
    .status-select {
      background: #111;
      border-radius: 999px;
      border: 1px solid #444;
      color: #eee;
      font-size: 0.7rem;
      padding: 3px 8px;
      outline: none;
    }

    .status-select:focus {
      border-color: var(--accent);
    }

    /* Toast / inline status */
    #toast {
      position: fixed;
      bottom: 16px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.92);
      color: #fff;
      padding: 8px 14px;
      border-radius: 999px;
      font-size: 0.8rem;
      border: 1px solid var(--red);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s;
      z-index: 10;
      max-width: 90%;
      text-align: center;
    }

    #toast.show {
      opacity: 1;
      pointer-events: auto;
    }

    footer {
      text-align: center;
      padding: 6px 10px 10px;
      font-size: 0.75rem;
      color: #777;
    }
  </style>

  <!-- OneSignal SDK -->
  <script src="https://cdn.onesignal.com/sdks/OneSignalSDK.js" async></script>
</head>
<body>

<header>
  <div class="hdr-left">
    <a href="index.html" title="Return to Home">
      <img src="official_logo_Nov.png" alt="Big Red Connect Logo" class="logo">
    </a>
    <div class="hdr-title">
      <span>Big Red Driver</span>
      <span>Live Bookings & Active Trips</span>
    </div>
  </div>
  <div class="hdr-right">
    <div class="hdr-actions">
      <button class="btn btn-ghost" id="btnRefresh">
        üîÑ Refresh
      </button>
      <button class="btn btn-primary" id="btnScopeToggle">
        üìã View: <span id="scopeLabel">Active</span>
      </button>
      <button class="btn btn-notify" id="btnNotify">
        üîî Alerts: On
      </button>
    </div>
    <div style="display:flex; gap:4px; margin-top:2px;">
      <div class="pill pill-sync" id="syncPill">Last sync: ‚Äî</div>
      <div class="pill pill-scope" id="countPill">
        Total: <strong>0</strong>
      </div>
    </div>
  </div>
</header>

<main>
  <div class="blurb">
    <span>
      <strong>New Requests</strong> ‚Üí accept or decline.<br/>
      <strong>Active Trips</strong> ‚Üí live status & progress.<br/>
      <strong>Completed</strong> ‚Üí log & history.
    </span>
    <span>Auto-refreshes every 20 seconds while open.</span>
  </div>

  <div class="grid">
    <!-- New Requests -->
    <section class="column" id="colNew">
      <div class="col-header">
        <div class="col-title">
          üÜï New Requests
        </div>
        <div class="col-count">
          <span id="countNew">0</span>
        </div>
      </div>
      <div class="col-body" id="listNew">
        <div class="empty-text">Nothing pending right now.</div>
      </div>
    </section>

    <!-- Active Trips -->
    <section class="column" id="colActive">
      <div class="col-header">
        <div class="col-title">
          üö¶ Active Trips
        </div>
        <div class="col-count">
          <span id="countActive">0</span>
        </div>
      </div>
      <div class="col-body" id="listActive">
        <div class="empty-text">No active trips at the moment.</div>
      </div>
    </section>

    <!-- Completed / History -->
    <section class="column" id="colDone">
      <div class="col-header">
        <div class="col-title">
          ‚úÖ Completed / Log
        </div>
        <div class="col-count">
          <span id="countDone">0</span>
        </div>
      </div>
      <div class="col-body" id="listDone">
        <div class="empty-text">Completed & cancelled trips will land here.</div>
      </div>
    </section>
  </div>
</main>

<footer>
  ¬© 2025 Big Red Connect ‚Äî Driver Dispatch View
</footer>

<div id="toast"></div>

<script>
  // ===============================
  //  CONFIG
  // ===============================
  const API_BASE = "https://bigred-bookings.bigredtransportation.workers.dev";
  const ONESIGNAL_APP_ID = "64641a89-3619-4491-a25b-c0ab000bdfe0";

  let currentScope = "active"; // "active" | "upcoming" | "all"
  let pollingTimer = null;
  let lastDataSnapshot = [];
  let driverPlayerId = null;

  const qs = (sel) => document.querySelector(sel);
  const qsa = (sel) => Array.from(document.querySelectorAll(sel));

  const syncPill = qs("#syncPill");
  const countPill = qs("#countPill");
  const scopeLabel = qs("#scopeLabel");
  const btnScopeToggle = qs("#btnScopeToggle");
  const btnRefresh = qs("#btnRefresh");
  const btnNotify = qs("#btnNotify");

  const listNew = qs("#listNew");
  const listActive = qs("#listActive");
  const listDone = qs("#listDone");
  const countNew = qs("#countNew");
  const countActive = qs("#countActive");
  const countDone = qs("#countDone");

  const toastEl = qs("#toast");

  // ===============================
  //  UTILITIES
  // ===============================
  function showToast(msg, ms = 2200) {
    toastEl.textContent = msg;
    toastEl.classList.add("show");
    setTimeout(() => {
      toastEl.classList.remove("show");
    }, ms);
  }

  function fmtTime(iso) {
    if (!iso) return "‚Äî";
    try {
      const d = new Date(iso);
      return d.toLocaleString("en-US", {
        month: "short",
        day: "numeric",
        hour: "numeric",
        minute: "2-digit"
      });
    } catch {
      return iso;
    }
  }

  function fmtShortTime(iso) {
    if (!iso) return "‚Äî";
    try {
      const d = new Date(iso);
      return d.toLocaleTimeString("en-US", {
        hour: "numeric",
        minute: "2-digit"
      });
    } catch {
      return iso;
    }
  }

  function classifyStatus(status) {
    if (!status) return "REQUESTED";
    return status.toUpperCase();
  }

  function isNewBucket(b) {
    const s = classifyStatus(b.status);
    if (s === "REQUESTED") return true;
    if (b.type === "RESERVATION" && s === "REQUESTED") return true;
    return false;
  }

  function isActiveBucket(b) {
    const s = classifyStatus(b.status);
    return ["ACCEPTED","ENROUTE","ARRIVED","ONBOARD"].includes(s);
  }

  function isDoneBucket(b) {
    const s = classifyStatus(b.status);
    return ["COMPLETED","CANCELLED"].includes(s);
  }

  function statusLabel(status) {
    const s = classifyStatus(status);
    switch (s) {
      case "REQUESTED":  return "Requested";
      case "ACCEPTED":   return "Accepted";
      case "ENROUTE":    return "En Route";
      case "ARRIVED":    return "Arrived";
      case "ONBOARD":    return "Onboard";
      case "COMPLETED":  return "Completed";
      case "CANCELLED":  return "Cancelled";
      default:           return s;
    }
  }

  function typeLabel(t) {
    return t === "RESERVATION" ? "Reservation" : "Instant";
  }

  // ===============================
  //  RENDER
  // ===============================
  function renderBookings(bookings) {
    lastDataSnapshot = bookings.slice();

    const newArr = bookings.filter(isNewBucket);
    const activeArr = bookings.filter(isActiveBucket);
    const doneArr = bookings.filter(isDoneBucket);

    countNew.textContent = newArr.length;
    countActive.textContent = activeArr.length;
    countDone.textContent = doneArr.length;

    countPill.innerHTML = `Total: <strong>${bookings.length}</strong>`;

    renderColumn(listNew, newArr, "new");
    renderColumn(listActive, activeArr, "active");
    renderColumn(listDone, doneArr, "done");
  }

  function renderColumn(container, list, bucket) {
    container.innerHTML = "";
    if (!list.length) {
      const div = document.createElement("div");
      div.className = "empty-text";
      div.textContent =
        bucket === "new" ? "Nothing pending right now."
      : bucket === "active" ? "No active trips at the moment."
      : "Completed & cancelled trips will land here.";
      container.appendChild(div);
      return;
    }

    for (const b of list) {
      const card = document.createElement("article");
      card.className = "card";
      card.dataset.id = b.id;
      card.dataset.status = classifyStatus(b.status);

      const s = classifyStatus(b.status);
      const isRes = b.type === "RESERVATION";
      const hasEta = !!b.scheduledFor;

      const whenText = hasEta
        ? (isRes ? `Scheduled ${fmtTime(b.scheduledFor)}` : `Time: ${fmtTime(b.scheduledFor)}`)
        : `Requested ${fmtTime(b.requestedAt)}`;

      // Estimate / pricing
      const estVal = typeof b.pricing?.estimate === "number"
        ? `$${b.pricing.estimate.toFixed(2)}`
        : "‚Äî";

      // Card header
      const header = document.createElement("div");
      header.className = "card-header-row";
      header.innerHTML = `
        <div>
          <strong>${typeLabel(b.type)}</strong>
          <div class="card-badge-row">
            <span class="badge badge-status">${statusLabel(s)}</span>
            <span class="badge badge-est">Est: ${estVal}</span>
            ${isRes && hasEta ? `<span class="badge badge-time">‚è∞ ${fmtShortTime(b.scheduledFor)}</span>` : ""}
            ${isRes ? `<span class="badge badge-type">üìÖ Reservation</span>` : `<span class="badge badge-type">‚ö° Instant</span>`}
          </div>
        </div>
        <div style="text-align:right;font-size:0.72rem;color:#bbb;">
          <div>#${b.id}</div>
          <div>${whenText}</div>
        </div>
      `;
      card.appendChild(header);

      // Main body
      const main = document.createElement("div");
      main.className = "card-main";

      const pickup = b.pickup?.address || "";
      const dropoff = b.dropoff?.address || "";
      const stops = Array.isArray(b.stops) ? b.stops : [];

      main.innerHTML = `
        <div class="loc-line">
          <span class="loc-label">FROM</span>
          <span class="loc-text">${pickup || "<em>Missing</em>"}</span>
        </div>
        ${stops.length ? `
        <div class="loc-line">
          <span class="loc-label">STOPS</span>
          <span class="loc-text">${stops.map(s => s.address || "").filter(Boolean).join(" ‚Üí ")}</span>
        </div>` : ""}
        <div class="loc-line">
          <span class="loc-label">TO</span>
          <span class="loc-text">${dropoff || "<em>Missing</em>"}</span>
        </div>
        <div style="margin-top:4px;font-size:0.75rem;color:#bbb;">
          ${b.metrics?.miles != null ? `üìè ${b.metrics.miles} mi` : ""}
          ${b.metrics?.minutes != null ? ` ‚Ä¢ ‚è±Ô∏è ${b.metrics.minutes} min` : ""}
        </div>
      `;
      card.appendChild(main);

      // Footer with actions + manual dropdown
      const footer = document.createElement("div");
      footer.className = "card-footer";

      const actions = document.createElement("div");
      actions.className = "card-actions";

      // Quickflow buttons
      if (bucket === "new") {
        const acceptBtn = makeChip("‚úÖ Accept", "primary", "ACCEPTED");
        const declineBtn = makeChip("‚úñ Cancel", "warn", "CANCELLED");
        actions.appendChild(acceptBtn);
        actions.appendChild(declineBtn);
      } else if (bucket === "active") {
        if (s === "ACCEPTED") {
          actions.appendChild(makeChip("üöó En Route", "primary", "ENROUTE"));
          actions.appendChild(makeChip("‚úñ Cancel", "warn", "CANCELLED"));
        } else if (s === "ENROUTE") {
          actions.appendChild(makeChip("üìç Arrived", "primary", "ARRIVED"));
          actions.appendChild(makeChip("‚úñ Cancel", "warn", "CANCELLED"));
        } else if (s === "ARRIVED") {
          actions.appendChild(makeChip("üë• Onboard", "primary", "ONBOARD"));
          actions.appendChild(makeChip("‚úñ Cancel", "warn", "CANCELLED"));
        } else if (s === "ONBOARD") {
          actions.appendChild(makeChip("‚úÖ Complete", "good", "COMPLETED"));
        } else {
          actions.appendChild(makeChip("‚úÖ Complete", "good", "COMPLETED"));
          actions.appendChild(makeChip("‚úñ Cancel", "warn", "CANCELLED"));
        }
      }

      footer.appendChild(actions);

      // Manual status dropdown (can jump anywhere)
      const select = document.createElement("select");
      select.className = "status-select";
      const statuses = [
        "REQUESTED",
        "ACCEPTED",
        "ENROUTE",
        "ARRIVED",
        "ONBOARD",
        "COMPLETED",
        "CANCELLED"
      ];
      statuses.forEach(st => {
        const opt = document.createElement("option");
        opt.value = st;
        opt.textContent = statusLabel(st);
        select.appendChild(opt);
      });
      select.value = s;

      select.addEventListener("change", () => {
        const target = select.value;
        if (target === "CANCELLED") {
          const ok = confirm("Cancel this trip?");
          if (!ok) {
            select.value = s;
            return;
          }
        }
        updateBookingStatus(b.id, target);
      });

      footer.appendChild(select);

      const meta = document.createElement("div");
      meta.className = "card-meta";
      meta.textContent =
        b.rider?.name
          ? `Rider: ${b.rider.name}${b.rider.partySize ? " ‚Ä¢ Party " + b.rider.partySize : ""}`
          : (b.rider?.partySize ? `Party size: ${b.rider.partySize}` : "");
      footer.appendChild(meta);

      card.appendChild(footer);

      container.appendChild(card);
    }
  }

  function makeChip(label, style, statusTarget) {
    const btn = document.createElement("button");
    btn.type = "button";
    btn.className = "chip-btn " + (style || "");
    btn.textContent = label;
    btn.dataset.statusTarget = statusTarget;
    return btn;
  }

  // ===============================
  //  API
  // ===============================
  async function fetchBookings() {
    const url = `${API_BASE}/api/driver/bookings?scope=${encodeURIComponent(currentScope)}&t=${Date.now()}`;

    setSyncState("loading");

    try {
      const res = await fetch(url, {
        method: "GET",
        headers: {
          "Accept": "application/json"
        }
      });

      if (!res.ok) {
        throw new Error(`HTTP ${res.status}`);
      }

      const data = await res.json();
      renderBookings(Array.isArray(data) ? data : []);
      setSyncState("ok");
    } catch (err) {
      setSyncState("err");
      showToast("Unable to sync bookings. Check connection.");
    }
  }

  async function updateBookingStatus(id, newStatus) {
    if (!id || !newStatus) return;

    const url = `${API_BASE}/api/driver/bookings/${encodeURIComponent(id)}`;
    const body = { status: newStatus };

    setSyncState("loading");
    try {
      const res = await fetch(url, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify(body)
      });

      if (!res.ok) {
        const txt = await res.text();
        console.error("Update failed:", txt);
        showToast("Could not update booking.");
        setSyncState("err");
        return;
      }

      const updated = await res.json();
      const idx = lastDataSnapshot.findIndex(b => b.id === updated.id);
      if (idx !== -1) {
        lastDataSnapshot[idx] = updated;
        renderBookings(lastDataSnapshot);
      } else {
        fetchBookings();
      }

      setSyncState("ok");
      showToast(`Status ‚Üí ${statusLabel(updated.status)}`);
    } catch (err) {
      setSyncState("err");
      showToast("Network error updating booking.");
    }
  }

  function setSyncState(state) {
    const nowStr = new Date().toLocaleTimeString("en-US", {
      hour: "numeric",
      minute: "2-digit"
    });

    syncPill.classList.remove("ok", "err");
    if (state === "ok") {
      syncPill.classList.add("ok");
      syncPill.textContent = `Last sync: ${nowStr}`;
    } else if (state === "err") {
      syncPill.classList.add("err");
      syncPill.textContent = `Sync error (${nowStr})`;
    } else {
      syncPill.textContent = "Syncing‚Ä¶";
    }
  }

  function toggleScope() {
    if (currentScope === "active") {
      currentScope = "upcoming";
      scopeLabel.textContent = "Upcoming";
      showToast("Viewing upcoming reservations.");
    } else if (currentScope === "upcoming") {
      currentScope = "all";
      scopeLabel.textContent = "All";
      showToast("Viewing all bookings.");
    } else {
      currentScope = "active";
      scopeLabel.textContent = "Active";
      showToast("Viewing active & near-now only.");
    }
    fetchBookings();
  }

  function startPolling() {
    if (pollingTimer) clearInterval(pollingTimer);
    pollingTimer = setInterval(fetchBookings, 20000);
  }

  function stopPolling() {
    if (pollingTimer) clearInterval(pollingTimer);
    pollingTimer = null;
  }

  // ===============================
  //  NOTIFICATIONS (OneSignal)
  // ===============================
  function updateNotifyUI(enabled) {
    if (!btnNotify) return;
    if (enabled) {
      btnNotify.classList.add("on");
      btnNotify.textContent = "üîî Alerts: On";
    } else {
      btnNotify.classList.remove("on");
      btnNotify.textContent = "üîî Alerts: Off";
    }
  }

  async function registerDriverDevice(playerId) {
    driverPlayerId = playerId;
    // Optional: let the Worker know which device is the driver
    try {
      await fetch(`${API_BASE}/api/driver/device`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          playerId,
          role: "driver",
          driverId: "dan"
        })
      });
    } catch {
      // Non-fatal if this fails; Worker may still send broadcast notifications
    }
  }

  function initNotifications() {
    if (!window.OneSignal || !ONESIGNAL_APP_ID) return;

    window.OneSignal = window.OneSignal || [];
    const OneSignal = window.OneSignal;

    OneSignal.push(function () {
      OneSignal.init({
        appId: ONESIGNAL_APP_ID,
        notifyButton: { enable: false }
      });

      OneSignal.isPushNotificationsEnabled(function(isEnabled) {
        updateNotifyUI(isEnabled);
        if (isEnabled) {
          OneSignal.getUserId().then(function(playerId) {
            if (playerId) {
              registerDriverDevice(playerId);
            }
          });
        }
      });

      OneSignal.on('subscriptionChange', function(isSubscribed) {
        updateNotifyUI(isSubscribed);
        if (isSubscribed) {
          OneSignal.getUserId().then(function(playerId) {
            if (playerId) {
              registerDriverDevice(playerId);
            }
          });
        }
      });
    });

    if (btnNotify) {
      btnNotify.addEventListener("click", function () {
        window.OneSignal.push(function () {
          OneSignal.isPushNotificationsEnabled(function(isEnabled) {
            if (!isEnabled) {
              OneSignal.registerForPushNotifications();
            } else {
              showToast("Alerts already enabled for this device.");
            }
          });
        });
      });
    }
  }

  // ===============================
  //  EVENT WIRING
  // ===============================
  document.addEventListener("DOMContentLoaded", () => {
    // Initial sync
    fetchBookings();
    startPolling();

    // Scope toggle
    btnScopeToggle.addEventListener("click", () => {
      toggleScope();
    });

    // Manual refresh
    btnRefresh.addEventListener("click", () => {
      fetchBookings();
      showToast("Refreshing bookings‚Ä¶");
    });

    // Action buttons via event delegation
    document.body.addEventListener("click", (e) => {
      const btn = e.target.closest(".chip-btn");
      if (!btn) return;

      const card = e.target.closest(".card");
      if (!card) return;

      const id = card.dataset.id;
      const statusTarget = btn.dataset.statusTarget;
      if (!id || !statusTarget) return;

      if (statusTarget === "CANCELLED") {
        const ok = confirm("Cancel this trip?");
        if (!ok) return;
      }

      updateBookingStatus(id, statusTarget);
    });

    // Pause polling when tab is hidden (battery-friendly)
    document.addEventListener("visibilitychange", () => {
      if (document.hidden) stopPolling();
      else {
        fetchBookings();
        startPolling();
      }
    });

    // Init push notifications last
    initNotifications();
  });
</script>

</body>
</html>