<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Big Red Connect â€” Driver Dispatch</title>

  <!-- PWA Icons -->
  <link rel="apple-touch-icon" href="icon.PNG">
  <link rel="icon" type="image/png" sizes="192x192" href="icon.PNG">
  <link rel="manifest" href="manifest-driver.json">
  <meta name="theme-color" content="#000000">

  <!-- Disable cache -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <!-- OneSignal v16 SDK -->
  <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
  <script>
    window.OneSignalDeferred = window.OneSignalDeferred || [];
    function withOneSignal(fn) { OneSignalDeferred.push(fn); }
  </script>

  <style>
    :root {
      --red: #b30000;
      --bg: #000;
      --panel: #111;
      --border: #222;
      --muted: #aaa;
      --accent: #ffcc00;
    }

    body {
      margin: 0;
      background: #000;
      color: #fff;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }

    header {
      display:flex;
      justify-content:space-between;
      padding:10px;
      background:#000;
      border-bottom:2px solid var(--red);
      position:sticky;
      top:0;
      z-index:10;
    }

    .logo { height:40px; border-radius:4px; }

    .btn {
      padding:6px 10px;
      border-radius:8px;
      border:none;
      cursor:pointer;
      font-weight:600;
    }
    .btn-primary { background:var(--red); color:#fff; }
    .btn-ghost   { background:#111; color:#fff; border:1px solid #444; }
    .btn-notify  { background:#111; color:#fff; border:1px solid #555; }

    .grid {
      padding:12px;
      display:grid;
      grid-template-columns:1fr;
      gap:12px;
    }
    @media(min-width:900px){
      .grid { grid-template-columns:repeat(3,1fr); }
    }

    .column {
      background:#111;
      border:1px solid #222;
      border-radius:10px;
      overflow:hidden;
    }

    .col-header {
      padding:10px;
      border-bottom:1px solid #222;
      font-weight:700;
      text-transform:uppercase;
      font-size:.85rem;
      display:flex;
      justify-content:space-between;
    }

    .col-body {
      max-height:70vh;
      overflow-y:auto;
      padding:10px;
    }

    .empty-text {
      text-align:center;
      color:#777;
      padding:20px;
      font-size:.85rem;
    }

    .card {
      background:#000;
      border:1px solid #333;
      border-radius:8px;
      padding:10px;
      margin-bottom:10px;
      font-size:.82rem;
    }

    .card-label-row {
      display:flex;
      justify-content:space-between;
      margin-bottom:6px;
    }

    .badge {
      display:inline-block;
      padding:2px 6px;
      border-radius:999px;
      font-size:.7rem;
      border:1px solid #666;
      margin-right:4px;
    }
    .badge-status { border-color:#aaa; }

    .loc-line { margin:4px 0; font-size:.78rem; }

    .eta-line {
      margin-top:4px;
      font-size:.78rem;
      color:#ccc;
    }

    .card-footer {
      border-top:1px solid #222;
      margin-top:8px;
      padding-top:6px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:6px;
      flex-wrap:wrap;
    }

    select.status-dropdown {
      background:#111;
      color:#fff;
      border:1px solid #333;
      padding:4px;
      border-radius:6px;
    }

    /* Vehicle Selector */
    .vehicle-select-row {
      display:flex;
      align-items:center;
      gap:8px;
      margin:10px 0 6px 0;
    }

    .vehicle-thumb {
      width:55px;
      height:auto;
      border-radius:6px;
      border:1px solid #333;
    }

    .vehicle-dropdown {
      flex:1;
      background:#111;
      color:#fff;
      border:1px solid #333;
      padding:6px;
      border-radius:6px;
      font-size:.8rem;
    }

    /* Chips (actions) */
    .chip {
      padding:4px 8px;
      border-radius:999px;
      border:1px solid #444;
      background:#111;
      color:#eee;
      font-size:.7rem;
      cursor:pointer;
      text-decoration:none;
      display:inline-block;
    }
    .chip.primary { border-color:var(--red); color:#ffdada; }
    .chip.muted   { border-color:#444; color:#ccc; }

    #toast {
      position:fixed;
      bottom:20px;
      left:50%;
      transform:translateX(-50%);
      background:#111;
      border:1px solid var(--red);
      padding:10px 18px;
      border-radius:999px;
      opacity:0;
      pointer-events:none;
      transition:opacity .25s;
      z-index:50;
    }
    #toast.show { opacity:1; }
  </style>
</head>

<body>

<header>
  <div style="display:flex;align-items:center;gap:10px;">
    <a href="index.html"><img src="official_logo_Nov.png" class="logo" /></a>
    <div>
      <div style="font-weight:700;font-size:.9rem;">Big Red Driver</div>
      <div style="color:#888;font-size:.75rem;">Live Dispatch</div>
    </div>
  </div>

  <div style="display:flex;gap:6px;">
    <button class="btn btn-ghost" id="btnRefresh">ðŸ”„ Refresh</button>
    <button class="btn btn-primary" id="btnScope">ðŸ“‹ Active</button>
    <button class="btn btn-notify" id="btnNotify">ðŸ”” Alerts: Off</button>
  </div>
</header>

<div class="grid">

  <section class="column">
    <div class="col-header">ðŸ†• New Requests <span id="countNew">0</span></div>
    <div class="col-body" id="listNew"><div class="empty-text">None</div></div>
  </section>

  <section class="column">
    <div class="col-header">ðŸš¦ Active Trips <span id="countActive">0</span></div>
    <div class="col-body" id="listActive"><div class="empty-text">None</div></div>
  </section>

  <section class="column">
    <div class="col-header">âœ… Completed <span id="countDone">0</span></div>
    <div class="col-body" id="listDone"><div class="empty-text">None</div></div>
  </section>

</div>

<div id="toast"></div>

<script>
/* ======================================================
   ONE SIGNAL â€” DRIVER LOGIN
====================================================== */
const notifyBtn = document.querySelector("#btnNotify");

function updateNotifyButton(enabled) {
  notifyBtn.textContent = enabled ? "ðŸ”” Alerts: On" : "ðŸ”” Alerts: Off";
}

function showToast(msg) {
  const toast = document.querySelector("#toast");
  toast.textContent = msg;
  toast.classList.add("show");
  setTimeout(() => toast.classList.remove("show"), 1800);
}

withOneSignal(async function(OneSignal) {
  try {
    await OneSignal.init({
      appId: "64641a89-3619-4491-a25b-c0ab000bdfe0",
      allowLocalhostAsSecureOrigin: true,
      notifyButton: { enable: false }
    });

    await OneSignal.login("driver");

    const status = await OneSignal.Notifications.getPermissionStatus();
    updateNotifyButton(status === "granted");
  } catch (e) {
    console.warn("OneSignal init/login error:", e);
  }
});

notifyBtn.addEventListener("click", () => {
  withOneSignal(async function(OneSignal) {
    const perm = await OneSignal.Notifications.getPermissionStatus();

    if (perm === "granted") {
      showToast("Alerts already enabled.");
      return;
    }

    const result = await OneSignal.Notifications.requestPermission();
    updateNotifyButton(result === "granted");
  });
});

/* ======================================================
   DRIVER DISPATCH LOGIC
====================================================== */
const API = "https://bigred-bookings.bigredtransportation.workers.dev";
let scope = "active";

async function fetchBookings() {
  try {
    const res = await fetch(`${API}/api/driver/bookings?scope=${scope}&t=${Date.now()}`);
    if (!res.ok) throw new Error("HTTP " + res.status);
    const data = await res.json();
    renderAll(data);
  } catch (e) {
    console.error(e);
    showToast("Sync failed");
  }
}

function renderAll(list) {
  const newArr    = list.filter(b => b.status === "REQUESTED");
  const activeArr = list.filter(b => ["ACCEPTED","ENROUTE","ARRIVED"].includes(b.status));
  const doneArr   = list.filter(b => ["COMPLETED","CANCELLED"].includes(b.status));

  renderColumn("listNew", newArr);
  renderColumn("listActive", activeArr);
  renderColumn("listDone", doneArr);

  document.getElementById("countNew").textContent    = newArr.length;
  document.getElementById("countActive").textContent = activeArr.length;
  document.getElementById("countDone").textContent   = doneArr.length;
}

function renderColumn(id, arr) {
  const box = document.getElementById(id);
  box.innerHTML = "";

  if (!arr.length) {
    box.innerHTML = `<div class="empty-text">None</div>`;
    return;
  }

  arr.forEach(b => {
    const div = document.createElement("div");
    div.className = "card";

    const estFare = b.pricing?.estimate
      ? `$${b.pricing.estimate.toFixed(2)}`
      : "--";

    const estMinutes = b.metrics?.minutes
      ? `${Math.round(b.metrics.minutes)} min`
      : null;

    const rideId = b.id;
    const isEnrouteOrArrived = ["ENROUTE","ARRIVED"].includes(b.status);

    div.innerHTML = `
      <div class="card-label-row">
        <span><strong>${b.type}</strong></span>
        <span class="badge badge-status">${b.status}</span>
      </div>

      <div class="loc-line">FROM: ${b.pickup.address}</div>
      ${
        b.stops?.length
          ? `<div class="loc-line">STOPS: ${b.stops.map(s=>s.address).join(" â†’ ")}</div>`
          : ""
      }
      <div class="loc-line">TO: ${b.dropoff.address}</div>

      <!-- VEHICLE SELECTOR -->
      <div class="vehicle-select-row">
        <img src="${b.vehicle?.image || '/Black Acadia Thumbnail.PNG'}"
             class="vehicle-thumb"
             id="vehImg-${rideId}">
        <select class="vehicle-dropdown" data-id="${rideId}" id="vehSel-${rideId}">
          <option value="BLACK_ACADIA"
                  data-label="Black GMC Acadia (SUV)"
                  data-img="/Black Acadia Thumbnail.PNG"
                  ${b.vehicle?.code === "BLACK_ACADIA" || !b.vehicle ? "selected" : ""}>
            Black GMC Acadia (SUV)
          </option>
          <option value="BIG_RED"
                  data-label="Big Red (Red Silverado)"
                  data-img="/Big Red Thumbnail.PNG"
                  ${b.vehicle?.code === "BIG_RED" ? "selected" : ""}>
            Big Red (Red Silverado)
          </option>
        </select>
      </div>

      <div style="margin-top:6px;">Est Fare: ${estFare}</div>
      ${
        estMinutes
          ? `<div class="eta-line">Est. ride time (from calculator): ${estMinutes}</div>`
          : ""
      }

      <div class="card-footer">
        <div>
          <select class="status-dropdown" data-id="${rideId}">
            <option ${b.status==="REQUESTED"?"selected":""}>REQUESTED</option>
            <option ${b.status==="ACCEPTED"?"selected":""}>ACCEPTED</option>
            <option ${b.status==="ENROUTE"?"selected":""}>ENROUTE</option>
            <option ${b.status==="ARRIVED"?"selected":""}>ARRIVED</option>
            <option ${b.status==="COMPLETED"?"selected":""}>COMPLETED</option>
            <option ${b.status==="CANCELLED"?"selected":""}>CANCELLED</option>
          </select>
        </div>

        <div style="display:flex;flex-direction:column;align-items:flex-end;gap:4px;">
          <div style="font-size:.75rem;color:#bbb;">
            Rider: ${b.rider?.name || "â€”"}
          </div>
          <div style="display:flex;gap:4px;flex-wrap:wrap;justify-content:flex-end;">
            ${
              b.rider?.phone
                ? `<a class="chip muted" href="sms:${b.rider.phone}">Text Rider</a>`
                : ""
            }
            ${
              isEnrouteOrArrived
                ? `<a class="chip primary" href="https://location-reader.bigredtransportation.workers.dev/?id=${rideId}" target="_blank">Live Map</a>`
                : ""
            }
          </div>
        </div>
      </div>
    `;

    box.appendChild(div);
  });
}

/* ======================================================
   STATUS CHANGE
====================================================== */
document.body.addEventListener("change", async (e) => {
  if (!e.target.classList.contains("status-dropdown")) return;

  const id = e.target.dataset.id;
  const newState = e.target.value;

  try {
    const res = await fetch(`${API}/api/driver/bookings/${id}`, {
      method:"PUT",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({ status:newState })
    });

    if (res.ok) {
      showToast(`Status â†’ ${newState}`);
      fetchBookings();
    } else {
      showToast("Update failed");
    }
  } catch (err) {
    console.error(err);
    showToast("Update failed");
  }
});

/* ======================================================
   VEHICLE ASSIGNMENT
====================================================== */
document.body.addEventListener("change", async (e) => {
  if (!e.target.classList.contains("vehicle-dropdown")) return;

  const id = e.target.dataset.id;
  const option = e.target.selectedOptions[0];

  const vehicle = {
    code:  option.value,
    label: option.dataset.label,
    image: option.dataset.img
  };

  // Update thumbnail instantly
  const img = document.querySelector(`#vehImg-${id}`);
  if (img) img.src = vehicle.image;

  try {
    const res = await fetch(`${API}/api/driver/bookings/${id}`, {
      method:"PUT",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({ vehicle })
    });

    if (res.ok) showToast("Vehicle updated");
    else       showToast("Update failed");
  } catch (err) {
    console.error(err);
    showToast("Update failed");
  }
});

/* ======================================================
   SCOPE + REFRESH
====================================================== */
document.querySelector("#btnScope").addEventListener("click", () => {
  if (scope === "active")      scope = "upcoming";
  else if (scope === "upcoming") scope = "all";
  else                          scope = "active";

  document.querySelector("#btnScope").textContent = `ðŸ“‹ ${scope}`;
  fetchBookings();
});

document.querySelector("#btnRefresh").addEventListener("click", () => {
  fetchBookings();
  showToast("Refreshingâ€¦");
});

/* ======================================================
   AUTO REFRESH
====================================================== */
setInterval(fetchBookings, 20000);
fetchBookings();
</script>

</body>
</html>