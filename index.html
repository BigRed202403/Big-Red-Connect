<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Big Red Connect</title>

  <!-- üì± PWA / Icons -->
  <link rel="apple-touch-icon" href="Official Logo.png">
  <link rel="icon" type="image/png" sizes="192x192" href="Official Logo.png">
  <link rel="shortcut icon" href="Official Logo.png">
  <link rel="manifest" href="manifest.json">
  <meta name="apple-mobile-web-app-title" content="Big Red Connect">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="theme-color" content="#000">

  <!-- üö´ No Cache -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <!-- üé® Styles -->
  <link rel="stylesheet" href="style.css" />

  <!-- üîî OneSignal Web Push SDK v16 -->
  <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>

  <script>
    /* Utility: Detect iPhone Safari */
    function isIPhoneSafari() {
      return /iPhone/i.test(navigator.userAgent) &&
             !window.matchMedia('(display-mode: standalone)').matches &&
             !navigator.standalone;
    }

    /* -------------------------------------------------
       OneSignal Initialization (Rider Mode)
       ------------------------------------------------- */
    window.OneSignalDeferred = window.OneSignalDeferred || [];
    OneSignalDeferred.push(async function (OneSignal) {
      await OneSignal.init({
        appId: "9b8bcc89-87d3-46e2-b2d0-042d1a267718",
        safari_web_id: "web.onesignal.auto.0c90051e-4735-447d-b203-75e3767d91b9",
        notifyButton: { enable: false },
        serviceWorkerPath: "/onesignalsdkworker.js?v=3",
        path: "/"
      });

      // Baseline tag (kept)
      await OneSignal.sendTag("role_rider", "true");
    });

    /* -------------------------------------------------
       UPDATED: Enable Alerts ‚Üí Auto-tag as Rider (Live)
       ------------------------------------------------- */
    function handleEnableAlerts() {
      window.OneSignalDeferred.push(async function (OneSignal) {
        const supported = await OneSignal.Notifications.isPushSupported();
        if (!supported) {
          alert("This browser does not support notifications.");
          return;
        }

        const permission = OneSignal.Notifications.permission;

        if (permission === "granted" || permission === true) {
          // Already enabled ‚Üí ensure correct tags exist
          await OneSignal.sendTag("env", "live");
          await OneSignal.sendTag("role_rider_live", "true");
          alert("You're already set ‚Äî alerts are enabled!");
          return;
        }

        if (isIPhoneSafari()) {
          document.getElementById("iosAlertTip").style.display = "block";
        }

        // This opens the push prompt
        await OneSignal.Slidedown.promptPush();

        // After permission is granted ‚Üí these tags ensure the rider receives pushes
        await OneSignal.sendTag("env", "live");
        await OneSignal.sendTag("role_rider_live", "true");

        console.log("[Rider] Push tags applied ‚Üí env=live, role_rider_live=true");
      });
    }

    /* ------------------------------------------------------
       LOGIN CHECKS
       ------------------------------------------------------ */
    function isRiderLoggedIn() {
      try {
        const raw = localStorage.getItem("bigred_rider_profile_v1");
        if (!raw) return false;
        const p = JSON.parse(raw);
        return !!p.phone;
      } catch {
        return false;
      }
    }

    /* ------------------------------------------------------
       DESTINATION HANDOFF (Index ‚Üí Estimate / Ride Request)
       - sessionStorage primary
       - localStorage fallback
       ------------------------------------------------------ */
    function stashDropoffHandoff(dest) {
      try { sessionStorage.setItem("brc_dropoff_handoff", dest); } catch (e) {}
      try { localStorage.setItem("brc_dropoff_handoff", dest); } catch (e) {}
    }

    function goRequestRide() {
      if (!isRiderLoggedIn()) {
        window.location.href = "/rider-login.html?next=ride-request";
      } else {
        window.location.href = "/rider/ride-request.html";
      }
    }

    // ‚úÖ NEW: Go to public Estimate page first (no login required)
    function goToEstimate(e) {
      if (e) e.preventDefault();
      const dest = document.getElementById("quickWhere")?.value?.trim() || "";
      if (!dest) return;

      // Store for carryover (Estimate can also read this if you want)
      stashDropoffHandoff(dest);

      // Pass via querystring too (optional, but nice)
      window.location.href = "/Estimate.html?destination=" + encodeURIComponent(dest);
    }

    function goMyProfile() {
      try {
        const raw = localStorage.getItem("bigred_rider_profile_v1");
        if (!raw) {
          window.location.href = "/rider-login.html?next=profile";
          return;
        }
        window.location.href = "/rider/rider.html";
      } catch (err) {
        console.error(err);
        window.location.href = "/rider-login.html?next=profile";
      }
    }
  </script>

</head>

<body>

  <!-- üåÜ Hero area -->
  <div class="hero"></div>

  <!-- üöó Main Logo -->
  <img src="Official Logo.png" alt="Big Red Connect Logo" class="main-logo" />

  <!-- Tagline -->
  <p class="tagline">Veteran Owned ¬∑ Flat Rate Rides ¬∑ Trusted Local Driver</p>

  <!-- Dynamic Status Pill -->
  <div id="status-pill" class="status status--loading">Checking status‚Ä¶</div>

  <!-- Floating Refresh Button -->
  <button id="refreshButton" title="Refresh Page">üîÑ Refresh</button>

  <!-- Quick Actions -->
  <div class="cta-group">
    <a href="sms:14053784024" class="btn primary">üì≤ Text Big Red</a>
    <a href="tel:14053784024" class="btn secondary">üìû Call Big Red</a>
    <!-- ‚úÖ NEW: Quick Estimate -->
    <a href="/Estimate.html" class="btn secondary">üí≤ Quick Estimate</a>
  </div>

  <!-- Notifications Section -->
  <div style="text-align:center; margin-top:18px;">
    <button onclick="handleEnableAlerts()" style="
      background:#b30000;
      color:white;
      border:none;
      padding:12px 22px;
      font-size:1em;
      font-weight:700;
      border-radius:8px;
      cursor:pointer;
      box-shadow:0 3px 6px rgba(0,0,0,0.4);
    ">
      üîî Enable Big Red Alerts
    </button>

    <p style="font-size:0.8em; color:#aaa; margin-top:6px;">
      Get live updates when Big Red is on-duty and available.
    </p>

    <p id="iosAlertTip" style="
      font-size:0.8em;
      color:#ffcc66;
      margin-top:10px;
      display:none;
    ">
      üëâ <strong>iPhone users:</strong> Tap Share ‚Üí "Add to Home Screen", then reopen and tap Enable Alerts again.
    </p>
  </div>

  <!-- Quick Destination Form -->
  <div class="info-section" style="text-align:center; margin-top:20px;">
    <h2>Plan Your Connection</h2>
    <!-- ‚úÖ UPDATED: goes to Estimate first -->
    <form id="quickDestination" onsubmit="goToEstimate(event)" style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap;">
      <input id="quickWhere" type="text" placeholder="Where are you headed?" required
        style="flex:1;min-width:220px;max-width:420px;padding:12px;border-radius:10px;border:1px solid #333;background:#111;color:#fff;">
      <button type="submit" class="btn primary">üìÖ Plan Now</button>
    </form>
    <p style="font-size:0.9em;color:#888;margin-top:6px;">
      Tip: Start typing a place, business, or address.
    </p>
  </div>

  <!-- Navigation Tiles -->
  <div class="tile-grid">
    <a onclick="goRequestRide()" class="tile" style="cursor:pointer;">üõ∑<br>Request a Ride</a>
    <a href="live.html" class="tile">üó∫Ô∏è<br>Driver Map</a>
    <a href="reviews.html" class="tile">‚≠ê<br>Rider Reviews</a>
    <a href="faq.html" class="tile">‚ÑπÔ∏è<br>FAQ & Info</a>
    <a onclick="goMyProfile()" class="tile" style="cursor:pointer;">üë§<br>My Profile</a>
    <a href="https://www.facebook.com/share/1BWCx63CUt/?mibextid=wwXIfr" target="_blank" class="tile">üëç<br>Follow on Facebook</a>
  </div>

  <!-- Content Sections -->
  <section class="info-section">
    <h2>What I Do</h2>
    <p>I offer local ride connections across the Oklahoma City metro.</p>
    <ul>
      <li>Daily work, school, and appointments</li>
      <li>Airport & Tinker AFB rides</li>
      <li>Nightlife pick-ups & drop-offs</li>
      <li>Events, concerts, casinos</li>
    </ul>
  </section>

  <section class="info-section">
    <h2>Why Choose Red</h2>
    <ul>
      <li>Veteran-owned and operated.</li>
      <li>Flat-rate, no-surprise pricing.</li>
      <li>One trusted driver ‚Äî always consistent, no surprises.</li>
    </ul>
  </section>

  <section class="info-section">
    <h2>What Riders Say</h2>
    <div class="review-card">
      ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê "Always dependable."
      <br><strong>‚Äî Alex, Norman</strong>
    </div>
    <div class="review-card">
      ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê "My go-to for nights out."
      <br><strong>‚Äî Taylor, OKC</strong>
    </div>
    <p><a href="reviews.html">More reviews ‚Üí</a></p>
  </section>

  <footer>
    <p>Questions? Text <strong>"RED"</strong> to (405) 378-4024.</p>
    <p><a href="faq.html">FAQ</a> | <a href="reviews.html">Leave a Review</a></p>
    <p>&copy; 2025 Big Red Connect</p>
  </footer>

  <!-- Google Places -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCMM0dxLNM7XQI5G3OBSnINeO5hcS3Ks5I&libraries=places"></script>
  <script>
    function initQuickSearch() {
      new google.maps.places.Autocomplete(
        document.getElementById("quickWhere"),
        { fields: ["formatted_address", "name"] }
      );
    }
    window.addEventListener("load", initQuickSearch);
  </script>

  <!-- Status Pill -->
<script src="status.js?v=20260116"></script>

  <!-- Floating Refresh -->
  <script>
    const refreshBtn = document.getElementById("refreshButton");
    let refreshTimeout;

    function showRefreshButton(){ refreshBtn.classList.add("visible"); }
    function hideRefreshButton(){
      refreshBtn.classList.remove("visible");
      clearTimeout(refreshTimeout);
      refreshTimeout = setTimeout(showRefreshButton, 30000);
    }

    refreshBtn.addEventListener("click", () => {
      hideRefreshButton();
      location.reload(true);
    });

    window.addEventListener("load", () => {
      refreshTimeout = setTimeout(showRefreshButton, 30000);
    });
  </script>

  <style>
    #refreshButton {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #b30000;
      color:#fff;
      border:none;
      border-radius:6px;
      padding:10px 16px;
      font-size:0.95em;
      font-weight:700;
      cursor:pointer;
      box-shadow:0 2px 6px rgba(0,0,0,0.4);
      opacity:0;
      pointer-events:none;
      transition:opacity .5s;
      z-index:10;
    }
    #refreshButton.visible {
      opacity:1;
      pointer-events:auto;
    }
  </style>

</body>
</html>