<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Big Red Connect</title>

  <!-- ğŸ“± PWA / Icons -->
  <link rel="apple-touch-icon" href="icon.PNG">
  <link rel="icon" type="image/png" sizes="192x192" href="icon.png">
  <link rel="shortcut icon" href="icon.PNG">
  <link rel="manifest" href="manifest.json">
  <meta name="apple-mobile-web-app-title" content="Big Red Connect">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="theme-color" content="#000">

  <!-- ğŸš« No cache -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <!-- ğŸ¨ Styles -->
  <link rel="stylesheet" href="style.css" />

  <!-- ğŸ”” OneSignal Web Push SDK -->
  <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>

  <!-- ğŸ”§ FIXED NOTIFICATION LOGIC -->
  <script>
    /* -----------------------------------------
       UTILITIES
    ----------------------------------------- */

    function isStandalone() {
      return window.matchMedia('(display-mode: standalone)').matches ||
             window.navigator.standalone === true;
    }

    function isIPhoneSafari() {
      return /iPhone/i.test(navigator.userAgent) && !isStandalone();
    }

    function getSoftDisable() {
      return localStorage.getItem("brc_push_disabled") === "1";
    }

    function setSoftDisable(v) {
      localStorage.setItem("brc_push_disabled", v ? "1" : "0");
    }

    /* -----------------------------------------
       UI STATES
    ----------------------------------------- */

    function renderStateEnabled() {
      document.getElementById("notifyEnableBtn").style.display = "none";
      document.getElementById("notifyDisableBtn").style.display = "inline-block";

      const badge = document.getElementById("notifyBadge");
      badge.textContent = "âœ” Notifications Enabled";
      badge.style.background = "#0f8c0f";
      badge.style.display = "inline-block";

      document.getElementById("notifyMsg").style.display = "none";
      document.getElementById("iosTip").style.display = "none";
    }

    function renderStateDisabled() {
      document.getElementById("notifyEnableBtn").style.display = "inline-block";
      document.getElementById("notifyDisableBtn").style.display = "none";

      const badge = document.getElementById("notifyBadge");
      badge.textContent = "âš  Notifications Disabled";
      badge.style.background = "#b30000";
      badge.style.display = "inline-block";

      document.getElementById("notifyMsg").style.display = "block";
      document.getElementById("iosTip").style.display = isIPhoneSafari() ? "block" : "none";
    }

    function renderStateNotSubscribed() {
      document.getElementById("notifyEnableBtn").style.display = "inline-block";
      document.getElementById("notifyDisableBtn").style.display = "none";
      document.getElementById("notifyBadge").style.display = "none";
      document.getElementById("notifyMsg").style.display = "block";
      document.getElementById("iosTip").style.display = isIPhoneSafari() ? "block" : "none";
    }

    /* -----------------------------------------
       INIT OneSignal
    ----------------------------------------- */

    window.OneSignalDeferred = window.OneSignalDeferred || [];

    OneSignalDeferred.push(async function (OneSignal) {
      await OneSignal.init({
        appId: "64641a89-3619-4491-a25b-c0ab000bdfe0",
        notifyButton: { enable: false },
        serviceWorkerPath: "/OneSignalSDKWorker.js",
        serviceWorkerUpdaterPath: "/OneSignalSDKUpdaterWorker.js"
      });

      setTimeout(async () => {
        let osSubscribed = await OneSignal.User.PushSubscription.isSubscribed();
        const softDisabled = getSoftDisable();

        /* -----------------------------------------
           iOS FIX: Safari often reports false 
           even when subscribed. We detect actual
           permission instead.
        ----------------------------------------- */
        if (Notification.permission === "granted" && osSubscribed === false) {
          osSubscribed = true;
        }

        if (!osSubscribed) {
          renderStateNotSubscribed();
        } else if (softDisabled) {
          renderStateDisabled();
        } else {
          renderStateEnabled();
        }
      }, 500);
    });

    /* -----------------------------------------
       ACTION BUTTONS
    ----------------------------------------- */

    async function enableNotifications() {
      window.OneSignalDeferred.push(async function (OneSignal) {
        const osSubscribed = await OneSignal.User.PushSubscription.isSubscribed();

        if (!osSubscribed) {
          OneSignal.showSlidedownPrompt();
          return;
        }

        setSoftDisable(false);
        renderStateEnabled();
      });
    }

    function disableNotifications() {
      setSoftDisable(true);
      renderStateDisabled();
    }
  </script>

</head>

<body>

  <!-- ğŸŒ† Hero -->
  <div class="hero"></div>

  <!-- ğŸš— Logo -->
  <img src="official_logo_Nov.png" alt="Big Red Connect Logo" class="main-logo" />

  <!-- ğŸ·ï¸ Tagline -->
  <p class="tagline">Veteran Owned Â· Affordable Flat Rates Â· Trusted Local Connections</p>

  <!-- ğŸš¦ Dynamic Status Pill -->
  <div id="status-pill" class="status status--loading">Checking statusâ€¦</div>

  <!-- ğŸ”„ Floating Refresh Button -->
  <button id="refreshButton" title="Refresh Page">ğŸ”„ Refresh</button>

  <!-- ğŸ“² Quick Actions -->
  <div class="cta-group">
    <a href="sms:14053784024" class="btn primary">ğŸ“² Text â€œREDâ€</a>
    <a href="tel:14053784024" class="btn secondary">ğŸ“ Call Big Red</a>
  </div>

  <!-- ğŸ”” Notification Controls -->
  <div style="text-align:center; margin-top:18px;">

    <!-- Status Badge -->
    <div id="notifyBadge" style="
      display:none;
      background:#444;
      color:white;
      padding:10px 18px;
      border-radius:8px;
      font-size:1em;
      font-weight:700;
      margin-bottom:10px;
      box-shadow:0 3px 6px rgba(0,0,0,0.4);
    "></div>

    <!-- Enable Button -->
    <button id="notifyEnableBtn" onclick="enableNotifications()" style="
      display:none;
      background:#b30000;
      color:white;
      border:none;
      padding:12px 22px;
      font-size:1em;
      font-weight:700;
      border-radius:8px;
      cursor:pointer;
      box-shadow:0 3px 6px rgba(0,0,0,0.4);
    ">
      ğŸ”” Enable Notifications
    </button>

    <!-- Disable Button -->
    <button id="notifyDisableBtn" onclick="disableNotifications()" style="
      display:none;
      background:#555;
      color:white;
      border:none;
      padding:12px 22px;
      font-size:1em;
      font-weight:700;
      border-radius:8px;
      cursor:pointer;
      box-shadow:0 3px 6px rgba(0,0,0,0.4);
      margin-top:8px;
    ">
      ğŸ”• Disable Notifications
    </button>

    <!-- Description -->
    <p id="notifyMsg" style="font-size:0.8em; color:#aaa; margin-top:6px; display:none;">
      Get alerts when Big Red is LIVE, weekend rundowns, airport alerts, and more.
    </p>

    <!-- iOS Tip -->
    <p id="iosTip" style="font-size:0.8em; color:#ffcc66; margin-top:6px; display:none;">
      ğŸ‘‰ On iPhone: Tap the Share icon â†’ Add to Home Screen â†’ Then return to enable alerts.
    </p>

  </div>

  <!-- ğŸ§­ â€œWhere To?â€ -->
  <div class="info-section" style="text-align:center; margin-top:20px;">
    <h2 style="margin-bottom:10px;">Plan Your Connection</h2>

    <form id="quickDestination" onsubmit="goToFare(event)" style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap;">
      <input id="quickWhere" type="text" placeholder="Where to?" required 
             style="flex:1;min-width:220px;max-width:420px;padding:12px;border-radius:10px;border:1px solid #333;background:#111;color:#fff;">
      <button type="submit" class="btn primary">â¡ï¸ Next</button>
    </form>

    <p style="font-size:0.9em;color:#888;margin-top:6px;">
      Tip: Start typing a place, business, or address â€” suggestions will appear.
    </p>
  </div>

  <!-- ğŸ§± Navigation Tiles -->
  <div class="tile-grid">
    <a href="farecalculator.html" class="tile">ğŸ’²<br>Fare Calculator</a>
    <a href="live.html" class="tile">ğŸ—ºï¸<br>Live Map</a>
    <a href="reviews.html" class="tile">â­<br>Rider Reviews</a>
    <a href="faq.html" class="tile">â„¹ï¸<br>FAQ & Info</a>
    <a href="https://www.facebook.com/share/1BWCx63CUt/?mibextid=wwXIfr" target="_blank" class="tile">ğŸ‘<br>Follow on Facebook</a>
  </div>

  <!-- What I Do -->
  <section class="info-section">
    <h2>What I Do</h2>
    <p>I offer local ride connections across the Oklahoma City metro â€” from workdays and class runs to weekend nights, OU games, and airport trips.</p>
    <ul>
      <li>Daily work, school, and appointment connections</li>
      <li>Airport and Tinker AFB flat-rate rides</li>
      <li>Evening and nightlife link-ups</li>
      <li>Event, casino, and concert trips â€” plan ahead and ride local</li>
    </ul>
  </section>

  <!-- Why Choose Red -->
  <section class="info-section">
    <h2>Why Choose Red</h2>
    <ul>
      <li>Veteran-owned and operated â€” every connection is personal.</li>
      <li>Flat-rate, fair pricing with zero surprises.</li>
      <li>One trusted driver â€” no random apps or surge pricing.</li>
    </ul>
  </section>

  <!-- Reviews -->
  <section class="info-section">
    <h2>What Riders Say</h2>
    <div class="review-card">
      â­â­â­â­â­ â€œAlways dependable and easy to reach. Flat rate, no surprises.â€<br>
      â€” <strong>Alex, Norman</strong>
    </div>
    <div class="review-card">
      â­â­â­â­â­ â€œFeels like riding with a friend, not an app. My go-to for nights out.â€<br>
      â€” <strong>Taylor, OKC</strong>
    </div>
    <p><a href="reviews.html">See more reviews â†’</a></p>
  </section>

  <!-- Footer -->
  <footer>
    <p>Questions or ride connection requests?<br>Text <strong>â€œREDâ€</strong> to (405) 378-4024.</p>
    <p><a href="faq.html">FAQ & Policies</a> | <a href="reviews.html">Leave a Review</a></p>
    <p>&copy; 2025 Big Red Connect</p>
  </footer>

  <!-- Google Places -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCMM0dxLNM7XQI5G3OBSnINeO5hcS3Ks5I&libraries=places"></script>
  <script>
    let whereAuto;
    function initQuickSearch() {
      whereAuto = new google.maps.places.Autocomplete(
        document.getElementById("quickWhere"),
        { fields: ["formatted_address", "name"] }
      );
    }
    function goToFare(e) {
      e.preventDefault();
      const dest = document.getElementById("quickWhere").value.trim();
      if (dest) {
        window.location.href = "farecalculator.html?dropoff=" + encodeURIComponent(dest);
      }
    }
    window.onload = initQuickSearch;
  </script>

  <!-- Status Pill -->
  <script src="status.js?v=20251026"></script>

  <!-- Refresh Button Logic -->
  <script>
    const refreshBtn = document.getElementById("refreshButton");
    let refreshTimeout;

    function showRefreshButton(){ refreshBtn.classList.add("visible"); }
    function hideRefreshButton(){
      refreshBtn.classList.remove("visible");
      clearTimeout(refreshTimeout);
      refreshTimeout = setTimeout(showRefreshButton, 30000);
    }

    refreshBtn.addEventListener("click", () => {
      hideRefreshButton();
      location.reload(true);
    });

    window.addEventListener("load", () => {
      refreshTimeout = setTimeout(showRefreshButton, 30000);
    });
  </script>

  <style>
    #refreshButton {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #b30000;
      color:#fff;
      border:none;
      border-radius:6px;
      padding:10px 16px;
      font-size:0.95em;
      font-weight:700;
      cursor:pointer;
      box-shadow:0 2px 6px rgba(0,0,0,0.4);
      opacity:0;
      pointer-events:none;
      transition:opacity .5s ease;
      z-index:10;
    }
    #refreshButton.visible {
      opacity:1;
      pointer-events:auto;
    }
    #refreshButton:hover { background:#cc0000; }
  </style>

</body>
</html>