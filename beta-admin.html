<script>
const STATUS_WORKER="https://bigred-status-updater.bigredtransportation.workers.dev";
const LOCATION_WORKER="https://update-location.bigredtransportation.workers.dev";
const AUTH_SECRET="BigRedPrivateKey2025";
const TZ="America/Chicago";

const pill=document.getElementById("status-pill");
const statusStamp=document.getElementById("statusStamp");
const gpsStamp=document.getElementById("gpsStamp");
const gpsRate=document.getElementById("gpsRate");
const select=document.getElementById("statusSelect");
const livePill=document.getElementById("livePill");
const toast=document.getElementById("toast");
const gpsPermission=document.getElementById("gpsPermission");
const requestGPSBtn=document.getElementById("requestGPSBtn");

function showToast(msg,ms=2000){toast.textContent=msg;toast.style.opacity=1;setTimeout(()=>toast.style.opacity=0,ms);}
function logDebug(msg){
 const el=document.getElementById("debugLog");
 const now=new Date().toLocaleTimeString("en-US",{hour12:false});
 el.innerHTML=`[${now}] ${msg}<br>`+el.innerHTML;
}

document.getElementById("refreshPage").onclick=()=>{showToast("Refreshing‚Ä¶");setTimeout(()=>location.reload(true),350);};

async function fetchStatus(){
 try{
  const res=await fetch(STATUS_WORKER+"/status?nocache="+Date.now(),{cache:"no-store"});
  const j=await res.json();
  renderStatusPill(j.status,j.updated);
  select.value=j.status;
  buildPreview(j.status);
  if(j.status==="online")startGPSLoop(30000);
  else if(j.status==="away")startGPSLoop(60000);
  else stopGPSLoop();
 }catch(e){renderStatusPill("offline");}
}

function fmtLocal(iso){if(!iso)return"‚Äî";return new Date(iso).toLocaleString("en-US",{timeZone:TZ});}
function renderStatusPill(state,iso){
 pill.classList.remove("online","away","offline");
 let stamp=fmtLocal(iso);
 if(state==="online"){pill.classList.add("online");pill.textContent=`üü¢ Online ‚Äî as of ${stamp}`;}
 else if(state==="away"){pill.classList.add("away");pill.textContent=`üü° Limited ‚Äî as of ${stamp}`;}
 else{pill.classList.add("offline");pill.textContent=`üî¥ Offline ‚Äî as of ${stamp}`;}
 statusStamp.textContent=stamp;
}

requestGPSBtn.addEventListener("click",()=>{
 if(!navigator.geolocation){alert("GPS not supported on this device.");return;}
 navigator.geolocation.getCurrentPosition(
  pos=>{
    showToast("‚úÖ Location permission granted!");
    gpsPermission.style.display="none";
    const{latitude,longitude}=pos.coords;
    sendGPS(latitude,longitude);
  },
  err=>{
    console.warn("‚ùå Permission denied:",err);
    alert("Location permission was denied. Enable it in Settings ‚Üí Privacy ‚Üí Location Services.");
  },
  {enableHighAccuracy:true,timeout:10000}
 );
});
function maybeShowGPSPrompt(status){
 if(status==="online"){gpsPermission.style.display="block";}
 else{gpsPermission.style.display="none";}
}

document.getElementById("updateStatusBtn").onclick=async()=>{
 const newStatus=select.value;
 const payload={status:newStatus,updated:new Date().toISOString()};
 try{
  const res=await fetch(STATUS_WORKER+"/",{method:"PUT",headers:{"Content-Type":"application/json","X-Auth-Token":AUTH_SECRET},body:JSON.stringify(payload)});
  if(!res.ok)throw new Error(await res.text());
  renderStatusPill(newStatus,payload.updated);
  showToast("‚úÖ Status updated");
  buildPreview(newStatus);
  maybeShowGPSPrompt(newStatus);
  if(newStatus==="online")startGPSLoop(30000);
  else stopGPSLoop();
 }catch(e){showToast("‚ö†Ô∏è Update failed");}
};

/* === SMART PREVIEW BUILDER (Merged) === */
function buildPreview(status){
 const img=document.getElementById("statusImage");
 const caption=document.getElementById("captionBox");
 const now=new Date();
 const hour=now.getHours();
 const month=now.getMonth();

 const isHoliday=(month===10||month===11);
 const isDay=hour>=7&&hour<18;

 const dayImages=[
   "3F34BE7E-5953-433C-B8D0-17AC9108107F.png",
   "B02AB3EA-1AF5-4BE4-8CBB-E5A1AA40711F.png",
   "Big Red Live 2.png",
   "Big Red Live Text Only.png"
 ];

 const nightImages=[
   "3673A967-4A2D-4F9C-8602-0C820D31D168.png",
   "982ABF7A-D9F5-403D-BAE8-13777EC286FB.png",
   "BA7E86CF-5782-4323-B0B2-19918EF67887.png",
   "0081086F-89FA-41B2-85EB-E4EE97E9E8EF.png",
   "Big Red Live 2.png"
 ];

 const holidayImages=[
   "3673A967-4A2D-4F9C-8602-0C820D31D168.png",
   "982ABF7A-D9F5-403D-BAE8-13777EC286FB.png",
   "B02AB3EA-1AF5-4BE4-8CBB-E5A1AA40711F.png",
   "Big Red Live Holiday 1.png",
   "Big Red Live Christmas.png",
   "Big Red Live Thanksgiving.png"
 ];

 let chosen;
 if(isHoliday){
   chosen=holidayImages[Math.floor(Math.random()*holidayImages.length)];
 }else if(isDay){
   chosen=dayImages[Math.floor(Math.random()*dayImages.length)];
 }else{
   chosen=nightImages[Math.floor(Math.random()*nightImages.length)];
 }

 img.src=`https://raw.githubusercontent.com/bigred202403/Big-Red-Connect/main/${encodeURIComponent(chosen)}`;

 const dayNames=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
 const weekday=dayNames[now.getDay()];
 let base="";
 if(status==="online"){
   if(isHoliday){
     base=`üéÑ ${weekday} Moves ‚Äì Big Red Connect is LIVE this holiday season! From last call to your front door, ride local and ride safe.`;
   }else if(isDay){
     base=`üöó ${weekday} Moves ‚Äì Big Red Connect is LIVE! Affordable, local, and ready for your next daytime ride.`;
   }else{
     base=`üåô ${weekday} Nights ‚Äì Big Red Connect is LIVE! From last call to your front door, ride local and ride safe.`;
   }
 }else if(status==="away"){
   base=`üïë ${weekday} Update ‚Äì Big Red Connect is temporarily away but back soon!`;
 }else{
   base=`üî¥ ${weekday} Update ‚Äì Big Red Connect is currently offline. Thanks for riding local!`;
 }

 const CTA="\n\nNo surprises. Just solid local moves.\nText ‚ÄòRED‚Äô to 405-378-4024 ‚Äî your affordable flat-rate ride connection.\nVeteran Owned ‚Ä¢ Affordable ‚Ä¢ Local ‚Ä¢ Trusted.";
 caption.value=base+CTA;
}

/* === Share / Copy Buttons === */
document.getElementById("copyBtn").onclick=()=>{navigator.clipboard.writeText(document.getElementById("captionBox").value);showToast("üìã Caption copied");};
document.getElementById("shareBtn").onclick=()=>{const c=encodeURIComponent(document.getElementById("captionBox").value);
window.open(`https://www.facebook.com/sharer/sharer.php?u=https://bigred202403.github.io/Big-Red-Connect/&quote=${c}`,"_blank");};

/* === GPS LOOP (recursive) + WAKE LOCK === */
let gpsTimerActive=false;let wakeLock=null;let currentIntervalMs=0;
function setLivePill(active,rateMs){
 livePill.classList.remove("online","away","offline");
 if(active){livePill.classList.add("online");livePill.textContent="üì° Tracking: ON";}
 else{livePill.classList.add("offline");livePill.textContent="üì° Tracking: OFF";}
 gpsRate.textContent=active?`${Math.round(rateMs/1000)}s`:"‚Äî";
}

async function sendGPS(lat,lng){
 const payload={latitude:lat,longitude:lng,timestamp:new Date().toISOString()};
 try{
  logDebug(`Sending GPS ‚Üí ${lat.toFixed(5)}, ${lng.toFixed(5)}`);
  const res=await fetch(LOCATION_WORKER,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});
  if(res.ok){
    gpsStamp.textContent=fmtLocal(payload.timestamp);
    logDebug("‚úÖ GPS sent OK");
  }else{
    logDebug("‚ö†Ô∏è GPS push failed "+res.status);
  }
 }catch(e){
  logDebug("‚ùå GPS send error: "+e.message);
 }
}

function startGPSLoop(intervalMs){
 stopGPSLoop();
 currentIntervalMs=intervalMs;
 gpsTimerActive=true;
 setLivePill(true,currentIntervalMs);
 requestWakeLock();
 logDebug("GPS loop started ("+intervalMs+"ms)");
 const loop=()=>{
   if(!gpsTimerActive)return;
   if(!navigator.geolocation){showToast("‚ö†Ô∏è Enable Location Services");return;}
   logDebug("‚è∞ GPS tick");
   navigator.geolocation.getCurrentPosition(
     (pos)=>{const{latitude,longitude}=pos.coords;sendGPS(latitude,longitude);},
     (err)=>logDebug("GPS error "+err.message),
     {enableHighAccuracy:true,maximumAge:8000,timeout:8000}
   );
   setTimeout(loop,currentIntervalMs);
 };
 loop();
}

function stopGPSLoop(){
 gpsTimerActive=false;
 currentIntervalMs=0;
 setLivePill(false,0);
 releaseWakeLock();
 logDebug("GPS loop stopped");
}

async function requestWakeLock(){try{if('wakeLock'in navigator){wakeLock=await navigator.wakeLock.request('screen');logDebug("Wake lock granted");}}catch(e){logDebug("Wake lock denied "+e.message);}}
async function releaseWakeLock(){if(wakeLock){try{await wakeLock.release();logDebug("Wake lock released");}catch{}wakeLock=null;}}

window.addEventListener("pagehide",()=>{stopGPSLoop();});
fetchStatus();

/* === PWA Service Worker === */
if("serviceWorker"in navigator){
 window.addEventListener("load",()=>{
  navigator.serviceWorker.register("sw.js")
  .then(()=>console.log("‚úÖ Service Worker registered for Admin PWA"))
  .catch(err=>console.warn("‚ö†Ô∏è SW registration failed:",err));
 });
}
</script>