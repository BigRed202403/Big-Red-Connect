<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Admin Big Red (Beta)</title>

<!-- Icons / PWA basics -->
<link rel="apple-touch-icon" href="icon.png">
<link rel="icon" type="image/png" sizes="192x192" href="icon.png">
<link rel="shortcut icon" href="icon.png">
<meta name="theme-color" content="#000000">

<style>
:root { --red:#b30000; --bg:#000; --panel:#111; --muted:#aaa; }
body{background:var(--bg);color:#fff;font-family:Arial,Helvetica,sans-serif;margin:0;text-align:center;}
header{background:var(--panel);display:flex;justify-content:space-between;align-items:center;
padding:10px 16px;border-bottom:2px solid var(--red);}
.bar-left{color:#bbb;font-size:.92em;display:flex;gap:10px;align-items:center;}
.pill{padding:4px 10px;border-radius:999px;font-weight:700;font-size:.85em;}
.pill.online{background:#064;} .pill.away{background:#665500;} .pill.offline{background:#400;}
.refresh-btn{background:var(--red);color:#fff;border:none;padding:8px 14px;border-radius:6px;cursor:pointer;font-weight:700;}
.refresh-btn:hover{background:#cc0000;}
h1{margin:18px 0 6px;color:var(--red);font-size:1.6rem;}
.tagline{color:#ddd;margin:0 0 8px;font-size:.95rem;}
.status{margin:10px auto;padding:10px;border-radius:6px;display:inline-block;min-width:280px;}
.status.online{background:#064;} .status.away{background:#665500;} .status.offline{background:#400;}
.grid{display:grid;grid-template-columns:1fr;gap:18px;max-width:880px;margin:0 auto;padding:10px 16px 24px;}
section{background:var(--panel);border:1px solid #222;border-radius:8px;padding:14px;}
section h2{margin:6px 0 8px;font-size:1.1rem;}
select,button{padding:10px;border-radius:6px;border:none;margin:6px;font-weight:700;}
.btn-primary{background:var(--red);color:#fff;} .btn-secondary{background:#000;color:#fff;border:1px solid var(--red);}
.row{display:flex;justify-content:center;align-items:center;flex-wrap:wrap;gap:6px;}
.meta{color:var(--muted);font-size:.85em;margin-top:6px;}
.img-box{max-width:95%;margin:10px auto;border:3px solid var(--red);border-radius:6px;padding:8px;}
.img-box img{width:100%;border-radius:6px;}
textarea{width:95%;max-width:780px;height:120px;background:#111;color:#fff;border:2px solid var(--red);
border-radius:6px;padding:8px;}
footer{margin:18px 0 24px;font-size:.9em;color:#777;}
#toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);
background:var(--red);color:#fff;padding:8px 16px;border-radius:6px;opacity:0;transition:opacity .35s;z-index:5;}
#debugLog{font-family:monospace;font-size:0.75rem;color:#0f0;background:#000;
padding:6px;max-height:200px;overflow:auto;text-align:left;border-top:1px solid #222;}
</style>
</head>
<body>

<header>
  <div class="bar-left">
    <span>ðŸ”’ Internal Use Only</span>
    <span id="livePill" class="pill offline">ðŸ“¡ Tracking: OFF</span>
  </div>
  <button class="refresh-btn" id="refreshPage">ðŸ”„ Refresh Page</button>
</header>

<h1>Big Red Connect â€” Admin Console (Beta)</h1>
<p class="tagline">Veteran Owned â€¢ Affordable â€¢ Local â€¢ Trusted</p>

<div id="status-pill" class="status">Checking statusâ€¦</div>

<div class="grid">
  <!-- CONTROL -->
  <section id="control">
    <h2>Update Driving Status</h2>
    <div class="row">
      <select id="statusSelect">
        <option value="online">ðŸŸ¢ On the Road</option>
        <option value="away">ðŸŸ¡ Limited Availability</option>
        <option value="offline">ðŸ”´ Offline</option>
      </select>
      <button class="btn-primary" id="updateStatusBtn">ðŸ’¾ Save Status</button>
    </div>
    <div class="meta">
      <div>Last status update: <span id="statusStamp">â€”</span></div>
      <div>Last GPS ping: <span id="gpsStamp">â€”</span> â€¢ Interval: <span id="gpsRate">â€”</span></div>
    </div>
  </section>

  <!-- QUICK SHARE -->
  <section id="share">
    <h2>Quick Share Builder</h2>
    <div class="img-box"><img id="statusImage" src="" alt="Preview"></div>
    <textarea id="captionBox" readonly>Loading caption...</textarea>
    <div class="row">
      <button class="btn-secondary" id="copyBtn">ðŸ“‹ Copy Caption</button>
      <button class="btn-primary" id="shareBtn">ðŸ“¤ Share on Facebook</button>
    </div>
    <div class="meta">Preview updates automatically by status, time & holiday logic.</div>
  </section>
</div>

<footer>Â© 2025 Big Red Connect â€” Admin Panel Beta</footer>
<div id="toast"></div>
<div id="debugLog">[Debug log started]</div>

<script>
/* === CONFIG === */
const STATUS_WORKER="https://bigred-status-updater.bigredtransportation.workers.dev";
const LOCATION_WORKER="https://update-location.bigredtransportation.workers.dev";
const AUTH_SECRET="BigRedPrivateKey2025";
const TZ="America/Chicago";

/* === ELEMENTS === */
const pill=document.getElementById("status-pill");
const statusStamp=document.getElementById("statusStamp");
const gpsStamp=document.getElementById("gpsStamp");
const gpsRate=document.getElementById("gpsRate");
const select=document.getElementById("statusSelect");
const livePill=document.getElementById("livePill");
const toast=document.getElementById("toast");

/* === UTILS === */
function showToast(msg,ms=2500){toast.textContent=msg;toast.style.opacity=1;setTimeout(()=>toast.style.opacity=0,ms);}
function logDebug(msg){
 const el=document.getElementById("debugLog");
 const now=new Date().toLocaleTimeString("en-US",{hour12:false});
 el.innerHTML=`[${now}] ${msg}<br>`+el.innerHTML;
}
function fmtLocal(iso){if(!iso)return"â€”";return new Date(iso).toLocaleString("en-US",{timeZone:TZ});}

/* === Refresh Page === */
document.getElementById("refreshPage").onclick=()=>{showToast("Refreshingâ€¦");setTimeout(()=>location.reload(true),350);};

/* === Status Fetch + Render === */
async function fetchStatus(){
 try{
  const res=await fetch(`${STATUS_WORKER}/status?nocache=${Date.now()}`,{cache:"no-store"});
  const j=await res.json();
  renderStatusPill(j.status,j.updated);
  select.value=j.status;
  buildPreview(j.status);
  if(j.status==="online") startGPSLoop(30000);  // âœ… Online only: 30s
  else stopGPSLoop();                           // âŒ No loop for Away/Offline
 }catch(e){renderStatusPill("offline");}
}
function renderStatusPill(state,iso){
 pill.classList.remove("online","away","offline");
 const stamp=fmtLocal(iso);
 if(state==="online"){pill.classList.add("online");pill.textContent=`ðŸŸ¢ Online â€” as of ${stamp}`;}
 else if(state==="away"){pill.classList.add("away");pill.textContent=`ðŸŸ¡ Limited â€” as of ${stamp}`;}
 else{pill.classList.add("offline");pill.textContent=`ðŸ”´ Offline â€” as of ${stamp}`;}
 statusStamp.textContent=stamp;
}

/* === Status Update Button (kept as-fixed) === */
document.getElementById("updateStatusBtn").onclick=async()=>{
 const newStatus=select.value;
 const payload={status:newStatus,updated:new Date().toISOString()};
 try{
  const res=await fetch(`${STATUS_WORKER}/`,{
    method:"PUT",
    headers:{
      "Content-Type":"application/json",
      "X-Auth-Token":AUTH_SECRET
    },
    body:JSON.stringify(payload)
  });
  const resultText=await res.text();
  if(!res.ok) throw new Error(resultText);
  logDebug("âœ… Worker response: "+resultText);
  renderStatusPill(newStatus,payload.updated);
  showToast("âœ… Status saved successfully!");
  buildPreview(newStatus);
  if(newStatus==="online") startGPSLoop(30000); else stopGPSLoop();
 }catch(e){
  logDebug("âŒ Status update error: "+e.message);
  showToast("âš ï¸ Failed to save status");
 }
};

/* === Smart Preview Builder (Holiday + Day/Night + Offline wrap) === */
function buildPreview(status){
 const img=document.getElementById("statusImage");
 const caption=document.getElementById("captionBox");
 const now=new Date();
 const hour=now.getHours();
 const month=now.getMonth();
 const isHoliday=(month===10||month===11); // Nov/Dec
 const isDay=hour>=7&&hour<18;
 const weekday=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"][now.getDay()];

 // Clean image sets (no overlaid text graphics in offline)
 const dayImgs=["3F34BE7E-5953-433C-B8D0-17AC9108107F.png","B02AB3EA-1AF5-4BE4-8CBB-E5A1AA40711F.png","Big Red Live 2.png"];
 const nightImgs=["3673A967-4A2D-4F9C-8602-0C820D31D168.png","982ABF7A-D9F5-403D-BAE8-13777EC286FB.png","0081086F-89FA-41B2-85EB-E4EE97E9E8EF.png"];
 const holidayImgs=["B02AB3EA-1AF5-4BE4-8CBB-E5A1AA40711F.png","3673A967-4A2D-4F9C-8602-0C820D31D168.png","982ABF7A-D9F5-403D-BAE8-13777EC286FB.png","Big Red Live Holiday 1.png","Big Red Live Christmas.png","Big Red Live Thanksgiving.png"];

 let chosen="";
 if(status==="offline"){
   const offlineImgs=["3673A967-4A2D-4F9C-8602-0C820D31D168.png","982ABF7A-D9F5-403D-BAE8-13777EC286FB.png","0081086F-89FA-41B2-85EB-E4EE97E9E8EF.png"];
   chosen=offlineImgs[Math.floor(Math.random()*offlineImgs.length)];
 } else if(isHoliday){
   chosen=holidayImgs[Math.floor(Math.random()*holidayImgs.length)];
 } else if(isDay){
   chosen=dayImgs[Math.floor(Math.random()*dayImgs.length)];
 } else {
   chosen=nightImgs[Math.floor(Math.random()*nightImgs.length)];
 }
 img.src=`https://raw.githubusercontent.com/bigred202403/Big-Red-Connect/main/${encodeURIComponent(chosen)}`;

 let base="";
 if(status==="online"){
   base=isHoliday
     ? `ðŸŽ„ ${weekday} Moves â€“ Big Red Connect is LIVE this holiday season! From last call to your front door, ride local and ride safe.`
     : (isDay
        ? `ðŸš— ${weekday} Moves â€“ Big Red Connect is LIVE! Affordable, local, and ready for your next daytime ride.`
        : `ðŸŒ™ ${weekday} Nights â€“ Big Red Connect is LIVE! From last call to your front door, ride local and ride safe.`);
 }
 else if(status==="away"){
   base=`ðŸ•‘ ${weekday} Update â€“ Big Red Connect is temporarily away but back soon!`;
 }
 else if(status==="offline"){
   // ðŸ‘‹ â€œSee you â€¦â€ line with day/night + holiday awareness
   const dayNames=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
   const day=now.getDay();
   const nextDay=(day+1)%7;
   let seeYouMsg="";
   if(day===0){ // Sunday
     seeYouMsg=isHoliday
       ? "ðŸŽ„ Back on the road Monday night â€” plan ahead with Big Red this holiday season!"
       : "ðŸ‘‹ Back on the road Monday night â€” plan ahead with Big Red!";
   } else if(isDay){
     seeYouMsg=isHoliday
       ? "ðŸŽ See you tonight â€” plan ahead and ride local this holiday season!"
       : "ðŸ‘‹ See you tonight â€” plan ahead with Big Red!";
   } else {
     seeYouMsg=isHoliday
       ? `ðŸŽ„ See you ${dayNames[nextDay]} night â€” plan ahead and ride local this holiday season!`
       : `ðŸ‘‹ See you ${dayNames[nextDay]} night â€” plan ahead with Big Red!`;
   }

   if(isHoliday){
     base = isDay
       ? `ðŸŽ„ Wrapped up another round of solid local moves.\nThanks to everyone who planned ahead and rode local today!\n\n${seeYouMsg}`
       : `ðŸŽ Thatâ€™s a wrap for tonightâ€™s holiday connections.\nAppreciate everyone who rode local and kept it festive and safe!\n\n${seeYouMsg}`;
   } else {
     base = isDay
       ? `âœ… Wrapped up another round of solid local moves.\nThanks to everyone who planned ahead and rode local today.\n\n${seeYouMsg}`
       : `ðŸŒ™ Thatâ€™s a wrap for tonightâ€™s connections.\nBig Red is signing off â€” appreciate everyone who rode local and kept it safe out there.\n\n${seeYouMsg}`;
   }
   showToast("ðŸ“£ Wrap-Up caption ready to post!");
 }

 const CTA="\n\nNo surprises. Just solid local moves.\nText â€˜REDâ€™ to 405-378-4024 â€” your affordable flat-rate ride connection.\nVeteran Owned â€¢ Affordable â€¢ Local â€¢ Trusted.";
 caption.value=base+CTA;
}

/* === Copy / Share === */
document.getElementById("copyBtn").onclick=()=>{navigator.clipboard.writeText(document.getElementById("captionBox").value);showToast("ðŸ“‹ Caption copied");};
document.getElementById("shareBtn").onclick=()=>{const c=encodeURIComponent(document.getElementById("captionBox").value);
window.open(`https://www.facebook.com/sharer/sharer.php?u=https://bigred202403.github.io/Big-Red-Connect/&quote=${c}`,"_blank");};

/* === GPS loop (Online only) + Wake Lock === */
let gpsTimerActive=false, wakeLock=null;
function setLivePill(active,rateMs){
 livePill.classList.remove("online","away","offline");
 livePill.classList.add(active?"online":"offline");
 livePill.textContent=active?"ðŸ“¡ Tracking: ON":"ðŸ“¡ Tracking: OFF";
 gpsRate.textContent=active?`${Math.round(rateMs/1000)}s`:"â€”";
}
async function sendGPS(lat,lng){
 const payload={latitude:lat,longitude:lng,timestamp:new Date().toISOString()};
 try{
  logDebug(`Sending GPS â†’ ${lat.toFixed(5)}, ${lng.toFixed(5)}`);
  const res=await fetch(LOCATION_WORKER,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});
  if(res.ok){gpsStamp.textContent=fmtLocal(payload.timestamp);logDebug("âœ… GPS sent OK");}
  else{logDebug("âš ï¸ GPS push failed "+res.status);}
 }catch(e){logDebug("âŒ GPS send error: "+e.message);}
}
function startGPSLoop(intervalMs){
 stopGPSLoop();
 gpsTimerActive=true; setLivePill(true,intervalMs); requestWakeLock();
 const loop=()=>{if(!gpsTimerActive)return;
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(
      pos=>sendGPS(pos.coords.latitude,pos.coords.longitude),
      err=>logDebug("GPS error "+err.message),
      {enableHighAccuracy:true,maximumAge:8000,timeout:8000}
    );
  }
  setTimeout(loop,intervalMs);
 }; loop();
}
function stopGPSLoop(){gpsTimerActive=false; setLivePill(false,0); releaseWakeLock();}
async function requestWakeLock(){try{if('wakeLock'in navigator){wakeLock=await navigator.wakeLock.request('screen');}}catch{}}
async function releaseWakeLock(){if(wakeLock){try{await wakeLock.release();}catch{}wakeLock=null;}}
window.addEventListener("pagehide",()=>{stopGPSLoop();});

/* Init */
fetchStatus();

/* PWA SW (optional) */
if("serviceWorker"in navigator){
 window.addEventListener("load",()=>{
  navigator.serviceWorker.register("sw.js").catch(()=>{});
 });
}
</script>
</body>
</html>