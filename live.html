<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Big Red Connect â€” Live Map</title>

  <!-- ðŸ“± PWA / Icons -->
  <link rel="apple-touch-icon" href="icon.PNG">
  <link rel="icon" type="image/png" sizes="192x192" href="icon.png">
  <link rel="shortcut icon" href="icon.PNG">
  <link rel="manifest" href="manifest.json">
  <meta name="apple-mobile-web-app-title" content="Big Red Connect">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="theme-color" content="#000000">

  <style>
    body {
      background: #000;
      color: #fff;
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 0;
      padding: 0;
    }
    h1 {
      color: #b30000;
      margin-top: 20px;
    }
    p.tagline {
      color: #ccc;
      margin-bottom: 10px;
    }
    #map {
      height: 340px;
      width: 95%;
      max-width: 700px;
      margin: 10px auto;
      border: 2px solid #b30000;
      border-radius: 8px;
    }
    .status {
      display: inline-block;
      padding: 10px 16px;
      border-radius: 20px;
      margin: 10px 0;
      font-weight: bold;
      font-size: 1em;
    }
    .status.online { background: #064; }
    .status.away { background: #665500; }
    .status.offline { background: #400; }
    footer {
      margin: 20px 0;
      font-size: 0.9em;
      color: #aaa;
    }
    a {
      color: #b30000;
      text-decoration: none;
    }
  </style>
</head>

<body>
  <h1>Big Red Live Map</h1>
  <p class="tagline">See where Big Red is right now.</p>

  <div id="status-pill" class="status">Checking statusâ€¦</div>
  <div id="map"></div>

  <footer>
    <p>&copy; 2025 Big Red Connect â€” <a href="index.html">Return Home</a></p>
  </footer>

  <script src="status.js"></script>
  <script>
    const LOCATION_READER = "https://location-reader.bigredtransportation.workers.dev";
    const HQ = { lat: 35.3400, lng: -97.4900 }; // fallback HQ coordinates
    const STALE_MIN = 30;

    let map, driverMarker;

    async function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: HQ,
        zoom: 11,
        mapTypeControl: false,
        streetViewControl: false,
        fullscreenControl: false,
      });
      await loadDriverLocation();
    }

    async function loadDriverLocation() {
      try {
        const res = await fetch(LOCATION_READER + "?nocache=" + Date.now(), { cache: "no-store" });
        const j = await res.json();
        const lat = parseFloat(j.latitude);
        const lng = parseFloat(j.longitude);
        const ts = j.timestamp ? new Date(j.timestamp) : null;
        const ageMin = ts ? (Date.now() - ts.getTime()) / 60000 : 999;

        let pos = HQ;
        if (!isNaN(lat) && !isNaN(lng) && ageMin <= STALE_MIN) {
          pos = { lat, lng };
        }

        if (driverMarker) driverMarker.setMap(null);
        driverMarker = new google.maps.Marker({
          position: pos,
          map,
          label: "ðŸš—",
          title: "Big Red (Live Position)"
        });

        map.setCenter(pos);
      } catch (err) {
        console.warn("âš ï¸ Failed to load driver position:", err);
      }
    }

    document.addEventListener("statusUpdated", async (e) => {
      const state = e.detail;
      if (state === "online") {
        await loadDriverLocation();
        setInterval(loadDriverLocation, 30000);
      }
    });
  </script>

  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCMM0dxLNM7XQI5G3OBSnINeO5hcS3Ks5I&callback=initMap">
  </script>
</body>
</html>