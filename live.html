<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Big Red Connect â€” Live Map & ETA</title>

  <link rel="apple-touch-icon" href="icon.PNG">
  <link rel="icon" type="image/png" sizes="192x192" href="icon.png">
  <link rel="shortcut icon" href="icon.PNG">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#000000">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <link rel="stylesheet" href="style.css" />

  <style>
    body { text-align:center; color:#fff; background:#000; font-family:Arial, sans-serif; }
    #map { height:340px; width:100%; border-radius:10px; margin-top:10px; }
    .hidden { display:none !important; }
    #status-message { background:#111; border:1px solid #f00; padding:14px; border-radius:8px; margin-top:12px; }
    .pulse-marker {
      position:absolute; width:20px; height:20px;
      background:rgba(255,0,0,0.5); border-radius:50%;
      animation:pulse 2s infinite; transform:translate(-10px,-10px);
    }
    @keyframes pulse {
      0% { transform:scale(0.8); opacity:0.6; }
      50% { transform:scale(1.5); opacity:0.3; }
      100% { transform:scale(0.8); opacity:0.6; }
    }
  </style>
</head>
<body>
  <h1>Big Red Live Map & ETA</h1>
  <p class="tagline">See where Big Red is â€” and how long until arrival.</p>

  <div id="status-pill" class="status status--loading">Checking statusâ€¦</div>
  <div id="map" class="hidden"></div>
  <div id="status-message"></div>

  <script src="status.js"></script>

  <script>
    const LOCATION_READER = "https://location-reader.bigredtransportation.workers.dev";
    const HQ = { lat: 35.3207, lng: -97.4929 };
    const REFRESH_MS = 5000;

    let map, driverMarker, pulseOverlay;
    let currentStatus = "offline";

    document.addEventListener("statusUpdated", (e) => {
      currentStatus = (e.detail || "offline").toLowerCase();
      toggleMap();
    });

    // Load cached status immediately
    const cachedStatus = localStorage.getItem("bigred_status");
    if (cachedStatus) {
      currentStatus = cachedStatus;
      toggleMap();
    }

    window.initMap = async function() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: HQ, zoom: 11, disableDefaultUI: false
      });
      startTracking();
    };

    function toggleMap() {
      const mapDiv = document.getElementById("map");
      const msg = document.getElementById("status-message");

      if (currentStatus === "online") {
        mapDiv.classList.remove("hidden");
        msg.innerHTML = "";
        startTracking();
      } else {
        mapDiv.classList.add("hidden");
        msg.innerHTML =
          currentStatus === "away"
            ? "ðŸŸ¡ Limited Availability â€” between runs or outside usual area."
            : "ðŸ”´ Offline â€” off the road for now. You can still plan ahead anytime.";
      }
    }

    async function fetchLocation() {
      try {
        const res = await fetch(LOCATION_READER + "?nocache=" + Date.now(), { cache: "no-store" });
        const j = await res.json();
        if (j.latitude && j.longitude) return { lat: parseFloat(j.latitude), lng: parseFloat(j.longitude) };
      } catch (e) {
        console.warn("Location fetch failed:", e);
      }
      return HQ;
    }

    async function startTracking() {
      if (currentStatus !== "online") return;
      const pos = await fetchLocation();
      renderMarker(pos);
      setTimeout(startTracking, REFRESH_MS);
    }

    function renderMarker(pos) {
      if (!map) return;
      if (driverMarker) driverMarker.setMap(null);
      if (pulseOverlay) pulseOverlay.setMap(null);

      driverMarker = new google.maps.Marker({ position: pos, map, label: "ðŸš—" });
      const pulseDiv = document.createElement("div");
      pulseDiv.className = "pulse-marker";
      pulseOverlay = new google.maps.OverlayView();
      pulseOverlay.onAdd = function() {
        this.getPanes().overlayLayer.appendChild(pulseDiv);
      };
      pulseOverlay.draw = function() {
        const proj = this.getProjection();
        const pt = proj.fromLatLngToDivPixel(new google.maps.LatLng(pos.lat, pos.lng));
        if (pt) { pulseDiv.style.left = pt.x + "px"; pulseDiv.style.top = pt.y + "px"; }
      };
      pulseOverlay.onRemove = function() { if (pulseDiv.parentNode) pulseDiv.parentNode.remove(); };
      pulseOverlay.setMap(map);
      map.panTo(pos);
    }
  </script>

  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCMM0dxLNM7XQI5G3OBSnINeO5hcS3Ks5I&callback=initMap">
  </script>
</body>
</html>
