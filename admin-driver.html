<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Big Red Admin / Driver Console</title>

<link rel="apple-touch-icon" href="BRCNYE2026.png">
<link rel="icon" type="image/png" sizes="192x192" href="BRCNYE2026.png">
<link rel="shortcut icon" href="BRCNYE2026.png">
<link rel="manifest" href="manifest-admin.json">
<meta name="apple-mobile-web-app-title" content="Big Red Admin">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="theme-color" content="#000">
<meta http-equiv="Cache-Control" content="no-store"/>

<!-- âœ… Google Maps Places (Autocomplete) -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCMM0dxLNM7XQI5G3OBSnINeO5hcS3Ks5I&libraries=places"></script>

<!-- OneSignal v16 -->
<script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
<script>
  window.OneSignalDeferred = window.OneSignalDeferred || [];
  OneSignalDeferred.push(async function(OneSignal){
    try{
      await OneSignal.init({
        appId:"9b8bcc89-87d3-46e2-b2d0-042d1a267718",
        safari_web_id:"web.onesignal.auto.0c90051e-4735-447d-b203-75e3767d91b9",
        notifyButton:{ enable:false },
        serviceWorkerPath:"/onesignalsdkworker.js",
        path:"/"
      });
      await OneSignal.login("admin_driver_live");
      await OneSignal.sendTag("env","live");
      await OneSignal.sendTag("role_admin_live","true");
      await OneSignal.sendTag("role_driver_live","true");
      console.log("[Admin/Driver] OneSignal initialized + tags set.");
    }catch(e){
      console.warn("OneSignal admin-driver init error:",e);
    }
  });

  function enableAdminAlerts(){
    window.OneSignalDeferred.push(async function(OneSignal){
      const supported = OneSignal.Notifications.isPushSupported();
      if(!supported){
        alert("Notifications not supported on this device.");
        return;
      }
      const perm = OneSignal.Notifications.permission;
      if(perm === "granted" || perm === true){
        alert("Alerts already enabled.");
        return;
      }
      await OneSignal.Slidedown.promptPush();
    });
  }
</script>

<style>
:root{--red:#b30000;--bg:#000;--panel:#111;--muted:#aaa;--border:#222;}
*{box-sizing:border-box;}
body{background:var(--bg);color:#fff;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;margin:0;}
header{background:var(--panel);display:flex;justify-content:space-between;align-items:center;padding:8px 12px;border-bottom:2px solid var(--red);position:sticky;top:0;z-index:20;flex-wrap:wrap;gap:8px;}
.header-left{display:flex;align-items:center;gap:10px;font-size:.9rem;min-width:0;flex:1 1 260px;}
.header-left img{height:40px;border-radius:4px;}
.header-right{display:flex;gap:8px;align-items:center;justify-content:flex-end;flex:1 1 260px;flex-wrap:wrap;}
.pill{padding:3px 10px;border-radius:999px;font-weight:700;font-size:.8rem;white-space:nowrap;}
.pill.online{background:#064;}
.pill.away{background:#665500;}
.pill.offline{background:#400;}
.btn{padding:6px 10px;border-radius:8px;border:none;cursor:pointer;font-weight:600;font-size:.85rem;}
.btn-primary{background:var(--red);color:#fff;}
.btn-secondary{background:#000;color:#fff;border:1px solid var(--red);}
.btn-ghost{background:#111;color:#fff;border:1px solid #444;}
h1{text-align:center;margin:14px 0 4px;color:var(--red);font-size:1.4rem;}
.tagline{text-align:center;color:#ddd;margin:0 0 10px;font-size:.9rem;}
#status-pill{margin:10px auto 12px;padding:8px 14px;border-radius:18px;display:inline-block;min-width:260px;font-size:.85rem;background:#222;border:1px solid #333;}
#status-pill.online{background:#064;}
#status-pill.away{background:#665500;}
#status-pill.offline{background:#400;}
.layout{display:grid;grid-template-columns:1fr;gap:14px;max-width:1200px;margin:0 auto 20px;padding:0 10px 18px;}
@media(min-width:900px){.layout{grid-template-columns:1.1fr 1.3fr;}}
section{background:var(--panel);border:1px solid var(--border);border-radius:8px;padding:12px;margin:0;}
section h2{margin:4px 0 8px;font-size:1rem;border-bottom:1px solid #222;padding-bottom:4px;}
.meta{font-size:.78rem;color:var(--muted);margin-top:4px;line-height:1.15rem;}
select,button,input,textarea{font-family:inherit;}
select,button,input[type=text],input[type=url]{padding:7px 9px;border-radius:6px;border:none;margin:4px 0;font-weight:600;font-size:.85rem;}
textarea{width:100%;min-height:90px;background:#111;color:#fff;border:1px solid var(--red);border-radius:6px;padding:8px;resize:vertical;font-size:.85rem;}
.row{display:flex;align-items:center;flex-wrap:wrap;gap:8px;margin:6px 0;}
.preview-box{margin-top:6px;padding:8px;border-radius:6px;border:1px dashed #444;background:#050505;font-size:.8rem;color:#ddd;line-height:1.2rem;}
.img-box{max-width:100%;margin:8px auto 4px;border:2px solid var(--red);border-radius:6px;padding:6px;background:#000;}
.img-box img{width:100%;border-radius:6px;}
.grid-dispatch{display:grid;grid-template-columns:1fr;gap:8px;}
@media(min-width:900px){.grid-dispatch{grid-template-columns:repeat(3,1fr);}}
.column{background:#000;border-radius:8px;border:1px solid #222;overflow:hidden;}
.col-header{padding:8px 10px;border-bottom:1px solid #222;font-weight:700;font-size:.8rem;display:flex;justify-content:space-between;align-items:center;}
.col-body{max-height:60vh;overflow-y:auto;padding:8px;}
.empty-text{text-align:center;color:#777;padding:18px 6px;font-size:.8rem;}
.card{background:#111;border:1px solid #333;border-radius:8px;padding:8px;margin-bottom:8px;font-size:.78rem;}
.card:hover{border-color:#555;}
.card-label-row{display:flex;justify-content:space-between;margin-bottom:4px;gap:8px;}
.badge{padding:2px 6px;border-radius:999px;font-size:.65rem;border:1px solid #666;white-space:nowrap;}
.loc-line{margin:3px 0;font-size:.76rem;}
.eta-line{margin-top:3px;font-size:.75rem;color:#ccc;}
.card-footer{border-top:1px solid #222;margin-top:6px;padding-top:6px;display:flex;justify-content:space-between;align-items:flex-start;gap:6px;flex-wrap:wrap;}
.status-dropdown{background:#111;color:#fff;border:1px solid #333;padding:4px;border-radius:6px;font-size:.75rem;}
.chip{padding:3px 7px;border-radius:999px;border:1px solid #444;background:#111;color:#eee;font-size:.7rem;cursor:pointer;text-decoration:none;display:inline-block;}
.chip.primary{border-color:var(--red);color:#ffdada;}
.chip.warn{border-color:#996600;color:#ffe3b0;}
.chip.danger{border-color:#aa2222;color:#ffb9b9;}
#toast{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:#111;color:#fff;border:1px solid var(--red);padding:8px 16px;border-radius:16px;opacity:0;pointer-events:none;transition:opacity .35s;z-index:50;font-size:.8rem;max-width:92vw;text-align:center;}
#toast.show{opacity:1;}
#debugLog{font-family:monospace;font-size:.72rem;color:#0f0;background:#000;padding:6px;max-height:220px;overflow:auto;border-top:1px solid #222;margin:0 auto 18px;max-width:1200px;}

body.mode-driver .admin-only{display:none;}
body.mode-admin .driver-only{display:none;}

.smalllabel{font-size:.8rem;color:#ccc;display:block;margin-top:6px;}
.minihint{font-size:.72rem;color:#888;margin-top:2px;line-height:1.1rem;}
.stop-row{display:flex;gap:6px;align-items:center;margin:6px 0;}
.stop-row input{flex:1;min-width:180px;}

@media (max-width:520px){
  .header-left img{height:34px;}
  .btn{padding:8px 10px;font-size:.78rem;border-radius:10px;}
  #livePill{padding:3px 8px;font-size:.72rem;}
  .header-left div div:nth-child(2){display:none;}
}
.header-left > div{max-width:160px;min-width:0;}

/* Admin Edit Modal styles */
.modalOverlay{
  position:fixed; inset:0;
  background:rgba(0,0,0,.72);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:999;
  padding:16px;
}
.modalOverlay.show{ display:flex; }
.modalBox{
  width:min(760px, 96vw);
  background:#0b0b0b;
  border:1px solid #333;
  border-radius:12px;
  padding:12px;
  box-shadow: 0 18px 40px rgba(0,0,0,.55);
}
.modalTop{
  display:flex;
  justify-content:space-between;
  gap:10px;
  align-items:center;
  border-bottom:1px solid #222;
  padding-bottom:8px;
  margin-bottom:10px;
}
.modalTitle{
  font-weight:800;
  font-size:.95rem;
}
.modalClose{
  background:#111;
  border:1px solid #444;
  color:#fff;
  border-radius:10px;
  padding:8px 10px;
  cursor:pointer;
  font-weight:700;
}
.modalGrid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
}
@media (max-width:720px){
  .modalGrid{ grid-template-columns:1fr; }
}
.modalBox label{ font-size:.78rem; color:#bbb; display:block; margin:2px 0 4px; }
.modalBox input, .modalBox select, .modalBox textarea{
  width:100%;
  border-radius:10px;
  border:1px solid #333;
  background:#000;
  color:#fff;
  padding:10px;
  font-weight:600;
  font-size:.85rem;
}
.modalActions{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  justify-content:flex-end;
  margin-top:10px;
  border-top:1px solid #222;
  padding-top:10px;
}
.btn-danger{ background:#400; color:#fff; border:1px solid var(--red); }
.btn-small{ padding:6px 10px; font-size:.8rem; border-radius:10px; }
</style>
</head>

<body class="mode-admin">
<header>
  <div class="header-left">
    <a href="index.html"><img src="BRCNYE2026.png" alt="Big Red Connect logo"></a>
    <div>
      <div style="font-weight:700;font-size:.9rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">Big Red Admin / Driver</div>
      <div style="color:#888;font-size:.75rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">Live Dispatch & Status</div>
    </div>
    <span id="livePill" class="pill offline">ğŸ“¡ Tracking: OFF</span>
  </div>
  <div class="header-right">
    <button class="btn btn-secondary" id="btnModeToggle" title="Toggle Admin/Driver">ğŸ›  Admin Mode</button>
    <button class="btn btn-ghost" id="btnRefreshPage" title="Refresh Page">ğŸ”„ Refresh</button>
    <button class="btn btn-secondary" onclick="enableAdminAlerts()" title="Enable Alerts">ğŸ”” Alerts</button>
  </div>
</header>

<h1>Big Red Connect â€” Admin / Driver Console</h1>
<p class="tagline">Veteran Owned â€¢ Affordable â€¢ Local â€¢ Trusted</p>

<div style="text-align:center;">
  <div id="status-pill" class="offline">Status: OFFLINE â€¢ loadingâ€¦</div>
</div>

<div class="layout">
  <div>
    <section>
      <h2>Driving Status & GPS</h2>

      <div class="row">
        <select id="statusSelect">
          <option value="online">ğŸŸ¢ On the Road</option>
          <option value="away">ğŸŸ¡ Limited Availability</option>
          <option value="offline" selected>ğŸ”´ Offline</option>
        </select>
        <button class="btn btn-primary" id="updateStatusBtn" title="Save Status">ğŸ’¾ Save</button>
      </div>

      <div class="row">
        <label for="globalVehicleSelect" style="font-size:.8rem;color:#ccc;">Active Vehicle</label>
        <select id="globalVehicleSelect" class="status-dropdown" style="min-width:220px;">
          <option value="BLACK_ACADIA">Black GMC Acadia (SUV)</option>
          <option value="BIG_RED">Big Red (Red Silverado)</option>
        </select>
      </div>

      <div class="meta">
        Last status update: <span id="statusStamp">â€”</span><br>
        Last GPS ping: <span id="gpsStamp">â€”</span> â€¢ Interval: <span id="gpsRate">â€”</span>
      </div>
    </section>

    <section class="admin-only" style="margin-top:12px;">
      <h2>Create Ride (Manual)</h2>

      <div class="row">
        <input id="manualRiderName" type="text" placeholder="Rider name (optional)" style="flex:1;min-width:180px;">
        <input id="manualRiderPhone" type="text" placeholder="Rider phone (required)" style="flex:1;min-width:180px;">
      </div>

      <div class="row">
        <label class="smalllabel" for="manualPassengers" style="margin:0;">Passengers</label>
        <select id="manualPassengers" style="min-width:140px;">
          <option value="1" selected>1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
          <option value="6">6</option>
        </select>

        <label class="smalllabel" for="manualAirportToggle" style="margin:0;">Airport ride?</label>
        <select id="manualAirportToggle" style="min-width:160px;">
          <option value="auto" selected>AUTO-detect</option>
          <option value="yes">Yes</option>
          <option value="no">No</option>
        </select>
      </div>

      <span class="smalllabel">Pickup</span>
      <input id="manualPickup" type="text" placeholder="Pickup address">

      <span class="smalllabel">Gate Code / Access (optional)</span>
      <input id="manualGateCode" type="text" placeholder="Gate code, building, apartmentâ€¦">

      <div class="minihint">Stops are optional (up to 3). Add them in order.</div>
      <div id="manualStopsWrap"></div>
      <div class="row">
        <button class="btn btn-secondary" id="manualAddStopBtn" type="button">â• Add Stop</button>
        <button class="btn btn-ghost" id="manualClearStopsBtn" type="button">ğŸ§¹ Clear Stops</button>
      </div>

      <span class="smalllabel">Dropoff</span>
      <input id="manualDropoff" type="text" placeholder="Dropoff address">

      <div class="row" id="manualLuggageRow" style="display:none;">
        <label class="smalllabel" for="manualLuggageCount" style="margin:0;">Luggage</label>
        <select id="manualLuggageCount" style="min-width:160px;">
          <option value="0" selected>0</option>
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
          <option value="6">6+</option>
        </select>
        <div class="minihint" style="margin:0;">Shown when airport ride is detected / forced.</div>
      </div>

      <div class="row">
        <input id="manualTime" type="text" placeholder="Time (optional) e.g., 1/11 10:15 PM" style="flex:1;min-width:220px;">
      </div>

      <label style="font-size:.8rem;color:#ccc;">Notes (optional)</label>
      <textarea id="manualNotes" placeholder="Extra contextâ€¦"></textarea>

      <div class="row" style="margin-top:8px;">
        <button class="btn btn-primary" id="btnCreateManualRide" title="Create Ride">â• Create</button>
        <button class="btn btn-secondary" id="btnClearManualRide" title="Clear Form">ğŸ§¹ Clear</button>
      </div>

      <p class="meta">
        âœ… Manual create uses: <code>POST /api/admin/bookings/manual</code> (requires <code>X-Admin-Secret</code>).<br>
        Stores <code>metadata.manualTimeText</code>, <code>metadata.notes</code>, and <code>metadata.luggageCount</code>.
      </p>
    </section>

    <section class="admin-only" style="margin-top:12px;">
      <h2>Broadcast Push Alerts (Riders)</h2>

      <div class="row">
        <select id="pushTemplate" style="flex:1;min-width:220px;">
          <option value="LIVE">ğŸš— LIVE â€” Ready to Roll</option>
          <option value="AIRPORT">âœˆï¸ Airport Runs</option>
          <option value="WEEKEND">ğŸ» Weekend Night Run</option>
          <option value="CAMPUS">ğŸ…¿ï¸ Campus Corner Late Night</option>
          <option value="OFFLINE">ğŸ”´ Going Offline</option>
          <option value="CUSTOM">âœï¸ Custom Only</option>
        </select>
        <button class="btn btn-ghost" id="pushApplyTemplate" title="Apply Template">Apply</button>
      </div>

      <label style="font-size:.8rem;color:#ccc;">Title</label>
      <input id="pushTitle" type="text" placeholder="Big Red Connect"/>

      <label style="font-size:.8rem;color:#ccc;">Message</label>
      <textarea id="pushMessage" placeholder="Enter broadcast message"></textarea>

      <label style="font-size:.8rem;color:#ccc;">Tap-through Link (optional)</label>
      <input id="pushUrl" type="url" placeholder="https://bigredconnectokc.com/"/>

      <div class="preview-box">
        <strong>Preview</strong><br>
        <span id="pushPrevTitle">Big Red Connect</span><br>
        <span id="pushPrevMessage">Message will appear here.</span><br>
        <span style="color:#888;font-size:.75rem;">Link: <span id="pushPrevUrl">https://bigredconnectokc.com/</span></span>
      </div>

      <div class="row" style="margin-top:8px;">
        <button class="btn btn-primary" id="sendBroadcastPush" title="Send Broadcast">ğŸ“¢ Send</button>
        <button class="btn btn-secondary" id="clearPush" title="Clear Push Fields">ğŸ§¹ Clear</button>
      </div>

      <p class="meta">Sends a push notification to all riders tagged <code>env = "live"</code>.</p>
    </section>

    <section class="admin-only" style="margin-top:12px;">
      <h2>Live Map â€” Image & Caption</h2>

      <div class="img-box">
        <img id="statusImage" src="" alt="Live status image">
      </div>

      <div class="row">
        <button id="prevImage" class="btn btn-ghost" title="Previous Image">â¬… Image</button>
        <button id="nextImage" class="btn btn-ghost" title="Next Image">Image â¡</button>
      </div>

      <div class="row">
        <button id="prevCaption" class="btn btn-ghost" title="Previous Caption">â¬… Caption</button>
        <button id="nextCaption" class="btn btn-ghost" title="Next Caption">Caption â¡</button>
        <button id="resetCaption" class="btn btn-secondary" title="Reset Caption">Reset</button>
      </div>

      <label style="font-size:.8rem;color:#ccc;">Caption</label>
      <textarea id="captionBox">Loadingâ€¦</textarea>

      <div class="row" style="margin-top:8px;">
        <button class="btn btn-secondary" id="copyBtn" title="Copy Caption">ğŸ“‹ Copy</button>
        <button class="btn btn-primary" id="postToLive" title="Post To Live Map">ğŸ“¢ Post</button>
      </div>

      <p class="meta">Updates the live map worker.</p>
    </section>
  </div>

  <div>
    <section>
      <h2>Driver Dispatch Board</h2>

      <div class="row" style="justify-content:space-between;">
        <button class="btn btn-ghost" id="btnDispatchRefresh" title="Refresh Dispatch">ğŸ”„ Refresh</button>
        <button class="btn btn-secondary" id="btnScope" title="Toggle Scope">ğŸ“‹ active</button>
      </div>

      <div class="grid-dispatch">
        <div class="column">
          <div class="col-header">ğŸ†• New Requests <span id="countNew">0</span></div>
          <div class="col-body" id="listNew"><div class="empty-text">None</div></div>
        </div>

        <div class="column">
          <div class="col-header">ğŸš¦ Active Trips <span id="countActive">0</span></div>
          <div class="col-body" id="listActive"><div class="empty-text">None</div></div>
        </div>

        <div class="column">
          <div class="col-header">âœ… Completed <span id="countDone">0</span></div>
          <div class="col-body" id="listDone"><div class="empty-text">None</div></div>
        </div>
      </div>

      <p class="meta">
        Tap a card to open details. Use the status dropdown to move rides.<br>
        Admin mode also allows editing ride details + sending rider notifications on status changes.
      </p>
    </section>
  </div>
</div>

<div id="toast"></div>
<div id="debugLog" class="admin-only">[Debug started]</div>

<div id="editOverlay" class="modalOverlay" aria-hidden="true">
  <div class="modalBox">
    <div class="modalTop">
      <div class="modalTitle" id="editTitle">Edit Ride</div>
      <button class="modalClose" id="editCloseBtn">âœ– Close</button>
    </div>

    <div class="modalGrid">
      <div>
        <label>Ride ID</label>
        <input id="editRideId" type="text" readonly>
      </div>
      <div>
        <label>Status (display only)</label>
        <input id="editRideStatus" type="text" readonly>
      </div>

      <div>
        <label>Rider Name</label>
        <input id="editRiderName" type="text" placeholder="Rider name">
      </div>
      <div>
        <label>Rider Phone</label>
        <input id="editRiderPhone" type="text" placeholder="4055551234">
      </div>

      <div>
        <label>Passengers</label>
        <select id="editPartySize">
          <option value="1">1</option><option value="2">2</option><option value="3">3</option>
          <option value="4">4</option><option value="5">5</option><option value="6">6</option>
        </select>
      </div>

      <div>
        <label>Luggage Count</label>
        <select id="editLuggageCount">
          <option value="0">0</option><option value="1">1</option><option value="2">2</option>
          <option value="3">3</option><option value="4">4</option><option value="5">5</option>
          <option value="6">6+</option>
        </select>
      </div>

      <div style="grid-column:1/-1;">
        <label>Pickup Address</label>
        <input id="editPickup" type="text" placeholder="Pickup address">
      </div>

      <div style="grid-column:1/-1;">
        <label>Stops (one per line, optional)</label>
        <textarea id="editStops" placeholder="Stop 1&#10;Stop 2&#10;Stop 3"></textarea>
      </div>

      <div style="grid-column:1/-1;">
        <label>Dropoff Address</label>
        <input id="editDropoff" type="text" placeholder="Dropoff address">
      </div>

      <div style="grid-column:1/-1;">
        <label>Scheduled For (optional ISO string)</label>
        <input id="editScheduledFor" type="text" placeholder="2026-01-11T22:15:00-06:00">
      </div>

      <div style="grid-column:1/-1;">
        <label>Notes (metadata.notes)</label>
        <textarea id="editNotes" placeholder="Notesâ€¦"></textarea>
      </div>

      <div style="grid-column:1/-1;">
        <label>Manual Time Text (metadata.manualTimeText)</label>
        <input id="editManualTimeText" type="text" placeholder="1/11 10:15 PM">
      </div>
    </div>

    <div class="modalActions">
      <button class="btn btn-secondary btn-small" id="editCopyLoginLinkBtn">ğŸ”— Copy Rider Login Link</button>
      <button class="btn btn-secondary btn-small" id="editCopyDirectionsBtn">ğŸ§­ Copy Directions Link</button>
      <button class="btn btn-primary btn-small" id="editSaveBtn">ğŸ’¾ Save Changes</button>
      <button class="btn btn-danger btn-small" id="editCancelBtn">Cancel</button>
    </div>
  </div>
</div>

<script>
/* =========================
   CONFIG
========================= */
const STATUS_WORKER   = "https://bigred-status-updater.bigredtransportation.workers.dev";
const LOCATION_WORKER = "https://update-location.bigredtransportation.workers.dev";
const POST_WORKER     = "https://post-to-live-beta.bigredtransportation.workers.dev";
const PUSH_WORKER     = "https://bigred-push.bigredtransportation.workers.dev";
const BOOKINGS_API    = "https://bigred-bookings.bigredtransportation.workers.dev";

const AUTH_SECRET = "BigRedPrivateKey2025";
const TZ          = "America/Chicago";
const HOME_URL    = "https://bigredconnectokc.com/";

/* If your rider login page uses a different path, change it here */
const RIDER_LOGIN_BASE = `${HOME_URL}rider.html`;

/* Status + dispatch enums */
const DRIVER_STATUSES = [
  { value:"REQUESTED", label:"ğŸ†• Requested" },
  { value:"ACCEPTED",  label:"âœ… Accepted" },
  { value:"ENROUTE",   label:"ğŸš— Enroute" },
  { value:"ARRIVED",   label:"ğŸ“ Arrived" },
  { value:"PICKED_UP", label:"ğŸ‘‹ Picked Up" },
  { value:"COMPLETED", label:"ğŸ Completed" },
  { value:"CANCELLED", label:"âœ– Cancelled" },
];

/* Live map images */
const LIVE_IMAGES=[
  "Official Logo.png",
  "1A5072F2-8604-4CAB-BC84-E15D86D8CE73.png",
  "3673A967-4A2D-4F9C-8602-0C820D31D168.png",
  "8F06509B-317B-45C2-89CE-B2AD1E16D054.png",
  "Big Red Live Text Only.png",
  "2675CB44-5C25-48F5-8185-D9B42A5D9BA1.png",
  "2A5BF138-5AEC-4F26-80BC-BDA3D913C156.png",
  "2CFFFFC3-72E2-4F92-946E-E135D1263442.png",
  "3D17FB5A-0B9D-4DDD-A2EA-C408FB7E04B2.png",
  "3FE45F11-C3B1-4EF2-B8B9-826F2A3B69FA.png",
  "4F3CFD95-B9BB-44D4-B0FA-6192AFCF64CA.png",
  "65F274B4-AB0B-4EA7-AB15-A0AF7FD53660.png",
  "72D2D594-1687-406E-B3B7-24BFB9E1F845.png",
  "74A13122-CF3D-4A7F-BB59-AB89C8B83122.png",
  "84552267-843C-4BC9-9A28-7E5273407FC0.png",
  "8DEA1C2C-A2D3-4FC9-AB9E-8AE5AD14C442.png",
  "8EA345C3-ADC9-4703-9BB7-9788F6E20071.png",
  "8EDE8455-2E49-455A-84CA-743597C0DA75.png",
  "8F34B771-5C26-4CDC-B8C3-538A38278750.png",
  "96403A00-9D6A-4EC3-B2BD-3E9BCE124D87.png",
  "9E1D2D7B-C078-4EA0-941B-C8689F82044F.png",
  "B06D89E3-ECFF-4B50-A687-99E096595B0F.png",
  "CBB513B3-F72E-4657-B32B-256640A76D69.png",
  "D860509D-733C-4C73-B529-891C73F46329.png",
  "E6D81943-48D2-4F74-9B95-FFCD8421DD36.png",
  "Untitled design.png",
];

const TEMPLATES={
  LIVE:{title:"Big Red is LIVE",message:"ğŸš— Big Red Connect is LIVE across the metro â€” text RED to 405-378-4024."},
  AIRPORT:{title:"Airport Runs Available",message:"âœˆï¸ Flat-rate airport connections â€” text RED to 405-378-4024."},
  WEEKEND:{title:"Weekend Night Runs",message:"ğŸ» From last call to your front door â€” ride local, text RED."},
  CAMPUS:{title:"Campus Corner Nights",message:"ğŸ“ OU events + late nights â€” text RED to 405-378-4024."},
  OFFLINE:{title:"Big Red is Offline",message:"ğŸ”´ Big Red is offline â€” text RED for next run info."}
};
const CAPTION_KEYS=["LIVE","AIRPORT","WEEKEND","CAMPUS","OFFLINE"];

/* =========================
   STATE
========================= */
let imgIndex=0;
let captionIndex=0;

let gpsTimer=null;
let gpsLastTs=null;

let dispatchScope = localStorage.getItem("dispatchScope") || "active"; // active | all
let currentStatusVal="offline";
let currentMode = localStorage.getItem("adminDriverMode") || "admin";

const bookingCache = new Map();
let editingBookingId = null;

/* =========================
   SMALL UTILS
========================= */
function $(id){ return document.getElementById(id); }

function showToast(msg){
  const t=$("toast");
  if(!t) return;
  t.textContent=msg;
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"),2000);
}
function log(msg){
  const box=$("debugLog");
  if(!box) return;
  const time=new Date().toLocaleTimeString("en-US",{hour12:false});
  box.innerHTML=`[${time}] ${msg}<br>`+box.innerHTML;
}
function formatDateTime(iso){
  if(!iso) return "â€”";
  try{
    return new Date(iso).toLocaleString("en-US",{
      timeZone:TZ,
      month:"2-digit",day:"2-digit",year:"2-digit",
      hour:"2-digit",minute:"2-digit"
    });
  }catch(e){ return iso; }
}
function escHtml(s){
  return String(s ?? "")
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;")
    .replace(/'/g,"&#39;");
}
function digitsOnly(v){ return String(v||"").replace(/\D/g,""); }
function normalizePhoneDigits(raw){
  let d = digitsOnly(raw);
  if(d.length === 11 && d.startsWith("1")) d = d.slice(1);
  return d;
}
function captionBox(){ return $("captionBox"); }

function copyText(txt){
  try{
    navigator.clipboard.writeText(txt).then(()=>showToast("Copied"),()=>showToast("Copy failed"));
  }catch(e){
    showToast("Copy failed");
  }
}
window.copyText = copyText;

/* =========================
   MODE TOGGLE
========================= */
function applyMode(mode){
  currentMode = (mode === "driver") ? "driver" : "admin";
  document.body.classList.remove("mode-admin","mode-driver");
  document.body.classList.add(currentMode==="driver" ? "mode-driver" : "mode-admin");
  const btn=$("btnModeToggle");
  if(btn){
    btn.textContent = currentMode==="driver" ? "ğŸš— Driver Mode" : "ğŸ›  Admin Mode";
  }
  localStorage.setItem("adminDriverMode", currentMode);
}

/* =========================
   PLACES AUTOCOMPLETE
========================= */
const OKC_BOUNDS = (window.google && google.maps)
  ? new google.maps.LatLngBounds(
      new google.maps.LatLng(35.20, -97.80),
      new google.maps.LatLng(35.70, -97.20)
    )
  : null;

const __acMap = new Map(); // inputId -> Autocomplete instance

function attachAutocompleteToInput(inputEl){
  if(!inputEl) return;
  if(!(window.google && google.maps && google.maps.places)) {
    log("Places library not available (Google script missing or blocked).");
    return;
  }
  if(!inputEl.id) {
    // ensure it has an id (Autocomplete map key)
    inputEl.id = "ac_" + Math.random().toString(36).slice(2);
  }
  if(__acMap.has(inputEl.id)) return;

  const ac = new google.maps.places.Autocomplete(inputEl, {
    bounds: OKC_BOUNDS || undefined,
    strictBounds: true,
    componentRestrictions: { country: "us" },
    fields: ["formatted_address","name","geometry"]
  });

  ac.addListener("place_changed", ()=>{
    const place = ac.getPlace();
    const name = (place?.name || "").trim();
    const addr = (place?.formatted_address || "").trim();

    if (name && addr) {
      const nameLower = name.toLowerCase();
      const addrLower = addr.toLowerCase();
      inputEl.value = addrLower.startsWith(nameLower) ? addr : `${name}, ${addr}`;
      return;
    }
    if (addr) { inputEl.value = addr; return; }
    if (name) { inputEl.value = name; return; }
  });

  __acMap.set(inputEl.id, ac);
}

function initAddressAutocomplete(){
  attachAutocompleteToInput($("manualPickup"));
  attachAutocompleteToInput($("manualDropoff"));
  attachAutocompleteToInput($("editPickup"));
  attachAutocompleteToInput($("editDropoff"));
  document.querySelectorAll('input[id^="manualStop_"]').forEach(attachAutocompleteToInput);
}

/* =========================
   DIRECTIONS + SMS HELPERS
========================= */
function buildGoogleDirectionsUrl(booking){
  const origin = (booking?.pickup?.address || "").trim();
  const destination = (booking?.dropoff?.address || "").trim();
  const stops = Array.isArray(booking?.stops) ? booking.stops : [];
  if(!origin || !destination) return "";
  const waypointsArr = stops.map(s => (s?.address || "").trim()).filter(Boolean);
  const params = new URLSearchParams();
  params.set("api","1");
  params.set("travelmode","driving");
  params.set("origin", origin);
  params.set("destination", destination);
  if(waypointsArr.length){ params.set("waypoints", waypointsArr.join("|")); }
  return `https://www.google.com/maps/dir/?${params.toString()}`;
}
function smsHrefWithBody(phoneDigits, body){
  if(!phoneDigits) return "";
  const encoded = encodeURIComponent(body || "");
  // iOS tolerates "sms:+1XXXXXXXXXX&body=..."
  return `sms:+1${phoneDigits}&body=${encoded}`;
}
function smsTemplateText(templateKey, booking){
  const riderName = (booking?.rider?.name || "").trim();
  const pickup = (booking?.pickup?.address || "").trim();
  const dropoff = (booking?.dropoff?.address || "").trim();
  const greet = riderName ? `Hey ${riderName} â€” ` : `Hey â€” `;
  const templates = {
    OMW: `${greet}Iâ€™m on my way now. Iâ€™ll text when Iâ€™m close.`,
    ARRIVED: `${greet}Iâ€™m here at the pickup. Where should I pull in?`,
    CONFIRM: `${greet}Confirming pickup: ${pickup || "[pickup]"} â†’ ${dropoff || "[dropoff]"}. You ready?`,
    LATE: `${greet}Running a few minutes behind â€” Iâ€™m still coming. Iâ€™ll update you shortly.`,
  };
  return templates[templateKey] || `${greet}Iâ€™m on my way.`;
}

/* Rider login link helper (based on riderId if present) */
function resolveRiderIdFromBooking(b){
  const a = b?.rider?.riderId; if(a) return a;
  const b1 = b?.riderId; if(b1) return b1;
  const c = b?.rider?.id; if(c) return c;
  const d = b?.rider?.external_id; if(d) return d;
  const e = b?.rider?.externalId; if(e) return e;
  return "";
}
function buildRiderLoginLink(booking){
  const riderId = resolveRiderIdFromBooking(booking);
  if(!riderId) return "";
  // This matches your "login via external_id" concept.
  // If your rider page uses a different query param, change "external_id" here.
  const u = new URL(RIDER_LOGIN_BASE);
  u.searchParams.set("external_id", riderId);
  return u.toString();
}

/* =========================
   LIVE IMAGES + CAPTIONS
========================= */
function setImage(idx){
  if(!LIVE_IMAGES.length) return;
  imgIndex=(idx+LIVE_IMAGES.length)%LIVE_IMAGES.length;
  const img=$("statusImage");
  if(img) img.src=LIVE_IMAGES[imgIndex];
  log("Image set: "+LIVE_IMAGES[imgIndex]);
}
function applyTemplateToCaption(key){
  const t=TEMPLATES[key]; if(!t) return;
  captionBox().value=t.message;
  captionIndex = Math.max(0, CAPTION_KEYS.indexOf(key));
}
function stepCaption(d){
  captionIndex=(captionIndex+d+CAPTION_KEYS.length)%CAPTION_KEYS.length;
  applyTemplateToCaption(CAPTION_KEYS[captionIndex]);
}
async function loadLastCaption(){
  try{
    const r=await fetch(POST_WORKER+"/current");
    const d=await r.json();
    captionBox().value=d.caption || TEMPLATES.LIVE.message;
  }catch(e){
    captionBox().value=TEMPLATES.LIVE.message;
  }
}
async function postToLive(){
  const c=captionBox().value.trim();
  if(!c){showToast("Caption required");return;}
  const img=LIVE_IMAGES[imgIndex]||"";
  const statusSel=$("statusSelect").value;
  try{
    const r=await fetch(POST_WORKER,{
      method:"POST",
      headers:{ "Content-Type":"application/json","X-Admin-Secret":AUTH_SECRET },
      body:JSON.stringify({caption:c,image:img,status:statusSel})
    });
    showToast(r.ok?"Live map updated":"Update failed");
  }catch(e){ showToast("Error posting live"); }
}
function copyCaption(){
  navigator.clipboard.writeText(captionBox().value)
    .then(()=>showToast("Copied"),()=>showToast("Copy failed"));
}

/* =========================
   PUSH UI (BROADCAST)
========================= */
function updPrev(){
  $("pushPrevTitle").textContent = $("pushTitle").value || "Big Red Connect";
  $("pushPrevMessage").textContent = $("pushMessage").value || "Message will appear here.";
  $("pushPrevUrl").textContent = $("pushUrl").value || HOME_URL;
}
function applyPushTemplate(){
  const k=$("pushTemplate").value;
  if(k==="CUSTOM") return;
  const t=TEMPLATES[k]; if(!t) return;
  $("pushTitle").value=t.title;
  $("pushMessage").value=t.message;
  $("pushUrl").value=HOME_URL;
  captionBox().value=t.message;
  updPrev();
  captionIndex=CAPTION_KEYS.indexOf(k);
}
function clearPush(){
  $("pushTitle").value="";
  $("pushMessage").value="";
  $("pushUrl").value="";
  updPrev();
}
async function sendPush(payload){
  try{
    const r=await fetch(PUSH_WORKER,{
      method:"POST",
      headers:{ "Content-Type":"application/json","X-Admin-Secret":AUTH_SECRET },
      body:JSON.stringify(payload)
    });
    const txt=await r.text();
    log("Push response: "+r.status+" "+txt);
    showToast(r.ok?"Push sent":"Push failed");
  }catch(e){
    log("Push error: "+e.message);
    showToast("Push error");
  }
}
function handlePushBroadcast(){
  const title=$("pushTitle").value.trim() || "Big Red Connect";
  const msg=$("pushMessage").value.trim();
  const url=$("pushUrl").value.trim() || HOME_URL;
  if(!msg){ showToast("Message required"); return; }

  const payload = {
    type: "broadcast",
    title,
    message: msg,
    url,
    filters: [{ field: "tag", key: "env", value: "live" }]
  };
  sendPush(payload);
}
function autoOnlinePush(){
  const payload = {
    type: "broadcast",
    title: "Big Red is LIVE",
    message: "ğŸš— Big Red Connect is LIVE across the metro â€” text RED to 405-378-4024 for a flat-rate connection.",
    url: HOME_URL,
    filters: [{ field: "tag", key: "env", value: "live" }]
  };
  sendPush(payload);
}

/* =========================
   STATUS + GPS
========================= */
async function loadStatus(){
  try{
    const res=await fetch(STATUS_WORKER+"/status");
    if(!res.ok) return;
    const data=await res.json();
    log("Status GET OK: "+JSON.stringify(data));
    const statusVal=data.status || "offline";
    currentStatusVal = statusVal;

    const pill=$("status-pill");
    const headerPill=$("livePill");
    pill.classList.remove("online","away","offline");
    headerPill.classList.remove("online","away","offline");

    let label="";
    if(statusVal==="online"){
      label="ONLINE";
      pill.classList.add("online");
      headerPill.classList.add("online");
      headerPill.textContent="ğŸ“¡ Tracking: ON";
    }else if(statusVal==="away"){
      label="LIMITED";
      pill.classList.add("away");
      headerPill.classList.add("away");
      headerPill.textContent="ğŸ“¡ Tracking: LIMITED";
    }else{
      label="OFFLINE";
      pill.classList.add("offline");
      headerPill.classList.add("offline");
      headerPill.textContent="ğŸ“¡ Tracking: OFF";
    }

    const when=formatDateTime(data.lastUpdated);
    pill.textContent=`Status: ${label} â€¢ as of ${when}`;
    $("statusStamp").textContent=when;
    $("statusSelect").value=statusVal;

    const globalVeh=$("globalVehicleSelect");
    if(globalVeh){
      if(data.vehicle && data.vehicle.code) globalVeh.value=data.vehicle.code;
      else globalVeh.value="BLACK_ACADIA";
    }

    handleGpsForStatus(statusVal);
  }catch(e){
    log("Status error: "+e.message);
  }
}

async function updateStatus(){
  const val=$("statusSelect").value;
  const message=val==="online"?"On the Road":val==="away"?"Limited Availability":"Offline";
  const wasOnline = (currentStatusVal === "online");

  const vehicleCode = $("globalVehicleSelect") ? $("globalVehicleSelect").value : undefined;

  try{
    log("Status PUTâ€¦");
    const payload = { status:val, online:(val==="online"), message };
    if(vehicleCode) payload.vehicleCode = vehicleCode;

    const res=await fetch(STATUS_WORKER+"/status",{
      method:"PUT",
      headers:{ "Content-Type":"application/json","X-Auth-Token":AUTH_SECRET },
      body:JSON.stringify(payload)
    });

    const bodyText = await res.text();
    log("Status PUT response: "+bodyText);
    showToast(res.ok?"Status updated":"Status update failed");

    if(res.ok){
      currentStatusVal = val;
      if(!wasOnline && val==="online"){
        log("Auto-online push trigger fired.");
        autoOnlinePush();
      }
    }
    loadStatus();
  }catch(e){
    log("PUT error:"+e.message);
    showToast("Status error");
  }
}

function handleGpsForStatus(val){ if(val==="online") startGpsPings(); else stopGpsPings(); }

function determineGpsInterval() {
  let interval = 600000; // default 10m
  const active = document.querySelectorAll("#listActive .card");
  if (active.length > 0) interval = 20000; // 20s while active trips exist
  if (window.__nearPickup === true) interval = 5000; // optional flag if you add it later
  return interval;
}

function startGpsPings(){
  if (gpsTimer) { clearTimeout(gpsTimer); gpsTimer = null; }
  if (!("geolocation" in navigator)) { log("No geolocation support."); return; }

  async function pingOnce(){
    const interval = determineGpsInterval();

    navigator.geolocation.getCurrentPosition(pos => {
      const now = Date.now();

      $("gpsStamp").textContent = new Date().toLocaleString("en-US", { timeZone: TZ });

      $("gpsRate").textContent =
        gpsLastTs
          ? Math.round((now - gpsLastTs) / 1000) + "s"
          : interval >= 60000
              ? Math.round(interval / 60000) + "m"
              : Math.round(interval / 1000) + "s";

      gpsLastTs = now;

      fetch(LOCATION_WORKER, {
        method: "PUT",
        headers: { "Content-Type": "application/json","X-Auth-Token": AUTH_SECRET },
        body: JSON.stringify({
          lat: pos.coords.latitude,
          lng: pos.coords.longitude,
          accuracy: pos.coords.accuracy,
          updated: new Date().toISOString()
        })
      })
      .then(r => r.text())
      .then(t => log("GPS PUT: " + t))
      .catch(e => log("GPS error: " + e.message));

      gpsTimer = setTimeout(pingOnce, interval);

    }, err => {
      log("GPS error: " + err.message);
      gpsTimer = setTimeout(pingOnce, 60000);
    }, { enableHighAccuracy: true, maximumAge: 5000, timeout: 10000 });
  }

  pingOnce();
}

function stopGpsPings(){
  if(gpsTimer){clearTimeout(gpsTimer);gpsTimer=null;}
  $("gpsRate").textContent="â€”";
}

/* =========================
   MANUAL CREATE (STOPS + LUGGAGE)
========================= */
let manualStopIds = [];

function isAirportText(s){
  const t = String(s||"").toLowerCase();
  return t.includes("airport") || t.includes("will rogers");
}
function manualIsAirportRide(){
  const toggle = ($("manualAirportToggle")?.value || "auto").toLowerCase();
  if(toggle === "yes") return true;
  if(toggle === "no") return false;
  const p = $("manualPickup")?.value || "";
  const d = $("manualDropoff")?.value || "";
  return isAirportText(p) || isAirportText(d);
}
function syncManualLuggageVisibility(){
  const row = $("manualLuggageRow");
  const lug = $("manualLuggageCount");
  if(!row || !lug) return;
  if(manualIsAirportRide()){
    row.style.display = "flex";
  }else{
    row.style.display = "none";
    lug.value = "0";
  }
}
function addManualStopField(initialValue=""){
  if(manualStopIds.length >= 3){
    showToast("Stop limit is 3");
    return;
  }
  const id = "manualStop_" + Date.now() + "_" + Math.floor(Math.random()*1000);
  manualStopIds.push(id);

  const wrap = $("manualStopsWrap");
  const div = document.createElement("div");
  div.className = "stop-row";
  div.id = "row_" + id;
  div.innerHTML = `
    <input id="${id}" type="text" placeholder="Stop ${manualStopIds.length} address" value="${escHtml(String(initialValue||""))}">
    <button type="button" class="btn btn-ghost" title="Remove Stop" onclick="removeManualStop('${id}')">âœ–</button>
  `;
  wrap.appendChild(div);

  attachAutocompleteToInput($(id));
}
function removeManualStop(id){
  const row = $("row_" + id);
  if(row) row.remove();
  manualStopIds = manualStopIds.filter(x => x !== id);
}
window.removeManualStop = removeManualStop;

function clearManualStops(){
  manualStopIds.slice().forEach(id => removeManualStop(id));
  manualStopIds = [];
}
function getManualStopsList(){
  return manualStopIds
    .map(id => ($(id)?.value || "").trim())
    .filter(Boolean);
}
function clearManualRideForm(){
  ["manualRiderName","manualRiderPhone","manualPickup","manualGateCode","manualDropoff","manualTime","manualNotes"].forEach(id=>{
    const el = $(id);
    if(el) el.value = "";
  });
  const pax = $("manualPassengers");
  if(pax) pax.value = "1";
  const airportToggle = $("manualAirportToggle");
  if(airportToggle) airportToggle.value = "auto";
  const lug = $("manualLuggageCount");
  if(lug) lug.value = "0";
  clearManualStops();
  syncManualLuggageVisibility();
}

async function createManualRide(){
  const rider_name  = ($("manualRiderName").value || "").trim();
  const rider_phone_raw = ($("manualRiderPhone").value || "").trim();
  const rider_phone = normalizePhoneDigits(rider_phone_raw);

  const pickup      = ($("manualPickup").value || "").trim();
  const dropoff     = ($("manualDropoff").value || "").trim();
  const time        = ($("manualTime").value || "").trim();
  const notes       = ($("manualNotes").value || "").trim();
  const gateCode    = ($("manualGateCode").value || "").trim();

  const partySize = Number($("manualPassengers")?.value || "1");
  const luggageCount = Number($("manualLuggageCount")?.value || "0");
  const stopsText = getManualStopsList();

  if(!rider_phone){ showToast("Rider phone required"); return; }
  if(!pickup || !dropoff){ showToast("Pickup + dropoff required"); return; }

  const payload = {
    source: "MANUAL",
    rider_name,
    rider_phone,
    pickup,
    dropoff,
    time: time || "",
    notes: (notes ? notes + (gateCode ? `\nGate: ${gateCode}` : "") : (gateCode ? `Gate: ${gateCode}` : "")),
    stops: stopsText.map(a => ({ address: a })),
    partySize: Number.isFinite(partySize) ? partySize : 1,
    luggageCount: manualIsAirportRide() ? (Number.isFinite(luggageCount) ? luggageCount : 0) : 0
  };

  try{
    log("Manual ride POST /api/admin/bookings/manual â€¦ " + JSON.stringify(payload));
    const r = await fetch(`${BOOKINGS_API}/api/admin/bookings/manual`, {
      method: "POST",
      headers: { "Content-Type": "application/json", "X-Admin-Secret": AUTH_SECRET },
      body: JSON.stringify(payload)
    });

    const txt = await r.text();
    log(`Manual ride response â†’ ${r.status} ${txt}`);
    if(!r.ok){ showToast("Manual create failed"); return; }

    showToast("Manual ride created");
    clearManualRideForm();
    fetchBookings();
  }catch(e){
    log("Manual create error: " + e.message);
    showToast("Manual create error");
  }
}

/* =========================
   DISPATCH: FETCH + RENDER + STATUS UPDATE
========================= */
function fmtStops(stops){
  const arr = Array.isArray(stops) ? stops : [];
  const addrs = arr.map(x => (x?.address || "").trim()).filter(Boolean);
  if(!addrs.length) return "";
  return addrs.map((a,i)=>`<div class="loc-line">ğŸ›‘ Stop ${i+1}: ${escHtml(a)}</div>`).join("");
}

function statusDropdownHtml(current, bookingId){
  const opts = DRIVER_STATUSES.map(s=>{
    const sel = (s.value === current) ? "selected" : "";
    return `<option value="${s.value}" ${sel}>${escHtml(s.label)}</option>`;
  }).join("");
  return `
    <select class="status-dropdown" data-action="statusChange" data-id="${escHtml(bookingId)}" title="Change ride status">
      ${opts}
    </select>
  `;
}

function quickChipsHtml(booking){
  const directionsUrl = buildGoogleDirectionsUrl(booking);
  const directionsBtn = directionsUrl
    ? `<a class="chip primary" href="${escHtml(directionsUrl)}" target="_blank" rel="noopener">ğŸ§­ Directions</a>`
    : ``;

  const smsDigits = normalizePhoneDigits(booking?.rider?.phone || "");
  const smsBtn = smsDigits
    ? `<a class="chip" href="${escHtml(smsHrefWithBody(smsDigits, smsTemplateText("CONFIRM", booking)))}">ğŸ’¬ Text</a>`
    : ``;

  const riderLogin = buildRiderLoginLink(booking);
  const riderBtn = riderLogin
    ? `<a class="chip warn" href="${escHtml(riderLogin)}" target="_blank" rel="noopener">ğŸ” Rider Link</a>`
    : ``;

  return `
    ${directionsBtn}
    ${smsBtn}
    ${riderBtn}
    <span class="chip" data-action="copyId" data-id="${escHtml(booking.id)}">ğŸ“‹ Copy ID</span>
    <span class="chip" data-action="openEdit" data-id="${escHtml(booking.id)}">âœï¸ Edit</span>
  `;
}

function renderColumn(containerId, items){
  const box = $(containerId);
  if(!box) return;

  if(!Array.isArray(items) || items.length === 0){
    box.innerHTML = `<div class="empty-text">None</div>`;
    return;
  }

  box.innerHTML = items.map(b=>{
    const id = escHtml(b?.id || "");
    const status = escHtml(b?.status || "");
    const riderName = escHtml(b?.rider?.name || "");
    const riderPhone = escHtml(b?.rider?.phone || "");
    const partySize = escHtml(b?.rider?.partySize ?? "");
    const pickup = escHtml(b?.pickup?.address || "");
    const dropoff = escHtml(b?.dropoff?.address || "");
    const createdAt = b?.createdAt ? formatDateTime(b.createdAt) : "â€”";
    const scheduledFor = b?.scheduledFor ? formatDateTime(b.scheduledFor) : "";
    const manualTimeText = escHtml(b?.metadata?.manualTimeText || "");
    const notes = escHtml(b?.metadata?.notes || "");

    return `
      <div class="card" data-id="${id}" data-action="cardTap">
        <div class="card-label-row">
          <div><strong>${riderName || "Rider"}</strong> ${riderPhone ? `â€¢ ${riderPhone}` : ""}</div>
          <span class="badge">${status}</span>
        </div>

        ${partySize ? `<div class="loc-line">ğŸ‘¥ Party: ${partySize}</div>` : ""}

        <div class="loc-line">ğŸ“ Pickup: ${pickup || "â€”"}</div>
        ${fmtStops(b?.stops)}
        <div class="loc-line">ğŸ Dropoff: ${dropoff || "â€”"}</div>

        ${scheduledFor ? `<div class="eta-line">ğŸ—“ Scheduled: ${escHtml(scheduledFor)}</div>` : ""}
        ${manualTimeText ? `<div class="eta-line">â± Manual time: ${manualTimeText}</div>` : ""}
        <div class="eta-line">ğŸ•’ Created: ${escHtml(createdAt)}</div>

        ${notes ? `<div class="eta-line">ğŸ“ Notes: ${notes}</div>` : ""}

        <div class="card-footer">
          <div style="display:flex;gap:6px;flex-wrap:wrap;align-items:center;">
            ${statusDropdownHtml(b.status, b.id)}
            ${quickChipsHtml(b)}
          </div>
        </div>
      </div>
    `;
  }).join("");
}

function renderAllBookings(list){
  bookingCache.clear();
  list.forEach(b => { if(b && b.id) bookingCache.set(String(b.id), b); });

  const newArr   = list.filter(b=>b.status==="REQUESTED");
  const activeArr= list.filter(b=>["ACCEPTED","ENROUTE","ARRIVED","PICKED_UP"].includes(b.status));
  const doneArr  = list.filter(b=>["COMPLETED","CANCELLED"].includes(b.status));

  renderColumn("listNew", newArr);
  renderColumn("listActive", activeArr);
  renderColumn("listDone", doneArr);

  $("countNew").textContent    = newArr.length;
  $("countActive").textContent = activeArr.length;
  $("countDone").textContent   = doneArr.length;

  // Update scope button label
  const scopeBtn = $("btnScope");
  if(scopeBtn) scopeBtn.textContent = `ğŸ“‹ ${dispatchScope}`;

  // If there are active trips, GPS interval tightens automatically
}

async function fetchBookings(){
  try{
    const r=await fetch(`${BOOKINGS_API}/api/driver/bookings?scope=${encodeURIComponent(dispatchScope)}&t=${Date.now()}`);
    const data=await r.json();
    renderAllBookings(Array.isArray(data) ? data : []);
  }catch(e){
    showToast("Dispatch sync failed");
    log("Dispatch fetch error: "+e.message);
  }
}

/* Change booking status (driver) */
async function updateBookingStatus(bookingId, newStatus){
  if(!bookingId || !newStatus) return;

  const booking = bookingCache.get(String(bookingId));
  const prev = booking?.status;

  try{
    log(`Status change â†’ ${bookingId}: ${prev} -> ${newStatus}`);
    const r = await fetch(`${BOOKINGS_API}/api/driver/bookings/${encodeURIComponent(bookingId)}`,{
      method:"PUT",
      headers:{
        "Content-Type":"application/json",
        "X-Auth-Secret": AUTH_SECRET
      },
      body: JSON.stringify({ status: newStatus })
    });

    const txt = await r.text();
    log(`Booking status PUT ${r.status}: ${txt}`);

    if(!r.ok){
      showToast("Status update failed");
      // revert dropdown visually by refetching
      fetchBookings();
      return;
    }

    showToast("Ride updated");

    // Optional: notify rider via push worker if your backend doesn't already do it
    // (You said rider push is sent on status update; if backend handles it, this is redundant)
    // We'll only send if riderId exists AND you want front-end to do it.
    // Comment/uncomment based on your preference:
    // await maybeSendRiderStatusPush(bookingId, newStatus);

    fetchBookings();
  }catch(e){
    log("updateBookingStatus error: "+e.message);
    showToast("Status update error");
    fetchBookings();
  }
}

/* Optional rider push on status change (safe/no-op if no riderId) */
async function maybeSendRiderStatusPush(bookingId, newStatus){
  const booking = bookingCache.get(String(bookingId));
  if(!booking) return;

  const riderId = resolveRiderIdFromBooking(booking);
  if(!riderId) return;

  const riderName = (booking?.rider?.name || "").trim();
  const pickup = (booking?.pickup?.address || "").trim();
  const title = "Big Red Update";
  const msgMap = {
    ACCEPTED:  `âœ… ${riderName ? riderName + ", " : ""}Iâ€™ve accepted your request. Iâ€™ll head your way soon.`,
    ENROUTE:   `ğŸš— ${riderName ? riderName + ", " : ""}Iâ€™m on the way to your pickup.`,
    ARRIVED:   `ğŸ“ ${riderName ? riderName + ", " : ""}Iâ€™ve arrived at the pickup. Reply with where to pull in.`,
    PICKED_UP: `ğŸ‘‹ ${riderName ? riderName + ", " : ""}Weâ€™re on the way.`,
    COMPLETED: `ğŸ Trip completed. Thanks for riding local!`,
    CANCELLED: `âœ– Trip was cancelled. If you still need a connection, text RED.`,
    REQUESTED: `ğŸ†• Request received. Iâ€™ll confirm shortly.`,
  };

  const payload = {
    type: "rider",
    riderId,
    title,
    message: msgMap[newStatus] || `Update: ${newStatus}`,
    url: HOME_URL
  };

  await sendPush(payload);
}

/* =========================
   EDIT MODAL (ADMIN)
========================= */
function openEditModal(bookingId){
  const b = bookingCache.get(String(bookingId));
  if(!b){ showToast("Booking not found"); return; }

  editingBookingId = String(bookingId);

  $("editRideId").value = b.id || "";
  $("editRideStatus").value = b.status || "";

  $("editRiderName").value  = b?.rider?.name || "";
  $("editRiderPhone").value = normalizePhoneDigits(b?.rider?.phone || "");

  $("editPartySize").value  = String(b?.rider?.partySize ?? "1");
  $("editLuggageCount").value = String(b?.metadata?.luggageCount ?? "0");

  $("editPickup").value  = b?.pickup?.address || "";
  $("editDropoff").value = b?.dropoff?.address || "";

  const stopsArr = Array.isArray(b?.stops) ? b.stops : [];
  const stopsLines = stopsArr.map(s=> (s?.address||"").trim()).filter(Boolean).join("\n");
  $("editStops").value = stopsLines;

  $("editScheduledFor").value = b?.scheduledFor || "";
  $("editNotes").value = b?.metadata?.notes || "";
  $("editManualTimeText").value = b?.metadata?.manualTimeText || "";

  // ensure autocomplete attached for modal fields
  attachAutocompleteToInput($("editPickup"));
  attachAutocompleteToInput($("editDropoff"));

  $("editOverlay").classList.add("show");
  $("editOverlay").setAttribute("aria-hidden","false");
}

function closeEditModal(){
  editingBookingId = null;
  $("editOverlay").classList.remove("show");
  $("editOverlay").setAttribute("aria-hidden","true");
}

async function saveEditModal(){
  if(!editingBookingId){ showToast("No booking selected"); return; }

  const rider_name = ($("editRiderName").value || "").trim();
  const rider_phone = normalizePhoneDigits(($("editRiderPhone").value || "").trim());

  const pickup  = ($("editPickup").value || "").trim();
  const dropoff = ($("editDropoff").value || "").trim();

  const partySize = Number(($("editPartySize").value || "1"));
  const luggageCount = Number(($("editLuggageCount").value || "0"));

  const scheduledFor = ($("editScheduledFor").value || "").trim();
  const notes = ($("editNotes").value || "").trim();
  const manualTimeText = ($("editManualTimeText").value || "").trim();

  const stopsLines = ($("editStops").value || "")
    .split("\n")
    .map(s=>s.trim())
    .filter(Boolean)
    .slice(0,3);

  if(!pickup || !dropoff){
    showToast("Pickup + dropoff required");
    return;
  }
  if(rider_phone && rider_phone.length !== 10){
    showToast("Rider phone must be 10 digits");
    return;
  }

  const payload = {
    rider_name,
    rider_phone,
    pickup,
    dropoff,
    partySize: Number.isFinite(partySize) ? partySize : 1,
    stops: stopsLines.map(a=>({ address:a })),
    scheduledFor: scheduledFor || "",
    metadata: {
      notes,
      manualTimeText,
      luggageCount: Number.isFinite(luggageCount) ? luggageCount : 0
    }
  };

  try{
    log(`Admin edit PUT ${editingBookingId} â€¦ ${JSON.stringify(payload)}`);
    const r = await fetch(`${BOOKINGS_API}/api/admin/bookings/${encodeURIComponent(editingBookingId)}`,{
      method:"PUT",
      headers:{
        "Content-Type":"application/json",
        "X-Admin-Secret": AUTH_SECRET
      },
      body: JSON.stringify(payload)
    });

    const txt = await r.text();
    log(`Admin edit response ${r.status}: ${txt}`);

    if(!r.ok){
      showToast("Save failed");
      return;
    }

    showToast("Saved");
    closeEditModal();
    fetchBookings();
  }catch(e){
    log("saveEditModal error: "+e.message);
    showToast("Save error");
  }
}

function copyEditRiderLoginLink(){
  if(!editingBookingId){ showToast("No ride selected"); return; }
  const b = bookingCache.get(String(editingBookingId));
  const link = buildRiderLoginLink(b);
  if(!link){ showToast("No riderId on this booking"); return; }
  copyText(link);
}
function copyEditDirectionsLink(){
  if(!editingBookingId){ showToast("No ride selected"); return; }
  const b = bookingCache.get(String(editingBookingId));
  const link = buildGoogleDirectionsUrl(b);
  if(!link){ showToast("Missing pickup/dropoff"); return; }
  copyText(link);
}

/* =========================
   SCOPE TOGGLE
========================= */
function toggleScope(){
  dispatchScope = (dispatchScope === "active") ? "all" : "active";
  localStorage.setItem("dispatchScope", dispatchScope);
  $("btnScope").textContent = `ğŸ“‹ ${dispatchScope}`;
  fetchBookings();
  showToast(`Scope: ${dispatchScope}`);
}

/* =========================
   EVENT DELEGATION (DISPATCH BOARD)
========================= */
function handleDispatchClick(e){
  const target = e.target;

  // Status dropdown change
  if(target && target.matches('select[data-action="statusChange"]')){
    const bookingId = target.getAttribute("data-id");
    const newStatus = target.value;
    updateBookingStatus(bookingId, newStatus);
    e.stopPropagation();
    return;
  }

  // Chips
  const chip = target.closest && target.closest(".chip");
  if(chip && chip.dataset && chip.dataset.action){
    const action = chip.dataset.action;
    const id = chip.dataset.id;
    if(action === "copyId"){
      copyText(id);
      e.stopPropagation();
      return;
    }
    if(action === "openEdit"){
      if(currentMode !== "admin"){ showToast("Switch to Admin Mode to edit"); return; }
      openEditModal(id);
      e.stopPropagation();
      return;
    }
  }

  // Card tap opens edit (admin only)
  const card = target.closest && target.closest(".card");
  if(card && card.dataset && card.dataset.id){
    if(currentMode === "admin"){
      openEditModal(card.dataset.id);
    }
  }
}

/* =========================
   WIRE BUTTONS
========================= */
function wireButtons(){
  $("updateStatusBtn").onclick = updateStatus;

  $("prevImage").onclick = ()=>setImage(imgIndex-1);
  $("nextImage").onclick = ()=>setImage(imgIndex+1);

  $("prevCaption").onclick = ()=>stepCaption(-1);
  $("nextCaption").onclick = ()=>stepCaption(1);
  $("resetCaption").onclick = ()=>applyTemplateToCaption("LIVE");

  $("copyBtn").onclick = copyCaption;
  $("postToLive").onclick = postToLive;

  $("pushApplyTemplate").onclick = applyPushTemplate;
  $("clearPush").onclick = clearPush;
  $("sendBroadcastPush").onclick = handlePushBroadcast;

  $("btnCreateManualRide").onclick = createManualRide;
  $("btnClearManualRide").onclick = clearManualRideForm;

  ["pushTitle","pushMessage","pushUrl"].forEach(id=>{
    const el=$(id);
    if(el) el.oninput=updPrev;
  });

  $("btnRefreshPage").onclick = ()=>location.reload(true);

  $("btnDispatchRefresh").onclick = ()=>{
    fetchBookings();
    showToast("Dispatch refreshed");
  };

  $("btnScope").onclick = toggleScope;

  $("btnModeToggle").onclick = ()=>{
    applyMode(currentMode==="admin" ? "driver" : "admin");
    showToast(`Mode: ${currentMode}`);
  };

  // Manual stops + luggage wiring
  $("manualAddStopBtn").addEventListener("click", ()=>addManualStopField(""));
  $("manualClearStopsBtn").addEventListener("click", clearManualStops);
  ["manualPickup","manualDropoff","manualAirportToggle"].forEach(id=>{
    const el = $(id);
    if(el){
      el.addEventListener("input", syncManualLuggageVisibility);
      el.addEventListener("change", syncManualLuggageVisibility);
    }
  });

  // digits-only UX enforcement for phone fields (manual + edit)
  const phoneInput = $("manualRiderPhone");
  if(phoneInput){
    phoneInput.addEventListener("input", ()=>{ phoneInput.value = normalizePhoneDigits(phoneInput.value); });
  }
  const editPhone = $("editRiderPhone");
  if(editPhone){
    editPhone.addEventListener("input", ()=>{ editPhone.value = normalizePhoneDigits(editPhone.value); });
  }

  // Modal buttons
  $("editCloseBtn").onclick = closeEditModal;
  $("editCancelBtn").onclick = closeEditModal;
  $("editSaveBtn").onclick = saveEditModal;
  $("editCopyLoginLinkBtn").onclick = copyEditRiderLoginLink;
  $("editCopyDirectionsBtn").onclick = copyEditDirectionsLink;

  // Click outside modal closes
  $("editOverlay").addEventListener("click",(ev)=>{
    if(ev.target === $("editOverlay")) closeEditModal();
  });

  // Dispatch click delegation
  $("listNew").addEventListener("click", handleDispatchClick);
  $("listActive").addEventListener("click", handleDispatchClick);
  $("listDone").addEventListener("click", handleDispatchClick);

  // ESC closes modal
  document.addEventListener("keydown",(ev)=>{
    if(ev.key === "Escape" && $("editOverlay").classList.contains("show")) closeEditModal();
  });
}

/* =========================
   BOOT
========================= */
window.addEventListener("load",()=>{
  // mode + scope
  applyMode(currentMode);
  $("btnScope").textContent = `ğŸ“‹ ${dispatchScope}`;

  // initial UI
  updPrev();
  applyTemplateToCaption("LIVE");
  setImage(0);

  // load data
  loadStatus();
  loadLastCaption();
  fetchBookings();

  // timers
  setInterval(fetchBookings, 20000);

  // init UX
  syncManualLuggageVisibility();
  initAddressAutocomplete();
  wireButtons();
});
</script>

</body>
</html>