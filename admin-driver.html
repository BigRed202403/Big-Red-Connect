<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Big Red Admin / Driver Console</title>

<link rel="apple-touch-icon" href="BRCNYE2026.png">
<link rel="icon" type="image/png" sizes="192x192" href="BRCNYE2026.png">
<link rel="shortcut icon" href="BRCNYE2026.png">
<link rel="manifest" href="manifest-admin.json">
<meta name="apple-mobile-web-app-title" content="Big Red Admin">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="theme-color" content="#000">
<meta http-equiv="Cache-Control" content="no-store"/>

<!-- OneSignal v16 -->
<script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
<script>
  window.OneSignalDeferred = window.OneSignalDeferred || [];
  OneSignalDeferred.push(async function(OneSignal){
    try{
      await OneSignal.init({
        appId:"9b8bcc89-87d3-46e2-b2d0-042d1a267718",
        safari_web_id:"web.onesignal.auto.0c90051e-4735-447d-b203-75e3767d91b9",
        notifyButton:{ enable:false },
        serviceWorkerPath:"/onesignalsdkworker.js",
        path:"/"
      });
      await OneSignal.login("admin_driver_live");
      await OneSignal.sendTag("env","live");
      await OneSignal.sendTag("role_admin_live","true");
      await OneSignal.sendTag("role_driver_live","true");
      console.log("[Admin/Driver] OneSignal initialized + tags set.");
    }catch(e){
      console.warn("OneSignal admin-driver init error:", e);
    }
  });

  function enableAdminAlerts(){
    window.OneSignalDeferred.push(async function(OneSignal){
      const supported = OneSignal.Notifications.isPushSupported();
      if(!supported){
        alert("Notifications not supported on this device.");
        return;
      }
      const perm = OneSignal.Notifications.permission;
      if(perm === "granted" || perm === true){
        alert("Alerts already enabled.");
        return;
      }
      await OneSignal.Slidedown.promptPush();
    });
  }
</script>

<style>
:root{
  --bg:#000;
  --panel:#101010;
  --panel2:#0a0a0a;
  --border:#1f1f1f;
  --muted:#a9a9a9;
  --red:#b30000;
  --green:#0a5;
  --yellow:#b98500;
  --danger:#a33;

  /* Tap target sizing (in-car friendly) */
  --tap:44px;
}
*{box-sizing:border-box;}
html,body{height:100%;}
body{
  margin:0;
  background:var(--bg);
  color:#fff;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
}

/* ===== Header (compact) ===== */
header{
  position:sticky;
  top:0;
  z-index:50;
  background:linear-gradient(180deg,#0f0f0f 0%, #070707 100%);
  border-bottom:2px solid var(--red);
  padding:10px 10px; /* slightly taller */
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}
.h-left{
  display:flex;
  align-items:center;
  gap:10px;
  min-width:0;
}
.h-left img{
  width:38px;
  height:38px;
  border-radius:10px;
  border:1px solid #222;
}
.h-title{
  display:flex;
  flex-direction:column;
  line-height:1.05rem;
  min-width:0;
}
.h-title .top{
  font-weight:900;
  font-size:.95rem;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.h-title .sub{
  font-size:.78rem;
  color:#9c9c9c;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.pill{
  padding:7px 12px; /* bigger */
  border-radius:999px;
  font-weight:900;
  font-size:.82rem;
  border:1px solid #2b2b2b;
  background:#0b0b0b;
  white-space:nowrap;
}
.pill.online{border-color:rgba(0,255,120,.55); color:#caffdf;}
.pill.away{border-color:rgba(255,204,0,.6); color:#fff1bf;}
.pill.offline{border-color:rgba(180,60,60,.65); color:#ffd0d0;}

.h-right{
  display:flex;
  align-items:center;
  gap:8px;
}

/* ===== Buttons (uniform, larger tap targets) ===== */
.btn{
  min-height:var(--tap);
  min-width:var(--tap);
  padding:10px 12px;
  border-radius:14px;
  border:1px solid #2b2b2b;
  background:#0b0b0b;
  color:#fff;
  cursor:pointer;
  font-weight:900;
  font-size:.92rem;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:8px;
  user-select:none;
  -webkit-tap-highlight-color: transparent;
}
.btn:active{transform:scale(.99);}
.btn-primary{background:var(--red); border-color:#7a0000;}
.btn-secondary{border-color:var(--red);}
.btn-ghost{background:#101010; border-color:#333;}
.btn .lbl{display:inline;}

/* Header buttons: keep them thumb-friendly */
header .btn{
  padding:10px 12px;
  border-radius:16px;
}

/* On small phones: increase hit area and keep labels hidden to avoid header wrap */
@media (max-width:430px){
  .btn{
    padding:12px 12px;
    font-size:1rem;
  }
  header .btn{
    padding:12px 12px;
  }
  .btn .lbl{display:none;}
}

/* ===== Layout ===== */
.shell{
  max-width:1200px;
  margin:0 auto;
  padding:10px 10px 18px;
}
.grid{
  display:grid;
  grid-template-columns:1fr;
  gap:12px;
}
@media(min-width:980px){
  .grid{grid-template-columns:1.05fr 1.25fr;}
}

.section{
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:14px;
  padding:12px;
}
.section h2{
  margin:2px 0 10px;
  font-size:1rem;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}
.sep{border:none;border-top:1px solid #1f1f1f;margin:10px 0;}
.meta{font-size:.78rem;color:var(--muted);line-height:1.2rem;margin-top:6px;}

.row{
  display:flex;
  flex-wrap:wrap;
  gap:10px; /* more spacing */
  align-items:center;
  margin:10px 0;
}

label.small{
  display:block;
  font-size:.78rem;
  color:#cfcfcf;
  margin:8px 0 6px;
}

input[type=text],input[type=url],select,textarea{
  width:100%;
  min-height:var(--tap); /* better for driving */
  background:#0b0b0b;
  color:#fff;
  border:1px solid #2a2a2a;
  border-radius:12px;
  padding:12px 12px; /* larger */
  font-weight:800;
  font-size:.96rem;
}
textarea{min-height:110px;resize:vertical;}
code{background:#0b0b0b;border:1px solid #222;border-radius:8px;padding:2px 6px;color:#ddd;}

#status-pill{
  width:100%;
  background:#0a0a0a;
  border:1px solid #2a2a2a;
  border-radius:999px;
  padding:12px 14px;
  font-weight:900;
  font-size:.92rem;
  text-align:center;
}
#status-pill.online{border-color:rgba(0,255,120,.45);}
#status-pill.away{border-color:rgba(255,204,0,.5);}
#status-pill.offline{border-color:rgba(180,60,60,.55);}

.preview-box{
  margin-top:10px;
  padding:10px 12px;
  border-radius:12px;
  border:1px dashed #3a3a3a;
  background:#070707;
  font-size:.88rem;
  color:#ddd;
  line-height:1.2rem;
}

.img-box{
  width:100%;
  border:2px solid var(--red);
  border-radius:14px;
  padding:8px;
  background:#000;
}
.img-box img{
  width:100%;
  border-radius:12px;
}

/* ===== Dispatch (collapsible on mobile) ===== */
.dispatch-grid{
  display:grid;
  grid-template-columns:1fr;
  gap:10px;
}
@media(min-width:980px){
  .dispatch-grid{grid-template-columns:repeat(3,1fr);}
}
.details-col{
  background:#070707;
  border:1px solid #222;
  border-radius:14px;
  overflow:hidden;
}
.details-col summary{
  list-style:none;
  cursor:pointer;
  padding:12px 12px; /* bigger */
  border-bottom:1px solid #1f1f1f;
  font-weight:900;
  font-size:.92rem;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  min-height:var(--tap);
}
.details-col summary::-webkit-details-marker{display:none;}
.details-col[open] summary{background:#0b0b0b;}
.col-body{
  max-height:56vh;
  overflow:auto;
  padding:10px;
}
.empty-text{text-align:center;color:#777;padding:18px 6px;font-size:.9rem;}

.card{
  background:#101010;
  border:1px solid #2a2a2a;
  border-radius:14px;
  padding:10px;
  margin-bottom:10px;
  font-size:.88rem;
}
.card-head{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:8px;
  margin-bottom:8px;
}
.badge{
  padding:5px 10px; /* bigger */
  border-radius:999px;
  font-size:.78rem;
  border:1px solid #555;
  background:#0b0b0b;
}
.loc-line{margin:4px 0;color:#eaeaea;}
.eta-line{margin-top:4px;color:#cfcfcf;}

.vehicle-row{
  display:flex;
  align-items:center;
  gap:8px;
  margin:10px 0 6px;
}
.vehicle-thumb{
  width:50px;
  height:50px;
  object-fit:cover;
  border-radius:12px;
  border:1px solid #333;
}
.vehicle-dd{flex:1;min-width:180px;}

.card-footer{
  border-top:1px solid #1f1f1f;
  margin-top:10px;
  padding-top:8px;
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  gap:10px;
  flex-wrap:wrap;
}
.status-dd{min-width:160px;}

.chip{
  min-height:var(--tap);
  padding:10px 12px; /* bigger */
  border-radius:999px;
  border:1px solid #333;
  background:#121212;
  color:#eee;
  font-size:.9rem;
  cursor:pointer;
  text-decoration:none;
  display:inline-flex;
  align-items:center;
  gap:8px;
  -webkit-tap-highlight-color: transparent;
}
.chip.primary{border-color:var(--red);color:#ffdada;}
.chip:active{transform:scale(.99);}

/* Toast */
#toast{
  position:fixed;
  bottom:16px;
  left:50%;
  transform:translateX(-50%);
  background:#0f0f0f;
  color:#fff;
  border:1px solid var(--red);
  padding:12px 16px;
  border-radius:999px;
  opacity:0;
  pointer-events:none;
  transition:opacity .35s;
  z-index:999;
  font-size:.92rem;
  max-width:92vw;
  text-align:center;
}
#toast.show{opacity:1;}

/* Debug drawer */
.debug-wrap{
  max-width:1200px;
  margin:0 auto 18px;
  padding:0 10px 18px;
}
.debug-wrap details{
  background:#050505;
  border:1px solid #1f1f1f;
  border-radius:14px;
  overflow:hidden;
}
.debug-wrap summary{
  padding:12px 12px;
  cursor:pointer;
  font-weight:900;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:8px;
  min-height:var(--tap);
}
#debugLog{
  font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
  font-size:.74rem;
  color:#0f0;
  background:#000;
  padding:10px;
  max-height:240px;
  overflow:auto;
  border-top:1px solid #1f1f1f;
}

/* Mode visibility */
body.mode-driver .admin-only{display:none !important;}
body.mode-admin .driver-only{display:block;}

/* TRUE DRIVER MODE: dispatch full-width, left column hidden */
body.mode-driver .grid{
  grid-template-columns:1fr !important;
}
body.mode-driver .grid > div:first-child{
  display:none !important;
}

/* SMS template button group */
.sms-templates{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  justify-content:flex-end;
}
.sms-templates .chip{
  padding:10px 12px;
}
</style>
</head>

<body class="mode-admin">
<header>
  <div class="h-left">
    <a href="index.html"><img src="BRCNYE2026.png" alt="Big Red Connect"></a>
    <div class="h-title">
      <div class="top">Admin / Driver Console</div>
      <div class="sub">Live Dispatch & Status</div>
    </div>
    <span id="livePill" class="pill offline">ğŸ“¡ Tracking: OFF</span>
  </div>

  <div class="h-right">
    <button class="btn btn-secondary" id="btnModeToggle" title="Toggle Admin/Driver">ğŸ›  <span class="lbl">Admin</span></button>
    <button class="btn btn-ghost" id="btnRefreshPage" title="Refresh Page">ğŸ”„ <span class="lbl">Refresh</span></button>
    <button class="btn btn-secondary" onclick="enableAdminAlerts()" title="Enable Alerts">ğŸ”” <span class="lbl">Alerts</span></button>
  </div>
</header>

<div class="shell">
  <div id="status-pill" class="offline">Status: OFFLINE â€¢ loadingâ€¦</div>

  <div class="grid" style="margin-top:10px;">
    <!-- LEFT COLUMN -->
    <div>
      <div class="section">
        <h2>Driving Status & GPS</h2>

        <div class="row">
          <select id="statusSelect" style="flex:1;min-width:180px;">
            <option value="online">ğŸŸ¢ On the Road</option>
            <option value="away">ğŸŸ¡ Limited Availability</option>
            <option value="offline" selected>ğŸ”´ Offline</option>
          </select>
          <button class="btn btn-primary" id="updateStatusBtn" title="Save Status">ğŸ’¾ <span class="lbl">Save</span></button>
        </div>

        <div class="row">
          <div style="flex:1;min-width:220px;">
            <label class="small" for="globalVehicleSelect">Active Vehicle</label>
            <select id="globalVehicleSelect">
              <option value="BLACK_ACADIA">Black GMC Acadia (SUV)</option>
              <option value="BIG_RED">Big Red (Red Silverado)</option>
            </select>
          </div>
        </div>

        <div class="meta">
          Last status update: <span id="statusStamp">â€”</span><br>
          Last GPS ping: <span id="gpsStamp">â€”</span> â€¢ Interval: <span id="gpsRate">â€”</span>
        </div>

        <div class="admin-only">
          <hr class="sep">
          <h2>Create Ride (Manual)</h2>

          <div class="row">
            <input id="manualRiderName" type="text" placeholder="Rider name (optional)" style="flex:1;min-width:180px;">
            <input id="manualRiderPhone" type="text" placeholder="Rider phone (required)" style="flex:1;min-width:180px;">
          </div>

          <label class="small">Pickup</label>
          <input id="manualPickup" type="text" placeholder="Pickup address">

          <label class="small">Dropoff</label>
          <input id="manualDropoff" type="text" placeholder="Dropoff address">

          <div class="row">
            <input id="manualTime" type="text" placeholder="Time (optional) e.g., 12/31 10:15 PM" style="flex:1;min-width:220px;">
          </div>

          <label class="small">Notes (optional)</label>
          <textarea id="manualNotes" placeholder="Gate code, apartment, extra contextâ€¦"></textarea>

          <div class="row" style="margin-top:10px;">
            <button class="btn btn-primary" id="btnCreateManualRide" title="Create Ride">â• <span class="lbl">Create</span></button>
            <button class="btn btn-secondary" id="btnClearManualRide" title="Clear Form">ğŸ§¹ <span class="lbl">Clear</span></button>
          </div>

          <p class="meta">
            Creates a REQUESTED booking with <code>created_via = "manual"</code>.
            Rider push requires a riderId after claim/login (7.2).
          </p>
        </div>
      </div>

      <div class="section admin-only" style="margin-top:12px;">
        <h2>Broadcast Push Alerts (Riders)</h2>

        <div class="row">
          <select id="pushTemplate" style="flex:1;min-width:220px;">
            <option value="LIVE">ğŸš— LIVE â€” Ready to Roll</option>
            <option value="AIRPORT">âœˆï¸ Airport Runs</option>
            <option value="WEEKEND">ğŸ» Weekend Night Run</option>
            <option value="CAMPUS">ğŸ…¿ï¸ Campus Corner Late Night</option>
            <option value="OFFLINE">ğŸ”´ Going Offline</option>
            <option value="CUSTOM">âœï¸ Custom Only</option>
          </select>
          <button class="btn btn-ghost" id="pushApplyTemplate" title="Apply Template">âœ¨ <span class="lbl">Apply</span></button>
        </div>

        <label class="small">Title</label>
        <input id="pushTitle" type="text" placeholder="Big Red Connect"/>

        <label class="small">Message</label>
        <textarea id="pushMessage" placeholder="Enter broadcast message"></textarea>

        <label class="small">Tap-through Link (optional)</label>
        <input id="pushUrl" type="url" placeholder="https://bigredconnectokc.com/"/>

        <div class="preview-box">
          <strong>Preview</strong><br>
          <span id="pushPrevTitle">Big Red Connect</span><br>
          <span id="pushPrevMessage">Message will appear here.</span><br>
          <span style="color:#888;font-size:.8rem;">Link: <span id="pushPrevUrl">https://bigredconnectokc.com/</span></span>
        </div>

        <div class="row" style="margin-top:10px;">
          <button class="btn btn-primary" id="sendBroadcastPush" title="Send Broadcast">ğŸ“¢ <span class="lbl">Send</span></button>
          <button class="btn btn-secondary" id="clearPush" title="Clear Push Fields">ğŸ§¹ <span class="lbl">Clear</span></button>
        </div>

        <p class="meta">Sends a push notification to all riders tagged <code>env = "live"</code>.</p>
      </div>

      <div class="section admin-only" style="margin-top:12px;">
        <h2>Live Map â€” Image & Caption</h2>

        <div class="img-box">
          <img id="statusImage" src="" alt="Live status image">
        </div>

        <div class="row">
          <button id="prevImage" class="btn btn-ghost" title="Previous Image">â¬… <span class="lbl">Image</span></button>
          <button id="nextImage" class="btn btn-ghost" title="Next Image"><span class="lbl">Image</span> â¡</button>
        </div>

        <div class="row">
          <button id="prevCaption" class="btn btn-ghost" title="Previous Caption">â¬… <span class="lbl">Caption</span></button>
          <button id="nextCaption" class="btn btn-ghost" title="Next Caption"><span class="lbl">Caption</span> â¡</button>
          <button id="resetCaption" class="btn btn-secondary" title="Reset Caption">â†º <span class="lbl">Reset</span></button>
        </div>

        <label class="small">Caption</label>
        <textarea id="captionBox">Loadingâ€¦</textarea>

        <div class="row" style="margin-top:10px;">
          <button class="btn btn-secondary" id="copyBtn" title="Copy Caption">ğŸ“‹ <span class="lbl">Copy</span></button>
          <button class="btn btn-primary" id="postToLive" title="Post To Live Map">ğŸ“¢ <span class="lbl">Post</span></button>
        </div>

        <p class="meta">Updates the live map worker.</p>
      </div>
    </div>

    <!-- RIGHT COLUMN -->
    <div>
      <div class="section">
        <h2>Driver Dispatch Board</h2>

        <div class="row" style="justify-content:space-between;">
          <button class="btn btn-ghost" id="btnDispatchRefresh" title="Refresh Dispatch">ğŸ”„ <span class="lbl">Refresh</span></button>
          <button class="btn btn-secondary" id="btnScope" title="Toggle Scope">ğŸ“‹ <span class="lbl">active</span></button>
        </div>

        <div class="dispatch-grid">
          <details class="details-col" id="colNew" open>
            <summary>ğŸ†• New Requests <span id="countNew">0</span></summary>
            <div class="col-body" id="listNew"><div class="empty-text">None</div></div>
          </details>

          <details class="details-col" id="colActive" open>
            <summary>ğŸš¦ Active Trips <span id="countActive">0</span></summary>
            <div class="col-body" id="listActive"><div class="empty-text">None</div></div>
          </details>

          <details class="details-col" id="colDone">
            <summary>âœ… Completed <span id="countDone">0</span></summary>
            <div class="col-body" id="listDone"><div class="empty-text">None</div></div>
          </details>
        </div>

        <p class="meta">Change status to move rides. Rider push is sent on each status update (if riderId can be resolved).</p>
      </div>
    </div>
  </div>
</div>

<div id="toast"></div>

<div class="debug-wrap admin-only">
  <details>
    <summary>ğŸ§ª Debug <span style="color:#888;font-weight:800;font-size:.85rem;">(tap to expand)</span></summary>
    <div id="debugLog">[Debug started]</div>
  </details>
</div>

<script>
/* =======================
   ENDPOINTS / CONSTANTS
   ======================= */
const STATUS_WORKER="https://bigred-status-updater.bigredtransportation.workers.dev";
const LOCATION_WORKER="https://update-location.bigredtransportation.workers.dev";
const POST_WORKER="https://post-to-live-beta.bigredtransportation.workers.dev";
const PUSH_WORKER="https://bigred-push.bigredtransportation.workers.dev";
const BOOKINGS_API="https://bigred-bookings.bigredtransportation.workers.dev";

const AUTH_SECRET="BigRedPrivateKey2025";
const TZ="America/Chicago";
const HOME_URL="https://bigredconnectokc.com/";

/* Rider login page is ROOT (main branch), MyRide page is /rider */
const RIDER_LOGIN_URL = `${HOME_URL}/rider-login.html`;

/* =======================
   MEDIA
   ======================= */
const LIVE_IMAGES=[
  "BRCNYE2026.png",
  "Official Logo.png",
  "1A5072F2-8604-4CAB-BC84-E15D86D8CE73.png",
  "3673A967-4A2D-4F9C-8602-0C820D31D168.png",
  "8F06509B-317B-45C2-89CE-B2AD1E16D054.png",
  "Big Red Live Text Only.png",
  "2675CB44-5C25-48F5-8185-D9B42A5D9BA1.png",
  "2A5BF138-5AEC-4F26-80BC-BDA3D913C156.png",
  "2CFFFFC3-72E2-4F92-946E-E135D1263442.png",
  "3D17FB5A-0B9D-4DDD-A2EA-C408FB7E04B2.png",
  "3FE45F11-C3B1-4EF2-B8B9-826F2A3B69FA.png",
  "4F3CFD95-B9BB-44D4-B0FA-6192AFCF64CA.png",
  "65F274B4-AB0B-4EA7-AB15-A0AF7FD53660.png",
  "72D2D594-1687-406E-B3B7-24BFB9E1F845.png",
  "74A13122-CF3D-4A7F-BB59-AB89C8B83122.png",
  "84552267-843C-4BC9-9A28-7E5273407FC0.png",
  "8DEA1C2C-A2D3-4FC9-AB9E-8AE5AD14C442.png",
  "8EA345C3-ADC9-4703-9BB7-9788F6E20071.png",
  "8EDE8455-2E49-455A-84CA-743597C0DA75.png",
  "8F34B771-5C26-4CDC-B8C3-538A38278750.png",
  "96403A00-9D6A-4EC3-B2BD-3E9BCE124D87.png",
  "9E1D2D7B-C078-4EA0-941B-C8689F82044F.png",
  "B06D89E3-ECFF-4B50-A687-99E096595B0F.png",
  "CBB513B3-F72E-4657-B32B-256640A76D69.png",
  "D860509D-733C-4C73-B529-891C73F46329.png",
  "E6D81943-48D2-4F74-9B95-FFCD8421DD36.png",
  "Untitled design.png",
];

let imgIndex=0;

const TEMPLATES={
  LIVE:{title:"Big Red is LIVE",message:"ğŸš— Big Red Connect is LIVE across the metro â€” text RED to 405-378-4024."},
  AIRPORT:{title:"Airport Runs Available",message:"âœˆï¸ Flat-rate airport connections â€” text RED to 405-378-4024."},
  WEEKEND:{title:"Weekend Night Runs",message:"ğŸ» From last call to your front door â€” ride local, text RED."},
  CAMPUS:{title:"Campus Corner Nights",message:"ğŸ“ OU events + late nights â€” text RED to 405-378-4024."},
  OFFLINE:{title:"Big Red is Offline",message:"ğŸ”´ Big Red is offline â€” text RED for next run info."}
};

const CAPTION_KEYS=["LIVE","AIRPORT","WEEKEND","CAMPUS","OFFLINE"];
let captionIndex=0;

/* =======================
   STATE
   ======================= */
let gpsTimer=null;
let gpsLastTs=null;
let dispatchScope="active";
let currentStatusVal="offline";

/* mode */
let currentMode = localStorage.getItem("adminDriverMode") || "admin";

/* =======================
   UTIL
   ======================= */
function showToast(msg){
  const t=document.getElementById("toast");
  if(!t) return;
  t.textContent=msg;
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"),2000);
}
function log(msg){
  const box=document.getElementById("debugLog");
  if(!box) return;
  const time=new Date().toLocaleTimeString("en-US",{hour12:false});
  box.innerHTML=`[${time}] ${msg}<br>`+box.innerHTML;
}
function formatDateTime(iso){
  if(!iso)return"â€”";
  try{
    return new Date(iso).toLocaleString("en-US",{
      timeZone:TZ,
      month:"2-digit",day:"2-digit",year:"2-digit",
      hour:"2-digit",minute:"2-digit"
    });
  }catch(e){return iso;}
}
function captionBox(){return document.getElementById("captionBox");}

function digitsOnly(v){
  return String(v||"").replace(/\D/g,"");
}

async function copyTextToClipboard(text){
  try{
    await navigator.clipboard.writeText(text);
    showToast("Copied SMS");
  }catch(e){
    const ta = document.createElement("textarea");
    ta.value = text;
    document.body.appendChild(ta);
    ta.select();
    try{ document.execCommand("copy"); showToast("Copied SMS"); }
    catch(_){ showToast("Copy failed"); }
    ta.remove();
  }
}

function applyMode(mode){
  currentMode = (mode === "driver") ? "driver" : "admin";
  const body=document.body;
  body.classList.remove("mode-admin","mode-driver");
  body.classList.add(currentMode==="driver"?"mode-driver":"mode-admin");
  const btn=document.getElementById("btnModeToggle");
  if(btn){
    btn.innerHTML = currentMode==="driver"
      ? `ğŸš— <span class="lbl">Driver</span>`
      : `ğŸ›  <span class="lbl">Admin</span>`;
  }
  localStorage.setItem("adminDriverMode",currentMode);
}

/* =======================
   IMAGES
   ======================= */
function loadImages(){setImage(0);}
function setImage(idx){
  if(!LIVE_IMAGES.length)return;
  imgIndex=(idx+LIVE_IMAGES.length)%LIVE_IMAGES.length;
  document.getElementById("statusImage").src=LIVE_IMAGES[imgIndex];
  log("Image set: "+LIVE_IMAGES[imgIndex]);
}

/* =======================
   MANUAL RIDE CREATE (7.1)
   ======================= */
function normPhone(p){
  return String(p||"").replace(/[^\d+]/g,"").trim();
}

async function createManualRide(){
  const name  = (document.getElementById("manualRiderName").value || "").trim();
  const phone = normPhone(document.getElementById("manualRiderPhone").value);
  const pickup = (document.getElementById("manualPickup").value || "").trim();
  const dropoff = (document.getElementById("manualDropoff").value || "").trim();
  const time = (document.getElementById("manualTime").value || "").trim();
  const notes = (document.getElementById("manualNotes").value || "").trim();

  if(!phone){
    showToast("Rider phone required");
    return;
  }
  if(!pickup || !dropoff){
    showToast("Pickup + dropoff required");
    return;
  }

  const payload = { rider_name:name, rider_phone:phone, pickup, dropoff, time, notes };

  try{
    log("Manual ride POSTâ€¦ " + JSON.stringify(payload));

    const r = await fetch(`${BOOKINGS_API}/api/admin/bookings/manual`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-Admin-Secret": AUTH_SECRET
      },
      body: JSON.stringify(payload)
    });

    const txt = await r.text();
    log(`Manual ride response â†’ ${r.status} ${txt}`);

    if(!r.ok){
      showToast("Manual create failed");
      return;
    }

    showToast("Manual ride created");
    fetchBookings();
  }catch(e){
    log("Manual create error: " + e.message);
    showToast("Manual create error");
  }
}

function clearManualRideForm(){
  ["manualRiderName","manualRiderPhone","manualPickup","manualDropoff","manualTime","manualNotes"]
    .forEach(id => {
      const el = document.getElementById(id);
      if(el) el.value = "";
    });
}

/* =======================
   STATUS + GPS
   ======================= */
async function loadStatus(){
  try{
    const res=await fetch(STATUS_WORKER+"/status");
    if(!res.ok)return;
    const data=await res.json();
    log("Status GET OK: "+JSON.stringify(data));
    let statusVal=data.status||"offline";
    currentStatusVal = statusVal;

    const pill=document.getElementById("status-pill");
    const headerPill=document.getElementById("livePill");
    pill.classList.remove("online","away","offline");
    headerPill.classList.remove("online","away","offline");

    let label="";
    if(statusVal==="online"){
      label="ONLINE";
      pill.classList.add("online");
      headerPill.classList.add("online");
      headerPill.textContent="ğŸ“¡ Tracking: ON";
    }else if(statusVal==="away"){
      label="LIMITED";
      pill.classList.add("away");
      headerPill.classList.add("away");
      headerPill.textContent="ğŸ“¡ Tracking: LIMITED";
    }else{
      label="OFFLINE";
      pill.classList.add("offline");
      headerPill.classList.add("offline");
      headerPill.textContent="ğŸ“¡ Tracking: OFF";
    }

    const when=formatDateTime(data.lastUpdated);
    pill.textContent=`Status: ${label} â€¢ as of ${when}`;
    document.getElementById("statusStamp").textContent=when;
    document.getElementById("statusSelect").value=statusVal;

    const globalVeh=document.getElementById("globalVehicleSelect");
    if(globalVeh){
      if(data.vehicle && data.vehicle.code) globalVeh.value=data.vehicle.code;
      else globalVeh.value="BLACK_ACADIA";
    }

    handleGpsForStatus(statusVal);
  }catch(e){
    log("Status error: "+e.message);
  }
}

async function updateStatus(){
  const val=document.getElementById("statusSelect").value;
  const normalized=val;
  const message=val==="online"?"On the Road":val==="away"?"Limited Availability":"Offline";
  const wasOnline = (currentStatusVal === "online");

  const globalVeh=document.getElementById("globalVehicleSelect");
  const vehicleCode = globalVeh ? globalVeh.value : undefined;

  try{
    log("Status PUTâ€¦");
    const payload = { status:normalized, online:(normalized==="online"), message };
    if(vehicleCode) payload.vehicleCode = vehicleCode;

    const res=await fetch(STATUS_WORKER+"/status",{
      method:"PUT",
      headers:{
        "Content-Type":"application/json",
        "X-Auth-Token":AUTH_SECRET
      },
      body:JSON.stringify(payload)
    });

    const bodyText = await res.text();
    log("Status PUT response: "+bodyText);
    showToast(res.ok?"Status updated":"Status update failed");

    if(res.ok){
      currentStatusVal = normalized;
      if(!wasOnline && normalized==="online"){
        log("Auto-online push trigger fired.");
        autoOnlinePush();
      }
    }

    loadStatus();
  }catch(e){
    log("PUT error:"+e.message);
    showToast("Status error");
  }
}

function handleGpsForStatus(val){
  if(val==="online")startGpsPings();
  else stopGpsPings();
}

function determineGpsInterval() {
  let interval = 600000; // 10 minutes idle online
  const active = document.querySelectorAll("#listActive .card");
  if (active.length > 0) interval = 20000; // 20 seconds
  if (window.__nearPickup === true) interval = 5000; // 5 seconds
  return interval;
}

function startGpsPings(){
  if (gpsTimer) {
    clearTimeout(gpsTimer);
    gpsTimer = null;
  }

  if (!("geolocation" in navigator)) {
    log("No geolocation support.");
    return;
  }

  async function pingOnce(){
    const interval = determineGpsInterval();

    navigator.geolocation.getCurrentPosition(pos => {
      const now = Date.now();

      document.getElementById("gpsStamp").textContent =
        new Date().toLocaleString("en-US", { timeZone: TZ });

      document.getElementById("gpsRate").textContent =
        gpsLastTs
          ? Math.round((now - gpsLastTs) / 1000) + "s"
          : interval >= 60000
              ? Math.round(interval / 60000) + "m"
              : Math.round(interval / 1000) + "s";

      gpsLastTs = now;

      fetch(LOCATION_WORKER, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
          "X-Auth-Token": AUTH_SECRET
        },
        body: JSON.stringify({
          lat: pos.coords.latitude,
          lng: pos.coords.longitude,
          accuracy: pos.coords.accuracy,
          updated: new Date().toISOString()
        })
      })
      .then(r => r.text())
      .then(t => log("GPS PUT: " + t))
      .catch(e => log("GPS error: " + e.message));

      gpsTimer = setTimeout(pingOnce, interval);

    }, err => {
      log("GPS error: " + err.message);
      gpsTimer = setTimeout(pingOnce, 60000);
    }, {
      enableHighAccuracy: true,
      maximumAge: 5000,
      timeout: 10000
    });
  }

  pingOnce();
}

function stopGpsPings(){
  if(gpsTimer){clearTimeout(gpsTimer);gpsTimer=null;}
  document.getElementById("gpsRate").textContent="â€”";
}

/* =======================
   LIVE MAP CAPTIONS
   ======================= */
function applyTemplateToCaption(key){
  const t=TEMPLATES[key];if(!t)return;
  captionBox().value=t.message;
  captionIndex=CAPTION_KEYS.indexOf(key);
}
function stepCaption(d){
  captionIndex=(captionIndex+d+CAPTION_KEYS.length)%CAPTION_KEYS.length;
  applyTemplateToCaption(CAPTION_KEYS[captionIndex]);
}
async function loadLastCaption(){
  try{
    const r=await fetch(POST_WORKER+"/current");
    const d=await r.json();
    captionBox().value=d.caption||TEMPLATES.LIVE.message;
  }catch(e){
    captionBox().value=TEMPLATES.LIVE.message;
  }
}
async function postToLive(){
  const c=captionBox().value.trim();
  if(!c){showToast("Caption required");return;}
  const img=LIVE_IMAGES[imgIndex]||"";
  const statusSel=document.getElementById("statusSelect").value;
  try{
    const r=await fetch(POST_WORKER,{
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "X-Admin-Secret":AUTH_SECRET
      },
      body:JSON.stringify({caption:c,image:img,status:statusSel})
    });
    showToast(r.ok?"Live map updated":"Update failed");
  }catch(e){
    showToast("Error posting live");
  }
}

/* =======================
   PUSH
   ======================= */
function updPrev(){
  document.getElementById("pushPrevTitle").textContent=
    document.getElementById("pushTitle").value||"Big Red Connect";
  document.getElementById("pushPrevMessage").textContent=
    document.getElementById("pushMessage").value||"Message will appear here.";
  document.getElementById("pushPrevUrl").textContent=
    document.getElementById("pushUrl").value||HOME_URL;
}
function applyPushTemplate(){
  const k=document.getElementById("pushTemplate").value;
  if(k==="CUSTOM")return;
  const t=TEMPLATES[k];if(!t)return;
  document.getElementById("pushTitle").value=t.title;
  document.getElementById("pushMessage").value=t.message;
  document.getElementById("pushUrl").value=HOME_URL;
  captionBox().value=t.message;
  updPrev();
  captionIndex=CAPTION_KEYS.indexOf(k);
}
function clearPush(){
  document.getElementById("pushTitle").value="";
  document.getElementById("pushMessage").value="";
  document.getElementById("pushUrl").value="";
  updPrev();
}

async function sendPush(payload){
  try{
    const r=await fetch(PUSH_WORKER,{
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "X-Admin-Secret":AUTH_SECRET
      },
      body:JSON.stringify(payload)
    });
    const txt=await r.text();
    log("Push response: "+r.status+" "+txt);
    showToast(r.ok?"Push sent":"Push failed");
  }catch(e){
    log("Push error: "+e.message);
    showToast("Push error");
  }
}

function handlePushBroadcast(){
  const title=document.getElementById("pushTitle").value.trim()||"Big Red Connect";
  const msg=document.getElementById("pushMessage").value.trim();
  const url=document.getElementById("pushUrl").value.trim()||HOME_URL;
  if(!msg){ showToast("Message required"); return; }

  const payload = {
    type: "broadcast",
    title,
    message: msg,
    url,
    filters: [{ field: "tag", key: "env", value: "live" }]
  };
  sendPush(payload);
}

function autoOnlinePush(){
  const payload = {
    type: "broadcast",
    title: "Big Red is LIVE",
    message: "ğŸš— Big Red Connect is LIVE across the metro â€” text RED to 405-378-4024 for a flat-rate connection.",
    url: HOME_URL,
    filters: [{ field: "tag", key: "env", value: "live" }]
  };
  sendPush(payload);
}

/* =======================
   CAPTION COPY
   ======================= */
function copyCaption(){
  navigator.clipboard.writeText(captionBox().value)
    .then(()=>showToast("Copied"),()=>showToast("Copy failed"));
}

/* =======================
   SMS templates for ride cards
   ======================= */
function vehicleLabelFromCode(code){
  if(code==="BIG_RED") return "red Silverado";
  return "black GMC Acadia";
}

function buildRideSms(templateKey, data){
  const rider = (data.riderName || "there").trim() || "there";
  const pickup = (data.pickup || "your pickup").trim();
  const dropoff = (data.dropoff || "your destination").trim();
  const vehicle = vehicleLabelFromCode(data.vehicleCode || "BLACK_ACADIA");

  if(templateKey==="confirm"){
    return `Hey ${rider} â€” got it. Pickup: ${pickup}. Dropoff: ${dropoff}. Iâ€™ll update you when Iâ€™m on the way.`;
  }
  if(templateKey==="omw"){
    return `Hey ${rider} â€” Iâ€™m on my way now. Iâ€™ll be there shortly.`;
  }
  if(templateKey==="arrived"){
    return `Hey ${rider} â€” Iâ€™m here at ${pickup}. Iâ€™m in the ${vehicle}. Reply when youâ€™re coming out.`;
  }
  if(templateKey==="complete"){
    return `Thanks again, ${rider}! If you need another connection later, just text RED.`;
  }
  return `Hey ${rider} â€” quick update from Big Red Connect.`;
}

/* Click delegation for SMS template chips */
document.body.addEventListener("click", async (e) => {
  const btn = e.target.closest && e.target.closest(".sms-template");
  if(!btn) return;

  const templateKey = btn.dataset.template || "";
  const payload = {
    riderName: btn.dataset.riderName || "",
    pickup: btn.dataset.pickup || "",
    dropoff: btn.dataset.dropoff || "",
    vehicleCode: btn.dataset.vehicleCode || "BLACK_ACADIA"
  };

  const msg = buildRideSms(templateKey, payload);
  await copyTextToClipboard(msg);
});

/* =======================
   DISPATCH
   ======================= */
async function fetchBookings(){
  try{
    const r=await fetch(`${BOOKINGS_API}/api/driver/bookings?scope=${dispatchScope}&t=${Date.now()}`);
    const data=await r.json();
    renderAllBookings(Array.isArray(data) ? data : []);
  }catch(e){
    showToast("Dispatch sync failed");
    log("Dispatch fetch error: "+e.message);
  }
}

function resolveRiderIdFromBooking(b){
  const a = b?.rider?.riderId; if(a) return a;
  const b1 = b?.riderId; if(b1) return b1;
  const c = b?.rider?.id; if(c) return c;
  const d = b?.rider?.external_id; if(d) return d;
  const e = b?.rider?.externalId; if(e) return e;
  return "";
}

/* NEW: passenger count resolver */
function resolvePassengers(b){
  const v =
    b?.rider?.passengers ??
    b?.rider?.party_size ??
    b?.rider?.partySize ??     // âœ… ADD THIS
    b?.rider?.pax;
  const n = Number(v);
  return Number.isFinite(n) && n > 0 ? n : 1;
}

function renderAllBookings(list){
  const newArr=list.filter(b=>b.status==="REQUESTED");
  const activeArr=list.filter(b=>["ACCEPTED","ENROUTE","ARRIVED","PICKED_UP"].includes(b.status));
  const doneArr=list.filter(b=>["COMPLETED","CANCELLED"].includes(b.status));
  renderColumn("listNew",newArr);
  renderColumn("listActive",activeArr);
  renderColumn("listDone",doneArr);
  document.getElementById("countNew").textContent=newArr.length;
  document.getElementById("countActive").textContent=activeArr.length;
  document.getElementById("countDone").textContent=doneArr.length;
}

function renderColumn(id,arr){
  const box=document.getElementById(id);
  box.innerHTML="";
  if(!arr.length){
    box.innerHTML=`<div class="empty-text">None</div>`;
    return;
  }

  arr.forEach(b=>{
    const estFare=b.pricing?.estimate?`$${b.pricing.estimate.toFixed(2)}`:"--";
    const estMinutes=b.metrics?.minutes?`${Math.round(b.metrics.minutes)} min`:null;
    const rideId=b.id;
    const isEnroute=["ENROUTE","ARRIVED","PICKED_UP"].includes(b.status);

    const riderIdResolved = resolveRiderIdFromBooking(b);

    const phoneDigits = digitsOnly(b?.rider?.phone||"");
    const smsHref = phoneDigits ? `sms:+1${phoneDigits}` : "";

    const riderName = (b?.rider?.name||"").trim();
    const pickupAddr = (b?.pickup?.address||"").trim();
    const dropoffAddr = (b?.dropoff?.address||"").trim();
    const vCode = b?.vehicle?.code || "BLACK_ACADIA";

    const pax = resolvePassengers(b);

    const div=document.createElement("div");
    div.className="card";

    div.innerHTML=`
      <div class="card-head">
        <span><strong>${b.type||"Ride"}</strong></span>
        <span class="badge">${b.status||"â€”"}</span>
      </div>

      <div class="loc-line">FROM: ${b.pickup?.address||"â€”"}</div>
      ${b.stops?.length?`<div class="loc-line">STOPS: ${b.stops.map(s=>s.address).join(" â†’ ")}</div>`:""}
      <div class="loc-line">TO: ${b.dropoff?.address||"â€”"}</div>

      <div class="vehicle-row">
        <img src="${b.vehicle?.image||'/Black Acadia Thumbnail.PNG'}"
             class="vehicle-thumb"
             id="vehImg-${rideId}">
        <select class="vehicle-dd vehicle-dropdown" data-id="${rideId}" id="vehSel-${rideId}">
          <option value="BLACK_ACADIA"
                  data-label="Black GMC Acadia (SUV)"
                  data-img="/Black Acadia Thumbnail.PNG"
                  ${(b.vehicle?.code==="BLACK_ACADIA"||!b.vehicle)?"selected":""}>
            Black GMC Acadia (SUV)
          </option>
          <option value="BIG_RED"
                  data-label="Big Red (Red Silverado)"
                  data-img="/Big Red Thumbnail.PNG"
                  ${b.vehicle?.code==="BIG_RED"?"selected":""}>
            Big Red (Red Silverado)
          </option>
        </select>
      </div>

      <div>Est Fare: ${estFare}</div>
      ${pax ? `<div class="eta-line">PAX: ${pax}</div>` : ``}
      ${estMinutes?`<div class="eta-line">Est. ride time: ${estMinutes}</div>`:""}

      <div class="card-footer">
        <div>
          <select class="status-dd status-dropdown" data-id="${rideId}" data-rider-id="${riderIdResolved}">
            <option ${b.status==="REQUESTED"?"selected":""}>REQUESTED</option>
            <option ${b.status==="ACCEPTED"?"selected":""}>ACCEPTED</option>
            <option ${b.status==="ENROUTE"?"selected":""}>ENROUTE</option>
            <option ${b.status==="ARRIVED"?"selected":""}>ARRIVED</option>
            <option ${b.status==="PICKED_UP"?"selected":""}>PICKED_UP</option>
            <option ${b.status==="COMPLETED"?"selected":""}>COMPLETED</option>
            <option ${b.status==="CANCELLED"?"selected":""}>CANCELLED</option>
          </select>
        </div>

        <div style="display:flex;flex-direction:column;align-items:flex-end;gap:8px;max-width:100%;">
          <div style="font-size:.9rem;color:#bbb;">Rider: ${b.rider?.name||"â€”"}</div>

          <div class="sms-templates">
            <button class="chip sms-template"
              data-template="confirm"
              data-rider-name="${riderName}"
              data-pickup="${pickupAddr}"
              data-dropoff="${dropoffAddr}"
              data-vehicle-code="${vCode}"
              title="Copy: Confirmed / got it">âœ… Confirm</button>

            <button class="chip sms-template"
              data-template="omw"
              data-rider-name="${riderName}"
              data-pickup="${pickupAddr}"
              data-dropoff="${dropoffAddr}"
              data-vehicle-code="${vCode}"
              title="Copy: On my way">ğŸš— OMW</button>

            <button class="chip sms-template"
              data-template="arrived"
              data-rider-name="${riderName}"
              data-pickup="${pickupAddr}"
              data-dropoff="${dropoffAddr}"
              data-vehicle-code="${vCode}"
              title="Copy: Arrived">ğŸ“ Arrived</button>

            <button class="chip sms-template"
              data-template="complete"
              data-rider-name="${riderName}"
              data-pickup="${pickupAddr}"
              data-dropoff="${dropoffAddr}"
              data-vehicle-code="${vCode}"
              title="Copy: Complete / thanks">âœ… Done</button>
          </div>

          <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;">
            ${phoneDigits ? `<a class="chip" href="${smsHref}">ğŸ’¬ Text Rider</a>` : ""}
            ${isEnroute?`<a class="chip primary" href="https://location-reader.bigredtransportation.workers.dev/?id=${rideId}" target="_blank">ğŸ“ Live Map</a>`:""}
          </div>
        </div>
      </div>
    `;

    box.appendChild(div);
  });
}

/* =======================
   DISPATCH EVENTS (status + vehicle)
   ======================= */
document.body.addEventListener("change", async (e) => {
  if (!e.target.classList.contains("status-dropdown")) return;

  const select = e.target;
  const rideId = select.dataset.id;
  const newState = select.value;
  const riderId = select.dataset.riderId || "";

  log("Resolved rideId â†’ " + rideId);
  log("Resolved riderId â†’ " + (riderId || "null"));

  try {
    const r = await fetch(`${BOOKINGS_API}/api/driver/bookings/${rideId}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ status: newState })
    });

    const putTxt = await r.text();
    log(`Status PUT (${rideId}) â†’ ${r.status} ${putTxt}`);
    showToast(r.ok ? `Status â†’ ${newState}` : "Update failed");

    fetchBookings();

  } catch (err) {
    showToast("Failed");
    log("Status update error: " + err.message);
  }
});

document.body.addEventListener("change",async(e)=>{
  if(!e.target.classList.contains("vehicle-dropdown"))return;
  const id=e.target.dataset.id;
  const opt=e.target.selectedOptions[0];
  const vehicle={code:opt.value,label:opt.dataset.label,image:opt.dataset.img};
  const img=document.getElementById(`vehImg-${id}`);
  if(img) img.src=vehicle.image;

  try{
    const r=await fetch(`${BOOKINGS_API}/api/driver/bookings/${id}`,{
      method:"PUT",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({vehicle})
    });
    const t=await r.text();
    log(`Vehicle PUT (${id}) â†’ ${r.status} ${t}`);
    showToast(r.ok?"Vehicle updated":"Failed");
  }catch(err){
    showToast("Failed");
    log("Vehicle update error: "+err.message);
  }
});

/* =======================
   SCOPE TOGGLE
   ======================= */
document.getElementById("btnScope").addEventListener("click",()=>{
  if(dispatchScope==="active")dispatchScope="upcoming";
  else if(dispatchScope==="upcoming")dispatchScope="all";
  else dispatchScope="active";
  document.getElementById("btnScope").innerHTML=`ğŸ“‹ <span class="lbl">${dispatchScope}</span>`;
  fetchBookings();
});

/* =======================
   BUTTON WIRING
   ======================= */
document.getElementById("updateStatusBtn").onclick=updateStatus;
document.getElementById("prevImage").onclick=()=>setImage(imgIndex-1);
document.getElementById("nextImage").onclick=()=>setImage(imgIndex+1);
document.getElementById("prevCaption").onclick=()=>stepCaption(-1);
document.getElementById("nextCaption").onclick=()=>stepCaption(1);
document.getElementById("resetCaption").onclick=()=>applyTemplateToCaption("LIVE");
document.getElementById("copyBtn").onclick=copyCaption;
document.getElementById("postToLive").onclick=postToLive;
document.getElementById("pushApplyTemplate").onclick=applyPushTemplate;
document.getElementById("clearPush").onclick=clearPush;
document.getElementById("sendBroadcastPush").onclick=handlePushBroadcast;

document.getElementById("btnCreateManualRide").onclick=createManualRide;
document.getElementById("btnClearManualRide").onclick=clearManualRideForm;

["pushTitle","pushMessage","pushUrl"].forEach(id=>{
  const el=document.getElementById(id);
  if(el) el.oninput=updPrev;
});

document.getElementById("btnRefreshPage").onclick=()=>location.reload(true);
document.getElementById("btnDispatchRefresh").onclick=()=>{
  fetchBookings();
  showToast("Dispatch refreshed");
};

document.getElementById("btnModeToggle").onclick=()=>{
  applyMode(currentMode==="admin"?"driver":"admin");
};

/* =======================
   INIT
   ======================= */
window.addEventListener("load",()=>{
  applyMode(currentMode);
  updPrev();
  applyTemplateToCaption("LIVE");
  loadImages();
  loadStatus();
  loadLastCaption();
  fetchBookings();
  setInterval(fetchBookings,20000);
});
</script>

</body>
</html>