<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Big Red Connect ‚Äî Admin + Driver</title>

  <!-- PWA Icons -->
  <link rel="apple-touch-icon" href="icon.PNG">
  <link rel="icon" type="image/png" sizes="192x192" href="icon.PNG">
  <link rel="shortcut icon" href="icon.PNG">
  <link rel="manifest" href="manifest-admin.json">
  <meta name="theme-color" content="#000000">
  <meta http-equiv="Cache-Control" content="no-store"/>

  <style>
    :root {
      --red: #b30000;
      --bg: #000;
      --panel: #111;
      --border: #222;
      --muted: #aaa;
      --accent: #ffcc00;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      background: var(--bg);
      color: #fff;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }

    a { color: #ff6666; }

    /* Header */
    header {
      background: #000;
      border-bottom: 2px solid var(--red);
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      position: sticky;
      top: 0;
      z-index: 20;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
    }

    .header-left img {
      height: 40px;
      border-radius: 4px;
    }

    .header-title-main {
      font-size: 0.95rem;
      font-weight: 700;
    }

    .header-title-sub {
      font-size: 0.78rem;
      color: #888;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .pill {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 700;
      border: 1px solid #333;
    }

    .pill.online { background: #064; }
    .pill.away   { background: #665500; }
    .pill.offline{ background: #400; }

    .btn-small {
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid var(--red);
      background: #000;
      color: #fff;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
    }

    .btn-small:hover {
      background: #151515;
    }

    /* Tabs */
    .tabs {
      display: flex;
      border-bottom: 1px solid #222;
      background: #050505;
    }

    .tab-btn {
      flex: 1;
      padding: 10px 0;
      text-align: center;
      font-size: 0.9rem;
      font-weight: 600;
      border: none;
      background: #050505;
      color: #aaa;
      cursor: pointer;
    }

    .tab-btn.active {
      color: #fff;
      border-bottom: 2px solid var(--red);
      background: #111;
    }

    .tab-pane {
      display: none;
    }

    .tab-pane.active {
      display: block;
    }

    h1 {
      text-align: center;
      font-size: 1.4rem;
      margin: 16px 0 4px;
    }

    .tagline {
      text-align: center;
      font-size: 0.9rem;
      color: var(--muted);
      margin-bottom: 10px;
    }

    /* Global status pill under tabs */
    #status-pill {
      margin: 10px auto 12px;
      padding: 8px 14px;
      border-radius: 18px;
      display: inline-block;
      min-width: 260px;
      font-size: 0.82rem;
      background: #222;
      border: 1px solid #333;
    }
    #status-pill.online { background: #064; }
    #status-pill.away   { background: #665500; }
    #status-pill.offline{ background: #400; }

    /* DRIVER TAB LAYOUT */
    .grid {
      padding: 10px 12px 22px;
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }

    @media(min-width: 900px) {
      .grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    .column {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden;
    }

    .col-header {
      padding: 8px 10px;
      border-bottom: 1px solid #222;
      font-weight: 700;
      font-size: 0.8rem;
      text-transform: uppercase;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .col-header span:last-child {
      font-size: 0.75rem;
      color: #ccc;
    }

    .col-body {
      max-height: 68vh;
      overflow-y: auto;
      padding: 10px;
    }

    .empty-text {
      text-align: center;
      color: #777;
      padding: 20px;
      font-size: 0.8rem;
    }

    .driver-toolbar {
      padding: 10px 12px 0;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
      justify-content: space-between;
    }

    .driver-toolbar-left {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
      font-size: 0.8rem;
    }

    .driver-toolbar-right {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .btn-chip {
      padding: 5px 10px;
      border-radius: 999px;
      border: 1px solid #444;
      background: #111;
      color: #eee;
      font-size: 0.75rem;
      cursor: pointer;
    }

    .btn-chip.primary {
      border-color: var(--red);
    }

    .scope-label {
      font-size: 0.78rem;
      color: #ccc;
    }

    /* Booking cards */
    .card {
      background: #000;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 10px;
      font-size: 0.8rem;
    }

    .card-label-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 6px;
    }

    .badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 0.68rem;
      border: 1px solid #666;
      margin-left: 4px;
    }

    .badge-status {
      border-color: #aaa;
    }

    .loc-line {
      margin: 3px 0;
      font-size: 0.78rem;
    }

    .eta-line {
      margin-top: 4px;
      font-size: 0.75rem;
      color: #ccc;
    }

    .vehicle-select-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 6px;
    }

    .vehicle-thumb {
      width: 55px;
      height: auto;
      border-radius: 6px;
      border: 1px solid #333;
    }

    .vehicle-dropdown {
      flex: 1;
      background: #111;
      color: #fff;
      border: 1px solid #333;
      padding: 5px;
      border-radius: 6px;
      font-size: 0.78rem;
    }

    .card-footer {
      border-top: 1px solid #222;
      margin-top: 8px;
      padding-top: 6px;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 6px;
      flex-wrap: wrap;
    }

    .status-dropdown {
      background: #111;
      color: #fff;
      border: 1px solid #333;
      padding: 4px 6px;
      border-radius: 6px;
      font-size: 0.75rem;
    }

    .chip {
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #444;
      background: #111;
      color: #eee;
      font-size: 0.7rem;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
    }

    .chip.primary {
      border-color: var(--red);
      color: #ffdada;
    }

    .chip.muted {
      border-color: #444;
      color: #ddd;
    }

    /* ADMIN TAB LAYOUT */
    .admin-wrap {
      max-width: 980px;
      margin: 0 auto;
      padding: 12px 12px 30px;
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }

    @media(min-width: 820px) {
      .admin-wrap {
        grid-template-columns: 1fr 1fr;
      }
      .admin-section-full {
        grid-column: 1 / span 2;
      }
    }

    .admin-section {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px;
      font-size: 0.86rem;
    }

    .admin-section h2 {
      margin: 4px 0 8px;
      font-size: 1rem;
      border-bottom: 1px solid #222;
      padding-bottom: 4px;
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 6px 0;
      align-items: center;
    }

    select, button, input[type="text"], input[type="url"], textarea {
      font-family: inherit;
    }

    select, input[type="text"], input[type="url"] {
      padding: 7px 9px;
      border-radius: 6px;
      border: 1px solid #333;
      background: #000;
      color: #fff;
      font-size: 0.86rem;
    }

    .btn-primary {
      background: var(--red);
      color: #fff;
      border-radius: 8px;
      border: none;
      padding: 8px 12px;
      font-size: 0.86rem;
      font-weight: 600;
      cursor: pointer;
    }

    .btn-secondary {
      background: #000;
      color: #fff;
      border-radius: 8px;
      border: 1px solid var(--red);
      padding: 8px 12px;
      font-size: 0.86rem;
      font-weight: 600;
      cursor: pointer;
    }

    .btn-tertiary {
      background: #222;
      color: #fff;
      border-radius: 8px;
      border: 1px solid #555;
      padding: 7px 10px;
      font-size: 0.8rem;
      cursor: pointer;
    }

    textarea {
      width: 100%;
      min-height: 100px;
      background: #111;
      color: #fff;
      border: 1px solid var(--red);
      border-radius: 6px;
      padding: 8px;
      resize: vertical;
      font-size: 0.86rem;
    }

    .meta {
      font-size: 0.8rem;
      color: var(--muted);
      margin-top: 4px;
    }

    .img-box {
      max-width: 100%;
      margin: 8px auto;
      border: 2px solid var(--red);
      border-radius: 6px;
      padding: 6px;
      background: #000;
    }

    .img-box img {
      width: 100%;
      border-radius: 6px;
    }

    .preview-box {
      margin-top: 6px;
      padding: 8px;
      border-radius: 6px;
      border: 1px dashed #444;
      background: #050505;
      font-size: 0.8rem;
      color: #ddd;
    }

    /* Toast */
    #toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #111;
      border: 1px solid var(--red);
      padding: 10px 16px;
      border-radius: 999px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s;
      z-index: 60;
      font-size: 0.82rem;
    }
    #toast.show { opacity: 1; }
  </style>
</head>
<body>

<header id="headerHome">
  <div class="header-left">
    <img src="icon.PNG" alt="Big Red icon">
    <div>
      <div class="header-title-main">Big Red Admin + Driver</div>
      <div class="header-title-sub">Veteran Owned ‚Ä¢ Affordable ‚Ä¢ Local ‚Ä¢ Trusted</div>
    </div>
  </div>
  <div class="header-right">
    <span id="headerTrackPill" class="pill offline">üì° Tracking: OFF</span>
    <button class="btn-small" id="btnHardRefresh">üîÑ Reload</button>
  </div>
</header>

<div class="tabs">
  <button class="tab-btn active" data-tab="driver">üöó Driver</button>
  <button class="tab-btn" data-tab="admin">üõ† Admin</button>
</div>

<div style="text-align:center;">
  <div id="status-pill" class="offline">Status: OFFLINE ‚Ä¢ loading‚Ä¶</div>
</div>

<h1>Big Red Connect Control Center</h1>
<p class="tagline">One page for dispatch, status, GPS, live map and push.</p>

<!-- DRIVER TAB -->
<section id="tab-driver" class="tab-pane active">
  <div class="driver-toolbar">
    <div class="driver-toolbar-left">
      <span class="scope-label">Showing:</span>
      <button class="btn-chip primary" id="btnScope">üìã active</button>
      <span class="scope-label" id="scopeHint">Tap to cycle ‚Üí upcoming ‚Üí all</span>
    </div>
    <div class="driver-toolbar-right">
      <button class="btn-chip" id="btnRefreshDriver">üîÑ Refresh</button>
      <button class="btn-chip" id="btnQuickOnline">üü¢ Go Online</button>
      <button class="btn-chip" id="btnQuickOffline">üî¥ Go Offline</button>
    </div>
  </div>

  <div class="grid">
    <section class="column">
      <div class="col-header">
        <span>üÜï New Requests</span>
        <span id="countNew">0</span>
      </div>
      <div class="col-body" id="listNew">
        <div class="empty-text">No new ride requests.</div>
      </div>
    </section>

    <section class="column">
      <div class="col-header">
        <span>üö¶ Active Trips</span>
        <span id="countActive">0</span>
      </div>
      <div class="col-body" id="listActive">
        <div class="empty-text">No active trips.</div>
      </div>
    </section>

    <section class="column">
      <div class="col-header">
        <span>‚úÖ Completed / Cancelled</span>
        <span id="countDone">0</span>
      </div>
      <div class="col-body" id="listDone">
        <div class="empty-text">No completed rides yet.</div>
      </div>
    </section>
  </div>
</section>

<!-- ADMIN TAB -->
<section id="tab-admin" class="tab-pane">
  <div class="admin-wrap">

    <!-- Status + GPS -->
    <section class="admin-section">
      <h2>Driving Status & GPS</h2>

      <div class="row">
        <select id="statusSelect">
          <option value="online">üü¢ On the Road</option>
          <option value="away">üü° Limited Availability</option>
          <option value="offline" selected>üî¥ Offline</option>
        </select>
        <button class="btn-primary" id="updateStatusBtn">üíæ Save</button>
      </div>

      <div class="meta">
        <div>Last status update: <span id="statusStamp">‚Äî</span></div>
        <div>Last GPS ping: <span id="gpsStamp">‚Äî</span> ‚Ä¢ Interval: <span id="gpsRate">‚Äî</span></div>
        <div style="margin-top:4px;">GPS pings run only when status is <strong>On the Road</strong>.</div>
      </div>
    </section>

    <!-- Broadcast Push -->
    <section class="admin-section">
      <h2>Broadcast Push Alerts</h2>

      <div class="row">
        <label style="font-size:0.8rem;color:#ccc;">Template</label>
      </div>

      <div class="row">
        <select id="pushTemplate">
          <option value="LIVE">üöó LIVE ‚Äî Ready to Roll</option>
          <option value="AIRPORT">‚úàÔ∏è Airport Runs</option>
          <option value="WEEKEND">üçª Weekend Night Run</option>
          <option value="CAMPUS">üéì Campus Corner / OU</option>
          <option value="XMAS1">üéÑ Christmas Lights & Events</option>
          <option value="XMAS2">üéÑ Holiday Nights Out</option>
          <option value="XMAS3">üéÑ Family & Errand Runs</option>
          <option value="XMAS4">üéÑ Zoo Lights & Dates</option>
          <option value="XMAS5">üéÑ Late Night Holiday Pickups</option>
          <option value="OFFLINE">üî¥ Going Offline</option>
          <option value="CUSTOM">‚úèÔ∏è Custom Only</option>
        </select>
        <button class="btn-tertiary" id="pushApplyTemplate">Apply</button>
      </div>

      <label style="font-size:0.8rem;color:#ccc;">Title</label>
      <input id="pushTitle" type="text" placeholder="Big Red Connect"/>

      <label style="font-size:0.8rem;color:#ccc;margin-top:6px;">Message</label>
      <textarea id="pushMessage" placeholder="Notification message to subscribers‚Ä¶"></textarea>

      <label style="font-size:0.8rem;color:#ccc;margin-top:6px;">Tap-through Link (optional)</label>
      <input id="pushUrl" type="url" placeholder="https://bigredconnectokc.com/"/>

      <div class="preview-box">
        <strong>Preview:</strong><br>
        <span id="pushPrevTitle">Big Red Connect</span><br>
        <span id="pushPrevMessage">Message will appear here.</span><br>
        <span style="color:#888;font-size:0.78rem;">Link:
          <span id="pushPrevUrl">https://bigredconnectokc.com/</span>
        </span>
      </div>

      <div class="row" style="margin-top:8px;">
        <button class="btn-primary" id="sendBroadcastPush">üì¢ Send Broadcast Push</button>
        <button class="btn-secondary" id="clearPush">üßπ Clear</button>
      </div>

      <div class="meta">
        Uses your <strong>bigred-push</strong> Worker to hit OneSignal.<br>
        SMS is still your backup fail-safe channel.
      </div>
    </section>

    <!-- Live Map Image + Caption -->
    <section class="admin-section admin-section-full">
      <h2>Live Map ‚Äì Image & Caption</h2>

      <div class="img-box">
        <img id="statusImage" src="icon.PNG" alt="Live image preview">
      </div>

      <div class="row">
        <button class="btn-tertiary" id="prevImage">‚¨Ö Image</button>
        <button class="btn-tertiary" id="nextImage">Image ‚û°</button>
      </div>

      <div class="row">
        <button class="btn-tertiary" id="prevCaption">‚¨Ö Caption</button>
        <button class="btn-tertiary" id="nextCaption">Caption ‚û°</button>
        <button class="btn-secondary" id="resetCaption">Reset</button>
      </div>

      <label style="font-size:0.8rem;color:#ccc;margin-top:6px;">Live Caption</label>
      <textarea id="captionBox">Loading‚Ä¶</textarea>

      <div class="row" style="margin-top:10px;">
        <button class="btn-secondary" id="copyCaption">üìã Copy Caption</button>
        <button class="btn-primary" id="postToLive">üì¢ Post to Live Map</button>
      </div>

      <div class="meta">
        Caption syncs nicely with your social posts and live status map.
      </div>
    </section>

  </div>
</section>

<div id="toast"></div>

<script>
/* =========================================================
   CONFIG
========================================================= */
const AUTH_SECRET     = "BigRedPrivateKey2025";

/* Workers (LIVE) */
const STATUS_WORKER   = "https://bigred-status-updater.bigredtransportation.workers.dev";
const LOCATION_WORKER = "https://update-location.bigredtransportation.workers.dev";
const POST_WORKER     = "https://post-to-live-beta.bigredtransportation.workers.dev";
const PUSH_WORKER     = "https://bigred-push.bigredtransportation.workers.dev";
const BOOKINGS_API    = "https://bigred-bookings.bigredtransportation.workers.dev";

const HOME_URL        = "https://bigredconnectokc.com/";
const TZ              = "America/Chicago";

/* Manual live images list (already in your project root) */
const LIVE_IMAGES = [
  "icon.PNG",
  "icon.png",
  "Big Red Live 2.png",
  "Big Red Live Holiday 1.png",
  "Big Red Live Christmas.png",
  "Big Red Live Text Only.png",
  "Big Red Live Thanksgiving.png",
  "0081086F-89FA-41B2-85EB-E4EE97E9E8EF.png",
  "059AAE7C-E31D-4780-B0FD-00535D28F120.png",
  "148D1A08-D537-4A0C-B141-2336DBF68A15.png",
  "1A5072F2-8604-4CAB-BC84-E15D86D8CE73.png",
  "3673A967-4A2D-4F9C-8602-0C820D31D168.png",
  "37263759-BD32-4E50-883A-0A5BE2F71928.png",
  "3F34BE7E-5953-433C-B8D0-17AC9108107F.png",
  "7106A362-DEC7-4EA7-A0B2-B83DC93EFFAD.png",
  "8F06509B-317B-45C2-89CE-B2AD1E16D054.png",
  "982ABF7A-D9F5-403D-BAE8-13777EC286FB.png",
  "B02AB3EA-1AF5-4BE4-8CBB-E5A1AA40711F.png",
  "BA7E86CF-5782-4323-B0B2-19918EF67887.png",
  "Official Logo.png"
];

let imgIndex = 0;

/* Caption / Push templates */
const TEMPLATES = {
  LIVE: {
    name: "üöó LIVE ‚Äî Ready to Roll",
    title: "Big Red is LIVE",
    message: "üöó Big Red Connect is LIVE across the metro ‚Äî text RED to 405-378-4024 to line up your flat-rate connection."
  },
  AIRPORT: {
    name: "‚úàÔ∏è Airport Runs",
    title: "Airport Runs Available",
    message: "‚úàÔ∏è Headed to or from Will Rogers? Plan ahead with flat-rate airport connections. Text RED to 405-378-4024."
  },
  WEEKEND: {
    name: "üçª Weekend Night Run",
    title: "Weekend Night Runs",
    message: "üçª From last call to your front door ‚Äî ride local, ride safe. Text RED to 405-378-4024."
  },
  CAMPUS: {
    name: "üéì Campus Corner / OU Nights",
    title: "Campus Corner Nights",
    message: "üéì Campus Corner nights and OU events ‚Äî keep it simple and ride local. Text RED to 405-378-4024."
  },
  XMAS1: {
    name: "üéÑ Christmas Lights & Events",
    title: "Christmas Season Rides",
    message: "üéÑ From Zoo Lights to holiday parties and shopping runs ‚Äî ride local, ride safe, and plan ahead with Big Red. Text RED to 405-378-4024."
  },
  XMAS2: {
    name: "üéÑ Holiday Nights Out",
    title: "Holiday Nights Out",
    message: "üéÑ Holiday nights, Christmas events, and seasonal runs ‚Äî Big Red is rolling. Text RED to 405-378-4024."
  },
  XMAS3: {
    name: "üéÑ Family & Errand Runs",
    title: "Holiday Errands & Family Rides",
    message: "üéÑ Christmas lights, family gatherings, and shopping trips ‚Äî plan ahead and ride local with Big Red. Text RED to 405-378-4024."
  },
  XMAS4: {
    name: "üéÑ Zoo Lights & Dates",
    title: "Zoo Lights & Date Nights",
    message: "üéÑ Zoo Lights, date nights, and downtown Christmas vibes ‚Äî let Big Red handle the drive. Text RED to 405-378-4024."
  },
  XMAS5: {
    name: "üéÑ Late Night Holiday Pickups",
    title: "Holiday Late Night Pickups",
    message: "üéÑ Wrapping up late? I‚Äôve got your ride home. Holiday late night pickups across the metro ‚Äî text RED to 405-378-4024."
  },
  OFFLINE: {
    name: "üî¥ Going Offline",
    title: "Big Red is Offline",
    message: "üî¥ Big Red is offline for now ‚Äî check back soon or text RED to 405-378-4024 to plan your next connection."
  }
};

const CAPTION_KEYS = [
  "LIVE",
  "AIRPORT",
  "WEEKEND",
  "CAMPUS",
  "XMAS1",
  "XMAS2",
  "XMAS3",
  "XMAS4",
  "XMAS5",
  "OFFLINE"
];

let captionIndex = 0;

/* Driver booking state */
let scope = "active"; // active | upcoming | all
let lastBookings = [];

/* GPS ping state */
let gpsTimer = null;
let gpsLastTs = null;

/* =========================================================
   BASIC HELPERS
========================================================= */
function showToast(msg) {
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.classList.add("show");
  setTimeout(() => t.classList.remove("show"), 1900);
}

function formatDateTime(iso) {
  if (!iso) return "‚Äî";
  try {
    return new Date(iso).toLocaleString("en-US", {
      timeZone: TZ,
      month: "2-digit",
      day: "2-digit",
      year: "2-digit",
      hour: "2-digit",
      minute: "2-digit"
    });
  } catch (e) {
    return iso;
  }
}

function captionBox() {
  return document.getElementById("captionBox");
}

/* =========================================================
   TAB SWITCHING + HEADER HOME TAP
========================================================= */
document.getElementById("headerHome").addEventListener("click", (e) => {
  // Only treat tap on left (logo/title) as home; ignore right side buttons
  if ((e.target.closest(".header-right"))) return;
  window.location.href = "index.html";
});

document.querySelectorAll(".tab-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
    document.querySelectorAll(".tab-pane").forEach(p => p.classList.remove("active"));

    btn.classList.add("active");
    const tab = btn.dataset.tab;
    document.getElementById("tab-" + tab).classList.add("active");
  });
});

document.getElementById("btnHardRefresh").addEventListener("click", () => {
  location.reload(true);
});

/* =========================================================
   STATUS + GPS (SHARED FOR TABS)
========================================================= */
async function loadStatus() {
  try {
    const res = await fetch(STATUS_WORKER + "/status");
    if (!res.ok) return;

    const data = await res.json();

    let statusVal = "offline";
    let last = data.lastUpdated || data.updated || null;

    if ("status" in data && data.status) {
      statusVal = data.status;
    } else if ("online" in data) {
      statusVal = data.online ? "online" : "offline";
    }

    const pill = document.getElementById("status-pill");
    const headerPill = document.getElementById("headerTrackPill");
    const stamp = document.getElementById("statusStamp");
    const selector = document.getElementById("statusSelect");

    pill.classList.remove("online", "away", "offline");
    headerPill.classList.remove("online", "away", "offline");

    let label = "";
    if (statusVal === "online") {
      label = "ONLINE";
      pill.classList.add("online");
      headerPill.classList.add("online");
      headerPill.textContent = "üì° Tracking: ON";
    } else if (statusVal === "away") {
      label = "LIMITED";
      pill.classList.add("away");
      headerPill.classList.add("away");
      headerPill.textContent = "üì° Tracking: LIMITED";
    } else {
      label = "OFFLINE";
      pill.classList.add("offline");
      headerPill.classList.add("offline");
      headerPill.textContent = "üì° Tracking: OFF";
    }

    const when = formatDateTime(last);
    pill.textContent = `Status: ${label} ‚Ä¢ as of ${when}`;
    stamp.textContent = when;

    if (selector) selector.value = statusVal;

    handleGpsForStatus(statusVal);
  } catch (e) {
    console.warn("Status error:", e);
  }
}

async function updateStatus() {
  const val = document.getElementById("statusSelect").value;

  let normalizedStatus = "offline";
  let message = "Offline";

  if (val === "online") {
    normalizedStatus = "online";
    message = "On the Road";
  } else if (val === "away") {
    normalizedStatus = "away";
    message = "Limited Availability";
  }

  const body = {
    status: normalizedStatus,
    online: normalizedStatus === "online",
    message,
    activeRideId: null,
    location: null
  };

  try {
    const res = await fetch(STATUS_WORKER + "/status", {
      method: "PUT",
      headers: {
        "Content-Type": "application/json",
        "X-Auth-Token": AUTH_SECRET
      },
      body: JSON.stringify(body)
    });

    const text = await res.text();
    console.log("Status PUT:", res.status, text);

    if (!res.ok) {
      showToast("‚ö†Ô∏è Status update failed");
    } else {
      showToast("‚úÖ Status updated");
      handleGpsForStatus(normalizedStatus);
      loadStatus();
    }
  } catch (e) {
    console.warn("Status PUT error:", e);
    showToast("‚ö†Ô∏è Status error");
  }
}

document.getElementById("updateStatusBtn").addEventListener("click", updateStatus);

/* Quick buttons (Driver tab) */
document.getElementById("btnQuickOnline").addEventListener("click", () => {
  document.getElementById("statusSelect").value = "online";
  updateStatus();
});

document.getElementById("btnQuickOffline").addEventListener("click", () => {
  document.getElementById("statusSelect").value = "offline";
  updateStatus();
});

/* GPS ping handling */
function handleGpsForStatus(statusVal) {
  if (statusVal === "online") {
    startGpsPings();
  } else {
    stopGpsPings();
  }
}

function startGpsPings() {
  if (gpsTimer) {
    clearInterval(gpsTimer);
    gpsTimer = null;
  }
  if (!("geolocation" in navigator)) {
    console.warn("Geolocation not available in browser.");
    return;
  }

  console.log("Starting GPS pings (15s)...");
  gpsLastTs = null;

  gpsTimer = setInterval(() => {
    navigator.geolocation.getCurrentPosition(
      pos => {
        const now = Date.now();
        const stampEl = document.getElementById("gpsStamp");
        const rateEl = document.getElementById("gpsRate");

        const displayTime = new Date().toLocaleString("en-US", {
          timeZone: TZ,
          month: "2-digit",
          day: "2-digit",
          year: "2-digit",
          hour: "2-digit",
          minute: "2-digit"
        });
        stampEl.textContent = displayTime;

        if (gpsLastTs) {
          const diffSec = Math.round((now - gpsLastTs) / 1000);
          rateEl.textContent = diffSec + "s";
        } else {
          rateEl.textContent = "~15s";
        }
        gpsLastTs = now;

        const payload = {
          lat: pos.coords.latitude,
          lng: pos.coords.longitude,
          accuracy: pos.coords.accuracy,
          source: "admin-driver",
          updated: new Date().toISOString()
        };

        fetch(LOCATION_WORKER, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            "X-Auth-Token": AUTH_SECRET
          },
          body: JSON.stringify(payload)
        }).then(r => r.text())
          .then(txt => console.log("GPS PUT:", txt))
          .catch(err => console.warn("GPS PUT error:", err));
      },
      err => {
        console.warn("GPS error:", err.message);
      },
      { enableHighAccuracy: true, maximumAge: 5000, timeout: 10000 }
    );
  }, 15000);
}

function stopGpsPings() {
  if (gpsTimer) {
    clearInterval(gpsTimer);
    gpsTimer = null;
    console.log("GPS pings stopped.");
  }
  document.getElementById("gpsRate").textContent = "‚Äî";
}

/* =========================================================
   LIVE IMAGE ROTATION
========================================================= */
function setImage(idx) {
  if (!LIVE_IMAGES || LIVE_IMAGES.length === 0) return;
  imgIndex = (idx + LIVE_IMAGES.length) % LIVE_IMAGES.length;
  const img = document.getElementById("statusImage");
  img.src = LIVE_IMAGES[imgIndex];
}

document.getElementById("prevImage").addEventListener("click", () => {
  setImage(imgIndex - 1);
});
document.getElementById("nextImage").addEventListener("click", () => {
  setImage(imgIndex + 1);
});

/* =========================================================
   CAPTION + TEMPLATE + LIVE POST
========================================================= */
function applyTemplateToCaption(key) {
  const tpl = TEMPLATES[key];
  if (!tpl) return;
  captionBox().value = tpl.message;
  captionIndex = CAPTION_KEYS.indexOf(key);
  if (captionIndex < 0) captionIndex = 0;

  // Also sync push fields
  document.getElementById("pushTitle").value   = tpl.title;
  document.getElementById("pushMessage").value = tpl.message;
  document.getElementById("pushUrl").value     = HOME_URL;
  updatePushPreview();
}

function stepCaption(delta) {
  captionIndex = (captionIndex + delta + CAPTION_KEYS.length) % CAPTION_KEYS.length;
  const key = CAPTION_KEYS[captionIndex];
  applyTemplateToCaption(key);
}

document.getElementById("prevCaption").addEventListener("click", () => stepCaption(-1));
document.getElementById("nextCaption").addEventListener("click", () => stepCaption(1));
document.getElementById("resetCaption").addEventListener("click", () => {
  applyTemplateToCaption("LIVE");
});

async function loadLastCaption() {
  try {
    const res = await fetch(POST_WORKER + "/current");
    if (!res.ok) {
      captionBox().value = TEMPLATES.LIVE.message;
      return;
    }
    const data = await res.json();
    if (data && data.caption) {
      captionBox().value = data.caption;
    } else {
      captionBox().value = TEMPLATES.LIVE.message;
    }
  } catch (e) {
    console.warn("Caption GET error:", e);
    captionBox().value = TEMPLATES.LIVE.message;
  }
}

async function postToLive() {
  const caption = captionBox().value.trim();
  if (!caption) {
    showToast("Caption is required");
    return;
  }
  const image = LIVE_IMAGES[imgIndex] || "";

  const statusSel = document.getElementById("statusSelect")?.value || "offline";

  try {
    const res = await fetch(POST_WORKER, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-Admin-Secret": AUTH_SECRET
      },
      body: JSON.stringify({ caption, image, status: statusSel })
    });
    const txt = await res.text();
    console.log("Post-to-live:", res.status, txt);
    showToast(res.ok ? "üì¢ Live map updated" : "‚ö†Ô∏è Live map error");
  } catch (e) {
    console.warn("Post-to-live error:", e);
    showToast("‚ö†Ô∏è Live map error");
  }
}

document.getElementById("postToLive").addEventListener("click", postToLive);

document.getElementById("copyCaption").addEventListener("click", () => {
  const text = captionBox().value;
  if (!text) {
    showToast("Nothing to copy");
    return;
  }
  navigator.clipboard.writeText(text)
    .then(() => showToast("üìã Caption copied"))
    .catch(() => showToast("‚ö†Ô∏è Copy failed"));
});

/* =========================================================
   BROADCAST PUSH (via bigred-push Worker)
========================================================= */
function updatePushPreview() {
  document.getElementById("pushPrevTitle").textContent =
    document.getElementById("pushTitle").value || "Big Red Connect";

  document.getElementById("pushPrevMessage").textContent =
    document.getElementById("pushMessage").value || "Message will appear here.";

  document.getElementById("pushPrevUrl").textContent =
    document.getElementById("pushUrl").value || HOME_URL;
}

document.getElementById("pushTitle").addEventListener("input", updatePushPreview);
document.getElementById("pushMessage").addEventListener("input", updatePushPreview);
document.getElementById("pushUrl").addEventListener("input", updatePushPreview);

function applyPushTemplate() {
  const key = document.getElementById("pushTemplate").value;
  if (key === "CUSTOM") return;

  const t = TEMPLATES[key];
  if (!t) return;

  document.getElementById("pushTitle").value   = t.title;
  document.getElementById("pushMessage").value = t.message;
  document.getElementById("pushUrl").value     = HOME_URL;

  captionBox().value = t.message;
  updatePushPreview();

  captionIndex = CAPTION_KEYS.indexOf(key);
  if (captionIndex < 0) captionIndex = 0;
}

document.getElementById("pushApplyTemplate").addEventListener("click", applyPushTemplate);

function clearPush() {
  document.getElementById("pushTitle").value = "";
  document.getElementById("pushMessage").value = "";
  document.getElementById("pushUrl").value = "";
  updatePushPreview();
}

document.getElementById("clearPush").addEventListener("click", clearPush);

async function sendBroadcastPush() {
  const title = document.getElementById("pushTitle").value.trim() || "Big Red Connect";
  const message = document.getElementById("pushMessage").value.trim();
  const url = document.getElementById("pushUrl").value.trim() || HOME_URL;

  if (!message) {
    showToast("Message is required");
    return;
  }

  const payload = {
    type: "broadcast",
    title,
    message,
    url
  };

  try {
    const res = await fetch(PUSH_WORKER, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    const txt = await res.text();
    console.log("Broadcast push:", res.status, txt);
    showToast(res.ok ? "üì¢ Push sent" : "‚ö†Ô∏è Push failed");
  } catch (e) {
    console.warn("Push error:", e);
    showToast("‚ö†Ô∏è Push error");
  }
}

document.getElementById("sendBroadcastPush").addEventListener("click", sendBroadcastPush);

/* =========================================================
   DRIVER DISPATCH (3 columns)
========================================================= */
async function fetchBookings() {
  try {
    const res = await fetch(`${BOOKINGS_API}/api/driver/bookings?scope=${scope}&t=${Date.now()}`);
    if (!res.ok) throw new Error("HTTP " + res.status);
    const data = await res.json();
    lastBookings = Array.isArray(data) ? data : [];
    renderAllBookings(lastBookings);
  } catch (e) {
    console.warn("fetchBookings error:", e);
    showToast("Sync failed");
  }
}

function renderAllBookings(list) {
  const newArr    = list.filter(b => b.status === "REQUESTED");
  const activeArr = list.filter(b => ["ACCEPTED","ENROUTE","ARRIVED","PICKED_UP"].includes(b.status));
  const doneArr   = list.filter(b => ["COMPLETED","CANCELLED"].includes(b.status));

  renderColumn("listNew", newArr);
  renderColumn("listActive", activeArr);
  renderColumn("listDone", doneArr);

  document.getElementById("countNew").textContent    = newArr.length;
  document.getElementById("countActive").textContent = activeArr.length;
  document.getElementById("countDone").textContent   = doneArr.length;
}

function renderColumn(id, arr) {
  const box = document.getElementById(id);
  box.innerHTML = "";

  if (!arr.length) {
    box.innerHTML = `<div class="empty-text">None</div>`;
    return;
  }

  arr.forEach(b => {
    const div = document.createElement("div");
    div.className = "card";

    const estFare = b.pricing?.estimate
      ? `$${Number(b.pricing.estimate).toFixed(2)}`
      : "--";

    const estMinutes = b.metrics?.minutes
      ? `${Math.round(b.metrics.minutes)} min`
      : null;

    const rideId = b.id;
    const isEnrouteOrArrivedOrPickedUp = ["ENROUTE","ARRIVED","PICKED_UP"].includes(b.status);

    div.innerHTML = `
      <div class="card-label-row">
        <span><strong>${b.type || "RIDE"}</strong></span>
        <span>
          <span class="badge badge-status">${b.status}</span>
        </span>
      </div>

      <div class="loc-line">FROM: ${b.pickup?.address || "‚Äî"}</div>
      ${
        b.stops?.length
          ? `<div class="loc-line">STOPS: ${b.stops.map(s => s.address).join(" ‚Üí ")}</div>`
          : ""
      }
      <div class="loc-line">TO: ${b.dropoff?.address || "‚Äî"}</div>

      <div class="vehicle-select-row">
        <img src="${b.vehicle?.image || "/Black Acadia Thumbnail.PNG"}"
             class="vehicle-thumb"
             id="vehImg-${rideId}">
        <select class="vehicle-dropdown" data-id="${rideId}" id="vehSel-${rideId}">
          <option value="BLACK_ACADIA"
                  data-label="Black GMC Acadia (SUV)"
                  data-img="/Black Acadia Thumbnail.PNG"
                  ${b.vehicle?.code === "BLACK_ACADIA" || !b.vehicle ? "selected" : ""}>
            Black GMC Acadia (SUV)
          </option>
          <option value="BIG_RED"
                  data-label="Big Red (Red Silverado)"
                  data-img="/Big Red Thumbnail.PNG"
                  ${b.vehicle?.code === "BIG_RED" ? "selected" : ""}>
            Big Red (Red Silverado)
          </option>
        </select>
      </div>

      <div style="margin-top:6px;">Est Fare: ${estFare}</div>
      ${
        estMinutes
          ? `<div class="eta-line">Est. ride time (from calculator): ${estMinutes}</div>`
          : ""
      }

      <div class="card-footer">
        <div>
          <select class="status-dropdown" data-id="${rideId}">
            <option ${b.status==="REQUESTED" ? "selected" : ""}>REQUESTED</option>
            <option ${b.status==="ACCEPTED"  ? "selected" : ""}>ACCEPTED</option>
            <option ${b.status==="ENROUTE"   ? "selected" : ""}>ENROUTE</option>
            <option ${b.status==="ARRIVED"   ? "selected" : ""}>ARRIVED</option>
            <option ${b.status==="PICKED_UP" ? "selected" : ""}>PICKED_UP</option>
            <option ${b.status==="COMPLETED" ? "selected" : ""}>COMPLETED</option>
            <option ${b.status==="CANCELLED" ? "selected" : ""}>CANCELLED</option>
          </select>
        </div>
        <div style="display:flex;flex-direction:column;align-items:flex-end;gap:4px;">
          <div style="font-size:.75rem;color:#bbb;">
            Rider: ${b.rider?.name || "‚Äî"}
          </div>
          <div style="display:flex;gap:4px;flex-wrap:wrap;justify-content:flex-end;">
            ${
              b.rider?.phone
                ? `<a class="chip muted" href="sms:${b.rider.phone}">Text Rider</a>`
                : ""
            }
            ${
              isEnrouteOrArrivedOrPickedUp
                ? `<a class="chip primary" href="https://location-reader.bigredtransportation.workers.dev/?id=${encodeURIComponent(rideId)}" target="_blank">Live Map</a>`
                : ""
            }
          </div>
        </div>
      </div>
    `;

    box.appendChild(div);
  });
}

/* Change booking status */
document.body.addEventListener("change", async (e) => {
  if (!e.target.classList.contains("status-dropdown")) return;

  const id = e.target.dataset.id;
  const newState = e.target.value;

  try {
    const res = await fetch(`${BOOKINGS_API}/api/driver/bookings/${id}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ status: newState })
    });

    if (res.ok) {
      showToast(`Status ‚Üí ${newState}`);
      // Fire ride-specific push (best-effort)
      const booking = lastBookings.find(b => b.id === id);
      if (booking) {
        pushRideStatusUpdate(booking, newState);
      }
      fetchBookings();
    } else {
      showToast("Update failed");
    }
  } catch (err) {
    console.error(err);
    showToast("Update failed");
  }
});

/* Vehicle assignment */
document.body.addEventListener("change", async (e) => {
  if (!e.target.classList.contains("vehicle-dropdown")) return;

  const id = e.target.dataset.id;
  const option = e.target.selectedOptions[0];
  const vehicle = {
    code:  option.value,
    label: option.dataset.label,
    image: option.dataset.img
  };

  const img = document.getElementById(`vehImg-${id}`);
  if (img) img.src = vehicle.image;

  try {
    const res = await fetch(`${BOOKINGS_API}/api/driver/bookings/${id}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ vehicle })
    });

    if (res.ok) {
      showToast("Vehicle updated");
    } else {
      showToast("Update failed");
    }
  } catch (err) {
    console.error(err);
    showToast("Update failed");
  }
});

/* Scope cycling & refresh */
document.getElementById("btnScope").addEventListener("click", () => {
  if (scope === "active")      scope = "upcoming";
  else if (scope === "upcoming") scope = "all";
  else                          scope = "active";

  document.getElementById("btnScope").textContent = `üìã ${scope}`;
  fetchBookings();
});

document.getElementById("btnRefreshDriver").addEventListener("click", () => {
  fetchBookings();
  showToast("Refreshing‚Ä¶");
});

/* Auto-refresh driver bookings */
setInterval(fetchBookings, 20000);

/* =========================================================
   RIDE-SPECIFIC PUSH (best-effort hook)
========================================================= */
function humanStatusLabel(st) {
  switch (st) {
    case "ACCEPTED":  return "Ride accepted ‚Äî you‚Äôre on the list.";
    case "ENROUTE":   return "Big Red is en route to your pickup.";
    case "ARRIVED":   return "Big Red has arrived at your pickup.";
    case "PICKED_UP": return "You‚Äôre on the way ‚Äî ride in progress.";
    case "COMPLETED": return "Your ride has been completed. Thank you!";
    case "CANCELLED": return "Your ride was cancelled.";
    default:          return `Status updated: ${st}`;
  }
}

async function pushRideStatusUpdate(booking, newStatus) {
  try {
    const payload = {
      type: "ride-status",
      rideId: booking.id,
      title: "Big Red Ride Update",
      message: humanStatusLabel(newStatus)
      // Worker can map rideId ‚Üí device/alias.
    };

    const res = await fetch(PUSH_WORKER, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const txt = await res.text();
    console.log("Ride-status push:", booking.id, newStatus, res.status, txt);
  } catch (e) {
    console.warn("Ride-status push error:", e);
  }
}

/* =========================================================
   INIT
========================================================= */
window.addEventListener("load", () => {
  // Initial UI state
  setImage(0);
  applyTemplateToCaption("LIVE");
  updatePushPreview();
  loadStatus();
  loadLastCaption();
  fetchBookings();
});
</script>

</body>
</html>