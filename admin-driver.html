<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Big Red Admin / Driver Console</title>

<link rel="apple-touch-icon" href="icon.PNG">
<link rel="icon" type="image/png" sizes="192x192" href="icon.png">
<link rel="shortcut icon" href="icon.PNG">
<link rel="manifest" href="manifest-admin.json">
<meta name="apple-mobile-web-app-title" content="Big Red Admin">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="theme-color" content="#000">
<meta http-equiv="Cache-Control" content="no-store"/>

<!-- OneSignal v16 -->
<script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
<script>
  window.OneSignalDeferred = window.OneSignalDeferred || [];
  OneSignalDeferred.push(async function(OneSignal){
    try{
      await OneSignal.init({
        appId:"9b8bcc89-87d3-46e2-b2d0-042d1a267718",
        safari_web_id:"web.onesignal.auto.0c90051e-4735-447d-b203-75e3767d91b9",
        notifyButton:{enable:false},
        serviceWorkerPath:"/onesignalsdkworker.js",
        path:"/"
      });
      await OneSignal.login("admin_driver_live");
      await OneSignal.sendTag("env","live");
      await OneSignal.sendTag("role_admin_live","true");
      await OneSignal.sendTag("role_driver_live","true");
      console.log("[Admin/Driver] OneSignal initialized + tags set.");
    }catch(e){
      console.warn("OneSignal admin-driver init error:",e);
    }
  });

  function enableAdminAlerts(){
    window.OneSignalDeferred.push(async function(OneSignal){
      const supported = OneSignal.Notifications.isPushSupported();
      if(!supported){
        alert("Notifications not supported on this device.");
        return;
      }
      const perm = OneSignal.Notifications.permission;
      if(perm === "granted" || perm === true){
        alert("Alerts already enabled.");
        return;
      }
      await OneSignal.Slidedown.promptPush();
    });
  }
</script>

<style>
:root{--red:#b30000;--bg:#000;--panel:#111;--muted:#aaa;--border:#222;--accent:#ffcc00;}
*{box-sizing:border-box;}
body{background:var(--bg);color:#fff;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;margin:0;}
header{background:var(--panel);display:flex;justify-content:space-between;align-items:center;padding:8px 12px;border-bottom:2px solid var(--red);position:sticky;top:0;z-index:20;}
.header-left{display:flex;align-items:center;gap:10px;font-size:.9rem;}
.header-left img{height:40px;border-radius:4px;}
.pill{padding:3px 10px;border-radius:999px;font-weight:700;font-size:.8rem;}
.pill.online{background:#064;}
.pill.away{background:#665500;}
.pill.offline{background:#400;}
.header-right{display:flex;gap:6px;align-items:center;}
.btn{padding:6px 10px;border-radius:8px;border:none;cursor:pointer;font-weight:600;font-size:.85rem;}
.btn-primary{background:var(--red);color:#fff;}
.btn-secondary{background:#000;color:#fff;border:1px solid var(--red);}
.btn-ghost{background:#111;color:#fff;border:1px solid #444;}
h1{text-align:center;margin:14px 0 4px;color:var(--red);font-size:1.4rem;}
.tagline{text-align:center;color:#ddd;margin:0 0 10px;font-size:.9rem;}
#status-pill{margin:10px auto 12px;padding:8px 14px;border-radius:18px;display:inline-block;min-width:260px;font-size:.85rem;background:#222;border:1px solid #333;}
#status-pill.online{background:#064;}
#status-pill.away{background:#665500;}
#status-pill.offline{background:#400;}
.layout{display:grid;grid-template-columns:1fr;gap:14px;max-width:1200px;margin:0 auto 20px;padding:0 10px 18px;}
@media(min-width:900px){.layout{grid-template-columns:1.1fr 1.3fr;}}
section{background:var(--panel);border:1px solid var(--border);border-radius:8px;padding:12px;margin:0;}
section h2{margin:4px 0 8px;font-size:1rem;border-bottom:1px solid #222;padding-bottom:4px;}
.meta{font-size:.78rem;color:var(--muted);margin-top:4px;}
select,button,input,textarea{font-family:inherit;}
select,button,input[type=text],input[type=url]{padding:7px 9px;border-radius:6px;border:none;margin:4px 0;font-weight:600;font-size:.85rem;}
textarea{width:100%;min-height:90px;background:#111;color:#fff;border:1px solid var(--red);border-radius:6px;padding:8px;resize:vertical;font-size:.85rem;}
.row{display:flex;align-items:center;flex-wrap:wrap;gap:8px;margin:6px 0;}
.preview-box{margin-top:6px;padding:8px;border-radius:6px;border:1px dashed #444;background:#050505;font-size:.8rem;color:#ddd;}
.img-box{max-width:100%;margin:8px auto 4px;border:2px solid var(--red);border-radius:6px;padding:6px;background:#000;}
.img-box img{width:100%;border-radius:6px;}

.grid-dispatch{display:grid;grid-template-columns:1fr;gap:8px;}
@media(min-width:900px){.grid-dispatch{grid-template-columns:repeat(3,1fr);}}
.column{background:#000;border-radius:8px;border:1px solid #222;overflow:hidden;}
.col-header{padding:8px 10px;border-bottom:1px solid #222;font-weight:700;font-size:.8rem;display:flex;justify-content:space-between;align-items:center;}
.col-body{max-height:60vh;overflow-y:auto;padding:8px;}
.empty-text{text-align:center;color:#777;padding:18px 6px;font-size:.8rem;}
.card{background:#111;border:1px solid #333;border-radius:8px;padding:8px;margin-bottom:8px;font-size:.78rem;}
.card-label-row{display:flex;justify-content:space-between;margin-bottom:4px;}
.badge{padding:2px 6px;border-radius:999px;font-size:.65rem;border:1px solid #666;}
.loc-line{margin:3px 0;font-size:.76rem;}
.eta-line{margin-top:3px;font-size:.75rem;color:#ccc;}
.vehicle-select-row{display:flex;align-items:center;gap:6px;margin:6px 0;}
.vehicle-thumb{width:50px;border-radius:6px;border:1px solid #333;}
.vehicle-dropdown{flex:1;background:#111;color:#fff;border:1px solid #333;padding:5px;border-radius:6px;font-size:.75rem;}
.card-footer{border-top:1px solid #222;margin-top:6px;padding-top:4px;display:flex;justify-content:space-between;align-items:center;gap:4px;flex-wrap:wrap;}
.status-dropdown{background:#111;color:#fff;border:1px solid #333;padding:4px;border-radius:6px;font-size:.75rem;}
.chip{padding:3px 7px;border-radius:999px;border:1px solid #444;background:#111;color:#eee;font-size:.7rem;cursor:pointer;text-decoration:none;display:inline-block;}
.chip.primary{border-color:var(--red);color:#ffdada;}
#toast{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:#111;color:#fff;border:1px solid var(--red);padding:8px 16px;border-radius:16px;opacity:0;pointer-events:none;transition:opacity .35s;z-index:50;font-size:.8rem;}
#toast.show{opacity:1;}
#debugLog{font-family:monospace;font-size:.72rem;color:#0f0;background:#000;padding:6px;max-height:180px;overflow:auto;border-top:1px solid #222;}

/* üîÄ Admin / Driver mode visibility */
body.mode-driver .admin-only{display:none;}
body.mode-admin .driver-only{display:block;}
</style>
</head>

<body class="mode-admin">
<header>
  <div class="header-left">
    <a href="index.html"><img src="official_logo_Nov.png" alt="Big Red Connect logo"></a>
    <div>
      <div style="font-weight:700;font-size:.9rem;">Big Red Admin / Driver</div>
      <div style="color:#888;font-size:.75rem;">Live Dispatch & Status</div>
    </div>
    <span id="livePill" class="pill offline">üì° Tracking: OFF</span>
  </div>
  <div class="header-right">
    <!-- NEW: Mode toggle button -->
    <button class="btn btn-secondary" id="btnModeToggle">üõ† Admin Mode</button>
    <button class="btn btn-ghost" id="btnRefreshPage">üîÑ Refresh</button>
    <button class="btn btn-secondary" onclick="enableAdminAlerts()">üîî Alerts</button>
  </div>
</header>

<h1>Big Red Connect ‚Äî Admin / Driver Console</h1>
<p class="tagline">Veteran Owned ‚Ä¢ Affordable ‚Ä¢ Local ‚Ä¢ Trusted</p>

<div style="text-align:center;">
  <div id="status-pill" class="offline">Status: OFFLINE ‚Ä¢ loading‚Ä¶</div>
</div>

<div class="layout">
  <div>
    <!-- STATUS + GPS -->
    <section>
      <h2>Driving Status & GPS</h2>
      <div class="row">
        <select id="statusSelect">
          <option value="online">üü¢ On the Road</option>
          <option value="away">üü° Limited Availability</option>
          <option value="offline" selected>üî¥ Offline</option>
        </select>
        <button class="btn btn-primary" id="updateStatusBtn">üíæ Save</button>
      </div>

      <!-- NEW: Global Active Vehicle selector -->
      <div class="row">
        <label for="globalVehicleSelect" style="font-size:.8rem;color:#ccc;">Active Vehicle</label>
        <select id="globalVehicleSelect" class="vehicle-dropdown">
          <option value="BLACK_ACADIA">Black GMC Acadia (SUV)</option>
          <option value="BIG_RED">Big Red (Red Silverado)</option>
        </select>
      </div>

      <div class="meta">
        Last status update: <span id="statusStamp">‚Äî</span><br>
        Last GPS ping: <span id="gpsStamp">‚Äî</span> ‚Ä¢ Interval: <span id="gpsRate">‚Äî</span>
      </div>
    </section>

    <!-- BROADCAST PUSH (Admin-only) -->
    <section class="admin-only">
      <h2>Broadcast Push Alerts (Riders)</h2>

      <div class="row">
        <label style="font-size:.8rem;color:#ccc;">Template:</label>
      </div>
      <div class="row">
        <select id="pushTemplate">
          <option value="LIVE">üöó LIVE ‚Äî Ready to Roll</option>
          <option value="AIRPORT">‚úàÔ∏è Airport Runs</option>
          <option value="WEEKEND">üçª Weekend Night Run</option>
          <option value="CAMPUS">üÖøÔ∏è Campus Corner Late Night</option>
          <option value="XMAS1">üéÑ Christmas ‚Äì Lights & Events</option>
          <option value="XMAS2">üéÑ Christmas ‚Äì Nights Out</option>
          <option value="XMAS3">üéÑ Christmas ‚Äì Family & Errands</option>
          <option value="XMAS4">üéÑ Christmas ‚Äì Zoo Lights & Dates</option>
          <option value="XMAS5">üéÑ Christmas ‚Äì Late Night Pickups</option>
          <option value="OFFLINE">üî¥ Going Offline</option>
          <option value="CUSTOM">‚úèÔ∏è Custom Only</option>
        </select>
        <button class="btn-ghost" id="pushApplyTemplate">Apply</button>
      </div>

      <label style="font-size:.8rem;color:#ccc;">Title</label>
      <input id="pushTitle" type="text" placeholder="Big Red Connect"/>

      <label style="font-size:.8rem;color:#ccc;">Message</label>
      <textarea id="pushMessage" placeholder="Enter broadcast message"></textarea>

      <label style="font-size:.8rem;color:#ccc;">Tap-through Link (optional)</label>
      <input id="pushUrl" type="url" placeholder="https://bigredconnectokc.com/"/>

      <div class="preview-box">
        <strong>Preview:</strong><br>
        <span id="pushPrevTitle">Big Red Connect</span><br>
        <span id="pushPrevMessage">Message will appear here.</span><br>
        <span style="color:#888;font-size:.75rem;">Link: <span id="pushPrevUrl">https://bigredconnectokc.com/</span></span>
      </div>

      <div class="row" style="margin-top:8px;">
        <button class="btn btn-primary" id="sendBroadcastPush">üì¢ Send Broadcast</button>
        <button class="btn btn-secondary" id="clearPush">üßπ Clear</button>
      </div>

      <p class="meta">
        Sends a push notification to all riders tagged <code>env = "live"</code>.
      </p>
    </section>

    <!-- LIVE MAP (Admin-only) -->
    <section class="admin-only">
      <h2>Live Map ‚Äî Image & Caption</h2>
      <div class="img-box">
        <img id="statusImage" src="" alt="Live status image">
      </div>

      <div class="row">
        <button id="prevImage" class="btn-ghost">‚¨Ö Image</button>
        <button id="nextImage" class="btn-ghost">Image ‚û°</button>
      </div>

      <div class="row">
        <button id="prevCaption" class="btn-ghost">‚¨Ö Caption</button>
        <button id="nextCaption" class="btn-ghost">Caption ‚û°</button>
        <button id="resetCaption" class="btn-secondary">Reset</button>
      </div>

      <label style="font-size:.8rem;color:#ccc;">Caption</label>
      <textarea id="captionBox">Loading‚Ä¶</textarea>

      <div class="row" style="margin-top:8px;">
        <button class="btn btn-secondary" id="copyBtn">üìã Copy Caption</button>
        <button class="btn btn-primary" id="postToLive">üì¢ Post to Live Map</button>
      </div>

      <p class="meta">Updates the live map worker.</p>
    </section>
  </div>

  <!-- DISPATCH BOARD -->
  <div>
    <section>
      <h2>Driver Dispatch Board</h2>
      <div class="row" style="justify-content:space-between;">
        <button class="btn btn-ghost" id="btnDispatchRefresh">üîÑ Refresh</button>
        <button class="btn btn-secondary" id="btnScope">üìã active</button>
      </div>

      <div class="grid-dispatch">
        <div class="column">
          <div class="col-header">üÜï New Requests <span id="countNew">0</span></div>
          <div class="col-body" id="listNew"><div class="empty-text">None</div></div>
        </div>
        <div class="column">
          <div class="col-header">üö¶ Active Trips <span id="countActive">0</span></div>
          <div class="col-body" id="listActive"><div class="empty-text">None</div></div>
        </div>
        <div class="column">
          <div class="col-header">‚úÖ Completed <span id="countDone">0</span></div>
          <div class="col-body" id="listDone"><div class="empty-text">None</div></div>
        </div>
      </div>

      <p class="meta">Tap status to move rides.</p>
    </section>
  </div>
</div>

<div id="toast"></div>
<div id="debugLog" class="admin-only">[Debug started]</div>

<script>
const STATUS_WORKER="https://bigred-status-updater.bigredtransportation.workers.dev";
const LOCATION_WORKER="https://update-location.bigredtransportation.workers.dev";
const POST_WORKER="https://post-to-live-beta.bigredtransportation.workers.dev";
const PUSH_WORKER="https://bigred-push.bigredtransportation.workers.dev";
const BOOKINGS_API="https://bigred-bookings.bigredtransportation.workers.dev";

const AUTH_SECRET="BigRedPrivateKey2025";
const TZ="America/Chicago";
const HOME_URL="https://bigredconnectokc.com/";

const LIVE_IMAGES=[
  "icon.png","icon.PNG",
  "0081086F-89FA-41B2-85EB-E4EE97E9E8EF.png",
  "059AAE7C-E31D-4780-B0FD-00535D28F120.png",
  "148D1A08-D537-4A0C-B141-2336DBF68A15.png",
  "1A5072F2-8604-4CAB-BC84-E15D86D8CE73.png",
  "3673A967-4A2D-4F9C-8602-0C820D31D168.png",
  "37263759-BD32-4E50-883A-0A5BE2F71928.png",
  "3F34BE7E-5953-433C-B8D0-17AC9108107F.png",
  "7106A362-DEC7-4EA7-A0B2-B83DC93EFFAD.png",
  "8F06509B-317B-45C2-89CE-B2AD1E16D054.png",
  "982ABF7A-D9F5-403D-BAE8-13777EC286FB.png",
  "B02ABF7E-1AF5-4BE4-8CBB-E5A1AA40711F.png",
  "BA7E86CF-5782-4323-B0B2-19918EF67887.png",
  "Big Red Live 2.png",
  "Big Red Live Christmas.png",
  "Big Red Live Holiday 1.png",
  "Big Red Live Text Only.png",
  "Big Red Live Thanksgiving.png",
  "Official Logo.png"
];

let imgIndex=0;

const TEMPLATES={
  LIVE:{title:"Big Red is LIVE",message:"üöó Big Red Connect is LIVE across the metro ‚Äî text RED to 405-378-4024."},
  AIRPORT:{title:"Airport Runs Available",message:"‚úàÔ∏è Flat-rate airport connections ‚Äî text RED to 405-378-4024."},
  WEEKEND:{title:"Weekend Night Runs",message:"üçª From last call to your front door ‚Äî ride local, text RED."},
  CAMPUS:{title:"Campus Corner Nights",message:"üéì OU events + late nights ‚Äî text RED to 405-378-4024."},
  XMAS1:{title:"Christmas Season Rides",message:"üéÑ Zoo Lights, holiday parties ‚Äî plan ahead with Big Red."},
  XMAS2:{title:"Holiday Nights Out",message:"üéÑ Late night holiday runs ‚Äî text RED."},
  XMAS3:{title:"Holiday Family & Errands",message:"üéÑ Shopping + family ‚Äî plan ahead with Big Red."},
  XMAS4:{title:"Zoo Lights & Date Nights",message:"üéÑ Date nights + events ‚Äî ride local."},
  XMAS5:{title:"Holiday Late Night Pickups",message:"üéÑ Late-night holiday pickups ‚Äî text RED."},
  OFFLINE:{title:"Big Red is Offline",message:"üî¥ Big Red is offline ‚Äî text RED for next run info."}
};

const CAPTION_KEYS=["LIVE","AIRPORT","WEEKEND","CAMPUS","XMAS1","XMAS2","XMAS3","XMAS4","XMAS5","OFFLINE"];
let captionIndex=0;

let gpsTimer=null;
let gpsLastTs=null;
let dispatchScope="active";

/* NEW: track current status so we can detect offline ‚Üí online */
let currentStatusVal = "offline";

/* NEW: mode management */
let currentMode = localStorage.getItem("adminDriverMode") || "admin";
function applyMode(mode){
  currentMode = (mode === "driver") ? "driver" : "admin";
  const body=document.body;
  body.classList.remove("mode-admin","mode-driver");
  body.classList.add(currentMode==="driver"?"mode-driver":"mode-admin");
  const btn=document.getElementById("btnModeToggle");
  if(btn){
    btn.textContent = currentMode==="driver" ? "üöó Driver Mode" : "üõ† Admin Mode";
  }
  localStorage.setItem("adminDriverMode",currentMode);
}

function showToast(msg){
  const t=document.getElementById("toast");
  t.textContent=msg;
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"),2000);
}
function log(msg){
  const box=document.getElementById("debugLog");
  const time=new Date().toLocaleTimeString("en-US",{hour12:false});
  box.innerHTML=`[${time}] ${msg}<br>`+box.innerHTML;
}
function formatDateTime(iso){
  if(!iso)return"‚Äî";
  try{
    return new Date(iso).toLocaleString("en-US",{
      timeZone:TZ,
      month:"2-digit",day:"2-digit",year:"2-digit",
      hour:"2-digit",minute:"2-digit"
    });
  }catch(e){return iso;}
}
function captionBox(){return document.getElementById("captionBox");}

/* IMAGES */
function loadImages(){setImage(0);}
function setImage(idx){
  if(!LIVE_IMAGES.length)return;
  imgIndex=(idx+LIVE_IMAGES.length)%LIVE_IMAGES.length;
  document.getElementById("statusImage").src=LIVE_IMAGES[imgIndex];
  log("Image set: "+LIVE_IMAGES[imgIndex]);
}

/* STATUS + GPS */
async function loadStatus(){
  try{
    const res=await fetch(STATUS_WORKER+"/status");
    if(!res.ok)return;
    const data=await res.json();
    log("Status GET OK: "+JSON.stringify(data));
    let statusVal=data.status||"offline";

    /* update tracker */
    currentStatusVal = statusVal;

    const pill=document.getElementById("status-pill");
    const headerPill=document.getElementById("livePill");
    pill.classList.remove("online","away","offline");
    headerPill.classList.remove("online","away","offline");
    let label="";
    if(statusVal==="online"){
      label="ONLINE";
      pill.classList.add("online");
      headerPill.classList.add("online");
      headerPill.textContent="üì° Tracking: ON";
    }else if(statusVal==="away"){
      label="LIMITED";
      pill.classList.add("away");
      headerPill.classList.add("away");
      headerPill.textContent="üì° Tracking: LIMITED";
    }else{
      label="OFFLINE";
      pill.classList.add("offline");
      headerPill.classList.add("offline");
      headerPill.textContent="üì° Tracking: OFF";
    }
    const when=formatDateTime(data.lastUpdated);
    pill.textContent=`Status: ${label} ‚Ä¢ as of ${when}`;
    document.getElementById("statusStamp").textContent=when;
    document.getElementById("statusSelect").value=statusVal;

    /* NEW: restore global vehicle from status if present */
    const globalVeh=document.getElementById("globalVehicleSelect");
    if(globalVeh){
      if(data.vehicle && data.vehicle.code){
        globalVeh.value=data.vehicle.code;
      }else{
        globalVeh.value="BLACK_ACADIA";
      }
    }

    handleGpsForStatus(statusVal);
  }catch(e){
    log("Status error: "+e.message);
  }
}

async function updateStatus(){
  const val=document.getElementById("statusSelect").value;
  let normalized=val;
  let message=val==="online"?"On the Road":val==="away"?"Limited Availability":"Offline";

  const wasOnline = (currentStatusVal === "online");

  /* NEW: read global vehicle */
  const globalVeh=document.getElementById("globalVehicleSelect");
  const vehicleCode = globalVeh ? globalVeh.value : undefined;

  try{
    log("Status PUT‚Ä¶");
    const payload = {
      status:normalized,
      online:(normalized==="online"),
      message
    };
    if(vehicleCode){
      payload.vehicleCode = vehicleCode;
    }

    const res=await fetch(STATUS_WORKER+"/status",{
      method:"PUT",
      headers:{
        "Content-Type":"application/json",
        "X-Auth-Token":AUTH_SECRET
      },
      body:JSON.stringify(payload)
    });
    const bodyText = await res.text();
    log("Status PUT response: "+bodyText);
    showToast(res.ok?"Status updated":"Status update failed");

    if(res.ok){
      /* update local tracker */
      currentStatusVal = normalized;

      /* if we just transitioned OFFLINE/AWAY ‚Üí ONLINE, fire auto push */
      if(!wasOnline && normalized === "online"){
        log("Auto-online push trigger fired.");
        autoOnlinePush();
      }
    }

    loadStatus();
  }catch(e){
    log("PUT error:"+e.message);
    showToast("Status error");
  }
}

function handleGpsForStatus(val){
  if(val==="online")startGpsPings();else stopGpsPings();
}
function startGpsPings(){
  if(gpsTimer){clearInterval(gpsTimer);gpsTimer=null;}
  if(!("geolocation" in navigator)){
    log("No geolocation.");
    return;
  }
  gpsTimer=setInterval(()=>{
    navigator.geolocation.getCurrentPosition(pos=>{
      const now=Date.now();
      document.getElementById("gpsStamp").textContent=new Date().toLocaleString("en-US",{timeZone:TZ});
      if(gpsLastTs){
        document.getElementById("gpsRate").textContent=Math.round((now-gpsLastTs)/1000)+"s";
      }else{
        document.getElementById("gpsRate").textContent="~15s";
      }
      gpsLastTs=now;
      fetch(LOCATION_WORKER,{
        method:"PUT",
        headers:{
          "Content-Type":"application/json",
          "X-Auth-Token":AUTH_SECRET
        },
        body:JSON.stringify({
          lat:pos.coords.latitude,
          lng:pos.coords.longitude,
          accuracy:pos.coords.accuracy,
          updated:new Date().toISOString()
        })
      }).then(r=>r.text())
        .then(t=>log("GPS PUT: "+t))
        .catch(e=>log("GPS error:"+e.message));
    },err=>log("GPS error:"+err.message),{
      enableHighAccuracy:true,
      maximumAge:5000,
      timeout:10000
    });
  },15000);
}
function stopGpsPings(){
  if(gpsTimer){clearInterval(gpsTimer);gpsTimer=null;}
  document.getElementById("gpsRate").textContent="‚Äî";
}

/* CAPTIONS */
function applyTemplateToCaption(key){
  const t=TEMPLATES[key];if(!t)return;
  captionBox().value=t.message;
  captionIndex=CAPTION_KEYS.indexOf(key);
}
function stepCaption(d){
  captionIndex=(captionIndex+d+CAPTION_KEYS.length)%CAPTION_KEYS.length;
  applyTemplateToCaption(CAPTION_KEYS[captionIndex]);
}
async function loadLastCaption(){
  try{
    const r=await fetch(POST_WORKER+"/current");
    const d=await r.json();
    captionBox().value=d.caption||TEMPLATES.LIVE.message;
  }catch(e){
    captionBox().value=TEMPLATES.LIVE.message;
  }
}
async function postToLive(){
  const c=captionBox().value.trim();
  if(!c){showToast("Caption required");return;}
  const img=LIVE_IMAGES[imgIndex]||"";
  const statusSel=document.getElementById("statusSelect").value;
  try{
    const r=await fetch(POST_WORKER,{
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "X-Admin-Secret":AUTH_SECRET
      },
      body:JSON.stringify({caption:c,image:img,status:statusSel})
    });
    showToast(r.ok?"Live map updated":"Update failed");
  }catch(e){
    showToast("Error posting live");
  }
}

/* PUSH PREVIEW + BROADCAST */
function updPrev(){
  document.getElementById("pushPrevTitle").textContent=
    document.getElementById("pushTitle").value||"Big Red Connect";
  document.getElementById("pushPrevMessage").textContent=
    document.getElementById("pushMessage").value||"Message will appear here.";
  document.getElementById("pushPrevUrl").textContent=
    document.getElementById("pushUrl").value||HOME_URL;
}
function applyPushTemplate(){
  const k=document.getElementById("pushTemplate").value;
  if(k==="CUSTOM")return;
  const t=TEMPLATES[k];if(!t)return;
  document.getElementById("pushTitle").value=t.title;
  document.getElementById("pushMessage").value=t.message;
  document.getElementById("pushUrl").value=HOME_URL;
  captionBox().value=t.message;
  updPrev();
  captionIndex=CAPTION_KEYS.indexOf(k);
}
function clearPush(){
  document.getElementById("pushTitle").value="";
  document.getElementById("pushMessage").value="";
  document.getElementById("pushUrl").value="";
  updPrev();
}

async function sendPush(payload){
  try{
    const r=await fetch(PUSH_WORKER,{
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "X-Admin-Secret":AUTH_SECRET
      },
      body:JSON.stringify(payload)
    });
    const txt=await r.text();
    log("Push response: "+r.status+" "+txt);
    showToast(r.ok?"Push sent":"Push failed");
  }catch(e){
    log("Push error: "+e.message);
    showToast("Push error");
  }
}

/* üîî RIDER BROADCAST: env = live */
function handlePushBroadcast(){
  const title=document.getElementById("pushTitle").value.trim()||"Big Red Connect";
  const msg=document.getElementById("pushMessage").value.trim();
  const url=document.getElementById("pushUrl").value.trim()||HOME_URL;
  if(!msg){
    showToast("Message required");
    return;
  }

  const payload = {
    type: "broadcast",
    title,
    message: msg,
    url,
    filters: [
      { field: "tag", key: "env", value: "live" }
    ]
  };

  sendPush(payload);
}

/* NEW: automatic online push ‚Äì uses same path as broadcast */
function autoOnlinePush(){
  const payload = {
    type: "broadcast",
    title: "Big Red is LIVE",
    message: "üöó Big Red Connect is LIVE across the metro ‚Äî text RED to 405-378-4024 for a flat-rate connection.",
    url: HOME_URL,
    filters: [
      { field: "tag", key: "env", value: "live" }
    ]
  };
  sendPush(payload);
}

/* CLIPBOARD */
function copyCaption(){
  navigator.clipboard.writeText(captionBox().value)
    .then(()=>showToast("Copied"),()=>showToast("Copy failed"));
}

/* DISPATCH */
async function fetchBookings(){
  try{
    const r=await fetch(`${BOOKINGS_API}/api/driver/bookings?scope=${dispatchScope}&t=${Date.now()}`);
    const data=await r.json();
    renderAllBookings(data);
  }catch(e){
    showToast("Dispatch sync failed");
  }
}

function renderAllBookings(list){
  const newArr=list.filter(b=>b.status==="REQUESTED");
  const activeArr=list.filter(b=>["ACCEPTED","ENROUTE","ARRIVED","PICKED_UP"].includes(b.status));
  const doneArr=list.filter(b=>["COMPLETED","CANCELLED"].includes(b.status));
  renderColumn("listNew",newArr);
  renderColumn("listActive",activeArr);
  renderColumn("listDone",doneArr);
  document.getElementById("countNew").textContent=newArr.length;
  document.getElementById("countActive").textContent=activeArr.length;
  document.getElementById("countDone").textContent=doneArr.length;
}

function renderColumn(id,arr){
  const box=document.getElementById(id);
  box.innerHTML="";
  if(!arr.length){
    box.innerHTML=`<div class="empty-text">None</div>`;
    return;
  }
  arr.forEach(b=>{
    const estFare=b.pricing?.estimate?`$${b.pricing.estimate.toFixed(2)}`:"--";
    const estMinutes=b.metrics?.minutes?`${Math.round(b.metrics.minutes)} min`:null;
    const rideId=b.id;
    const isEnroute=["ENROUTE","ARRIVED","PICKED_UP"].includes(b.status);
    const div=document.createElement("div");
    div.className="card";
    div.innerHTML=`
      <div class="card-label-row">
        <span><strong>${b.type}</strong></span>
        <span class="badge">${b.status}</span>
      </div>
      <div class="loc-line">FROM: ${b.pickup.address}</div>
      ${b.stops?.length?`<div class="loc-line">STOPS: ${b.stops.map(s=>s.address).join(" ‚Üí ")}</div>`:""}
      <div class="loc-line">TO: ${b.dropoff.address}</div>
      <div class="vehicle-select-row">
        <img src="${b.vehicle?.image||'/Black Acadia Thumbnail.PNG'}"
             class="vehicle-thumb"
             id="vehImg-${rideId}">
        <select class="vehicle-dropdown" data-id="${rideId}" id="vehSel-${rideId}">
          <option value="BLACK_ACADIA"
                  data-label="Black GMC Acadia (SUV)"
                  data-img="/Black Acadia Thumbnail.PNG"
                  ${(b.vehicle?.code==="BLACK_ACADIA"||!b.vehicle)?"selected":""}>
            Black GMC Acadia (SUV)
          </option>
          <option value="BIG_RED"
                  data-label="Big Red (Red Silverado)"
                  data-img="/Big Red Thumbnail.PNG"
                  ${b.vehicle?.code==="BIG_RED"?"selected":""}>
            Big Red (Red Silverado)
          </option>
        </select>
      </div>
      <div style="margin-top:6px;">Est Fare: ${estFare}</div>
      ${estMinutes?`<div class="eta-line">Est. ride time: ${estMinutes}</div>`:""}
      <div class="card-footer">
        <div>
          <select class="status-dropdown" data-id="${rideId}">
            <option ${b.status==="REQUESTED"?"selected":""}>REQUESTED</option>
            <option ${b.status==="ACCEPTED"?"selected":""}>ACCEPTED</option>
            <option ${b.status==="ENROUTE"?"selected":""}>ENROUTE</option>
            <option ${b.status==="ARRIVED"?"selected":""}>ARRIVED</option>
            <option ${b.status==="PICKED_UP"?"selected":""}>PICKED_UP</option>
            <option ${b.status==="COMPLETED"?"selected":""}>COMPLETED</option>
            <option ${b.status==="CANCELLED"?"selected":""}>CANCELLED</option>
          </select>
        </div>
        <div style="display:flex;flex-direction:column;align-items:flex-end;gap:4px;">
          <div style="font-size:.75rem;color:#bbb;">Rider: ${b.rider?.name||"‚Äî"}</div>
          <div style="display:flex;gap:4px;flex-wrap:wrap;">
            ${b.rider?.phone?`<a class="chip" href="sms:${b.rider.phone}">Text Rider</a>`:""}
            ${isEnroute?`<a class="chip primary" href="https://location-reader.bigredtransportation.workers.dev/?id=${rideId}" target="_blank">Live Map</a>`:""}
          </div>
        </div>
      </div>`;
    box.appendChild(div);
  });
}

/* DISPATCH EVENTS */
document.body.addEventListener("change",async(e)=>{
  if(!e.target.classList.contains("status-dropdown"))return;
  const id=e.target.dataset.id;
  const newState=e.target.value;
  try{
    const r=await fetch(`${BOOKINGS_API}/api/driver/bookings/${id}`,{
      method:"PUT",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({status:newState})
    });
    showToast(r.ok?`Status ‚Üí ${newState}`:"Update failed");
    fetchBookings();
  }catch(err){
    showToast("Failed");
  }
});

document.body.addEventListener("change",async(e)=>{
  if(!e.target.classList.contains("vehicle-dropdown"))return;
  const id=e.target.dataset.id;
  const opt=e.target.selectedOptions[0];
  const vehicle={code:opt.value,label:opt.dataset.label,image:opt.dataset.img};
  document.getElementById(`vehImg-${id}`).src=vehicle.image;
  try{
    const r=await fetch(`${BOOKINGS_API}/api/driver/bookings/${id}`,{
      method:"PUT",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({vehicle})
    });
    showToast(r.ok?"Vehicle updated":"Failed");
  }catch(err){
    showToast("Failed");
  }
});

/* SCOPE TOGGLE */
document.getElementById("btnScope").addEventListener("click",()=>{
  if(dispatchScope==="active")dispatchScope="upcoming";
  else if(dispatchScope==="upcoming")dispatchScope="all";
  else dispatchScope="active";
  document.getElementById("btnScope").textContent=`üìã ${dispatchScope}`;
  fetchBookings();
});

/* BUTTON WIRING */
document.getElementById("updateStatusBtn").onclick=updateStatus;
document.getElementById("prevImage").onclick=()=>setImage(imgIndex-1);
document.getElementById("nextImage").onclick=()=>setImage(imgIndex+1);
document.getElementById("prevCaption").onclick=()=>stepCaption(-1);
document.getElementById("nextCaption").onclick=()=>stepCaption(1);
document.getElementById("resetCaption").onclick=()=>applyTemplateToCaption("LIVE");
document.getElementById("copyBtn").onclick=copyCaption;
document.getElementById("postToLive").onclick=postToLive;
document.getElementById("pushApplyTemplate").onclick=applyPushTemplate;
document.getElementById("clearPush").onclick=clearPush;
document.getElementById("sendBroadcastPush").onclick=handlePushBroadcast;

["pushTitle","pushMessage","pushUrl"].forEach(id=>{
  document.getElementById(id).oninput=updPrev;
});

document.getElementById("btnRefreshPage").onclick=()=>location.reload(true);
document.getElementById("btnDispatchRefresh").onclick=()=>{
  fetchBookings();
  showToast("Dispatch refreshed");
};

/* NEW: Mode toggle click */
document.getElementById("btnModeToggle").onclick=()=>{
  applyMode(currentMode==="admin"?"driver":"admin");
};

/* INIT */
window.addEventListener("load",()=>{
  applyMode(currentMode);        // NEW: restore mode
  updPrev();
  applyTemplateToCaption("LIVE");
  loadImages();
  loadStatus();
  loadLastCaption();
  fetchBookings();
  setInterval(fetchBookings,20000);
});
</script>

</body>
</html>