<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Big Red Admin</title>

<!-- ðŸ“± PWA / Icons -->
<link rel="apple-touch-icon" href="icon.PNG">
<link rel="icon" type="image/png" sizes="192x192" href="icon.PNG">
<link rel="shortcut icon" href="icon.PNG">
<link rel="manifest" href="manifest-admin.json">
<meta name="apple-mobile-web-app-title" content="Big Red Admin">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="theme-color" content="#000">

<!-- OneSignal v16 SDK -->
<script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
<script>
  window.OneSignalDeferred = window.OneSignalDeferred || [];
</script>

<style>
  :root {
    --red:#b30000;
    --bg:#000;
    --panel:#111;
    --muted:#aaa;
  }
  body { background:var(--bg); color:#fff; font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; margin:0; }
  header {
    display:flex; justify-content:space-between; align-items:center;
    padding:12px 16px; border-bottom:2px solid var(--red);
  }
  .logo { height:36px; border-radius:4px; }
  main { max-width:640px; margin:20px auto; padding:0 16px 40px; }
  .card {
    background:var(--panel); border-radius:10px; border:1px solid #222;
    padding:14px 12px; margin-bottom:14px;
  }
  h1 { margin:10px 0 4px; font-size:1.4rem; }
  button {
    padding:10px 16px; border-radius:8px; border:none;
    font-weight:700; background:var(--red); color:#fff;
    cursor:pointer; margin-top:10px;
  }
  input, textarea {
    width:100%; padding:10px; border-radius:8px; border:1px solid #333;
    background:#000; color:#fff; margin-top:6px; font-size:.9rem;
  }
  #statusLine { font-size:.85rem; color:var(--muted); margin-top:6px; }
  #errorDetails { font-size:.8rem; color:#ff8080; margin-top:4px; white-space:pre-wrap; }
  #toast {
    position:fixed; bottom:20px; left:50%; transform:translateX(-50%);
    background:#111; border:1px solid var(--red);
    padding:8px 16px; border-radius:999px;
    opacity:0; pointer-events:none; transition:opacity .25s;
  }
  #toast.show { opacity:1; }
</style>
</head>
<body>

<header>
  <div style="display:flex; align-items:center; gap:10px;">
    <img src="icon.PNG" class="logo"/>
    <div>
      <div style="font-weight:700;font-size:1rem;">Big Red Admin</div>
      <div style="font-size:.75rem;color:#aaa;">Driver Console</div>
    </div>
  </div>
</header>

<main>
  <!-- OneSignal status -->
  <section class="card">
    <h1>Admin Push Setup</h1>
    <p>This device will be tagged as the <strong>LIVE Admin</strong> push controller.</p>
    <button id="btnEnable">ðŸ”” Enable Admin Alerts</button>
    <div id="statusLine">Status: waiting for OneSignalâ€¦</div>
    <div id="errorDetails"></div>
  </section>

  <!-- Send push -->
  <section class="card">
    <h1>Send Admin Push</h1>

    <label>Title</label>
    <input id="pushTitle" value="Admin Test"/>

    <label>Message</label>
    <textarea id="pushMessage" rows="3">Hello from Admin Console</textarea>

    <button id="btnSend">ðŸ“¤ Send Push</button>
  </section>
</main>

<div id="toast"></div>

<script>
const statusLine   = document.getElementById("statusLine");
const errorDetails = document.getElementById("errorDetails");
const toastEl      = document.getElementById("toast");
const pushTitle    = document.getElementById("pushTitle");
const pushMessage  = document.getElementById("pushMessage");
const btnEnable    = document.getElementById("btnEnable");
const btnSend      = document.getElementById("btnSend");

function setStatus(msg){ statusLine.textContent = msg; }
function setError(msg){ errorDetails.textContent = msg || ""; }
function toast(msg){
  toastEl.textContent = msg;
  toastEl.classList.add("show");
  setTimeout(()=> toastEl.classList.remove("show"), 2000);
}

/* --------------------------------------------------
   OneSignal Initialization (LIVE ADMIN DEVICE)
-------------------------------------------------- */
OneSignalDeferred.push(async function(OneSignal){
  try{
    setStatus("SDK loaded â€” initializingâ€¦");

    await OneSignal.init({
      appId: "9b8bcc89-87d3-46e2-b2d0-042d1a267718",
      safari_web_id: "web.onesignal.auto.0c90051e-4735-447d-b203-75e3767d91b9",
      notifyButton: { enable:false },
      serviceWorkerPath: "/onesignalsdkworker.js",
      path: "/"
    });

    // login as admin device
    await OneSignal.login("admin_driver_live");

    // apply tags
    await OneSignal.User.addTags({
      env: "live",
      role_admin_live: "true"
    });

    setStatus("Initialized â€” ready to request permission");
  }
  catch(e){
    console.error("Admin init error:", e);
    setStatus("Error initializing OneSignal");
    setError(String(e));
  }
});

/* --------------------------------------------------
   Request push permission
-------------------------------------------------- */
btnEnable.addEventListener("click", ()=>{
  OneSignalDeferred.push(async function(OneSignal){
    try {
      const result = await OneSignal.Notifications.requestPermission();
      setStatus("Permission: " + result);
      toast(result === "granted" ? "Alerts enabled!" : "Permission denied");
    } catch(e){
      setError(String(e));
      toast("Permission error");
    }
  });
});

/* --------------------------------------------------
   SEND PUSH â†’ Cloudflare Worker
-------------------------------------------------- */
btnSend.addEventListener("click", async ()=>{
  const title = pushTitle.value.trim();
  const msg   = pushMessage.value.trim();

  if(!title || !msg){
    toast("Enter title & message");
    return;
  }

  const payload = {
    type: "admin",
    title,
    message: msg
  };

  try{
    const res = await fetch("https://bigred-push.bigredtransportation.workers.dev/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-Admin-Secret": "BigRedPrivateKey2025"
      },
      body: JSON.stringify(payload)
    });

    const data = await res.json();
    console.log("Worker response:", data);

    if(data.ok){
      toast("Push sent!");
    } else {
      toast("Push error");
      setError(JSON.stringify(data, null, 2));
    }
  }
  catch(e){
    setError(String(e));
    toast("Network error");
  }
});
</script>

</body>
</html>