<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rider Login – Big Red Connect</title>

  <!-- Icons -->
  <link rel="apple-touch-icon" href="/BRCNYE2026.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/BRCNYE2026.png">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#000000">

  <style>
    body { margin:0; background:#000; color:#fff; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif; padding-bottom:40px; }
    header { padding:15px 12px; display:flex; align-items:center; gap:12px; border-bottom:2px solid #b30000; background:#000; position:sticky; top:0; z-index:20; }
    header img { height:46px; cursor:pointer; }
    h1 { text-align:center; margin:25px 10px 10px; font-size:1.44rem; font-weight:700; }
    .box { background:#111; border:1px solid #222; border-radius:10px; margin:12px; padding:18px; }
    label { display:block; margin-top:14px; font-size:.85rem; color:#bbb; }
    input { width:100%; padding:12px; font-size:1rem; margin-top:6px; border-radius:8px; border:1px solid #333; background:#000; color:#fff; }
    button { width:calc(100% - 24px); margin:18px 12px 0 12px; padding:14px; font-size:1rem; text-align:center; background:#b30000; color:#fff; border:none; border-radius:10px; font-weight:700; cursor:pointer; }
    button:disabled { opacity:0.6; cursor:not-allowed; }
    #toast { position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:#111; border:1px solid #b30000; padding:12px 18px; border-radius:999px; opacity:0; transition:.25s; pointer-events:none; z-index:50; }
    #toast.show { opacity:1; }
  </style>
</head>

<body>

<header>
  <img src="/BRCNYE2026.png" id="logoHome" alt="Big Red Connect">
  <div>
    <div style="font-weight:700;">Big Red Connect</div>
    <div style="color:#888;font-size:.8rem;">Rider Login</div>
  </div>
</header>

<h1>Welcome Back</h1>

<div class="box">
  <label>Your Name</label>
  <input id="name" placeholder="John Doe" autocomplete="name">

  <label>Mobile Number</label>
  <input id="phone" placeholder="405-555-1234" inputmode="tel" autocomplete="tel">
</div>

<button id="btnLogin">Continue</button>
<div id="toast"></div>

<script>
  const PROFILE_API  = "https://bigred-rider-profile.bigredtransportation.workers.dev";
  const BOOKINGS_API = "https://bigred-bookings.bigredtransportation.workers.dev";

  // -------------------------------------------------------
  // Read redirect intent from querystring
  //   /rider-login.html?next=ride-from-search&address=...
  // -------------------------------------------------------
  const qs = new URLSearchParams(location.search);
  const NEXT = (qs.get("next") || "").trim();
  const NEXT_ADDRESS = (qs.get("address") || "").trim();

  function showToast(msg){
    const t=document.getElementById("toast");
    t.textContent=msg;
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"),1800);
  }

  document.getElementById("logoHome").onclick = () => location.href="/index.html";

  // -------------------------------------------------------
  // Destination handoff store (Index/Login → Ride Request)
  // -------------------------------------------------------
  function stashDropoffHandoff(dest){
    if(!dest) return;
    try { sessionStorage.setItem("brc_dropoff_handoff", dest); } catch(e){}
    try { localStorage.setItem("brc_dropoff_handoff", dest); } catch(e){}
  }

  // -------------------------------------------------------
  // ✅ Claim any phone-only manual rides and attach this riderId
  // -------------------------------------------------------
  async function claimManualRidesForThisPhone(){
    try{
      const riderId  = localStorage.getItem("riderId") || "";
      const phoneRaw = localStorage.getItem("riderPhone") || "";
      const phone    = phoneRaw.replace(/\D/g,""); // digits only
      if(!riderId || !phone) return;

      const resp = await fetch(`${BOOKINGS_API}/api/rider/claim-rides`,{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ riderId, phone })
      });

      const txt = await resp.text();
      console.log("[claim-rides]", resp.status, txt);
    }catch(e){
      console.warn("claim-rides failed", e);
    }
  }

  // -------------------------------------------------------
  // Decide where to go AFTER login
  // -------------------------------------------------------
  function redirectAfterLogin(){
    // Highest priority: login came from Index quick-destination
    if (NEXT === "ride-from-search" && NEXT_ADDRESS) {
      stashDropoffHandoff(NEXT_ADDRESS);
      window.location.href = "/rider/ride-request.html?dropoff=" + encodeURIComponent(NEXT_ADDRESS);
      return;
    }

    // Optional: if you later add other next routes, handle here.
    // For now, default behavior:
    window.location.href = "/rider/rider.html";
  }

  // -------------------------------------------------------
  // LOGIN CLICK
  // -------------------------------------------------------
  document.getElementById("btnLogin").addEventListener("click", async () => {
    const btn = document.getElementById("btnLogin");
    btn.disabled = true;

    const name  = document.getElementById("name").value.trim();
    const phone = document.getElementById("phone").value.trim().replace(/\D/g,"");

    if(!name || !phone){
      btn.disabled = false;
      showToast("Name & phone required");
      return;
    }
    if(phone.length < 10){
      btn.disabled = false;
      showToast("Invalid phone number");
      return;
    }

    try {
      // 1) Get canonical riderId from profile worker
      const res = await fetch(`${PROFILE_API}/api/rider/login`, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify({ phone })
      });

      if(!res.ok){
        btn.disabled = false;
        showToast("Login failed");
        return;
      }

      const data = await res.json();
      const riderId = data.riderId;

      if(!riderId){
        btn.disabled = false;
        showToast("Missing riderId");
        return;
      }

      // 2) Persist canonical profile
      const profile = { riderId, name, phone };
      localStorage.setItem("bigred_rider_profile_v1", JSON.stringify(profile));

      // 3) Backward compatibility (older pages)
      localStorage.setItem("riderId", riderId);
      localStorage.setItem("riderName", name);
      localStorage.setItem("riderPhone", phone);

      // ✅ 3.5) Claim any manual rides for this phone (NEW)
      await claimManualRidesForThisPhone();

      // 4) Update profile server-side (best effort)
      fetch(`${PROFILE_API}/api/rider/profile`, {
        method:"PUT",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify(profile)
      }).catch(()=>{});

      // 5) Redirect based on intent
      redirectAfterLogin();

    } catch(err){
      console.error(err);
      btn.disabled = false;
      showToast("Connection error");
    }
  });
</script>

</body>
</html>